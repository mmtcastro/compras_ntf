'++LotusScript Development Environment:2:5:(Options):0:74
Option Public
Option Declare
Use "ccDespesa"
Use "GeraJavaId"


'++LotusScript Development Environment:2:5:(Forward):0:1
Declare Class ccItemListaMateriais
Declare Class ccListaMateriais
Declare Sub CriarRenovacao(negocio As NotesDocument)
Declare Sub GetValoresTimeSheet(planilha As NotesDocument)
Declare Sub PopulaMatrizTarifacao(doc As NotesDocument)
Declare Function FaturaContrato(negocio As NotesDocument, tipoFaturamento As String) As Boolean
Declare Sub FaturaMateriais( uidoc As NotesUiDocument )
Declare Sub Ofensores(negocio As NotesDocument, newDoc As NotesDocument)
Declare Function BuscaCargaMedia(uf As String, cnae As String) As Variant
Declare Sub SolicitaAprovacaoMargemFatorInferior(doc As NotesDocument, tipo As String)
Declare Function GeraCodigoEspelho (fatura As NotesDocument) As Variant
Declare Sub AlteraListaServicos( uidoc As NotesUIDocument )
Declare Function CalcIRRF(doc As NotesDocument) As Double
Declare Sub LinkFaturasPopup(negocio As NotesDocument)
Declare Function GetClassificacao(classificacao As String) As Variant
Declare Function BuscaCodigoFiscal (tipo As String) As Variant
Declare Function CkServicosInternos(negocio As NotesDocument, tipo As String) As Boolean
Declare Sub SaveListaServicos(doc As NotesDocument)
Declare Sub SolicitaPOC(negocio As NotesDocument)
Declare Sub DescontoFlatListaMateriais(uidoc As NotesUIDocument, desconto As Double, operacao As string)
Declare Sub PopulaMargem(doc As NotesDocument)
Declare Sub MgPrevista(doc As NotesDocument)
Declare Sub LinkVisitasPopup(negocio As NotesDocument)
Declare Function BuscaImpostos(ncm As String) As Variant
Declare Function CalcIss (doc As NotesDocument) As Double
Declare Function CkReceber(negocio As NotesDocument) As Boolean
Declare Function GetResponsavelPlanejamento(area As String, tipo As String) As String
Declare Sub OrganizaListaPorMoeda(uidoc As NotesUIDocument)
Declare Sub GetValores(planilha As NotesDocument)
Declare Function CheckStatusServicos(uidoc As NotesDocument)
Declare Function CkChamados(uidoc As NotesuiDocument) As Boolean
Declare Sub SaveAceiteFaturamento(uidoc As NotesuiDocument)
Declare Sub AtualizaSaldosEstoque(negocio As NotesDocument)
Declare Sub LinkCotacoes(negocio As NotesDocument)
Declare Sub GetHoras(negocio As NotesDocument, tipo As string)
Declare Sub CalcTotaisNegocio(doc As NotesDocument)
Declare Function GetNumeroBanco(banco As String) As String
Declare Function GetCustoHora(area As String) As Double
Declare Sub ReprovarMargemFator(doc As NotesDocument)
Declare Sub LinkNegocios(negocio As NotesDocument)
Declare Function CalcCustoHoras(negocio As NotesDocument) As Double
Declare Sub AlteraTimeSheets(negocio As NotesDocument)
Declare Function CheckFreteProjeto(docAtu As NotesDocument) As Boolean
Declare Sub LinkPrejuizo(negocio As NotesDocument)
Declare Function Fechado(status As String) As Boolean
Declare Function GetMoedas As Variant
Declare Function AvisoFaturamento(aceite As NotesDocument) As Boolean
Declare Sub DolarMedio(docAtu As NotesDocument)
Declare Sub AtualizaCheckPointProjeto(negocio As NotesDocument)
Declare Function BuscaProtocolo(estado As String, cf As String, contribuinte As Variant, tipo As String) As Variant
Declare Sub ConcluirNegociosBatch(doc As NotesDocument)
Declare Sub RefreshListaMateriais(doc As NotesDocument)
Declare Sub AlteraDespesas(negocio As NotesDocument)
Declare Sub AvisoSolicita(projeto As NotesDocument, fase As String)
Declare Function CkBaixa(negocio As NotesDocument) As Boolean
Declare Function CheckMgItens(doc As NotesDocument) As Boolean
Declare Function CheckMgRevenda(doc As NotesDocument) As Boolean
Declare Sub CalcBudget(projeto As NotesDocument)
Declare Sub CalcParticipacoes(doc As NotesDocument)
Declare Sub FaturaServicos(uidoc As NotesUiDocument)
Declare Sub AvisoCheckPointPV(negocio As NotesDocument, tipo As String)
Declare Sub AtualizaServicosInternos(negocio As NotesDocument, tipo As string)
Declare Sub ConcluirNegocio(negocio As NotesDocument)
Declare Function ConsisteComprador(uidoc As NotesuiDocument) As Boolean
Declare Sub LinkProjetoPopup(negocio As NotesDocument)
Declare Sub PopulaICMSOE(doc As NotesDocument)
Declare Sub CustoHora(negocio As NotesDocument, tipo As String)
Declare Function BuscaICMS(origem As String, destino As String, contribuinte As String) As Variant
Declare Sub AlteraAreas(negocio As NotesDocument)
Declare Sub AtualizaMetasNegocio(docAtu As NotesDocument, tipo As String)
Declare Function CheckDocListas(codigo As String, item As String, tipo As String) As Boolean
Declare Sub CalcCapitalGiroReal(negocios As NotesDocumentCollection)
Declare Sub GeraDespesasServicosInternos(principal As NotesDocument, adendo As NotesDocument)
Declare Sub Perda(negocio As NotesDocument)
Declare Sub AvisoParticipacao(negocio As NotesDocument, fase As String, nome As String, valor As Double, vencimento As String)
Declare Sub AvisoConclusaoNegocio(negocio As NotesDocument,newDoc As NotesDocument)
Declare Sub GeraCapitalGiro64K(negocios As NotesDocumentCollection)
Declare Sub CalcFatoresImportacao(uidoc As NotesUIDocument)
Declare Sub CalcTotaisPO(doc As NotesDocument)
Declare Sub GeraDespesaCapitalGiro(negocio As NotesDocument)
Declare Sub SaldoServicosAFaturar(uidoc As NotesUiDocument)
Declare Function CkProjeto(negocio As NotesDocument) As Boolean
Declare Function TemConteudo(doc As NotesDocument) As Boolean
Declare Sub CancelaFaturasReceber(negocio As NotesDocument)
Declare Function GetPrazoPlanejamento(prazo As Integer) As String
Declare Sub PopulaListaMateriais(doc As NotesDocument)
Declare Sub GeraReceber(doc As NotesDocument)
Declare Sub GerarIntermediacaoVendas(negocio As NotesDocument)
Declare Function CkFeriado (diaVenc As String) As Boolean
Declare Sub LoadAceiteFaturamento(uidoc As NotesUIDocument)
Declare Function CalcCofins( doc As NotesDocument ) As Double
Declare Function CkItemEmDolar(docAtu As NotesDocument) As Boolean
Declare Sub AtualizaMetas(docAtu As NotesDocument)
Declare Sub AvisoFechamentoProjeto(doc As NotesDocument)
Declare Sub CheckStatusCQ (doc As NotesDocument)
Declare Sub AprovarMargemFator(doc As NotesDocument)
Declare Sub SaveListaMateriais(doc As NotesDocument)
Declare Sub AtualizaSitGerente(negocio As NotesDocument)
Declare Sub Desfechamento(negocio As NotesDocument)
Declare Function ExtratoPerda(negocio As NotesDocument) As Variant
Declare Function GetVisitas(codigo As String) As Double
Declare Function ConsisteCamposFechamento(uidoc As NotesUIDocument) As Boolean
Declare Sub DeletarEspelhosReceber(negocio As NotesDocument, tipo As String)
Declare Function CheckFI(doc As NotesDocument, tipo As String) As Boolean
Declare Sub AtualizaDadosGerentesDoNamesAddresBook(negocio As NotesDocument)
Declare Sub ConclusaoNegocio(negocio As NotesDocument)
Declare Sub LoadListaMateriais(doc As NotesDocument)
Declare Sub LoadListaServicos(doc As NotesDocument)
Declare Function GetValoresPlanilha(codigo As String, tipo As String) As Variant
Declare Sub AtualizaPrejuizo(negocio As NotesDocument)
Declare Sub GetTotalFaturado(negocio As NotesDocument)
Declare Sub LoadServicosInternos(doc As NotesDocument)
Declare Function CalcPis( doc As NotesDocument ) As Double
Declare Sub Cotacao(docAtu As NotesDocument)
Declare Function CkImportacao(negocio As NotesDocument) As Boolean
Declare Sub SolicitaPV(negocio As NotesDocument)
Declare Sub EspelhoMateriais(uidoc As NotesUIDocument)
Declare Sub PopulaListaServicos(doc As NotesDocument)
Declare Sub CalcNota(doc As NotesDocument)
Declare Function RetiraSinais(texto As String) As String
Declare Sub CalcListaServicos( uidoc As NotesUiDocument )
Declare Sub PopulaConclusaoNegocio(newdoc As NotesDocument)
Declare Sub CalcListaCPS(projeto As NotesDocument)
Declare Sub GeraRequisicao (uidoc As NotesuiDocument)
Declare Sub PlanilhaFinanceira(projeto As NotesDocument)
Declare Function GetPrazoRenovacao(codigo As String, item As String) As Integer
Declare Sub AnalisePerda(negocio As NotesDocument)
Declare Function CkSatisfacao(Source As NotesUIDocument) As Boolean
Declare Function WhoIsOnLine( uidoc As NotesUiDocument) As Variant
Declare Function GeraCodigo(negocio As NotesDocument)
Declare Function CheckContratoLicenca(ui As NotesUIDocument)
Declare Sub CheckStatusNegocio(doc As NotesDocument)
Declare Sub GeraDespesasParticipacao(negocio As NotesDocument)
Declare Sub CriarPrejuizo(negocio As NotesDocument)
Declare Sub Contrato(negocio As NotesDocument, acao As String)
Declare Sub LinkCotacoesPopup(negocio As NotesDocument)
Declare Function CheckItensLista(ui As NotesUIDocument) As Boolean
Declare Function CalcICMS(doc As NotesDocument) As Variant
Declare Sub EspelhoServicos(uidoc As NotesUIDocument)
Declare Sub LinkOrigem(negocio As NotesDocument)
Declare Function geraCodigoPedidoCompra(codigoFornecedor As String)
Declare Sub CalcPlanilha(planilha As NotesDocument)
Declare Sub MgReal(doc As NotesDocument)
Declare Function ConsisteCamposContrato(uidoc As NotesUIDocument) As Boolean
Declare Sub GetRegrasFiscais(negocio As NotesDocument)
Declare Sub ConsolidaCenarios(negocio As NotesDocument)
Declare Sub GetHorasPrevistas(negocio As NotesDocument)
Declare Function AtualizaSaldosAFaturar(doc As NotesDocument) As Variant
Declare Sub AvisoForecast(doc As NotesDocument)
Declare Function GetDadosBancarios(negocio As NotesDocument) As String
Declare Sub AvisoFaturamentoFinanceiro(aceite As NotesDocument)
Declare Sub ColocarNaAgenda(doc As NotesDocument)
Declare Function GetFator(area As String, fase As String) As Double
Declare Function CheckMgServicos(doc As NotesDocument) As Boolean
Declare Function CkAceite (doc As NotesDocument) As Boolean
Declare Function CkNegocioPrincipal(Source As NotesUIDocument) As Boolean
Declare Sub LinkDespesasPopup(negocio As NotesDocument)
Declare Function GetFatorPMO(area As String) As Double
Declare Sub ConverteListaMateriais(negocio As NotesDocument)
Declare Sub GeraDespesasEncargosSociais(negocio As NotesDocument)
Declare Function CkDataCQ(Source As NotesUIDocument) As Boolean
Declare Function CalcIS (doc As NotesDocument) As Double
Declare Function CheckDesfechamento(negocio As NotesDocument)
Declare Sub AlteraListaMateriais(uidoc As NotesUIDocument)
Declare Function WorkflowResumido(codigo As String) As String
Declare Function CheckMgNegocio(doc As NotesDocument) As Boolean
Declare Sub AvisoMgPrevista(doc As NotesDocument, tipo As String)
Declare Sub PopulaMetas(uidoc As NotesUIDocument)
Declare Function CkCodigo(Source As NotesUIDocument) As Boolean
Declare Function BuscaAtividades (negocio As NotesDocument) As Double
Declare Sub AtualizaRenovacao(negocio As NotesDocument)
Declare Sub AjusteComissao(negocio As NotesDocument)
Declare Function CalcIF(doc As NotesDocument) As Double
Declare Sub CalcPremio(doc As NotesDocument)
Declare Sub CalcCapitalGiroPrevisto(negocio As NotesDocument)
Declare Function CkEmpresa(negocio As NotesDocument) As Variant
Declare Sub CriarNegocio(negocio As NotesUIDocument, doc As NotesDocument)
Declare  Sub AtualizaMovimentoNegocio(negocio As NotesDocument, scan As integer)
Declare Function CheckItensAgente ( doc As NotesDocument ) As Integer
Declare Function CkDadosEmpresa (empresa As NotesDocument) As Variant
Declare Function CheckAceiteFaturamento(codigo As String) As String
Declare Sub MargensListaUI(ui As NotesUiDocument)
Declare Sub GeraDocumentoPublico (doc As NotesDocument)
Declare Sub StatusProjeto(doc As NotesDocument)
Declare Sub AvisoCQ (doc As NotesDocument)
Declare Sub StatusRenovacao(doc As NotesDocument)
Declare Function CheckFreteRevenda(doc As NotesDocument) As Boolean
Declare Function CkComissionamento (doc As NotesDocument) As Boolean
Declare Sub AtualizaFollowUp(uidoc As NotesUIDocument, doc As NotesDocument)
Declare Sub GeraControleDoc(negocio As NotesDocument, Tipo As String)
Declare Sub GeraCapitalGiroRTF (negocios As NotesDocumentCollection)
Declare Function CalculaSaldosMateriais (doc As NotesDocument) As Double
Declare Sub LinkProjetoContrato(negocio As NotesDocument)
Declare Sub Forecast(negocio As NotesDocument)
Declare Function ConsisteCampos(Source As NotesUIDocument) As Variant
Declare Function CkSuframa(origem As String, destino As String) As Boolean
Declare Function CkPlanilha(uidoc As NotesUIDocument) As Boolean
Declare Sub AtualizaReceber(espelho As NotesDocument)
Declare Sub SaldoMateriais(projeto As NotesDocument)
Declare Sub Participacoes(negocio As NotesDocument)
Declare Sub GetDataConclusao(negocio As NotesDocument)
Declare Function CheckFaturamento(negocio As NotesDocument) As Variant
Declare Sub GetConsolidacoes(doc As NotesDocument)
Declare Sub CalcComissoes (doc As NotesDocument)
Declare Sub FaturaMateriaisDoc(negocio As NotesDocument)
Declare Sub AvisoDesfechamento(doc As NotesDocument)
Declare Sub GeraCapitalGiroporArray(negocios As NotesDocumentCollection)
Declare Function getPedido(Texto As String) As String
Declare Sub ProjetoContrato(negocio As NotesDocument, acao As String)
Declare Sub AtualizaPrevisaoEntrega(negocio As NotesDocument)
Declare Sub NotOnLine(uidoc As NotesUiDocument)
Declare Function CkCliente(codCliente As String) As Boolean
Declare Sub AvisoNovoNegocio(uidoc As NotesUIDocument)
Declare Function CheckItensListaCPS(uidoc As NotesUiDocument) As Boolean
Declare Function CalcINSSRF(doc As NotesDocument) As Double
Declare Function CalcTotalMercadorias(doc As NotesDocument) As Double
Declare Function CheckItensListaServicos(ui As NotesUIDocument) As Boolean
Declare Sub BuscaRegrasFiscais(negocio As NotesDocument)
Declare Function BuscaCatalogo(partN As String) As Variant
Declare Sub LinkRenovacao(negocio As NotesDocument)
Declare Sub CkStatusCotacao(cotacao As NotesDocument)
Declare Sub PopulaMoedas(negocio As NotesDocument)
Declare Sub Fechamento(doc As NotesDocument)
Declare Sub RefreshListaServicos(doc As NotesDocument)
Declare Function CalcTotalServicos( doc As NotesDocument ) As Double
Declare Function TemHardware(doc As NotesDocument) As Boolean
Declare Function CkAreaTS(doc As NotesDocument) As String
Declare Function GetPrimeiroTelefone(telefoneCompleto As String) As String

'++LotusScript Development Environment:2:5:(Declarations):0:10
Dim aliquota(16) As Double
Dim credIcms As Double
Dim credPis As Double
Dim credCofins As Double
Dim prazoPlanejamento As Integer
Dim pf As Variant
Dim visitas As Double
Dim dataPagamento As String

%REM
	Class ccItemListaMateriais
	Description: Uma linha da lista de materiais para ser usado em c
%END REM

Class ccItemListaMateriais
	Private m_it As string
	Private m_Q As Integer
	Private m_PartNo As String
	Private m_Produto As String
	Private m_T As String 'tipo
	Private m_UN As String 'unidade
	Private m_CF As String 'NCM
	Private m_ST As String
	Private m_Fabricante As String
	Private m_UFCompra As String
	Private m_ICC As Double 'ICMS Compra
	Private m_US As String 'moeda
	Private m_CustoFOB As Double
	Private m_FI As Double 'fator de importacao
	Private m_Custo As Double
	Private m_ICMSSTC As double 'ICMS ST da compra
	Private m_Mg As Double
	Private m_CustoUnit As Double
	Private m_CusTot As Double
	Private m_ICMSST As Double 'venda
	Private m_VendaTot As Double
	Private m_IC As Double 'aliq ICMS da venda
	Private m_ICD As Double 'aliq ICMS Diferencial
	Private m_FCP As Double 'aliq Fundo de Combate a Pobreza
	Private m_IP As Double 'aliq IPI Venda 
	Private m_IPC As Double 'aliq IPI Compra
	Private m_II As Double 'imposto de importacao
	
	'========
	Property Get It As String    
		It = m_It
	End Property
	Property Set It As String     
		m_It = It
	End Property
	'========
	Property Get Q As String    
		Q = m_Q
	End Property
	Property Set q As String     
		m_Q = Q
	End Property
	'=========
	Property Get PartNo As String    
		PartNo = m_PartNo
	End Property
	Property Set PartNo As String     
		m_PartNo = PartNo
	End Property
	'=========
	Property Get Produto As String    
		Produto = m_Produto
	End Property
	Property Set Produto As String     
		m_Produto = Produto
	End Property
	'=========
	Property Get T As String    
		T = m_T
	End Property
	Property Set T As String     
		m_T = T
	End Property
	'=========
	Property Get UN As String    
		UN = m_UN
	End Property
	Property Set UN As String     
		m_UN = UN
	End Property
	'=========
	Property Get CF As String    
		CF = m_CF
	End Property
	Property Set CF As String     
		m_CF = CF
	End Property
	'=========
	Property Get ST As String    
		ST = m_ST
	End Property
	Property Set ST As String     
		m_ST = ST
	End Property
	'=========
	Property Get Fabricante As String    
		Fabricante = m_Fabricante
	End Property
	Property Set Fabricante As String     
		m_Fabricante = Fabricante
	End Property
	'=========
	Property Get UFCompra As String    
		UFCompra = m_UFCompra
	End Property
	Property Set UFCompra As String     
		m_UFCompra = UFCompra
	End Property
	'=========
	Property Get ICC As double    
		ICC = m_ICC
	End Property
	Property Set ICC As double     
		m_ICC = ICC
	End Property
	'=========
	Property Get US As String    
		US = m_US
	End Property
	Property Set US As String     
		m_US = US
	End Property
	'=========
	Property Get CustoFOB As double    
		CustoFOB = m_CustoFOB
	End Property
	Property Set CustoFOB As double     
		m_CustoFOB = CustoFOB
	End Property
	'=========
	Property Get FI As double
		FI = m_FI
	End Property
	Property Set FI As double     
		m_FI = FI
	End Property
	'=========
	Property Get Custo As double    
		Custo = m_Custo
	End Property
	Property Set Custo As double     
		m_Custo = Custo
	End Property
	'=========
	Property Get ICMSSTC As double    
		ICMSSTC = m_ICMSSTC
	End Property
	Property Set ICMSSTC As double     
		m_ICMSSTC = ICMSSTC
	End Property
	'=========
	Property Get Mg As double
		Mg = m_Mg
	End Property
	Property Set Mg As double     
		m_Mg = Mg
	End Property
	'=========
	Property Get CustoUnit As double    
		CustoUnit = m_CustoUnit
	End Property
	Property Set CustoUnit As double     
		m_CustoUnit = CustoUnit
	End Property
	'=========
	Property Get CusTot As double 
		CusTot = m_CusTot
	End Property
	Property Set CusTot As double     
		m_CusTot = CusTot
	End Property
	'=========
	Property Get ICMSST As double    
		ICMSST = m_ICMSST
	End Property
	Property Set ICMSST As double     
		m_ICMSST = ICMSST
	End Property
	'=========
	Property Get VendaTot As double   
		VendaTot = m_VendaTot
	End Property
	Property Set VendaTot As double     
		m_VendaTot = VendaTot
	End Property
	'=========
	Property Get IC As double
		IC = m_IC
	End Property
	Property Set IC As double     
		m_IC = IC
	End Property
	'=========
	Property Get ICD As double
		ICD = m_ICD
	End Property
	Property Set ICD As double     
		m_ICD = ICD
	End Property
	'=========
	Property Get FCP As double
		FCP = m_FCP
	End Property
	Property Set FCP As double     
		m_FCP = FCP
	End Property
	'=========
	Property Get IP As double    
		IP = m_IP
	End Property
	Property Set IP As double     
		m_IP = IP
	End Property
	'=========
	Property Get IPC As Double    
		IPC = m_IPC
	End Property
	Property Set IPC As Double     
		m_IPC = IPC
	End Property
	'=========
	Property Get II As double    
		II = m_II
	End Property
	Property Set II As double     
		m_II = II
	End Property
	
End Class
%REM
	Class ccListaMateriais
	Description: A lista de materiais é um array de itens de listas de materiais
%END REM

Class ccListaMateriais
	Private m_Itens As variant
	
	Sub AddItemAt(uidoc As NotesUiDocument, at As Integer)
		dim item As New ccItemListaMateriais
		Dim i As String
		i = CStr(at)
		item.It = i
		item.Q = CInt(uidoc.Fieldgettext("Q_" & i))
		item.PartNo = uidoc.Fieldgettext("PartNo_" & i)
		item.Produto = uidoc.Fieldgettext("Produto_" & i)
		item.T = uidoc.Fieldgettext("T_" & i)
		item.UN = uidoc.Fieldgettext("UN_" & i)
		item.CF = uidoc.Fieldgettext("CF_" & i)
		item.ST = uidoc.Fieldgettext("ST_" & i)
		item.Fabricante = uidoc.Fieldgettext("Fabricante_" & i)
		item.UFCompra = uidoc.Fieldgettext("UFCompra_" & i)
		item.ICC = uidoc.Fieldgettext("ICC_" & i)
		item.US = uidoc.Fieldgettext("US_" & i)
		If IsNumeric(uidoc.Fieldgettext("CustoFob_" & i)) Then item.CustoFOB = CDbl(uidoc.Fieldgettext("CustoFob_" & i)) Else item.CustoFob = 0
		If IsNumeric(uidoc.Fieldgettext("FI_" & i)) Then item.FI = CDbl(uidoc.Fieldgettext("FI_" & i)) Else item.FI = 0
		If IsNumeric(uidoc.Fieldgettext("Custo_" & i)) Then item.Custo = CDbl(uidoc.Fieldgettext("Custo_" & i)) Else item.Custo = 0
		If IsNumeric(uidoc.Fieldgettext("ICMSSTC_" & i)) Then item.ICMSSTC = Cdbl(uidoc.Fieldgettext("ICMSSTC_" & i)) Else item.ICMSSTC = 0
		If IsNumeric(uidoc.Fieldgettext("MG_" & i)) Then item.Mg = CDbl(uidoc.Fieldgettext("MG_" & i)) Else item.Mg = 0
		If IsNumeric(uidoc.Fieldgettext("CustoUnit_" & i)) Then item.CustoUnit = CDbl(uidoc.Fieldgettext("CustoUnit_" & i)) Else item.CustoUnit = 0
		If IsNumeric(uidoc.Fieldgettext("CusTot_" & i)) Then item.CusTot = CDbl(uidoc.Fieldgettext("CusTot_" & i)) Else item.CusTot = 0
		If uidoc.Fieldgettext("Form") = "Negocio" Then
			If IsNumeric(uidoc.Fieldgettext("ICMSST_" & i)) Then item.ICMSST = CDbl(uidoc.Fieldgettext("ICMSST_" & i)) Else item.ICMSST = 0
			If IsNumeric(uidoc.Fieldgettext("VendaTot_" & i)) Then item.VendaTot = CDbl(uidoc.Fieldgettext("VendaTot_" & i)) Else item.VendaTot = 0
			item.IC = CDbl(uidoc.Fieldgettext("IC_" & i))
			item.ICD = CDbl(uidoc.Fieldgettext("ICD_" & i))
			item.FCP = CDbl(uidoc.Fieldgettext("FCP_" & i))
			item.IP = CDbl(uidoc.Fieldgettext("IP_" & i))
		End If
		item.IPC = CDbl(uidoc.Fieldgettext("IPC_" & i))
		item.II = cdbl(uidoc.Fieldgettext("II_" & i))
		Dim scan As Integer
		If IsEmpty(me.m_Itens) Then
			ReDim me.m_Itens(0)
			Set me.m_Itens(0) = item
		Else
			ReDim Preserve me.m_Itens(UBound(me.m_Itens)+1)
			Set me.m_Itens(UBound(me.m_Itens)) = item
		End If
	End Sub
	
	%REM
		Sub AddListaMateriaisFromUiDoc
		Description: Copia toda a lista de materiais para a a ccListaMateriais
					faz o loop completo pela lista de materiais e chama a função de inclui item a item
	%END REM
	Sub AddListaMateriaisFromUidoc(uidoc As NotesUIDocument)
		Dim scan As Integer, qvar As Integer
		For scan = 0 To 49
			qvar = Val(uidoc.FieldGetText("Q_" & scan))
			If qvar > 0 Then	
				Call me.AddItemAt(uidoc, scan)
			End If
		Next
		
	End Sub
	
	%REM ==================
		Sub checkInitArray
		Description: verifica se a array já foi inicializada
	%END REM
	function checkInitArray(array) As variant	
		Dim x() As String
		Dim isArr As variant
		ForAll v In array
			isArr = True
			Exit ForAll 
		End ForAll
		checkInitArray = isArr		
	End Function
	
	
	%REM =================
		Sub serializaLista
		Description: prepara para retirar os espaços em branco da lista de materiais
					serializando novamente a lista.
	%END REM
	Sub serializaLista
		Dim scan As Integer
		Dim item As ccItemListaMateriais
		Dim itens() As Variant
		'Set itens = me.Itens
		For scan = 0 To UBound(me.m_Itens)
			Set item = Me.m_itens(scan)
			item.It = CStr(scan)
		Next
	End Sub
	
%REM =====================
	Sub WriteItensUiDoc
	Description: Imprime na tela do uidoc uma lista de materiais
	%END REM
	Sub WriteItensToUiDoc(uidoc As NotesUIDocument)
		Dim scan As Integer
		Dim it As String
		Dim item As ccItemListaMateriais
		'For scan = 0 To me.NumItens()
		For scan = 0 To 49	'LMO 19/05/16 - Não estava limpando os campos e os itens estavam ficando duplicados
			it = CStr(scan)
			If scan <= me.NumItens() Then
				Set item = me.m_itens(scan)
				Call uidoc.Fieldsettext("Q_"&it, CStr(item.Q))
				Call uidoc.Fieldsettext("PartNo_"&it,item.PartNo)
				Call uidoc.Fieldsettext("Produto_"&it,item.Produto)
				Call uidoc.Fieldsettext("T_"&it,item.T)
				Call uidoc.Fieldsettext("UN_"&it,item.UN)
				Call uidoc.Fieldsettext("CF_"&it,item.CF)
				Call uidoc.Fieldsettext("ST_"&it,item.ST)
				Call uidoc.Fieldsettext("Fabricante_"&it,item.Fabricante)
				Call uidoc.Fieldsettext("UFCompra_"&it,item.UFCompra)
				Call uidoc.Fieldsettext("ICC_"&it,Format(item.ICC, "Percent"))
				Call uidoc.Fieldsettext("US_"&it,item.US)
				Call uidoc.Fieldsettext("CustoFob_"&it,Format(item.CustoFob, "Standard"))
				Call uidoc.Fieldsettext("FI_"&it,Format(item.FI, "Fixed"))
				Call uidoc.Fieldsettext("Custo_"&it,Format(item.Custo, "Standard"))
				Call uidoc.Fieldsettext("ICMSSTC_"&it,Format(item.ICMSSTC, "Standard"))
				Call uidoc.Fieldsettext("MG_"&it,Format(item.MG, "Fixed"))
				Call uidoc.Fieldsettext("CustoUnit_"&it,Format(item.CustoUnit, "Standard"))
				Call uidoc.Fieldsettext("CusTot_"&it,Format(item.CusTot, "Standard"))
				If uidoc.Fieldgettext("Form") = "Negocio" Then
					Call uidoc.Fieldsettext("ICMSST_"&it,Format(item.ICMSST, "Standard"))
					Call uidoc.Fieldsettext("VendaTot_"&it,Format(item.VendaTot, "Standard"))
					Call uidoc.Fieldsettext("IC_"&it,Format(item.IC, "Percent"))
					Call uidoc.Fieldsettext("ICD_"&it,Format(item.ICD, "Percent"))
					Call uidoc.Fieldsettext("FCP_"&it,Format(item.FCP, "Percent"))
					Call uidoc.Fieldsettext("IP_"&it,Format(item.IP, "Percent"))
				End If
				Call uidoc.Fieldsettext("IPC_"&it,Format(item.IPC, "Percent"))
				Call uidoc.Fieldsettext("II_"&it,Format(item.II, "Percent"))		
			Else
				'Limpa Campos - LMO 19/05/16
				Call uidoc.Fieldsettext("Q_"&it, "")
				Call uidoc.Fieldsettext("PartNo_"&it, "")
				Call uidoc.Fieldsettext("Produto_"&it, "")
				Call uidoc.Fieldsettext("T_"&it, "")
				Call uidoc.Fieldsettext("UN_"&it, "")
				Call uidoc.Fieldsettext("CF_"&it, "")
				Call uidoc.Fieldsettext("ST_"&it, "")
				Call uidoc.Fieldsettext("Fabricante_"&it, "")
				Call uidoc.Fieldsettext("UFCompra_"&it, "")
				Call uidoc.Fieldsettext("ICC_"&it, "")
				Call uidoc.Fieldsettext("US_"&it, "R$")
				Call uidoc.Fieldsettext("CustoFob_"&it, "")
				Call uidoc.Fieldsettext("FI_"&it, "")
				Call uidoc.Fieldsettext("Custo_"&it, "")
				Call uidoc.Fieldsettext("ICMSSTC_"&it, "")
				Call uidoc.Fieldsettext("MG_"&it, "")
				Call uidoc.Fieldsettext("CustoUnit_"&it, "")
				Call uidoc.Fieldsettext("CusTot_"&it, Format("0", "Fixed"))
				If uidoc.Fieldgettext("Form") = "Negocio" Then
					Call uidoc.Fieldsettext("ICMSST_"&it, Format("0", "Fixed"))
					Call uidoc.Fieldsettext("VendaTot_"&it, Format("0", "Fixed"))
					Call uidoc.Fieldsettext("IC_"&it, "")
					Call uidoc.Fieldsettext("ICD_"&it, "")
					Call uidoc.Fieldsettext("FCP_"&it, "")
					Call uidoc.Fieldsettext("IP_"&it, "")
				End If
				Call uidoc.Fieldsettext("IPC_"&it, "")
				Call uidoc.Fieldsettext("II_"&it, "")
			End If
		Next
	End Sub

	%REM
	Function NumItens
	Description: retorna o numeros de itens que na lista de materiais
	%END REM
	Function NumItens() As Integer	
		NumItens = UBound(me.m_itens)
	End Function

	%REM
	function OrdenaPorMoeda
	Description: Retorna outra lista de materiais agrupada conforme a moeda
				primeiro R$, USC e depois UST se houver
	%END REM
	sub OrdenaPorMoeda
		If IsEmpty(me.m_Itens) Then
			Exit sub
		End If
		Dim scan As Integer
		Dim R As Variant, USC As Variant, UST As Variant
		Dim item As ccItemListaMateriais 	
		Dim moeda As string
		For scan = 0 To UBound(me.m_itens)
			Set item = me.m_itens(scan)
			If item.US = "R$" Then
				If IsEmpty(R) Then
					ReDim R(0)
					Set R(0) = item
				Else
					ReDim Preserve R(UBound(R)+1) As Variant
					Set R(UBound(R)) = item
				End If
			ElseIf item.US = "USC" Then
				If IsEmpty(USC) Then
					ReDim USC(0)
					Set USC(0) = item
				Else
					ReDim Preserve USC(UBound(USC)+1) As Variant
					Set USC(UBound(USC)) = item
				End If
			Else
				If IsEmpty(UST) Then
					ReDim UST(0)
					Set UST(0) = item
				Else
					ReDim Preserve UST(UBound(UST)+1) As Variant
					Set UST(UBound(UST)) = item
				End If
			End If		
		Next

		Dim topScan As Integer
		If Not IsEmpty(R) then
			For scan = 0 To UBound(R)	
				ReDim Preserve itens(topScan) As variant
				Set itens(topScan) = R(scan)
				topScan = topScan + 1	
			Next
		End If
		If Not (IsEmpty(USC)) then
			For scan = 0 To UBound(USC)
				ReDim Preserve itens(topScan) As Variant		
				Set itens(topScan) = USC(scan)
				topScan = topScan + 1	
			Next
		End If
		If Not (IsEmpty(UST)) then
			For scan = 0 To UBound(UST)
				ReDim Preserve itens(topScan) As Variant		
				Set itens(topScan) = UST(scan)
				topScan = topScan + 1	
			Next
		End If
		stop
		me.m_Itens = itens
		'me.Itens = itens
		
	End sub

	%REM
	Function getItemAt
	Description: Retorna o ítem de uma determinada posição da lista de materiais
	%END REM
	Function getItemAt(linha As Integer) As ccItemListaMateriais	
		Set getItemAt =  me.m_Itens(linha) 	
	End Function

	%REM
	sub setItemAt
	Description: Altera o ítem de uma determinada posição da lista de materiais
	%END REM
	Sub setItemAt(linha As Integer, novoItem As ccItemListaMateriais) 
		Dim item As ccItemListaMateriais
		Set item = me.m_Itens(linha)	
		Set item = novoItem		
	End Sub
	'=========
	'	Property Get Itens As variant 
	'			Itens = m_Itens
	'	End Property
	'	Property Set Itens As variant
	'		m_Itens = Itens
	'	End Property
	
	

End Class

'++LotusScript Development Environment:2:2:CriarRenovacao:5:8
%REM
	Sub CriarRenovacao
	Description: Comments for Sub
%END REM
Sub CriarRenovacao(negocio As NotesDocument)
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim scan As Integer, item As Integer, x As Integer, y As Integer, prazo As Integer
	ReDim prazos(x) As Integer, itens(49, 49) As Integer
	Dim indice As Variant
	Dim key(1) As String
	key(0) = negocio.Codigo(0)
	Set view = db.Getview("(Renovacoes/Origem/Prazo)")
	For scan = 0 To 49
		If negocio.Getitemvalue("t_" & scan)(0) = "SW" Or negocio.Getitemvalue("t_" & scan)(0) = "SV" Then
			prazo = GetPrazoRenovacao(negocio.Codigo(0), CStr(scan + 1))
			If prazo > 0 Then
				indice = ArrayGetIndex(prazos, prazo)
				If IsNull(indice) Then
					ReDim Preserve prazos(x) As Integer
					prazos(x) = prazo
					itens(x, y) = scan + 1
					x = x + 1
				Else
					itens(indice, y) = scan + 1
				End If
				y = y + 1
			End If
		End If
	Next
	'*** Obtém o menor prazo - LMO 02/01/25 ***
	Dim menorPrazo As Integer
	If x > 0 Then
		For x = 0 To UBound(Prazos)
			If x = 0 Then
				menorPrazo = prazos(x)
			Else
				If menorPrazo > prazos(x) Then menorPrazo = prazos(x)
			End If
		Next
	End If
	'***
	
	'*** Cria apenas uma Renovação com o menor prazo - LMO 02/01/25 ***
	If menorPrazo > 0 Then
		key(1) = CStr(menorPrazo)
		Set doc = view.Getdocumentbykey(key, True)
		If doc Is Nothing Then
			Dim vencimento As New NotesDateTime(negocio.DataFechamento(0))
			Call vencimento.Adjustday(menorPrazo)
			Set doc = New NotesDocument(db)
			doc.Form = "Renovacao"
			doc.Id = geraJavaId(doc)
			doc.IdOrigem = negocio.Id
			doc.CodigoOrigem = negocio.Codigo
			doc.Prazo = menorPrazo
			doc.Vencimento = CDat(vencimento.Dateonly)
			doc.Autor = session.CommonUserName
			doc.Criacao = Now
			doc.Cliente = negocio.Cliente
			doc.UF = negocio.UF
			doc.Contribuinte = negocio.Contribuinte
			doc.CodCliente = negocio.CodCliente
			doc.CodigoGrupoEconomico = negocio.CodigoGrupoEconomico
			doc.CodEmpresa = negocio.CodEmpresa
			doc.DataCotacaoUS = negocio.DataCotacaoUS
			doc.USC = negocio.USC
			doc.UST = negocio.UST
			doc.USCompra = negocio.USCompra
			doc.USVenda = negocio.USVenda
			'Adendo
			doc.Classe = "Adendo"
			doc.TipoAdendo = "Comercial"
			If negocio.Classe(0) = "Adendo" Then
				doc.NegocioPrincipal = negocio.NegocioPrincipal(0)
				doc.Grupo = negocio.NegocioPrincipal(0)
			Else
				doc.NegocioPrincipal = negocio.Codigo(0)
				doc.Grupo = negocio.Codigo(0)
			End If
			doc.TipoNegocio = negocio.TipoNegocio
			doc.Descricao = negocio.Descricao
			doc.OrigemOportunidade = negocio.OrigemOportunidade
			doc.Dias = 0
			doc.TipoVenda = "Venda Simples"
			doc.AreaVendas = negocio.AreaVendas
			doc.GerenteConta = negocio.GerenteConta
			doc.Inside = negocio.Inside
			doc.NomeComissao = negocio.NomeComissao
			doc.ParticipacaoComissao = negocio.ParticipacaoComissao
			doc.ContatoComercial = negocio.ContatoComercial
			doc.CargoComercial = negocio.CargoComercial
			doc.TelComercial = negocio.TelComercial
			doc.CelComercial = negocio.CelComercial
			doc.eMailComercial = negocio.eMailComercial
			doc.ContatoTecnico = negocio.ContatoTecnico
			doc.CargoTecnico = negocio.CargoTecnico
			doc.TelTecnico = negocio.TelTecnico
			doc.CelTecnico = negocio.CelTecnico
			doc.eMailTecnico = negocio.eMailTecnico
			doc.Parceria = negocio.Parceria
			doc.Temperatura = "Quente"
			doc.Sit = "Pendente"
			doc.SitNumero = "1"
			doc.PrazoPagamento = negocio.PrazoPagamento
			doc.PrazoPagamentoFornecedor = negocio.PrazoPagamentoFornecedor
			Call GeraCodigo(doc)
			'Lista de Materiais
			doc.ResultadoRevendaP = negocio.ResultadoRevendaP
			doc.FI_HW = negocio.FI_HW
			doc.FI_SW = negocio.FI_SW
			doc.FI_SV = negocio.FI_SV
			doc.Destino = negocio.Destino
			'Mantém os Itens na mesma posição do Negócio
			For scan = 0 To 49
				If negocio.Getitemvalue("Produto_" & scan)(0) <> "" Then
					Call doc.Replaceitemvalue("Q_" & scan, negocio.Getitemvalue("Q_" & scan)(0))
					Call doc.Replaceitemvalue("PartNo_" & scan, negocio.Getitemvalue("PartNo_" & scan)(0))
					Call doc.Replaceitemvalue("Produto_" & scan, negocio.Getitemvalue("Produto_" & scan)(0))
					Call doc.Replaceitemvalue("t_" & scan, negocio.Getitemvalue("t_" & scan)(0))
					Call doc.Replaceitemvalue("Un_" & scan, negocio.Getitemvalue("Un_" & scan)(0))
					Call doc.Replaceitemvalue("CF_" & scan, negocio.Getitemvalue("CF_" & scan)(0))
					Call doc.Replaceitemvalue("ST_" & scan, negocio.Getitemvalue("ST_" & scan)(0))
					Call doc.Replaceitemvalue("Fabricante_" & scan, negocio.Getitemvalue("Fabricante_" & scan)(0))
					Call doc.Replaceitemvalue("UFCompra_" & scan, negocio.Getitemvalue("UFCompra_" & scan)(0))
					Call doc.Replaceitemvalue("ICC_" & scan, negocio.Getitemvalue("ICC_" & scan)(0))
					Call doc.Replaceitemvalue("IPC_" & scan, negocio.Getitemvalue("IPC_" & scan)(0))
					Call doc.Replaceitemvalue("us_" & scan, negocio.Getitemvalue("us_" & scan)(0))
					Call doc.Replaceitemvalue("CustoFOB_" & scan, negocio.Getitemvalue("CustoFOB_" & scan)(0))
					Call doc.Replaceitemvalue("FI_" & scan, negocio.Getitemvalue("FI_" & scan)(0))
					Call doc.Replaceitemvalue("Custo_" & scan, negocio.Getitemvalue("Custo_" & scan)(0))
					Call doc.Replaceitemvalue("ICMSSTC_" & scan, negocio.Getitemvalue("ICMSSTC_" & scan)(0))
					Call doc.Replaceitemvalue("Mg_" & scan, negocio.Getitemvalue("Mg_" & scan)(0))
					Call doc.Replaceitemvalue("CustoUnit_" & scan, negocio.Getitemvalue("CustoUnit_" & scan)(0))
					Call doc.Replaceitemvalue("CusTot_" & scan, negocio.Getitemvalue("CusTot_" & scan)(0))
					Call doc.Replaceitemvalue("ICMSST_" & scan, negocio.Getitemvalue("ICMSST_" & scan)(0))
					Call doc.Replaceitemvalue("VendaTot_" & scan, negocio.Getitemvalue("VendaTot_" & scan)(0))
					Call doc.Replaceitemvalue("IC_" & scan, negocio.Getitemvalue("IC_" & scan)(0))
					Call doc.Replaceitemvalue("ICD_" & scan, negocio.Getitemvalue("ICD_" & scan)(0))
					Call doc.Replaceitemvalue("FCP_" & scan, negocio.Getitemvalue("FCP_" & scan)(0))
					Call doc.Replaceitemvalue("IP_" & scan, negocio.Getitemvalue("IP_" & scan)(0))
					Call doc.Replaceitemvalue("II_" & scan, negocio.Getitemvalue("II_" & scan)(0))
				End If
			Next
			Call CalcTotaisNegocio(doc)
			Call StatusRenovacao(doc)
			Call doc.Computewithform(False, False)
			Call doc.save(True, True)
			'Gera/Atualiza Documento Público
			Call GeraDocumentoPublico(doc)
			MsgBox "Renovação Criada." & Chr(10) & "Consulte a vista Renovações", 64, "Aviso"
		End If
	End If
	'***
	
	%REM
	If x > 0 Then
		For x = 0 To UBound(Prazos)
			key(1) = CStr(prazos(x))
			Set doc = view.Getdocumentbykey(key, True)
			If doc Is Nothing Then
				Dim vencimento As New NotesDateTime(negocio.DataFechamento(0))
				Call vencimento.Adjustday(prazos(x))
				Set doc = New NotesDocument(db)
				doc.Form = "Renovacao"
				doc.Id = geraJavaId(doc)
				doc.IdOrigem = negocio.Id
				doc.CodigoOrigem = negocio.Codigo
				doc.Prazo = prazos(x)
				doc.Vencimento = CDat(vencimento.Dateonly)
				doc.Autor = session.CommonUserName
				doc.Criacao = Now
				doc.Cliente = negocio.Cliente
				doc.UF = negocio.UF
				doc.Contribuinte = negocio.Contribuinte
				doc.CodCliente = negocio.CodCliente
				doc.CodigoGrupoEconomico = negocio.CodigoGrupoEconomico
				doc.CodEmpresa = negocio.CodEmpresa
				doc.DataCotacaoUS = negocio.DataCotacaoUS
				doc.USC = negocio.USC
				doc.UST = negocio.UST
				doc.USCompra = negocio.USCompra
				doc.USVenda = negocio.USVenda
				'Adendo
				doc.Classe = "Adendo"
				doc.TipoAdendo = "Comercial"
				If negocio.Classe(0) = "Adendo" Then
					doc.NegocioPrincipal = negocio.NegocioPrincipal(0)
					doc.Grupo = negocio.NegocioPrincipal(0)
				Else
					doc.NegocioPrincipal = negocio.Codigo(0)
					doc.Grupo = negocio.Codigo(0)
				End If
				doc.TipoNegocio = negocio.TipoNegocio
				doc.Descricao = negocio.Descricao
				doc.OrigemOportunidade = negocio.OrigemOportunidade
				doc.Dias = 0
				doc.TipoVenda = "Venda Simples"
				doc.AreaVendas = negocio.AreaVendas
				doc.GerenteConta = negocio.GerenteConta
				doc.Inside = negocio.Inside
				doc.NomeComissao = negocio.NomeComissao
				doc.ParticipacaoComissao = negocio.ParticipacaoComissao
				doc.ContatoComercial = negocio.ContatoComercial
				doc.CargoComercial = negocio.CargoComercial
				doc.TelComercial = negocio.TelComercial
				doc.CelComercial = negocio.CelComercial
				doc.eMailComercial = negocio.eMailComercial
				doc.ContatoTecnico = negocio.ContatoTecnico
				doc.CargoTecnico = negocio.CargoTecnico
				doc.TelTecnico = negocio.TelTecnico
				doc.CelTecnico = negocio.CelTecnico
				doc.eMailTecnico = negocio.eMailTecnico
				doc.Parceria = negocio.Parceria
				doc.Temperatura = "Quente"
				doc.Sit = "Pendente"
				doc.SitNumero = "1"
				doc.PrazoPagamento = negocio.PrazoPagamento
				doc.PrazoPagamentoFornecedor = negocio.PrazoPagamentoFornecedor
				Call GeraCodigo(doc)
				'Lista de Materiais
				doc.ResultadoRevendaP = negocio.ResultadoRevendaP
				doc.FI_HW = negocio.FI_HW
				doc.FI_SW = negocio.FI_SW
				doc.FI_SV = negocio.FI_SV
				doc.Destino = negocio.Destino
				scan = 0
				For y = 0 To UBound(itens, 2)
					item = itens(x, y)
					If item > 0 Then
						item = item - 1
						Call doc.Replaceitemvalue("Q_" & scan, negocio.Getitemvalue("Q_" & item)(0))
						Call doc.Replaceitemvalue("PartNo_" & scan, negocio.Getitemvalue("PartNo_" & item)(0))
						Call doc.Replaceitemvalue("Produto_" & scan, negocio.Getitemvalue("Produto_" & item)(0))
						Call doc.Replaceitemvalue("t_" & scan, negocio.Getitemvalue("t_" & item)(0))
						Call doc.Replaceitemvalue("Un_" & scan, negocio.Getitemvalue("Un_" & item)(0))
						Call doc.Replaceitemvalue("CF_" & scan, negocio.Getitemvalue("CF_" & item)(0))
						Call doc.Replaceitemvalue("ST_" & scan, negocio.Getitemvalue("ST_" & item)(0))
						Call doc.Replaceitemvalue("Fabricante_" & scan, negocio.Getitemvalue("Fabricante_" & item)(0))
						Call doc.Replaceitemvalue("UFCompra_" & scan, negocio.Getitemvalue("UFCompra_" & item)(0))
						Call doc.Replaceitemvalue("ICC_" & scan, negocio.Getitemvalue("ICC_" & item)(0))
						Call doc.Replaceitemvalue("IPC_" & scan, negocio.Getitemvalue("IPC_" & item)(0))
						Call doc.Replaceitemvalue("us_" & scan, negocio.Getitemvalue("us_" & item)(0))
						Call doc.Replaceitemvalue("CustoFOB_" & scan, negocio.Getitemvalue("CustoFOB_" & item)(0))
						Call doc.Replaceitemvalue("FI_" & scan, negocio.Getitemvalue("FI_" & item)(0))
						Call doc.Replaceitemvalue("Custo_" & scan, negocio.Getitemvalue("Custo_" & item)(0))
						Call doc.Replaceitemvalue("ICMSSTC_" & scan, negocio.Getitemvalue("ICMSSTC_" & item)(0))
						Call doc.Replaceitemvalue("Mg_" & scan, negocio.Getitemvalue("Mg_" & item)(0))
						Call doc.Replaceitemvalue("CustoUnit_" & scan, negocio.Getitemvalue("CustoUnit_" & item)(0))
						Call doc.Replaceitemvalue("CusTot_" & scan, negocio.Getitemvalue("CusTot_" & item)(0))
						Call doc.Replaceitemvalue("ICMSST_" & scan, negocio.Getitemvalue("ICMSST_" & item)(0))
						Call doc.Replaceitemvalue("VendaTot_" & scan, negocio.Getitemvalue("VendaTot_" & item)(0))
						Call doc.Replaceitemvalue("IC_" & scan, negocio.Getitemvalue("IC_" & item)(0))
						Call doc.Replaceitemvalue("ICD_" & scan, negocio.Getitemvalue("ICD_" & item)(0))
						Call doc.Replaceitemvalue("FCP_" & scan, negocio.Getitemvalue("FCP_" & item)(0))
						Call doc.Replaceitemvalue("IP_" & scan, negocio.Getitemvalue("IP_" & item)(0))
						Call doc.Replaceitemvalue("II_" & scan, negocio.Getitemvalue("II_" & item)(0))
						scan = scan + 1
					End If
				Next
				Call CalcTotaisNegocio(doc)
				Call StatusRenovacao(doc)
				Call doc.Computewithform(False, False)
				Call doc.save(True, True)
				'Gera/Atualiza Documento Público
				Call GeraDocumentoPublico(doc)
				MsgBox "Renovação Criada." & Chr(10) & "Consulte a vista Renovações", 64, "Aviso"
			End If
		Next
	End If
	%END REM
	
End Sub

'++LotusScript Development Environment:2:2:GetValoresTimeSheet:5:8
%REM
	Sub GetValoresTimeSheet
	Description: Comments for Sub
%END REM
Sub GetValoresTimeSheet(planilha As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(planilha.Parentdatabase.Server, "TimeSheet.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim horasU As Double
	Dim planU As Double, gerU As Double, execU As Double, deslocamentoU As Double, docU As Double
	Dim kmU As Double, transU As Double, alimU As Double, teleU As Double
	Dim planPVU As Double, gerPVU As Double, execPVU As Double, deslocamentoPVU As Double, docPVU As Double
	Dim kmPVU As Double, transPVU As Double, alimPVU As Double, telePVU As Double
	Dim planPOCU As Double, gerPOCU As Double, execPOCU As Double, deslocamentoPOCU As Double, docPOCU As Double
	Dim kmPOCU As Double, transPOCU As Double, alimPOCU As Double, telePOCU As Double
	Set view = db.GetView("(TimeSheet/Codigo)")
	Set dc = view.GetAllDocumentsByKey(planilha.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		'Horas Ajustadas
		If CStr(doc.TotPeriodo(0)) <> "" Then
			horasU = Round(doc.TotPeriodo(0), 2)
		Else
			horasU = Round(CDbl(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60), 2)
		End If
		'*** Pré-Venda ***
		If doc.Tipo(0) = "PV" Then
			If doc.TipoHora(0) = "Plan" Then
				planPVU = planPVU + horasU
			ElseIf doc.TipoHora(0) = "Ger" Then
				gerPVU = gerPVU + horasU
			ElseIf doc.TipoHora(0) = "Exec" Then
				execPVU = execPVU + horasU
			ElseIf doc.TipoHora(0) = "Deslocamento" Then
				deslocamentoPVU = deslocamentoPVU + horasU
			ElseIf doc.TipoHora(0) = "Doc" Then
				docPVU = docPVU + horasU
			Else
				execPVU = execPVU + horasU
			End If
			kmPVU = kmPVU + Round(doc.Valor_0(0), 2)
			transPVU = transPVU + Round(doc.Valor_1(0), 2)
			alimPVU = alimPVU + Round(doc.Valor_2(0), 2)
			telePVU = telePVU + Round(doc.Valor_5(0), 2)
		'*** POC ***
		ElseIf doc.Tipo(0) = "POC" Then
			If doc.TipoHora(0) = "Plan" Then
				planPOCU = planPOCU + horasU
			ElseIf doc.TipoHora(0) = "Ger" Then
				gerPOCU = gerPOCU + horasU
			ElseIf doc.TipoHora(0) = "Exec" Then
				execPOCU = execPOCU + horasU
			ElseIf doc.TipoHora(0) = "Deslocamento" Then
				deslocamentoPOCU = deslocamentoPOCU + horasU
			ElseIf doc.TipoHora(0) = "Doc" Then
				docPOCU = docPOCU + horasU
			Else
				execPOCU = execPOCU + horasU
			End If
			kmPOCU = kmPOCU + Round(doc.Valor_0(0), 2)
			transPOCU = transPOCU + Round(doc.Valor_1(0), 2)
			alimPOCU = alimPOCU + Round(doc.Valor_2(0), 2)
			telePOCU = telePOCU + Round(doc.Valor_5(0), 2)
		'*** Execução ***
		'ElseIf doc.Tipo(0) = "Projeto" Or doc.Tipo(0) = "P" Or doc.Tipo(0) = "Contrato" Or doc.Tipo(0) = "C" Then
		ElseIf doc.Tipo(0) = "Projeto" Or doc.Tipo(0) = "P" Then
			If InStr(planilha.StatusNegocio(0), "Pré-Venda") = 0 And InStr(planilha.StatusNegocio(0), "POC") = 0 And planilha.StatusNegocio(0) <> "Forecast" Then
				'Total de Horas
				If doc.TipoHora(0) = "Plan" Then
					planU = planU + horasU
				ElseIf doc.TipoHora(0) = "Ger" Then
					gerU = gerU + horasU
				ElseIf doc.TipoHora(0) = "Exec" Then
					execU = execU + horasU
				ElseIf doc.TipoHora(0) = "Deslocamento" Then
					deslocamentoU = deslocamentoU + horasU
				ElseIf doc.TipoHora(0) = "Doc" Then
					docU = docU + horasU
				Else
					execU = execU + horasU
				End If
				'Total de Despesas
				kmU = kmU + Round(doc.Valor_0(0), 2)
				transU = transU + Round(doc.Valor_1(0), 2)
				alimU = alimU + Round(doc.Valor_2(0), 2)
				If doc.Hasitem(doc.Valor_5(0)) Then
					teleU = teleU + Round(doc.Valor_5(0), 2)
				End If
			End If
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	'*** Print Execução ***
		'Horas
		planilha.PlanU = planU
		planilha.GerU = gerU
		planilha.ExecU = execU
		planilha.DeslocamentoU = deslocamentoU
		planilha.DocU = docU
		'Despesas
		planilha.KmU = kmU
		planilha.TranspU = transU 
		planilha.AlimeU = alimU 
		planilha.TeleU = teleU
	'*** Print Pré-Venda ***
	'Horas
	planilha.PlanPVU = planPVU
	planilha.GerPVU = gerPVU
	planilha.ExecPVU = execPVU
	planilha.DeslocamentoPVU = deslocamentoPVU
	planilha.DocPVU = docPVU
	'Despesas
	planilha.KmPVU = kmPVU
	planilha.TranspPVU = transPVU 
	planilha.AlimePVU = alimPVU
	planilha.TelePVU = telePVU
	'*** Print POC ***
	'Horas
	planilha.PlanPOCU = planPOCU
	planilha.GerPOCU = gerPOCU
	planilha.ExecPOCU = execPOCU
	planilha.DeslocamentoPOCU = deslocamentoPOCU
	planilha.DocPOCU = docPOCU
	'Despesas
	planilha.KmPOCU = kmPOCU
	planilha.TranspPOCU = transPOCU
	planilha.AlimePOCU = alimPOCU
	planilha.TelePOCU = telePOCU
	
End Sub

'++LotusScript Development Environment:2:2:PopulaMatrizTarifacao:5:8
%REM
	Sub PopulaMatrizTarifacao
	Description: Comments for Sub
%END REM
Sub PopulaMatrizTarifacao(doc As NotesDocument)
	
	If doc.TipoVenda(0) <> "Contrato" Then Exit Sub
	Dim db As New NotesDatabase(doc.ParentDatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim config As NotesDocument
	Dim scan As Integer
	Set view = db.GetView("(CargaTributaria)")
	For scan = 0 To 9
		If doc.GetItemValue("CPartNo_" & scan)(0) <> "" Then
			Set config = view.GetDocumentByKey(doc.GetItemValue("CPartNo_" & scan)(0), True)
			If Not config Is Nothing Then
				Call doc.Replaceitemvalue("CNBS_" & scan, config.Codigo(0))
				If doc.GetItemValue("CTipo_" & scan)(0) = "Aluguel" Then
					Call doc.Replaceitemvalue("CRIR_" & scan, 0)
				Else
					Call doc.Replaceitemvalue("CRIR_" & scan, config.IRRF(0))
				End If
				Call doc.Replaceitemvalue("CRIN_" & scan, config.INSSRF(0))
				Call doc.Replaceitemvalue("CISS_" & scan, config.ISS(0))
			Else
				Call doc.Replaceitemvalue("CNBS_" & scan, "")
				Call doc.Replaceitemvalue("CRIR_" & scan, "")
				Call doc.Replaceitemvalue("CRIN_" & scan, "")
				Call doc.Replaceitemvalue("CISS_" & scan, "")
			End If
		Else
			Call doc.Replaceitemvalue("CNBS_" & scan, "")
			Call doc.Replaceitemvalue("CRIR_" & scan, "")
			Call doc.Replaceitemvalue("CRIN_" & scan, "")
			Call doc.Replaceitemvalue("CISS_" & scan, "")
		End If
	Next

End Sub

'++LotusScript Development Environment:2:1:FaturaContrato:5:8
%REM
	Sub FaturaContrato
	Description: Comments for Sub
%END REM
Function FaturaContrato(negocio As NotesDocument, tipoFaturamento As String) As Boolean
	
	'1)Gera Espelhos e Recibos de Locação
	'2)Gera Receber
	FaturaContrato = True
	Dim dataInicial As New NotesDateTime(negocio.DataInicial(0))
	Dim dataFinal As New NotesDateTime(negocio.DataFinal(0))
	If CDat(dataFinal.Dateonly) < CDat(Today) Then
		MsgBox "A Data Final do Contrato é passada. Nenhum item foi faturado.", 64, "Aviso"
		Exit Function
	End If
	Dim session As New NotesSession
	Dim dbempresas As New NotesDatabase(session.CurrentDatabase.Server, "empresas.nsf")
	Dim dbFat As New NotesDatabase(session.CurrentDatabase.Server, "faturas.nsf")
	Dim viewEmpresas As NotesView
	Dim empresa As NotesDocument, cliente As NotesDocument, espelho As NotesDocument
	Dim x As Integer, scan As Integer, scan2 As Integer, resp As Integer, qtd As Integer
	Dim codigo As Variant
	Dim tipo As String
	Dim ckEspelho As Boolean, ckItem As Boolean, ckParcelas As Boolean
	If tipoFaturamento = "Espelho" Then
		resp = MsgBox("Confirma a geração dos Espelhos do Contrato?", 36, "Espelhos do Contrato")
	Else
		resp = MsgBox("Confirma a geração das Faturas, Recibos e Receber do Contrato?", 36, "Faturamento do Contrato")
	End If
	If resp <> 6 Then
		FaturaContrato = False
		Exit Function
	End If
	'Verifica se a empresa e o cliente existe no BD Empresas
	Set viewempresas = dbempresas.GetView( "(Dados Cadastrais)" )
	Set empresa = viewempresas.GetDocumentByKey( negocio.CodEmpresa(0), True )
	If empresa Is Nothing Then
		Print "Erro no Contrato: " & negocio.Codigo(0) & " Emitente não está cadastrado em Empresas"
		FaturaContrato = False
		Exit Function
	End If
	Set cliente = viewempresas.GetDocumentByKey( negocio.CodClienteFaturamento(0), True )
	If cliente Is Nothing Then
		Print "Erro no Contrato: " & negocio.Codigo(0) & " Cliente não está cadastrado em Empresas"
		FaturaContrato = False
		Exit Function
	End If
	'Verifica o preenchimento dos Dados da Empresa e Cliente
	Dim ck As Variant
	ck = ckDadosEmpresa(empresa)
	If Not ck(0) Then
		MsgBox "Atualizar em Empresas os Campos:" + ck(1), 16, "Erro no Cadastro da Empresa " & negocio.CodEmpresa(0)
		FaturaContrato = False
		Exit Function
	End If
	ck = ckDadosEmpresa(cliente)
	If Not ck(0) Then
		MsgBox "Atualizar em Empresas os Campos:" + ck(1), 16, "Erro no Cadastro da Empresa " & negocio.CodClienteFaturamento(0)
		FaturaContrato = False
		Exit Function
	End If
	'Busca Código Fiscal (Operações - Estoque Main)
	codigo = BuscaCodigoFiscal("Prestação de Serviços")
	'Item
	For scan = 0 To 9
		'Flag Faturar precisa ser S (Sim)
		If negocio.Getitemvalue("Faturar_" & scan)(0) = "S" Then
			qtd = Val(negocio.Getitemvalue("CQs_" & scan)(0))
			If qtd > 0 Then
				ckItem = True
				If negocio.Getitemvalue("CTipo_" & scan)(0) = "Aluguel" Then
					tipo = "ReciboLocacao"
				Else
					tipo = "Espelho"
				End If
				'Data de Faturamento
				Dim faturamento As New NotesDateTime(negocio.DiaFaturamento(0) & "/" & Month(Today) & "/" & Year(Today))
				If negocio.TipoPagamento(0) = "Postecipado" Then
					Call faturamento.Adjustmonth(1, True)
				End If
				'Parcela
				For x = 1 To qtd
					'Ajusta a Data do Faturamento (Não pode ser Sábado, Domingo ou Feriado)
					Do Until Weekday(faturamento.DateOnly) <> 1 And Weekday(faturamento.DateOnly) <> 7 And Not ckFeriado(faturamento.DateOnly)
						Call faturamento.Adjustday(1, True)
					Loop
					'A Data de Faturamento precisa ser igual ou maior que Hoje
					If CDat(faturamento.Dateonly) < CDat(Today) Then Set faturamento = New NotesDateTime(Day(Today) & "/" & Month(faturamento.Dateonly) & "/" & Year(faturamento.Dateonly))
					'Data de Vencimento
					Dim vencimento As NotesDateTime
					If negocio.CondPagto(0) = "D.D.L." Then	'D.D.L. (Dias Decorridos Líquido)
						Set vencimento = New NotesDateTime(faturamento.Dateonly)
						Call vencimento.Adjustday(negocio.PrazoPagamento(0), True)
					ElseIf negocio.CondPagto(0) = "D.F.M." Then	'D.F.M. (Dias Fora Mês)
						Set vencimento = New NotesDateTime("01/" & Month(faturamento.Dateonly) & "/" & Year(faturamento.Dateonly))
						Call vencimento.AdjustMonth(1)
						Call vencimento.Adjustday(negocio.PrazoPagamento(0) - 1)
					ElseIf negocio.CondPagto(0) = "D.F.Q." Then	'D.F.Q. (Dias Fora Quinzena)
						If Day(faturamento.DateOnly) <= 15 Then
							'Faturado até dia 15
							Set vencimento = New NotesDateTime("15/" & Month(faturamento.DateOnly) & "/" & Year(faturamento.DateOnly))
							Call vencimento.Adjustday(negocio.PrazoPagamento(0))
						Else
							'Faturado após dia 15	
							Set vencimento = New NotesDateTime("01/" & Month(faturamento.DateOnly) & "/" & Year(faturamento.DateOnly))
							Call vencimento.AdjustMonth(1)
							Call vencimento.Adjustday(negocio.PrazoPagamento(0))
						End If
					ElseIf negocio.CondPagto(0) = "D.F.S." Then	'D.F.S. (Dias Fora Semana)
						Set vencimento = New NotesDateTime(faturamento.DateOnly)
						Do Until Weekday(vencimento.Dateonly) = 1
							Call vencimento.AdjustDay(1)
						Loop
						Call vencimento.Adjustday(negocio.PrazoPagamento(0))
					ElseIf negocio.CondPagto(0) = "D.F.V." Then	'D.F.V. (Dia Fixo de Vencimento)
						Set vencimento = New NotesDateTime(negocio.PrazoPagamento(0) & "/" & Month(faturamento.DateOnly) & "/" & Year(faturamento.DateOnly))
						If negocio.TipoPagamento(0) = "Postecipado" Then
							Call vencimento.Adjustmonth(1, True)
						End If
					End If
					'Ajusta Data do Vencimento (Não pode ser Sábado, Domingo ou Feriado)
					Do Until Weekday(vencimento.DateOnly) <> 1 And Weekday(vencimento.DateOnly) <> 7 And Not ckFeriado(vencimento.DateOnly)
						Call vencimento.Adjustday(1, True)
					Loop
	%REM
					'Última quarta-feira do mês - LMO 31/07/18
					Dim vencimento As New NotesDateTime("01/" & Month(faturamento.Dateonly) & "/" & Year(faturamento.Dateonly))
					Call vencimento.AdjustMonth(1)
					Call vencimento.Adjustday(-1)
					Do Until Weekday(vencimento.Dateonly) = 4
						Call vencimento.Adjustday(-1)
					Loop
	%END REM
					'Verifica se o documento já existe
					If tipoFaturamento <> "Espelho" Then
						Dim view As NotesView
						Dim doc As NotesDocument
						'Chave Negócio/Item/Parcela
						Dim chave(2) As String
						chave(0) = negocio.Codigo(0)
						chave(1) = (scan + 1)
						chave(2) = x
						Set view = dbFat.GetView("(Espelhos/Negocio/Item/Parcela)")
						Set doc = view.GetDocumentByKey(chave, True)
						If Not doc Is Nothing Then
							If doc.Sit(0) <> "Cancelada" Then
								GoTo proximo
							End If
						End If
					End If
					'Cria Faturamento
					Set espelho = New NotesDocument(dbFat)
					If tipoFaturamento = "Espelho" And tipo = "Espelho" Then
						espelho.Form = "EspelhoPrint"
					Else
						espelho.Form = tipo
					End If
					'Chave Item/Parcela
					espelho.Item = (scan + 1)
					espelho.Parcela = x
					'
					espelho.Id = geraJavaId(espelho)
					espelho.IDOrigem = negocio.UniversalID	
					espelho.Origem = negocio.DocID(0)
					espelho.Autor = session.Commonusername
					espelho.Criacao = Now
					If tipoFaturamento = "Espelho" Then
						espelho.Sit = "Espelho"
					Else
						espelho.Sit = "A Emitir"
					End If
					espelho.Tipo = "Serviços"
					'Área: Locação vai para a Área de Vendas
					If negocio.Getitemvalue("CTipo_" & scan)(0) = "Aluguel" Then
						espelho.Area = negocio.AreaVendas(0)
					Else
						'espelho.Area = negocio.Getitemvalue("CArea_" & scan)(0)
						espelho.Area = negocio.Area(0)
					End If
					espelho.AreaVendas = negocio.AreaVendas(0)
					'
					espelho.CodEspelho = GeraCodigoEspelho(espelho)
					espelho.GerenteConta = negocio.GerenteConta(0)
					espelho.Inside = negocio.Inside(0)    
					espelho.Codigo = negocio.Codigo(0)
					espelho.CodCliente = negocio.CodClienteFaturamento(0)
					espelho.CodClienteFatura = negocio.CodClienteFaturamento(0)
					espelho.CodigoGrupoEconomico = negocio.CodigoGrupoEconomico(0)
					espelho.CodEmpresa = negocio.CodEmpresa(0)
					espelho.Cliente = negocio.Cliente(0)
					'Aviso de Faturamento - LMO 19/04/18
					espelho.EnviarEmail = "Enviar"
					espelho.Comprador = negocio.Comprador(0)
					espelho.TelComprador = negocio.TelComprador(0)
					espelho.CelComprador = negocio.CelComprador(0)
					espelho.EmailComprador = negocio.EmailComprador(0)
					espelho.TelefoneInside = negocio.TelefoneInside(0)
					espelho.CelularInside = negocio.CelularInside(0)
					If cliente.Estado(0) = "SP" Then espelho.CodNatureza = codigo(0) Else espelho.CodNatureza = codigo(1)
					espelho.Natureza = "Prestação de Serviços"
					espelho.Descricao = negocio.Descricao(0) & " - Parcela " & x & "/" & qtd
					espelho.DataFaturamento = CDat(faturamento.Dateonly)
					espelho.Vencimento = CDat(vencimento.Dateonly)
					espelho.TipoComissionamento = negocio.TipoComissionamento(0)
					espelho.RegrasFiscais = negocio.RegrasFiscais(0)
					espelho.TipoCompra = "Revenda"
					espelho.TipoVenda = negocio.TipoVenda(0)
					espelho.Parceria = negocio.Parceria(0)
					espelho.TipoPagto = negocio.TipoPagto(0)
					espelho.USC = 1
					espelho.UST = 1
					espelho.AliqIRRF = 0
					espelho.AliqINSSRF = 0
					'Dados do Emitente
					espelho.ClienteE = empresa.Nome(0)
					espelho.EnderecoE = Trim(empresa.Endereco(0) & " " & empresa.Numero(0) & " " & empresa.Complemento(0))
					espelho.CepE = empresa.CEP(0)
					espelho.BairroE = empresa.Bairro(0)
					espelho.CidadeE = empresa.Cidade(0)
					espelho.EstadoE = empresa.Estado(0)
					espelho.CGCE = empresa.CGC(0)
					espelho.InscricaoE = empresa.Inscricao(0)
					espelho.TelefoneE = empresa.Telefones(0)
					'Dados do Sacado
					espelho.Cliente = cliente.Nome(0)
					espelho.Endereco = Trim(cliente.Endereco(0) & " " & cliente.Numero(0) & " " & cliente.Complemento(0))
					espelho.Cep = cliente.CEP(0)
					espelho.Bairro = cliente.Bairro(0)
					espelho.Cidade = cliente.Cidade(0)
					espelho.Estado = cliente.Estado(0)
					espelho.Pais = cliente.Pais(0)
					If cliente.CGC(0) <> "" Then
						espelho.TipoInscricao = "CNPJ"
						espelho.CGC = cliente.CGC(0)
					ElseIf cliente.CPF(0) <> "" Then
						espelho.TipoInscricao = "CPF"
						espelho.CGC = cliente.CGC(0)
					Else
						espelho.TipoInscricao = "CNPJ"
						espelho.CGC = cliente.CGC(0)
					End If
					espelho.Inscricao = cliente.Inscricao(0)
					'espelho.Telefone = cliente.Telefones(0)
					espelho.Telefone = GetPrimeiroTelefone(cliente.Telefones(0))
					espelho.Email = cliente.EmailNfeServicos(0)
					'Dados Adicionais
					espelho.DadosAdicionais_2 = "Pedido de Compra: " & negocio.Pedido(0) & GetDadosBancarios(negocio)
					espelho.Impostos = 0
					espelho.Pis = 0
					espelho.Cofins = 0
					espelho.Premio = 0
					espelho.CMV = 0
					Call espelho.ReplaceItemValue("TipoServ_0", "C")
					Call espelho.ReplaceItemValue("ItNotas_0", CStr(scan+1))
					Call espelho.ReplaceItemValue("Qs_0", 1)
					Call espelho.ReplaceItemValue("PNs_0", negocio.Getitemvalue("CPartNo_" & scan)(0))
					Call espelho.ReplaceItemValue("Produtos_0", negocio.Getitemvalue("CProdutos_" & scan)(0) & " - Parcela " & x & "/" & qtd)
					Call espelho.ReplaceItemValue("CusTots_0", negocio.GetItemValue("CCusTots_" & scan)(0))
					espelho.AliqIRRF = negocio.GetItemValue("CRIR_" & scan)(0)
					espelho.AliqINSSRF = negocio.GetItemValue("CRIN_" & scan)(0)
					espelho.AliqServico = negocio.GetItemValue("CISS_" & scan)(0)
					espelho.CodServico = negocio.GetItemValue("CNBS_" & scan)(0)
					'Calcula o Total  do Espelho
					Call CalcNota(espelho)
					'Criando Link para o Negocio
					Dim ligacao As NotesRichTextItem
					Set ligacao = espelho.CreateRichTextItem("LinkNegocio")
					Call ligacao.AppendDocLink(negocio, "Link para o Negocio "+ negocio.Codigo(0))   
					Call espelho.ComputeWithForm(False, False)
					Call espelho.Save(True, True)
					ckEspelho = True
					'Gera Receber
					Call GeraReceber(espelho)
proximo:
					'Data de Faturamento
					Set faturamento = New NotesDateTime(negocio.DiaFaturamento(0) & "/" & Month(faturamento.Dateonly) & "/" & Year(faturamento.Dateonly))
					Call faturamento.Adjustmonth(1)
				Next
			End If
		End If
	Next
	If ckEspelho Then
		If tipoFaturamento = "Espelho" Then
			MsgBox "Espelhos do Contrato gerados.", 64, "Aviso"
		Else
			MsgBox "Faturas, Recibos e Receber do Contrato gerados.", 64, "Aviso"
		End If
	ElseIf Not ckItem Then
		MsgBox "Você não selecionou nenhum item válido para Faturar.", 64, "Aviso"
	Else
		MsgBox "Todas as Parcelas do Contrato já foram geradas.", 64, "Aviso"
	End If
	
End Function


'++LotusScript Development Environment:2:2:FaturaMateriais:1:8
Sub FaturaMateriais( uidoc As NotesUiDocument )
	
	'Consiste Campos do Fechamento
	If Not ConsisteCamposFechamento(uidoc) Then
		Exit Sub
	End If
	'Consiste Campos Comprador
	If Not ConsisteComprador(uidoc) Then
		Exit Sub
	End If
	Dim session As New NotesSession
	Dim workspace As New NotesUiWorkspace
	Dim pedido As String, st As String, item As String
	Dim fator As Double, fi As Double, ip As Double, total As Double
	Dim scan As Integer, scan2 As Integer, scan3 As Integer
	'Condições de Pagamento (D.D.L.: Dias da Data Líquido; D.F.M.: Dias Fora Mês; D.F.Q.: Dias Fora Quinzena; D.F.V.: Dia Fixo de Vencimento)
	Dim dataFaturamento As New NotesDateTime(Today), vencimento As New NotesDateTime(Today)
	If uidoc.FieldGetText("CondPagto") = "D.F.M." Then	'D.F.M. (Dias Fora Mês)
		Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
		Call vencimento.AdjustMonth(1)
		Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0) - 1)
	ElseIf uidoc.FieldGetText("CondPagto") = "D.F.Q." Then	'D.F.Q. (Dias Fora Quinzena)
		If Day(dataFaturamento.DateOnly) <= 15 Then
			'1)Faturado até dia 15
			Set vencimento = New NotesDateTime("15/" & Month(Today) & "/" & Year(Today))
			Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
		Else	
			'2)Faturado após dia 15
			Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
			Call vencimento.AdjustMonth(1)
			Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
		End If
	ElseIf uidoc.FieldGetText("CondPagto") = "D.F.S." Then	'D.F.S. (Dias Fora Semana)
		Set vencimento = New NotesDateTime(Today)
		Do Until Weekday(vencimento.Dateonly) = 1
			Call vencimento.AdjustDay(1)
		Loop
		Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
	Elseif uidoc.FieldGetText("CondPagto") = "D.F.V." Then	'D.F.V. (Dia Fixo de Vencimento)
		Set vencimento = New NotesDateTime(uidoc.FieldGetText("PrazoPagamento") & "/" & Month(Today) & "/" & Year(Today))
	Elseif uidoc.FieldGetText("CondPagto") = "D.D.L." Then	'D.D.L. (Dias Decorridos Líquido)
		Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
	End If
	'Consistências
	For scan = 0 To 49
		If uidoc.FieldGetText("Q_" & scan) <> "" And uidoc.FieldGetText("QFat_" & scan) <> "" Then
			'Verifica Quantidade no Negócio e Quantidade de Faturamento
			If Val(uidoc.FieldGetText("QFat_" & scan)) > Val(uidoc.FieldGetText("Q_" & scan)) Then
				If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
				scan2 = scan2 + 1
			End If
			scan3 = scan3 + 1
		End If
	Next
	If scan2 > 0 Then
		MsgBox "A quantidade de Faturamento não pode ser maior do que a quantidade do Negócio no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio.", 16, "Erro !"
		Exit Sub
	End If
	If scan3 = 0 Then
		MsgBox "Você não informou nenhum item da Lista de Materiais para ser Faturado." & Chr(10) & "Informe no campo Saldos a Faturar", 16, "Erro !"
		Exit Sub
	End If
	'Fim das Consistências
	pedido = getPedido(uidoc.FieldGetText("Pedido"))
	Dim nota As NotesUiDocument
	Set nota = workspace.ComposeDocument("", "", "NotaMateriais")
	Call nota.FieldSetText("DataFaturamento", dataFaturamento.DateOnly)
	Call nota.FieldSetText("Vencimento", vencimento.DateOnly)
	Call nota.FieldSetText("Codigo", uidoc.FieldGetText("Codigo"))
	Call nota.FieldSetText("GerenteConta", uidoc.FieldGetText("GerenteConta"))
	Call nota.FieldSetText("Inside", uidoc.FieldGetText("Inside"))
	Call nota.FieldSetText("Renovacao", uidoc.FieldGetText("Renovacao"))
	Call nota.FieldSetText("Parceria", uidoc.FieldGetText("Parceria"))
	Call nota.FieldSetText("CodCliente", uidoc.FieldGetText("CodCliente"))
	Call nota.FieldSetText("CodClienteFaturamento", uidoc.FieldGetText("CodCliente"))
	Call nota.FieldSetText("Contribuinte", uidoc.FieldGetText("Contribuinte"))
	Call nota.FieldSetText("InscricaoSuframa", uidoc.FieldGetText("InscricaoSuframa"))
	Call nota.FieldSetText("CodEmpresa", uidoc.FieldGetText("CodEmpresa"))
	Call nota.FieldSetText("CondPagto", uidoc.FieldGetText("PrazoPagamento") & uidoc.FieldGetText("CondPagto"))
	Call nota.FieldSetText("TipoPagto", uidoc.FieldGetText("TipoPagto"))
	Call nota.FieldSetText("Pedido", pedido)
	'Todas as Áreas de Lista de Materiais serão Vendas - LMO 14/06/24
	Call nota.FieldSetText("Area", uidoc.FieldGetText("AreaVendas"))
	Call nota.FieldSetText("AreaVendas", uidoc.FieldGetText("AreaVendas"))
	'
	Call nota.FieldSetText("UF", uidoc.FieldGetText("UF"))
	Call nota.FieldSetText("Destino",  uidoc.FieldGetText("Destino"))
	Call nota.FieldSetText("TipoComissionamento", uidoc.FieldGetText("TipoComissionamento"))
	Call nota.FieldSetText("Tipo", "Nota")
	Call nota.FieldSetText("TipoCompra", "Revenda")
	Call nota.FieldSetText("TipoVenda", uidoc.FieldGetText("TipoVenda"))
	'Aviso de Faturamento - LMO 19/04/18
	Call nota.FieldSetText("Comprador", uidoc.FieldGetText("Comprador"))
	Call nota.FieldSetText("TelComprador", uidoc.FieldGetText("TelComprador"))
	Call nota.FieldSetText("CelComprador", uidoc.FieldGetText("CelComprador"))
	Call nota.FieldSetText("EmailComprador", uidoc.FieldGetText("EmailComprador"))
	Call nota.FieldSetText("TelefoneInside", uidoc.FieldGetText("TelefoneInside"))
	Call nota.FieldSetText("CelularInside", uidoc.FieldGetText("CelularInside"))
	Call nota.FieldSetText("EnviarEmail", uidoc.FieldGetText("EnviarEmail"))
	'Busca Cotação da Moeda
	Dim moeda As Variant
	moeda = GetMoedas
	'US$C Venda Fixo - LMO 08/01/18
	If IsNumeric(uidoc.Fieldgettext("USVenda")) Then
		Call nota.FieldSetText("USC", uidoc.Fieldgettext("USVenda"))
	Else
		Call nota.FieldSetText("USC", CStr(moeda(0)))
	End If
	Call nota.FieldSetText("UST", CStr(moeda(1)))
	'Listas
	Dim doc As NotesDocument
	Dim listas As New NotesDatabase(uidoc.Document.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Set view = listas.GetView("(NegocioNItens)")
	Dim codigo As String
	codigo$ = uidoc.FieldGetText("Codigo")
	Dim ck As Long, ckq As Long, saldoFat As Long
	Dim tipo As String, tipoAnterior As String
	Dim icAnterior As Double, ipAnterior As Double, icd As Double
	Dim msg As Variant
	For scan = 0 To 49
		'Dados Adicionais
		If scan = 0 Then
			If tipoAnterior = "SW" Then
				Call nota.FieldSetText("ObsCorpo", "Base de cálculo do ICMS Conforme o artigo 51-A-RICMS/91 do Decreto 35.674 de 15/09/92"_
				& Chr(10) & "Pedido de Compra: " & uidoc.FieldGetText("Pedido") & GetDadosBancarios(uidoc.Document))
			Else
				Call nota.FieldSetText("ObsCorpo", "Pedido de Compra: " & uidoc.FieldGetText("Pedido") & GetDadosBancarios(uidoc.Document))
			End If
		End If
		ck = Val(uidoc.FieldGetText("QFat_" & scan))
		ckq = Val(uidoc.FieldGetText("Q_" & scan))
		If ck > 0 And ckq > 0 Then
			Set doc = view.getDocumentByKey(codigo & "-" & (scan + 1), True)
			If Not doc Is Nothing Then
				'Diferencial de ICMS
				If CStr(doc.ICD(0)) <> "" Then icd = doc.ICD(0) Else icd = 0
				'Verifica saldos para faturamento
				saldoFat = doc.Q(0) - doc.QFat(0)
				If ck > saldoFat Then
					msg = Msgbox("O saldo máximo para faturamento do ítem Nº " & (scan + 1) &" é de " & saldoFat, 16, "Você entrou com uma quantidade inválida")
					Goto refresh
				End If
				'Verifica se houve troca de tipo de produto no mesmo pedido
				If scan2 > 0 Then
					If tipoAnterior <> doc.T(0) Then
						msg = Msgbox("Você não pode pedir ítens de tipos diferentes no mesmo Pedido", 16, "Tipos de Ítens Diferentes no Mesmo Pedido")
						Goto refresh
					End If
				End If
				'Verifica se as alíquotas de retenção de IR e INSS são as mesmas
				If doc.T(0) <> "HW" Then
					If (doc.T(0) = "SV" Or doc.T(0) = "SW") And scan2 > 0 Then
						If doc.IC(0) <> icAnterior Or doc.IPI(0) <> ipAnterior Then
							Msgbox("Você entrou com itens com retenções de IR e INSS diferentes para a mesma Nota Fiscal")
							Goto refresh
						End If
					End If
				End If
				'
				Call nota.FieldSetText("Q_" & scan2, Cstr(ck))
				Call nota.FieldSetText("NItem_" & scan2, doc.NItem(0)) 
				Call nota.FieldSetText("PartNo_" & scan2, doc.PartNo(0))
				Call nota.FieldSetText("Produto_" & scan2, doc.Produto(0))
				Call nota.FieldSetText("Un_" & scan2, doc.Un(0))
				Call nota.FieldSetText("Us_" & scan2, Cstr(doc.US(0)))
				Call nota.FieldSetText("CF_" & scan2, doc.CF(0))
				'CST e IPI
				If doc.T(0) = "HW" Then
					'Converte Origem
					If CStr(doc.FI(0)) <> "" Then fi = doc.FI(0) Else fi = 0
					If fi > 0 Then
						'Importação TDec
						st = Left(doc.ST(0), 1)
						ip = doc.IPI(0)
					ElseIf Left(doc.ST(0), 1) = "1" Then
						st = "2"
						ip = 0
					ElseIf Left(doc.ST(0), 1) = "6" Then
						st = "7"
						ip = 0
					Else
						st = Left(doc.ST(0), 1)
						ip = 0
					End If
					'Converte Situação Tributária
					'Venda para SP
					If uidoc.FieldGetText("UF") = "SP" Then
						'Importação TDec
						If fi > 0 Then
							st = st & "00"
						'Substituição Tributária
						ElseIf Right(doc.ST(0), 2) = "10" Or Right(doc.ST(0), 2) = "70" Then
							st = st & "60"
						Else
							'Compra de Fora de SP
							If doc.UFCompra(0) <> "SP" And doc.UFCompra(0) <> "EX" And Right(doc.ST(0), 2) = "00" And doc.IC(0) = 0 Then
								st = st & "60"
							'Compra de SP
							Else
								st = st & Right(doc.ST(0), 2)
							End If
						End If
					'Venda para Fora de SP
					Else
						'Com Diferencial de ICMS
						If icd > 0 And uidoc.FieldGetText("Contribuinte") <> "Não" Then
							st = st & "10"
						'Sem Diferencial de ICMS
						Else
							st = st & "00"	'Conforme Gleidi (sametime) - LMO 16/02/24
						End If
					End If
				Else 'SW/SV
					'Converte Origem - LMO 24/06/2022
					If CStr(doc.FI(0)) <> "" Then fi = doc.FI(0) Else fi = 0
					If fi > 0 Then
						st = Left(doc.ST(0), 1)
					ElseIf Left(doc.ST(0), 1) = "1" Then
						st = "2"
					ElseIf Left(doc.ST(0), 1) = "6" Then
						st = "7"
					Else
						st = Left(doc.ST(0), 1)
					End If
					st = st & Right(doc.ST(0), 2)
					ip = doc.IPI(0)
				End If
				Call nota.FieldSetText("ST_" & scan2, st)
				'Moeda
				If doc.US(0) = "US$C" Then
					fator = moeda(0)
				Elseif doc.US(0) = "US$T" Then
					fator = moeda(1)
				Else
					fator = 1
				End If
				'Listas: ICMSST/BCICMSST/AlíquotaFCP/AlíquotaPIS/AlíquotaCOFINS
				Dim icmsst As Double, bcICMSST As Double, aliquotaFCP As Double, aliquotaPIS As Double, aliquotaCOFINS As Double
				If CStr(doc.ICMSST(0)) = "" Then icmsst = 0 Else icmsst = Round(doc.ICMSST(0)/doc.Q(0),4)
				If CStr(doc.BCICMSST(0)) = "" Then bcICMSST = 0 Else bcICMSST = Round(doc.BCICMSST(0)/doc.Q(0),4)
				If CStr(doc.FCP(0)) = "" Then aliquotaFCP = 0 Else aliquotaFCP = Round(doc.FCP(0),2)
				If CStr(doc.AliquotaPIS(0)) = "" Then aliquotaPIS = 0 Else aliquotaPIS = doc.AliquotaPIS(0)
				If CStr(doc.AliquotaCOFINS(0)) = "" Then aliquotaCOFINS = 0 Else aliquotaCOFINS = doc.AliquotaCOFINS(0)
				'Não Contribuinte (Valor de Venda é igual a BC-ICMSST)
				If uidoc.FieldGetText("Contribuinte") = "Não" And icd > 0 Then
					Call nota.FieldSetText("Custo_" & scan2, CStr(bcICMSST))
				Else
					Call nota.FieldSetText("Custo_" & scan2, CStr(doc.CustoUnit(0) + icmsst))
				End If
				Call nota.FieldSetText("ICMSST_" & scan2, CStr(icmsst))
				Call nota.FieldSetText("BCICMSST_" & scan2, CStr(bcicmsst))
				Call nota.FieldSetText("IC_" & scan2, Format(doc.IC(0), "Percent"))
				Call nota.FieldSetText("ICST_" & scan2, Format(icd, "Percent"))
				Call nota.FieldSetText("FCP_" & scan2, Format(aliquotaFCP, "Percent"))
				Call nota.FieldSetText("IP_" & scan2, Format(ip, "Percent"))
				Call nota.FieldSetText("AliquotaPIS_" & scan2, Format(aliquotaPIS, "Percent"))
				Call nota.FieldSetText("AliquotaCOFINS_" & scan2, Format(aliquotaCOFINS, "Percent"))
				total = total + (doc.CustoUnit(0) * ck * fator)
				scan2 = scan2 + 1
				tipoAnterior = doc.T(0)
				icAnterior = doc.IC(0)
				ipAnterior = doc.IPI(0)
			End If
		End If
	Next
refresh: 'Finalização da Função com classificação da nota em caso de erro
	Call nota.FieldSetText("Total", Format(total, "Standard"))
	Call nota.FieldSetText("Valor", Format(total, "Standard"))
	If tipoAnterior = "HW" Then
		tipo = "Hardware"
	Elseif tipoAnterior = "SW" Then
		tipo = "Software"
	Else
		tipo = "Serviços"
	End If
	Call nota.FieldSetText("TipoNF", tipo)
	'Calcula o CustoUnit/CusTot
	Call nota.Refresh
	
End Sub

'++LotusScript Development Environment:2:2:Ofensores:5:8
%REM
	Sub Ofensores
	Description: Comments for Sub
%END REM
Sub Ofensores(negocio As NotesDocument, newDoc As NotesDocument)
	
	Dim ofensor(24) As String
	Dim previsto(24) As Double
	Dim realizado(24) As Double
	Dim diferenca(24) As Double
	ofensor(0) = "Venda Materiais:"
	ofensor(1) = "Venda Serviços:"
	ofensor(2) = "CMV:"
	ofensor(3) = "Importação:"
	ofensor(4) = "CSV:"
	ofensor(5) = "Variação Cambial:"
	ofensor(6) = "ICMS:"
	ofensor(7) = "ICMS-ST:"
	ofensor(8) = "IPI:"
	ofensor(9) = "ISS:"
	ofensor(10) = "INSS:"
	ofensor(11) = "PIS:"
	ofensor(12) = "COFINS:"
	ofensor(13) = "CSLL:"
	ofensor(14) = "IRPJ:"
	ofensor(15) = "Contribuição Previden.:"
	ofensor(16) = "Visitas:"
	ofensor(17) = "Frete:"
	ofensor(18) = "Terceiros:"
	ofensor(19) = "Planilha:"
	ofensor(20) = "Pré-Venda:"
	ofensor(21) = "POC:"
	ofensor(22) = "Capital Giro:"
	ofensor(23) = "Encargos:"
	ofensor(24) = "Intermediação:"
	'ofensor(25) = "Participação:"
	'Valor Previsto
	previsto(0) = negocio.VendaM_P(0)
	previsto(1) = negocio.VendaS_P(0)
	previsto(2) = negocio.Custo_P(0)
	previsto(3) = negocio.CustoImp_P(0)
	previsto(4) = negocio.CustosHoras_P(0)
	previsto(5) = negocio.Cambio_P(0)
	previsto(6) = negocio.ICMS_P(0)
	previsto(7) = negocio.ICMSSTC_P(0)
	previsto(8) = negocio.IPI_P(0)
	previsto(9) = negocio.ISS_P(0)
	previsto(10) = negocio.INSS_P(0)
	previsto(11) = negocio.PIS_P(0)
	previsto(12) = negocio.COFINS_P(0)
	previsto(13) = negocio.CSLL_P(0)
	previsto(14) = negocio.IRPJ_P(0)
	previsto(15) = negocio.CPR_P(0)
	previsto(16) = negocio.Atividades_P(0)
	previsto(17) = negocio.Despesas_P(0)
	previsto(18) = negocio.TerceirosFaturaveis_P(0)
	previsto(19) = negocio.PF_P(0)
	previsto(20) = negocio.PreVenda_P(0)
	previsto(21) = negocio.POC_P(0)
	previsto(22) = negocio.Juros_P(0)
	previsto(23) = negocio.Encargos_P(0)
	previsto(24) = negocio.Intermediacao_P(0)
	'previsto(25) = negocio.Participacao_P(0)
	'Valor Realizado
	realizado(0) = negocio.VendaM_R(0)
	realizado(1) = negocio.VendaS_R(0)
	realizado(2) = negocio.Custo_R(0)
	realizado(3) = negocio.CustoImp_R(0)
	realizado(4) = negocio.CustosHoras_R(0)
	realizado(5) = negocio.Cambio_R(0)
	realizado(6) = negocio.ICMS_R(0)
	realizado(7) = negocio.ICMSSTC_R(0)
	realizado(8) = negocio.IPI_R(0)
	realizado(9) = negocio.ISS_R(0)
	realizado(10) = negocio.INSS_R(0)
	realizado(11) = negocio.PIS_R(0)
	realizado(12) = negocio.COFINS_R(0)
	realizado(13) = negocio.CSLL_R(0)
	realizado(14) = negocio.IRPJ_R(0)
	realizado(15) = negocio.CPR_R(0)
	realizado(16) = negocio.Atividades_R(0)
	realizado(17) = negocio.Despesas_R(0)
	realizado(18) = negocio.TerceirosFaturaveis_R(0)
	realizado(19) = negocio.PF_R(0)
	realizado(20) = negocio.PreVenda_R(0)
	realizado(21) = negocio.POC_R(0)
	realizado(22) = negocio.Juros_R(0)
	realizado(23) = negocio.Encargos_R(0)
	realizado(24) = negocio.Intermediacao_R(0)
	'realizado(25) = negocio.Participacao_R(0)
	'Diferença
	diferenca(0) = negocio.VendaM_D(0)
	diferenca(1) = negocio.VendaS_D(0)
	diferenca(2) = negocio.Custo_D(0)
	diferenca(3) = negocio.CustoImp_D(0)
	diferenca(4) = negocio.CustosHoras_D(0)
	diferenca(5) = negocio.Cambio_D(0)
	diferenca(6) = negocio.ICMS_D(0)
	diferenca(7) = negocio.ICMSSTC_D(0)
	diferenca(8) = negocio.IPI_D(0)
	diferenca(9) = negocio.ISS_D(0)
	diferenca(10) = negocio.INSS_D(0)
	diferenca(11) = negocio.PIS_D(0)
	diferenca(12) = negocio.COFINS_D(0)
	diferenca(13) = negocio.CSLL_D(0)
	diferenca(14) = negocio.IRPJ_D(0)
	diferenca(15) = negocio.CPR_D(0)
	diferenca(16) = negocio.Atividades_D(0)
	diferenca(17) = negocio.Despesas_D(0)
	diferenca(18) = negocio.TerceirosFaturaveis_D(0)
	diferenca(19) = negocio.PF_D(0)
	diferenca(20) = negocio.PreVenda_D(0)
	diferenca(21) = negocio.POC_D(0)
	diferenca(22) = negocio.Juros_D(0)
	diferenca(23) = negocio.Encargos_D(0)
	diferenca(24) = negocio.Intermediacao_D(0)
	'diferenca(25) = negocio.Participacao_D(0)
	'Ordem Decrescente
	'Dim pos(25) As Integer, x As Integer, y As Integer
	Dim pos(24) As Integer, x As Integer, y As Integer
	For x = 0 To UBound(ofensor)
		For y = 0 To UBound(ofensor)
			If Abs(diferenca(y)) > Abs(diferenca(x)) Then
				pos(x) = pos(x) + 1
			End If
		Next
	Next
	'Print: 4 principais Ofensores
	For x = 0 To 3
		For y = 0 To UBound(pos)
			If pos(y) = x Then
				If diferenca(y) <> 0 Then
					Call newDoc.Replaceitemvalue("Ofensor_" & x, ofensor(y))
					Call newDoc.Replaceitemvalue("Previsto_" & x, previsto(y))
					Call newDoc.Replaceitemvalue("Realizado_" & x, realizado(y))
					Call newDoc.Replaceitemvalue("Diferenca_" & x, diferenca(y))
				End If
				Exit For
			End If
		Next
	Next
	
End Sub

'++LotusScript Development Environment:2:1:BuscaCargaMedia:5:8
%REM
	Function BuscaCargaMedia
	Description: Comments for Function
%END REM
Function BuscaCargaMedia(uf As String, cnae As String) As Variant
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	ReDim Preserve array(1) As Variant
	Dim key(1) As String
	Set view = db.Getview("(CargaMedia)")
	key(0) = uf
	key(1) = cnae
	Set doc = view.Getdocumentbykey(key, True)
	'Não consultou CNAE
	If doc Is Nothing Then
		array(0) = False
		'Consultou CNAE
	Else
		'Verifica a Data da Última Consulta do CNAE
		If Month(doc.DataPesquisa(0)) & Year(doc.DataPesquisa(0)) = Month(Today) & Year(Today) Then
			array(0) = doc.CargaMedia(0)
			array(1) = doc.FCP(0)
			'CNAE Desatualizado
		Else
			array(0) = False
		End If
	End If
	BuscaCargaMedia = array
	
End Function

'++LotusScript Development Environment:2:2:SolicitaAprovacaoMargemFatorInferior:1:8
Sub SolicitaAprovacaoMargemFatorInferior(doc As NotesDocument, tipo As String)
	
	Dim session As New NotesSession
	Dim resp As String
	If tipo = "Frete Revenda" Then
		resp = InputBox("Informe a Justificativa:", tipo, "")
		If resp = "" Then End
		doc.Justifica_FreteRevenda = resp
		doc.SolicitadoPor_FreteRevenda = session.Commonusername
		doc.DataSolicitacao_FreteRevenda = Now
		'
		doc.Status_FreteRevenda = "Aguardando Aprovação"
		doc.AprovadoPor_FreteRevenda = ""
		doc.DataAprovacao_FreteRevenda = ""
	ElseIf tipo = "Frete Projeto" Then
		resp = InputBox("Informe a Justificativa:", tipo, "")
		If resp = "" Then End
		doc.Justifica_FreteProjeto = resp
		doc.SolicitadoPor_FreteProjeto = session.Commonusername
		doc.DataSolicitacao_FreteProjeto = Now
		'
		doc.Status_FreteProjeto = "Aguardando Aprovação"
		doc.AprovadoPor_FreteProjeto = ""
		doc.DataAprovacao_FreteProjeto = ""
	ElseIf tipo = "Margem Item" Then
		resp = InputBox("Informe a Justificativa:", tipo, "")
		If resp = "" Then End
		doc.Justifica_MI = resp
		doc.SolicitadoPor_MI = session.Commonusername
		doc.DataSolicitacao_MI = Now
		'
		doc.Status_MI = "Aguardando Aprovação"
		doc.AprovadoPor_MI = ""
		doc.DataAprovacao_MI = ""
	ElseIf tipo = "FI" Then
		resp = InputBox("Informe a Justificativa:", tipo, "")
		If resp = "" Then End
		doc.Justifica_FI = resp
		doc.SolictadoPor_FI = session.Commonusername
		doc.DataSolicitacao_FI = Now
		'
		doc.Status_FI = "Aguardando Aprovação"
		doc.AprovadoPor_FI = ""
		doc.DataAprovacao_FI = ""
		doc.FIAprovado_HW = ""
		doc.FIAprovado_SW = ""
		doc.FIAprovado_SV = ""
	Else
		resp = InputBox("Informe a Justificativa:", tipo, "")
		If resp = "" Then End
		doc.TipoSolicitacao = tipo
		doc.Justifica = resp
		doc.SolicitadoPor = session.Commonusername
		doc.DataSolicitacao = Now
		If tipo = "Margem Negócio" Then
			doc.MgSolicitada = doc.Res_P(0)
		ElseIf tipo = "Margem Revenda" Then
			doc.MgSolicitada = doc.ResM_P(0)
		ElseIf tipo = "Margem Serviços" Then
			doc.MgSolicitada = doc.ResS_P(0)
		End If
		'
		doc.StatusMg = "Aguardando Aprovação"
		doc.AprovadoPor = ""
		doc.DataAprovacao = ""
		doc.MgAprovada = ""
	End If
	doc.Sit =  "Aguardando Aprovação"
	doc.SitNumero =  15
	doc.TipoAprovacao = tipo
	'Email de Solicitação de Aprovação
	Call AvisoMgPrevista(doc, "Solicita Aprovação " & tipo)
	Call doc.Save(False, False)
	'Salva Lista de Materiais no db Listas
	Call SaveListaMateriais(doc)
	'Salva Lista de Serviços no db Listas
	Call SaveListaServicos(doc)
	
End Sub

'++LotusScript Development Environment:2:1:GeraCodigoEspelho:1:8
Function GeraCodigoEspelho (fatura As NotesDocument) As Variant
	
	Dim db As New NotesDatabase (fatura.ParentDatabase.Server, "faturas.nsf")
	Dim dc As NotesDocumentCollection, view As NotesView
	Set view = db.GetView( "(EspelhosNegocio)" )
	Set dc = view.GetAllDocumentsByKey(fatura.Codigo(0), True)
	Dim ckCodigo As String
	ckCodigo = fatura.Codigo(0) + "|" + CStr(dc.Count + 1)
	GeraCodigoEspelho = ckCodigo     
	
End Function

'++LotusScript Development Environment:2:2:AlteraListaServicos:5:8
%REM
	Sub AlteraListaServicos
	Description: Comments for Sub
%END REM
Sub AlteraListaServicos( uidoc As NotesUIDocument )
	
	Dim session As New NotesSession
	Dim listas As New NotesDatabase(uidoc.Document.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Set view = listas.GetView("(NegocioNServicos)")
	Dim doc As NotesDocument
	Dim dc As NotesDocumentCollection
	Dim item As NotesDocument
	Dim array As Variant, scan As Integer
	Dim codigo As String, partN As String, custo As Double, terceiros As Double, mg As Double, valor As Double, total As Double, despesa As Double, cps As Double, ir As Double, inss As Double, iss As Double
	Dim terceirosDoc As Double, despesaDoc As Double, cpsDoc As Double
	Dim flag As Variant, boxtype As Long, answer As Integer
	codigo$ = uidoc.FieldGetText("Codigo")
	Dim ligacao As NotesRichTextItem                              
	Dim valorLimite As Double, ck As Long
	If Not checkItensListaServicos(uidoc) Then
		MsgBox "Os itens não foram atualizados em Listas", 16, "Erro"
		Exit Sub
	End If
	'*** Solicita Aprovação da Margem do Negócio inferior a Margem Prevista do Negócio ***
	If CheckMgNegocio(uidoc.Document) Then
		answer = MessageBox("A Margem do Negócio é menor que " & uidoc.FieldGetText("Resultado") & Chr(10) & "Deseja solicitar aprovação para utilização dessa Margem?", 4+32+256+4096, "Alterar Lista de Serviços")
		If answer = 6 Then
			Call SolicitaAprovacaoMargemFatorInferior(uidoc.Document, "Margem Negócio")
			uidoc.Document.SaveOptions = "0"
			uidoc.Close
			Exit Sub
		Else
			MsgBox "Os itens não foram atualizados em Listas", 16, "Erro"
			Call LoadListaServicos(uidoc.Document)
			Exit Sub
		End If
	'*** Solicitação de Aprovação da Margem de Serviços inferior a Margem Prevista de Serviços *** LMO 15/08/18
	ElseIf CheckMgServicos(uidoc.Document) Then
		answer = MessageBox("A Margem de Serviços é menor que " & uidoc.FieldGetText("MgServicosM") & Chr(10) & "Deseja solicitar aprovação para utilização dessa Margem?", 4+32+256+4096, "Alterar Lista de Serviços")
		If answer = 6 Then
			Call SolicitaAprovacaoMargemFatorInferior(uidoc.Document, "Margem Serviços")
			uidoc.Document.SaveOptions = "0"
			uidoc.Close
			Exit Sub
		Else
			MsgBox "Os itens não foram atualizados em Listas", 16, "Erro"
			Call LoadListaServicos(uidoc.Document)
			Exit Sub
		End If
	'*** Altera a Lista de Serviços (Margem Maior ou Igual a Margem Prevista) ***
	Else
		For scan% = 0 To 11
			Set doc = view.getDocumentByKey( codigo$ & "-" & CStr(scan% + 1) )
			If uidoc.FieldGetText("Custos_" & scan) = "" Then custo = 0 Else custo = CDbl(uidoc.FieldGetText("Custos_" & scan))
			If uidoc.FieldGetText("Terceiros_" & scan) = "" Then terceiros = 0 Else terceiros = CDbl(uidoc.FieldGetText("Terceiros_" & scan))
			If uidoc.FieldGetText("Mgs_" & scan) = "" Then mg = 0 Else mg = CDbl(uidoc.FieldGetText("Mgs_" & scan))
			If uidoc.FieldGetText("CustoUnits_" & scan) = "" Then valor = 0 Else valor = CDbl(uidoc.FieldGetText("CustoUnits_" & scan))
			If uidoc.FieldGetText("CusTots_" & scan) = "" Then total = 0 Else total = CDbl(uidoc.FieldGetText("CusTots_" & scan))
			If uidoc.FieldGetText("Despesas_" & scan) = "" Then despesa = 0 Else despesa = CDbl(uidoc.FieldGetText("Despesas_" & scan))
			If uidoc.FieldGetText("CPS_" & scan) = "" Then cps = 0 Else cps = CDbl(uidoc.FieldGetText("CPS_" & scan))
			If uidoc.FieldGetText("RIR_" & scan) = "" Then ir = 0 Else ir = CDbl(uidoc.FieldGetText("RIR_" & scan))
			If uidoc.FieldGetText("RIN_" & scan) = "" Then inss = 0 Else inss = CDbl(uidoc.FieldGetText("RIN_" & scan))
			If uidoc.FieldGetText("ISS_" & scan) = "" Then iss = 0 Else iss = CDbl(uidoc.FieldGetText("ISS_" & scan))
			If Not(doc Is Nothing) Then
				If doc.Hasitem("Terceiros") Then terceirosDoc = doc.Terceiros(0) Else terceirosDoc = 0
				If doc.Hasitem("Despesas") Then despesaDoc = doc.Despesas(0) Else despesaDoc = 0
				If doc.Hasitem("CPS") Then cpsDoc = doc.CPS(0) Else cpsDoc = 0
				If doc.Hasitem("PartN") Then partN = doc.PartN(0) Else partN = ""
				If doc.Qs(0) <> Val(uidoc.FieldGetText("Qs_" + CStr(scan))) Or partN <> uidoc.FieldGetText("PartNos_" + CStr(scan)) Or doc.Produtos(0) <> uidoc.FieldGetText("Produtos_" + CStr(scan)) Or doc.Us(0) <> uidoc.FieldGetText("uss_" + CStr(scan)) Or doc.Custos(0) <> custo Or terceirosDoc <> terceiros Or doc.Mgs(0) <> mg Or doc.CustoUnits(0) <> valor Or despesaDoc <> despesa Or cpsDoc <> cps Or doc.RIR(0) <> ir Or doc.RIN(0) <> inss Or doc.ISS(0) <> iss Then
					valorLimite# = doc.CusTots(0) - doc.VlFat(0) 'o valor que ainda falta ser faturado é o limite para alteração dos valores e quantidades
					'If valorLimite# = 0 Then 'tudo já foi faturado 'Comentado, eu não entendi o porque dessa trava e o comercial tinha que faturar mais um valor - LMO 05/10/2023
					'	MsgBox("O item " + CStr(scan% + 1) + " já foi totalmente faturado e não pode ser alterado" )	
					'Else
					If doc.VlFat(0) > total Then
						answer% = MessageBox("O Investimento Total não pode ser menor que o Valor Faturado " + Format(CStr(doc.VlFat(0)), "Standard") + " no item " + CStr(scan% + 1), boxType&,  "Você alterou a quantidade do Serviço " & CStr(scan% + 1))
					Else
						ck = Val( uidoc.FieldGetText( "Qs_" & CStr( scan%) ) )
						If ck = 0 Then
							If doc.VlFat(0) > 0 Then
								answer% = MessageBox("O item " + CStr(scan% + 1) + " não pode ser deletado pois já foi faturado", boxType&,  "Você alterou a quantidade do Serviço "& CStr(scan% + 1) & " para zero !")
							Else
								boxType& = 4+32+256+4096
								answer% = MessageBox("Isto irá deletar o Serviço. Confirma a Deleção do Serviço ?" & CStr(scan% + 1), boxType&,  "Você alterou a quantidade do Serviço "& CStr(scan% + 1) & " para zero !")
								If answer% = 6  Then  flag = doc.Remove( True )
							End If
						Else
							doc.Qs = Val( uidoc.FieldGetText("Qs_" & CStr(scan%) ) )
							doc.PartN = uidoc.FieldGetText("PartNos_" & CStr(scan%) )
							doc.Produtos = uidoc.FieldGetText("Produtos_" & CStr(scan%) )
							doc.Us = uidoc.FieldGetText("Uss_" & CStr(scan%) )
							doc.Custos= custo
							doc.Terceiros = terceiros
							doc.Mgs= mg
							doc.CustoUnits= valor
							doc.Despesas = despesa
							doc.CPS = cps
							doc.CusTots = total
							doc.RIR = ir
							doc.RIN = inss
							doc.ISS = iss
							Call doc.Save(True, True)
						End If
					End If
				End If		
			Else
				If Val(uidoc.FieldGetText("Qs_" & scan)) > 0 Then
					Set doc = New NotesDocument(listas)
					doc.Form = "Servico"
					doc.Autor = session.CommonUserName
					doc.Criacao = Now
					doc.Id = geraJavaId(doc)
					Set ligacao = doc.CreateRichTextItem("LinkNegocio")
					Call ligacao.AppendDocLink( uidoc.Document, "Link para o Negócio "+ codigo$ )
					doc.Codigo = codigo$
					doc.NServico = CStr(scan% + 1)
					doc.Qs = CInt( uidoc.FieldGetText("Qs_" & CStr(scan%) ) )
					doc.PartN = uidoc.FieldGetText("PartNos_" & CStr(scan%) )
					doc.Produtos = uidoc.FieldGetText("Produtos_" & CStr(scan%) )
					doc.Us = uidoc.FieldGetText("Uss_" & CStr(scan%) )
					doc.Custos = custo
					doc.Terceiros = terceiros
					doc.Mgs = mg
					doc.CustoUnits = valor
					doc.Despesas = despesa
					doc.CPS = cps
					doc.CusTots = total
					doc.RIR = ir
					doc.RIN = inss
					doc.ISS = iss
					doc.VlFat = 0
					Call doc.Save(True, True)                                                      
				End If
			End If
		Next
		Call LoadListaServicos(uidoc.Document)
	End If
	
End Sub

'++LotusScript Development Environment:2:1:CalcIRRF:1:8
Function CalcIRRF(doc As NotesDocument) As Double
	'As consistências de todos os serviços possuem a mesma alíquota de retenção já foi realizada na geração da Nota Fiscal
	
	If doc.Tipo(0) = "Serviços" Then
		If (doc.TotalServicos(0) * doc.AliqIRRF(0)) > 10 Or doc.CkIRRF(0) = "IRRF" Then
			CalcIRRF# = doc.TotalServicos(0) * aliquota(4)
		Else
			CalcIRRF# = 0
		End If
	Else
		CalcIRRF# = 0
	End If
	
End Function

'++LotusScript Development Environment:2:2:LinkFaturasPopup:5:8
%REM
	Sub LinkFaturasPopup
	Description: Comments for Sub
%END REM
Sub LinkFaturasPopup(negocio As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim dbFat As New NotesDatabase(negocio.ParentDatabase.Server,"faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim dc As NotesDocumentCollection
	'Dim total As Double
	If negocio.HasItem("DocLinks") Then negocio.RemoveItem("DocLinks")
	Set view = dbFat.GetView("(EspelhosNegocio)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set doc = dc.Getfirstdocument()
	%REM
	Do Until doc Is Nothing
		If doc.Sit(0) <> "Espelho" Then
			total = total + doc.TotTot(0)
		End If
		Set doc = dc.Getnextdocument(doc)
	Loop
	%END REM
	Dim rtitem As NotesRichTextItem
	Set rtitem = negocio.CreateRichTextItem("DocLinks")
	'Define o Estilo
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 8
	richStyle.NotesColor = COLOR_BLACK
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AppendText("Faturas")
	%REM
	If total > 0 Then
		Call rtitem.AppendText(" R$ " & Format(total, "Standard"))
	End If
	%END REM
	Call rtitem.AddNewLine(1)
	richStyle.NotesColor = COLOR_BLUE   
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	'*** Faturas ***
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	If doc Is Nothing Then Exit Sub
	While doc.Codigo(0) =  negocio.Codigo(0)
		If doc.Sit(0) <> "Espelho" Then
			If doc.Form(0) = "Recibo" Then
				If InStr(doc.Natureza(0), "Débito") > 0 Then
					Call rtitem.AppendDocLink(doc, "Link para " & doc.Natureza(0))
					Call rtitem.AppendText(doc.Natureza(0) & " ")
				Else
					Call rtitem.AppendDocLink(doc, "Link para o Recibo")
					Call rtitem.AppendText("Recibo ")
				End If
			ElseIf doc.Form(0) = "ReciboLocacao" Then
				Call rtitem.AppendDocLink(doc, "Link para o Recibo de Locação")
				Call rtitem.AppendText("Recibo de Locação ")
			ElseIf doc.Form(0) = "Glosa" Then
				Call rtitem.AppendDocLink(doc, "Link para a Glosa")
				Call rtitem.AppendText("Glosa ")
			Else
				Call rtitem.AppendDocLink(doc, "Link para a Fatura")
				Call rtitem.AppendText("Fatura ")
			End If
			Call rtitem.AppendText(CStr(doc.NFiscal(0)) & " ")
			Call rtitem.AppendText(Format(doc.DataFaturamento(0), "dd/mm/yyyy") & " ")
			If doc.Form(0) = "Glosa" Then
				Call rtitem.AppendText("R$ " & Format(doc.TotalNota(0), "Standard"))
			Else
				Call rtitem.AppendText("R$ " & Format(doc.TotTot(0), "Standard"))
			End If
			Call rtitem.AppendText(" " & doc.Sit(0))
			If doc.Form(0) = "ReciboLocacao" Then
				Call rtitem.AppendText(" Recibo de Locação")
			Else
				Call rtitem.AppendText(" " & doc.Natureza(0))
			End If
			Call rtitem.AppendText(" - " & doc.Descricao(0))
			Call rtitem.AddNewLine(1)
		End If
		Set doc = view.GetNextDocument(doc)
	Wend
	
	'*** Receber ***
	%REM Fica Lento no Contrato com muitas parcelas - 26/12/24 LMO
	Dim dcReceber As NotesDocumentCollection
	Dim receber As NotesDocument
	'Define o Estilo
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 8
	richStyle.NotesColor = COLOR_BLACK
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine(1)
	Call rtitem.AppendText("Receber")
	Call rtitem.AddNewLine(1)
	richStyle.NotesColor = COLOR_BLUE
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	While doc.Codigo(0) =  negocio.Codigo(0)
		If doc.Sit(0) <> "Espelho" Then
			Set dcReceber = doc.Responses
			Set receber = dcReceber.Getfirstdocument()
			Do Until receber Is Nothing
				If receber.Form(0) = "Receber" Then
					Call rtitem.AppendDocLink(receber, "Link para o Receber")
					Call rtitem.AppendText("Receber ")
					Call rtitem.AppendText(receber.NTituloReceber(0) & " ")
					Call rtitem.AppendText(receber.Prorrogacao(0) & " - ")
					Call rtitem.AppendText(receber.Sit(0) & " ")
					Call rtitem.AppendText("R$ " & Format(receber.TotTot(0), "Standard"))
					Call rtitem.AddNewLine(1)
				End If
				Set receber = dcReceber.Getnextdocument(receber)
			Loop
		End If
		Set doc = view.GetNextDocument(doc)
	Wend
	%END REM
	
	'*** Espelhos ***
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 8
	richStyle.NotesColor = COLOR_BLACK
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine(1)
	Call rtitem.AppendText("Espelhos")
	Call rtitem.AddNewLine(1)
	richStyle.NotesColor = COLOR_BLUE
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	While doc.Codigo(0) =  negocio.Codigo(0)
		If doc.Sit(0) = "Espelho" Then
			If doc.Form(0) = "Recibo" Then
				Call rtitem.AppendDocLink(doc, "Link para o Recibo")
				Call rtitem.AppendText("Recibo ")
			ElseIf doc.Form(0) = "ReciboLocacao" Then
				Call rtitem.AppendDocLink(doc, "Link para o Recibo de Locação")
				Call rtitem.AppendText("Recibo de Locação ")
			ElseIf doc.Form(0) = "Glosa" Then
				Call rtitem.AppendDocLink(doc, "Link para a Glosa")
				Call rtitem.AppendText("Glosa ")
			Else
				Call rtitem.AppendDocLink(doc, "Link para o Espelho")
				Call rtitem.AppendText("Espelho ")
			End If
			Call rtitem.AppendText(CStr(doc.NFiscal(0)) & " ")
			Call rtitem.AppendText(Format(doc.DataFaturamento(0), "dd/mm/yyyy") & " ")
			If doc.Form(0) = "Glosa" Then
				Call rtitem.AppendText("R$ " & Format(doc.TotalNota(0), "Standard"))
			Else
				Call rtitem.AppendText("R$ " & Format(doc.TotTot(0), "Standard"))
			End If
			Call rtitem.AppendText(" " & doc.Sit(0))
			If doc.Form(0) = "ReciboLocacao" Then
				Call rtitem.AppendText(" Recibo de Locação")
			Else
				Call rtitem.AppendText(" " & doc.Natureza(0))
			End If
			Call rtitem.AppendText(" - " & doc.Descricao(0))
			Call rtitem.AddNewLine(1)
		End If
		Set doc = view.GetNextDocument(doc)
	Wend
		
End Sub

'++LotusScript Development Environment:2:1:GetClassificacao:5:8
%REM
	Function GetClassificacao
	Description: Comments for Function
%END REM
Function GetClassificacao(classificacao As String) As Variant
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim array(1) As String
	Set view = db.Getview("ClassificacaoDespesas")
	Set doc = view.Getdocumentbykey(classificacao, True)
	If Not doc Is Nothing Then
		If doc.Hasitem("ClassificacaoDespesaOperacional") Then
			If doc.ClassificacaoDespesaOperacional(0) <> "" Then
				array(0) = doc.ClassificacaoDespesaOperacional(0)
			End If
		End If
		If array(0) = "" Then array(0) = "Insumos" Else array(0) = doc.ClassificacaoDespesaOperacional(0)
		array(1) = "Despesa Operacional"
	End If
	GetClassificacao = array
	
End Function

'++LotusScript Development Environment:2:1:BuscaCodigoFiscal:1:8
Function BuscaCodigoFiscal (tipo As String) As Variant
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.CurrentDatabase.Server, "EstoqueMain.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim codigo(1) As String
	
	Set view = db.GetView ("(Operacao)")
	Set doc = view.GetDocumentByKey(tipo, True)
	If doc Is Nothing Then
		MsgBox "A configuração para esta operação não foi encontrada. Entre em contato com o Desenvolvimento", 16, "Erro"
		End 	
	End If
	
	codigo(0) = doc.CFOP(0)
	codigo(1) = doc.CFOP_1(0)
	
	BuscaCodigoFiscal = codigo
	
End Function

'++LotusScript Development Environment:2:1:CkServicosInternos:5:8
%REM
	Function CkServicosInternos
	Description: Comments for Function
%END REM
Function CkServicosInternos(negocio As NotesDocument, tipo As String) As Boolean
	
	CkServicosInternos = True
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim key(1) As String
	Dim totServicos As Double
	key(0) = "Serviços Internos"
	key(1) = negocio.Codigo(0)
	Set view = db.GetView("(Adendos)")
	Set dc = view.GetAllDocumentsByKey(key, True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.Sit(0) <> "Consolidado" And doc.Sit(0) <> "Perdido" And doc.Sit(0) <> "" And doc.Sit(0) <> "Postergado" Then
			If tipo = "Fechamento" Then
				'Pré-Venda
				If InStr(doc.Sit(0), "Pré-Venda") > 0 Then
					MsgBox "As Pré-Vendas dos Serviços Internos devem estar todas concluídas. Negócio: " & doc.Codigo(0), 16, "Erro ao Fechar Venda"	
					CkServicosInternos = False
				End If
				'POC
				If InStr(doc.Sit(0), "POC") > 0 Then
					MsgBox "Os POCs dos Serviços Internos devem estar todos concluídos. Negócio: " & doc.Codigo(0), 16, "Erro ao Fechar Venda"	
					CkServicosInternos = False
				End If
				'Verifica o Valor de Venda
				If CStr(doc.TotServicos_1(0)) = "" Then totServicos = 0 Else totServicos = doc.TotServicos_1(0)
				If totServicos = 0 Then
					MsgBox "Os Valores de Venda dos Serviços Internos devem ser informados. Negócio: " & doc.Codigo(0), 16, "Erro ao Fechar Venda"
					CkServicosInternos = False
				End If
			ElseIf tipo = "Desfechamento" Then
				If Not CheckDesfechamento(doc) Then
					CkServicosInternos = False
				End If
			End If
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	
End Function

'++LotusScript Development Environment:2:2:SaveListaServicos:1:8
Sub SaveListaServicos(doc As NotesDocument)
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(doc.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim item As NotesDocument, itemAnterior As NotesDocument
	Dim array As Variant, scan As Integer, status As String
	Set view = db.Getview("(NegocioNServicos)")
	If Fechado(doc.Sit(0)) Then status = "Ativo" Else status = "Inativo"
	For scan = 0 To 11
		Set itemAnterior = view.Getdocumentbykey(doc.Codigo(0) & "-" & (scan+1), True)
		array = doc.Getitemvalue("Qs_" & scan)
		If Val(array(0)) > 0 And doc.TipoVenda(0) <> "Venda Simples" Then
			If Not itemAnterior Is Nothing Then
				Set item = itemAnterior
			Else
				Set item = New NotesDocument(db)
				item.Form = "Servico"
				item.Id = geraJavaId(item)
				item.IdOrigem = doc.Id(0)
				item.Codigo = doc.Codigo(0)
				item.NServico = CStr(scan+1)
				item.Autor = session.CommonUserName
				item.Criacao = Now
				'Campos de Controle
				item.VlFat = 0
				item.VlRecibo = 0
			End If
			item.Status = status
			item.Area = doc.Area(0) 
			array = doc.Getitemvalue("Qs_" & scan)
			item.Qs = Val(array(0))
			array = doc.Getitemvalue("PartNos_" & scan)
			item.PartN = array(0)
			array = doc.Getitemvalue("Produtos_" & scan)
			item.Produtos = array(0)
			array = doc.Getitemvalue("Uss_" & scan)
			item.Us = array(0)
			array = doc.Getitemvalue("Custos_" & scan)
			If IsNumeric(array(0)) Then item.Custos = array(0) Else item.Custos = 0
			array = doc.Getitemvalue("Terceiros_" & scan)
			If IsNumeric(array(0)) Then item.Terceiros = array(0) Else item.Terceiros = 0
			If doc.Form(0) = "Negocio" Then
				array = doc.Getitemvalue("Mgs_" & scan)
				If IsNumeric(array(0)) Then item.Mgs = array(0) Else item.Mgs = 0
				array = doc.Getitemvalue("CustoUnits_" & scan)
				If IsNumeric(array(0)) Then item.CustoUnits = array(0) Else item.CustoUnits = 0
				array = doc.Getitemvalue("CusTots_" & scan)
				If IsNumeric(array(0)) Then item.CusTots = Round(array(0), 2) Else item.CusTots = 0
				array = doc.Getitemvalue("RIR_" & scan)
				If IsNumeric(array(0)) Then item.RIR = array(0) Else item.RIR = 0
				array = doc.Getitemvalue("RIN_" & scan)
				If IsNumeric(array(0)) Then item.RIN = Round(array(0), 2) Else item.RIN = 0
				array = doc.Getitemvalue("ISS_" & scan)
				If IsNumeric(array(0)) Then item.ISS = Round(array(0), 2) Else item.ISS = 0
			End If
			array = doc.Getitemvalue("Despesas_" & scan)
			If IsNumeric(array(0)) Then item.Despesas = array(0) Else item.Despesas = 0
			array = doc.Getitemvalue("CPS_" & scan)
			If IsNumeric(array(0)) Then item.CPS = array(0) Else item.CPS = 0
			'Link para a Origem
			If item.Hasitem("LinkNegocio") Then item.Removeitem("LinkNegocio")
			Dim ligacao As NotesRichTextItem
			Set ligacao = item.CreateRichTextItem("LinkNegocio")
			Call ligacao.AppendDocLink(doc, "Link para o " & doc.Form(0) & " " & doc.Codigo(0))
			Call item.ComputeWithForm(False, False)
			Call item.Save(True, True )
		Else
			If Not itemAnterior Is Nothing Then
				Call itemAnterior.Remove(True)	
			End If
		End If
	Next
	
End Sub

'++LotusScript Development Environment:2:2:SolicitaPOC:5:8
%REM
	Sub SolicitaPOC
	Description: Comments for Sub
%END REM
Sub SolicitaPOC(negocio As NotesDocument)
	
	On Error Resume Next
	If negocio.TecnicoPOC(0) = "" Then
		negocio.TecnicoPOC = GetResponsavelPlanejamento(negocio.Area(0), "Poc")
	End If
	Dim data As String
	data = GetPrazoPlanejamento(prazoPlanejamento)
	Dim session As New NotesSession
	Dim scan As Integer, x As Integer
	'Forecast
	Dim proxDatas As Variant, proxData(0) As Variant
	Dim datasForecast As Variant, dataForecast(0) As Variant
	Dim temperaturas As Variant, temperatura(0) As Variant
	Dim tiposFollowUp As Variant, tipoFollowUp(0) As Variant
	Dim followUps As Variant, followUp(0) As Variant
	proxData(0) = CDat(data)
	dataForecast(0) = negocio.DataForecastSub(0)
	temperatura(0) = negocio.TemperaturaSub(0)
	tipoFollowUp(0) = "POC"
	followUp(0) = "-> " & Format(Now, "dd/mm/yyyy") & " " & session.Commonusername & " - " & Implode(negocio.ObsSub, " ")
	If negocio.ProxData(0) <> "" Then
		'Temperatura passou a ser MultiValue - LMO 24/07/18
		x = UBound(negocio.DataForecast)
		If UBound(negocio.Temperatura) < x Then
			ReDim temp(x) As Variant
			For scan = 0 To x
				If scan > UBound(negocio.Temperatura) Then
					temp(scan) = negocio.TemperaturaSub(0)
				Else
					If negocio.Temperatura(scan) = "" Then
						temp(scan) = negocio.TemperaturaSub(0)
					Else
						temp(scan) = negocio.Temperatura(scan)
					End If
				End If
			Next
			negocio.Temperatura = temp
		End If
		'*** Tipo de Follow Up - LMO 23/08/18 ***
		x = UBound(negocio.DataForecast)
		If UBound(negocio.TipoFollowup) < x Then
			ReDim tipoFUp(x) As String
			For scan = 0 To x
				If scan > UBound(negocio.TipoFollowup) Then
					tipoFUp(scan) = "Telefone"
				Else
					If negocio.TipoFollowup(scan) = "" Then
						tipoFUp(scan) = "Telefone"
					Else
						tipoFUp(scan) = negocio.TipoFollowup(scan)
					End If
				End If
			Next
			negocio.TipoFollowup = tipoFUp
		End If
		'***
		proxDatas = ArrayAppend( proxData, negocio.ProxData )			
		datasForecast = ArrayAppend( dataForecast, negocio.DataForecast )
		temperaturas = ArrayAppend( temperatura, negocio.Temperatura )
		tiposFollowUp = ArrayAppend( tipoFollowUp, negocio.TipoFollowup )
		followUps = ArrayAppend( followUp, negocio.FollowUp )
	Else 
		proxDatas = proxData			
		datasForecast = dataForecast
		temperaturas = temperatura
		tiposFollowUp = tipoFollowUp
		followUps = followUp
	End If
	negocio.ProxData = proxDatas
	negocio.DataForecast = datasForecast
	negocio.Temperatura = temperaturas
	negocio.TipoFollowup = tiposFollowUp
	negocio.FollowUp = followUps
	'Solicitação do POC
	'Ordena do atual para o antigo - LMO 27/07/18
	Dim valoresEstimados As Variant, valorEstimado(0) As Variant
	Dim probsFechamento As Variant, probFechamento(0) As Variant
	Dim datasLimite As Variant, dataLimite(0) As Variant
	Dim respsSolicitacao As Variant, respSolicitacao(0) As Variant
	Dim solicitacoes As Variant, solicitacao(0) As Variant
	Dim observacoes As Variant, obs(0) As Variant
	valorEstimado(0) = CDbl(negocio.ValorEstimadoSub(0))
	If negocio.TemperaturaSub(0) = "Frio" Then
		probFechamento(0) = 0.6
	ElseIf negocio.TemperaturaSub(0) = "Morno" Then
		probFechamento(0) = 0.7
	ElseIf negocio.TemperaturaSub(0) = "Quente" Then
		probFechamento(0) = 0.8
	End If
	dataLimite(0) = CDat(data)
	respSolicitacao(0) = session.CommonUserName
	solicitacao(0) = Now
	obs(0) = "-> " & Format(Now, "dd/mm/yyyy") & " " & session.Commonusername & " - " & Implode(negocio.ObsSub, " ")
	If CStr(negocio.ValorEstimadoPOC(0)) = "" Then
		valoresEstimados = valorEstimado
		probsFechamento = probFechamento
		datasLimite = dataLimite
		respsSolicitacao = respSolicitacao
		solicitacoes = solicitacao
		observacoes = obs
	Else
		valoresEstimados = ArrayAppend( valorEstimado, negocio.ValorEstimadoPOC )
		probsFechamento = ArrayAppend( probFechamento, negocio.ProbFechamentoPOC )
		datasLimite = ArrayAppend( dataLimite, negocio.DataLimitePOC )
		respsSolicitacao = ArrayAppend( respSolicitacao, negocio.RespSolicitacaoPOC )
		solicitacoes = ArrayAppend( solicitacao, negocio.SolicitacaoPOC )
		observacoes = ArrayAppend( obs, negocio.ObsPOC )
		'Data Retorno POC
		negocio.DataRetornoPOC = Today
	End If
	negocio.ValorEstimadoPOC = valoresEstimados
	negocio.ProbFechamentoPOC = probsFechamento
	negocio.DataLimitePOC = datasLimite
	negocio.RespSolicitacaoPOC = respsSolicitacao
	negocio.SolicitacaoPOC = solicitacoes
	negocio.ObsPOC = observacoes
	'Controle de POC
	negocio.Sit = "POC"
	negocio.SitNumero = 9
	negocio.CkPOC = "1"
	negocio.CkConclusaoPOC = ""
	Call negocio.Save(True, True)
	'Atualiza Projeto/Contrato
	Call ProjetoContrato(negocio, "POC")
	
End Sub

'++LotusScript Development Environment:2:2:DescontoFlatListaMateriais:7:8
%REM
	Sub DescontoFlatListaMat (MCastro em 28/01/2015)
	Description: 	Aplica um desconto flat no preço de venda da lista de materiais
					depois recalcular a lista através do "calc"
					Operação pode ser aplicar ou desaplicar o desconto
%END REM
Sub DescontoFlatListaMateriais(uidoc As NotesUIDocument, desconto As Double, operacao As string)
	'Popula Lista de Materiais
	Call uidoc.Refresh
	'Calcula as Margens dos Itens do Negócio
	Dim qvar As Long, custoFOB As Double, fi As Double, custo As Double, icmsst As Double, mg As Double, venda As Double, total  As Double
	Dim scan As Integer, us As String
	For scan = 0 To 49
		qvar = Val(uidoc.FieldGetText("Q_" & scan))
		If qvar > 0 Then			
			'Calcula Custo/Margem/Custo Unitário
			ReDim Preserve custoUnit(scan) As Double
			ReDim preserve novoCustoUnit(scan) As Double
			If uidoc.FieldGetText("CustoUnit_" & scan) = "" Then venda = 0 Else venda = CDbl(uidoc.FieldGetText("CustoUnit_" & scan))
			custounit(scan) = venda
			If venda > 0 then 
				If operacao = "aplicar" then
					venda = venda * (1-desconto)
					novoCustoUnit(scan) = venda * (1-desconto)
				Else					
					venda = venda / (1-desconto)
					novoCustoUnit(scan) = venda / (1-desconto)
				End if
			End if
			Call uidoc.FieldSetText("Mg_" & scan, "")
			Call uidoc.FieldSetText("CustoUnit_" & scan, CStr(venda))
		End If
	Next
	'Calcula o Total do Negócio
	Call MargensListaUI(uidoc)
	Call uidoc.Refresh
	Call MgPrevista(uidoc.Document)
	
End Sub

'++LotusScript Development Environment:2:2:PopulaMargem:5:8
%REM
	Sub PopulaMargem
	Description: Apesar do nome, esta função trata das comissoes conforme as margens do negocio
%END REM
Sub PopulaMargem(doc As NotesDocument)
	
	On Error Resume Next
	'If doc.Sit(0) = "Concluído" Or doc.Sit(0) = "Perdido" Or doc.Sit(0) = "Postergado" Then Exit Sub
	If doc.Sit(0) = "Perdido" Or doc.Sit(0) = "Postergado" Then Exit Sub
	Dim db As New NotesDatabase(doc.Parentdatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim config As NotesDocument
	Dim scan As Integer
	'Comissão por Gerente
	If doc.GerenteConta(0) <> "" Then
		Set view = db.GetView("(Configuracao/Comissao/Gerente)")
		Set config = view.Getdocumentbykey(doc.GerenteConta(0), True)
		If Not config Is Nothing Then
			doc.TipoRelacao = config.TipoRelacao(0)
			doc.Comissao = config.Comissao(0)
			doc.Adiantamento = config.Adiantamento(0)
		Else
			doc.TipoRelacao = ""
			doc.Comissao = ""
			doc.Adiantamento = ""
			MsgBox "Configuração de Comissão do Gerente de Contas " & doc.GerenteConta(0) & " não existe. Solicite a sua criação ao Desenvolvimento.", 16, "Erro no Negócio " & doc.Codigo(0)
		End If
	End If
	'Participação da Área de Serviços - LMO 29/01/2019
	Dim data As String, area As String
	If doc.TipoVenda(0) = "Contrato" Then
		'Área da Matriz de Tarifação
		If doc.TipoVenda(0) = "Contrato" Then
			For scan = 0 To 9
				If Val(doc.Getitemvalue("CQs_" & scan)(0)) > 0 And doc.Getitemvalue("CTipo_" & scan)(0) = "Serviços" And doc.Getitemvalue("CParticipacao_" & scan)(0) <> "N" Then
					area = doc.Getitemvalue("CArea_" & scan)(0)
				End If
			Next
		End If
	Else
		area = doc.Area(0)
	End If
	data = doc.DataConclusao(0)
	If data = "" Then data = doc.DataFechamento(0)
	If data = "" Then data = doc.Criacao(0)
	Set view = db.GetView("(Configuracao/Participacoes)")
	Set dc = view.Getalldocumentsbykey(area, True)
	Set config = dc.Getfirstdocument()
	Do Until config Is Nothing
		'If config.Status(0) = "Ativa" And CDat(data)>= CDat(config.DataInicial(0)) And CDat(data)<= CDat(config.DataFinal(0)) Then
		If config.Status(0) = "Ativa" Then
			If config.Fase(0) = "Pré-Venda" Then
				doc.PremioPV = config.Premio(0) * GetFator(area, config.Fase(0))
				doc.DistribuicaoPremioPV = config.DistribuicaoPremio(0)
				doc.DiaPagtoPV = config.DiaPagto(0)
				doc.MesPagtoPV = config.MesPagto
			ElseIf config.Fase(0) = "Execução" Then
				doc.PremioExec = config.Premio(0) * GetFator(area, config.Fase(0))
				doc.DistribuicaoPremioExec = config.DistribuicaoPremio(0)
				doc.DiaPagtoExec = config.DiaPagto(0)
				doc.MesPagtoExec = config.MesPagto
			ElseIf config.Fase(0) = "PMO" Then
				doc.PremioPMO = config.Premio(0) * GetFator(area, config.Fase(0))
				doc.DistribuicaoPremioPMO = config.DistribuicaoPremio(0)
				doc.DiaPagtoPMO = config.DiaPagto(0)
				doc.MesPagtoPMO = config.MesPagto
			End If
		End If
		Set config = dc.Getnextdocument(config)
	Loop
	If CStr(doc.PremioPV(0)) = "" Then doc.PremioPV = 0
	If CStr(doc.PremioExec(0)) = "" Then doc.PremioExec = 0
	If CStr(doc.PremioPMO(0)) = "" Then doc.PremioPMO = 0
	'Resultado Mínimo do Negócio, Encargos Sociais sobre a Comissão, Fator de Importação Mínimo Geral e Prazos de Pagamento
	Set view = db.GetView("(ConfiguracaoMargem)")
	Set config = view.Getfirstdocument()
	'Fator de Importação por Parceria - LMO 06/09/23
	Dim fi_HW As Double, fi_SW As Double, fi_SV As Double
	Dim viewP As NotesView
	Dim configP As NotesDocument
	Set viewP = db.GetView("(Parceria)")
	If doc.Parceria(0) <> "" Then
		Set configP = viewP.Getdocumentbykey(doc.Parceria(0), True)
		If Not configP Is Nothing Then
			If configP.Hasitem("FI_HW") Then
				If Val(configP.FI_HW(0)) > 0 Then fi_HW = configP.FI_HW(0)
				If Val(configP.FI_SW(0)) > 0 Then fi_SW = configP.FI_SW(0)
				If Val(configP.FI_SV(0)) > 0 Then fi_SV = configP.FI_SV(0)
			End If
		End If
	End If
	'
	If Not config Is Nothing Then
		doc.Resultado = config.Resultado(0)
		doc.MgRevendaM = config.Resultado(0)
		doc.MgServicosM = config.ResultadoServicos(0)
		If doc.TipoRelacao(0) = "Terceiro" Then
			doc.DSR = 0
			doc.INSS = 0
			doc.FGTS = 0
			doc.DecimoTerceiro = 0
			doc.Ferias = 0
			doc.EncargosSociais = 0
		Else
			'Percentual
			doc.DSR = config.DSR(0)
			doc.INSS = config.INSS(0)
			doc.FGTS = config.FGTS(0)
			doc.DecimoTerceiro = config.DecimoTerceiro(0)
			doc.Ferias = config.Ferias(0)
			doc.EncargosSociais = doc.DSR(0) + doc.INSS(0) + doc.FGTS(0) + doc.DecimoTerceiro(0) + doc.Ferias(0)
			'Vencimento
			doc.VencDSR = config.VencDSR(0)
			doc.VencINSS = config.VencINSS(0)
			doc.VencFGTS = config.VencFGTS(0)
			doc.VencDecimoTerceiro = config.VencDecimoTerceiro(0)
			doc.VencFerias = config.VencFerias(0)
			'Antecipação
			doc.AdDSR = config.AdDSR(0)
			doc.AdINSS = config.AdINSS(0)
			doc.AdFGTS = config.AdFGTS(0)
			doc.AdDecimoTerceiro = config.AdDecimoTerceiro(0)
			doc.AdFerias = config.AdFerias(0)
		End If
		'Fator de Importação Geral (Caso o Fator de Importação por Parceria for Zero) - LMO 06/09/23
		If fi_HW = 0 Then fi_HW = config.FI_HW(0)
		If fi_SW = 0 Then fi_SW = config.FI_SW(0)
		If fi_SV = 0 Then fi_SV = config.FI_SV(0)
		doc.FI_HW = fi_HW
		doc.FI_SW = fi_SW
		doc.FI_SV = fi_SV
		doc.PrazoPagtoImportacao = config.PrazoPagtoImportacao(0)
		doc.PrazoPagtoCMV = config.PrazoPagtoCMV(0)
		doc.PrazoPagtoFrete = config.PrazoPagtoFrete(0)
		doc.PrazoPagtoPlanilhaFinanceira = config.PrazoPagtoPlanilhaFinanceira(0)
		doc.PrazoPagtoCPS = config.PrazoPagtoCPS(0)
		doc.PrazoPagtoTerceiros = config.PrazoPagtoTerceiros(0)
	Else
		doc.Resultado = 0.15
		doc.DSR = 0
		doc.INSS = 0
		doc.FGTS = 0
		doc.DecimoTerceiro = 0
		doc.Ferias = 0
		doc.EncargosSociais = 0
		doc.FI_HW = 1.95
		doc.FI_SW = 1.32
		doc.FI_SV = 1.46
		doc.PrazoPagtoImportacao = 60
		doc.PrazoPagtoCMV = 30
		doc.PrazoPagtoFrete = 15
		doc.PrazoPagtoPlanilhaFinanceira = 7
		doc.PrazoPagtoCPS = 28
		doc.PrazoPagtoTerceiros = 15
	End If
	
End Sub



'++LotusScript Development Environment:2:2:MgPrevista:5:8
%REM
	Sub MgPrevista
	Description: Comments for Sub
%ENDREM
Sub MgPrevista(doc As NotesDocument)
	
	On Error Resume Next
	Dim scan As Integer
	Dim qtd As Variant, tipo As Variant, us As Variant, cusFob As Variant, cus As Variant, terc As Variant, cusUnit As Variant, st As Variant, ufCompra As Variant, icc As Variant, icstc As Variant, ic As Variant, icst As Variant, ipc As Variant, ip As Variant, ii As Variant, fcp As Variant, cusTot As Variant, aliquotaPIS As Variant, aliquotaCOFINS As Variant
	Dim compra As Double, venda As Double, custo As Double, custoImp As Double, custoSV As Double,terceirosT As Double, icmsD As Double, icmsC As Double, fcpAliq As Double, fcpTot As Double, ipi As Double, ipiC As Double, ipiD As Double, iss As Double, inss As Double, pis As Double, cofins As Double, csll As Double, irpj As Double, cpr As Double, comissao As Double, frete As Double, intermediacao As Double, terceiros As Double, icmsstC As Double, icmsst As Double, impostoC As Double, imposto As Double, fob As Double, aliqISS As Double
	Dim compraFob As Double, fatorCompra As Double, fatorVenda As Double, bcIR As Double, ir As Double, bcPISCOFINS As Double
	Dim issM As Double, issS As Double, inssM As Double, inssS As Double, pisM As Double, pisS As Double, cofinsM As Double, cofinsS As Double, cprM As Double, cprS As Double
	'Alíquotas dos Impostos
	Call BuscaRegrasFiscais(doc)
	'Planilha Financeira
	pf = GetValoresPlanilha(doc.Codigo(0), "Previsto")
	'Visitas
	visitas = GetVisitas(doc.Codigo(0))
	'Calcula Capital de Giro Previsto
	Call CalcCapitalGiroPrevisto(doc)
	'Lista de Materiais
	For scan = 0 To 49
		qtd = doc.Getitemvalue("Q_" & scan)
		If Val(qtd(0)) > 0 Then
			us = doc.Getitemvalue("us_" & scan)
			cusFob = doc.Getitemvalue("CustoFOB_" & scan)
			cus = doc.Getitemvalue("Custo_" & scan)
			cusUnit = doc.Getitemvalue("CustoUnit_" & scan)
			tipo = doc.Getitemvalue("t_" & scan)
			st = doc.Getitemvalue("ST_" & scan)
			ufCompra = doc.Getitemvalue("UFCompra_" & scan)
			icc = doc.Getitemvalue("ICC_" & scan)
			icstc = doc.Getitemvalue("ICMSSTC_" & scan)
			ic = doc.Getitemvalue("IC_" & scan)
			icst = doc.Getitemvalue("ICMSST_" & scan)
			ipc = doc.Getitemvalue("IPC_" & scan)
			ip = doc.Getitemvalue("IP_" & scan)
			ii = doc.Getitemvalue("II_" & scan)
			fcp = doc.Getitemvalue("FCP_" & scan)
			aliquotaPIS = doc.Getitemvalue("AliquotaPIS_" & scan)
			aliquotaCOFINS = doc.Getitemvalue("AliquotaCOFINS_" & scan)
			'Cotação da Moeda
			If us(0) = "US$C" Then
				'fatorCompra = doc.USC(0)
				'US$C Venda Fixo - LMO 08/01/18
				If IsNumeric(doc.USCompra(0)) Then
					fatorCompra = doc.USCompra(0)
				Else
					fatorCompra = doc.USC(0)
				End If
				'US$C Venda Fixo - LMO 08/01/18
				If IsNumeric(doc.USVenda(0)) Then
					fatorVenda = doc.USVenda(0)
				Else
					fatorVenda = doc.USC(0)
				End If
			Else
				fatorCompra = 1
				fatorVenda = 1
			End If
			If CStr(icstc(0)) = "" Then icmsstC = 0 Else icmsstC = CDbl(icstc(0))
			If CStr(icst(0)) = "" Then icmsst = 0 Else icmsst = CDbl(icst(0))
			compra = cus(0) * qtd(0) * fatorCompra
			If ufCompra(0) <> "SP" And ufCompra(0) <> "EX" Then
				If Right(st(0), 2) = "00" Then
					impostoC = impostoC + icmsstC * qtd(0) * fatorCompra
				End If
			End If
			venda = cusUnit(0) * qtd(0) * fatorVenda
			'FCP
			If CStr(fcp(0)) <> "" And CStr(fcp(0)) <> "?" Then fcpAliq = fcp(0) Else fcpAliq = 0
			If doc.Destino(0) = "Revenda" Then
				'Venda para Revenda: Sem IPI na BC-ICMS
				fcpTot = fcpTot + venda/(1+ip(0)) * fcpAliq
			Else
				'Venda para Consumo: Com IPI na BC-ICMS
				fcpTot = fcpTot + venda * fcpAliq
			End If
			'*** Importação ***
			If CStr(cusFob(0)) = "" Then fob = 0 Else fob = cusFob(0)
			If fob > 0 Then
				custoImp = custoImp + compra
				compraFob = cusFob(0) * qtd(0) * fatorCompra
				If tipo(0) = "HW" Then
					Dim cif As Double, bcICMS As Double, bcIPI As Double, valPIS As Double, valCOFINS As Double, valII As Double, valIPI As Double, custTot As Double
					cif = Round(compraFob, 2)
					valPIS = cif*aliquota(0)
					valCOFINS = cif*aliquota(1)
					valII = cif*ii(0)
					bcIPI = cif+valII
					valIPI = bcIPI*ipc(0)
					bcICMS = (cif+valII+valIPI+valPIS+valCOFINS)/(1-icc(0))
					custTot = bcICMS - valIPI
					'Venda para Revenda (Sem IPI na BC-ICMS)
					If doc.Destino(0) = "Revenda" Then
						icmsD = icmsD + (venda/(1+ip(0)) * ic(0))
						pis = pis + ((venda/(1+ip(0)) - (venda/(1+ip(0)) * ic(0))) * aliquotaPIS(0)) - valPIS
						pisM = pisM + ((venda/(1+ip(0)) - (venda/(1+ip(0)) * ic(0))) * aliquotaPIS(0)) - valPIS
						cofins = cofins + ((venda/(1+ip(0)) - (venda/(1+ip(0)) * ic(0))) * aliquotaCOFINS(0)) - valCOFINS
						cofinsM = cofinsM + ((venda/(1+ip(0)) - (venda/(1+ip(0)) * ic(0))) * aliquotaCOFINS(0)) - valCOFINS
					'Venda para Consumidor Final (Com IPI na BC-ICMS)	
					Else
						icmsD = icmsD + (venda * ic(0))
						pis = pis + ((venda/(1+ip(0)) - (venda * ic(0))) * aliquotaPIS(0)) - valPIS
						pisM = pisM + ((venda/(1+ip(0)) - (venda * ic(0))) * aliquotaPIS(0)) - valPIS
						cofins = cofins + ((venda/(1+ip(0)) - (venda * ic(0))) * aliquotaCOFINS(0)) - valCOFINS
						cofinsM = cofinsM + ((venda/(1+ip(0)) - (venda * ic(0))) * aliquotaCOFINS(0)) - valCOFINS
					End If
					icmsC = icmsC - (bcICMS * icc(0))
					imposto = imposto + icmsst * fatorVenda
					ipiD = ipiD + venda/(1+ip(0)) * ip(0)
					ipiC = ipiC - valIPI
					ipi = ipi + (venda/(1+ip(0))*ip(0)) - valIPI
				'SW/SV Importados - LMO 20/06/16 (email GFogaca 14/06/16)
				Else
					bcIR = Round(compraFob / 0.85, 2)
					ir = Round(bcIR * aliquota(14), 2)
					'BC PIS/COFINS - LMO 31/01/23 (email gfogaca 24/01/23)
					bcPISCOFINS = Round((compraFob + ir) / 0.9075, 2)
					'bcPISCOFINS = Round(((compraFob + ir) * 0.05 + (compraFob + ir)) / 0.9075, 2)
					pis = pis + (venda * aliquotaPIS(0) - bcPISCOFINS * aliquota(0))
					pisM = pisM + (venda * aliquotaPIS(0) - bcPISCOFINS * aliquota(0))
					cofins = cofins + (venda * aliquotaCOFINS(0) - bcPISCOFINS * aliquota(1))
					cofinsM = cofinsM + (venda * aliquotaCOFINS(0) - bcPISCOFINS * aliquota(1))
					cpr = cpr + venda * aliquota(13)
					cprM = cprM + venda * aliquota(13)
				End If
			'*** Compra do Fornecedor ***
			Else
				Dim icms As Double, valorICMSC As Double, valorIcmsstC As Double
				If icc(0) = 0 And CStr(doc.Getitemvalue("ICMS_" & scan)(0)) <> "" Then icms = doc.Getitemvalue("ICMS_" & scan)(0) Else icms = icc(0)
				valorICMSC = compra / (1 + ipc(0)) * icms
				If ufCompra(0) = "SP" Or ufCompra(0) = "EX" Then
					valorIcmsstC = icmsstC * qtd(0) * fatorCompra
					custo = custo + compra + valorIcmsstC
					pis = pis + ((venda - (venda * ic(0))) * aliquotaPIS(0) - (compra + valorIcmsstC - valorICMSC) * aliquota(0))
					pisM = pisM + ((venda - (venda * ic(0))) * aliquotaPIS(0) - (compra + valorIcmsstC - valorICMSC) * aliquota(0))
					cofins = cofins + ((venda - (venda * ic(0))) * aliquotaCOFINS(0) - (compra + valorIcmsstC - valorICMSC) * aliquota(1))
					cofinsM = cofinsM + ((venda - (venda * ic(0))) * aliquotaCOFINS(0) - (compra + valorIcmsstC - valorICMSC) * aliquota(1))
				Else
					custo = custo + compra
					pis = pis + (venda - venda * ic(0)) * aliquotaPis(0) - (compra - valorICMSC) * aliquota(0)
					pisM = pisM + (venda - venda * ic(0)) * aliquotaPis(0) - (compra - valorICMSC) * aliquota(0)
					cofins = cofins + (venda - venda * ic(0)) * aliquotaCOFINS(0) - (compra - valorICMSC) * aliquota(1)
					cofinsM = cofinsM + (venda - venda * ic(0)) * aliquotaCOFINS(0) - (compra - valorICMSC) * aliquota(1)
				End If
				'HW
				If tipo(0) = "HW" Then
					icmsD = icmsD + venda * ic(0)
					If ufCompra(0) = "SP" Or (ufCompra(0) <> "SP" And doc.UF(0) <> "EX" And doc.Pais(0) = "Brasil") Then
						'Redução da BC do ICMS - LMO 09/11/15
						If st(0) = "420" Then
							icmsC = icmsC - compra * (1 - 0.3333) /(1+ipc(0)) * icc(0)
						Else
							icmsC = icmsC - compra/(1+ipc(0)) * icc(0)
						End If
					End If
					imposto = imposto + icmsst * fatorVenda
				'SW/SV	
				Else
					cpr = cpr + venda * aliquota(13)
					cprM = cprM + venda * aliquota(13)
				End If
			End If
			'ISS/INSS
			If tipo(0) = "SW" Then
				iss = iss + venda * aliquota(12)
				issM = issM + venda * aliquota(12)
			ElseIf tipo(0) = "SV" Then
				iss = iss + venda * aliquota(3)
				issM = issM + venda * aliquota(3)
				inss = inss + venda * aliquota(5)
				inssM = inssM + venda * aliquota(5)
			End If
		End If
	Next
	'Despesas de Vendas
	If CStr(doc.Frete(0)) <> "" Then frete = doc.Frete(0)
	If CStr(doc.Intermediacao(0)) <> "" Then intermediacao = doc.Intermediacao(0)
	pis = pis - (frete + intermediacao) * aliquota(0)
	pisM = pisM - (frete + intermediacao) * aliquota(0)
	cofins = cofins - (frete + intermediacao) * aliquota(1)
	cofinsM = cofinsM - (frete + intermediacao) * aliquota(1)
	'Lista de Serviços
	If doc.TipoVenda(0) = "Projeto" Or doc.TipoVenda(0) = "Chamado" Then
		For scan = 0 To 11
			qtd = doc.Getitemvalue("Qs_" & scan)
			If Val(qtd(0)) > 0 Then
				us = doc.Getitemvalue("uss_" & scan)
				cus = doc.Getitemvalue("Custos_" & scan)
				cusTot = doc.Getitemvalue("CusTots_" & scan)
				ic = doc.Getitemvalue("RIR_" & scan)'IR
				ip = doc.Getitemvalue("RIN_" & scan) 'INSS
				If CStr(doc.Getitemvalue("ISS_" & scan)(0)) = "" Then aliqISS = aliquota(3) Else aliqISS = doc.Getitemvalue("ISS_" & scan)(0)
				compra = qtd(0) * cus(0)
				venda = cusTot(0)
				custoSV = custoSV + compra
				iss = iss + venda * aliqISS
				issS = issS + venda * aliqISS
				inss = inss + venda * aliquota(5)
				inssS = inssS + venda * aliquota(5)
				pis = pis + (venda * doc.AliquotaPIS(0))
				pisS = pisS + (venda * doc.AliquotaPIS(0))
				cofins = cofins + (venda * doc.AliquotaCOFINS(0))
				cofinsS = cofinsS + (venda * doc.AliquotaCOFINS(0))
				cpr = cpr + venda * aliquota(13)
				cprS = cprS + venda * aliquota(13)
			End If
		Next
		pis = pis - (pf(2) + pf(5) + pf(12)) * aliquota(0)
		pisS = pisS - (pf(2) + pf(5) + pf(12)) * aliquota(0)
		cofins = cofins - (pf(2) + pf(5) + pf(12)) * aliquota(1)
		cofinsS = cofinsS - (pf(2) + pf(5) + pf(12)) * aliquota(1)
	End If
	'Matriz de Tarifação
	If doc.TipoVenda(0) = "Contrato" Then
		For scan = 0 To 9
			qtd = doc.Getitemvalue("CQs_" & scan)
			If Val(qtd(0)) > 0 Then
				cus = doc.Getitemvalue("CCusto_" & scan)
				terc = doc.GetItemValue("CTerceiros_" & scan)
				cusTot = doc.Getitemvalue("CCusTots_" & scan)
				ic = doc.Getitemvalue("RIR_" & scan)'IR
				ip = doc.Getitemvalue("RIN_" & scan) 'INSS
				If CStr(doc.Getitemvalue("CISS_" & scan)(0)) = "" Then aliqISS = aliquota(3) Else aliqISS = doc.Getitemvalue("CISS_" & scan)(0)
				If CStr(cus(0)) = "" Then compra = 0 Else compra = cus(0) * Val(qtd(0))
				If CStr(terc(0)) = "" Then terceiros = 0 Else terceiros = terc(0) * Val(qtd(0))
				custoSV = custoSV + compra
				terceirosT = terceirosT + terceiros
				venda = cusTot(0) * qtd(0)
				iss = iss + venda * aliqISS
				issS = issS + venda * aliqISS
				inss = inss + venda * aliquota(5)
				inssS = inssS + venda * aliquota(5)
				pis = pis + venda * doc.AliquotaPIS(0)
				pisS = pisS + venda * doc.AliquotaPIS(0)
				cofins = cofins + venda * doc.AliquotaCOFINS(0)
				cofinsS = cofinsS + venda * doc.AliquotaCOFINS(0)
				cpr = cpr + venda * aliquota(13)
				cprS = cprS + venda * aliquota(13)
				pis = pis - terceiros * aliquota(0)
				pisS = pisS - terceiros * aliquota(0)
				cofins = cofins - terceiros * aliquota(1)
				cofinsS = cofinsS - terceiros * aliquota(1)
			End If
		Next
	End If
	'Horas e Custo das Horas
	Call CustoHora(doc, "Prevista")
	'Print Margem Prevista
	doc.VendaM_P = doc.TotMateriais_1(0)
	doc.VendaS_P = doc.TotServicos_1(0)
	doc.Venda_P = doc.TotalNegocio(0)
	'Despesas e Horas Consolidadas - LMO 17/08/18
	Call GetConsolidacoes(doc)
	doc.Custo_P = custo
	doc.CustoImp_P = custoImp
	doc.Cambio_P = 0
	doc.CustosHoras_P = custoSV	'Custo informado na Lista de Serviços/Matriz de Tarifação
	doc.ICMSD_P = icmsD
	doc.ICMSC_P = icmsC
	doc.ICMS_P = icmsD + icmsC
	doc.ICMSSTC_P = impostoC
	doc.ICMSST_P = imposto
	doc.DifICMS_P = impostoC + imposto
	doc.FCP_P = fcpTot
	doc.IPID_P = ipiD
	doc.IPIC_P = ipiC
	doc.IPI_P = ipi
	doc.ISS_P = iss
	doc.INSS_P = inss
	'doc.PIS_P = pis
	'doc.COFINS_P = cofins
	'*** Intermediação de Vendas - LMO 05/11/2024 ***
	Dim percentualIntermediacao As Double, valorIntermediacao As Double
	If CStr(doc.PercentualIntermediacao(0)) <> "" Then percentualIntermediacao = doc.PercentualIntermediacao(0)
	If doc.TipoIntermediacao(0) = "Percentual Faturamento" Then
		valorIntermediacao = Round(doc.Venda_P(0) * percentualIntermediacao, 2)
	ElseIf doc.TipoIntermediacao(0) = "Percentual Margem" Then
		valorIntermediacao = Round(doc.BCPremio_P(0) * percentualIntermediacao, 2)
	ElseIf doc.TipoIntermediacao(0) = "Valor Fixo" Then
		If CStr(doc.ValoresIntermediacao_P(0)) <> "" Then
			For scan = 0 To UBound(doc.ValoresIntermediacao_P)
				If CStr(doc.ValoresIntermediacao_P(scan)) <> "" Then valorIntermediacao = valorIntermediacao + doc.ValoresIntermediacao_P(scan)
			Next
		Else
			If CStr(doc.ValorIntermediacao_P(0)) <> "" Then valorIntermediacao = doc.ValorIntermediacao_P(0)
		End If
	End If
	If CStr(doc.ValoresIntermediacao_P(0)) = "" Then doc.ValoresIntermediacao_P = valorIntermediacao
	doc.ValorIntermediacao_P = valorIntermediacao
	doc.Intermediacao_P = valorIntermediacao
	'*** Crédito PIS/COFINS na Intermediação de Vendas ***
	If doc.CreditoPisCofins(0) = "Sim" Then
		pis = pis - valorIntermediacao * doc.AliquotaPIS(0)
		pisS = pisS - valorIntermediacao * doc.AliquotaPIS(0)
		cofins = cofins - valorIntermediacao * doc.AliquotaCOFINS(0)
		cofinsS = cofinsS - valorIntermediacao * doc.AliquotaCOFINS(0)
	End If
	doc.PIS_P = pis
	doc.COFINS_P = cofins
	'*** FIM Intermediação de Vendas - LMO 05/11/2024 ***
	doc.CSLL_P = csll
	doc.IRPJ_P = irpj
	doc.CPR_P = cpr
	If doc.Sit(0) = "Prospect" Or doc.Sit(0) = "Forecast" Or InStr(doc.Sit(0), "Pré-Venda") > 0 Or InStr(doc.Sit(0), "POC") > 0 Then
		doc.Atividades_P = visitas
	Else
		If CStr(doc.Atividades_P(0)) = "" Then doc.Atividades_P = 0
	End If
	doc.Despesas_P = frete + intermediacao
	If doc.TipoVenda(0) = "Contrato" Then
		doc.TerceirosFaturaveis_P = terceirosT
	Else
		doc.TerceirosFaturaveis_P = pf(5)
	End If
	doc.PF_P = pf(0) + pf(1) + pf(2)
	doc.PreVenda_P = pf(6) + pf(7)
	doc.POC_P = pf(9) + pf(10)
	doc.Juros_P = doc.JurosTotal_P(0)
	'Tabela do Valor dos Serviços - LMO 29/06/12
	doc.ValorSV_P = doc.CustosHoras_P(0)
	doc.HorasSV_P = doc.HorasT_P(0)
	If Val(doc.HorasSV_P(0)) > 0 Then
		doc.CustoHoraSV_P = doc.ValorSV_P(0)/doc.HorasSV_P(0)
	Else
		doc.CustoHoraSV_P = 0
	End If
	'Comissionamento por Faturamento
	If doc.TipoComissionamento(0) = "Faturamento" Then
		Call CalcPremio(doc)
		doc.BCPremio_P = 0
		doc.Encargos_P = 0
		doc.Premio_P = doc.Premio(0)
		doc.Margem_P = (doc.Venda_P(0) - doc.ServicosInternos_P(0) - doc.Custo_P(0) - doc.CustoImp_P(0) - doc.CustosHoras_P(0) - doc.ICMS_P(0) - doc.DifICMS_P(0) - doc.FCP_P(0) - doc.IPI_P(0) - doc.ISS_P(0) - doc.INSS_P(0) - doc.PIS_P(0) - doc.COFINS_P(0) - doc.CSLL_P(0) - doc.IRPJ_P(0) - doc.CPR_P(0) - doc.Atividades_P(0) - doc.Despesas_P(0) - doc.TerceirosFaturaveis_P(0) - doc.PF_P(0) - doc.Juros_P(0)) - doc.Premio_P(0) - doc.Encargos_P(0)
	'Comissionamento por Margem
	Else
		'Base de Cálculo da Comissão e Encargos
		If CStr(doc.Comissao(0)) <> "" Then comissao = doc.Comissao(0)
		doc.BCPremio_P = (doc.Venda_P(0) - doc.Custo_P(0) - doc.CustoImp_P(0) - doc.CustosHoras_P(0) - doc.ICMS_P(0) - doc.DifICMS_P(0) - doc.FCP_P(0) - doc.IPI_P(0) - doc.ISS_P(0) - doc.INSS_P(0) - doc.PIS_P(0) - cofins - doc.CSLL_P(0) - doc.IRPJ_P(0) - doc.CPR_P(0) - doc.Atividades_P(0) - doc.Despesas_P(0) - doc.TerceirosFaturaveis_P(0) - doc.PF_P(0) - doc.PreVenda_P(0) - doc.POC_P(0) - doc.Juros_P(0)) * comissao
		doc.Encargos_P = doc.BCPremio_P(0) * doc.EncargosSociais(0)
		'Comissão e Margem - LMO 19/05/2020
		doc.Margem_P = (doc.Venda_P(0) - doc.Custo_P(0) - doc.CustoImp_P(0) - doc.CustosHoras_P(0) - doc.ICMS_P(0) - doc.DifICMS_P(0) - doc.FCP_P(0) - doc.IPI_P(0) - doc.ISS_P(0) - doc.INSS_P(0) - doc.PIS_P(0) - doc.COFINS_P(0) - doc.CSLL_P(0) - doc.IRPJ_P(0) - doc.CPR_P(0) - doc.Atividades_P(0) - doc.Despesas_P(0) - doc.TerceirosFaturaveis_P(0) - doc.PF_P(0) - doc.PreVenda_P(0) - doc.POC_P(0) - doc.Juros_P(0)) - doc.BCPremio_P(0) - doc.Encargos_P(0) - doc.Intermediacao_P(0)
		doc.Premio_P = doc.Margem_P(0) * comissao
		'*** Adiantamento ***
		Dim adiantamento As Double
		If CStr(doc.Adiantamento(0)) <> "" Then adiantamento = doc.Adiantamento(0)
		doc.PremioServicos = 0
		doc.PremioMateriais = 0
		doc.Premio = Round(doc.Premio_P(0) * adiantamento, 2)
	End If
	'Participação Técnica
	If doc.Margem_P(0) > 0 Then
		doc.Participacao_P = Round(doc.Margem_P(0) * (doc.PremioPV(0) + doc.PremioExec(0) + doc.PremioPMO(0)), 2)
	Else
		doc.Participacao_P = 0
	End If
	'*** Resultado do Negócio ***
	doc.Resultado_P = doc.Margem_P(0) - doc.Participacao_P(0)
	If doc.Venda_P(0) = 0 Then
		doc.Res_P = 0
	Else
		doc.Res_P = doc.Resultado_P(0) / doc.Venda_P(0)
	End If
	doc.ResultadoP = doc.Res_P(0)
	
	'*** Resultado de Materiais ***
	If doc.TipoVenda(0) = "Contrato" Then
		doc.ResultadoM_P = 0
		doc.ResM_P = 0
		doc.MgRevendaP = 0
		doc.ResultadoRevendaP = 0
	Else
		Dim premioM As Double, fatorM As Double, encargosM As Double, intermediacaoM As Double
		If doc.Venda_P(0) <> 0 Then
			fatorM = doc.VendaM_P(0) / doc.Venda_P(0)
		End If
		premioM = (doc.VendaM_P(0) - doc.Custo_P(0) - doc.CustoImp_P(0)	- doc.Despesas_P(0) - doc.ICMS_P(0) - doc.DifICMS_P(0) - doc.FCP_P(0) - doc.IPI_P(0) - issM - inssM - pisM - cofinsM - (doc.CSLL_P(0) * fatorM) - (doc.IRPJ_P(0) * fatorM) - cprM - (doc.Atividades_P(0) * fatorM) - doc.PreVenda_P(0) * fatorM - doc.POC_P(0) * fatorM - (doc.Juros_P(0) * fatorM)) * comissao
		encargosM = premioM * doc.EncargosSociais(0)
		intermediacaoM = doc.Intermediacao_P(0) * fatorM
		doc.ResultadoM_P = Round(doc.VendaM_P(0) - doc.Custo_P(0) - doc.CustoImp_P(0) - doc.Despesas_P(0) - doc.ICMS_P(0) - doc.DifICMS_P(0) - doc.FCP_P(0) - doc.IPI_P(0) - issM - inssM - pisM - cofinsM - (doc.CSLL_P(0) * fatorM) - (doc.IRPJ_P(0) * fatorM) - cprM - (doc.Atividades_P(0) * fatorM) - doc.PreVenda_P(0) * fatorM - doc.POC_P(0) * fatorM - (doc.Juros_P(0) * fatorM) - premioM - encargosM - intermediacaoM - (doc.Participacao_P(0) * fatorM), 2)
		If doc.VendaM_P(0) = 0 Then
			doc.ResM_P = 0
		Else
			doc.ResM_P = doc.ResultadoM_P(0) / doc.VendaM_P(0)
		End If
		doc.MgRevendaP = doc.ResM_P(0)
		doc.ResultadoRevendaP = doc.ResM_P(0)
	End If
	
	'*** Resultado de Serviços ***
	Dim premioS As Double, fatorS As Double, encargosS As Double, intermediacaoS As Double
	If doc.Venda_P(0) <> 0 Then
		fatorS = doc.VendaS_P(0) / doc.Venda_P(0)
	End If
	'Prêmio de Serviços
	premioS = (doc.VendaS_P(0) - doc.CustosHoras_P(0) - issS - inssS - pisS - cofinsS - (doc.CSLL_P(0) * fatorS) - (doc.IRPJ_P(0) * fatorS) - cprS - (doc.Atividades_P(0) * fatorS) - doc.TerceirosFaturaveis_P(0) - doc.PF_P(0) - doc.PreVenda_P(0) * fatorS - doc.POC_P(0) * fatorS - (doc.Juros_P(0) * fatorS)) * comissao
	encargosS = premioS * doc.EncargosSociais(0)
	intermediacaoS = doc.Intermediacao_P(0) * fatorS
	doc.ResultadoS_P = Round(doc.VendaS_P(0) - doc.CustosHoras_P(0) - issS - inssS - pisS - cofinsS - (doc.CSLL_P(0) * fatorS) - (doc.IRPJ_P(0) * fatorS) - cprS - (doc.Atividades_P(0) * fatorS) - doc.TerceirosFaturaveis_P(0) - doc.PF_P(0) - doc.PreVenda_P(0) * fatorS - doc.POC_P(0) * fatorS - (doc.Juros_P(0) * fatorS) - premioS - encargosS - intermediacaoS - (doc.Participacao_P(0) * fatorS), 2)
	If doc.VendaS_P(0) = 0 Then
		doc.ResS_P = 0
	Else
		doc.ResS_P = doc.ResultadoS_P(0) / doc.VendaS_P(0)
	End If
	doc.MgServicosP = doc.ResS_P(0)
	doc.ResultadoServicosP = doc.ResS_P(0)
	
End Sub

'++LotusScript Development Environment:2:2:LinkVisitasPopup:5:8
%REM
	Sub LinkVisitasPopup
	Description: Comments for Sub
%END REM
Sub LinkVisitasPopup(negocio As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim dc As NotesDocumentCollection
	If negocio.HasItem("DocLinks") Then negocio.RemoveItem("DocLinks")
	Set db =  session.CurrentDatabase
	Set view = db.GetView("(VisitasCodigo)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Dim rtitem As NotesRichTextItem
	Set rtitem = negocio.CreateRichTextItem("DocLinks")
	'Define o Estilo
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 8
	richStyle.NotesColor = COLOR_BLACK     
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AppendText("Visitas")
	Call rtitem.AddNewLine(1)
	Set doc = dc.GetFirstDocument
	richStyle.NotesColor = COLOR_BLUE     
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Set doc = dc.GetFirstDocument      
	While Not doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para a Visita")
		Call rtitem.AppendText(Format(doc.Data(0), "dd/mm/yyyy") & " ")
		Call rtitem.AppendText(doc.GerenteConta(0) & " ")
		Call rtitem.AppendText(doc.Atividade(0))
		Call rtitem.AddNewLine( 1 )
		Set doc = dc.GetNextDocument( doc )
	Wend
	
End Sub

'++LotusScript Development Environment:2:1:BuscaImpostos:5:8
%REM
	Function BuscaImpostos
	Description: Comments for Function
%END REM
Function BuscaImpostos(ncm As String) As Variant
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim array(5) As Variant
	Set view = db.GetView("(CargaTributaria)")
	Set doc = view.GetDocumentByKey(ncm, True)
	If Not doc Is Nothing Then
		array(0) = doc.ICMS(0)
		array(1) = doc.IPI(0)
		array(2) = doc.II(0)
		array(3) = doc.ISS(0)
		array(4) = doc.IRRF(0)
		array(5) = doc.INSSRF(0)
	End If
	BuscaImpostos = array
	
End Function

'++LotusScript Development Environment:2:1:CalcIss:1:8
Function CalcIss (doc As NotesDocument) As Double
	
	'Utiliza a Alíquota do Código do Serviço
	CalcISS# = doc.TotalServicos(0) * doc.AliqServico(0)
	
End Function

'++LotusScript Development Environment:2:1:CkReceber:1:8
Function CkReceber(negocio As NotesDocument) As Boolean
	
	CkReceber = True
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	'Verifica se tem Faturas/Glosas A Emitir
	Set view = db.GetView("(EspelhosNegocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.Sit(0) = "A Emitir" Or doc.Sit(0) = "Aguardando Aprovação" Then
			CkReceber = False
			Exit Function
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	'Verifica se todos os Receber foram pagos
	Set view = db.GetView("(Receber/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.Sit(0) = "a Receber" Then
			CkReceber = False
			Exit Function
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	'Data do Último Receber
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		negocio.DataConclusaoReceber = doc.Pagamento(0)
	End If
	
End Function

'++LotusScript Development Environment:2:1:GetResponsavelPlanejamento:1:8
Function GetResponsavelPlanejamento(area As String, tipo As String) As String
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Set view = db.getView("ConfigsProjeto")
	Dim doc As NotesDocument
	Set doc = view.getDocumentByKey(area, True)
	prazoPlanejamento = 0
	If Not(doc Is Nothing) Then
		'Pré-Venda
		If tipo = "PreVenda" Then
			GetResponsavelPlanejamento = doc.ResponsavelSolicitacaoPreVenda(0)
			prazoPlanejamento = Val(doc.PrazoPlanejamentoPreVenda(0))
			'POC
		ElseIf tipo = "Poc" Then
			GetResponsavelPlanejamento = doc.ResponsavelSolicitacaoPOC(0)
			prazoPlanejamento = Val(doc.PrazoPlanejamentoPOC(0))
			'Kickoff
		ElseIf tipo = "Kickoff" Then
			GetResponsavelPlanejamento = doc.ResponsavelSolicitacaoKickoff(0)
			prazoPlanejamento = Val(doc.PrazoPlanejamentoKickoff(0))
			'Pós-Venda
		Else
			GetResponsavelPlanejamento = doc.ResponsavelSolicitacaoPosVenda(0)
			prazoPlanejamento = Val(doc.PrazoPlanejamentoPosVenda(0))
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:OrganizaListaPorMoeda:5:8
%REM
	Sub OrganizaListaPorMoeda
	Description: Agrega os itens por moeda (US$ e R$) em negócios que ainda não estão em LISTAS.NSF
%END REM
Sub OrganizaListaPorMoeda(uidoc As NotesUIDocument)
	Dim codigo As String
	codigo = uidoc.Fieldgettext("Codigo")
	dim dbLista as New NotesDatabase(uidoc.Document.Parentdatabase.Server,"listas.nsf")
	Dim view As NotesView
	set view = dbLista.getView("")
	Dim dc As NotesDocumentCollection
	Set dc = view.getalldocumentsbykey(codigo, True)
	If dc.count > 0 Then
		MsgBox("Este Negócio está em andamento e não pode ser alterado")
		Exit sub
	End If
	Dim scan As Integer, scanUSC As Integer, scanUST As Integer, scanR As Integer
	Dim qvar As Integer, moeda As double
	Dim us As string
	For scan% = 0 To 49
		qvar = Val(uidoc.FieldGetText("Q_" & scan))
		If qvar > 0 Then     ' Verificando se o conteúdo da variante é numerica
			us = uidoc.FieldGetText("Us_" & scan)
			If us = "US$C" Then
				ReDim Preserve usc(scanUsc) As Variant
				scanUSC = scanUSC + 1
					
			ElseIf us = "US$T" Then
				ReDim Preserve ust(scanUST) As Variant
				scanUST = scanUST + 1
			Else
				ReDim Preserve r(scanR) As Variant
				scanR = scanR + 1
			End If
		End If
	Next
End Sub

'++LotusScript Development Environment:2:2:GetValores:5:8
%REM
	Sub GetValores dos Controle Financeiros e Cotações Financeiras
	Description: Comments for Sub
%END REM
Sub GetValores(planilha As NotesDocument)
	
	On Error Resume Next
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	'*** Execução ***
	'Planejado
	Dim passP As Double, hospP As Double, transporteP As Double, alugP As Double, matP As Double, ativoP As Double, servP As Double, freteMP As Double
	Dim kmP As Double, transP As Double, alimP As Double, teleP As Double
	Dim planP As Double, gerP As Double, execP As Double, deslocamentoP As Double, docP As Double
	Dim terceirosP As Double
	Dim freteP As Double, intermediacaoP As Double
	'Desvios
	Dim passD As Double, hospD As Double, transporteD As Double, alugD As Double, matD As Double, ativoD As Double, servD As Double, freteMD As Double
	Dim kmD As Double, transD As Double, alimD As Double, teleD As Double
	Dim pvD As Double, planD As Double, gerD As Double, execD As Double, deslocamentoD As Double, docD As Double
	Dim terceirosD As Double
	Dim freteD As Double, intermediacaoD As Double
	'Utilizado
	Dim passU As Double, hospU As Double, transporteU As Double, alugU As Double, matU As Double, ativoU As Double, servU As Double, freteMU As Double
	Dim terceirosU As Double
	Dim freteU As Double, intermediacaoU As Double
	'*** Pré-Venda ***
	'Planejado
	Dim passPV As Double, hospPV As Double, transportePV As Double, alugPV As Double, matPV As Double, ativoPV As Double, servPV As Double, freteMPV As Double
	Dim kmPV As Double, transPV As Double, alimPV As Double, telePV As Double
	Dim pvPV As Double, planPV As Double, gerPV As Double, execPV As Double, deslocamentoPV As Double, docPV As Double
	'Utilizado
	Dim passPVU As Double, hospPVU As Double, transportePVU As Double, alugPVU As Double, matPVU As Double, ativoPVU As Double, servPVU As Double, freteMPVU As Double
	'*** POC ***
	'Planejado
	Dim passPOC As Double, hospPOC As Double, transportePOC As Double, alugPOC As Double, matPOC As Double, ativoPOC As Double, servPOC As Double, freteMPOC As Double
	Dim kmPOC As Double, transPOC As Double, alimPOC As Double, telePOC As Double
	Dim pvPOC As Double, planPOC As Double, gerPOC As Double, execPOC As Double, deslocamentoPOC As Double, docPOC As Double
	'Utilizado
	Dim passPOCU As Double, hospPOCU As Double, transportePOCU As Double, alugPOCU As Double, matPOCU As Double, ativoPOCU As Double, servPOCU As Double, freteMPOCU As Double
	
	Set dc = planilha.Responses
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If doc.Form(0) = "ControleFinanceiro" Then
			'Custos
			Dim pass As Double, pass_1 As Double, hosp As Double, hosp_1 As Double, transporte As Double, alug As Double, alug_1 As Double, mat As Double, mat_1 As Double, mat_2 As Double, ativo As Double, ativo_1 As Double, serv As Double, serv_1 As Double, freteM As Double
			If CStr(doc.PassP(0)) <> "" Then pass = doc.PassP(0) Else pass = 0
			If CStr(doc.PassP_1(0)) <> "" Then pass_1 = doc.PassP_1(0) Else pass_1 = 0
			If CStr(doc.HospP(0)) <> "" Then hosp = doc.HospP(0) Else hosp = 0
			If CStr(doc.HospP_1(0)) <> "" Then hosp_1 = doc.HospP_1(0) Else hosp_1 = 0
			If CStr(doc.TransporteP(0)) <> "" Then transporte = doc.TransporteP(0) Else transporte = 0
			If CStr(doc.AlugP(0)) <> "" Then alug = doc.AlugP(0) Else alug = 0
			If CStr(doc.AlugP_1(0)) <> "" Then alug_1 = doc.AlugP_1(0) Else alug_1 = 0
			If CStr(doc.MatP(0)) <> "" Then mat = doc.MatP(0) Else mat = 0
			If CStr(doc.MatP_1(0)) <> "" Then mat_1 = doc.MatP_1(0) Else mat_1 = 0
			If CStr(doc.MatP_2(0)) <> "" Then mat_2 = doc.MatP_2(0) Else mat_2 = 0
			If CStr(doc.AtivoP(0)) <> "" Then ativo = doc.AtivoP(0) Else ativo = 0
			If CStr(doc.AtivoP_1(0)) <> "" Then ativo_1 = doc.AtivoP_1(0) Else ativo_1 = 0
			If CStr(doc.ServP(0)) <> "" Then serv = doc.ServP(0) Else serv = 0
			If CStr(doc.ServP_1(0)) <> "" Then serv_1 = doc.ServP_1(0) Else serv_1 = 0
			If CStr(doc.FreteMP(0)) <> "" Then freteM = doc.FreteMP(0) Else freteM = 0
			'Despesas
			Dim km As Double, km_1 As Double, trans As Double, trans_1 As Double, trans_2 As Double, trans_3 As Double, trans_4 As Double, trans_5 As Double, trans_6 As Double, alim As Double, alim_1 As Double, tele As Double
			If CStr(doc.KmP(0)) <> "" Then km = doc.KmP(0) Else km = 0
			If CStr(doc.KmP_1(0)) <> "" Then km_1 = doc.KmP_1(0) Else km_1 = 0
			If CStr(doc.TransP(0)) <> "" Then trans = doc.TransP(0) Else trans = 0
			If CStr(doc.TransP_1(0)) <> "" Then trans_1 = doc.TransP_1(0) Else trans_1 = 0
			If CStr(doc.TransP_2(0)) <> "" Then trans_2 = doc.TransP_2(0) Else trans_2 = 0
			If CStr(doc.TransP_3(0)) <> "" Then trans_3 = doc.TransP_3(0) Else trans_3 = 0
			If CStr(doc.TransP_4(0)) <> "" Then trans_4 = doc.TransP_4(0) Else trans_4 = 0
			If CStr(doc.TransP_5(0)) <> "" Then trans_5 = doc.TransP_5(0) Else trans_5 = 0
			If CStr(doc.TransP_6(0)) <> "" Then trans_6 = doc.TransP_6(0) Else trans_6 = 0
			If CStr(doc.AlimP(0)) <> "" Then alim = doc.AlimP(0) Else alim = 0
			If CStr(doc.AlimP_1(0)) <> "" Then alim_1 = doc.AlimP_1(0) Else alim_1 = 0
			If CStr(doc.TeleP(0)) <> "" Then tele = doc.TeleP(0) Else tele = 0
			'Horas Homem
			Dim plan As Double, ger As Double, exec As Double, deslocamento As Double, docu As Double
			If CStr(doc.PlanP(0)) <> "" Then plan = doc.PlanP(0) Else plan = 0
			If CStr(doc.GerP(0)) <> "" Then ger = doc.GerP(0) Else ger = 0
			If CStr(doc.ExecP(0)) <> "" Then exec = doc.ExecP(0) Else exec = 0
			If CStr(doc.DeslocamentoP(0)) <> "" Then deslocamento = doc.DeslocamentoP(0) Else deslocamento = 0
			If CStr(doc.DocP(0)) <> "" Then docu = doc.DocP(0) Else docu = 0
			'Terceiros Fauráveis
			Dim terceiros As Double
			If CStr(doc.TerceirosP(0)) <> "" Then terceiros = doc.TerceirosP(0) Else terceiros = 0
			'Despesas de Vendas
			Dim frete As Double, intermediacao As Double
			If CStr(doc.FreteP(0)) <> "" Then frete = doc.FreteP(0) Else frete = 0
			If CStr(doc.IntermediacaoP(0)) <> "" Then intermediacao = doc.IntermediacaoP(0) Else intermediacao = 0
			'*** Planejado ***
			If doc.Tipo(0) = "Planejado" Then
				'Custos
				passP = passP + pass + pass_1
				hospP = hospP + hosp + hosp_1
				transporteP = transporteP + transporte
				alugP = alugP + alug + alug_1
				matP = matP + mat + mat_1 + mat_2
				ativoP = ativoP + ativo + ativo_1
				servP = servP + serv + serv_1
				freteMP = freteMP + freteM
				'Despesas
				kmP = kmP + km + km_1
				transP = transP + trans + trans_1 + trans_2 + trans_3 + trans_4 + trans_5 + trans_6
				alimP = alimP + alim + alim_1
				teleP = teleP + tele
				'Horas Homem
				planP = planP + plan
				gerP = gerP + ger
				execP = execP + exec
				deslocamentoP = deslocamentoP + deslocamento
				docP = docP + docu
				'Terceiros Fauráveis
				terceirosP = terceirosP + terceiros
				'Despesas de Vendas
				freteP = freteP + frete
				intermediacaoP = intermediacaoP + intermediacao
			'*** Pré-Venda ***
			ElseIf (doc.Tipo(0) = "Pré-Venda" And doc.Status(0) = "Aprovado") Or doc.Tipo(0) = "Pré-Venda Planejada" Then
				'Custos
				passPV = passPV + pass + pass_1
				hospPV = hospPV + hosp + hosp_1
				transportePV = transportePV + transporte
				alugPV = alugPV + alug + alug_1
				matPV = matPV + mat + mat_1 + mat_2
				ativoPV = ativoPV + ativo + ativo_1
				servPV = servPV + serv + serv_1
				freteMPV = freteMPV + freteM
				'Despesas
				kmPV = kmPV + km + km_1
				transPV = transPV + trans + trans_1 + trans_2 + trans_3 + trans_4 + trans_5 + trans_6
				alimPV = alimPV + alim + alim_1
				telePV = telePV + tele
				'Horas Homem
				planPV = planPV + plan
				gerPV = gerPV + ger
				execPV = execPV + exec
				deslocamentoPV = deslocamentoPV + deslocamento
				docPV = docPV + docu
			'*** POC ***
			ElseIf (doc.Tipo(0) = "POC" And doc.Status(0) = "Aprovado") Or doc.Tipo(0) = "POC Planejado" Then
				'Custos
				passPOC = passPOC + pass + pass_1
				hospPOC = hospPOC + hosp + hosp_1
				transportePOC = transportePOC + transporte
				alugPOC = alugPOC + alug + alug_1
				matPOC = matPOC + mat + mat_1 + mat_2
				ativoPOC = ativoPOC + ativo + ativo_1
				servPOC = servPOC + serv + serv_1
				freteMPOC = freteMPOC + freteM
				'Despesas
				kmPOC = kmPOC + km + km_1
				transPOC = transPOC + trans + trans_1 + trans_2 + trans_3 + trans_4 + trans_5 + trans_6
				alimPOC = alimPOC + alim + alim_1
				telePOC = telePOC + tele
				'Horas Homem
				planPOC = planPOC + plan
				gerPOC = gerPOC + ger
				deslocamentoPOC = deslocamentoPOC + deslocamento
				execPOC = execPOC + exec
				docPOC = docPOC + docu
			'*** Desvios ***
			ElseIf doc.Tipo(0) = "Desvio" And doc.Status(0) = "Aprovado" Then
				'Custos
				passD = passD + pass + pass_1
				hospD = hospD + hosp + hosp_1
				transporteD = transporteD + transporte
				alugD = alugD + alug + alug_1
				matD = matD + mat + mat_1 + mat_2
				ativoD = ativoD + ativo + ativo_1
				servD = servD + serv + serv_1
				freteMD = freteMD + freteM
				'Despesas
				kmD = kmD + km + km_1
				transD = transD + trans + trans_1 + trans_2 + trans_3 + trans_4 + trans_5 + trans_6
				alimD = alimD + alim + alim_1
				teleD = teleD + tele
				'Horas Homem
				planD = planD + plan
				gerD = gerD + ger
				execD = execD + exec
				deslocamentoD = deslocamentoD + deslocamento
				docD = docD + docu
				'Terceiros Fauráveis
				terceirosD = terceirosD + terceiros
				'Despesas de Vendas
				freteD = freteD + frete
				intermediacaoD = intermediacaoD + intermediacao
			End If
		'*** Cotação Financeira ***
		ElseIf doc.Form(0) = "CotacaoFinanceira" Then
			'*** Pré-Venda ***
			If doc.Fase(0) = "Pré-Venda" Then
				If doc.Sit(0) = "Pedir Aprovação" Or doc.Sit(0) = "Pendente" Then
					'*** A Utilizar ***
					'Custos
					If doc.Tipo(0) = "Passagens de Projetos" Then
						passPVU = passPVU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Hospedagem de Projetos" Then	
						hospPVU = hospPVU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Transporte de Projetos" Then
						transportePVU = transportePVU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Alugueis de Projetos" Then	
						alugPVU = alugPVU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "CPS" Then	
						matPVU = matPVU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Ativo" Then	
						ativoPVU = ativoPVU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Terceiros" Then	
						servPVU = servPVU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Frete de Projetos" Then	
						freteMPVU = freteMPVU + doc.Saldo(0)
					End If
				ElseIf doc.Sit(0) <> "Não Aprovada" Then
				'*** Utilizado ***
					'Custos
					If doc.Tipo(0) = "Passagens de Projetos" Then
						passPVU = passPVU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Hospedagem de Projetos" Then
						hospPVU = hospPVU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Transporte de Projetos" Then
						transportePVU = transportePVU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Alugueis de Projetos" Then	
						alugPVU = alugPVU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "CPS" Then	
						matPVU = matPVU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Ativo" Then	
						ativoPVU = ativoPVU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Terceiros" Then	
						servPVU = servPVU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Frete de Projetos" Then	
						freteMPVU = freteMPVU + doc.TotMateriais(0)
					End If
				End If
			'*** POC ***
			ElseIf doc.Fase(0) = "POC" Then
				If doc.Sit(0) = "Pedir Aprovação" Or doc.Sit(0) = "Pendente" Then
					'*** A Utilizar ***
					'Custos
					If doc.Tipo(0) = "Passagens de Projetos" Then
						passPOCU = passPOCU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Hospedagem de Projetos" Then	
						hospPOCU = hospPOCU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Transporte de Projetos" Then
						transportePOCU = transportePOCU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Alugueis de Projetos" Then	
						alugPOCU = alugPOCU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "CPS" Then	
						matPOCU = matPOCU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Ativo" Then	
						ativoPOCU = ativoPOCU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Terceiros" Then	
						servPOCU = servPOCU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Frete de Projetos" Then	
						freteMPOCU = freteMPOCU + doc.Saldo(0)
					End If
				ElseIf doc.Sit(0) <> "Não Aprovada" Then
					'*** Utilizado ***
					'Custos
					If doc.Tipo(0) = "Passagens de Projetos" Then
						passPOCU = passPOCU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Hospedagem de Projetos" Then
						hospPOCU = hospPOCU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Transporte de Projetos" Then
						transportePOCU = transportePOCU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Alugueis de Projetos" Then	
						alugPOCU = alugPOCU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "CPS" Then	
						matPOCU = matPOCU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Ativo" Then	
						ativoPOCU = ativoPOCU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Terceiros" Then	
						servPOCU = servPOCU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Frete de Projetos" Then	
						freteMPOCU = freteMPOCU + doc.TotMateriais(0)
					End If
				End If
			'*** Execução ***
			ElseIf Fechado(planilha.StatusNegocio(0)) And doc.Fase(0) = "Execução" Then
				If doc.Sit(0) = "Pedir Aprovação" Or doc.Sit(0) = "Pendente" Then
					'*** A Utilizar ***
					'Custos
					If doc.Tipo(0) = "Passagens de Projetos" Then
						passU = passU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Transporte de Projetos" Then
						transporteU = transporteU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Hospedagem de Projetos" Then	
						hospU = hospU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Alugueis de Projetos" Then	
						alugU = alugU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "CPS" Then	
						matU = matU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Ativo" Then	
						ativoU = ativoU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Terceiros" Then	
						servU = servU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "Frete de Projetos" Then	
						freteMU = freteMU + doc.Saldo(0)
					End If
					'Terceiros Fauráveis
					If doc.Tipo(0) = "CSV" Then
						terceirosU = terceirosU + doc.Saldo(0)
					End If	
					'Despesas de Vendas
					If doc.Tipo(0) = "Frete de Revenda" Then
						freteU = freteU + doc.Saldo(0)
					ElseIf doc.Tipo(0) = "CMV" Then	
						intermediacaoU = intermediacaoU + doc.Saldo(0)
					End If
				ElseIf doc.Sit(0) <> "Não Aprovada" Then
					'*** Utilizado ***
					'Custos
					If doc.Tipo(0) = "Passagens de Projetos" Then
						passU = passU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Hospedagem de Projetos" Then
						hospU = hospU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Transporte de Projetos" Then
						transporteU = transporteU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Alugueis de Projetos" Then	
						alugU = alugU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "CPS" Then	
						matU = matU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Ativo" Then	
						ativoU = ativoU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Terceiros" Then	
						servU = servU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "Frete de Projetos" Then	
						freteMU = freteMU + doc.TotMateriais(0)
					End If
					'Terceiros Fauráveis
					If doc.Tipo(0) = "CSV" Then
						terceirosU = terceirosU + doc.TotMateriais(0)
					End If
					'Despesas de Vendas
					If doc.Tipo(0) = "Frete de Revenda" Then
						freteU = freteU + doc.TotMateriais(0)
					ElseIf doc.Tipo(0) = "CMV" Then	
						intermediacaoU = intermediacaoU + doc.TotMateriais(0)
					End If
				End If
			End If
		End If
		Set doc = dc.GetNextdocument(doc)
	Loop
	'*** Print Execução ***
	'*** Planejado ***
	'Custos
	planilha.PassP = passP
	planilha.HospP = hospP
	planilha.TransporteP = transporteP
	planilha.AlugP = alugP
	planilha.MatP = matP
	planilha.AtivoP = ativoP
	planilha.ServP = servP
	planilha.FreteMP = freteMP
	'Despesas
	planilha.KmP = kmP
	planilha.TranspP = transP
	planilha.AlimeP = alimP
	planilha.TeleP = teleP
	'Horas Homem
	planilha.PlanP = planP
	planilha.GerP = gerP
	planilha.ExecP = execP
	planilha.DeslocamentoP = deslocamentoP
	planilha.DocP = docP
	'Terceiros Fauráveis
	planilha.TerceirosP = terceirosP
	'Despesas de Vendas
	planilha.FreteP = freteP
	planilha.intermediacaoP = intermediacaoP
	'*** Desvios ***
	'Custos
	planilha.PassD = passD
	planilha.HospD = hospD
	planilha.TransporteD = transporteD
	planilha.AlugD = alugD
	planilha.MatD = matD
	planilha.AtivoD = ativoD
	planilha.ServD = servD
	planilha.FreteMD = freteMD
	'Despesas
	planilha.KmD = kmD
	planilha.TranspD = transD
	planilha.AlimeD = alimD
	planilha.TeleD = teleD
	'Horas Homem
	planilha.PVD = pvD
	planilha.PlanD = planD
	planilha.GerD = gerD
	planilha.ExecD = execD
	planilha.DeslocamentoD = deslocamentoD
	planilha.DocD = docD
	'Terceiros Fauráveis
	planilha.TerceirosD = terceirosD
	'Despesas de Vendas
	planilha.FreteD = freteD
	planilha.intermediacaoD = intermediacaoD
	'*** Utilizado ***
	'Custos
	planilha.PassU = passU
	planilha.HospU = hospU
	planilha.TransporteU = transporteU
	planilha.AlugU = alugU
	planilha.MatU = matU
	planilha.AtivoU = ativoU
	planilha.ServU = servU
	planilha.FreteMU = freteMU
	'Terceiros Fauráveis
	planilha.TerceirosU = terceirosU
	'Despesas de Vendas
	planilha.FreteU = freteU
	planilha.intermediacaoU = intermediacaoU
	'*** Print Pré-Venda ***
	 '* Planejado *
	'Custos
	planilha.PassPVT = passPV
	planilha.HospPVT = hospPV
	planilha.TransportePVT = transportePV
	planilha.AlugPVT = alugPV
	planilha.MatPVT = matPV
	planilha.AtivoPVT = ativoPV
	planilha.ServPVT = servPV
	planilha.FreteMPVT = freteMPV
	'Despesas
	planilha.KmPVT = kmPV
	planilha.TranspPVT = transPV
	planilha.AlimePVT = alimPV
	planilha.TelePVT = telePV
	'Horas Homem
	planilha.PlanPVT = planPV
	planilha.GerPVT = gerPV
	planilha.ExecPVT = execPV
	planilha.DeslocamentoPVT = deslocamentoPV
	planilha.DocPVT = docPV
	'* Utilizado *
	'Custos
	planilha.PassPVU = passPVU
	planilha.HospPVU = hospPVU
	planilha.TransportePVU = transportePVU
	planilha.AlugPVU = alugPVU
	planilha.MatPVU = matPVU
	planilha.AtivoPVU = ativoPVU
	planilha.ServPVU = servPVU
	planilha.FreteMPVU = freteMPVU
	'*** Print POC ***
	'* Planejado *
	'Custos
	planilha.PassPOCT = passPOC
	planilha.HospPOCT = hospPOC
	planilha.TransportePOCT = transportePOC
	planilha.AlugPOCT = alugPOC
	planilha.MatPOCT = matPOC
	planilha.AtivoPOCT = ativoPOC
	planilha.ServPOCT = servPOC
	planilha.FreteMPOCT = freteMPOC
	'Despesas
	planilha.KmPOCT = kmPOC
	planilha.TranspPOCT = transPOC
	planilha.AlimePOCT = alimPOC
	planilha.TelePOCT = telePOC
	'Horas Homem
	planilha.PlanPOCT = planPOC
	planilha.GerPOCT = gerPOC
	planilha.ExecPOCT = execPOC
	planilha.DeslocamentoPOCT = deslocamentoPOC
	planilha.DocPOCT = docPOC
	'* Utilizado *
	'Custos
	planilha.PassPOCU = passPOCU
	planilha.HospPOCU = hospPOCU
	planilha.TransportePOCU = transportePOCU
	planilha.AlugPOCU = alugPOCU
	planilha.MatPOCU = matPOCU
	planilha.AtivoPOCU = ativoPOCU
	planilha.ServPOCU = servPOCU
	planilha.FreteMPOCU = freteMPOCU
	
End Sub

'++LotusScript Development Environment:2:1:CheckStatusServicos:1:8
Function CheckStatusServicos(uidoc As NotesDocument)
	
	Dim dbServicos As New NotesDatabase(uidoc.Document.ParentDatabase.Server,"servicos.nsf")     
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim listaServicos As NotesDocumentCollection               
	'Verificando os status do projeto em Serviços
	Set view = dbServicos.GetView( "(ProjetosNegocio)" )
	Set doc = view.GetDocumentByKey(uidoc.Codigo(0),True)
	If Not (doc Is Nothing) Then
		uidoc.sitServicos = doc.Sit
	Else
		uidoc.sitServicos = "OK"
	End If
	'Verificando se o contrato encontra-se na lista de contratos ativos em Serviços
	If uidoc.TipoVenda(0) = "Contrato" Then
		Set view = dbServicos.GetView("(ContratosAtivos)")
		Set doc = view.GetDocumentByKey(uidoc.Codigo(0),True)     
		If Not (doc Is Nothing) Then
			uidoc.SitContrato = doc.Sit
		Else
			uidoc.sitContrato = "Inativo"
		End If
	End If
	
	Set view = dbServicos.GetView("(NegocioForm)")
	Set listaServicos = view.GetAllDocumentsByKey(uidoc.Codigo(0) & "Fase", True)
	Set doc = listaServicos.GetFirstDocument
	Dim scan As Integer
	Dim itFat As Variant
	Dim statsFat As String, status As String
	scan% = 0
	Do Until doc Is Nothing          
		StatsFat$ = "Sts_"+ Cstr(scan%)
		status$ = doc.Sit(0)
		Set itFat = uidoc.ReplaceItemValue( statsFat$, status$)
		Set doc = listaServicos.GetNextDocument(doc)
		scan% = scan% + 1          
	Loop              
	
	
End Function

'++LotusScript Development Environment:2:1:CkChamados:5:8
%REM
	Function CkChamados
	Description: Comments for Function
%END REM
Function CkChamados(uidoc As NotesuiDocument) As Boolean
	
	CkChamados = True
	Dim db As New NotesDatabase(uidoc.Document.Parentdatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Set view = db.Getview("(ChamadosPendentes/Negocio)")
	Set dc = view.GetAllDocumentsbykey(uidoc.Document.Codigo(0), True)
	If dc.Count > 0 Then
		CkChamados = False
		MsgBox "Contrato não pode ser concluído pois tem Chamados Pendentes", 16, "Erro na Conclusão do Contrato"
	End If	
	
End Function

'++LotusScript Development Environment:2:2:SaveAceiteFaturamento:5:8
%REM
	Sub SaveAceiteFaturamento
	Description: Comments for Sub
%END REM
Sub SaveAceiteFaturamento(uidoc As NotesuiDocument)
	
	Dim db As New NotesDatabase(uidoc.Document.Parentdatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument, aceite As NotesDocument
	Dim rtitem As NotesRichTextItem
	Dim anexos As NotesRichTextItem
	Dim datas As Variant, horarios As Variant, responsaveis As Variant, contatos As Variant, observacoes As Variant
	Dim key(2) As String
	Set aceite = uidoc.Document
	key(0) = aceite.Codigo(0)
	key(1) = aceite.NFiscal(0)
	key(2) = aceite.CodEmpresa(0)
	Call uidoc.save
	Call uidoc.Reload( )
	Set view = db.Getview("(EspelhosNegocioAceitePendente)")
	Set doc = view.GetDocumentbykey(key, True)
	If Not doc Is Nothing Then
		doc.StatusAceiteFaturamento = aceite.StatusAceiteFaturamento(0)
		If aceite.Hasitem("EmailAceiteFaturamento") Then
			If doc.Hasitem("EmailAceiteFaturamento") Then doc.Removeitem("EmailAceiteFaturamento")
			Set rtitem = doc.CreateRichTextItem("EmailAceiteFaturamento")
			Set anexos = aceite.Getfirstitem("EmailAceiteFaturamento")
			Call rtitem.Appendrtitem(anexos)
		End If
		If doc.DatasContato(0) <> "" Then
			datas = ArrayAppend(aceite.Data, doc.DatasContato)
			horarios = ArrayAppend(aceite.Horario, doc.HorariosContato)
			responsaveis = ArrayAppend(aceite.ResponsavelContato, doc.ResponsaveisContato)
			contatos = ArrayAppend(aceite.Contato, doc.ContatosContato)
			observacoes = ArrayAppend(aceite.Observacao, doc.ObservacoesContato)
		Else
			datas = aceite.Data
			horarios = aceite.Horario
			responsaveis = aceite.ResponsavelContato
			contatos = aceite.Contato
			observacoes = aceite.Observacao
		End If
		'Dados do Comprador
		doc.Comprador = aceite.Comprador(0)
		doc.TelComprador = aceite.TelComprador(0)
		doc.CelComprador = aceite.CelComprador(0)
		doc.EmailComprador = aceite.EmailComprador(0)
		doc.EnviarEmail = aceite.EnviarEmail(0)
		'
		doc.NumContatos = Val(aceite.NumContatos(0)) + 1
		doc.DatasContato = datas
		doc.HorariosContato = horarios
		doc.ResponsaveisContato = responsaveis
		doc.ContatosContato = contatos
		doc.ObservacoesContato = observacoes
		Call doc.Save(True, True)
		'Salva Informações do Aceite no Receber - LMO 23/10/18
		Call AtualizaReceber(doc)	
	End If
	
End Sub

'++LotusScript Development Environment:2:2:AtualizaSaldosEstoque:5:8
%REM
	Sub AtualizaSaldosEstoque
	Description: Comments for Sub
%END REM
Sub AtualizaSaldosEstoque(negocio As NotesDocument)
	
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "estoquemain.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim scan As Integer, saldo As Long, qtdEstoque As Long, valorEstoque As Double, fator As Double
	Dim key(1) As String
	key(0) = negocio.Codigo(0)
	Set view = db.Getview("(Estoque/Reserva)")
	For scan = 0 To 49
		key(1) = CStr(scan + 1)
		Set dc = view.Getalldocumentsbykey(key, True)
		Set doc = dc.Getfirstdocument()
		qtdEstoque = 0
		Do Until doc Is Nothing
			If CStr(doc.Saldo(0)) <> "" Then
				saldo = doc.Saldo(0)
			Else
				saldo = doc.Q(0) - doc.QSaida(0)
			End If
			qtdEstoque = qtdEstoque + saldo
			Set doc = dc.Getnextdocument(doc)
		Loop
		If negocio.GetItemValue( "Produto_" & scan)(0) <> "" Or qtdEstoque > 0 Then
			Call negocio.ReplaceItemValue( "QEstoque_" & scan, qtdEstoque)
		Else
			Call negocio.ReplaceItemValue( "QEstoque_" & scan, "")
		End If
		'Valor Total de Venda em Estoque
		If Val(negocio.Getitemvalue("Q_" & scan)(0)) > 0 And qtdEstoque > 0 Then
			'Cotação
			If negocio.Getitemvalue("us_" & scan)(0) = "US$C" Then
				'US$C Venda Fixo
				If IsNumeric(negocio.USVenda(0)) Then
					fator = negocio.USVenda(0)
				Else
					fator = negocio.USC(0)
				End If
			Else
				fator = 1
			End If
			If CStr(negocio.Getitemvalue("VendaTot_" & scan)(0)) <> "" Then valorEstoque = valorEstoque + negocio.Getitemvalue("VendaTot_" & scan)(0) / negocio.Getitemvalue("Q_" & scan)(0) * qtdEstoque * fator
		End If
	Next
	negocio.ValorEstoque = valorEstoque
	
End Sub

'++LotusScript Development Environment:2:2:LinkCotacoes:1:8
Sub LinkCotacoes(negocio As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "compras.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim cont As Integer
	'Define o Estilo do Texto
	Dim richStyle As NotesRichTextStyle	
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 8
	richStyle.NotesColor = COLOR_BLUE
	'
	If negocio.HasItem("LinkCotacoes") Then negocio.RemoveItem("LinkCotacoes")
	If negocio.HasItem("LinkPedidos") Then negocio.RemoveItem("LinkPedidos")
	Set view = db.Getview("(Cotacoes/Codigo)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument      
	Dim rtitem As NotesRichTextItem
	Set rtitem = negocio.CreateRichTextItem("LinkCotacoes")
	Call rtitem.AppendStyle(richStyle)
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para a Cotação")
		Call rtitem.AppendText(" " + doc.Status(0))
		Set doc = dc.GetNextDocument(doc)
		If Not doc Is Nothing Then
			Call rtitem.Addnewline(1)
		End If
	Loop
	'Link para os Pedidos de Compra
	Set view = db.Getview("(PedidosCodigo)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set rtitem = negocio.CreateRichTextItem("LinkPedidos")
	Call rtitem.AppendStyle(richStyle)
	cont = dc.Count
	Set doc = dc.GetFirstDocument     
	Do Until doc Is Nothing
		If doc.ClassificacaoDespesa(0) <> "Intermediação de Vendas" Then
			Call rtitem.AppendDocLink(doc, "Link para o Pedido de Compra")
			Call rtitem.AppendText(" " + doc.PO(0))
			Call rtitem.AppendText(" " + doc.Status(0))
		End If
		Set doc = dc.GetNextDocument(doc)
		If Not doc Is Nothing Then
			Call rtitem.Addnewline(1)
		End If
	Loop
	'PO
	Set db = New NotesDatabase(negocio.ParentDatabase.Server, "importacao.nsf")
	Set view = db.GetView("(PO/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	If cont > 0 And dc.Count > 0 Then
		Call rtitem.Addnewline(1)
	End If
	cont = dc.Count
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para o Pedido Internacional" )
		Call rtitem.AppendText(" " & doc.PO(0))
		Call rtitem.AppendText(" " & doc.Sit(0))
		Set doc = dc.GetNextDocument( doc )
		If Not(doc Is Nothing)Then
			Call rtitem.Addnewline(1)
		End If
	Loop
	'PO de Cotação Financeira
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "-", False)
	If cont > 0 And dc.Count > 0 Then
		Call rtitem.Addnewline(1)
	End If
	cont = dc.Count
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para o Pedido Internacional" )
		Call rtitem.AppendText(" " & doc.PO(0))
		Call rtitem.AppendText(" " & doc.Sit(0))
		Set doc = dc.GetNextDocument( doc )
		If Not(doc Is Nothing)Then
			Call rtitem.Addnewline(1)
		End If
	Loop
	'Atracagem
	Set view = db.GetView("(Atracagem/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	If cont > 0 And dc.count > 0 Then
		Call rtitem.Addnewline(1)
	End If
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para a Atracagem" )
		Call rtitem.AppendText(" " & UCase(doc.Atracagem(0)))
		Call rtitem.AppendText(" " & doc.Sit(0))
		Set doc = dc.GetNextDocument( doc )
		If Not(doc Is Nothing)Then
			Call rtitem.Addnewline(1)
		End If
	Loop
	'Atracagem de Cotação Financeira
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "-", False)
	If cont > 0 And dc.count > 0 Then
		Call rtitem.Addnewline(1)
	End If
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para a Atracagem" )
		Call rtitem.AppendText(" " & UCase(doc.Atracagem(0)))
		Call rtitem.AppendText(" " & doc.Sit(0))
		Set doc = dc.GetNextDocument( doc )
		If Not(doc Is Nothing)Then
			Call rtitem.Addnewline(1)
		End If
	Loop
	
End Sub

'++LotusScript Development Environment:2:2:GetHoras:5:8
%REM
	Sub GetHoras
	Description: Comments for Function
%END REM
Sub GetHoras(negocio As NotesDocument, tipo As string)
	
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim data As NotesDateTime
	Dim qtd As Double
	Dim horasMargemPV As Double, horasMargemPOC As Double, horasMargemExec As Double
	Dim horasDescontoPV As Double, horasDescontoPOC As Double, horasDescontoExec As Double
	Dim x As Integer, horasT As Double, indice As Variant
	ReDim Preserve datas(x) As String
	ReDim Preserve horas(x) As Double
	'*** Real ***
	If tipo = "Real" Then
		Set db = New NotesDatabase(negocio.ParentDatabase.Server, "timesheet.nsf")
		Set view = db.Getview("(TimeSheet/Codigo)")
		Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
		Set doc = dc.Getfirstdocument()
		Do Until doc Is Nothing
			If CStr(doc.TotPeriodo(0)) <> "" Then
				qtd = Round(doc.TotPeriodo(0), 1)
			Else
				qtd = Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
			End If
			'Horas de Pré-Venda (Não entram na Margem Real)
			'If doc.Tipo(0) = "PV" Then
			'	horasMargemPV = horasMargemPV + qtd
			'End If
			'Horas de Execução e POC (Entram na Margem Real)
			If doc.Tipo(0) = "P" Or doc.Tipo(0) = "POC" Or doc.Tipo(0) = "Contrato" Then
				If doc.Tipo(0) = "P" Or doc.Tipo(0) = "Contrato" Then
					horasMargemExec = horasMargemExec + qtd
				ElseIf doc.Tipo(0) = "POC" Then
					horasMargemPOC = horasMargemPOC + qtd
				End If
				Set data = New NotesDateTime(doc.Data(0))
				If x = 0 Then
					ReDim Preserve datas(x) As String
					ReDim Preserve horas(x) As Double
					datas(x) = Format(data.DateOnly, "mm/yyyy")
					horas(x) = horas(x) + qtd
					x = x + 1
				Else
					indice = ArrayGetIndex(datas, Format(data.DateOnly, "mm/yyyy"))
					If IsNull(indice) Then
						ReDim Preserve datas(x) As String
						ReDim Preserve horas(x) As Double
						datas(x) = Format(data.DateOnly, "mm/yyyy")
						horas(x) = horas(x) + qtd
						x = x + 1
					Else
						horas(indice) = horas(indice) + qtd
					End If 
				End If
				horasT = horasT + qtd
			End If
			Set doc = dc.Getnextdocument(doc)
		Loop
		'Horas Margem
		negocio.HorasMargem_PV = horasMargemPV
		negocio.HorasMargem_POC = horasMargemPOC
		negocio.HorasMargem_Exec = horasMargemExec
		negocio.HorasMargem = horasMargemPV + horasMargemPOC + horasMargemExec
		'Horas Desconto
		If CStr(negocio.HorasDesconto_PV(0)) <> "" Then horasDescontoPV = negocio.HorasDesconto_PV(0)
		If CStr(negocio.HorasDesconto_POC(0)) <> "" Then horasDescontoPOC = negocio.HorasDesconto_POC(0)
		If CStr(negocio.HorasDesconto_Exec(0)) <> "" Then horasDescontoExec = negocio.HorasDesconto_Exec(0)
		negocio.HorasDesconto_PV = horasDescontoPV
		negocio.HorasDesconto_POC = horasDescontoPOC
		negocio.HorasDesconto_Exec = horasDescontoExec
		negocio.HorasDesconto = horasDescontoPV + horasDescontoPOC + horasDescontoExec
		'Horas Finais
		negocio.HorasFinais_PV = horasMargemPV - horasDescontoPV
		negocio.HorasFinais_POC = horasMargemPOC - horasDescontoPOC
		negocio.HorasFinais_Exec = horasMargemExec - horasDescontoExec
		negocio.HorasFinais = negocio.HorasFinais_PV(0) + negocio.HorasFinais_POC(0) + negocio.HorasFinais_Exec(0)
	'*** Previsto ***
	Else
		If negocio.DataFechamento(0) <> "" Then
			Set data = New NotesDateTime(negocio.DataFechamento(0))
		Else
			Set data = New NotesDateTime(negocio.Criacao(0))
		End If
		Set db = New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
		Set view = db.Getview("(ProjetosCodigo)")
		Set doc = view.Getdocumentbykey(negocio.Codigo(0), True)
		If Not doc Is Nothing Then
			datas(x) = Format(data.DateOnly, "mm/yyyy")
			horas(x) = doc.HHP(0)
			horasT = horasT + doc.HHP(0)
		End If
	End If
	'Print
	negocio.Datas_R = datas
	negocio.Horas_R = horas
	negocio.HorasT_R = horasT
	
End Sub

'++LotusScript Development Environment:2:2:CalcTotaisNegocio:5:8
%REM
	Sub CalcTotaisNegocio
	Description: Comments for Sub
%END REM
Sub CalcTotaisNegocio(doc As NotesDocument)
	
	Dim scan As Integer, totalMateriais As Double, totalMateriaisCompra As Double, totalServicosCompra As Double, totalServicos As Double, custoContrato As Double, terceirosContrato As Double, totalContrato As Double
	Dim compra As Double, venda As Double, us As String, moedaCompra As Double, moedaVenda As Double, qvar As Long, custo As Double, icmsstC As Double, terceiros As Double, mg As Double, despesas As Double, cps As Double
	Dim frete As Double, intermediacao As Double
	Dim custoMateriaisUSC As Double, custoMateriaisR As Double, custoMateriais As Double
	Dim totalUSC As Double, totalR As Double
	Dim compraT As Double, terceirosT As Double, vendaT As Double
	'Lista de Materiais
	For scan = 0 To 49
		qvar = Val(doc.GetItemValue("Q_" & scan)(0))
		If qvar > 0 Then
			us = doc.GetItemValue("Us_" & scan)(0)
			If us = "US$C" Then
				'US$C Compra Fixo - LMO 13/03/20
				If IsNumeric(doc.USCompra(0)) Then
					moedaCompra = doc.USCompra(0)
				Else
					moedaCompra = doc.USC(0)
				End If
				'US$C Venda Fixo - LMO 08/01/18
				If doc.Form(0) = "Negocio" Or doc.Form(0) = "Renovacao" Then
					If IsNumeric(doc.USVenda(0)) Then
						moedaVenda = doc.USVenda(0)
					Else
						moedaVenda = doc.USC(0)
					End If
				Else
					moedaVenda = doc.USC(0)
				End If
				venda = doc.GetItemValue("VendaTot_" & scan)(0)
				totalUSC = totalUSC + venda
			Else
				moedaCompra = 1
				moedaVenda = 1
				venda = doc.GetItemValue("VendaTot_" & scan)(0)
				totalR = totalR + venda
			End If
			If CStr(doc.GetItemValue("Custo_" & scan)(0)) <> "" Then
				If CStr(doc.GetItemValue("ICMSSTC_" & scan)(0)) = "" Then icmsstC = 0 Else icmsstC = doc.GetItemValue("ICMSSTC_" & scan)(0)
				compra = (doc.GetItemValue("Custo_" & scan)(0) + icmsstC) * qvar
				If us = "US$C" Then
					custoMateriaisUSC = custoMateriaisUSC + compra				
				Else
					custoMateriaisR = custoMateriaisR + compra	
				End If
				custoMateriais = custoMateriais + (compra * moedaCompra)
				totalMateriaisCompra = totalMateriaisCompra + (compra * moedaCompra)
			End If
			If CStr(doc.GetItemValue("VendaTot_" & scan)(0)) <> "" Then
				venda = doc.GetItemValue("VendaTot_" & scan)(0)
				totalMateriais = totalMateriais + (venda * moedaVenda)
			End If
		End If
	Next
	'Lista de Serviços
	If doc.TipoVenda(0) <> "Venda Simples" Then
		For scan = 0 To 11
			qvar = Val(doc.GetItemValue("Qs_" & scan)(0))
			If qvar > 0  Then
				us = doc.GetItemValue("Uss_" & scan)(0)
				If us = "US$C" Then
					'US$C Compra Fixo - LMO 13/03/20
					If IsNumeric(doc.USCompra(0)) Then
						moedaCompra = doc.USCompra(0)
					Else
						moedaCompra = doc.USC(0)
					End If
					'US$C Venda Fixo - LMO 08/01/18
					If doc.Form(0) = "Negocio" Or doc.Form(0) = "Renovacao" Then
						If IsNumeric(doc.USVenda(0)) Then
							moedaVenda = doc.USVenda(0)
						Else
							moedaVenda = doc.USC(0)
						End If
					Else
						moedaVenda = doc.USC(0)
					End If
				ElseIf us = "US$T" Then
					moedaCompra = doc.UST(0)
					moedaVenda = doc.UST(0)
				Else
					moedaCompra = 1
					moedaVenda = 1
				End If
				If CStr(doc.GetItemValue("Custos_" & scan)(0)) = "" Then custo = 0 Else custo = doc.GetItemValue("Custos_" & scan)(0)
				If CStr(doc.GetItemValue("Terceiros_" & scan)(0)) = "" Then terceiros = 0 Else terceiros = doc.GetItemValue("Terceiros_" & scan)(0)
				If CStr(doc.GetItemValue("Mgs_" & scan)(0)) = "" Then mg = 0 Else mg = doc.GetItemValue("Mgs_" & scan)(0)
				If CStr(doc.GetItemValue("CustoUnits_" & scan)(0)) = "" Then venda = 0 Else venda = doc.GetItemValue("CustoUnits_" & scan)(0)
				If CStr(doc.GetItemValue("Despesas_" & scan)(0)) = "" Then despesas = 0 Else despesas = doc.GetItemValue("Despesas_" & scan)(0)
				If CStr(doc.GetItemValue("CPS_" & scan)(0)) = "" Then cps = 0 Else cps = doc.GetItemValue("CPS_" & scan)(0)
				Call doc.Replaceitemvalue("CusTots_" & scan, qvar * (venda + (despesas + cps) / moedaVenda))	'despesas e cps em R$
				totalServicos = TotalServicos + doc.GetItemValue("CusTots_" & scan)(0) * moedaVenda
				compra = custo + terceiros
				totalServicosCompra = totalServicosCompra + compra * moedaCompra
			End If
		Next
	End If
	'Despesas de Vendas - LMO 26/12/12
	If CStr(doc.Frete(0)) <> "" Then frete = doc.Frete(0)
	If CStr(doc.Intermediacao(0)) <> "" Then intermediacao = doc.Intermediacao(0)
	doc.Frete = frete
	doc.Intermediacao = intermediacao
	'Matriz de Tarifação
	If doc.TipoVenda(0) = "Contrato" Then
		For scan = 0 To 9
			qvar = Val(doc.GetItemValue("CQs_" & scan)(0))
			If qvar > 0 Then
				If CStr(doc.GetItemValue("CCusto_" & scan)(0)) <> "" Then compra = doc.GetItemValue("CCusto_" & scan)(0) Else compra = 0
				If CStr(doc.GetItemValue("CTerceiros_" & scan)(0)) = "" Then terceiros = 0 Else terceiros = doc.GetItemValue("CTerceiros_" & scan)(0)
				If CStr(doc.GetItemValue("CCusTots_" & scan)(0)) <> "" Then venda = doc.GetItemValue("CCusTots_" & scan)(0) Else venda = 0
				If CStr(doc.GetItemValue("CMg_" & scan)(0)) = "" Then mg = 0 Else mg = CDbl(doc.GetItemValue("CMg_" & scan)(0))
				If (compra > 0 And mg > 0 And venda > 0) Or (mg > 0 And venda > 0) Or (compra > 0 And venda > 0 And mg = 0) Or (venda > 0 And mg = 0) Or (venda > 0 And mg = 0) Then
					mg = (compra + terceiros)/venda
					Call doc.ReplaceItemValue("CMg_" & scan, Format(mg, "Fixed"))
				ElseIf (compra > 0 And mg > 0 And venda = 0) Or (mg > 0 And venda = 0) Then
					venda = (compra + terceiros)/mg
					Call doc.ReplaceItemValue("CCusTots_" & scan, Format(venda, "Standard"))
				ElseIf mg > 0 And venda > 0 And compra = 0 Then
					'O Custo tem que ser definido pela Área Técnica
				End If
				If doc.GetItemValue("CTipo_" & scan)(0) = "Aluguel" Then
					Call doc.Replaceitemvalue("CCustoT_" & scan, compra * qvar)
					Call doc.Replaceitemvalue("CCusTotsT_" & scan, venda * qvar)
				Else
					Call doc.Replaceitemvalue("CCusto_" & scan, compra)
					Call doc.Replaceitemvalue("CTerceiros_" & scan, terceiros)
					Call doc.Replaceitemvalue("CCusTots_" & scan, venda)
					Call doc.Replaceitemvalue("CCustoT_" & scan, compra * qvar)
					Call doc.Replaceitemvalue("CTerceirosT_" & scan, terceiros * qvar)
					Call doc.Replaceitemvalue("CCusTotsT_" & scan, venda * qvar)
				End If
				If CStr(doc.GetItemValue("CCustoT_" & scan)(0)) <> "" Then compraT = doc.GetItemValue("CCustoT_" & scan)(0) Else compraT = 0
				If CStr(doc.GetItemValue("CTerceirosT_" & scan)(0)) <> "" Then terceirosT = doc.GetItemValue("CTerceirosT_" & scan)(0) Else terceirosT = 0
				If CStr(doc.GetItemValue("CCusTotsT_" & scan)(0)) <> "" Then vendaT = doc.GetItemValue("CCusTotsT_" & scan)(0) Else vendaT = 0
				custoContrato = custoContrato + compraT
				terceirosContrato = terceirosContrato + terceirosT
				totalContrato = totalContrato + vendaT
			Else
				Call doc.Replaceitemvalue("CCustoT_" & scan, "")
				Call doc.Replaceitemvalue("CCusTotsT_" & scan, "")
			End If
		Next
	End If
	'Custos dos Materiais - LMO 08/03/16
	doc.CustoMateriaisUSC = Round(custoMateriaisUSC, 2)
	doc.CustoMateriaisR = Round(custoMateriaisR, 2)
	doc.CustoMateriais = Round(custoMateriais, 2)
	'
	doc.TotMateriaisUSC = Round(totalUSC, 2) 'incluído MCastro em 04/02/2015
	doc.TotMateriaisR = Round(totalR, 2) 'incluído MCastro em 04/02/2015
	doc.TotMateriais = Round(totalMateriais, 2)
	doc.TotServicos = Round(totalServicos, 2)
	'Matriz de Tarifação - LMO 10/10/19
	doc.CustoC = Round(custoContrato, 2)
	doc.TerceirosC = Round(terceirosContrato, 2)
	doc.TotContrato = Round(totalContrato, 2)
	doc.Valor = Round(totalContrato, 2)
	'Totais do Negócio
	If doc.TipoVenda(0) = "Contrato" Then totalMateriais = 0	'Compra de Ativo através da Lista de Materiais, o Faturamento será pelo Fixo do Contrato - LMO 31/07/12
	doc.TotalNegocio = Round(totalServicos, 2) + Round(totalMateriais, 2) + Round(totalContrato, 2)
	doc.TotMateriais_1 = Round(totalMateriais, 2)
	doc.TotServicos_1 = Round(totalServicos, 2) + Round(totalContrato, 2)
	'Forecast
	doc.ForecastCompra = Round(totalMateriaisCompra, 2) + Round(totalServicosCompra, 2)
	doc.ForecastVenda = Round(totalMateriais, 2) + Round(totalServicos, 2) + Round(totalContrato, 2)
	
End Sub

'++LotusScript Development Environment:2:1:GetNumeroBanco:5:8
%REM
	Function GetNumeroBanco
	Description: Comments for Function
%END REM
Function GetNumeroBanco(banco As String) As String
	
	If banco = "" Then Exit Function
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "bancos.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Set view = db.Getview("(Banco/Nome)")
	Set doc = view.Getdocumentbykey(banco, True)
	If Not doc Is Nothing Then
		GetNumeroBanco = doc.Codigo(0)
	End If
	
End Function

'++LotusScript Development Environment:2:1:GetCustoHora:5:8
%REM
	Function GetCustoHora
	Description: Comments for Function
%END REM
Function GetCustoHora(area As String) As Double
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "timesheet.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument, docCusto As NotesDocument
	Set view = db.GetView("(CustoHora)")
	'Verifica se Área tem Custo da Hora 
	Set doc = view.Getdocumentbykey(area, True)
	If doc Is Nothing Then Exit Function
	'
	Dim key(1) As String
	key(0) = area
	Dim data As New NotesDateTime(Today)
	Do While docCusto Is Nothing
		Call data.Adjustmonth(-1)
		key(1) = Month(data.DateOnly) & "/" & Year(data.DateOnly)
		Set docCusto = view.Getdocumentbykey(key, True)
	Loop
	GetCustoHora = Round(docCusto.CustoMedioHoraComOverhead(0), 2)
	
End Function


'++LotusScript Development Environment:2:2:ReprovarMargemFator:5:8
%REM
	Sub ReprovarMargemFator
	Description: Comments for Sub
%END REM
Sub ReprovarMargemFator(doc As NotesDocument)
	
	Dim session As New NotesSession
	Dim nome As New NotesName(session.Effectiveusername)
	doc.Sit =  "Forecast"
	doc.SitNumero = 2
	If doc.TipoAprovacao(0) = "Frete Revenda" Then
		doc.Status_FreteRevenda = "Reprovado"
		doc.AprovadoPor_FreteRevenda = nome.Common
		doc.DataAprovacao_FreteRevenda = Now
	ElseIf doc.TipoAprovacao(0) = "Frete Projeto" Then
		doc.Status_FreteProjeto = "Reprovado"
		doc.AprovadoPor_FreteProjeto = nome.Common
		doc.DataAprovacao_FreteProjeto = Now
	ElseIf doc.TipoAprovacao(0) = "Margem Item" Then
		doc.Status_MI = "Reprovado"
		doc.AprovadoPor_MI = nome.Common
		doc.DataAprovacao_MI = Now
	ElseIf doc.TipoAprovacao(0) = "FI" Then
		doc.Status_FI = "Reprovado"
		doc.AprovadoPor_FI = nome.Common
		doc.DataAprovacao_FI = Now
		doc.FIAprovado_HW = doc.FISolicitado_HW(0)
		doc.FIAprovado_SW = doc.FISolicitado_SW(0)
		doc.FIAprovado_SV = doc.FISolicitado_SV(0)
	Else
		doc.StatusMg = "Reprovado"
		doc.AprovadoPor = nome.Common
		doc.DataAprovacao = Now
		doc.MgAprovada = doc.MgSolicitada(0)
	End If
	'Email de Reprovação
	Call AvisoMgPrevista(doc, "Reprovado")
	Call doc.Save(False, False)
	
End Sub

'++LotusScript Development Environment:2:2:LinkNegocios:1:8
Sub LinkNegocios(negocio As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim rtitem As NotesRichTextItem
	Set db = New NotesDatabase(negocio.Parentdatabase.Server, "sales.nsf")
	Set view = db.GetView("(NegociosCodigo)")
	If negocio.HasItem("LinkNegocio") Then negocio.RemoveItem("LinkNegocio")
	If negocio.HasItem("LinkPrincipal") Then negocio.RemoveItem("LinkPrincipal")
	If negocio.HasItem("LinkNovoCodigo") Then negocio.RemoveItem("LinkNovoCodigo")
	'Negócio
	If negocio.Form(0) = "Negocio" Or negocio.Form(0) = "Renovacao" Or negocio.Form(0) = "Prejuizo" Then
		'Adendo
		If negocio.Classe(0) = "Adendo" Then
			Set doc = view.GetDocumentByKey(negocio.NegocioPrincipal(0), True)
			If Not doc Is Nothing Then
				Set rtitem = negocio.CreateRichTextItem("LinkNegocio")
				Call rtitem.AppendDocLink(doc, "Link para o Negócio")
			End If
		End If
		'Cenário/Renovação
		If negocio.TipoNegocio(0) = "Cenário" Or negocio.TipoNegocio(0) = "Renovação" Then
			Set doc = view.GetDocumentByKey(negocio.Principal(0), True)
			If Not doc Is Nothing Then
				Set rtitem = negocio.CreateRichTextItem("LinkPrincipal")
				Call rtitem.AppendDocLink( doc, "Link para o Negócio Principal" )
			End If
		End If
		'Consolidado/Prejuízo
		If negocio.Sit(0) = "Consolidado" Or negocio.Sit(0) = "Aguardando Análise da Perda" Or negocio.Form(0) = "Prejuizo" Then
			Dim scan As Integer
			For scan = 0 To UBound(negocio.NovoCodigo)
				If negocio.NovoCodigo(scan) <> "" Then
					Set doc = view.GetDocumentByKey(negocio.NovoCodigo(scan), True)
					If Not doc Is Nothing Then
						Set rtitem = negocio.CreateRichTextItem("LinkNovoCodigo")
						Call rtitem.AppendDocLink(doc, "Link para o Novo Negócio")
						If negocio.Form(0) = "Prejuizo" Then
							Call rtitem.AppendText(" " & doc.Codigo(0) & " " & doc.Sit(0))
						End If
					End If
				End If
			Next
		End If
		If negocio.Form(0) = "Renovacao" Or negocio.Form(0) = "Prejuizo" Then
			If negocio.HasItem("Link") Then negocio.RemoveItem("Link")
			Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
			If Not doc Is Nothing Then
				Set rtitem = negocio.CreateRichTextItem("Link")
				Call rtitem.AppendDocLink(doc, "Link para o Negócio")
			End If
		End If
	Else
		Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
		If Not doc Is Nothing Then
			Set rtitem = negocio.CreateRichTextItem("LinkNegocio")
			Call rtitem.AppendDocLink(doc, "Link para o Negócio")
		End If
	End If
	
End Sub

'++LotusScript Development Environment:2:1:CalcCustoHoras:1:8
Function CalcCustoHoras(negocio As NotesDocument) As Double
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "timesheet.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim scan As Integer
	Dim indice As Variant
	
	'Total de Horas por Técnico
	Redim dTecnicos(scan) As String
	Redim dTotHoras(scan) As Double
	dTecnicos(scan) = ""
	dTotHoras(scan) = 0
	
	Set view = db.GetView("(TimeSheet/Codigo)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If scan = 0 Then
			Redim dTecnicos(scan) As String
			Redim dTotHoras(scan) As Double
			dTecnicos(scan) = doc.Nome(0)
			dTotHoras(scan) = Cdbl(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + ((Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60))
			scan = scan + 1
		Else
			indice = Arraygetindex(dTecnicos, doc.Nome(0))
			If Isnull(indice) Then
				Redim Preserve dTecnicos(scan) As String
				Redim Preserve dTotHoras(scan) As Double
				dTecnicos(scan) = doc.Nome(0)
				dTotHoras(scan) = Cdbl(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + ((Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60))
				scan = scan + 1
			Else
				dTotHoras(indice) = dTotHoras(indice) + Cdbl(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + ((Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60))
			End If
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	
	'Custo Hora - Pessoal
	If session.IsOnServer Then
		Set db = New NotesDatabase(negocio.ParentDatabase.Server, "pessoal.nsf")
		Set view = db.GetView("(Funcionarios/Geral/UserName)")
		For scan = 0 To Ubound(dTecnicos)
			Set doc = view.GetDocumentByKey(dTecnicos(scan), True)
			If Not doc Is Nothing Then
				calcCustoHoras = dTotHoras(scan) * doc.CustoSalarioBaseHora(0)
			End If
		Next
	Else
		If negocio.IsMember_1(0) = "True" Then
			Set db = New NotesDatabase(negocio.ParentDatabase.Server, "pessoal.nsf")
			Set view = db.GetView("(Funcionarios/Geral/UserName)")
			For scan = 0 To Ubound(dTecnicos)
				Set doc = view.GetDocumentByKey(dTecnicos(scan), True)
				If Not doc Is Nothing Then
					calcCustoHoras = calcCustoHoras + dTotHoras(scan) * doc.CustoSalarioBaseHora(0)
				End If
			Next
		Else
			If Cstr(negocio.CustoHRS(0)) = "" Then
				calcCustoHoras = 0
			Else
				calcCustoHoras = negocio.CustoHRS(0)
			End If
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:AlteraTimeSheets:5:8
%REM
	Sub AlteraTimeSheets
	Description: Comments for Sub
%END REM
Sub AlteraTimeSheets(negocio As NotesDocument)
	
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Set db = New NotesDatabase(negocio.Parentdatabase.Server, "timesheet.nsf")
	Set view = db.GetView("(TimeSheet/Codigo)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		doc.CodigoNegocio = negocio.NovoCodigo(0)
		doc.CodigoNegocioAnterior = negocio.Codigo(0)
		Call doc.Save(True, True)
		Set doc = dc.Getnextdocument(doc)
	Loop
	
End Sub

'++LotusScript Development Environment:2:1:CheckFreteProjeto:5:8
%REM
	Function CheckFreteProjeto
	Description: Comments for Function
%END REM
Function CheckFreteProjeto(docAtu As NotesDocument) As Boolean
	
		If docAtu.TipoVenda(0) = "Chamado" Then Exit Function 'Exceção para Chamado - LMO 30/10/23
		Dim db As NotesDatabase
		Dim view As NotesView
		Dim doc As NotesDocument
		If docAtu.Form(0) = "Negocio" Then
			If docAtu.Status_FreteProjeto(0) = "Aprovado" Then Exit Function
			Set db = New NotesDatabase(docAtu.ParentDatabase.Server, "servicos.nsf")
			Set view = db.GetView("(ContratosProjetosCodigo)")
			Set doc = view.GetDocumentByKey(docAtu.Codigo(0), True)
			If Not doc Is Nothing Then
				If (TemHardware(doc) Or Val(doc.MatP(0)) > 0 Or Val(doc.MatP_1(0)) > 0 Or Val(doc.MatP_2(0)) > 0 Or Val(doc.AtivoP(0)) > 0 Or Val(doc.AtivoP_1(0)) > 0) And Val(doc.FreteMP(0)) <= 0 Then
					CheckFreteProjeto = True
				End If
			End If
		ElseIf docAtu.Form(0) = "Projeto" Then
			If (Not TemHardware(docAtu) And Val(docAtu.MatP(0)) = 0 And Val(docAtu.MatP_1(0)) = 0 And Val(docAtu.MatP_2(0)) = 0 And Val(docAtu.AtivoP(0)) = 0 And Val(docAtu.AtivoP_1(0)) = 0) Or Val(docAtu.FreteMP(0)) > 0 Then Exit Function
			Set db = New NotesDatabase(docAtu.ParentDatabase.Server, "sales.nsf")
			Set view = db.GetView("(NegociosCodigo)")
			Set doc = view.GetDocumentByKey(docAtu.Codigo(0), True)
			If Not doc Is Nothing Then
				If doc.Status_FreteProjeto(0) = "Aprovado" Then Exit Function
				Dim answer As Integer
				answer = MessageBox("Frete de Projeto Zero." & Chr(10) & "Deseja solicitar aprovação da Diretoria?", 4+32+256+4096, "Finalizar Pré-Venda")
				If answer = 6 Then
					Call SolicitaAprovacaoMargemFatorInferior(doc, "Frete Projeto")
				Else
					CheckFreteProjeto = True
				End If
			End If
		End If
		
End Function

'++LotusScript Development Environment:2:2:LinkPrejuizo:5:8
%REM
	Sub LinkPrejuizo
	Description: Comments for Sub
%END REM
Sub LinkPrejuizo(negocio As NotesDocument)
	
	On Error Resume Next
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim rtItem As NotesRichTextItem
	If negocio.HasItem("LinkPrejuizo") Then negocio.RemoveItem("LinkPrejuizo")
	Set db = negocio.Parentdatabase
	Set view = db.Getview("(Prejuizos/Codigo)")
	Set doc = view.Getdocumentbykey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		negocio.ValorPrejuizo = doc.TotalNegocio(0)
		negocio.StatusPrejuizo = doc.Sit(0)
		Set rtItem = negocio.CreateRichTextItem("LinkPrejuizo")
		Call rtItem.AppendDocLink(doc,"Link para o Prejuízo")
	Else
		negocio.ValorPrejuizo = ""
		negocio.StatusPrejuizo = ""
	End If
	
End Sub



'++LotusScript Development Environment:2:1:Fechado:1:8
Function Fechado(status As String) As Boolean
	
	If status = "Fechado" Or InStr(status, "Faturar") > 0 Or InStr(status, "Execução") > 0 Or status = "Contrato" Or status = "Receber" Or InStr(status, "Aguardando Conclusão") > 0 Or InStr(status, "Aguardando Baixa") > 0 Or status = "Concluído" Or status = "Aprovado" Or status = "Parcial" Then Fechado = True
	
End Function

'++LotusScript Development Environment:2:1:GetMoedas:1:8
Function GetMoedas As Variant
	
    'Conversão de Moedas
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim array(1) As Double
	Set view = db.GetView("3. Moedas")
	Set doc = view.GetDocumentByKey(Format(Today, "dd/mm/yyyy"), True)
	If doc Is Nothing Then
		array(0) = 1
		array(1) = 1
	Else
		array(0) = doc.USC(0)
		array(1) = doc.UST(0)
	End If
	GetMoedas = array
	
End Function

'++LotusScript Development Environment:2:1:AvisoFaturamento:5:8
%REM
	Sub AvisoFaturamento
	Description: Comments for Sub
%END REM
Function AvisoFaturamento(aceite As NotesDocument) As Boolean
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(aceite.Parentdatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument, memo As NotesDocument
	Dim x As Integer
	Dim key(1) As String
	key(0) = aceite.Codigo(0)
	key(1) = aceite.NFiscal(0)
	Set view = db.Getview("(EspelhosNegocioAceitePendente)")
	Set doc = view.GetDocumentbykey(key, True)
	If Not doc Is Nothing Then
		ReDim Preserve recipients(UBound(doc.Inside) + 1) As String
		For x = 0 To UBound(doc.Inside)
			recipients(x) = doc.Inside(x)
		Next
		recipients(x) = doc.GerenteConta(0)
		Dim rtitem As NotesRichTextItem
		Dim anexos As NotesRichTextItem
		Dim richStyle As NotesRichTextStyle
		Set memo = db.CreateDocument
		memo.Form = "Memo"
		memo.ReplyTo = doc.Inside(0)
		If aceite.EnviarEmail(0) = "Enviar" Then
			memo.SendTo = doc.EmailComprador(0)
		End If
		memo.CopyTo = recipients
		'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
		Set rtitem = memo.CreateRichTextItem("Body")
		Set anexos = doc.Getfirstitem("NFe")
		Set richStyle = session.CreateRichTextStyle
		richStyle.NotesFont = rtitem.GetNotesFont("Arial", True)
		richStyle.FontSize = 12
		Call rtitem.AppendStyle(richStyle)
		memo.Subject = "(Automático) Faturamento (" & doc.Codigo(0) & ") documento nº " & doc.NFiscal(0) & ", vencimento em " & Format(doc.Vencimento(0), "dd/mm/yyyy")
		If Hour(Now) <= 12 Then
			Call rtitem.Appendtext( "Bom dia," )
		Else
			Call rtitem.Appendtext( "Boa tarde," )
		End If
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Segue em anexo, para ciência e programação de pagamento, cobrança referente a Nota Fiscal nº ")
		richStyle.Bold = True
		richStyle.Notescolor = COLOR_RED
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( doc.NFiscal(0) )
		richStyle.Bold = False
		richStyle.Notescolor = COLOR_BLACK
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( "." )
		'Parcela 1
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Vencimento: ")
		richStyle.Bold = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( Format(doc.Vencimento(0), "dd/mm/yyyy") )
		richStyle.Bold = False
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Valor: ")
		richStyle.Bold = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( "R$" & Format(doc.Valor(0), "standard") )
		'Parcela 2
		If doc.Vencimento2(0) <> "" Then
			richStyle.Bold = False
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.AddNewLine( 2 )
			Call rtitem.Appendtext( "Vencimento: ")
			richStyle.Bold = True
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.Appendtext( Format(doc.Vencimento2(0), "dd/mm/yyyy") )
			richStyle.Bold = False
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.AddNewLine( 1 )
			Call rtitem.Appendtext( "Valor: ")
			richStyle.Bold = True
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.Appendtext( "R$" & Format(doc.Valor2(0), "standard") )
		End If
		'Parcela 3
		If doc.Vencimento3(0) <> "" Then
			richStyle.Bold = False
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.AddNewLine( 2 )
			Call rtitem.Appendtext( "Vencimento: ")
			richStyle.Bold = True
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.Appendtext( Format(doc.Vencimento3(0), "dd/mm/yyyy") )
			richStyle.Bold = False
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.AddNewLine( 1 )
			Call rtitem.Appendtext( "Valor: ")
			richStyle.Bold = True
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.Appendtext( "R$" & Format(doc.Valor3(0), "standard") )
		End If
		'Parcela 4
		If doc.Vencimento4(0) <> "" Then
			richStyle.Bold = False
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.AddNewLine( 2 )
			Call rtitem.Appendtext( "Vencimento: ")
			richStyle.Bold = True
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.Appendtext( Format(doc.Vencimento4(0), "dd/mm/yyyy") )
			richStyle.Bold = False
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.AddNewLine( 1 )
			Call rtitem.Appendtext( "Valor: ")
			richStyle.Bold = True
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.Appendtext( "R$" & Format(doc.Valor4(0), "standard") )
		End If
		richStyle.Bold = False
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Havendo necessidade de esclarecimentos complementares, favor entrar em contato.")
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Se estiver de acordo responder esse email confirmando o faturamento.")
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( doc.Inside(0) & "," )
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "TDec Network Group" )
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Fone: " & doc.TelefoneInside(0) & " " & doc.CelularInside(0) )
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendrtitem(anexos)
		Call memo.Send( True )
		doc.StatusAceiteFaturamento = "Ligação Pendente"
		doc.DataContato = Today
		doc.HorarioContato = Now
		doc.ResponsavelContato = session.Commonusername
		doc.ObservacaoContato = "Aviso de Faturamento enviado."
		MsgBox "Email de Aviso de Faturamento enviado.", 64, "Aviso"
		AvisoFaturamento = True
	End If
	
End Function

'++LotusScript Development Environment:2:2:DolarMedio:5:8
%REM
	Sub DolarMedio
	Description: Comments for Sub
%END REM
Sub DolarMedio(docAtu As NotesDocument)
	
	On Error Resume Next
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim cotacao As Double, media As Double
	Dim cont As Integer
	'Compras Nacionais: Baixas
	Set db = New NotesDatabase(docAtu.Parentdatabase.Server, "compras.nsf")
	Set view = db.Getview("(BaixasNegocio)")
	Set dc = view.Getalldocumentsbykey(docAtu.Codigo(0), True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If doc.Form(0) = "Baixa" Then
			If doc.TipoBaixa(0) = "Compra" Or doc.TipoBaixa(0) = "Simples Faturamento" Then
				'Verifica se tem item em dólar
				If CkItemEmDolar(doc) Then
					If doc.USC(0) > 0 Then
						cotacao = cotacao + doc.USC(0)
						cont = cont + 1
					End If
				End If
			End If
		End If
		Set doc = dc.Getnextdocument(doc)
	Loop
	'Compras Internacionais: Baixas de SW/SV (PIS/COFINS)
	Set db = New NotesDatabase(docAtu.ParentDatabase.Server, "importacao.nsf")
	Set view = db.GetView("(Baixa/Negocio)")
	Set dc = view.GetAllDocumentsByKey(docAtu.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.TipoBaixa(0) = "Compra" Then
			If doc.Natureza(0) = "Licenciamento de Uso" Or doc.Natureza(0) = "Prestação de Serviços" Then
				If doc.USC(0) > 0 Then
					cotacao = cotacao + doc.USC(0)
					cont = cont + 1
				End If
			End If
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	'Compras Internacionais: Remessas de Importação
	Set db = New NotesDatabase(docAtu.Parentdatabase.Server, "importacao.nsf")
	Set view = db.Getview("(Remessa/Negocio)")
	Set dc = view.Getalldocumentsbykey(docAtu.Codigo(0), True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If doc.Sit(0) <> "Cancelada" Then
			If CStr(doc.CotacaoFechamento(0)) <> "" Then
				cotacao = cotacao + doc.CotacaoFechamento(0)
				cont = cont + 1
			ElseIf CStr(doc.Cotacao(0)) <> "" Then
				cotacao = cotacao + doc.Cotacao(0)
				cont = cont + 1
			End If
		End If
		Set doc = dc.Getnextdocument(doc)
	Loop
	'Compras Internacionais: Danfes de Entrada (Atracagens)
	Set db = New NotesDatabase(docAtu.Parentdatabase.Server, "faturas.nsf")
	Set view = db.Getview("(Espelhos/Importacao/Negocio)")
	Set dc = view.Getalldocumentsbykey(docAtu.Codigo(0), True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If doc.Sit(0) <> "Cancelada" Then
			If doc.USC(0) > 0 Then
				cotacao = cotacao + doc.USC(0)
				cont = cont + 1
			End If
		End If
		Set doc = dc.Getnextdocument(doc)
	Loop
	'*** Dólar Médio de Compra ***
	If cont > 0 Then media = cotacao/cont Else media = 0
	docAtu.USMedioCompra = media
	
	'Dólar de Venda (Faturas)
	cotacao = 0
	cont = 0
	Set db = New NotesDatabase(docAtu.Parentdatabase.Server, "faturas.nsf")
	Set view = db.Getview("(EspelhosNegocio)")
	Set dc = view.Getalldocumentsbykey(docAtu.Codigo(0), True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If doc.Form(0) = "Espelho" Or doc.Form(0) = "Recibo" Then
			If doc.Sit(0) <> "Cancelada" Then
				If doc.Natureza(0) = "Licenciamento de Uso" Or doc.Natureza(0) = "Prestação de Serviços" Or InStr(doc.Natureza(0), "Venda") > 0 Or InStr(doc.Natureza(0), "Revenda") > 0 Or doc.Natureza(0) = "Simples Faturamento" Then
					'Hardware ou Revenda de SW/SV (M = Lista de Materiais)
					If doc.Tipo(0) = "Hardware" Or (doc.Tipo(0) <> "Hardware" And doc.Getitemvalue("TipoServ_0")(0) = "M") Then
						'Verifica se tem item em dólar
						If CkItemEmDolar(doc) Then
							If doc.USC(0) > 0 Then
								cotacao = cotacao + doc.USC(0)
								cont = cont + 1
							End If
						End If
					End If
				End If
			End If
		End If
		Set doc = dc.Getnextdocument(doc)
	Loop
	'*** Dólar Médio de Venda ***
	If cont > 0 Then media = cotacao/cont Else media = 0
	docAtu.USMedioVenda = media
	
	'*** Diferença entre o Dólar de Compra e de Venda ***
	docAtu.USMedioDiferenca = docAtu.USMedioCompra(0) - docAtu.USMedioVenda(0)
	
End Sub

'++LotusScript Development Environment:2:2:AtualizaCheckPointProjeto:5:8
%REM
	Sub AtualizaCheckPointProjeto
	Description: Comments for Sub
%END REM
Sub AtualizaCheckPointProjeto(negocio As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim projeto As NotesDocument
	Set view = db.GetView("(ProjetosCodigo)")
	Set projeto = view.Getdocumentbykey(negocio.Codigo(0), True)
	If Not projeto Is Nothing Then
		'Pré-Venda
		projeto.DataCheckPointPV = negocio.DataCheckPointPV
		projeto.ResponsavelInterrupcaoPV = negocio.ResponsavelInterrupcaoPV
		projeto.DataInterrupcaoPV = negocio.DataInterrupcaoPV
		projeto.MotivoInterrupcaoPV = negocio.MotivoInterrupcaoPV
		'Execução
		projeto.DataCheckPoint = negocio.DataCheckPoint
		projeto.ResponsavelInterrupcao = negocio.ResponsavelInterrupcao
		projeto.DataInterrupcao = negocio.DataInterrupcao
		projeto.MotivoInterrupcao = negocio.MotivoInterrupcao
		Call projeto.Save(False, False)
	End If
	
End Sub


'++LotusScript Development Environment:2:1:BuscaProtocolo:5:8
%REM
	Sub BuscaProtocolo
	Description: Comments for Sub
%END REM
Function BuscaProtocolo(estado As String, cf As String, contribuinte As Variant, tipo As String) As Variant
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	ReDim Preserve array(5) As Variant
	Dim key(3) As String
	Set view = db.Getview("(Protocolo)")
	key(0) = estado
	key(1) = cf
	key(2) = contribuinte
	key(3) = tipo
	Set doc = view.Getdocumentbykey(key, True)
	'Não consultou Protocolo
	If doc Is Nothing Then
		array(0) = False
	'Consultou Protocolo
	Else
		'*** Venda ***
		If tipo = "Venda" Then
			'Sem Protocolo
			If doc.Protocolo(0) = "0" Then
				'Verifica a Data da Última Consulta de Protocolo
				If Month(doc.DataPesquisa(0)) & Year(doc.DataPesquisa(0)) = Month(Today) & Year(Today) Then
					array(0) = 0
				'Protocolo Desatualizado
				Else
					array(0) = False
				End If
			'Com Protocolo
			Else
				'Verifica a Data da Última Consulta de Protocolo
				If Month(doc.DataPesquisa(0)) & Year(doc.DataPesquisa(0)) = Month(Today) & Year(Today) Then
					array(0) = 1					'Com Protocolo
					array(1) = doc.ICMS(0)			'Alíquota Interna do Estado Destino
					array(2) = doc.FCP(0)			'Fundo de Combate a Pobreza
					array(3) = doc.IVAAjustado(0)	'IVA Ajustado 4%
					array(4) = doc.IVAAjustado_1(0)	'IVA Ajustado 7% ou 12%
					array(5) = doc.Aliquota(0)		'Alíquota do ICMS
				'Protocolo Desatualizado
				Else
					array(0) = False
				End If
			End If
		'*** Compra ***
		ElseIf tipo = "Compra" Then
			'Sem Protocolo
			If doc.Protocolo(0) = "0" Then
				'Verifica a Data da Última Consulta de Protocolo
				If Month(doc.DataPesquisa(0)) & Year(doc.DataPesquisa(0)) = Month(Today) & Year(Today) Then
					array(0) = 0
				'Protocolo Desatualizado
				Else
					array(0) = False
				End If
			'Com Protocolo
			Else
				'Verifica a Data da Última Consulta de Protocolo
				If Month(doc.DataPesquisa(0)) & Year(doc.DataPesquisa(0)) = Month(Today) & Year(Today) Then
					array(0) = 1					'Com Protocolo
					array(1) = doc.IVAOriginal(0)	'IVA Original
					array(2) = doc.IVAAjustado(0)	'IVA Ajustado 4%
					array(3) = doc.IVAAjustado_1(0)	'IVA Ajustado 7% ou 12%
					array(4) = doc.Aliquota(0)		'Alíquota do ICMS
				'Protocolo Desatualizado
				Else
					array(0) = False
				End If
			End If
		End If
	End If
	BuscaProtocolo = array
	
End Function

'++LotusScript Development Environment:2:2:ConcluirNegociosBatch:5:8
%REM
	Sub ConcluirNegociosBatch
	Description: Comments for Sub
%END REM
Sub ConcluirNegociosBatch(doc As NotesDocument)
	
	'1) Calcula Planilha Financeira
	Call ProjetoContrato(doc, "Atualiza")
	'2) Calcula a Margem Real
	Call MgReal(doc)
	'3) Salva Margem Real no Negócio
	Call doc.Save (False, False)
	'4) Gera Despesas de Capital de Giro
	Call GeraDespesaCapitalGiro(doc)
	'5) Gera Despesas de Encargos Sociais sobre a Comissão
	Call GeraDespesasEncargosSociais(doc)
	'6) Conclui Serviços Internos
	Call AtualizaServicosInternos(doc, "Conclusão")
	'7) Popula a Margem da Participação Técnica
	Call PopulaMargem(doc)
	'8) Recalcula a Margem Real
	Call MgReal(doc)
	'9) Participação Técnica
	Call Participacoes (doc)
	'10) Conclusão do Negócio
	Call ConclusaoNegocio(doc)
	'11) Gera Despesas de Ajuste de Comissão
	Call AjusteComissao(doc)
	'12) Gera Despesas de Participação Técnica
	Call GeraDespesasParticipacao(doc)
	'13) Salva Negócio
	Call doc.Save (False, False)
	
End Sub

'++LotusScript Development Environment:2:2:RefreshListaMateriais:5:8
%REM
	Sub RefreshListaMateriais
	Description: Mantém a Ordem dos Itens
%END REM
Sub RefreshListaMateriais(doc As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(doc.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim item As NotesDocument
	Dim scan As Integer
	Dim key(1) As String
	Set view = db.GetView("(NegocioForm)")
	If doc.Form(0) = "Projeto" Then
		key(0) = doc.Codigo(0) & "Planilha"
	Else
		key(0) = doc.Codigo(0) & "Item"
	End If
	For scan = 0 To 49
		key(1) = CStr(scan + 1)
		Set item = view.GetDocumentByKey(key, True)
		If Not item Is Nothing Then
			Call doc.ReplaceItemValue("Q_" & scan, Val(item.Q(0)))
			Call doc.ReplaceItemValue("PartNo_" & scan, item.PartNo(0))
			Call doc.ReplaceItemValue("Produto_" & scan, item.Produto(0))
			Call doc.ReplaceItemValue("T_" & scan, item.T(0))
			Call doc.ReplaceItemValue("Un_" & scan, item.Un(0))
			Call doc.ReplaceItemValue("CF_" & scan, item.CF(0))
			Call doc.ReplaceItemValue("ST_" & scan, item.ST(0))
			Call doc.ReplaceItemValue("Fabricante_" & scan, item.Fabricante(0))
			Call doc.ReplaceItemValue("UFCompra_" & scan, item.UFCompra(0))
			Call doc.ReplaceItemValue("Us_" & scan, item.Us(0))
			If item.CustoFOB(0) = 0 Then Call doc.ReplaceItemValue("CustoFOB_" & scan, "") Else Call doc.ReplaceItemValue("CustoFOB_" & scan, item.CustoFOB(0))
			If item.FI(0) = 0 Then Call doc.ReplaceItemValue("FI_" & scan, "") Else Call doc.ReplaceItemValue("FI_" & scan, item.FI(0))
			If item.Custo(0) = 0 Then Call doc.ReplaceItemValue("Custo_" & scan, "") Else Call doc.ReplaceItemValue("Custo_" & scan, item.Custo(0))
			If item.ICMSSTC(0) = 0 Then Call doc.ReplaceItemValue("ICMSSTC_" & scan, "") Else Call doc.ReplaceItemValue("ICMSSTC_" & scan, item.ICMSSTC(0))
			If item.Mg(0) = 0 Then Call doc.ReplaceItemValue("Mg_" & scan, "") Else Call doc.ReplaceItemValue("Mg_" & scan, item.Mg(0))
			If item.CustoUnit(0) = 0 Then Call doc.ReplaceItemValue("CustoUnit_" & scan, "") Else Call doc.ReplaceItemValue("CustoUnit_" & scan, item.CustoUnit(0))
			If CStr(item.CusTot(0)) = "" Then Call doc.ReplaceItemValue("CusTot_" & scan, "") Else Call doc.ReplaceItemValue("CusTot_" & scan, item.CusTot(0))
			If CStr(item.ICMSST(0)) = "" Then Call doc.ReplaceItemValue("ICMSST_" & scan, "") Else Call doc.ReplaceItemValue("ICMSST_" & scan, item.ICMSST(0))
			If CStr(item.BCICMSST(0)) = "" Then Call doc.ReplaceItemValue("BCICMSST_" & scan, "") Else Call doc.ReplaceItemValue("BCICMSST_" & scan, item.BCICMSST(0))
			If CStr(item.ICC(0)) = "" Then Call doc.ReplaceItemValue("ICC_" & scan, 0) Else Call doc.ReplaceItemValue("ICC_" & scan, item.ICC(0))
			If CStr(item.IC(0)) = "" Then Call doc.ReplaceItemValue("IC_" & scan, 0) Else Call doc.ReplaceItemValue("IC_" & scan, item.IC(0))
			If CStr(item.ICD(0)) = "" Then Call doc.ReplaceItemValue("ICD_" & scan, 0) Else Call doc.ReplaceItemValue("ICD_" & scan, item.ICD(0))
			If CStr(item.FCP(0)) = "" Then Call doc.ReplaceItemValue("FCP_" & scan, 0) Else Call doc.ReplaceItemValue("FCP_" & scan, item.FCP(0))
			If CStr(item.IPIC(0)) = "" Then Call doc.ReplaceItemValue("IPC_" & scan, 0) Else Call doc.ReplaceItemValue("IPC_" & scan, item.IPIC(0))
			If CStr(item.IPI(0)) = "" Then Call doc.ReplaceItemValue("IP_" & scan, 0) Else Call doc.ReplaceItemValue("IP_" & scan, item.IPI(0))
			If CStr(item.II(0)) = "" Then Call doc.ReplaceItemValue("II_" & scan, 0) Else Call doc.ReplaceItemValue("II_" & scan, item.II(0))
			If CStr(item.ISS(0)) = "" Then Call doc.ReplaceItemValue("IS_" & scan, 0) Else Call doc.ReplaceItemValue("IS_" & scan, item.ISS(0))
			If CStr(item.AliquotaPIS(0)) = "" Then Call doc.ReplaceItemValue("AliquotaPIS_" & scan, 0) Else Call doc.ReplaceItemValue("AliquotaPIS_" & scan, item.AliquotaPIS(0))
			If CStr(item.AliquotaCOFINS(0)) = "" Then Call doc.ReplaceItemValue("AliquotaCOFINS_" & scan, 0) Else Call doc.ReplaceItemValue("AliquotaCOFINS_" & scan, item.AliquotaCOFINS(0))
			If doc.TipoVenda(0) = "Contrato" Then
				Call doc.ReplaceItemValue("QFat_" & scan, item.Q(0) - item.QCompra(0))
			Else
				Call doc.ReplaceItemValue("QFat_" & scan, item.Q(0) - item.QFat(0))
			End If	
		Else
			Call doc.ReplaceItemValue("Q_" & scan, "")
			Call doc.ReplaceItemValue("PartNo_" & scan, "")
			Call doc.ReplaceItemValue("Produto_" & scan, "")
			Call doc.ReplaceItemValue("T_" & scan, "")
			Call doc.ReplaceItemValue("Un_" & scan, "")
			Call doc.ReplaceItemValue("CF_" & scan, "")
			Call doc.ReplaceItemValue("ST_" & scan, "")
			Call doc.ReplaceItemValue("Fabricante_" & scan, "")
			Call doc.ReplaceItemValue("UFCompra_" & scan, "")
			Call doc.ReplaceItemValue("Us_" & scan, "R$")
			Call doc.ReplaceItemValue("CustoFOB_" & scan, "")
			Call doc.ReplaceItemValue("FI_" & scan, "")
			Call doc.ReplaceItemValue("Custo_" & scan, "")
			Call doc.ReplaceItemValue("ICMSSTC_" & scan, "")
			Call doc.ReplaceItemValue("Mg_" & scan, "")
			Call doc.ReplaceItemValue("CustoUnit_" & scan, "")
			Call doc.ReplaceItemValue("CusTot_" & scan, "")
			Call doc.ReplaceItemValue("ICMSST_" & scan, "")
			Call doc.ReplaceItemValue("BCICMSST_" & scan, "")
			Call doc.ReplaceItemValue("ICC_" & scan, "")
			Call doc.ReplaceItemValue("IC_" & scan, "")
			Call doc.ReplaceItemValue("ICD_" & scan, "")
			Call doc.ReplaceItemValue("FCP_" & scan, "")
			Call doc.ReplaceItemValue("IPC_" & scan, "")
			Call doc.ReplaceItemValue("IP_" & scan, "")
			Call doc.ReplaceItemValue("II_" & scan, "")
			Call doc.ReplaceItemValue("IS_" & scan, "")
			Call doc.ReplaceItemValue("AliquotaPIS_" & scan, "")
			Call doc.ReplaceItemValue("AliquotaCOFINS_" & scan, "")
			Call doc.ReplaceItemValue("QFat_" & scan, "")
		End If
	Next
	
End Sub

'++LotusScript Development Environment:2:2:AlteraDespesas:5:8
%REM
	Sub AlteraDespesas
	Description: Comments for Sub
%END REM
Sub AlteraDespesas(negocio As NotesDocument)
	
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim array As Variant
	Set db = New NotesDatabase(negocio.Parentdatabase.Server, "caixa.nsf")
	Set view = db.GetView("(DespesasNegocio)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If negocio.Sit(0) = "Perdido" Then
			array = GetClassificacao(doc.ClassificacaoDespesa(0))
			doc.ClassificacaoDespesa = array(0)
			doc.TipoCusto = array(1)
			'Salva a Classificacao e o TipoCusto Anterior para utilizar caso o Negócio seja Desperdido 
			doc.ClassificacaoAnterior = doc.ClassificacaoDespesa(0)
			doc.TipoCustoAnterior = doc.TipoCusto(0)
			Call doc.Save(True, True)
		ElseIf negocio.Sit(0) = "Consolidado" Then
			doc.CodigoNegocio = negocio.NovoCodigo(0)
			doc.CodigoAnterior = negocio.Codigo(0)
			Call doc.Save(True, True)
		End If
		Set doc = dc.Getnextdocument(doc)
	Loop
	
End Sub

'++LotusScript Development Environment:2:2:AvisoSolicita:5:8
%REM
	Sub AvisoSolicita
	Description: Comments for Sub
%END REM
Sub AvisoSolicita(projeto As NotesDocument, fase As String)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	Dim recipients(1) As String
	Dim memo As New NotesDocument( session.CurrentDatabase )
	memo.Form = "Memo"
	memo.CopyTo = "projetos@tdec.com.br"
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	Dim corpo As New NotesRichTextItem( memo , "Body" )
	Call corpo.AppendStyle(richStyle)
	If fase = "PV" Then
		memo.SendTo = projeto.ResponsavelSolicitacaoPV(0) & "/TDec"
		memo.Subject = "-> Solicitação de Pré-Venda de " & projeto.Area(0) & ": " & projeto.Codigo(0)
		Call corpo.Appendtext(projeto.ResponsavelSolicitacaoPV(0) & "," )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext("Favor Planejar a Pré-Venda de " & projeto.TipoVenda(0) & " de " & projeto.Area(0) & " " & projeto.Codigo(0))
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( projeto.Descricao(0) & " -> " )
		Call corpo.AppendDocLink( projeto, "Link para o " & projeto.TipoVenda(0) )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( "Prazo para Planejamento: " & projeto.DataLimitePV(0))
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Valor Estimado: R$ " & Format(projeto.ValorEstimado(0), "Standard") )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Probabilidade de Fechamento: " & Format(projeto.ProbFechamento(0), "Percent") )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Parceria: " & projeto.Parceria(0) )
		If projeto.Obs(0) <> "" Then
			Call corpo.AddNewLine( 2 )
			Call corpo.Appendtext( "Observações: " &  projeto.Obs(0) )
		End If
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( session.CommonUserName & "," )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "TDec Network Group" )
		Call memo.Send(False)
		MsgBox "Email encaminhado para " & projeto.ResponsavelSolicitacaoPV(0) & " e Projetos. Negocio " & projeto.Codigo(0), 64, "Solicitação de Pré-Venda"
	ElseIf fase = "POC" Then
		memo.SendTo = projeto.ResponsavelSolicitacaoPOC(0) & "/TDec"
		memo.Subject = "-> Solicitação de POC de " & projeto.Area(0) & ": " & projeto.Codigo(0)
		Call corpo.Appendtext(projeto.ResponsavelSolicitacaoPOC(0) & "," )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext("Favor Planejar o POC de " & projeto.TipoVenda(0) & " de " & projeto.Area(0) & " " & projeto.Codigo(0))
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( projeto.Descricao(0) & " -> " )
		Call corpo.AppendDocLink( projeto, "Link para o " & projeto.TipoVenda(0) )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( "Prazo para Planejamento: " & projeto.DataLimitePOC(0))
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Valor Estimado: R$ " & Format(projeto.ValorEstimado(0), "Standard") )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Probabilidade de Fechamento: " & Format(projeto.ProbFechamento(0), "Percent") )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Parceria: " & projeto.Parceria(0) )
		If projeto.ObsPOC(0) <> "" Then
			Call corpo.AddNewLine( 1 )
			Call corpo.Appendtext( "Observações:" & projeto.ObsPOC(0) )
		End If
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( session.CommonUserName & "," )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "TDec Network Group" )
		Call memo.Send(False)
		MsgBox "Email encaminhado para " & projeto.ResponsavelSolicitacaoPOC(0) & " Projetos e Pré-Venda. Negocio " & projeto.Codigo(0), 64, "Solicitação de POC"
	ElseIf fase = "Kickoff" Then
		memo.SendTo = projeto.ResponsavelKickoff(0) & "/TDec"
		'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
		memo.Subject = "-> Solicitação de Kickoff de " & projeto.Area(0) & ": " & projeto.Codigo(0)
		Call corpo.Appendtext(projeto.ResponsavelKickoff(0) & "," )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( "Favor efetuar o Kickoff de " & projeto.TipoVenda(0) & " de " & projeto.Area(0) & " " & projeto.Codigo(0))
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( projeto.Descricao(0) & " -> " )
		Call corpo.AppendDocLink( projeto, "Link para o " & projeto.TipoVenda(0) )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( "Valor Total: R$ " & Format(projeto.TotalNegocio(0), "Standard") )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Parceria: " & projeto.Parceria(0) )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( session.CommonUserName & "," )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "TDec Network Group" )
		Call memo.Send(False)
		MsgBox "Email encaminhado para " & projeto.ResponsavelKickoff(0) & " e Projetos. Negocio " & projeto.Codigo(0), 64, "Solicitação de Kickoff"
	ElseIf fase = "Exec" Then
		memo.SendTo = projeto.ResponsavelSolicitacao(0) & "/TDec"
		memo.Subject = "-> Solicitação de Planejamento da Execução de " & projeto.Area(0) & ": " & projeto.Codigo(0)
		Call corpo.Appendtext(projeto.ResponsavelSolicitacao(0) & "," )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext("Favor Planejar a Execução de " & projeto.TipoVenda(0) & " de " & projeto.Area(0) & " " & projeto.Codigo(0))
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( projeto.Descricao(0) & " -> " )
		Call corpo.AppendDocLink( projeto, "Link para o " & projeto.TipoVenda(0) )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( "Prazo para Planejamento: " & projeto.DataLimite(0))
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Valor Total: R$ " & Format(projeto.TotalNegocio(0), "Standard") )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Parceria: " & projeto.Parceria(0) )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( session.CommonUserName & "," )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "TDec Network Group" )
		Call memo.Send(False)
		MsgBox "Email encaminhado para " & projeto.ResponsavelSolicitacao(0) & " e Projetos. Negocio " & projeto.Codigo(0), 64, "Solicitação de Execução"
	End If
	
End Sub

'++LotusScript Development Environment:2:1:CkBaixa:5:8
%REM
	Function CkBaixa
	Description: Comments for Function
%END REM
Function CkBaixa(negocio As NotesDocument) As Boolean
	
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim qtd As Long, qtdBaixa As Long
	Set view = db.GetView("(NegocioForm)")
	'Lista de Materiais
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "Item", True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		qtd = qtd + doc.Q(0)
		qtdBaixa = qtdBaixa + doc.QBaixa(0)
		Set doc = dc.Getnextdocument(doc)
	Loop
	'Lista CPS, Compras de Cotação Financeira e Intermediação de Vendas
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "-", False)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		'qtd = qtd + doc.Q(0)
		qtd = qtd + doc.QCompra(0)
		qtdBaixa = qtdBaixa + doc.QBaixa(0)
		Set doc = dc.Getnextdocument(doc)
	Loop
	'Intermediação de Vendas
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "Intermediacao", True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		qtd = qtd + doc.Q(0)
		qtdBaixa = qtdBaixa + doc.QBaixa(0)
		Set doc = dc.Getnextdocument(doc)
	Loop
	If qtd = qtdBaixa Then
		CkBaixa = True
	End If
		
End Function

'++LotusScript Development Environment:2:1:CheckMgItens:5:8
%REM
	Function CheckMgItens
	Description: Verifica se tem itens com Mg Inferior a 15% (Não cobre os Impostos) - LMO 13/12/22
%END REM
Function CheckMgItens(doc As NotesDocument) As Boolean
	
	Dim scan As Integer, scan2 As Integer, item As String, mgMinima As Double
	For scan = 0 To 49
		If doc.GetItemValue("Produto_" & scan)(0) <> "" And CStr(doc.GetItemValue("Mg_" & scan)(0)) <> "" And Val(doc.GetItemValue("Q_" & scan)(0)) > 0 Then
			If CStr(doc.GetItemValue("MgSolicitada_" & scan)(0)) <> "" And doc.Status_MI(0) = "Aprovado" Then mgMinima = doc.GetItemValue("MgSolicitada_" & scan)(0) Else mgMinima = 0.85
			If CDbl(doc.GetItemValue("Mg_" & scan)(0)) > mgMinima Then
				Call doc.Replaceitemvalue("MgSolicitada_" & scan, doc.GetItemValue("Mg_" & scan)(0))
				CheckMgItens = True
				If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
				scan2 = scan2 + 1
			End If
		End If
	Next
	If CheckMgItens Then
		MsgBox "Margem maior que " & mgMinima & " no(s) Item(s) " & item & ".", 64, "Margem de Item da Lista de Materiais"
	End If
	
End Function

'++LotusScript Development Environment:2:1:CheckMgRevenda:5:8
%REM
	Function CheckMgRevenda
	Description: Comments for Function
%END REM
Function CheckMgRevenda(doc As NotesDocument) As Boolean
	
	'Margem Mínima de Revenda
	Dim margemMinimaRevenda As Double
	If CStr(doc.MgAprovada(0)) <> "" And doc.StatusMg(0) = "Aprovado" Then margemMinimaRevenda = doc.MgAprovada(0) Else margemMinimaRevenda = doc.MgRevendaM(0)
	If margemMinimaRevenda > doc.MgRevendaM(0) Then margemMinimaRevenda = doc.MgRevendaM(0)
	If Val(doc.TotMateriais(0)) > 0 And doc.ResM_P(0) < margemMinimaRevenda And doc.TipoVenda(0) <> "Contrato" Then
		CheckMgRevenda = True
	End If
	
End Function

'++LotusScript Development Environment:2:2:CalcBudget:5:8
%REM
	Sub CalcBudget
	Description: Comments for Sub
%END REM
Sub CalcBudget(projeto As NotesDocument)
	
	On Error Resume Next
	Dim desconto As Double
	'*** Custos ***
	Dim passQtd As Double, hospQtd As Double, transporteQtd As Double, alugQtd As Double, matQtd As Double, ativoQtd As Double, servQtd As Double, freteMQtd As Double
	Dim pass As Double, hosp As Double, transporte As Double, alug As Double, mat As Double, ativo As Double, serv As Double, freteM As Double
	'Passagens
	If CStr(projeto.PassQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then passQtd = Round(projeto.PassQtd(0), 0)
	If CStr(projeto.Pass(0)) <> "" Then pass = Round(projeto.Pass(0), 2)
	projeto.PassQtd = passQtd
	projeto.Pass = pass
	projeto.PassP = passQtd * pass
	'Passagens 1
	Dim passQtd_1 As Double, pass_1 As Double
	If CStr(projeto.PassQtd_1(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then passQtd_1 = Round(projeto.PassQtd_1(0), 0)
	If CStr(projeto.Pass_1(0)) <> "" Then pass_1 = Round(projeto.Pass_1(0), 2)
	projeto.PassQtd_1 = passQtd_1
	projeto.Pass_1 = pass_1
	projeto.PassP_1 = passQtd_1 * pass_1
	'Hospedagens
	If CStr(projeto.HospQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then hospQtd = Round(projeto.HospQtd(0), 0)
	If CStr(projeto.Hosp(0)) <> "" Then hosp = Round(projeto.Hosp(0), 2)
	projeto.HospQtd = hospQtd
	projeto.Hosp = hosp
	projeto.HospP = hospQtd * hosp
	'Hospedagens 1
	Dim hospQtd_1 As Double, hosp_1 As Double
	If CStr(projeto.HospQtd_1(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then hospQtd_1 = Round(projeto.HospQtd_1(0), 0)
	If CStr(projeto.Hosp_1(0)) <> "" Then hosp_1 = Round(projeto.Hosp_1(0), 2)
	projeto.HospQtd_1 = hospQtd_1
	projeto.Hosp_1 = hosp_1
	projeto.HospP_1 = hospQtd_1 * hosp_1
	'Transporte de Projetos
	If CStr(projeto.TransporteQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then transporteQtd = Round(projeto.TransporteQtd(0), 0)
	If CStr(projeto.Transporte(0)) <> "" Then transporte = Round(projeto.Transporte(0), 2)
	projeto.TransporteQtd = transporteQtd
	projeto.Transporte = transporte
	projeto.TransporteP = transporteQtd * transporte
	'Aluguéis
	If CStr(projeto.AlugQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then alugQtd = Round(projeto.AlugQtd(0), 0)
	If CStr(projeto.Alug(0)) <> "" Then alug = Round(projeto.Alug(0), 2)
	projeto.AlugQtd = alugQtd
	projeto.Alug = alug
	projeto.AlugP = alugQtd * alug
	'Aluguéis 1
	Dim alugQtd_1 As Double, alug_1 As Double
	If CStr(projeto.AlugQtd_1(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then alugQtd_1 = Round(projeto.AlugQtd_1(0), 0)
	If CStr(projeto.Alug_1(0)) <> "" Then alug_1 = Round(projeto.Alug_1(0), 2)
	projeto.AlugQtd_1 = alugQtd_1
	projeto.Alug_1 = alug_1
	projeto.AlugP_1 = alugQtd_1 * alug_1
	'Compras para Prestação de Serviços
	If CStr(projeto.MatQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then matQtd = Round(projeto.MatQtd(0), 0)
	If CStr(projeto.Mat(0)) <> "" Then mat = Round(projeto.Mat(0), 2)
	projeto.MatQtd = matQtd
	projeto.Mat = mat
	projeto.MatP = matQtd * mat
	'Compras para Prestação de Serviços 1
	Dim matQtd_1 As Double, mat_1 As Double
	If CStr(projeto.MatQtd_1(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then matQtd_1 = Round(projeto.MatQtd_1(0), 0)
	If CStr(projeto.Mat_1(0)) <> "" Then mat_1 = Round(projeto.Mat_1(0), 2)
	projeto.MatQtd_1 = matQtd_1
	projeto.Mat_1 = mat_1
	projeto.MatP_1 = matQtd_1 * mat_1
	'Compras para Prestação de Serviços 2
	Dim matQtd_2 As Double, mat_2 As Double
	If CStr(projeto.MatQtd_2(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then matQtd_2 = Round(projeto.MatQtd_2(0), 0)
	If CStr(projeto.Mat_2(0)) <> "" Then mat_2 = Round(projeto.Mat_2(0), 2)
	projeto.MatQtd_2 = matQtd_2
	projeto.Mat_2 = mat_2
	projeto.MatP_2 = matQtd_2 * mat_2
	'Ativo para Prestação de Serviços
	If CStr(projeto.AtivoQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then ativoQtd = Round(projeto.AtivoQtd(0), 0)
	If CStr(projeto.Ativo(0)) <> "" Then ativo = Round(projeto.Ativo(0), 2)
	projeto.AtivoQtd = ativoQtd
	projeto.Ativo = ativo
	projeto.AtivoP = ativoQtd * ativo
	'Ativo para Prestação de Serviços 1
	Dim ativoQtd_1 As Double, ativo_1 As Double
	If CStr(projeto.AtivoQtd_1(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then ativoQtd_1 = Round(projeto.AtivoQtd_1(0), 0)
	If CStr(projeto.Ativo_1(0)) <> "" Then ativo_1 = Round(projeto.Ativo_1(0), 2)
	projeto.AtivoQtd_1 = ativoQtd_1
	projeto.Ativo_1 = ativo_1
	projeto.AtivoP_1 = ativoQtd_1 * ativo_1
	'Contratação de Terceiros não Faturáveis
	If CStr(projeto.ServQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then servQtd = Round(projeto.ServQtd(0), 0)
	If CStr(projeto.Serv(0)) <> "" Then serv = Round(projeto.Serv(0), 2)
	projeto.ServQtd = servQtd
	projeto.Serv = serv
	projeto.ServP = servQtd * serv
	'Contratação de Terceiros não Faturáveis 1
	Dim servQtd_1 As Double, serv_1 As Double
	If CStr(projeto.ServQtd_1(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then servQtd_1 = Round(projeto.ServQtd_1(0), 0)
	If CStr(projeto.Serv_1(0)) <> "" Then serv_1 = Round(projeto.Serv_1(0), 2)
	projeto.ServQtd_1 = servQtd_1
	projeto.Serv_1 = serv_1
	projeto.ServP_1 = servQtd_1 * serv_1
	'Frete de Mercadorias
	If CStr(projeto.FreteMQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then freteMQtd = Round(projeto.FreteMQtd(0), 0)
	If CStr(projeto.FreteM(0)) <> "" Then freteM = Round(projeto.FreteM(0), 2)
	projeto.FreteMQtd = freteMQtd
	projeto.FreteM = freteM
	projeto.FreteMP = freteMQtd * freteM
	'Custo Total
	projeto.CustoP = projeto.PassP(0) + projeto.HospP(0) + projeto.TransporteP(0) + projeto.AlugP(0) + projeto.MatP(0) + projeto.AtivoP(0) + projeto.ServP(0) + projeto.FreteMP(0) + projeto.PassP_1(0) + projeto.HospP_1(0) + projeto.AlugP_1(0) + projeto.MatP_1(0) + projeto.AtivoP_1(0) + projeto.ServP_1(0) + projeto.MatP_2(0)
	'*** Despesas ***
	Dim kmQtd As Double, transQtd As Double, alimQtd As Double, teleQtd As Double
	Dim km As Double, trans As Double, alim As Double, tele As Double
	'Quilometragem
	If CStr(projeto.KmQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then kmQtd = Round(projeto.KmQtd(0), 0)
	If CStr(projeto.Km(0)) <> "" Then km = Round(projeto.Km(0), 2)
	projeto.KmQtd = kmQtd
	projeto.Km = km
	projeto.KmP = kmQtd * km
	'Quilometragem 1
	Dim kmQtd_1 As Double, km_1 As Double
	If CStr(projeto.KmQtd_1(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then kmQtd_1 = Round(projeto.KmQtd_1(0), 0)
	If CStr(projeto.Km_1(0)) <> "" Then km_1 = Round(projeto.Km_1(0), 2)
	projeto.KmQtd_1 = kmQtd_1
	projeto.Km_1 = km_1
	projeto.KmP_1 = kmQtd_1 * km_1
	'Transporte
	If CStr(projeto.TranspQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then transQtd = Round(projeto.TranspQtd(0), 0)
	If CStr(projeto.Transp(0)) <> "" Then trans = Round(projeto.Transp(0), 2)
	projeto.TranspQtd = transQtd
	projeto.Transp = trans
	projeto.TranspP = transQtd * trans
	'Transporte 1
	Dim transQtd_1 As Double, trans_1 As Double
	If CStr(projeto.TranspQtd_1(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then transQtd_1 = Round(projeto.TranspQtd_1(0), 0)
	If CStr(projeto.Transp_1(0)) <> "" Then trans_1 = Round(projeto.Transp_1(0), 2)
	projeto.TranspQtd_1 = transQtd_1
	projeto.Transp_1 = trans_1
	projeto.TranspP_1 = transQtd_1 * trans_1
	'Transporte 2
	Dim transQtd_2 As Double, trans_2 As Double
	If CStr(projeto.TranspQtd_2(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then transQtd_2 = Round(projeto.TranspQtd_2(0), 0)
	If CStr(projeto.Transp_2(0)) <> "" Then trans_2 = Round(projeto.Transp_2(0), 2)
	projeto.TranspQtd_2 = transQtd_2
	projeto.Transp_2 = trans_2
	projeto.TranspP_2 = transQtd_2 * trans_2
	'Transporte 3
	Dim transQtd_3 As Double, trans_3 As Double
	If CStr(projeto.TranspQtd_3(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then transQtd_3 = Round(projeto.TranspQtd_3(0), 0)
	If CStr(projeto.Transp_3(0)) <> "" Then trans_3 = Round(projeto.Transp_3(0), 2)
	projeto.TranspQtd_3 = transQtd_3
	projeto.Transp_3 = trans_3
	projeto.TranspP_3 = transQtd_3 * trans_3
	'Transporte 4
	Dim transQtd_4 As Double, trans_4 As Double
	If CStr(projeto.TranspQtd_4(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then transQtd_4 = Round(projeto.TranspQtd_4(0), 0)
	If CStr(projeto.Transp_4(0)) <> "" Then trans_4 = Round(projeto.Transp_4(0), 2)
	projeto.TranspQtd_4 = transQtd_4
	projeto.Transp_4 = trans_4
	projeto.TranspP_4 = transQtd_4 * trans_4
	'Transporte 5
	Dim transQtd_5 As Double, trans_5 As Double
	If CStr(projeto.TranspQtd_5(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then transQtd_5 = Round(projeto.TranspQtd_5(0), 0)
	If CStr(projeto.Transp_5(0)) <> "" Then trans_5 = Round(projeto.Transp_5(0), 2)
	projeto.TranspQtd_5 = transQtd_5
	projeto.Transp_5 = trans_5
	projeto.TranspP_5 = transQtd_5 * trans_5
	'Transporte 6
	Dim transQtd_6 As Double, trans_6 As Double
	If CStr(projeto.TranspQtd_6(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then transQtd_6 = Round(projeto.TranspQtd_6(0), 0)
	If CStr(projeto.Transp_6(0)) <> "" Then trans_6 = Round(projeto.Transp_6(0), 2)
	projeto.TranspQtd_6 = transQtd_6
	projeto.Transp_6 = trans_6
	projeto.TranspP_6 = transQtd_6 * trans_6
	'Alimentação
	If CStr(projeto.AlimeQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then alimQtd = Round(projeto.AlimeQtd(0), 0)
	If CStr(projeto.Alime(0)) <> "" Then alim = Round(projeto.Alime(0), 2)
	projeto.AlimeQtd = alimQtd
	projeto.Alime = alim
	projeto.AlimeP = alimQtd * alim
	'Alimentação 1
	Dim alimQtd_1 As Double, alim_1 As Double
	If CStr(projeto.AlimeQtd_1(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then alimQtd_1 = Round(projeto.AlimeQtd_1(0), 0)
	If CStr(projeto.Alime_1(0)) <> "" Then alim_1 = Round(projeto.Alime_1(0), 2)
	projeto.AlimeQtd_1 = alimQtd_1
	projeto.Alime_1 = alim_1
	projeto.AlimeP_1 = alimQtd_1 * alim_1
	'Telecom
	If CStr(projeto.TeleQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then teleQtd = Round(projeto.TeleQtd(0), 0)
	If CStr(projeto.Tele(0)) <> "" Then tele = Round(projeto.Tele(0), 2)
	projeto.TeleQtd = teleQtd
	projeto.Tele = tele
	projeto.TeleP = teleQtd * tele
	'Despesa Total
	projeto.DespP = projeto.KmP(0) + projeto.TranspP(0) + projeto.AlimeP(0) + projeto.TeleP(0) + projeto.KmP_1(0) + projeto.TranspP_1(0) + projeto.AlimeP_1(0) + projeto.TranspP_2(0) + projeto.TranspP_3(0) + projeto.TranspP_4(0) + projeto.TranspP_5(0) + projeto.TranspP_6(0)
	'*** Lista de CPS ***
	Dim cpsQtd As Double
	Dim cps As Double
	If CStr(projeto.CPSQtd(0)) <> "" And projeto.TipoVenda(0) <> "Venda Simples" Then cpsQtd = Round(projeto.CPSQtd(0), 0)
	If CStr(projeto.CPS(0)) <> "" Then cps = Round(projeto.CPS(0), 2)
	projeto.CPSQtd = cpsQtd
	projeto.CPS = cps
	projeto.CPSP = cpsQtd * cps
	'*** Horas Homem - Normais ***
	Dim horasPV As Double, horasPlan As Double, horasGer As Double, horasExec As Double, horasDeslocamento As Double, horasDoc As Double
	If projeto.TipoVenda(0) <> "Venda Simples" Then
		If CStr(projeto.HorasPV(0)) <> "" Then horasPV = Round(projeto.HorasPV(0), 2)
		If CStr(projeto.HorasPlan(0)) <> "" Then horasPlan = Round(projeto.HorasPlan(0), 2)
		If CStr(projeto.HorasGer(0)) <> "" Then horasGer = Round(projeto.HorasGer(0), 2)
		If CStr(projeto.HorasExec(0)) <> "" Then horasExec = Round(projeto.HorasExec(0), 2)
		If CStr(projeto.HorasDeslocamento(0)) <> "" Then horasDeslocamento = Round(projeto.HorasDeslocamento(0), 2)
		If CStr(projeto.HorasDoc(0)) <> "" Then horasDoc = Round(projeto.HorasDoc(0), 2)
	End If
	projeto.HorasPV = horasPV
	projeto.HorasPlan = horasPlan
	projeto.HorasGer = horasGer
	projeto.HorasExec = horasExec
	projeto.HorasDeslocamento = horasDeslocamento
	projeto.HorasDoc = horasDoc
	'Total
	projeto.HorasTot = horasPV + horasPlan + horasGer + horasExec + horasDeslocamento + horasDoc
	'*** Horas Homem - Fora do Expediente: Peso 2 ***
	Dim horasPVFE As Double, horasPlanFE As Double, horasGerFE As Double, horasExecFE As Double, horasDeslocamentoFE As Double, horasDocFE As Double
	If projeto.TipoVenda(0) <> "Venda Simples" Then
		If CStr(projeto.HorasPVFE(0)) <> "" Then horasPVFE = Round(projeto.HorasPVFE(0), 2)
		If CStr(projeto.HorasPlanFE(0)) <> "" Then horasPlanFE = Round(projeto.HorasPlanFE(0), 2)
		If CStr(projeto.HorasGerFE(0)) <> "" Then horasGerFE = Round(projeto.HorasGerFE(0), 2)
		If CStr(projeto.HorasExecFE(0)) <> "" Then horasExecFE = Round(projeto.HorasExecFE(0), 2)
		If CStr(projeto.HorasDeslocamentoFE(0)) <> "" Then horasDeslocamentoFE = Round(projeto.HorasDeslocamentoFE(0), 2)
		If CStr(projeto.HorasDocFE(0)) <> "" Then horasDocFE = Round(projeto.HorasDocFE(0), 2)
	End If
	projeto.HorasPVFE = horasPVFE
	projeto.HorasPlanFE = horasPlanFE
	projeto.HorasGerFE = horasGerFE
	projeto.HorasExecFE = horasExecFE
	projeto.HorasDeslocamentoFE = horasDeslocamentoFE
	projeto.HorasDocFE = horasDocFE
	'Total
	projeto.HorasTotFE = horasPVFE + horasPlanFE + horasGerFE + horasExecFE + horasDocFE
	'Total de Horas
	projeto.PlanP = Round(horasPlan + (horasPlanFE * 2), 2)
	projeto.GerP = Round(horasGer + (horasGerFE * 2), 2)
	projeto.ExecP = Round(horasExec + (horasExecFE * 2), 2)
	projeto.DeslocamentoP = Round(horasDeslocamento + (horasDeslocamentoFE * 2), 2)
	projeto.DocP = Round(horasDoc + (horasDocFE * 2), 2)
	'Totais
	projeto.HHP = projeto.PlanP(0) + projeto.GerP(0) + projeto.ExecP(0) + projeto.DeslocamentoP(0) + projeto.DocP(0)
	'Custo das Horas
	If Val(projeto.CustoHora(0)) = 0 Then
		projeto.CustoHora = GetCustoHora(projeto.Area(0))
	End If
	projeto.CustoPlan = projeto.PlanP(0) * projeto.CustoHora(0)
	projeto.CustoGer = projeto.GerP(0) * projeto.CustoHora(0)
	projeto.CustoExec = projeto.ExecP(0) * projeto.CustoHora(0)
	projeto.CustoDeslocamento = projeto.DeslocamentoP(0) * projeto.CustoHora(0)
	projeto.CustoDoc = projeto.DocP(0) * projeto.CustoHora(0)
	projeto.CustoHoras = projeto.HHP(0) * projeto.CustoHora(0)
	'Custo dos Serviços Final
	If CStr(projeto.Desconto(0)) <> "" Then desconto = projeto.Desconto(0)
	projeto.HHPT = projeto.HHP(0)
	projeto.CustoServicos = projeto.CustoHoras(0)
	projeto.ValorDesconto = projeto.CustoHoras(0) * desconto
	projeto.CustoServicosFinal = projeto.CustoHoras(0) - projeto.ValorDesconto(0)
	'*** Terceiros Faturáveis ***
	Dim terceirosQtd As Double,  terceiros As Double
	If CStr(projeto.TerceirosQtd(0)) <> "" Then terceirosQtd = Round(projeto.TerceirosQtd(0), 0)
	If CStr(projeto.Terceiros(0)) <> "" Then terceiros = Round(projeto.Terceiros(0), 2)
	projeto.TerceirosQtd = terceirosQtd
	projeto.Terceiros = terceiros
	projeto.TerceirosP = terceirosQtd * terceiros
	'Totais do Budget
	projeto.CustoDespPT = projeto.CustoP(0) + projeto.DespP(0)
	projeto.CPSPT = projeto.TotMateriais(0)
	projeto.CustoHorasPT = projeto.CustoServicosFinal(0)
	
End Sub

'++LotusScript Development Environment:2:2:CalcParticipacoes:5:8
%REM
	Sub CalcParticipacoes
	Description: Comments for Sub
%END REM
Sub CalcParticipacoes(doc As NotesDocument)
	
	On Error Resume Next
	Dim nomes As Variant, participacoes As Variant
	Dim scan As Integer
	Dim mg As Double, fator As Double
	If doc.Sit(0) = "Concluído" Then
		mg = doc.Margem_R(0)
	Else
		mg = doc.Margem_P(0)
	End If
	If mg < 0 Then mg = 0
	'Participação da Pré-Venda 
	If CStr(doc.FatorPV(0)) <> "" Then fator = doc.FatorPV(0) Else fator = 1
	doc.ValorPremioPV = mg * doc.PremioPV(0) * fator
	nomes = doc.NomePV
	participacoes = doc.ParticipacaoPV
	ReDim valoresParticipacoes(UBound(nomes)) As Double
	If UBound(nomes) = UBound(participacoes) Then
		For scan = 0 To UBound(nomes)
			If IsNumeric(participacoes(scan)) Then valoresParticipacoes(scan) = doc.ValorPremioPV(0) * participacoes(scan)
		Next
	End If
	doc.ValorParticipacaoPV = valoresParticipacoes
	'Participação da Execução
	If CStr(doc.FatorExec(0)) <> "" Then fator = doc.FatorExec(0) Else fator = 1
	doc.ValorPremioExec = mg * doc.PremioExec(0) * fator
	nomes = doc.NomeExec
	participacoes = doc.ParticipacaoExec
	ReDim valoresParticipacoes(UBound(nomes)) As Double
	If UBound(nomes) = UBound(participacoes) Then
		For scan = 0 To UBound(nomes)
			If IsNumeric(participacoes(scan)) Then valoresParticipacoes(scan) = doc.ValorPremioExec(0) * participacoes(scan)
		Next
	End If
	doc.ValorParticipacaoExec = valoresParticipacoes
	'Participação do PMO
	If CStr(doc.FatorPMO(0)) <> "" Then fator = doc.FatorPMO(0) Else fator = 1
	doc.ValorPremioPMO = mg * doc.PremioPMO(0) * fator
	nomes = doc.NomePMO
	participacoes = doc.ParticipacaoPMO
	ReDim valoresParticipacoes(UBound(nomes)) As Double
	If UBound(nomes) = UBound(participacoes) Then
		For scan = 0 To UBound(nomes)
			If IsNumeric(participacoes(scan)) Then valoresParticipacoes(scan) = doc.ValorPremioPMO(0) * participacoes(scan)
		Next
	End If
	doc.ValorParticipacaoPMO = valoresParticipacoes
	
End Sub

'++LotusScript Development Environment:2:2:FaturaServicos:1:8
Sub FaturaServicos(uidoc As NotesUiDocument)
	
	'Consiste Campos do Fechamento
	If Not ConsisteCamposFechamento(uidoc) Then
		Exit Sub
	End If
	'Consiste Campos Comprador
	If Not ConsisteComprador(uidoc) Then
		Exit Sub
	End If
	Dim ws As New NotesUiWorkspace
	Dim session As New NotesSession
	Dim fator As Double
	'Condições de Pagamento (D.D.L.: Dias da Data Líquido; D.F.M.: Dias Fora Mês; D.F.Q.: Dias Fora Quinzena; D.F.V.: Dia Fixo de Vencimento)
	Dim dataFaturamento As New NotesDateTime(Today), vencimento As New NotesDateTime(Today)
	If uidoc.FieldGetText("CondPagto") = "D.F.M." Then	'D.F.M. (Dias Fora Mês)
		Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
		Call vencimento.AdjustMonth(1)
		Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0) - 1)
	Elseif uidoc.FieldGetText("CondPagto") = "D.F.V." Then	'D.F.V. (Dia Fixo de Vencimento)
		Set vencimento = New NotesDateTime(uidoc.FieldGetText("PrazoPagamento") & "/" & Month(Today) & "/" & Year(Today))
	Elseif uidoc.FieldGetText("CondPagto") = "D.F.Q." Then	'D.F.Q. (Dias Fora Quinzena)
		If Day(dataFaturamento.DateOnly) <= 15 Then
			'1)Faturado até dia 15
			Set vencimento = New NotesDateTime("15/" & Month(Today) & "/" & Year(Today))
			Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
		Else	
			'2)Faturado após dia 15
			Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
			Call vencimento.AdjustMonth(1)
			Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
		End If
	Elseif uidoc.FieldGetText("CondPagto") = "D.D.L." Then	'D.D.L. (Dias Decorridos Líquido)
		Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
	End If
	'Listas
	Dim db As New NotesDatabase(uidoc.Document.ParentDatabase.Server,"listas.nsf")
	Dim view As NotesView
	Set view = db.GetView( "(NegocioNServicos)" )
	Dim doc As NotesDocument		
	Dim scan As Integer, i As Integer, irAnterior As Double, inAnterior As Double, iss As Double, issAnterior As Double, ck As Long, ckValFat As Double
	Dim rir() As Double, rin() As Double, ris() As Double
	Dim inssrf As Double, irrf As Double, issrf As Double, total As Double
	'Busca Cotação da Moeda
	Dim moeda As Variant
	moeda = GetMoedas
	'Preenchimento da Matriz
	For scan% = 0 To 11
		ck = Val( uidoc.FieldGetText( "Qs_" & Cstr( scan%) ) )
		If uidoc.FieldGetText( "VlFat_" & Cstr( scan%) ) = "" Then ckValFat# = 0 Else ckValFat# = Cdbl( uidoc.FieldGetText( "VlFat_" & Cstr( scan%) ) )
		If ck > 0 And ckValFat# > 0 Then
			Set doc = view.getDocumentByKey(uidoc.FieldGetText("Codigo") & "-" & (scan+1))
			If Not( doc Is Nothing)  Then
				If doc.US(0) = "US$C" Then
					fator# = moeda(0)
				Elseif doc.US(0) = "US$T" Then
					fator# = moeda(1)
				Else
					fator# = 1
				End If
				If doc.Hasitem("ISS") Then
					If CStr(doc.ISS(0)) <> "" Then iss = doc.ISS(0) Else iss = 0
				Else
					iss = 0
				End If
				If i% > 0 And (irAnterior# <> doc.RIR(0) Or inAnterior# <> doc.RIN(0) Or issAnterior# <> iss) Then
					MsgBox "Retenções de IR/INSS/ISS diferentes na mesma nota. Favor Separar a emissão das Notas por tipo de Retenção" & Chr(10) & "OU" & Chr(10) & "Atualizar o Negócio e Alterar a Lista de Serviços.", 16, "Serviço - " & doc.Produtos(0)
				Elseif Round(ckValFat#, 2) > Round((doc.CusTots(0) - doc.VlFat(0)), 2) Then
					MsgBox "O Valor do serviço selecionado é maior que o saldo para faturamento do mesmo", 16, "Serviço - " & doc.Produtos(0)
				Else						
					Redim Preserve nitem(i%) As String
					Redim Preserve qs(i%) As Long
					Redim Preserve valFat(i%) As Double
					Redim Preserve valOrig(i%) As Double
					ReDim Preserve partN(i%) As String
					Redim Preserve produtos(i%) As String
					Redim Preserve us(i%) As String
					Redim Preserve custounits(i%) As Double
					Redim Preserve custots(i%) As Double
					Redim Preserve rir(i%) As Double
					Redim Preserve rin(i%) As Double
					ReDim Preserve ris(i%) As Double
					nitem(i%) = doc.NServico(0) 
					qs(i%) = doc.Qs(0)
					valFat(i%) = ckValFat# * fator
					valOrig(i%) = ckValFat#
					partN(i%) = doc.PartN(0) 
					produtos(i%) = doc.Produtos(0) 
					us(i%) = doc.Us(0) 
					custounits(i%) = doc.CustoUnits(0) 
					custots(i%) = doc.CusTots(0) 
					rir(i%) = doc.RIR(0) 
					rin(i%) = doc.RIN(0)
					ris(i%) = iss
					irrf# = irrf# + rir(i%) * valFat(i%)
					inssrf# = inssrf# + rin(i%) * valFat(i%)
					issrf# = issrf# + ris(i%) * valFat(i%)
					total# = total# + valFat(i%)
					irAnterior# = doc.RIR(0)
					inAnterior# = doc.RIN(0)
					issAnterior# = iss
					i% = i% + 1
				End If
			End If
		End If
	Next
	If i% = 0 Then
		Msgbox "Não há serviços selecionados para Faturamento", 16, "Erro"
		Exit Sub
	End If
	
	Dim nota As NotesUiDocument
	Set nota = ws.ComposeDocument("", "", "NotaServicos")
	Call nota.FieldSetText("DataFaturamento", dataFaturamento.DateOnly)
	Call nota.FieldSetText("Vencimento", vencimento.DateOnly)
	Call nota.FieldSetText("Codigo", uidoc.FieldGetText("Codigo"))
	Call nota.FieldSetText("GerenteConta", uidoc.FieldGetText("GerenteConta"))
	Call nota.FieldSetText("Inside", uidoc.FieldGetText("Inside"))
	Call nota.FieldSetText("CodCliente", uidoc.FieldGetText("CodCliente"))
	Call nota.FieldSetText("CodClienteFaturamento", uidoc.FieldGetText("CodCliente"))
	Call nota.FieldSetText("CodigoGrupoEconomico", uidoc.FieldGetText("CodigoGrupoEconomico"))
	Call nota.FieldSetText("Renovacao", uidoc.FieldGetText("Renovacao"))
	Call nota.FieldSetText("Tipo", "Nota")
	Call nota.FieldSetText("TipoCompra", "Revenda")
	Call nota.FieldSetText("TipoVenda", uidoc.FieldGetText("TipoVenda"))
	'A Área da Lista de Serviços sempre será a Área de Serviços - LMO 14/06/24
	Call nota.FieldSetText("Area", uidoc.FieldGetText("Area"))
	Call nota.FieldSetText("AreaVendas", uidoc.FieldGetText("AreaVendas"))
	'
	Call nota.FieldSetText("Parceria", uidoc.FieldGetText("Parceria"))
	Call nota.FieldSetText("CodEmpresa", uidoc.FieldGetText("CodEmpresa"))
	Call nota.FieldSetText("CondPagto", uidoc.FieldGetText("PrazoPagamento") & uidoc.FieldGetText("CondPagto"))
	Call nota.FieldSetText("TipoPagto", uidoc.FieldGetText("TipoPagto"))
	Call nota.FieldSetText("Pedido", uidoc.FieldGetText("Pedido"))
	Call nota.FieldSetText("ObsCorpo", "Pedido de Compra: " & uidoc.FieldGetText("Pedido") & GetDadosBancarios(uidoc.Document))
	'Aviso de Faturamento - LMO 19/04/18
	Call nota.FieldSetText("Comprador", uidoc.FieldGetText("Comprador"))
	Call nota.FieldSetText("TelComprador", uidoc.FieldGetText("TelComprador"))
	Call nota.FieldSetText("CelComprador", uidoc.FieldGetText("CelComprador"))
	Call nota.FieldSetText("EmailComprador", uidoc.FieldGetText("EmailComprador"))
	Call nota.FieldSetText("TelefoneInside", uidoc.FieldGetText("TelefoneInside"))
	Call nota.FieldSetText("CelularInside", uidoc.FieldGetText("CelularInside"))
	Call nota.FieldSetText("EnviarEmail", uidoc.FieldGetText("EnviarEmail"))
	'US$C Venda Fixo - LMO 08/01/18
	If IsNumeric(uidoc.FieldGetText("USVenda")) Then
		Call nota.FieldSetText("USC", uidoc.FieldGetText("USVenda")) 
	Else
		Call nota.FieldSetText("USC", CStr(moeda(0))) 
	End If
	Call nota.FieldSetText("UST", Cstr(moeda(1))) 
	Call nota.FieldSetText("TipoComissionamento", uidoc.FieldGetText("TipoComissionamento"))
	Call nota.FieldSetText("AliquotaPIS", Format(uidoc.FieldGetText("AliquotaPIS"), "Percent"))
	Call nota.FieldSetText("AliquotaCOFINS", Format(uidoc.FieldGetText("AliquotaCOFINS"), "Percent"))
	For scan% = 0 To i% -1
		Call nota.FieldSetText("NItem_" & scan, nitem(scan))
		Call nota.FieldSetText("Qs_" & scan, Format(qs(scan), "Fixed"))
		Call nota.FieldSetText("PNs_" & scan, partN(scan))
		Call nota.FieldSetText("Produtos_" & scan, produtos(scan))
		Call nota.FieldSetText("Us_" & scan, us(scan))
		Call nota.FieldSetText("CusTots_" & scan, Format(valFat(scan), "Standard"))
		Call nota.FieldSetText("Custo_" & scan, Format(valOrig(scan), "Standard"))
		Call nota.FieldSetText("RIR_" & scan, Format(rir(scan), "Percent"))
		Call nota.FieldSetText("RIN_" & scan, Format(rin(scan), "Percent"))
		Call nota.FieldSetText("ISS_" & scan, Format(ris(scan), "Percent"))
	Next
	Call nota.FieldSetText("IRRF", Format(irrf#, "Fixed"))
	Call nota.FieldSetText("INSSRF", Format(inssrf#, "Fixed"))
	Call nota.FieldSetText("Valor", Format(total#, "Standard"))
	Call nota.FieldSetText("Total", Format(total#, "Standard"))
	Call nota.Refresh
	
End Sub

'++LotusScript Development Environment:2:2:AvisoCheckPointPV:5:8
%REM
	Sub AvisoCheckPointPV
	Description: Comments for Sub
%END REM
Sub AvisoCheckPointPV(negocio As NotesDocument, tipo As String)
	
	On Error Resume Next
	Dim scan As Integer
	ReDim recipients(scan) As String
	For scan = 0 To UBound(negocio.Inside)
		ReDim Preserve recipients(scan) As String
		recipients(scan) = negocio.Inside(scan)
	Next
	ReDim Preserve recipients(scan) As String
	recipients(scan) = negocio.GerenteConta(0)
	'
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	Set db = session.CurrentDatabase
	Dim memo As New NotesDocument( db )
	memo.Form = "Memo"
	memo.SendTo = "projetos@tdec.com.br"
	memo.CopyTo = recipients
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	Dim corpo As New NotesRichTextItem( memo , "Body" )
	Call corpo.AppendStyle(richStyle)
	If tipo = "Prorrogar" Then
		memo.Subject = "-> Check Point de Pré-Venda Prorrogado para " & Format(negocio.DataCheckPointPV(UBound(negocio.DataCheckPointPV)), "dd/mm/yyyy") & ": " & negocio.Codigo(0)
		Call corpo.Appendtext("Data de Check Point " & Format(negocio.DataCheckPointPV(UBound(negocio.DataCheckPointPV)), "dd/mm/yyyy"))
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( negocio.MotivoInterrupcaoPV(UBound(negocio.MotivoInterrupcaoPV)))
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext("Área: " & negocio.Area(0))
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext("Responsável pela Prorrogação do Check Point: " & negocio.ResponsavelInterrupcaoPV(UBound(negocio.ResponsavelInterrupcaoPV)))
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( "Negócio: " )
		Call corpo.AppendDocLink( negocio, "Link para o Negócio" )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( session.CommonUserName & "," )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "TDec Network Group" )
		Call memo.Send(False)
		MsgBox "Email encaminhado para Projetos, Gerente da Conta e Suporte a Vendas.", 64, "Prorrogação do Check Point de Pré-Venda"
	ElseIf tipo = "Concluir" Then
		memo.Subject = "-> Check Point de Pré-Venda Concluído: " & negocio.Codigo(0)
		Call corpo.Appendtext("Data da Conclusão do Check Point " & Format(negocio.DataCheckPointPV(UBound(negocio.DataCheckPointPV)), "dd/mm/yyyy"))
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( negocio.MotivoInterrupcaoPV(UBound(negocio.MotivoInterrupcaoPV)))
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext("Área: " & negocio.Area(0))
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext("Responsável pela Conclusão do Check Point: " & negocio.ResponsavelInterrupcaoPV(UBound(negocio.ResponsavelInterrupcaoPV)))
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( "Negócio: " )
		Call corpo.AppendDocLink( negocio, "Link para o Negócio" )
		Call corpo.AddNewLine( 2 )
		Call corpo.Appendtext( session.CommonUserName & "," )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "TDec Network Group" )
		Call memo.Send(False)
		MsgBox "Email encaminhado para Projetos, Gerente da Conta e Suporte a Vendas.", 64, "Conclusão do Check Point de Pré-Venda"
	End If
	
End Sub

'++LotusScript Development Environment:2:2:AtualizaServicosInternos:5:8
%REM
	Sub AtualizaServicosInternos
	Description: Comments for Sub
%END REM
Sub AtualizaServicosInternos(negocio As NotesDocument, tipo As string)
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim key(1) As String
	Dim totServicos As Double
	key(0) = "Serviços Internos"
	key(1) = negocio.Codigo(0)
	Set view = db.GetView("(Adendos)")
	Set dc = view.GetAllDocumentsByKey(key, True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.Sit(0) <> "Consolidado" And doc.Sit(0) <> "Perdido" And doc.Sit(0) <> "" And doc.Sit(0) <> "Postergado" Then
			'Fechamento da Venda
			If tipo = "Fechamento" Then
				'Solicita Aprovação da Margem do Negócio Inferior
				If Val(doc.Res_P(0)) < Val(doc.Resultado(0)) Then
					Call SolicitaAprovacaoMargemFatorInferior(doc, "Margem Inferior")
					'Solicita Aprovação da Margem de Revenda Inferior
				ElseIf Val(doc.TotMateriais(0)) > 0 And Val(doc.ResM_P(0)) < Val(doc.MgRevendaM(0)) Then
					Call SolicitaAprovacaoMargemFatorInferior(doc, "Margem Revenda Inferior")
					'Solicitação de Aprovação da Margem de Serviços Inferior
				ElseIf Val(doc.TotServicos(0)) > 0 And Val(doc.ResS_P(0)) < Val(doc.MgServicosM(0)) Then
					Call SolicitaAprovacaoMargemFatorInferior(doc, "Margem Serviços Inferior")
					'Solicita Aprovação de Fator de Importação Inferior
				ElseIf Not CheckFI(doc, "Solicita Aprovação") Then
					Call SolicitaAprovacaoMargemFatorInferior(doc, "Fator de Importação Inferior")
					'Fechamento
				Else
					doc.RespFechamento = session.Commonusername
					doc.DataFechamento = Now
					If doc.TipoVenda(0) = "Contrato" Then
						doc.Sit =  "Contrato"
						doc.SitNumero =  17
					Else	
						doc.Sit =  "Fechado"
						doc.SitNumero =  16
					End If
					doc.DFechado =  Now
					Call Fechamento(doc)
					Call doc.Save(True, True)
					'Atualiza Projeto/Contrato
					Call ProjetoContrato(doc, "Fechamento")
					'Atualiza Contrato
					If doc.TipoVenda(0) = "Contrato" Then
						Call Contrato(doc, "Fechamento")
					End If
					'Gera Controle Financeiro Planejado
					Call GeraControleDoc(doc, "Planejado")
					'Email da Margem Prevista
					Call AvisoMgPrevista(doc, "Fechamento")
				End If
				'Desfechamento
			ElseIf tipo = "Desfechamento" Then
				'Campos Utilizados no Forecast
				doc.ValorEstimadoSub = negocio.ValorEstimadoSub(0)
				doc.DataForecastSub = negocio.DataForecastSub(0)
				doc.TemperaturaSub = negocio.TemperaturaSub(0)
				doc.ProxDataSub = negocio.ProxDataSub(0)
				doc.ForecastSub = negocio.ForecastSub(0)
				'Desfechamento
				Call Desfechamento(doc)
				'Conclusão do Negócio
			ElseIf tipo = "Conclusão" Then
				'Zera Saldo de Faturamento da Lista de Materiais e Lista de Serviços
				Call ConcluirNegocio(doc)
				'Atualiza o Status do Negócio
				Call CheckStatusNegocio(doc)
				'Gera Despesas de Serviços Internos
				Call GeraDespesasServicosInternos(negocio, doc)
				'Atualiza Projeto/Contrato
				Call ProjetoContrato(doc, "Atualiza")
				'Atualiza Contrato na Base de Serviços
				If doc.TipoVenda(0) = "Contrato" Then
					Call Contrato(doc, "Atualiza")
				End If
			'Perda
			ElseIf tipo = "Perda" Then
				Call Perda(doc)
				Call doc.Save(False, False)
			End If
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	
End Sub

'++LotusScript Development Environment:2:2:ConcluirNegocio:5:8
%REM
	Sub ConcluirNegocioFob
	Description: Comments for Sub
%END REM
Sub ConcluirNegocio(negocio As NotesDocument)
	
	Dim db As New NotesDatabase( negocio.ParentDatabase.Server, "listas.nsf" )
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim array As Variant
	Dim scan As Integer
	'Lista de Materiais
	Set view = db.GetView( "(NegocioNItens)" )
	For scan = 0 To 49
		array = negocio.Getitemvalue("Q_" & scan)
		If Val(array(0)) > 0 Then
			Set doc = view.GetDocumentByKey(negocio.Codigo(0) & "-" & (scan + 1), True)
			If Not doc Is Nothing Then
				doc.QCompra = doc.Q(0)
				doc.QBaixa = doc.Q(0)
				doc.QFat = doc.Q(0)
				Call doc.Save(False, False)
			End If
		End If
	Next
	'Lista de Serviços
	Set view = db.GetView( "(NegocioNServicos)" )
	For scan = 0 To 11
		array = negocio.Getitemvalue("Qs_" & scan)
		If Val(array(0)) > 0 Then
			Set doc = view.GetDocumentByKey(negocio.Codigo(0) & "-" & (scan + 1), True)
			If Not doc Is Nothing Then
				array = negocio.Getitemvalue("CusTots_" & scan)
				doc.VlFat = array(0)
				Call doc.Save(False, False)
			End If
		End If
	Next
	'Atualiza Cotação
	Call Cotacao(negocio)
	
End Sub

'++LotusScript Development Environment:2:1:ConsisteComprador:5:8
%REM
	Function ConsisteComprador
	Description: Comments for Function 04/09/2018 LMO
%END REM
Function ConsisteComprador(uidoc As NotesuiDocument) As Boolean
	
	ConsisteComprador = True
	If uidoc.FieldGetText("Comprador") = "" Then
		MsgBox "Você precisa cadastrar um comprador para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "Comprador" )
		ConsisteComprador = False
		Exit Function
	ElseIf uidoc.FieldGetText("EmailComprador") = "" Then
		MsgBox "Comprador selecionado sem email preenchido. Favor atualizar o cadastro desse contato em Empresas ou selecionador outro contato.", 16, "Erro !"
		Call uidoc.GotoField( "Comprador" )
		ConsisteComprador = False
		Exit Function
	ElseIf uidoc.FieldGetText("TelComprador") = "" And uidoc.FieldGetText("CelComprador") = "" Then
		MsgBox "Comprador selecionado sem Telefone e Celular preenchidos. Favor atualizar o cadastro desse contato em Empresas ou selecionador outro contato.", 16, "Erro"
		Call uidoc.GotoField("Comprador")
		ConsisteComprador = False
		Exit Function
	ElseIf uidoc.FieldGetText("TelefoneInside") = "" Then
		MsgBox "Telefone do Suporte a Vendas não está correto no Names Address Book.", 16, "Erro"
		ConsisteComprador = False
		Exit Function
	End If
	
End Function

'++LotusScript Development Environment:2:2:LinkProjetoPopup:5:8
%REM
	Sub LinkProjetoPopup
	Description: Comments for Sub
%END REM
Sub LinkProjetoPopup(negocio As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	If negocio.HasItem("DocLinks") Then negocio.RemoveItem("DocLinks")
	Dim rtitem As NotesRichTextItem
	Set rtitem = negocio.CreateRichTextItem("DocLinks")
	'Define o Estilo
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 8
	'Projeto
	Set view = db.GetView("(ProjetosCodigo)")
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		richStyle.NotesColor = COLOR_BLACK     
		richStyle.Bold = True
		richStyle.Underline = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AppendText("Projeto")
		Call rtitem.AddNewLine(1)
		richStyle.NotesColor = COLOR_BLUE     
		richStyle.Bold = False
		richStyle.Underline = False
		Call rtitem.AppendStyle(richStyle)
		Set rtItem = negocio.CreateRichTextItem("DocLinks")
		Call rtItem.AppendDocLink(doc,"Link para o Projeto ")
		Call rtitem.AppendText(doc.Sit(0))
		Call rtitem.AddNewLine(1)
	End If
	'Contrato
	Set view = db.GetView("(ContratosCodigo)")
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		richStyle.NotesColor = COLOR_BLACK     
		richStyle.Bold = True
		richStyle.Underline = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AddNewLine(1)
		Call rtitem.AppendText("Contrato")
		Call rtitem.AddNewLine(1)
		richStyle.NotesColor = COLOR_BLUE     
		richStyle.Bold = False
		richStyle.Underline = False
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AppendDocLink(doc, "Link para o Contrato")
		Call rtitem.AppendText(doc.Sit(0))
	End If
	
End Sub

'++LotusScript Development Environment:2:2:PopulaICMSOE:5:8
%REM
	Sub PopulaICMSOE
	Description: Comments for Sub
%END REM
Sub PopulaICMSOE(doc As NotesDocument)
	
	Dim scan As Integer
	Dim protocolo As Variant, aliqICMSCompra As Variant, ipc As Variant
	Dim icc As Double, icmsOP As Double, icmsSTC As Double, custo As Double
	For scan = 0 To 49
		If doc.Getitemvalue("Produto_" & scan)(0) <> "" Then
			If CStr(doc.Getitemvalue("Custo_" & scan)(0)) <> "" Then custo = doc.Getitemvalue("Custo_" & scan)(0) Else custo = 0
			'Apenas se o Item não foi Comprado
			If CheckDocListas(doc.Codigo(0), CStr(scan + 1), "Compra") Then
				'Calcula ICMS Outros Estados das compras de Fora de SP
				If doc.Getitemvalue("T_" & scan)(0) = "HW" Then
					If Right(doc.Getitemvalue("ST_" & scan)(0), 2) = "00" Then
						If doc.Getitemvalue("UFCompra_" & scan)(0) <> "SP" And doc.Getitemvalue("UFCompra_" & scan)(0) <> "EX" Then
							protocolo = BuscaProtocolo(doc.Getitemvalue("UFCompra_" & scan)(0), doc.Getitemvalue("CF_" & scan)(0), "Sim", "Compra")
							'Não encontrou Protocolo/Protocolo Desatualizado
							If CStr(protocolo(0)) = "False" Then
								Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
							Else 'If CStr(protocolo(0)) = "False" Then
								'Sem Protocolo
								If protocolo(0) = 0 Then
									Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
								'Com Protocolo
								Else 'If protocolo(0) = 0 Then
									'ICMS Operações Próprias (Valor do Produto * ICC)
									'ICMS Substituição Tributária (Valor do Produto + IPI * IVA * Alíquota do ICMS)
									'ICMS Outros Estados (ICMS Substituição Tributária - ICMS Operações Prórias)
									aliqICMSCompra = BuscaICMS(doc.Getitemvalue("UFCompra_" & scan)(0), "SP", "Sim")
									If Left(doc.Getitemvalue("ST_" & scan)(0), 1) = "1" Or Left(doc.Getitemvalue("ST_" & scan)(0), 1) = "2" Or Left(doc.Getitemvalue("ST_" & scan)(0), 1) = "3" Or Left(doc.Getitemvalue("ST_" & scan)(0), 1) = "8" Then icc = aliqICMSCompra(1) Else icc = aliqICMSCompra(0)
									If doc.TipoCompra(0) = "Consumo" Then
										icmsOP = custo * icc
									Else
										ipc = doc.Getitemvalue("IPC_" & scan)
										icmsOP = custo/(1+ipc(0)) * icc
									End If
									If icc = 0.04 Then
										icmsSTC = custo * (1 + protocolo(2)) * protocolo(4)
									Else
										icmsSTC = custo * (1 + protocolo(3)) * protocolo(4)
									End If
									Call doc.Replaceitemvalue("ICMSSTC_" & scan, icmsSTC - icmsOP)
								End If	'If protocolo(0) = 0 Then
							End If 'If CStr(protocolo(0)) = "False" Then
						End If 'If doc.Getitemvalue("UFCompra_" & scan)(0) <> "SP" And doc.Getitemvalue("UFCompra_" & scan)(0) <> "EX" Then
					End If 'If Right(doc.Getitemvalue("ST_" & scan)(0), 2) = "00" Then
				Else 'If doc.Getitemvalue("T_" & scan)(0) = "HW" Then
					Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
				End If 'If doc.Getitemvalue("T_" & scan)(0) = "HW" Then
			End If 'If CheckDocListas(doc.Codigo(0), CStr(scan + 1), "Compra") Then
		Else 'If doc.Getitemvalue("Produto_" & scan)(0) <> "" Then
			Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
		End If 'If doc.Getitemvalue("Produto_" & scan)(0) <> "" Then
	Next 'For scan = 0 To 49
	
End Sub

'++LotusScript Development Environment:2:2:CustoHora:5:8
%REM
	Sub GetCustoHora
	Description: Comments for Sub
%END REM
Sub CustoHora(negocio As NotesDocument, tipo As String)
	
	Dim datas As Variant, horas As Variant
	If tipo = "Real" Then
		'Obtém Horas do Time Sheet
		Call GetHoras(negocio, "Real")
		datas = negocio.Datas_R
		horas = negocio.Horas_R
	Else
		'Obtém Horas Previstas do Projeto/Planilha Financeira
		Call GetHorasPrevistas(negocio)
		datas = negocio.Datas_P
		horas = negocio.Horas_P
	End If
	'Obtém Custo Médio da Hora
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "timesheet.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim scan As Integer, tot As Double
	ReDim Preserve custoMedio(scan) As Double
	Dim chave(1) As String
	chave(0) = negocio.Area(0)
	Set view = db.Getview("(CustoHora)")
	For scan = 0 To UBound(datas)
		Dim data As New NotesDateTime("1/" & datas(scan))
		'Utilizar o Custo da Hora do mês anterior
		Call data.Adjustmonth(-1)
		'
		chave(1) = Month(data.DateOnly) & "/" & Year(data.DateOnly)
		Set doc = view.Getdocumentbykey(chave, True)
		ReDim Preserve custoMedio(scan) As Double
		If Not doc Is Nothing Then
			custoMedio(scan) = Round(doc.CustoMedioHoraComOverhead(0), 2)
			tot = tot + (custoMedio(scan) * horas(scan))
		Else
			custoMedio(scan) = 0
		End If
	Next
	'Print
	If tipo = "Real" Then
		negocio.CustoMedio_R = custoMedio
		negocio.CustoMedioT_R = tot
	Else
		negocio.CustoMedio_P = custoMedio
		negocio.CustoMedioT_P = tot
	End If
	
End Sub

'++LotusScript Development Environment:2:1:BuscaICMS:5:8
%REM
	Function BuscaICMS
	Description: Comments for Function
%END REM
Function BuscaICMS(origem As String, destino As String, contribuinte As String) As Variant
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim array(10) As Double
	'Operações Estaduais Internas (mantém icms informado)
	If destino = origem Then
		Exit Function
	End If
	'Operações Interestaduais
	Dim chave(1) As String
	chave(0) = origem
	chave(1) = destino
	Set db = New NotesDatabase(session.CurrentDatabase.Server, "faturas.nsf")
	Set view = db.GetView("(Configuracao/ICMS)")
	Set doc = view.GetDocumentByKey(chave, True)
	If Not doc Is Nothing Then
		array(0) = doc.ICMS(0)
		array(1) = doc.ICMSImp(0)
		If contribuinte = "Não" Then
			array(2) = Val(doc.AbateOperacaoPropriaNC(0))
			array(3) = doc.Fator12NC(0)
			array(4) = doc.Fator17NC(0)
			array(5) = doc.Fator18NC(0)
			array(6) = doc.Fator19NC(0)
			array(8) = doc.Fator14NC(0)
			array(9) = Val(doc.AbateAntesFatorNC(0))
			array(10) = doc.Fator20NC(0)
		Else	
			array(2) = Val(doc.AbateOperacaoPropria(0))
			array(3) = doc.Fator12(0)
			array(4) = doc.Fator17(0)
			array(5) = doc.Fator18(0)
			array(6) = doc.Fator19(0)
			array(8) = doc.Fator14(0)
			array(9) = Val(doc.AbateAntesFator(0))
			array(10) = doc.Fator20(0)
		End If
		If doc.CargaMedia(0) = "Sim" Then array(7) = 1
	End If
	BuscaICMS = array
	
End Function

'++LotusScript Development Environment:2:2:AlteraAreas:1:8
Sub AlteraAreas(negocio As NotesDocument)
	
	Dim session As New NotesSession
	Dim dbFat As NotesDatabase, dbDespesa As NotesDatabase, dbCompras As NotesDatabase, dbServicos As NotesDatabase
	Dim viewFat As NotesView, viewReceber As NotesView, viewDespesa As NotesView, viewCompras As NotesView, viewServicos As NotesView
	Dim dcFat As NotesDocumentCollection, dcReceber As NotesDocumentCollection, dcDesp As NotesDocumentCollection, dcCompras As NotesDocumentCollection, dcServicos As NotesDocumentCollection, dcResp As NotesDocumentCollection
	Dim espelho As NotesDocument, receber As NotesDocument, despesa As NotesDocument, pedido As NotesDocument, projeto As NotesDocument, resp As NotesDocument
	Dim area As String, areaVendas As String, areaServicos As String
	Dim key(1) As String
	If negocio.AreaVendas(0) = "" Then areaVendas = "Revenda" Else areaVendas = negocio.AreaVendas(0)
	If negocio.Area(0) = "" Then areaServicos = areaVendas Else areaServicos = negocio.Area(0)
	Set dbFat = New NotesDatabase(negocio.Parentdatabase.Server, "faturas.nsf")
	Set dbDespesa = New NotesDatabase(negocio.Parentdatabase.Server, "caixa.nsf")
	Set dbCompras = New NotesDatabase(negocio.Parentdatabase.Server, "compras.nsf")
	Set dbServicos = New NotesDatabase(negocio.Parentdatabase.Server, "servicos.nsf")
	Set viewFat = dbFat.GetView("(EspelhosNegocio)")
	Set viewReceber = dbFat.GetView("(Receber/NFiscal)")
	Set viewDespesa = dbDespesa.GetView("Dados\IDOrigem")
	Set viewCompras = dbCompras.Getview("(PedidosNegocio)")
	Set viewServicos = dbServicos.Getview("(Codigo)")
	Set dcFat = viewFat.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set espelho = dcFat.GetFirstDocument
	'Faturamento
	Do Until espelho Is Nothing
		'Espelho
		espelho.AreaVendas = areaVendas
		espelho.Area = areaServicos
		Call espelho.Save(False, False)
		If espelho.Tipo(0) = "Serviços" And espelho.TipoServ_0(0) <> "M" Then
			area = areaServicos
		Else
			area = areaVendas
		End If
		'Receber
		If negocio.CodEmpresa(0) = "" Then key(0) = "TDEC" Else key(0) = negocio.CodEmpresa(0)
		key(1) = CStr(espelho.NFiscal(0))
		Set dcReceber = viewReceber.GetAllDocumentsByKey(key, True)
		Set receber = dcReceber.GetFirstDocument
		Do Until receber Is Nothing
			receber.AreaVendas = areaVendas
			receber.Area = area
			Call receber.Save(False, False)
			'Comissões
			Set dcDesp = viewDespesa.GetAllDocumentsByKey(receber.IDOrigem(0), True)
			If dcDesp.Count = 0 Then
				Set dcDesp = viewDespesa.GetAllDocumentsByKey(receber.UniversalID, True)
			End If
			Set despesa = dcDesp.GetFirstDocument
			Do Until despesa Is Nothing
				despesa.AreaDespesa = area
				despesa.Areas = area
				despesa.Overhead = 1
				Call despesa.Save(False, False)
				Set despesa = dcDesp.GetNextDocument(despesa)
			Loop
			Set receber = dcReceber.GetNextDocument(receber)
		Loop
		'Impostos do Espelho
		Set dcDesp = viewDespesa.GetAllDocumentsByKey(espelho.IDOrigem(0), True)
		If dcDesp.Count = 0 Then
			Set dcDesp = viewDespesa.GetAllDocumentsByKey(espelho.UniversalID, True)
		End If
		Set despesa = dcDesp.GetFirstDocument
		Do Until despesa Is Nothing
			despesa.AreaDespesa = area
			despesa.ResponsavelDespesa = area
			despesa.Areas = area
			despesa.Overhead = 1
			Call despesa.Save(False, False)
			Set despesa = dcDesp.GetNextDocument(despesa)
		Loop
		Set espelho = dcFat.GetNextDocument(espelho)
	Loop
	'Compras
	Set dcCompras = viewCompras.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set pedido = dcCompras.Getfirstdocument()
	Do Until pedido Is Nothing
		'Pedido
		If pedido.TipoCompra(0) = "Projeto" And pedido.ClassificacaoDespesa(0) <> "Frete de Projetos" And pedido.ClassificacaoDespesa(0) <> "Imposto - ICMS" Then
			area = areaServicos
		Else
			area = areaVendas
		End If
		pedido.AreaDespesa = area
		pedido.ResponsavelDespesa = area
		Call pedido.Save(False, False)
		'Baixa
		Set dcResp = pedido.Responses
		Set resp = dcResp.Getfirstdocument()
		Do Until resp Is Nothing
			resp.Area = area
			resp.Areas = area
			resp.Overhead = 1
			Call resp.Save(False, False)
			'Despesas da Baixa
			Set dcDesp = viewDespesa.Getalldocumentsbykey(resp.IDOrigem(0), False)
			Set despesa = dcDesp.Getfirstdocument()
			Do Until despesa Is Nothing
				despesa.AreaDespesa = area
				despesa.Areas = area
				despesa.Overhead = 1
				Call despesa.Save(False, False)
				Set despesa = dcDesp.Getnextdocument(despesa)
			Loop
			Set resp = dcResp.GetNextdocument(resp)
		Loop
		Set pedido = dcCompras.GetNextDocument(pedido)
	Loop
	'Projeto
	Set dcServicos = viewServicos.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set projeto = dcServicos.GetFirstDocument
	Do Until projeto Is Nothing
		projeto.AreaVendas = areaVendas
		projeto.Area = areaServicos
		Call projeto.Save(False, False)
		Set projeto = dcServicos.GetNextDocument(projeto)
	Loop
	'Planilha Financeira
	Set viewServicos = dbServicos.Getview("(Planilha/Codigo)")
	Set dcServicos = viewServicos.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set projeto = dcServicos.GetFirstDocument
	Do Until projeto Is Nothing
		projeto.AreaVendas = areaVendas
		projeto.Area = areaServicos
		Call projeto.Save(False, False)
		'Controles Financeiros/Cotações Financeiras
		Set dcResp = projeto.Responses
		Set resp = dcResp.Getfirstdocument()
		Do Until resp Is Nothing
			resp.AreaVendas = areaVendas
			resp.Area = areaServicos
			Call resp.Save(False, False)
			Set resp = dcResp.GetNextdocument(resp)
		Loop
		Set projeto = dcServicos.GetNextDocument(projeto)
	Loop
	MsgBox "Áreas Alteradas", 64, "Aviso"
		
End Sub

'++LotusScript Development Environment:2:2:AtualizaMetasNegocio:1:8
Sub AtualizaMetasNegocio(docAtu As NotesDocument, tipo As String)
	
	On Error Resume Next
	Dim db As New NotesDatabase(docAtu.ParentDatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim mes As String, realizadoP As Double, it As Variant, itR As Variant, itP As Variant, item As NotesItem, x As Integer
	Dim chave(1) As String
	mes = Month(docAtu.DataFechamento(0))
	If Len(mes) = 1 Then mes = "0" & mes
	chave(0) = Year(docAtu.DataFechamento(0)) & "-" & mes
	chave(1) = docAtu.GerenteConta(0)
	Set view = db.GetView("(Metas/MesBase)")
	Set doc = view.GetDocumentByKey(chave, True)
	If Not doc Is Nothing Then
		'Realizado
		If tipo = "Emite" Then
			doc.Realizado = doc.Realizado(0) + docAtu.TotalNegocio(0)
		Elseif tipo = "Cancela" Then
			doc.Realizado = doc.Realizado(0) - docAtu.TotalNegocio(0)
		End If
		'% Realizado
		If Cstr(doc.Previsto(0)) <> "" Then
			If doc.Previsto(0) <> 0 Then
				realizadoP = doc.Realizado(0) / doc.Previsto(0)
			End If
		End If
		doc.RealizadoP = realizadoP
		'Parceiro
		For x = 0 To 19
			it = doc.GetItemValue("Parceria_" & x)
			If it(0) <> "" Then
				If doc.Parceria(0) = it(0) Then
					itR = doc.GetItemValue("Realizado_" & x)
					If Isnumeric(itR(0)) Then
						'Realizado
						If tipo = "Emite" Then
							Set item = doc.ReplaceItemValue("Realizado_" & x, itR + docAtu.TotalNegocio(0))
						Elseif tipo = "Cancela" Then
							Set item = doc.ReplaceItemValue("Realizado_" & x, itR - docAtu.TotalNegocio(0))
						End If
						'% Realizado
						itR = doc.GetItemValue("Realizado_" & x)
						If Cstr(itR(0)) <> "" Then
							If itR(0) <> 0 Then
								Set item = doc.ReplaceItemValue("RealizadoP_" & x, itR(0) / itP(0))
							End If
						End If
					End If
					Exit For
				End If
			End If
		Next
		Call doc.Save(True, True)
	End If
	
End Sub

'++LotusScript Development Environment:2:1:CheckDocListas:5:8
%REM
	Function CheckDocListas: Verifica se os Itens já foram Comprados, Baixados ou Faturados.
	Description: Comments for Function
%END REM
Function CheckDocListas(codigo As String, item As String, tipo As String) As Boolean
	
	CheckDocListas = True
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.CurrentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim saldo As Long
	Set view = db.Getview("(NegocioNItens)")
	Set doc = view.Getdocumentbykey(codigo & "-" & item, True)
	If Not doc Is Nothing Then
		If tipo = "Compra" Then
			saldo = doc.Q(0) - doc.QCompra(0)
		ElseIf tipo = "Baixa" Then
			saldo = doc.Q(0) - doc.QBaixa(0)
		Else
			saldo = doc.Q(0) - doc.QFat(0)
		End If
		If saldo <= 0 Then
			CheckDocListas = False
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:CalcCapitalGiroReal:5:8
%REM
	Sub CalcCapitalGiroReal
	Description: Calcula o Capital de Giro Resumido (Sem Extrato) 
%END REM
Sub CalcCapitalGiroReal(negocios As NotesDocumentCollection)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim doc As NotesDocument
	'Iniciar criando um array com todas as datas entre o início e o final do negócio
	'Pesquisar nas bases de Receber e Despesas para ver quando iniciaram os movimentos de caixa
	Dim dbFaturas As New NotesDatabase(session.CurrentDatabase.Server,"faturas.nsf")
	Dim viewReceber As NotesView
	Set viewReceber = dbFaturas.GetView("(Receber/Negocio)")
	Dim dbDespesas As New NotesDatabase(session.CurrentDatabase.Server,"caixa.nsf")
	Dim viewDespesas As NotesView
	Set viewDespesas = dbDespesas.GetView("(DespesasNegocio)")
	Dim despesa As NotesDocument
	Dim receber As NotesDocument
	Dim primeiraDataDesp As NotesDateTime
	Dim primeiraDataRec As NotesDateTime
	Dim datasDescpTmp() As String
	Dim valoresDespTmp() As Double
	Dim valoresRecTmp() As Double
	Dim datasRecTmp() As String
	Dim dataFinal As NotesDateTime
	Dim dbBancos As New NotesDatabase(session.CurrentDatabase.Server,"bancos.nsf")
	Dim viewCapitalGiro As NotesView
	Dim hoje As New NotesDateTime(Today)
	Dim anos() As Integer, meses() As Integer
	Dim datasFatores() As String, valoresFatores() As Double, fatorIOF() As Double
	Dim ckAno As Integer, ckMes As Integer
	Dim comparaMesPeriodo As String, comparaMesHoje As String
	Dim contaMeses As NotesDateTime, contaMesesSimulacao As NotesDateTime
	Dim resultado As Integer
	Dim saldoInicial As Double, saldoFinal As Double,  saida As Double, entrada As Double,fator As Double, osJuros As Double, totJuros As Double, valIOF As Double
	Dim totIOF As Double, totIOC As Double
	Dim totJurosReais As Double, totJurosFuturos As Double
	Dim maiorSaldo As Double 'para calcular o IOC
	Dim periodoFinal As String, scanPeriodo As String
	Dim comissaoHoje As Double, capitalGiroHoje As Double
	Dim periodo As String, mes As String, ckPeriodo As String, simula As Double, simulaIOF As Double, simulaIOC
	Dim scanData As NotesDateTime
	Dim ultimaDataDesp As NotesDateTime, ultimaDataRec As NotesDateTime, estaData As NotesDateTime
	Dim diasContaNegativa As Double, valorMedioNegativo As Double
	Dim scan As Integer
	
	Dim datas() As Variant 'vai guardar todas entre a primeira despesa/receber até a conclusão do negócio
	Dim saidas() As Double, entradas() As Double, saldos() As Double, fatores() As Double, juros() As Double
	Dim ckIOC As Integer
	
	Dim dcDespesas As NotesDocumentCollection
	Dim dcReceber As NotesDocumentCollection
	
	ReDim preserve saldosFinais(0) As Double 'declaro duas vezes para nao dar problema se nao houverem desp nem receitas no negocio
	
	Dim codigo As String
	
	Dim negocio As NotesDocument
	Dim obs As String, ioc As Double, somaSaldos As Double
	
	Set negocio = negocios.GetFirstDocument
	Do Until negocio Is Nothing
		
		codigo = negocio.Codigo(0)
		saldoInicial = 0
		saldoFinal = 0
		totIOC = 0
		totJuros = 0
		totIOF = 0
		obs = ""
		ioc = 0
		somaSaldos = 0
		diasContaNegativa = 0
		valorMedioNegativo = 0

		Set dcDespesas = viewDespesas.GetAllDocumentsByKey(codigo, True)
		Set despesa = viewDespesas.GetDocumentByKey(codigo, True)
		Set dcReceber = viewReceber.GetAlldocumentsByKey(codigo, True)
		Set receber = viewReceber.GetDocumentByKey(codigo, True)
		If receber Is Nothing And despesa Is Nothing Then
			'MsgBox("Não houve movimento financeiro neste negócio")
			'print codigo + " - " + "Não houve movimento nesse negócio"
			obs = "Não houve movimento nesse negócio"
			GoTo semDetalhamento
		End If
		'Teve Receber mas não teve Despesas - LMO 12/12/24
		If despesa Is Nothing Then
			obs = "Não houve despesas nesse negócio"
			GoTo semDetalhamento
		End If
		
		
		Dim dataInicial As NotesDateTime
		
		'===============================================================================
		'certificando de estar pegando a última data do documentcollection das despesas
		'===============================================================================
		scan = 0
		Set doc = dcDespesas.GetFirstDocument
		If dcDespesas.Count > 0 Then
			Set ultimaDataDesp = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
			Set primeiraDataDesp = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
			Do Until doc Is Nothing
				ReDim Preserve datasDespTmp(scan) As String
				ReDim Preserve valoresDespTmp(scan) As Double
				datasDespTmp(scan) = DateValue(doc.VencimentoDespesa(0))
				valoresDespTmp(scan) = doc.TotTot(0)
				Set estaData = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
				If estaData.TimeDifference(ultimaDataDesp) > 0 Then
					Set ultimaDataDesp = session.CreateDateTime( estaData.DateOnly )
				End If
				If estaData.TimeDifference(primeiraDataDesp) <= 0 Then
					Set primeiraDataDesp = session.CreateDateTime( estaData.DateOnly )
				End If
				scan = scan+1
				Set doc = dcDespesas.GetNextDocument(doc)
			Loop
		End If
		'==================================================================================
		'Populando a matriz temporária de RECEBER e definindo qual a última data do receber
		'==================================================================================
		
		If dcReceber.Count > 0 Then
			scan = 0
			Set doc = dcReceber.GetFirstDocument
			Set ultimaDataRec = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
			Set primeiraDataRec = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
			Do Until doc Is Nothing
				ReDim Preserve datasRecTmp(scan) As String
				ReDim Preserve valoresRecTmp(scan) As Double
				datasRecTmp(scan) = DateValue(doc.Prorrogacao(0))
				valoresRecTmp(scan) = doc.TotTot(0)
				Set estaData = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
				If estaData.TimeDifference(ultimaDataRec) > 0 Then
					Set ultimaDataRec = session.CreateDateTime( estaData.DateOnly )
				End If
				If estaData.TimeDifference(primeiraDataRec) <= 0 Then
					Set primeiraDataRec = session.CreateDateTime( estaData.DateOnly )
				End If
				scan = scan+1
				Set doc = dcReceber.GetNextDocument(doc)
			Loop
		Else
			Set ultimaDataRec = session.CreateDateTime(ultimaDataDesp.DateOnly)
			Set primeiraDataRec = session.CreateDateTime(primeiraDataDesp.DateOnly)
		End If
		
		'================================================================================
		'Definindo a data final - a ultima data entre a ultima DESPESA e o ultimo RECEBER
		'================================================================================
		
		If primeiraDataDesp.TimeDifference(primeiraDataRec) <= 0 Then
			Set dataInicial = session.CreateDateTime( primeiraDataDesp.DateOnly )
		Else
			Set dataInicial = session.CreateDateTime( primeiraDataRec.DateOnly )
			obs = obs + " - Receber foi antes"
		End If
		
		If ultimaDataRec.TimeDifference(ultimaDataDesp) > 0 Then
			Set dataFinal = session.CreateDateTime( ultimaDataRec.DateOnly )
		Else
			Set dataFinal = session.CreateDateTime( ultimaDataDesp.DateOnly )
		End If
		
		Set scanData = session.CreateDateTime(dataInicial.DateOnly)
		scan = 0
		Do Until scanData.TimeDifference(dataFinal) > 0
			ReDim Preserve datas(scan)
			ReDim Preserve saldosIniciais(scan)
			ReDim Preserve entradas(scan)
			ReDim Preserve saidas(scan)
			ReDim Preserve saldosFinais(scan)
			ReDim Preserve fatores(scan)
			ReDim Preserve aliqIOF(scan) 'aliq de 0,0041% incide diariamente
			ReDim Preserve valorIOF(scan)
			ReDim Preserve juros(scan)
			ReDim Preserve comissoes(scan)
			datas(scan) = scanData.DateOnly
			Call scanData.AdjustDay(1)
			scan = scan + 1
		Loop
		
		'================================================================================================
		'populando a matriz de FATORES e IOF a partir dos dados contidos na vista Custo Capital de Giro em Bancos
		'em uma simulação pode ocorrer um caso onde datas futuras entram na simulacao. Vamos usar data de hoje para futuro
		'aproveitar e popular a matriz IOF que é fixa mensal
		'================================================================================================
		
		Set viewCapitalGiro = dbBancos.GetView("Custo Capital de Giro")
		
		' Definindo quantos meses devo buscar nas taxas de juros para fazer apenas um acesso a disco
		
		'====================================================================================
		'analisando se o periodo sendo analisado é anterior ou posterior ao mes da data atual
		'se for "depois" será usado o último índice existente no sistema. 
		'será uma SIMULACAO, já que não temos índices futuros
		'====================================================================================
		scan = 0
		
		Set contaMeses = session.CreateDateTime(DataInicial.DateOnly)
		Set contaMesesSimulacao = session.CreateDateTime(DataInicial.DateOnly)
		
		If Len(CStr(Month(dataFinal.LSGMTTime))) = 1 Then
			periodoFinal = CStr(Year(dataFinal.LSGMTTime)+"/0"+Cstr(Month(dataFinal.LSGMTTime)))
		Else
			periodoFinal = CStr(Year(dataFinal.LSGMTTime)+"/"+Cstr(Month(dataFinal.LSGMTTime)))
		End If
		If Len(CStr(Month(contaMeses.LSGMTTime))) = 1 Then
			scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/0"+Cstr(Month(contaMeses.LSGMTTime)))
		Else
			scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/"+Cstr(Month(contaMeses.LSGMTTime)))
		End If
		
		Do While scanPeriodo <= periodoFinal		
			ReDim Preserve anos(scan) As Integer
			mes = CStr(Month(contaMeses.LSLocalTime))
			If Len(mes) = 1 Then mes = "0" + mes
			periodo = CStr(Year(contaMeses.LSLocalTime)) + "/" + mes
			'analisando se a simulação está sendo feita em um mês futuro onde iremos utilizar o último fator como base de simulacao
			'========================
			'precisamos acrescenter um zero no mes para que a comparacao nao coloque periodos como 2014/4 sendo maior que 2014/10.
			If Len(CStr(Month(contaMeses.LSLocalTime))) = 1 Then
				comparaMesPeriodo = "0"+CStr(Month(contaMeses.LSLocalTime))
			Else
				comparaMesPeriodo = CStr(Month(contaMeses.LSLocalTime))
			End If 
			If Len(CStr(Month(Today))) = 1 Then
				comparaMesHoje = "0"+CStr(Month(contaMeses.LSLocalTime))
			Else
				comparaMesHoje = CStr(Month(Today))
			End If 			
			If CStr(Year(contaMeses.LSLocalTime)) + "/" +  comparaMesPeriodo < CStr(Year(Today)) + "/" + comparaMesHoje Then
				'MsgBox(CStr(Year(contaMeses.LSLocalTime)) + "/" +  CStr(Month(contaMeses.LSLocalTime)) + " --- " + CStr(Year(Today)) + "/" + CStr(Month(Today)))
				ckPeriodo = "antes"			
			Else
				ckPeriodo = "depois"
			End If
			Set doc = viewCapitalGiro.GetDocumentByKey(periodo, True)
			If doc Is Nothing And ckPeriodo = "antes" Then
				'MsgBox("Fator não encontrado na base Bancos - Vista Custo Capital de Giro. Favor criar o documento")
				'MsgBox( codigo + " - " + periodo + " - " + "Fator não encontrado")
				obs = "- Fator não está no sistema - "
				GoTo fatorNaoEncontrado
			End If
			ReDim Preserve datasFatores(scan) As String
			ReDim Preserve valoresFatores(scan) As Double
			ReDim Preserve fatorIOF(scan) As Double
			If ckPeriodo = "antes" Then  
				datasFatores(scan) = periodo
				valoresFatores(scan ) = doc.Fator(0)
				fatorIOF(scan) = doc.IOF(0)
				simula = doc.Fator(0)
				simulaIOF = doc.IOF(0)
			Else
				'se a primeira data do negócio for em um mês futuro, simula fica igual a zero.
				'neste caso, temos que voltar um mês no período para encontrar um simula diferente de zero
				If simula = 0 Then
					Do While simula = 0
						'procurar o último fator anterior à primeira despesa/receita do negocio
						mes = CStr(Month(contaMesesSimulacao.LSLocalTime))
						If Len(mes) = 1 Then mes = "0" + mes
						Set doc = viewCapitalGiro.GetDocumentByKey(CStr(Year(contaMesesSimulacao.LSLocalTime)) + "/" + mes, True)
						If Not (doc Is Nothing) Then							
							datasFatores(scan) = periodo ' fica o período correto com os fatores de mes anterior
							valoresFatores(scan) = doc.Fator(0)
							fatorIOF(scan) = doc.IOF(0)
							simula = doc.Fator(0)
							simulaIOF = doc.IOF(0)
						End If
						Call contaMesesSimulacao.Adjustmonth(-1)
					Loop
				Else
					datasFatores(scan) = periodo
					valoresFatores(scan ) = simula
					fatorIOF(scan) = simulaIOF
				End If
			End If
			Call contaMeses.AdjustMonth(1)
			If Len(CStr(Month(contaMeses.LSGMTTime))) = 1 Then
				scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/0"+Cstr(Month(contaMeses.LSGMTTime)))
			Else
				scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/"+Cstr(Month(contaMeses.LSGMTTime)))
			End If
			scan = scan + 1
		Loop
		
		'=====================================================================
		'Populando a matriz de FATORES para posterior calculo de juros diários
		'=====================================================================
		scan = 0
		Do While scan <= UBound(datas)
			mes =  CStr(Month(CDat(datas(scan))))
			If Len(mes) = 1 Then mes = "0" + mes
			periodo = CStr(Year(CDat(datas(scan)))) + "/" + mes
			fatores(scan) = valoresFatores(ArrayGetIndex(datasFatores, periodo))
			aliqIOF(scan) = fatorIOF(ArrayGetIndex(datasFatores, periodo))
			scan = scan + 1
		Loop 
		
		'para economizar acessos a disco e reduzir a quantidade de índices estou buscando uma técnica para fazer em memória
		'para isto irei copiar o conteúdo do document collection para a array temporária
		
		'=====================================================================
		'Populando a matriz SAIDAS com os dados das DESPESAS
		'Como o arraygetindex só pega a primeira ocorrencia do search, copio a ocorrencia encontrada, deleto e tento novamente até acabar com todas.
		'======================================================================
		
		maiorSaldo = 0
		scan = 0
		Do While scan <= UBound(datas)
			If scan = 336 Then STOP
			saida = 0
			entrada = 0
			'Verificando se há valor de saída na data do loop
			If dcDespesas.Count > 0 Then
				Do While Not (IsNull(ArrayGetIndex(  datasDespTmp, CStr(datas(scan))))) 
					resultado = ArrayGetIndex(  datasDespTmp, CStr(datas(scan)))
					'saídas negativas são créditos de impostos que não podem ser consideradas entradas reais de caixa
					'If valoresDespTmp(resultado)> 0 then
					saida = saida + valoresDespTmp(resultado)
					'End if 
					datasDespTmp(resultado) = "99/99/9999"	
				Loop 	
			End If
			'Verificando se há uma "entrada" na data do loop
			If dcReceber.Count > 0 Then		
				Do While Not (IsNull(ArrayGetIndex(  datasRecTmp, CStr(datas(scan))))) 
					resultado = ArrayGetIndex(  datasRecTmp, CStr(datas(scan)))
					entrada  = entrada + valoresRecTmp(resultado)
					datasRecTmp(resultado) = "99/99/9999"
				Loop 			
			End If
			If scan > 0 Then
				saldoInicial = saldosFinais(scan-1) + juros(scan-1) + valorIOF(scan-1)
				saldoFinal = saldoInicial + entrada - saida
				If saldoFinal < 0 Then 
					'esta conta não faz sentido, pois se o projeto fica muito tempo com valor negativo pequeno a média nao faz sentido
					diasContaNegativa = diasContaNegativa + 1
					valorMedioNegativo = valorMedioNegativo + saldoFinal
				End If
			Else
				saldoInicial = 0
				saldoFinal = entrada - saida
			End If
			
			
			'calculando os juros do dia
			If saldoFinal < 0 Then
				osJuros = saldoFinal * (fatores(scan)-1)
				valIOF = saldoFinal * aliqIOF(scan)
			Else
				osJuros = 0
				valIOF = 0
			End If
			
			saldosIniciais(scan) = saldoInicial
			saidas(scan) = saida
			entradas(scan) = entrada
			saldosFinais(scan) = saldoFinal
			juros(scan) = osJuros
			valorIOF(scan) = valIOF		
			comissoes(scan) = saldoFinal * negocio.Comissao(0) 	
			If CDat(datas(scan)) = Today Then
				comissaoHoje = comissoes(scan)
				capitalGiroHoje = saldosFinais(scan)
			End If
			
			totJuros = totJuros + osJuros 
			'Em um contrato de longo prazo os juros futuros são apenas uma conjuctura, partindo-se do pressuposto que o cliente nao pagará as parcelas
			'pois apenas as saídas estão programadas e as entradas não estão.
			If CDat(datas(scan)) > Today Then
				totJurosFuturos = totJurosFuturos + osJuros
			Else
				totJurosReais = totJurosReais + osJuros
			End If
			
			totIOF = totIOF + valIOF
			
			saida = 0
			entrada = 0
			scan = scan + 1
			
		Loop
		'=======================================================================================
		'Calcular IOC - sempre que o saldo sair de zero será utilizado o maior valor para colocar 0,0038 de IOC
		'calculando maior saldo para aplicar o IOC que é um imposto único cobrado sobre o maior valor utilizado de empréstimo
		'=======================================================================================
		
		maiorSaldo = 0
		ioc = 0
		ckIOC = 1
		For scan = 0 To UBound(saldosFinais)
			If scan > 0 Then
				If saldosFinais(scan) < 0 Then
					If saldosFinais(scan) < maiorSaldo Then 
						maiorSaldo = saldosFinais(scan)'a comparação é negativa pois a saída é um num negativo
					End If
				ElseIf saldosFinais(scan) > 0 And saldosFinais(scan-1) < 0 Then 'pegar a soma do bloco anterior e multiplicar para IOC
					ioc = ioc + (maiorSaldo * 0.0038)
					'MsgBox(codigo + " - Fechei o bloco " + CStr(ckIOC) + " - Maior Saldo -> " + CStr(maiorSaldo) + " - Saldo Final -> " + CStr(saldosFinais(scan))+ " IOC -> " + CStr(ioc))					
					maiorSaldo = 0
					ckIOC = ckIOC +1					
				End If
			Else
				If saldosFinais(0) < 0 Then maiorSaldo = saldosFinais(0)
			End If
		Next scan
		If ckIOC > 2 Then
			obs = obs + " - mais de um bloco de conta de IOC"
		End If

fatorNaoEncontrado: 'para achar os fatores que precisam ser criados
		totIOC = ioc

		
		
		
		GoTo fimDoLoop
		'====================================================================================
		'=== SEM DETALHAMENTO 0 FUNCAO RTF
		'====================================================================================		

semDetalhamento: 'vem pra cá se não houver movimentação ou se o limite do campo for excedito 
		'Call negocio.ReplaceItemValue("WC_Datas", "")
		'Call negocio.ReplaceItemValue("WC_Saidas", 0)
		'Call negocio.ReplaceItemValue("WC_Entradas", 0)
		'Call negocio.ReplaceItemValue("WC_SaldosIniciais", 0)
		'Call negocio.ReplaceItemValue("WC_Fatores", 0)
		'Call negocio.ReplaceItemValue("WC_SaldosFinais", 0)
		'Call negocio.ReplaceItemValue("WC_AliqIOFs", 0)
		'Call negocio.ReplaceItemValue("WC_ValorIOFs", 0)
		'Call negocio.ReplaceItemValue("WC_Juros", 0)
		'Call negocio.ReplaceItemValue("WC_SaldoDoDia", 0)
fimDoLoop:
		Call negocio.ReplaceItemValue("WC_Obs", obs)
		Call negocio.ReplaceItemValue("WC_TotJuros", totJuros)
		Call negocio.ReplaceItemValue("WC_TotJurosReais", totJurosReais)
		Call negocio.ReplaceItemValue("WC_TotJurosFuturos", totJurosFuturos)
		Call negocio.ReplaceItemValue("WC_ComissaoHoje", comissaoHoje)
		Call negocio.ReplaceItemValue("WC_TotIOF", totIOF)
		Call negocio.ReplaceItemValue("WC_TotIOC", totIOC)
		Call negocio.ReplaceItemValue("WC_Total", totJuros+totIOF+ totIOC)
		Call negocio.ReplaceItemValue("WC_DataInicial", dataInicial)
		Call negocio.ReplaceItemValue("WC_DataFinal", dataFinal)
		Call negocio.ReplaceItemValue("WC_Dias", diasContaNegativa)
		Call negocio.ReplaceItemValue("WC_SaldoDoDia", capitalGiroHoje)
		Call negocio.ReplaceItemValue("WC_SaldoDoDiaProjetado", saldosFinais(UBound(saldosFinais))) 'ultima posicao da matriz tem o saldo final
		If diasContaNegativa > 0 Then
			Call negocio.ReplaceItemValue("WC_ValorMedio", valorMedioNegativo/diasContaNegativa)
		End If
		'Call negocio.Save(True, True)
		Set negocio = negocios.GetNextDocument(negocio)
	Loop
	Exit Sub
		
End Sub

'++LotusScript Development Environment:2:2:GeraDespesasServicosInternos:5:8
%REM
	Sub GeraDespesasServicosInternos
	Description: Comments for Sub
%END REM
Sub GeraDespesasServicosInternos(principal As NotesDocument, adendo As NotesDocument)
	
	If Val(adendo.Venda_P(0)) = 0 Then Exit Sub
	Dim scan As Integer
	Dim negocio As NotesDocument
	For scan = 0 To 1
		If scan = 0 Then Set negocio = principal Else Set negocio = adendo
		If negocio.CheckPagtoServicosInternos(0) = "OK" Then Exit Sub
		Dim doc As Variant, ccDespesa As Variant
		Dim venc As New NotesDateTime(Today)
		Call venc.Adjustday(1)
		Set doc = New ccDespesa(negocio)
		doc.Origem = "Negócio - " & negocio.Codigo(0)
		doc.Codigo = negocio.Codigo(0)
		doc.Sit = "OK"
		doc.Classificacao = "Transferência Interna"
		doc.Area = negocio.AreaVendas(0)
		doc.Responsavel = negocio.AreaVendas(0)
		doc.Data = Today
		doc.Vencimento = venc.DateOnly
		doc.Adianta = True
		If negocio.Classe(0) = "Adendo" Then
			doc.Descricao = "Transferência Interna Adendo - " & negocio.Codigo(0)
			doc.Valor = Round(adendo.Venda_P(0), 2) * -1
		Else
			doc.Descricao = "Transferência Interna Negócio Principal - " & negocio.Codigo(0)
			doc.Valor = Round(adendo.Venda_P(0), 2)
		End If
		doc.TipoCompra = negocio.TipoCompra(0)
		doc.TipoVenda = negocio.TipoVenda(0)
		Call doc.Save
		negocio.CheckPagtoServicosInternos = "OK"
	Next
	
End Sub

'++LotusScript Development Environment:2:2:Perda:5:8
%REM
	Sub Perda
	Description: Comments for Sub
%END REM
Sub Perda(negocio As NotesDocument)
	
	Call MgReal(negocio)
	Call AnalisePerda(negocio)
	If negocio.Sit(0) = "Consolidado" And negocio.NovoCodigo(0) <> "" Then
		'Consolidação das Despesas e Time Sheets para o Novo Negócio
		Call AlteraDespesas(negocio)
		Call AlteraTimeSheets(negocio)
	ElseIf negocio.Sit(0) = "Perdido" Then
		'Alteração da Classificação das Despesas
		Call AlteraDespesas(negocio)
	End If
	
End Sub

'++LotusScript Development Environment:2:2:AvisoParticipacao:5:8
%REM
	Sub AvisoParticipacao
	Description: Comments for Sub
%END REM
Sub AvisoParticipacao(negocio As NotesDocument, fase As String, nome As String, valor As Double, vencimento As String)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim corpo As NotesRichTextItem
	Dim memo As NotesDocument
	'Estilo do Email
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	'Aviso Participacao
	Set memo = New NotesDocument(session.CurrentDatabase)
	memo.Form = "Memo"
	'memo.SendTo = nome
	memo.CopyTo = "Marcelo Castro/TDec"
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	memo.Subject = "-> Participação da " & fase & " de " & nome & ": " & negocio.Codigo(0)
	Set corpo = New NotesRichTextItem(memo, "Body")
	Call corpo.AppendStyle(richStyle)
	Call corpo.Appendtext("Responsável: " & nome)
	Call corpo.AddNewLine(1)
	Call corpo.Appendtext("Valor da Participação: R$ " & Format(valor, "Standard"))
	Call corpo.AddNewLine(1)
	Call corpo.Appendtext("Data para Pagamento: " & Format(vencimento, "dd/mm/yyyy"))
	Call corpo.AddNewLine(2)
	Call corpo.Appendtext("Negócio: " & negocio.Codigo(0) & " (" & negocio.Descricao(0) & ")")
	Call corpo.AddNewLine(1)
	Call corpo.Appendtext("Descrição: " & "Participação da " & fase & " de " & negocio.Area(0) & " - " & negocio.Codigo(0))
	Call corpo.AddNewLine(1)
	Call corpo.Appendtext("Parceria: " & negocio.Parceria(0))
	Call corpo.AddNewLine(1) 
	Call corpo.Appendtext("Link para o Negócio -> ")
	Call corpo.AppendDocLink(negocio, "Link para o Negócio" )
	Call corpo.AddNewLine(2)
	Call corpo.Appendtext("TDec Network Group.")
	Call memo.Send(False)
	MsgBox "Participação da " & fase & " Gerada para " & nome & " no valor de " & Format(valor, "standard"), 64, "Aviso"
	
End Sub

'++LotusScript Development Environment:2:2:AvisoConclusaoNegocio:5:8
%REM
	Sub AvisoConclusao
	Description: Comments for Sub
%END REM
Sub AvisoConclusaoNegocio(negocio As NotesDocument,newDoc As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim memo As NotesDocument
	Dim recipients(1) As String
	Dim rtitem As NotesRichTextItem
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	recipients(0) = "Marcelo Castro/TDec"
	recipients(1) = "Junior Castro/TDec"
	Set db = session.Currentdatabase
	Set memo = New NotesDocument(db)
	memo.SendTo = recipients
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	memo.Form = "Memo"
	'Negócio FOB
	If negocio.CheckNegocioFOB(0) = "OK" Then
		memo.Subject = "-> Conclusão de " & newDoc.TipoVenda(0) & " FOB: " & newDoc.Codigo(0)
	Else
		memo.Subject = "-> Conclusão de " & newDoc.TipoVenda(0) & ": " & newDoc.Codigo(0)
	End If
	Set rtitem = memo.CreateRichTextItem( "Body" )
	Call rtitem.AppendStyle( richStyle )
	Call rtitem.AddNewLine( 1 )
	Call rtitem.Appendtext( "Negócio: " )
	Call rtitem.AppendDocLink( negocio, "Link para o Negócio" )
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "Parceria: " & negocio.Parceria(0) )
	Call rtitem.AddNewLine( 1 )
	Call newDoc.RenderToRTItem( rtitem )
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "Atenciosamente," )
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "TDec Network Group" )
	Call memo.Send(False)
	
End Sub

'++LotusScript Development Environment:2:2:GeraCapitalGiro64K:7:8
%REM
	Sub geraCapitalGiro64K
	Description: Versao para gerar o capital de giro com tres campos de 64K.
	Se primeiro campo passar de 64 cria os demais campos.
	--- Nao está em uso. Usamos apenas o CalcCapitalGiroReal
%END REM
Sub GeraCapitalGiro64K(negocios As NotesDocumentCollection)
	
	'On Error GoTo tratamentoErro
	Dim session As New NotesSession
	Dim doc As NotesDocument
	'Iniciar criando um array com todas as datas entre o início e o final do negócio
	'Pesquisar nas bases de Receber e Despesas para ver quando iniciaram os movimentos de caixa
	Dim dbFaturas As New NotesDatabase(session.CurrentDatabase.Server,"faturas.nsf")
	Dim viewReceber As NotesView
	Set viewReceber = dbFaturas.GetView("(Receber/Negocio)")
	Dim dbDespesas As New NotesDatabase(session.CurrentDatabase.Server,"caixa.nsf")
	Dim viewDespesas As NotesView
	Set viewDespesas = dbDespesas.GetView("(DespesasNegocio)")
	Dim despesa As NotesDocument
	Dim receber As NotesDocument
	Dim primeiraDataDesp As NotesDateTime
	Dim primeiraDataRec As NotesDateTime
	Dim datasDescpTmp() As String
	Dim valoresDespTmp() As Double
	Dim valoresRecTmp() As Double
	Dim datasRecTmp() As String
	Dim dataFinal As NotesDateTime
	Dim dbBancos As New NotesDatabase(session.CurrentDatabase.Server,"bancos.nsf")
	Dim viewCapitalGiro As NotesView
	Dim hoje As New NotesDateTime(Today)
	Dim anos() As Integer, meses() As Integer
	Dim datasFatores() As String, valoresFatores() As Double, fatorIOF() As Double
	Dim ckAno As Integer, ckMes As Integer
	Dim comparaMesPeriodo As String, comparaMesHoje As String
	Dim contaMeses As NotesDateTime, contaMesesSimulacao As NotesDateTime
	Dim resultado As Integer
	Dim saldoInicial As Double, saldoFinal As Double,  saida As Double, entrada As Double,fator As Double, osJuros As Double, totJuros As Double, valIOF As Double
	Dim totIOF As Double, totIOC As Double
	Dim totJurosReais As Double, totJurosFuturos As Double
	Dim comissaoHoje As Double, capitalGiroHoje As DOuble
	Dim maiorSaldo As Double 'para calcular o IOC
	Dim periodoFinal As String, scanPeriodo As String
	Dim periodo As String, mes As String, ckPeriodo As String, simula As Double, simulaIOF As Double, simulaIOC
	Dim scanData As NotesDateTime
	Dim ultimaDataDesp As NotesDateTime, ultimaDataRec As NotesDateTime, estaData As NotesDateTime
	Dim diasContaNegativa As Double, valorMedioNegativo As Double
	Dim scan As Integer
	
	Dim datas() As Variant 'vai guardar todas entre a primeira despesa/receber até a conclusão do negócio
	Dim saidas() As Double, entradas() As Double, saldos() As Double, fatores() As Double, juros() As Double, comissoes() As Double
	Dim ckIOC As Integer
	
	Dim dcDespesas As NotesDocumentCollection
	Dim dcReceber As NotesDocumentCollection
	
	ReDim Preserve saldosFinais(0) As Double 'declaro duas vezes para nao dar problema se nao houverem desp nem receitas no negocio
	
	Dim codigo As String
	
	Dim negocio As NotesDocument
	Dim obs As String, ioc As Double, somaSaldos As Double
	
	Set negocio = negocios.GetFirstDocument
	Do Until negocio Is Nothing
		
		codigo = negocio.Codigo(0)
		saldoInicial = 0
		saldoFinal = 0
		totIOC = 0
		totJuros = 0
		totIOF = 0
		obs = ""
		ioc = 0
		somaSaldos = 0
		diasContaNegativa = 0
		valorMedioNegativo = 0
		
		'Print codigo
		Set dcDespesas = viewDespesas.GetAllDocumentsByKey(codigo, True)
		Set despesa = viewDespesas.GetDocumentByKey(codigo, True)
		Set dcReceber = viewReceber.GetAlldocumentsByKey(codigo, True)
		Set receber = viewReceber.GetDocumentByKey(codigo, True)
		If receber Is Nothing And despesa Is Nothing Then
			'MsgBox("Não houve movimento financeiro neste negócio")
			'print codigo + " - " + "Não houve movimento nesse negócio"
			Call negocio.ReplaceItemValue("WC_Obs","Não houve movimento nesse negócio 64k")
			Call negocio.ReplaceItemValue("WC_Datas", "")
			Call negocio.ReplaceItemValue("WC_Saidas", 0)
			Call negocio.ReplaceItemValue("WC_Entradas", 0)
			Call negocio.ReplaceItemValue("WC_SaldosIniciais", 0)
			Call negocio.ReplaceItemValue("WC_Fatores", 0)
			Call negocio.ReplaceItemValue("WC_SaldosFinais", 0)
			Call negocio.ReplaceItemValue("WC_AliqIOFs", 0)
			Call negocio.ReplaceItemValue("WC_ValorIOFs", 0)
			Call negocio.ReplaceItemValue("WC_Juros", 0)
			Call negocio.ReplaceItemValue("WC_SaldoDoDia", 0)
			Call negocio.save(True, True)
			'GoTo semDetalhamento
			Exit sub
		End If
		Dim dataInicial As NotesDateTime
		
		'===============================================================================
		'certificando de estar pegando a última data do documentcollection das despesas
		'===============================================================================
		scan = 0
		Set doc = dcDespesas.GetFirstDocument
		If dcDespesas.Count > 0 Then
			Set ultimaDataDesp = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
			Set primeiraDataDesp = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
			Do Until doc Is Nothing
				ReDim Preserve datasDespTmp(scan) As String
				ReDim Preserve valoresDespTmp(scan) As Double
				datasDespTmp(scan) = DateValue(doc.VencimentoDespesa(0))
				valoresDespTmp(scan) = doc.TotTot(0)
				Set estaData = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
				If estaData.TimeDifference(ultimaDataDesp) > 0 Then
					Set ultimaDataDesp = session.CreateDateTime( estaData.DateOnly )
				End If
				If estaData.TimeDifference(primeiraDataDesp) <= 0 Then
					Set primeiraDataDesp = session.CreateDateTime( estaData.DateOnly )
				End If
				scan = scan+1
				Set doc = dcDespesas.GetNextDocument(doc)
			Loop
		End If
		'==================================================================================
		'Populando a matriz temporária de RECEBER e definindo qual a última data do receber
		'==================================================================================
		
		If dcReceber.Count > 0 Then	
			scan = 0
			Set doc = dcReceber.GetFirstDocument
			Set ultimaDataRec = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
			Set primeiraDataRec = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
			Do Until doc Is Nothing
				ReDim Preserve datasRecTmp(scan) As String
				ReDim Preserve valoresRecTmp(scan) As Double
				datasRecTmp(scan) = DateValue(doc.Prorrogacao(0))
				valoresRecTmp(scan) = doc.TotTot(0)
				Set estaData = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
				If estaData.TimeDifference(ultimaDataRec) > 0 Then
					Set ultimaDataRec = session.CreateDateTime( estaData.DateOnly )
				End If
				If estaData.TimeDifference(primeiraDataRec) <= 0 Then
					Set primeiraDataRec = session.CreateDateTime( estaData.DateOnly )
				End If
				scan = scan+1
				Set doc = dcReceber.GetNextDocument(doc)
			Loop
		Else
			Set ultimaDataRec = session.CreateDateTime(ultimaDataDesp.DateOnly)
			Set primeiraDataRec = session.CreateDateTime(primeiraDataDesp.DateOnly)
		End If
		
		'================================================================================
		'Definindo a data final - a ultima data entre a ultima DESPESA e o ultimo RECEBER
		'================================================================================
		
		If primeiraDataDesp.TimeDifference(primeiraDataRec) <= 0 Then
			Set dataInicial = session.CreateDateTime( primeiraDataDesp.DateOnly )
		Else
			Set dataInicial = session.CreateDateTime( primeiraDataRec.DateOnly )
			obs = obs + " - Receber foi antes"
		End If
		
		If ultimaDataRec.TimeDifference(ultimaDataDesp) > 0 Then
			Set dataFinal = session.CreateDateTime( ultimaDataRec.DateOnly )
		Else
			Set dataFinal = session.CreateDateTime( ultimaDataDesp.DateOnly )
		End If
		
		Set scanData = session.CreateDateTime(dataInicial.DateOnly)
		scan = 0
		Do Until scanData.TimeDifference(dataFinal) > 0
			ReDim Preserve datas(scan)
			ReDim Preserve saldosIniciais(scan)
			ReDim Preserve entradas(scan)
			ReDim Preserve saidas(scan)
			ReDim Preserve saldosFinais(scan)
			ReDim Preserve fatores(scan)
			ReDim Preserve aliqIOF(scan) 'aliq de 0,0041% incide diariamente
			ReDim Preserve valorIOF(scan)
			ReDim Preserve juros(scan)
			ReDim Preserve comissoes(scan)
			datas(scan) = scanData.DateOnly
			Call scanData.AdjustDay(1)
			scan = scan + 1
		Loop
		
		'================================================================================================
		'populando a matriz de FATORES e IOF a partir dos dados contidos na vista Custo Capital de Giro em Bancos
		'em uma simulação pode ocorrer um caso onde datas futuras entram na simulacao. Vamos usar data de hoje para futuro
		'aproveitar e popular a matriz IOF que é fixa mensal
		'================================================================================================
		
		Set viewCapitalGiro = dbBancos.GetView("Custo Capital de Giro")
		
		' Definindo quantos meses devo buscar nas taxas de juros para fazer apenas um acesso a disco
		
		'====================================================================================
		'analisando se o periodo sendo analisado é anterior ou posterior ao mes da data atual
		'se for "depois" será usado o último índice existente no sistema. 
		'será uma SIMULACAO, já que não temos índices futuros
		'====================================================================================
		scan = 0
		
		Set contaMeses = session.CreateDateTime(DataInicial.DateOnly)
		Set contaMesesSimulacao = session.CreateDateTime(DataInicial.DateOnly)
		
		If Len(CStr(Month(dataFinal.LSGMTTime))) = 1 Then
			periodoFinal = CStr(Year(dataFinal.LSGMTTime)+"/0"+Cstr(Month(dataFinal.LSGMTTime)))
		Else
			periodoFinal = CStr(Year(dataFinal.LSGMTTime)+"/"+Cstr(Month(dataFinal.LSGMTTime)))
		End If
		If Len(CStr(Month(contaMeses.LSGMTTime))) = 1 Then
			scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/0"+Cstr(Month(contaMeses.LSGMTTime)))
		Else
			scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/"+Cstr(Month(contaMeses.LSGMTTime)))
		End If
		
		Do While scanPeriodo <= periodoFinal		
			ReDim Preserve anos(scan) As Integer
			mes = CStr(Month(contaMeses.LSLocalTime))
			If Len(mes) = 1 Then mes = "0" + mes
			periodo = CStr(Year(contaMeses.LSLocalTime)) + "/" + mes
			'analisando se a simulação está sendo feita em um mês futuro onde iremos utilizar o último fator como base de simulacao
			'========================
			'precisamos acrescenter um zero no mes para que a comparacao nao coloque periodos como 2014/4 sendo maior que 2014/10.
			If Len(CStr(Month(contaMeses.LSLocalTime))) = 1 Then
				comparaMesPeriodo = "0"+CStr(Month(contaMeses.LSLocalTime))
			Else
				comparaMesPeriodo = CStr(Month(contaMeses.LSLocalTime))
			End If 
			If Len(CStr(Month(Today))) = 1 Then
				comparaMesHoje = "0"+CStr(Month(contaMeses.LSLocalTime))
			Else
				comparaMesHoje = CStr(Month(Today))
			End If 
			
			If CStr(Year(contaMeses.LSLocalTime)) + "/" +  comparaMesPeriodo < CStr(Year(Today)) + "/" + comparaMesHoje Then
				'MsgBox(CStr(Year(contaMeses.LSLocalTime)) + "/" +  CStr(Month(contaMeses.LSLocalTime)) + " --- " + CStr(Year(Today)) + "/" + CStr(Month(Today)))
				ckPeriodo = "antes"			
			Else
				ckPeriodo = "depois"
			End If
			Set doc = viewCapitalGiro.GetDocumentByKey(periodo, True)
			If doc Is Nothing And ckPeriodo = "antes" Then
				'MsgBox("Fator não encontrado na base Bancos - Vista Custo Capital de Giro. Favor criar o documento")
				'MsgBox( codigo + " - " + periodo + " - " + "Fator não encontrado")
				obs = "- Fator não está no sistema - "
				Dim memoF As New NotesDocument(session.currentdatabase)
				memoF.Form = "Memo"
				memoF.Subject = "ERRO - Cálculo de Capital de Giro. Favor Criar o Fator  <"+CStr(Year(contaMeses.LSLocalTime)) + "/" +  comparaMesPeriodo +"> na Base de Dados BANCOS"
				Call memoF.Send(False,"Marcelo Castro/TDec")
				'GoTo fatorNaoEncontrado
			End If
			ReDim Preserve datasFatores(scan) As String
			ReDim Preserve valoresFatores(scan) As Double
			ReDim Preserve fatorIOF(scan) As Double
			If ckPeriodo = "antes" Then  
				datasFatores(scan) = periodo
				valoresFatores(scan ) = doc.Fator(0)
				fatorIOF(scan) = doc.IOF(0)
				simula = doc.Fator(0)
				simulaIOF = doc.IOF(0)
			Else
				'se a primeira data do negócio for em um mês futuro, simula fica igual a zero.
				'neste caso, temos que voltar um mês no período para encontrar um simula diferente de zero
				If simula = 0 Then
					Do While simula = 0
						'procurar o último fator anterior à primeira despesa/receita do negocio
						mes = CStr(Month(contaMesesSimulacao.LSLocalTime))
						If Len(mes) = 1 Then mes = "0" + mes
						Set doc = viewCapitalGiro.GetDocumentByKey(CStr(Year(contaMesesSimulacao.LSLocalTime)) + "/" + mes, True)
						If Not (doc Is Nothing) Then							
							datasFatores(scan) = periodo ' fica o período correto com os fatores de mes anterior
							valoresFatores(scan ) = doc.Fator(0)
							fatorIOF(scan) = doc.IOF(0)
							simula = doc.Fator(0)
							simulaIOF = doc.IOF(0)
						End If
						Call contaMesesSimulacao.Adjustmonth(-1)
					Loop
				Else
					datasFatores(scan) = periodo
					valoresFatores(scan ) = simula
					fatorIOF(scan) = simulaIOF
				End If
			End If
			Call contaMeses.AdjustMonth(1)
			If Len(CStr(Month(contaMeses.LSGMTTime))) = 1 Then
				scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/0"+Cstr(Month(contaMeses.LSGMTTime)))
			Else
				scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/"+Cstr(Month(contaMeses.LSGMTTime)))
			End If
			scan = scan + 1
		Loop
		
		'=====================================================================
		'Populando a matriz de FATORES para posterior calculo de juros diários
		'=====================================================================
		scan = 0
		Do While scan <= UBound(datas)
			mes =  CStr(Month(CDat(datas(scan))))
			If Len(mes) = 1 Then mes = "0" + mes
			periodo = CStr(Year(CDat(datas(scan)))) + "/" + mes
			fatores(scan) = valoresFatores(ArrayGetIndex(datasFatores, periodo))
			aliqIOF(scan) = fatorIOF(ArrayGetIndex(datasFatores, periodo))
			scan = scan + 1
		Loop 
		
		'para economizar acessos a disco e reduzir a quantidade de índices estou buscando uma técnica para fazer em memória
		'para isto irei copiar o conteúdo do document collection para a array temporária
		
		'==========================================================
		'Populando a matriz SAIDAS com os dados das DESPESAS
		'Como o arraygetindex só pega a primeira ocorrencia do search, copio a ocorrencia encontrada, deleto e tento novamente até acabar com todas.
		'============================================================
		
		maiorSaldo = 0
		scan = 0
		Do While scan <= UBound(datas)
			saida = 0
			entrada = 0
			'Verificando se há valor de saída na data do loop
			If dcDespesas.Count > 0 Then
				Do While Not (IsNull(ArrayGetIndex(  datasDespTmp, CStr(datas(scan))))) 
					resultado = ArrayGetIndex(  datasDespTmp, CStr(datas(scan)))
					'saídas negativas são créditos de impostos que não podem ser consideradas entradas reais de caixa
					'If valoresDespTmp(resultado)> 0 then
					saida = saida + valoresDespTmp(resultado)
					'End if 
					datasDespTmp(resultado) = "99/99/9999"	
				Loop 	
			End If
			'Verificando se há uma "entrada" na data do loop
			If dcReceber.Count > 0 Then		
				Do While Not (IsNull(ArrayGetIndex(  datasRecTmp, CStr(datas(scan))))) 
					resultado = ArrayGetIndex(  datasRecTmp, CStr(datas(scan)))
					entrada  = entrada + valoresRecTmp(resultado)
					datasRecTmp(resultado) = "99/99/9999"
				Loop 			
			End If
			If scan > 0 Then
				saldoInicial = saldosFinais(scan-1) + juros(scan-1) + valorIOF(scan-1)
				saldoFinal = saldoInicial + entrada - saida
				If saldoFinal < 0 Then 
					'esta conta não faz sentido, pois se o projeto fica muito tempo com valor negativo pequeno a média nao faz sentido
					diasContaNegativa = diasContaNegativa + 1
					valorMedioNegativo = valorMedioNegativo + saldoFinal
				End If
			Else
				saldoInicial = 0
				saldoFinal = entrada - saida
			End If
			
			
			'calculando os juros do dia
			If saldoFinal < 0 Then
				osJuros = saldoFinal * (fatores(scan)-1)
				valIOF = saldoFinal * aliqIOF(scan)
			Else
				osJuros = 0
				valIOF = 0
			End If
			
			saldosIniciais(scan) = saldoInicial
			saidas(scan) = saida
			entradas(scan) = entrada
			saldosFinais(scan) = saldoFinal
			juros(scan) = osJuros
			valorIOF(scan) = valIOF
			comissoes(scan) = saldoFinal * negocio.Comissao(0) 
			If CDat(datas(scan)) = Today Then
				comissaoHoje = comissoes(scan)
				capitalGiroHoje = saldosFinais(scan)
			End If
					
			totJuros = totJuros + osJuros 
			'Em um contrato de longo prazo os juros futuros são apenas uma conjuctura, partindo-se do pressuposto que o cliente nao pagará as parcelas
			'pois apenas as saídas estão programadas e as entradas não estão.
			If CDat(datas(scan)) > Today Then
				totJurosFuturos = totJurosFuturos + osJuros
			Else
				totJurosReais = totJurosReais + osJuros
			End If
			
			totIOF = totIOF + valIOF
			
			saida = 0
			entrada = 0
			scan = scan + 1
			
		Loop 
		'=======================================================================================
		'Calcular IOC - sempre que o saldo sair de zero será utilizado o maior valor para colocar 0,0038 de IOC
		'calculando maior saldo para aplicar o IOC que é um imposto único cobrado sobre o maior valor utilizado de empréstimo
		'=======================================================================================
		
		maiorSaldo = 0
		ioc = 0
		ckIOC = 1
		For scan = 0 To UBound(saldosFinais)
			If scan > 0 Then
				If saldosFinais(scan) < 0 Then
					If saldosFinais(scan) < maiorSaldo Then 
						maiorSaldo = saldosFinais(scan)'a comparação é negativa pois a saída é um num negativo
					End If
				ElseIf saldosFinais(scan) > 0 And saldosFinais(scan-1) < 0 Then 'pegar a soma do bloco anterior e multiplicar para IOC
					ioc = ioc + (maiorSaldo * 0.0038)
					'MsgBox(codigo + " - Fechei o bloco " + CStr(ckIOC) + " - Maior Saldo -> " + CStr(maiorSaldo) + " - Saldo Final -> " + CStr(saldosFinais(scan))+ " IOC -> " + CStr(ioc))					
					maiorSaldo = 0
					ckIOC = ckIOC +1					
				End If
			Else
				If saldosFinais(0) < 0 Then maiorSaldo = saldosFinais(0)
			End If
		Next scan
		If ckIOC > 2 Then
			obs = obs + " - mais de um bloco de conta de IOC"
		End If
		
'fatorNaoEncontrado: 'se o período for anterior a hoje e o fator não existir, o mesmo tem que ser criado. Neste caso a rotina pula para cá.
		stop
		
		Dim numcampo As Integer, contaKB As Long
		numcampo = 0
		Dim itDatas As NotesItem, itSaidas As NotesItem, itEntradas As NotesItem
		Dim itSaldosIniciais As NotesItem, itFatores As NotesItem, itSaldosFinais As NotesItem
		Dim itAliqIOFs As NotesItem, itValorIOFs As NotesItem, itJuros As NotesItem, itSaldoDoDia As NotesItem
		Dim itComissoes As NotesItem
		'limpando negócios antigos que tinham campos ainda com mais de 32K e nao estava gravando GRUPOSHC-139
		negocio.Removeitem("WC_Datas" & CStr(numcampo))
		negocio.Removeitem("WC_Saidas" & CStr(numcampo))
		negocio.Removeitem("WC_Entradas" & CStr(numcampo))
		negocio.Removeitem("WC_SaldosIniciais" & CStr(numcampo))
		negocio.Removeitem("WC_Fatores" & CStr(numcampo))
		negocio.Removeitem("WC_SaldosFinais" & CStr(numcampo))
		negocio.Removeitem("WC_AliqIOFs" & CStr(numcampo))
		negocio.Removeitem("WC_ValorIOFs" & CStr(numcampo))
		negocio.Removeitem("WC_Juros" & CStr(numcampo))
		negocio.Removeitem("WC_Comissoes" & CStr(numcampo))
		contaKB = 999999
		For numcampo = 0 To 7			
				'Limpando os documentos antigos com campos que foram utilizados a mais
				negocio.Removeitem("WC_Datas_" & CStr(numcampo))
				negocio.Removeitem("WC_Saidas_" & CStr(numcampo))
				negocio.Removeitem("WC_Entradas_" & CStr(numcampo))
				negocio.Removeitem("WC_SaldosIniciais_" & CStr(numcampo))
				negocio.Removeitem("WC_Fatores_" & CStr(numcampo))
				negocio.Removeitem("WC_SaldosFinais_" & CStr(numcampo))
				negocio.Removeitem("WC_AliqIOFs_" & CStr(numcampo))
				negocio.Removeitem("WC_ValorIOFs_" & CStr(numcampo))
				negocio.Removeitem("WC_Juros_" & CStr(numcampo))
				negocio.Removeitem("WC_Comissoes_" & CStr(numcampo))
		next
		numcampo = 0
		For scan = 0 To UBound(datas)			
			If contaKB > 640000 then			
				contaKB = 0
				numcampo = numcampo + 1
				'repete-se a declaracao para a criacao dos campos _2, _3, _4, _5, _6, _7
				negocio.Removeitem("WC_Datas_" & CStr(numcampo))
				negocio.Removeitem("WC_Saidas_" & CStr(numcampo))
				negocio.Removeitem("WC_Entradas_" & CStr(numcampo))
				negocio.Removeitem("WC_SaldosIniciais_" & CStr(numcampo))
				negocio.Removeitem("WC_Fatores_" & CStr(numcampo))
				negocio.Removeitem("WC_SaldosFinais_" & CStr(numcampo))
				negocio.Removeitem("WC_AliqIOFs_" & CStr(numcampo))
				negocio.Removeitem("WC_ValorIOFs_" & CStr(numcampo))
				negocio.Removeitem("WC_Juros_" & CStr(numcampo))
				negocio.Removeitem("WC_Comissoes_" & CStr(numcampo))
				'cria-se novamente os campos
				Set itDatas = New NotesItem(negocio,"WC_Datas_" & CStr(numcampo),"")
				Set itSaidas = New NotesItem(negocio,"WC_Saidas_" & CStr(numcampo),"")
				Set itEntradas = New NotesItem(negocio,"WC_Entradas_" & CStr(numcampo),"")
				Set itSaldosIniciais = New NotesItem(negocio,"WC_SaldosIniciais_" & CStr(numcampo),"")
				Set itFatores = New NotesItem(negocio,"WC_Fatores_" & CStr(numcampo),"")
				Set itSaldosFinais = New NotesItem(negocio,"WC_SaldosFinais_" & CStr(numcampo),"")
				Set itAliqIOFs = New NotesItem(negocio,"WC_AliqIOFs_" & CStr(numcampo),"")
				Set itValorIOFs = New NotesItem(negocio,"WC_ValorIOFs_" & CStr(numcampo),"")
				Set itJuros = New NotesItem(negocio,"WC_Juros_" & CStr(numcampo),"")
				Set itComissoes = New NotesItem(negocio,"WC_Comissoes_" & CStr(numcampo),"")
				'Set itSaldoDoDia = negocio.Getfirstitem("WC_SaldoDoDia_" & CStr(numcampo))
				itDatas.IsSummary = False
				itSaidas.Issummary = False
				itEntradas.Issummary = False
				itSaldosIniciais.Issummary = False
				itFatores.Issummary = False
				itSaldosFinais.Issummary = False
				itAliqIOFs.Issummary = False
				itValorIOFs.Issummary = False
				itJuros.Issummary = False
				itComissoes.Issummary = False
				'itSaldoDoDia.Issummary = false
			End If
			'Print "Numcampo "+ CStr(numcampo) + ":" + CStr(itFatores.ValueLength) + " / " + CStr(contaKB)
			Call itDatas.AppendToTextList(datas(scan))	
			Call itSaidas.Appendtotextlist(Format(CStr(saidas(scan)),"Standard"))
			Call itEntradas.Appendtotextlist(Format(CStr(entradas(scan)),"Standard"))
			Call itSaldosIniciais.Appendtotextlist(Format(CStr(saldosIniciais(scan)),"Standard"))
			Call itFatores.Appendtotextlist(CStr(fatores(scan)))
			Call itAliqIOFs.Appendtotextlist(CStr(aliqIOF(scan)))
			Call itValorIOFs.Appendtotextlist(Format(CStr(valorIOF(scan)),"Standard"))
			Call itJuros.Appendtotextlist(Format(CStr(juros(scan)),"Standard"))		
			Call itComissoes.Appendtotextlist(Format(CStr(comissoes(scan)),"Standard"))
			Call itSaldosFinais.Appendtotextlist(Format(CStr(saldosFinais(scan)),"Standard"))	
			'Call itSaldoDoDia.Appendtotextlist(saldosFinais(UBound(datas))) 'nao entendi...
			contaKB = contaKB + itFatores.ValueLength
		Next
		totIOC = ioc
		Call negocio.ReplaceItemValue("WC_Obs", obs)
		Call negocio.ReplaceItemValue("WC_TotJuros", totJuros)
		Call negocio.ReplaceItemValue("WC_TotJurosReais", totJurosReais)
		Call negocio.ReplaceItemValue("WC_TotJurosFuturos", totJurosFuturos)
		Call negocio.ReplaceItemValue("WC_ComissaoHoje", comissaoHoje)
		Call negocio.ReplaceItemValue("WC_TotIOF", totIOF)
		Call negocio.ReplaceItemValue("WC_TotIOC", totIOC)
		Call negocio.ReplaceItemValue("WC_Total", totJuros+totIOF+ totIOC)
		Call negocio.ReplaceItemValue("WC_DataInicial", dataInicial)
		Call negocio.ReplaceItemValue("WC_DataFinal", dataFinal)
		Call negocio.ReplaceItemValue("WC_Dias", diasContaNegativa)
		Call negocio.ReplaceItemValue("WC_SaldoDoDia", capitalGiroHoje)		
		Call negocio.ReplaceItemValue("WC_SaldoDoDiaProjetado", saldosFinais(UBound(saldosFinais))) 'ultima posicao da matriz tem o saldo final
		
		If diasContaNegativa > 0 Then
			Call negocio.ReplaceItemValue("WC_ValorMedio", valorMedioNegativo/diasContaNegativa)
		End If
		Call negocio.Save(True, True)	
		Set negocio = negocios.GetNextDocument(negocio)
	Loop
	
End Sub

'++LotusScript Development Environment:2:2:CalcFatoresImportacao:6:8
%REM
	Sub CalcFatoresImportacao - mcastro 29/01/2015
	Description: Utilizado no subform Importacao do Negócio.
	Calcula o fator de importacao item por item ao invés de usar o antigo 1,85 flat
%END REM
Sub CalcFatoresImportacao(uidoc As NotesUIDocument)
		
	Dim scan As Integer
	Dim check As integer
	Dim qvar As Integer
	check = 0
	For scan = 0 To 49
		qvar = Val(uidoc.FieldGetText("Q_" & scan))
		If qvar > 0 Then
			check = check + 1
			ReDim Preserve numeroDoItem(scan) As integer			
			ReDim Preserve itens(scan) As String
			ReDim Preserve partno(scan) As String
			numeroDoItem(scan) = scan
			itens(scan) = uidoc.FieldGetText("Produto_" & scan)
			partno(scan) = uidoc.FieldGetText("PartNo_" & scan)
		End If
	Next
	If  check = 0 Then
		MsgBox("Nenhum produto na lista de materiais " + CStr(scan))
		Exit Sub
	End If	
	
	Dim session As New NotesSession
	Dim dbEstoque As NotesDatabase
	
	Set dbEstoque = session.Getdatabase(session.Currentdatabase.Server,"estoquemain.nsf")
	Dim viewEstoque As NotesView
	Set viewEstoque = dbEstoque.Getview("(Catalogo/PartNumber)")
	Dim doc As NotesDocument
	Dim ii As Double, ipi As Double, icms As Double
	Dim baseii As Double, baseipi As Double, baseicms As Double, x As double
	x = 1
	For scan = 0 To UBound(partno)
		Set doc = viewEstoque.Getdocumentbykey(partno(scan),True)
		ReDim Preserve fatorItem(scan) As Double
		ii = doc.II(0)
		ipi = doc.IPI(0)
		icms = doc.ICMS(0)
		baseii = x + (x * ii)
		baseipi = baseii + (baseii * ipi)
		baseicms = baseipi + (baseipi * icms)
		fatorItem(scan) = baseicms
	Next
	
	Call uidoc.Document.Replaceitemvalue("ImportacaoItens", partno)
	Call uidoc.Document.Replaceitemvalue("ImportacaoFatorItem", fatorItem)
	
End Sub

'++LotusScript Development Environment:2:2:CalcTotaisPO:1:8
Sub CalcTotaisPO(doc As NotesDocument)
	
	Dim scan As Integer, total As Double, totalPago As Double, totalPagar As Double, totalICMSST As Double
	Dim pago As Integer, pagar As Variant, us As Variant, qvar As Variant, custoUnit As Variant, icmsst As Variant
	Dim moeda As Double
	For scan = 0 To 49
		qvar = doc.GetItemValue("Q_" & scan)
		If CStr(qvar(0)) <> "" Then
			us = doc.GetItemValue("Us_" & scan)
			If us(0) = "US$C" Then
				moeda = doc.USC(0)
			ElseIf us(0) = "US$T" Then
				moeda = doc.UST(0)
			ElseIf us(0) = "R$" Then
				moeda = 1
			End If
			custoUnit = doc.GetItemValue("CustoUnit_" & scan)
			pagar = doc.GetItemValue("S_" & scan)
			icmsst = doc.GetItemValue("ICMSST_" & scan)
			pago = qvar(0) - Val(pagar(0))
			total = total + (qvar(0) * CDbl(custoUnit(0)) * moeda)
			totalPago = totalPago + (pago * CDbl(custoUnit(0)) * moeda)
			totalPagar = totalPagar + (Val(pagar(0)) * CDbl(custoUnit(0)) * moeda)
			If CStr(icmsst(0)) <> "" Then
				totalICMSST = totalICMSST + (CDbl(icmsst(0)) * moeda)
			End If
		End If
	Next 
	doc.TotTot = total
	doc.TotPago = totalPago
	doc.TotPagar = totalPagar
	doc.TotICMSST = totalICMSST
	
End Sub

'++LotusScript Development Environment:2:2:GeraDespesaCapitalGiro:5:8
%REM
	Sub GeraDespesas
	Description: Comments for Sub
%END REM
Sub GeraDespesaCapitalGiro(negocio As NotesDocument)
	
	If negocio.CheckPagtoCapitalGiro(0) = "OK" Then Exit Sub
	If negocio.Juros_R(0) > 0 Then
		'1)Gera Despesas do Negócio
		Dim doc As Variant, ccDespesa As Variant
		Dim venc As New NotesDateTime(Today)
		Set venc = New NotesDateTime("15/" & Month(venc.Dateonly) & "/" & Year(venc.Dateonly))
		Call venc.Adjustmonth(1)
		Set doc = New ccDespesa(negocio)
		doc.Origem = "Negócio - " & negocio.Codigo(0)
		doc.Codigo = negocio.Codigo(0)
		doc.Sit = "Pendente"
		doc.Classificacao = "Custo Capital de Giro"
		doc.Area = negocio.AreaVendas(0)
		doc.Responsavel = negocio.AreaVendas(0)
		doc.Data = Today
		doc.Vencimento = venc.DateOnly
		doc.Adianta = True
		doc.Descricao = "Capital de Giro de Negócio - " & negocio.Codigo(0)
		doc.Valor = Round(negocio.Juros_R(0), 2)
		doc.TipoCompra = negocio.TipoCompra(0)
		doc.TipoVenda = negocio.TipoVenda(0)
		Call doc.Save
		'2) Gera Despesas de Contrapartida para a Administração
		Set doc = New ccDespesa(negocio)
		doc.Origem = "Negócio - " & negocio.Codigo(0)
		doc.Codigo = "TDECREDES"
		doc.CodigoAnterior = negocio.Codigo(0)
		doc.Sit = "Pendente"
		doc.Classificacao = "Custo Capital de Giro"
		doc.Area = "Administração"
		doc.Responsavel = "Administração"
		doc.Data = Today
		doc.Vencimento = venc.DateOnly
		doc.Adianta = True
		doc.Descricao = "Contrapartida de Capital de Giro de Negócio - " & negocio.Codigo(0)
		doc.Valor = Round(negocio.Juros_R(0), 2) * (-1)
		doc.TipoCompra = negocio.TipoCompra(0)
		doc.TipoVenda = negocio.TipoVenda(0)
		Call doc.Save
	End If
	negocio.CheckPagtoCapitalGiro = "OK"
	
End Sub

'++LotusScript Development Environment:2:2:SaldoServicosAFaturar:1:8
Sub SaldoServicosAFaturar(uidoc As NotesUiDocument)
	
	Dim listas As New NotesDatabase(uidoc.Document.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Set view = listas.GetView("(NegocioNServicos)")
	Dim doc As NotesDocument
	Dim dc As NotesDocumentCollection  
	Dim item As NotesDocument
	Dim array As Variant, scan As Integer
	Dim codigo As String, icms As Double
	Dim flag As Variant, boxtype As Long, answer As Integer
	codigo$ = uidoc.FieldGetText("Codigo")
	Dim ckFind As Variant
	ckFind = False
	For scan% = 0 To 11		
		Set doc = view.getDocumentByKey( codigo$ & "-" & Cstr(scan% + 1) )
		If Not( doc Is Nothing ) Then
			Call uidoc.FieldSetText( "VlFat_" & Cstr( scan%), Format( Cstr( doc.CusTots(0) - doc.VlFat(0) ), "Standard" ) )
			ckFind = True
		End If
	Next
	
End Sub

'++LotusScript Development Environment:2:1:CkProjeto:5:8
%REM
	Sub CheckStatusProjeto
	Description: Comments for Sub
%END REM
Function CkProjeto(negocio As NotesDocument) As Boolean
	
	CkProjeto = True
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Set view = db.GetView("(ProjetosCodigo)")
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		If doc.Sit(0) <> "Concluído" Then
			CkProjeto = False
		Else
			negocio.DataConclusaoProjeto = doc.Encerramento(0)
		End If
	End If
		
End Function

'++LotusScript Development Environment:2:1:TemConteudo:1:8
Function TemConteudo(doc As NotesDocument) As Boolean
	
	'1) Verifica Lista de Materiais, Serviços e Matriz de Tarifação do Negócio
	'Verifica conteúdo na Lista de Materiais e Lista de Serviços - LMO 07/01/19
	Dim scan As Integer
	'Lista de Materiais
	For scan = 0 To 49
		If doc.Getitemvalue("Produto_"& scan)(0) <> "" Then
			TemConteudo = True
			Exit Function
		End If	
	Next
	'Lista de Serviços
	For scan = 0 To 49
		If doc.Getitemvalue("Produtos_"& scan)(0) <> "" Then
			TemConteudo = True
			Exit Function
		End If	
	Next
	'Matriz de Tarifação
	For scan = 0 To 49
		If doc.Getitemvalue("CProdutos_"& scan)(0) <> "" Then
			TemConteudo = True
			Exit Function
		End If	
	Next
	%REM - LMO 07/01/19
	If doc.TotalNegocio(0) > 0 Then
		TemConteudo = True
		Exit Function
	End If
	%END REM
	'2) Verifica Proposta Eletrônica
	Dim rtitem As NotesRichTextItem
	If doc.Hasitem("LinkPropostas") Then
		Set rtitem = doc.GetFirstItem("LinkPropostas")
		If Not IsEmpty(rtitem.EmbeddedObjects) Then
			TemConteudo = True
			Exit Function
		End If         
	End If
	'3) Verifica Anexos: Proposta
	If doc.Hasitem("Propostas") Then
		Set rtitem = doc.GetFirstItem("Propostas")
		If Not IsEmpty(rtitem.EmbeddedObjects) Then
			TemConteudo = True
			Exit Function
		End If
	End If
	'4) Verifica Anexos: Escopo do Projeto
	If doc.Hasitem("Projeto") Then
		Set rtitem = doc.GetFirstItem("Projeto")
		If Not IsEmpty(rtitem.EmbeddedObjects) Then
			TemConteudo = True
			Exit Function
		End If
	End If
	
End Function


'++LotusScript Development Environment:2:2:CancelaFaturasReceber:5:8
%REM
	Sub CancelaFaturasReceber
	Description: Comments for Sub
%END REM
Sub CancelaFaturasReceber(negocio As NotesDocument)
	
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection, dcReceber As NotesDocumentCollection
	Dim doc As NotesDocument, receber As NotesDocument
	Dim cont As Integer
	Set view = db.GetView("(EspelhosNegocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.Getfirstdocument()
	'Verifica documentos Pendentes
	Do Until doc Is Nothing
		If doc.Sit(0) = "A Emitir" Then
			cont = cont + 1
			Exit Do
		End If
		Set doc = dc.Getnextdocument(doc)
	Loop
	'Confirma Cancelamento
	If cont > 0 Then
		If MessageBox("Você confirma o Cancelamento das Faturas, Recibos e Receber Pendentes do Contrato?", 4+32+256+4096, "Cancelar Faturas do Contrato") <> 6 Then
			Exit Sub
		End If
	Else
		MsgBox "Não há Faturas, Recibos e Receber " & Chr(34) & " A Emitir " & Chr(34) & " no Contrato.", 64, "Aviso"
		Exit Sub
	End If
	'Cancela documentos Pendentes
	Dim dataFinal As New NotesDateTime(negocio.DataConclusao(0))
	If negocio.TipoPagamento(0) = "Postecipado" Then Call dataFinal.Adjustmonth(1, True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If doc.Sit(0) = "A Emitir" Then
			If CDat(doc.DataFaturamento(0)) > CDat(dataFinal.Dateonly) Then
				'Verifica Status Receber
				Set dcReceber = doc.Responses
				Set receber = dcReceber.Getfirstdocument()
				Do Until receber Is Nothing
					If receber.Sit(0) = "OK" Then
						GoTo proximo
					End If
					Set receber = dcReceber.Getnextdocument(receber)
				Loop
				'Atualiza Espelho
				doc.Sit = "Cancelada"
				doc.ResponsavelC = negocio.RespConclusao(0)
				doc.DataC = negocio.DataConclusao(0)
				doc.Valor = 0
				doc.Valor2 = 0
				doc.Valor3 = 0
				doc.Valor4 = 0
				doc.TotTotComIPI = 0
				doc.TotTot = 0
				Call doc.Save(False, False)
				'Atualiza Receber
				Set receber = dcReceber.Getfirstdocument()
				Do Until receber Is Nothing
					If receber.Sit(0) = "a Receber" Then
						receber.Sit = "OK"
						receber.Pagamento = dataFinal.Dateonly
						receber.ValorReceber = 0
						receber.Multa = 0
						receber.Juros = 0
						receber.Desconto = 0
						receber.TotTot = 0
						Call receber.Save(False, False)
					End If
				Set receber = dcReceber.Getnextdocument(receber)
				Loop
			End If
		End If
proximo:
		Set doc = dc.Getnextdocument(doc)
	Loop
	MsgBox "Faturas, Recibos e Receber do Contrato cancelados.", 64, "Aviso"
	
End Sub

'++LotusScript Development Environment:2:1:GetPrazoPlanejamento:5:8
%REM
	Function GetPrazoPlanejamento
	Description: Comments for Function
%END REM
Function GetPrazoPlanejamento(prazo As Integer) As String
	
	'Calcula Previsão do Planejamento - busca em configProjeto, Prazo de Revisão - 1 dia
	Dim data As New NotesDateTime(Today)
	Dim scan As Integer
	Do Until scan = prazo
		Call data.AdjustDay(1)
		If Weekday(data.DateOnly) <> 1 And Weekday(data.DateOnly) <> 7 And Not ckFeriado(data.DateOnly) Then
			scan = scan + 1
		End If
	Loop
	GetPrazoPlanejamento = data.DateOnly
	
End Function


'++LotusScript Development Environment:2:2:PopulaListaMateriais:1:8
Sub PopulaListaMateriais(doc As NotesDocument)
	
	'On Error Resume Next
	Dim scan As Integer, scan2 As Integer
	Dim protocolo As Variant, cargaMedia As Variant, aliqICMS As Variant, aliqICMSCompra As Variant, cusTot As Variant, array As Variant, catalogo As Variant, impostos As Variant, fabricante As Variant, ip As Variant, ipc As Variant, indice As Variant
	Dim icc As Double, ic As Double, fob As Double, fi As Double, icmsOP As Double, icST as Double, qtd As Double, custo As Double, custoUnit As Double, icmsST As Double, icmsSTC As Double, fatorBC As Double, bc As Double, saldo As Long
	Dim aliquotaPIS As Double, aliquotaCOFINS As Double
	Dim contribuinte As String, ufCompra As String
	Dim suframa As Boolean, nacional As Boolean, ckExcecao As Boolean
	If doc.Form(0) <> "Projeto" And doc.Form(0) <> "CotacaoFinanceira" Then
		'Verifica Cliente
		array = CkEmpresa(doc)
		'Inscrição Estadual
		If IsNumeric(array(0)) Then
			contribuinte = "Sim"
		ElseIf array(0) = "" Then
			contribuinte = "?"
		Else
			contribuinte = "Não"
		End If
		doc.Contribuinte = contribuinte
	End If
	'Alíquotas dos Impostos
	Call BuscaRegrasFiscais(doc)
	'Suframa
	doc.MembroSuframa = ""
	doc.InscricaoSuframa = ""
	If doc.Form(0) <> "Projeto" And doc.Form(0) <> "CotacaoFinanceira" Then
		'Venda para Fora de SP
		If doc.UF(0) <> "SP" Then
			'Busca Alíquota Interestadual do ICMS
			aliqICMS = BuscaICMS("SP", doc.UF(0), contribuinte)	
			'Suframa - LMO 29/11/16
			If CkSuframa("SP", doc.UF(0)) Then
				If array(1) = "" Or array(1) = "--" Then
					doc.MembroSuframa = "?"
				ElseIf array(1) = "sim" Then
					suframa = True
					doc.MembroSuframa = "Sim"
					doc.InscricaoSuframa = array(2)
				End If
			End If
		Else
			doc.MembroSuframa = "Não"
			doc.InscricaoSuframa = ""
		End If
		'PIS - Exceção Tributária do Cliente (Lista de Serviços e Matriz de Tarifação) - LMO 01/09/17
		indice = ArrayGetIndex(doc.Tributos, "PIS")
		If Not IsNull(indice) And Not suframa And doc.Beneficio(0) <> "Não" Then
			If doc.Tipos(indice) = "Redução" Then
				aliquotaPIS = doc.Reducao(indice)
			Else
				aliquotaPIS = 0
			End If
		Else
			aliquotaPIS = aliquota(0)
		End If
		doc.AliquotaPIS = aliquotaPIS
		'COFINS - Exceção Tributária do Cliente (Lista de Serviços e Matriz de Tarifação) - LMO 01/09/17
		indice = ArrayGetIndex(doc.Tributos, "COFINS")
		If Not IsNull(indice) And Not suframa And doc.Beneficio(0) <> "Não" Then
			If doc.Tipos(indice) = "Redução" Then
				aliquotaCOFINS = doc.Reducao(indice)
			Else
				aliquotaCOFINS = 0
			End If
		Else
			aliquotaCOFINS = aliquota(1)
		End If
		doc.AliquotaCOFINS = aliquotaCOFINS
	End If	
	'
	For scan = 0 To 49
		If doc.Getitemvalue("Produto_" & scan)(0) <> "" Then
			array = doc.Getitemvalue("Custo_" & scan)
			If CStr(array(0)) <> "" Then custo = array(0) Else custo = 0
			array = doc.Getitemvalue("CustoUnit_" & scan)
			If CStr(array(0)) <> "" Then custoUnit = array(0) Else custoUnit = 0
			array = doc.Getitemvalue("Q_" & scan)
			If CStr(array(0)) <> "" Then qtd = array(0) Else qtd = 0
			array = doc.Getitemvalue("CustoFOB_" & scan)
			If CStr(array(0)) <> "" Then fob = array(0) Else fob = 0
			array = doc.Getitemvalue("FI_" & scan)
			If CStr(array(0)) <> "" Then fi = array(0) Else fi = 0
			array = doc.Getitemvalue("PartNo_" & scan)
			catalogo = BuscaCatalogo(array(0))
			Call doc.Replaceitemvalue("CusTot_" & scan, custoUnit * qtd)
			'Produto Nacional?
			array = doc.Getitemvalue("ST_" & scan)
			If Left(array(0), 1) = "0" Or Left(array(0), 1) = "3" Or Left(array(0), 1) = "4" Or Left(array(0), 1) = "5" Then
				nacional = True
			Else
				nacional = False
			End If
			'Fabricante/Importador?
			array = doc.Getitemvalue("ST_" & scan)
			If (Left(array(0), 1) = "1" Or Left(array(0), 1) = "6") And Right(array(0), 2) <> "41" Then
				Call doc.Replaceitemvalue("Fabricante_" & scan, "S")
			ElseIf Left(array(0), 1) = "2" Or Left(array(0), 1) = "7" Then
				Call doc.Replaceitemvalue("Fabricante_" & scan, "N")
			End If
			'Popula Classificação Fiscal
			Call doc.Replaceitemvalue("CF_" & scan, catalogo(0))
			'Popula Unidade de Medida
			array = doc.Getitemvalue("Un_" & scan)
			If array(0) = "" Then
				Call doc.Replaceitemvalue("Un_" & scan, catalogo(1))
			End If
			'Popula Impostos
			array = doc.Getitemvalue("CF_" & scan)
			impostos = BuscaImpostos(array(0))
			ufCompra = doc.Getitemvalue("UFCompra_" & scan)(0)	
			'Atualiza Alíquotas dos Impostos apenas se o Item não foi Comprado
			If CheckDocListas(doc.Codigo(0), CStr(scan + 1), "Compra") Then
				'Popula Tipo
				Call doc.Replaceitemvalue("T_" & scan, catalogo(2))
				'Popula UF de Compra Default para Importação
				If fob > 0 Or fi > 0 Then
					Call doc.Replaceitemvalue("UFCompra_" & scan, "EX")
				Else
					If doc.Getitemvalue("UFCompra_" & scan)(0) = "EX" Then
						Call doc.Replaceitemvalue("UFCompra_" & scan, "")
					End If
				End If
				ufCompra = doc.Getitemvalue("UFCompra_" & scan)(0)
				'Limpa ICMSST de Compra
				array = doc.Getitemvalue("T_" & scan)
				If array(0) <> "HW" Or doc.TipoCompra(0) = "Remessa" Then
					Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
				Else
					array = doc.Getitemvalue("ST_" & scan)
					If Right(array(0), 2) <> "10" And Right(array(0), 2) <> "00" And Right(array(0), 2) <> "70" Then
						Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
					Else
						If Right(array(0), 2) = "00" Then
							If ufCompra = "SP" Or ufCompra = "EX" Then
								Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
							End If
						End If
					End If
				End If
				'Popula CST 100 para Importação TDec
				If fob > 0 Or fi > 0 Then
					Call doc.Replaceitemvalue("ST_" & scan, "100")
				End If
				'IPI de Compra e IPI de Venda - Consumo, Remessa, Ativo, Projeto (HW) 
				array = doc.Getitemvalue("T_" & scan)
				If array(0) = "HW" Then
					If doc.TipoCompra(0) = "Consumo" Or doc.TipoCompra(0) = "Remessa" Or doc.TipoCompra(0) = "Ativo" Or doc.TipoCompra(0) = "Projeto" Then
						fabricante = doc.Getitemvalue("Fabricante_" & scan)
						If fabricante(0) = "S" Then
							Call doc.Replaceitemvalue("IPC_" & scan, impostos(1))
						Else
							Call doc.Replaceitemvalue("IPC_" & scan, 0)
						End If
						Call doc.Replaceitemvalue("IP_" & scan, 0)
					End If
				End If
			End If
			'Atualiza IRRF de SW/SV - LMO 09/05/25
			If array(0) <> "HW" Then
				Call doc.Replaceitemvalue("ICC_" & scan, 0)
			End If
			'Atualiza Alíquotas dos Impostos apenas se o Item não foi Faturado
			If CheckDocListas(doc.Codigo(0), CStr(scan + 1), "Venda") Then
				array = doc.Getitemvalue("T_" & scan)
				'SW/SV
				If array(0) <> "HW" Then
					Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
					Call doc.Replaceitemvalue("ICD_" & scan, 0)
					Call doc.Replaceitemvalue("FCP_" & scan, 0)
					Call doc.Replaceitemvalue("II_" & scan, 0)
					Call doc.Replaceitemvalue("ICC_" & scan, 0)
					If array(0) = "SV" Then
						'IRRF
						If impostos(4) = 0 Then
							Call doc.Replaceitemvalue("IC_" & scan, 0.015)
						Else
							Call doc.Replaceitemvalue("IC_" & scan, impostos(4))
						End If
					Else
						Call doc.Replaceitemvalue("IC_" & scan, 0)
					End If
					Call doc.Replaceitemvalue("IPC_" & scan, 0)
					Call doc.Replaceitemvalue("IP_" & scan, 0)
					Call doc.Replaceitemvalue("AliquotaPIS_" & scan, aliquotaPIS)
					Call doc.Replaceitemvalue("AliquotaCOFINS_" & scan, aliquotaCOFINS)
					Call doc.Replaceitemvalue("IS_" & scan, impostos(3))
					Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
				'HW
				Else
					'Consumo
					If doc.TipoCompra(0) = "Consumo" Then
						Call doc.Replaceitemvalue("ICC_" & scan, 0)
						Call doc.Replaceitemvalue("IC_" & scan, 0)
						Call doc.Replaceitemvalue("ICD_" & scan, 0)
						Call doc.Replaceitemvalue("FCP_" & scan, 0)
						Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
						Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
						Call doc.Replaceitemvalue("AliquotaPIS_" & scan, 0)
						Call doc.Replaceitemvalue("AliquotaCOFINS_" & scan, 0)
					'Remessa, Ativo, Projeto
					ElseIf doc.TipoCompra(0) = "Remessa" Or (doc.TipoCompra(0) = "Ativo" And doc.TipoVenda(0) <> "Contrato") Or doc.TipoCompra(0) = "Projeto" Then
						array = doc.Getitemvalue("ST_" & scan)
						If doc.TipoCompra(0) = "Ativo" Or Right(array(0), 2) = "30" Or Right(array(0), 2) = "40" Or Right(array(0), 2) = "41" Or Right(array(0), 2) = "50" Or Right(array(0), 2) = "51" Then
							Call doc.Replaceitemvalue("ICC_" & scan, 0)
						Else
							'Compra de SP
							If ufCompra = "SP" Or ufCompra = "EX" Then
								Call doc.Replaceitemvalue("ICC_" & scan, impostos(0))
							'Compra de Fora de SP
							Else
								aliqICMSCompra = BuscaICMS(ufCompra, "SP", "Sim")
								If Left(array(0), 1) = "1" Or Left(array(0), 1) = "2" Or Left(array(0), 1) = "3" Or Left(array(0), 1) = "8" Then icc = aliqICMSCompra(1) Else icc = aliqICMSCompra(0)
								If Right(array(0), 2) = "00" Then
									Call doc.Replaceitemvalue("ICC_" & scan, icc)
								Else
									Call doc.Replaceitemvalue("ICC_" & scan, 0)
									'Alíquota do ICMS de Compra utilizada para abater o ICMS da BC Pis/Cofins - LMO 05/06/23
									If Right(array(0), 2) = "10" Then
										Call doc.Replaceitemvalue("ICMS_" & scan, icc)
									End If
								End If
							End If
						End If
						Call doc.Replaceitemvalue("IC_" & scan, 0)
						Call doc.Replaceitemvalue("ICD_" & scan, 0)
						Call doc.Replaceitemvalue("FCP_" & scan, 0)
						Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
						Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
						Call doc.Replaceitemvalue("AliquotaPIS_" & scan, aliquota(0))
						Call doc.Replaceitemvalue("AliquotaCOFINS_" & scan, aliquota(1))
					'Revenda
					Else
						'*** IPI de Compra ***
						fabricante = doc.Getitemvalue("Fabricante_" & scan)
						If fabricante(0) = "S" Then
							Call doc.Replaceitemvalue("IPC_" & scan, impostos(1))
						Else
							Call doc.Replaceitemvalue("IPC_" & scan, 0)
						End If
						'*** IPI de Venda ***
						If fob > 0 Or fi > 0 Then
							'Exceção Tributária - LMO 22/09/17
							ckExcecao = False
							If doc.Beneficio(0) <> "Não" Then
								For scan2 = 0 To UBound(doc.Tributos)
									If doc.Tributos(scan2) = "IPI" And doc.Beneficio(0) <> "Não" Then
										'Por NCM
										If doc.NCM(scan2) <> "" Then
											array = doc.Getitemvalue("CF_" & scan)
											If array(0) = doc.NCM(scan2) Then
												'Suframa Nacional
												'If doc.Suframa(scan2) = "sim" And nacional Then
												'Suframa - LMO 03/03/2020
												If doc.Suframa(scan2) = "sim" Then
													ckExcecao = True	
													'Cliente Geral
												ElseIf doc.Suframa(scan2) <> "sim" Then
													ckExcecao = True	
												End If
											End If
										'Geral
										Else
											'Suframa
											If doc.Suframa(scan2) = "sim" Then
												ckExcecao = True
											'Cliente Geral
											ElseIf doc.Suframa(scan2) <> "sim" Then
												ckExcecao = True
											End If
										End If
									End If
									If ckExcecao Then Exit For
								Next
							End If
							'Com Exceção Tributária
							If ckExcecao Then
								If doc.Tipos(scan2) = "Redução" Then
									Call doc.Replaceitemvalue("IP_" & scan, doc.Reducao(scan2))
								Else
									Call doc.Replaceitemvalue("IP_" & scan, 0)
								End If
							'Sem Exceção Tributária
							Else
								Call doc.Replaceitemvalue("IP_" & scan, impostos(1))
							End If
						Else
							Call doc.Replaceitemvalue("IP_" & scan, 0)
						End If
						'*** ICC ***
						'Compra de SP/EX
						If ufCompra = "SP" Or ufCompra = "EX" Then
							array = doc.Getitemvalue("ST_" & scan)
							'Substituição Tributária ou Isento
							If Right(array(0), 2) = "10" Or Right(array(0), 2) = "30" Or Right(array(0), 2) = "40" Or Right(array(0), 2) = "41" Or Right(array(0), 2) = "50" Or Right(array(0), 2) = "51" Or Right(array(0), 2) = "60" Or Right(array(0), 2) = "70" Or Right(array(0), 2) = "90" Then
								Call doc.Replaceitemvalue("ICC_" & scan, 0)
								'Alíquota do ICMS de Compra utilizada para abater o ICMS da BC Pis/Cofins - LMO 05/06/23
								If Right(array(0), 2) = "10"  Then
									Call doc.Replaceitemvalue("ICMS_" & scan, impostos(0))
								End If
							'Operação Crédito e Débito
							Else
								Call doc.Replaceitemvalue("ICC_" & scan, impostos(0))
							End If
						'Compra de Fora de SP
						Else
							'Atualiza Alíquotas dos Impostos apenas se o Item não foi Comprado - LMO 20/03/24
							If CheckDocListas(doc.Codigo(0), CStr(scan + 1), "Compra") Then
								aliqICMSCompra = BuscaICMS(ufCompra, "SP", "Sim")
								array = doc.Getitemvalue("ST_" & scan)
								If Left(array(0), 1) = "1" Or Left(array(0), 1) = "2" Or Left(array(0), 1) = "3" Or Left(array(0), 1) = "8" Then icc = aliqICMSCompra(1) Else icc = aliqICMSCompra(0)
								If Right(array(0), 2) = "00" Then
									'Verifica se tem Protocolo de Compra - LMO 01/11/16
									array = doc.Getitemvalue("CF_" & scan)
									protocolo = BuscaProtocolo(ufCompra, array(0), "Sim", "Compra")
									'Não encontrou Protocolo ou Protocolo Desatualizado
									If CStr(protocolo(0)) = "False" Then
										Call doc.Replaceitemvalue("ICC_" & scan, "?")
										'Encontrou Protocolo
									Else
										'Sem Protocolo
										If protocolo(0) = 0 Then
											Call doc.Replaceitemvalue("ICC_" & scan, icc)
											'Com Protocolo
										Else
											Call doc.Replaceitemvalue("ICC_" & scan, 0)
											'Alíquota do ICMS de Compra utilizada para abater o ICMS da BC Pis/Cofins - LMO 05/06/23
											Call doc.Replaceitemvalue("ICMS_" & scan, icc)
										End If
									End If
								ElseIf Right(array(0), 2) = "10" Or Right(array(0), 2) = "30" Or Right(array(0), 2) = "40" Or Right(array(0), 2) = "41" Or Right(array(0), 2) = "50" Or Right(array(0), 2) = "51" Or Right(array(0), 2) = "60" Or Right(array(0), 2) = "70" Or Right(array(0), 2) = "90" Then
									Call doc.Replaceitemvalue("ICC_" & scan, 0)
									'Alíquota do ICMS de Compra utilizada para abater o ICMS da BC Pis/Cofins - LMO 05/06/23
									If Right(array(0), 2) = "10"  Then
										Call doc.Replaceitemvalue("ICMS_" & scan, icc)
									End If
								End If
							End If
						End If
						'*** IC ***
						'Venda para SP
						If doc.UF(0) = "SP" Or UCase(Trim(doc.Pais(0))) <> "BRASIL" Then
							'Compra de SP
							If ufCompra = "SP" Or ufCompra = "EX" Then
								array = doc.Getitemvalue("ST_" & scan)
								'Substituição Tributária ou Isento
								If Right(array(0), 2) = "10" Or Right(array(0), 2) = "30" Or Right(array(0), 2) = "40" Or Right(array(0), 2) = "41" Or Right(array(0), 2) = "50" Or Right(array(0), 2) = "51" Or Right(array(0), 2) = "60" Or Right(array(0), 2) = "70" Or Right(array(0), 2) = "90" Then
									Call doc.Replaceitemvalue("IC_" & scan, 0)
								'Operação Crédito e Débito
								Else
									Call doc.Replaceitemvalue("IC_" & scan, impostos(0))
								End If
							'Compra de Fora de SP
							Else
								aliqICMSCompra = BuscaICMS(ufCompra, "SP", "Sim")
								array = doc.Getitemvalue("ST_" & scan)
								If Right(array(0), 2) = "00" Then
									'Verifica se tem Protocolo de Compra - LMO 01/11/16
									array = doc.Getitemvalue("CF_" & scan)
									protocolo = BuscaProtocolo(ufCompra, array(0), "Sim", "Compra")
									'Não encontrou Protocolo ou Protocolo Desatualizado
									If CStr(protocolo(0)) = "False" Then
										'Call doc.Replaceitemvalue("ICC_" & scan, "?")
									'Encontrou Protocolo
									Else
										'Sem Protocolo
										If protocolo(0) = 0 Then
											Call doc.Replaceitemvalue("IC_" & scan, impostos(0))
										'Com Protocolo
										Else
											Call doc.Replaceitemvalue("IC_" & scan, 0)
										End If	
									End If
								Else
									Call doc.Replaceitemvalue("IC_" & scan, 0)
								End If
							End If
							Call doc.Replaceitemvalue("ICD_" & scan, 0)
							Call doc.Replaceitemvalue("FCP_" & scan, 0)
							Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
							Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
						'Venda para Fora de SP
						Else
							'*** ICC ***
							array = doc.Getitemvalue("ST_" & scan)
							If ufCompra = "SP" Or ufCompra = "EX" Then
								'Compra de SP
								If fob = 0 And fi = 0 And Right(array(0), 2) = "30" Or Right(array(0), 2) = "40" Or Right(array(0), 2) = "41" Or Right(array(0), 2) = "50" Or Right(array(0), 2) = "51" Or Right(array(0), 2) = "60" Or Right(array(0), 2) = "90" Then icc = 0 Else icc = impostos(0)
								Call doc.Replaceitemvalue("ICC_" & scan, icc)
							Else
								'Compra de Fora de SP
								If Right(array(0), 2) <> "00" Then
									aliqICMSCompra = BuscaICMS(ufCompra, "SP", "Sim")
									If Left(array(0), 1) = "1" Or Left(array(0), 1) = "2" Or Left(array(0), 1) = "3" Or Left(array(0), 1) = "8" Then icc = aliqICMSCompra(1) Else icc = aliqICMSCompra(0)
									Call doc.Replaceitemvalue("ICC_" & scan, icc)
								End If
							End If
							'*** IC ***
							'Exceção Tributária - LMO 22/09/17
							ckExcecao = False
							If doc.Beneficio(0) <> "Não" Then
								'Benefício apenas para Revenda - LMO 03/03/2020
								If doc.Destino(0) = "Revenda" Then
									For scan2 = 0 To UBound(doc.Tributos)
										If doc.Tributos(scan2) = "ICMS" Then
											'Por NCM
											If doc.NCM(scan2) <> "" Then
												array = doc.Getitemvalue("CF_" & scan)
												If array(0) = doc.NCM(scan2) Then
													'Suframa
													If doc.Suframa(scan2) = "sim" Then
														ckExcecao = True
													'Cliente Geral
													ElseIf doc.Suframa(scan2) <> "sim" Then
														ckExcecao = True	
													End If
												End If
											'Geral
											Else
												'Suframa
												If doc.Suframa(scan2) = "sim" Then
													ckExcecao = True
												'Cliente Geral
												ElseIf doc.Suframa(scan2) <> "sim" Then
													ckExcecao = True	
												End If
											End If
										End If
										If ckExcecao Then Exit For
									Next
								End If
							End If
							'Com Exceção Tributária
							If ckExcecao Then
								If doc.Tipos(scan2) = "Redução" Then
									ic = doc.Reducao(scan2)
								Else
									ic = 0
								End If
							'Sem Exceção Tributária
							Else
								array = doc.Getitemvalue("ST_" & scan)
								If (Left(array(0), 1) = "1" Or Left(array(0), 1) = "2" Or Left(array(0), 1) = "3" Or Left(array(0), 1) = "8") Then ic = aliqICMS(1) Else ic = aliqICMS(0)
							End If
							Call doc.Replaceitemvalue("IC_" & scan, ic)
							'*** Diferencial do ICMS ***
							'Exceção Tributária - LMO 22/09/17
							ckExcecao = False
							If doc.Beneficio(0) <> "Não" Then
								For scan2 = 0 To UBound(doc.Tributos)
									If doc.Tributos(scan2) = "ICMS-ST" Then
										'Por NCM
										If doc.NCM(scan2) <> "" Then
											array = doc.Getitemvalue("CF_" & scan)
											If array(0) = doc.NCM(scan2) Then
												'Suframa
												If doc.Suframa(scan2) = "sim" Then
													ckExcecao = True
												'Cliente Geral
												ElseIf doc.Suframa(scan2) <> "sim" Then
													ckExcecao = True	
												End If
											End If
										'Geral
										Else
											'Suframa
											If doc.Suframa(scan2) = "sim" Then
												ckExcecao = True	
											'Cliente Geral
											ElseIf doc.Suframa(scan2) <> "sim" Then
												ckExcecao = True	
											End If
										End If
									End If
									If ckExcecao Then Exit For
								Next
							End If
							'Com Exceção Tributária
							If ckExcecao Then
								Call doc.Replaceitemvalue("ICD_" & scan, 0)
								Call doc.Replaceitemvalue("FCP_" & scan, 0)
								Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
								Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
							'Sem Exceção Tributária
							Else
								array = doc.Getitemvalue("CF_" & scan)
								protocolo = BuscaProtocolo(doc.UF(0), array(0), contribuinte, "Venda")
								'Não encontrou Protocolo ou Protocolo Desatualizado
								If CStr(protocolo(0)) = "False" Then
									Call doc.Replaceitemvalue("ICD_" & scan, "?")
									Call doc.Replaceitemvalue("FCP_" & scan, "?")
									Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
									Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
								'Encontrou Protocolo
								Else
									'Sem Protocolo
									If protocolo(0) = 0 Then
										Call doc.Replaceitemvalue("ICD_" & scan, 0)
										Call doc.Replaceitemvalue("FCP_" & scan, 0)
										Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
										Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
									'Com Protocolo
									Else
										array = doc.Getitemvalue("CusTot_" & scan)
										ip = doc.Getitemvalue("IP_" & scan)
										'Carga Média por CNAE
										If doc.Form(0) = "Negocio" And aliqICMS(7) = 1 Then
											cargaMedia = BuscaCargaMedia(doc.UF(0), doc.CNAE(0))
											'Não encontrou CNAE ou CNAE Desatualizado
											If CStr(cargaMedia(0)) = "False" Then
												Call doc.Replaceitemvalue("ICD_" & scan, "*")
												Call doc.Replaceitemvalue("FCP_" & scan, "*")
												Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
												Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
											'Encontrou CNAE
											Else
												'Alíquota do ICMS não pode ser zero
												If protocolo(5) = 0 Then
													Call doc.Replaceitemvalue("ICD_" & scan, "?")
													Call doc.Replaceitemvalue("FCP_" & scan, "?")
													Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
													Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
												Else
													Call doc.Replaceitemvalue("ICD_" & scan, cargaMedia(0))
													Call doc.Replaceitemvalue("FCP_" & scan, cargaMedia(1))
													Call doc.Replaceitemvalue("BCICMSST_" & scan, (array(0) / (1+ip(0)) * ic + array(0) * cargaMedia(0)) / protocolo(5))
													Call doc.Replaceitemvalue("ICMSST_" & scan, array(0) * (cargaMedia(0) + cargaMedia(1)))
												End If
											End If
										Else
											'Venda para Revenda
											If doc.Destino(0) = "Revenda" Then
												If protocolo(3) = 0 Or protocolo(4) = 0 Or protocolo(5) = 0 Then
													Call doc.Replaceitemvalue("ICD_" & scan, "?")
													Call doc.Replaceitemvalue("FCP_" & scan, "?")
													Call doc.Replaceitemvalue("ICMSST_" & scan, 0)
													Call doc.Replaceitemvalue("BCICMSST_" & scan, 0)
												Else
													'IVA 4%
													If ic = 0.04 Then
														bc = array(0) * (1 + protocolo(3))
														Call doc.Replaceitemvalue("ICD_" & scan, protocolo(3))
													'IVA 7% ou 12%
													Else
														bc = array(0) * (1 + protocolo(4))
														Call doc.Replaceitemvalue("ICD_" & scan, protocolo(4))
													End If
													Call doc.Replaceitemvalue("FCP_" & scan, protocolo(2))
													Call doc.Replaceitemvalue("ICMSST_" & scan, bc * protocolo(5) - array(0)/(1+ip(0)) * ic)
													Call doc.Replaceitemvalue("BCICMSST_" & scan, bc)
												End If
											'Venda para Consumidor Final
											Else
												Call doc.Replaceitemvalue("ICD_" & scan, protocolo(1) - ic)	'Alíquota Diferencial
												Call doc.Replaceitemvalue("FCP_" & scan, protocolo(2))	'Alíquota do Fundo de Combate a Pobreza
												'Fator BC Diferencial (1 - Alíquota Interna do Estado Destino)
												fatorBC = (1 - protocolo(1))
												'Não Contribuinte
												If contribuinte = "Não" Then
													'Base de Cálculo Única - gfogaca 31/03/22 (email)
													icmsOP = array(0) * ic
													fatorBC = fatorBC - protocolo(2)
													bc = (array(0) - icmsOP) / fatorBC
													Call doc.Replaceitemvalue("ICMSST_" & scan, bc * (protocolo(1) - ic) + (bc * protocolo(2)))
												'Contribuinte
												ElseIf contribuinte = "Sim" Then
													'Não abate ICMS-OP da BC
													If aliqICMS(2) = 0 Then
														bc = array(0)
														Call doc.Replaceitemvalue("ICMSST_" & scan, bc * (protocolo(1) - ic) + bc * protocolo(2))
													'Abate ICMS-OP da BC-ICMSST
													Else
														'**** gfogaca 20/10/22 (email) ****
														If doc.UF(0) = "RJ" Then
															icmsOP = array(0) * ic
															fatorBC = fatorBC - protocolo(2)
															bc = (array(0) - icmsOP) / fatorBC
															Call doc.Replaceitemvalue("ICMSST_" & scan, (bc * protocolo(1) - icmsOP) + bc * protocolo(2))
														'Abate Antes do Fator - LMO 03/02/23 (email gfogaca 03/02/23)
														ElseIf aliqICMS(9) = 1 Then
															icmsOP = array(0) * ic
															bc = (array(0) - icmsOP) / fatorBC
															icST = bc * (protocolo(1) - ic)
															Call doc.Replaceitemvalue("ICMSST_" & scan, icST + bc * protocolo(2))
														'Abate Depois do Fator - LMO 03/02/23 (email gfogaca 03/02/23)
														Else
															icmsOP = array(0) / fatorBC * ic
															bc = array(0) / fatorBC - icmsOP
															icST = array(0) / fatorBC * (protocolo(1) - ic)
															Call doc.Replaceitemvalue("ICMSST_" & scan, icST + bc * protocolo(2))
														End If
													End If
												End If
												Call doc.Replaceitemvalue("BCICMSST_" & scan, bc)
											End If
										End If
									End If
								End If
							End If
						End If
						'*** PIS ***
						'Exceção Tributária - LMO 22/09/17
						ckExcecao = False
						If doc.Beneficio(0) <> "Não" Then
							For scan2 = 0 To UBound(doc.Tributos)
								If doc.Tributos(scan2) = "PIS" Then
									'Por NCM
									If doc.NCM(scan2) <> "" Then
										array = doc.Getitemvalue("CF_" & scan)
										If array(0) = doc.NCM(scan2) Then
											'Suframa
											If doc.Suframa(scan2) = "sim" Then
												ckExcecao = True
											'Cliente Geral
											ElseIf doc.Suframa(scan2) <> "sim" Then
												ckExcecao = True	
											End If
										End If
									'Geral
									Else
										'Suframa
										If doc.Suframa(scan2) = "sim" Then
											ckExcecao = True	
										'Cliente Geral
										ElseIf doc.Suframa(scan2) <> "sim" Then
											ckExcecao = True	
										End If
									End If
								End If
								If ckExcecao Then Exit For
							Next
						End If
						'Com Exceção Tributária
						If ckExcecao Then
							If doc.Tipos(scan2) = "Redução" Then
								Call doc.Replaceitemvalue("AliquotaPIS_" & scan, doc.Reducao(scan2))
							Else
								Call doc.Replaceitemvalue("AliquotaPIS_" & scan, 0)
							End If
						'Sem Exceção Tributária
						Else
							Call doc.Replaceitemvalue("AliquotaPIS_" & scan, aliquota(0))
						End If
						'*** COFINS ***
						'Exceção Tributária - LMO 22/09/17
						ckExcecao = False
						If doc.Beneficio(0) <> "Não" Then
							For scan2 = 0 To UBound(doc.Tributos)
								If doc.Tributos(scan2) = "COFINS" Then
									'Por NCM
									If doc.NCM(scan2) <> "" Then
										array = doc.Getitemvalue("CF_" & scan)
										If array(0) = doc.NCM(scan2) Then
											'Suframa
											If doc.Suframa(scan2) = "sim" Then
												ckExcecao = True	
											'Cliente Geral
											ElseIf doc.Suframa(scan2) <> "sim" Then
												ckExcecao = True	
											End If
										End If
									'Geral
									Else
										'Suframa
										If doc.Suframa(scan2) = "sim" Then
											ckExcecao = True	
										'Cliente Geral
										ElseIf doc.Suframa(scan2) <> "sim" Then
											ckExcecao = True	
										End If
									End If
								End If
								If ckExcecao Then Exit For
							Next
						End If
						'Com Exceção Tributária
						If ckExcecao Then
							If doc.Tipos(scan2) = "Redução" Then
								Call doc.Replaceitemvalue("AliquotaCOFINS_" & scan, doc.Reducao(scan2))
							Else
								Call doc.Replaceitemvalue("AliquotaCOFINS_" & scan, 0)
							End If
						'Sem Exceção Tributária
						Else
							Call doc.Replaceitemvalue("AliquotaCOFINS_" & scan, aliquota(1))
						End If
					End If	
					'II
					If fob > 0 Or fi > 0 Then
						'Importação TDec
						Call doc.Replaceitemvalue("II_" & scan, impostos(2))
					Else
						Call doc.Replaceitemvalue("II_" & scan, 0)
					End If
				End If
			Else
				array = doc.Getitemvalue("II_" & scan)
				If CStr(array(0)) = "" Then
					Call doc.Replaceitemvalue("II_" & scan, 0)
				End If
			End If
			
			'Calcula ICMS Outros Estados das Compras de Fora de SP apenas se o Item não foi Comprado
			If doc.TipoCompra(0) <> "Remessa" Then
				array = doc.Getitemvalue("T_" & scan)
				If array(0) = "HW" Then
					array = doc.Getitemvalue("ST_" & scan)
					If Right(array(0), 2) = "00" Then
						If ufCompra <> "SP" And ufCompra <> "EX" Then
							If CheckDocListas(doc.Codigo(0), CStr(scan + 1), "Compra") Then
								array = doc.Getitemvalue("CF_" & scan)
								protocolo = BuscaProtocolo(ufCompra, array(0), "Sim", "Compra")
								'Não encontrou Protocolo/Protocolo Desatualizado
								If CStr(protocolo(0)) = "False" Then
									Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
								Else
									'Sem Protocolo
									If protocolo(0) = 0 Then
										Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
									'Com Protocolo
									Else
										'ICMS Operações Próprias (Valor dos Produtos * ICC)
										'ICMS Substituição Tributária (Valor da Nota * IVA * Alíquota do ICMS)
										'ICMS Outros Estados (ICMS Substituição Tributária - ICMS Operações Prórias)
										aliqICMSCompra = BuscaICMS(ufCompra, "SP", "Sim")
										array = doc.Getitemvalue("ST_" & scan)
										If Left(array(0), 1) = "1" Or Left(array(0), 1) = "2" Or Left(array(0), 1) = "3" Or Left(array(0), 1) = "8" Then icc = aliqICMSCompra(1) Else icc = aliqICMSCompra(0)
										If doc.TipoCompra(0) = "Consumo" Then
											icmsOP = custo * icc
										Else
											ipc = doc.Getitemvalue("IPC_" & scan)
											icmsOP = custo/(1+ipc(0)) * icc
										End If
										If icc = 0.04 Then
											icmsSTC = custo * (1 + protocolo(2)) * protocolo(4)
										Else
											icmsSTC = custo * (1 + protocolo(3)) * protocolo(4)
										End If
										Call doc.Replaceitemvalue("ICMSSTC_" & scan, icmsSTC - icmsOP)
									End If
								End If
							End If
						End If
					End If
				End If
			End If
			
			'*** Valor de Venda com o ICMSST ***
			If CStr(doc.Getitemvalue("ICMSST_" & scan)(0)) <> "" Then icmsST = doc.Getitemvalue("ICMSST_" & scan)(0) Else icmsST = 0
			If CStr(doc.Getitemvalue("BCICMSST_" & scan)(0)) <> "" Then bc = doc.Getitemvalue("BCICMSST_" & scan)(0) Else bc = 0
			'Venda Não Contribuinte para Fora de SP
			If contribuinte = "Não" And icmsST > 0 Then	'email gfogaca 31/07/23 15:38 hrs
				Call doc.Replaceitemvalue("VendaTot_" & scan, bc)
				'Call doc.Replaceitemvalue("VendaTot_" & scan, bc * (1 + ip(0))) 'Soma o IPI (Aguardando resposta da consultoria) - LMO 14/11/25  
			Else
				Call doc.Replaceitemvalue("VendaTot_" & scan, custoUnit * qtd + icmsST)
			End If
		Else
			Call doc.ReplaceItemValue("Q_" & scan, "")
			Call doc.Replaceitemvalue("T_" & scan, "")
			Call doc.Replaceitemvalue("Un_" & scan, "")
			Call doc.Replaceitemvalue("CF_" & scan, "")
			Call doc.Replaceitemvalue("ST_" & scan, "")
			Call doc.Replaceitemvalue("Fabricante_" & scan, "")
			Call doc.Replaceitemvalue("UFCompra_" & scan, "")
			Call doc.ReplaceItemValue("Us_" & scan, "R$")
			Call doc.Replaceitemvalue("ICC_" & scan, "")
			Call doc.Replaceitemvalue("IPC_" & scan, "")
			Call doc.Replaceitemvalue("CustoFOB_" & scan, "")
			Call doc.Replaceitemvalue("FI_" & scan, "")
			Call doc.Replaceitemvalue("Custo_" & scan, "")
			Call doc.Replaceitemvalue("ICMSSTC_" & scan, "")
			Call doc.Replaceitemvalue("Mg_" & scan, "")
			Call doc.Replaceitemvalue("CustoUnit_" & scan, "")
			Call doc.Replaceitemvalue("CusTot_" & scan, "")
			Call doc.Replaceitemvalue("ICMSST_" & scan, "")
			Call doc.Replaceitemvalue("BCICMSST_" & scan, "")
			Call doc.Replaceitemvalue("VendaTot_" & scan, "")
			Call doc.Replaceitemvalue("IC_" & scan, "")
			Call doc.Replaceitemvalue("ICD_" & scan, "")
			Call doc.Replaceitemvalue("FCP_" & scan, "")
			Call doc.Replaceitemvalue("IP_" & scan, "")
			Call doc.Replaceitemvalue("II_" & scan, "")
			Call doc.Replaceitemvalue("AliquotaPIS_" & scan, "")
			Call doc.Replaceitemvalue("AliquotaCOFINS_" & scan, "")
			Call doc.Replaceitemvalue("ICMS_" & scan, "")
		End If
Proximo:
	Next
	
End Sub

'++LotusScript Development Environment:2:2:GeraReceber:1:8
Sub GeraReceber(doc As NotesDocument)
	'Gera/Atualiza Receber
	
	'Se for uma Nota Fiscal de Entrada, Remessa e Devolução não gera receber.
	If doc.TipoNota(0) = "Entrada" Or (InStr(doc.Natureza(0), "Remessa") > 0 And InStr(doc.Natureza(0), "Entrega Futura") = 0) Or InStr(doc.Natureza(0), "Devolução") > 0 Then
		Exit Sub
	End If
	Dim session As New NotesSession
	Dim dbFat As NotesDatabase
	Dim car As NotesDocument
	Set dbFat = doc.Parentdatabase
	'Gera um Receber para cada parcela.
	Dim scan As Integer
	Dim valor(3) As Double, vencimento(3) As String, titulo(3) As String
	If CStr(doc.Valor(0)) = "" Then valor(0) = 0 Else valor(0) = doc.Valor(0)
	If CStr(doc.Valor2(0)) = "" Then valor(1) = 0 Else valor(1) = doc.Valor2(0)
	If CStr(doc.Valor3(0)) = "" Then valor(2) = 0 Else valor(2) = doc.Valor3(0)
	If CStr(doc.Valor4(0)) = "" Then valor(3) = 0 Else valor(3) = doc.Valor4(0)
	vencimento(0) = CStr(doc.vencimento(0))
	vencimento(1) = CStr(doc.vencimento2(0))
	vencimento(2) = CStr(doc.vencimento3(0))
	vencimento(3) = CStr(doc.vencimento4(0))
	titulo(0) = "A"
	titulo(1) = "B"
	titulo(2) = "C"
	titulo(3) = "D"
	'Atualiza Receber já criado - LMO 06/12/17
	Dim dc As NotesDocumentCollection
	Dim receber As NotesDocument
	Set dc = doc.Responses
	For scan = 0 To 3 
		If valor(scan) <> 0 Then
			Set receber = dc.Getnthdocument(scan + 1)
			If Not receber Is Nothing Then
				Set car = receber
			Else
				Set car = New NotesDocument(dbFat)
				car.Form = "Receber"
				car.Id = geraJavaId(car)
				car.IdOrigem = doc.Id
				car.Sit = "a Receber"
				car.Codigo = doc.Codigo
				car.CodEmpresa = doc.CodEmpresa
				car.Autor = session.UserName
				car.Criacao = Now()
			End If
			car.Area = doc.Area
			car.AreaVendas = doc.AreaVendas
			car.TipoAvancado = doc.TipoAvancado
			car.GerenteConta = doc.GerenteConta
			car.CodCliente = doc.CodCLiente
			car.CodigoGrupoEconomico = doc.CodigoGrupoEconomico
			'Comprador - LMO 27/04/18
			car.Comprador = doc.Comprador
			car.TelComprador = doc.TelComprador
			car.CelComprador = doc.CelComprador
			car.EmailComprador = doc.EmailComprador
			'
			car.Tipo = doc.Tipo
			car.SitEspelho = doc.Sit(0)
			car.Vencimento = CDat(vencimento(scan))
			car.Prorrogacao = CDat(vencimento(scan))
			'Cálculo do dia de disponibilidade do dinheiro na Conta
			Dim  disp As  New NotesDateTime( vencimento(scan) )
			If Weekday( DateValue( disp.dateonly ) ) = 6 Then
				Call disp.adjustday( 3 )          
			ElseIf Weekday( DateValue( disp.dateonly ) ) = 7 Then
				Call disp.adjustday( 3 )          
			ElseIf Weekday( DateValue( disp.dateonly ) ) = 1 Then
				Call disp.adjustday( 2 )          
			Else
				Call disp.adjustday( 1 )          
			End If
			car.DinheiroNaConta = DateValue( disp.dateonly ) 
			car.TipoVenda = doc.TipoVenda
			car.ValorReceber = valor(scan)
			car.Juros = 0
			car.Desconto = 0
			car.TotTot = valor(scan)
			car.DataFaturamento = doc.DataFaturamento
			car.NTituloReceber = CStr(doc.NFiscal(0)) + titulo(scan)
			car.NFiscal = CStr(doc.NFiscal(0))
			car.Boleto = doc.NBoleto
			car.Cliente = doc.Cliente
			car.CGC = doc.CGC
			car.Endereco = doc.Endereco
			car.Bairro = doc.Bairro
			car.CEP = doc.CEP
			car.Cidade = doc.Cidade
			car.UF = doc.Estado	
			car.Descricao = doc.descricao
			'Cobrança Bancária		
			car.TipoPagto = doc.TipoPagto(0)
			car.TipoInscricao = "02"
			car.TipoOcorrencia = "01"
			car.TipoTitulo = "01"
			car.AceiteCliente = "A"
			car.Instrucao_1 = "00"
			car.Instrucao_2 = "00"
			car.Mora = 0.33
			car.CkProcessamento = 0
			Call car.MakeResponse( doc )
			Call car.ComputeWithForm(False, False)
			Call car.Save(True,True)
		End If
	Next
	
End Sub

'++LotusScript Development Environment:2:2:GerarIntermediacaoVendas:5:8
%REM
	Sub GerarIntermediacaoVendas
	Description: Comments for Sub
%END REM
Sub GerarIntermediacaoVendas(negocio As NotesDocument)
	'Gera PO e envia email para o Financeiro efetuar a Baixa
	
	'Compras
	Dim scan As Integer
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "compras.nsf")
	'Empresas
	Dim dbEmpresas As New NotesDatabase(negocio.Parentdatabase.Server, "empresas.nsf")
	Dim viewEmpresas As NotesView, viewContatos As NotesView
	Dim empresa As NotesDocument, contato As NotesDocument
	Set viewEmpresas = dbEmpresas.GetView("(Dados Cadastrais)")
	Set viewContatos = dbEmpresas.GetView("(ContatosGrupoEconomicoAtivos)")
	'Estoque Main
	Dim estoque As New NotesDatabase(negocio.Parentdatabase.Server, "estoquemain.nsf")
	Dim catalogo As NotesView
	Dim equipamento As NotesDocument
	Set catalogo = estoque.Getview("(Catalogo/PartNumber)")
	'Listas
	Dim listas As New NotesDatabase(negocio.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim item As NotesDocument, itemAnterior As NotesDocument
	Set view = listas.Getview("(NegocioNIntermediacao)")
	'Fornecedor
	Dim ws As New NotesUIWorkspace
	Dim flag As Boolean
	Dim codigoFornecedor As String
	
	For scan = 0 To UBound(negocio.ValoresIntermediacao_P)
		'Item
		Set itemAnterior = view.Getdocumentbykey(negocio.Codigo(0) & "-" & (scan + 1), True)
		If Not itemAnterior Is Nothing Then
			Set item = itemAnterior
			If item.QCompra(0) > 0 Or item.QBaixa(0) > 0 Or item.QPreBaixa(0) > 0 Or Val(item.QSimplesFaturamento(0)) > 0 Then
				MsgBox "A Intermediação de Vendas do item " & (scan + 1) & ", R$" & Format(negocio.ValoresIntermediacao_P(scan), "standard") & ", já foi gerada.", 64, "Aviso"
				GoTo proximo
			End If
		End If
		'Fornecedor
		flag = ws.DialogBox( "Popup_Empresa", True, True, False, False, False, False, "Intermediação de Vendas: Item " & (scan + 1), negocio, True, False, False)
		If flag = False Then
			End
		Else
			codigoFornecedor = UCase(Trim(negocio.CodigoEmpresa(0)))
		End If
		Set empresa = viewEmpresas.GetDocumentByKey(codigoFornecedor, True)
		If empresa Is Nothing Then
			MsgBox "Empresa " & codigoFornecedor & " não encontrada no cadastro de Empresas. Selecione uma Empresa válida.", 16, "Erro"
			End
		End If 
		'Contato
		Set contato = viewContatos.GetDocumentByKey(empresa.CodigoOrigem(0), True)
		If contato Is Nothing Then
			MsgBox "Não há Contatos Ativos no Grupo Econômico " & empresa.CodigoOrigem(0) & ". Crie/Ative o Contato em Empresas.", 16, "Erro"
			End
		End If
		'Equipamento
		Set equipamento = catalogo.Getdocumentbykey("INT-VD", True)
		If equipamento Is Nothing Then
			MsgBox "PartNumber " & "INT-VD" & " não encontrado no Estoque Main. Cadastre o PartNumber no Catálogo do Estoque Main.", 16, "Erro"
			End
		End If
		Dim doc As New NotesDocument(db)
		doc.Form = "Pedido"
		doc.Id = geraJavaId(doc)
		doc.Estoque = "Sim"
		doc.Status = "Pendente"
		doc.Criacao = Now
		doc.Autor = session.CommonUserName
		doc.DataCotacaoUS = negocio.DataCotacaoUS(0)
		doc.USC = negocio.USC(0)
		doc.UST = negocio.UST(0)
		doc.PO = geraCodigoPedidoCompra(empresa.Codigo(0))
		doc.DataPO = Today
		doc.Codigo = negocio.Codigo(0)
		doc.CodEmpresa = negocio.CodEmpresa(0)
		doc.CodCliente = empresa.Codigo(0)
		'Fonecedor
		doc.GrupoEconomico = empresa.CodigoOrigem(0)
		doc.IdEmpresa = empresa.Id(0)
		doc.UF = empresa.Estado(0)
		'Contato
		doc.Contato = contato.Nome(0)
		doc.Email = contato.Codigo(0)
		doc.TelVendedor = contato.Telefones(0)
		doc.Municipio = empresa.Cidade(0)
		doc.Descricao = negocio.Descricao(0)
		doc.CondicaoPagto = negocio.PrazoPagamento(0)
		doc.PrazoEntrega = Today
		doc.Entrega = Today
		doc.CondicaoEntrega = "TDec"
		doc.Garantia = 0
		doc.Tipo = negocio.Form(0)
		doc.AreaDespesa = negocio.AreaDespesa(0)
		doc.ResponsavelDespesa = negocio.ResponsavelDespesa(0)
		doc.TipoCompra = "Projeto"
		doc.ClassificacaoDespesa = "Intermediação de Vendas"
		doc.Areas = negocio.AreaDespesa(0)
		doc.Overhead = 1
		doc.TipoVenda = negocio.TipoVenda(0)
		'Item
		If Not itemAnterior Is Nothing Then
			Set item = itemAnterior
		Else
			Set item = New NotesDocument(listas)
			item.Form = "Intermediacao"
			item.Id = geraJavaId(item)
			item.IdOrigem = doc.Id(0)
			item.Codigo = doc.Codigo(0)
			item.NItem = CStr(scan + 1)
			item.Autor = session.CommonUserName
			item.Criacao = Now
		End If
		item.QCompra = 1
		item.VlCompra = negocio.ValoresIntermediacao_P(scan)
		item.QDanfe = 0
		item.QPreBaixa = 0
		item.QSimplesFaturamento = 0
		item.QBaixa = 0
		item.QFat = 0
		item.QRecibo = 0
		item.Status = "Ativa"
		item.CompromissoEntrega = doc.PrazoEntrega(0)
		item.PrazoEntrega =  doc.PrazoEntrega(0)
		item.Garantia = doc.Garantia(0)
		item.Q = 1
		item.PartNo = "INT-VD"
		'Equipamento
		item.Produto = equipamento.Nome(0)
		item.Un = equipamento.UnidadeMedida(0)
		item.CF = equipamento.ClassificacaoFiscal(0)
		item.ST = "000"
		item.Fabricante = equipamento.Fabricante(0)
		item.US = equipamento.Moeda(0)
		item.T = equipamento.Tipo(0)
		'
		Dim natureza As String
		If item.T(0) = "HW" Then
			natureza = "Venda" 
		ElseIf item.T(0) = "SW" Then
			natureza = "Licenciamento de Uso"
		ElseIf item.T(0) = "SV" Or item.T(0) = "Serviço" Then
			natureza = "Prestação de Serviços"
		Else
			natureza = "Erro"
		End If
		doc.Natureza = natureza
		'
		item.UFCompra = doc.UF(0)
		item.UFVenda = negocio.UF(0)
		item.CustoFOB = 0
		item.FI = 0
		item.Custo = negocio.ValoresIntermediacao_P(scan)
		item.ICMSSTC = 0
		item.Mg = 1
		item.CustoUnit = negocio.ValoresIntermediacao_P(scan)
		item.CusTot = negocio.ValoresIntermediacao_P(scan)
		item.ICMSST = 0
		item.BCICMSST = 0
		item.FIReal = 0
		item.ICC = 0
		item.IC = 0
		item.ICD = 0
		item.FCP = 0
		item.IPIC = 0
		item.IPI = 0
		item.II = 0
		item.ISS = 0
		item.AliquotaPIS = 0
		item.AliquotaCOFINS = 0
		'Link para Negócio
		If item.Hasitem("LinkNegocio") Then item.Removeitem("LinkNegocio")
		Dim ligacao As NotesRichTextItem
		Set ligacao = item.CreateRichTextItem("LinkNegocio")
		Call ligacao.AppendDocLink(negocio, "Link para o Negócio " & doc.Codigo(0))
		Call item.Save(True, True)
		'Popula Itens do PO
		Call doc.ReplaceItemValue("i_0", CStr(scan + 1))
		Call doc.ReplaceItemValue("Q_0", 1)
		Call doc.ReplaceItemValue("S_0", 1)
		Call doc.ReplaceItemValue("QOrig_0", 1)
		Call doc.ReplaceItemValue("PartNo_0", item.PartNo(0))
		Call doc.ReplaceItemValue("Produto_0", item.Produto(0))
		Call doc.ReplaceItemValue("PrazoEntrega_0", doc.PrazoEntrega(0))
		Call doc.ReplaceItemValue("t_0", item.T(0))
		Call doc.ReplaceItemValue("Un_0", item.Un(0))
		Call doc.ReplaceItemValue("Us_0", item.US(0))
		Call doc.ReplaceItemValue("CustoUnit_0", item.CustoUnit(0))
		Call doc.ReplaceItemValue("CusTot_0", item.CusTot(0))
		Call doc.ReplaceItemValue("ICMSST_0", item.ICMSST(0))
		Call doc.ReplaceItemValue("IC_0", item.ICC(0))
		Call doc.ReplaceItemValue("IP_0", item.IPIC(0))
		Call doc.ReplaceItemValue("ST_0", item.Un(0))
		'Gerando Link entre o Pedido de Compra e o Negócio
		Dim rtitem As NotesRichTextItem
		Set rtitem = New NotesRichTextItem( doc, "LinkCotacao" )
		Call rtitem.AppendDocLink( negocio, "Link para o Negócio" )
		'Calcula os Totais do Pedido
		Call CalcTotaisPO (doc)
		Call doc.Save( True, True )
		'Envia Email do Pedido para o Financeiro
		Dim success As Variant
		Dim memo As New NotesDocument(db)
		memo.Form = "Memo"
		memo.Subject = "-> Pedido de Compra de Intermediação de Vendas - " & doc.PO(0)
		memo.SendTo = "financeiro@tdec.com.br"
		memo.CopyTo = session.CommonUserName
		'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
		Set rtitem = New NotesRichTextItem( memo, "Body" )
		Call rtitem.Appendtext( "Favor efetuar a Baixa de Intermediação de Vendas." )
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Valor: R$ " & Format(negocio.ValoresIntermediacao_P(scan), "Standard") )
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Negócio: " & negocio.Codigo(0) )
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Descrição: " & negocio.Descricao(0) )
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Pedido de Compra:  " )
		Call rtitem.AppendDocLink( doc, "Link para o Pedido de Compra" )
		Call rtitem.AddNewLine( 2 )
		success = doc.RenderToRTItem(rtitem)
		memo.SignOnSend = True
		Call memo.Send(False)
		MsgBox "Pedido de Intermediação de Vendas Gerado com sucesso. Item " & (scan + 1) & ", R$" & Format(negocio.ValoresIntermediacao_P(scan), "standard") & ", é necessário efetuar a baixa.", 64, "Aviso"
proximo:		
	Next
	
End Sub

'++LotusScript Development Environment:2:1:CkFeriado:1:8
Function CkFeriado (diaVenc As String) As Boolean
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase( session.CurrentDatabase.server ,"adm.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim dia As New NotesDateTime(diaVenc)
	Set view = db.GetView( "Adm\Feriados" )
	Set doc = view.GetDocumentByKey(Day(dia.DateOnly) & "/" & Month(dia.DateOnly) & "/" & Year(dia.DateOnly), True )
	If Not doc Is Nothing Then
		CkFeriado = True	
	End If
	
End Function

'++LotusScript Development Environment:2:2:LoadAceiteFaturamento:5:8
%REM
	Sub LoadAceite
	Description: Comments for Sub
%END REM
Sub LoadAceiteFaturamento(uidoc As NotesUIDocument)
	
	Dim db As New NotesDatabase(uidoc.Document.Parentdatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument, aceite As NotesDocument
	Dim key(2) As String
	Set aceite = uidoc.Document
	key(0) = aceite.Codigo(0)
	key(1) = aceite.NFiscal(0)
	key(2) = aceite.CodEmpresa(0)
	Set view = db.Getview("(EspelhosNegocioAceitePendente)")
	Set doc = view.GetDocumentbykey(key, True)
	If Not doc Is Nothing Then
		aceite.StatusAceiteFaturamento = doc.StatusAceiteFaturamento(0)
		aceite.CodigoGrupoEconomico = doc.CodigoGrupoEconomico(0)
		aceite.Comprador = doc.Comprador(0)
		aceite.TelComprador = doc.TelComprador(0)
		aceite.CelComprador = doc.CelComprador(0)
		aceite.EmailComprador = doc.EmailComprador(0)
		aceite.EnviarEmail = doc.EnviarEmail(0)
		aceite.NumContatos = Val(doc.NumContatos(0))
		aceite.DatasContato = doc.DatasContato
		aceite.HorariosContato = doc.HorariosContato
		aceite.ResponsaveisContato = doc.ResponsaveisContato
		aceite.ContatosContato = doc.ContatosContato
		aceite.ObservacoesContato = doc.ObservacoesContato
	End If
	Call uidoc.Refreshhideformulas()
	
End Sub

'++LotusScript Development Environment:2:1:CalcCofins:1:8
Function CalcCofins( doc As NotesDocument ) As Double
		
	If doc.TipoNota(0) = "Entrada" Then
		CalcCofins# = (doc.TotalServicos(0) + doc.TotalProdutos(0)) * aliquota(1) * - 1
	Else
		CalcCofins# = (doc.TotalServicos(0) + doc.TotalProdutos(0)) * aliquota(1)
	End If
		
End Function

'++LotusScript Development Environment:2:1:CkItemEmDolar:5:8
%REM
	Function CkItemEmDolar
	Description: Verifica se tem item em dólar - LMO 13/02/24
%END REM
Function CkItemEmDolar(docAtu As NotesDocument) As Boolean
	
	On Error Resume Next
	Dim scan As Integer
	'*** Baixa ***
	If docAtu.Form(0) = "Baixa" Then
		For scan = 0 To 49
			If docAtu.GetItemValue("us_" & scan)(0) = "US$C" Then
				CkItemEmDolar = True
				Exit For
			End If
		Next
		Exit Function
	End If
	
	'*** Espelho ***
	Dim db As New NotesDatabase(docAtu.Parentdatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Set view = db.GetView("(NegocioNItens)")
	If docAtu.Form(0) = "Espelho" Then
		If docAtu.Tipo(0) = "Hardware" Then
			For scan = 0 To 49
				Set doc = view.getDocumentByKey(docAtu.Codigo(0) & "-" & docAtu.GetItemValue("itNota_" & scan)(0))
				If Not doc Is Nothing Then
					If doc.Us(0) = "US$C" Then
						CkItemEmDolar = True
						Exit For
					End If
				End If
			Next
		Else
			For scan = 0 To 99
				Set doc = view.getDocumentByKey(docAtu.Codigo(0) & "-" & docAtu.GetItemValue("itNotas_" & scan)(0))
				If Not doc Is Nothing Then
					If doc.Us(0) = "US$C" Then
						CkItemEmDolar = True
						Exit For
					End If
				End If
			Next
		End If
	End If
	
	'*** Recibo ***
	If docAtu.Form(0) = "Recibo" Then
		If docAtu.Tipo(0) = "Hardware" Then
			For scan = 0 To 9
				Set doc = view.getDocumentByKey(docAtu.Codigo(0) & "-" & docAtu.GetItemValue("itNota_" & scan)(0))
				If Not doc Is Nothing Then
					If doc.Us(0) = "US$C" Then
						CkItemEmDolar = True
						Exit For
					End If
				End If
			Next
		Else
			For scan = 0 To 4
				Set doc = view.getDocumentByKey(docAtu.Codigo(0) & "-" & docAtu.GetItemValue("itNotas_" & scan)(0))
				If Not doc Is Nothing Then
					If doc.Us(0) = "US$C" Then
						CkItemEmDolar = True
						Exit For
					End If
				End If
			Next
		End If
	End If	
	
End Function

'++LotusScript Development Environment:2:2:AtualizaMetas:1:8
Sub AtualizaMetas(docAtu As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As NotesDatabase, dbFat As NotesDatabase
	Dim view As NotesView, viewFat As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim tot As Double, totFat As Double, realizadoP As Double, faturadoP As Double
	Redim chave(1) As String
	chave(0) = docAtu.MesBase(0)
	chave(1) = docAtu.Nome(0)
	
	'Realizado - Sales Force
	Set db = New NotesDatabase(docAtu.ParentDatabase.Server, "sales.nsf")
	Set view = db.GetView("(Negocios/Periodo)")
	'Faturado - Faturamento
	Set dbFat = New NotesDatabase(docAtu.ParentDatabase.Server, "faturas.nsf")
	Set viewFat = dbFat.GetView("(Espelho/Periodo)")
	
	'Realizado por Vendedor
	Set dc = view.GetAllDocumentsByKey(chave, True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		tot = tot + doc.TotalNegocio(0)
		Set doc = dc.GetNextDocument(doc)
	Loop
	docAtu.Realizado = tot
	'Faturado por Vendedor
	Set dc = viewFat.GetAllDocumentsByKey(chave, True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		totFat = totFat + doc.TotTot(0)
		Set doc = dc.GetNextDocument(doc)
	Loop
	docAtu.Faturado = totFat
	'% Realizado e % Faturado
	If Cstr(docAtu.Previsto(0)) <> "" Then
		If docAtu.Previsto(0) <> 0 Then
			realizadoP = docAtu.Realizado(0) / docAtu.Previsto(0)
			faturadoP = docAtu.Faturado(0) / docAtu.Previsto(0)
		End If
	End If
	docAtu.RealizadoP = realizadoP
	docAtu.FaturadoP = faturadoP
	
	'Parceria
	Dim x As Integer, it As NotesItem, item As Variant
	Redim Preserve chave(2) As String
	For x = 0 To 19
		item = docAtu.GetItemValue("Parceria_" & x)
		If item(0) <> "" Then
			chave(2) = item(0)
			'Realizado
			Set dc = view.GetAllDocumentsByKey(chave, True)
			Set doc = dc.GetFirstDocument
			tot = 0
			Do Until doc Is Nothing
				tot = tot + doc.TotalNegocio(0)
				Set doc = dc.GetNextDocument(doc)
			Loop
			Set it = docAtu.ReplaceItemValue("Realizado_" & x, tot)
			'Faturado
			Set dc = viewFat.GetAllDocumentsByKey(chave, True)
			Set doc = dc.GetFirstDocument
			totFat = 0
			Do Until doc Is Nothing
				totFat = totFat + doc.TotTot(0)
				Set doc = dc.GetNextDocument(doc)
			Loop
			Set it = docAtu.ReplaceItemValue("Faturado_" & x, totFat)
			'% Realizado e % Faturado
			realizadoP = 0
			faturadoP = 0
			item = docAtu.GetItemValue("Previsto_" & x)
			If Cstr(item(0)) <> "" Then
				If item(0) <> 0 Then
					realizadoP = tot / item(0)
					faturadoP = totFat / item(0)
				End If
			End If
			Set it = docAtu.ReplaceItemValue("RealizadoP_" & x, realizadoP)
			Set it = docAtu.ReplaceItemValue("FaturadoP_" & x, faturadoP)
		End If
	Next
	
End Sub

'++LotusScript Development Environment:2:2:AvisoFechamentoProjeto:1:8
Sub AvisoFechamentoProjeto(doc As NotesDocument)
	'Avisa a área de Projetos e Pós-Venda de Cabling sobre o Fechamento da Venda
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim nome As New NotesName(session.Effectiveusername)
	Dim db As NotesDatabase
	Set db = session.CurrentDatabase
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	'Planilha Financeira
	Dim serv As New NotesDatabase(db.Server, "servicos.nsf")
	Dim view As NotesView
	Dim planilha As NotesDocument
	Set view = serv.GetView("(Planilha/Codigo)")
	Set planilha = view.GetDocumentByKey(doc.Codigo(0), True)
	'Email
	Dim recipients(1) As String
	Dim memo As New NotesDocument(db)
	memo.Form = "Memo"
	recipients(0) = "projetos@tdec.com.br"
	If doc.TipoVenda(0) = "Contrato" Then
		recipients(1) = "noc@tdec.com.br"
	End If
	memo.SendTo = recipients
	If doc.Area(0) = "Cabling" Then
		memo.CopyTo = "Pós-Venda Cabling"
	End If
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	If doc.Sit(0) =  "Faturamento Futuro" Then
		memo.Subject = "-> " & doc.TipoVenda(0) & " com Faturamento Futuro fechado com o Cliente: " & doc.Codigo(0)
	Else
		memo.Subject = "-> " & doc.TipoVenda(0) & " fechado com o Cliente: " & doc.Codigo(0)
	End If
	Dim corpo As New NotesRichTextItem(memo , "Body")
	Call corpo.AppendStyle(richStyle)
	Call corpo.Appendtext("Favor incluir as Reservas Técnicas na Planilha Financeira " & doc.Codigo(0) & ".")
	Call corpo.AddNewLine(2)
	Call corpo.Appendtext("Área: " & doc.Area(0))
	Call corpo.AddNewLine(1)
	Call corpo.Appendtext("Descrição: " & doc.Descricao(0))
	Call corpo.AddNewLine(2)
	Call corpo.Appendtext("Negócio: ")
	Call corpo.AppendDocLink(doc, "Link para o Negócio")
	If Not planilha Is Nothing Then
		Call corpo.AddNewLine(2)
		Call corpo.Appendtext("Planilha Financeira: ")
		Call corpo.AppendDocLink(planilha, "Link para a Planilha Financeira")
	End If
	Call corpo.AddNewLine(2)
	Call corpo.Appendtext(nome.Common & ",")
	Call corpo.AddNewLine(1)
	Call corpo.Appendtext("TDec Network Group")
	Call memo.Send(False)
	
End Sub

'++LotusScript Development Environment:2:2:CheckStatusCQ:1:8
Sub CheckStatusCQ (doc As NotesDocument)
	
	Dim sit As String
	'Projeto
	If doc.TipoVenda(0) = "Projeto" Or doc.TipoVenda(0) = "Chamado" Then
		'Pendências TDec
		If doc.PendenciaExecucao(0) = "" And doc.PendenciaDocumento(0) = "" Then
			sit = "Pendente"
		Elseif doc.PendenciaExecucao(0) <> "Não" Or doc.PendenciaDocumento(0) <> "Não" Then
			sit = "Aguardando Pendências TDec"
			'Ligação para o Cliente
		Elseif doc.PendenciaCliente(0) <> "Não" Or doc.ConformidadeProjeto(0) <> "Sim" Or doc.NivelSatisfacao(0) = "" Then
			sit = "Aguardando Pendências de Ligação"
			'Aceite do Projeto
		Elseif doc.AceiteEncaminhado(0) <> "Sim" Or doc.AceiteAssinado(0) <> "Sim" Or ckAceite(doc) <> True Then
			sit = "Aguardando Aceite de Projeto"
			'Conclusão do Controle de Qualidade
		Else
			sit = "Concluído"
		End If
		'Venda Simples
	Elseif doc.TipoVenda(0) = "Venda Simples" Then
		'Ligação para o Cliente
		If doc.PendenciaCliente(0) = "" And doc.ConformidadeProjeto(0) = "" And doc.NivelSatisfacao(0) = "" Then
			sit = "Pendente"
		Elseif doc.PendenciaCliente(0) <> "Não" Or doc.ConformidadeProjeto(0) <> "Sim" Or doc.NivelSatisfacao(0) = "" Then
			sit = "Aguardando Pendências de Ligação"
			'Conclusão do Controle de Qualidade
		Else
			sit = "Concluído"
		End If
	End If
	doc.SitCQ = sit
	
End Sub

'++LotusScript Development Environment:2:2:AprovarMargemFator:5:8
%REM
	Sub AprovarMargemFator
	Description: Comments for Sub
%END REM
Sub AprovarMargemFator(doc As NotesDocument)
	
	Dim session As New NotesSession
	Dim nome As New NotesName(session.Effectiveusername)
	'Frete de Projeto
	If doc.TipoAprovacao(0) = "Frete Projeto" Then
		doc.Status_FreteProjeto = "Aprovado"
		doc.AprovadoPor_FreteProjeto = nome.Common
		doc.DataAprovacao_FreteProjeto = Now
		GoTo fim
	'Frete de Revenda
	ElseIf doc.TipoAprovacao(0) = "Frete Revenda" Then
		doc.Status_FreteRevenda = "Aprovado"
		doc.AprovadoPor_FreteRevenda = nome.Common
		doc.DataAprovacao_FreteRevenda = Now
	'Margem de Item
	ElseIf doc.TipoAprovacao(0) = "Margem Item" Then
		doc.Status_MI = "Aprovado"
		doc.AprovadoPor_MI = nome.Common
		doc.DataAprovacao_MI = Now
	'Fator de Importação
	ElseIf doc.TipoAprovacao(0) = "FI" Then
		doc.Status_FI = "Aprovado"
		doc.AprovadoPor_FI = nome.Common
		doc.DataAprovacao_FI = Now
		doc.FIAprovado_HW = doc.FISolicitado_HW(0)
		doc.FIAprovado_SW = doc.FISolicitado_SW(0)
		doc.FIAprovado_SV = doc.FISolicitado_SV(0)
	'Margem Negócio/Materiais/Serviços
	Else
		doc.StatusMg = "Aprovado"
		doc.AprovadoPor = nome.Common
		doc.DataAprovacao = Now
		doc.MgAprovada = doc.MgSolicitada(0)
	End If
	
	'*** Fechamento ***
	'Consolida os Cenários
	Call ConsolidaCenarios(doc)
	'Fechamento
	doc.DataFechamento = Now
	doc.SitNumero =  16
	doc.DFechado =  Now
	doc.TipoNegocio =  "Negócio"
	'Faturamento Futuro
	If CStr(doc.DataFaturamentoFuturo(0)) <> "" Then
		doc.Sit =  "Faturamento Futuro"
	'Fechamento
	Else
		If doc.TipoVenda(0) = "Contrato" Then
			doc.Sit = "Contrato"
		Else
			doc.Sit = "Fechado"
		End If
		Call Fechamento(doc)
		Call doc.Save(False, False)
		'Atualiza Projeto/Contrato
		Call ProjetoContrato(doc, "Fechamento")
		'Gera Controle Financeiro Planejado
		Call GeraControleDoc(doc, "Planejado")
	End If
	'***
fim:
	'Envia Email de Aprovação da Margem Prevista
	Call AvisoMgPrevista(doc, "Aprovado")
	Call doc.Save(False, False)
	
End Sub

'++LotusScript Development Environment:2:2:SaveListaMateriais:1:8
Sub SaveListaMateriais(doc As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(doc.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim item As NotesDocument, itemAnterior As NotesDocument
	Dim scan As Integer, status As String, form As String
	If doc.Form(0) = "Projeto" Or doc.Form(0) = "Contrato" Then
		form = "Planilha"
		Set view = db.Getview("(NegocioNPlanilhas)")
		If Fechado(doc.StatusNegocio(0)) Then status = "Ativa" Else status = "Inativa"
	Else
		form = "Item"
		Set view = db.Getview("(NegocioNItens)")
		If doc.Form(0) = "Requisicao" Then
			If Fechado(doc.Status(0)) Then status = "Ativo" Else status = "Inativo"
		Else
			If Fechado(doc.Sit(0)) Then status = "Ativo" Else status = "Inativo"
		End If
	End If
	For scan = 0 To 49
		Set itemAnterior = view.Getdocumentbykey(doc.Codigo(0) & "-" & (scan+1), True)
		If doc.Getitemvalue("Produto_" & scan)(0) <> "" Then
			'Verifica se o Item já existe
			If Not itemAnterior Is Nothing Then
				Set item = itemAnterior
			Else
				Set item = New NotesDocument(db)
				item.Form = form
				item.Id = geraJavaId(item)
				item.IdOrigem = doc.Id(0)
				item.Codigo = doc.Codigo(0)
				item.NItem = CStr(scan+1)
				item.Autor = session.CommonUserName
				item.Criacao = Now
				'Campos de Controle
				item.QCompra = 0
				item.VlCompra = 0
				item.QDanfe = 0
				item.QPreBaixa = 0
				item.QSimplesFaturamento = 0
				item.QBaixa = 0
				item.QFat = 0
				item.QRecibo = 0
			End If
			item.Status = status
			item.Q = Val(doc.GetItemValue("Q_" & scan)(0))
			item.PartNo = doc.GetItemValue("PartNo_" & scan)(0)
			item.Produto = doc.GetItemValue("Produto_" & scan)(0)
			item.Un = doc.GetItemValue("Un_" & scan)(0)
			item.CF = doc.GetItemValue("CF_" & scan)(0)
			item.ST = doc.GetItemValue("ST_" & scan)(0)
			item.Fabricante = doc.GetItemValue("Fabricante_" & scan)(0)
			item.UFCompra = doc.GetItemValue("UFCompra_" & scan)(0)
			item.UFVenda = doc.UF(0)
			item.US = doc.GetItemValue("Us_" & scan)(0)
			If IsNumeric(doc.GetItemValue("CustoFOB_" & scan)(0)) Then item.CustoFOB = doc.GetItemValue("CustoFOB_" & scan)(0) Else item.CustoFOB = 0
			If IsNumeric(doc.GetItemValue("FI_" & scan)(0)) Then item.FI = doc.GetItemValue("FI_" & scan)(0) Else item.FI = 0
			If IsNumeric(doc.GetItemValue("Custo_" & scan)(0)) Then item.Custo = doc.GetItemValue("Custo_" & scan)(0) Else item.Custo = 0
			If IsNumeric(doc.GetItemValue("ICMSSTC_" & scan)(0)) Then item.ICMSSTC = doc.GetItemValue("ICMSSTC_" & scan)(0) Else item.ICMSSTC = 0
			If IsNumeric(doc.GetItemValue("Mg_" & scan)(0)) Then item.Mg = doc.GetItemValue("Mg_" & scan)(0) Else item.Mg = 0
			If IsNumeric(doc.GetItemValue("CustoUnit_" & scan)(0)) Then item.CustoUnit = doc.GetItemValue("CustoUnit_" & scan)(0) Else item.CustoUnit = 0
			If IsNumeric(doc.GetItemValue("CusTot_" & scan)(0)) Then item.CusTot = doc.GetItemValue("CusTot_" & scan)(0) Else item.CusTot = 0
			If IsNumeric(doc.GetItemValue("ICMSST_" & scan)(0)) Then item.ICMSST = doc.GetItemValue("ICMSST_" & scan)(0) Else item.ICMSST = 0
			If IsNumeric(doc.GetItemValue("BCICMSST_" & scan)(0)) Then item.BCICMSST = doc.GetItemValue("BCICMSST_" & scan)(0) Else item.BCICMSST = 0
			item.FIReal = 0
			item.T = doc.GetItemValue("T_" & scan)(0)
			If IsNumeric(doc.GetItemValue("ICC_" & scan)(0)) Then item.ICC = doc.GetItemValue("ICC_" & scan)(0) Else item.ICC = 0
			If IsNumeric(doc.GetItemValue("IC_" & scan)(0)) Then item.IC = doc.GetItemValue("IC_" & scan)(0) Else item.IC = 0
			If IsNumeric(doc.GetItemValue("ICD_" & scan)(0)) Then item.ICD = doc.GetItemValue("ICD_" & scan)(0) Else item.ICD = 0
			If IsNumeric(doc.GetItemValue("FCP_" & scan)(0)) Then item.FCP = doc.GetItemValue("FCP_" & scan)(0) Else item.FCP = 0
			If IsNumeric(doc.GetItemValue("IPC_" & scan)(0)) Then item.IPIC = doc.GetItemValue("IPC_" & scan)(0) Else item.IPIC = 0
			If IsNumeric(doc.GetItemValue("IP_" & scan)(0)) Then item.IPI = doc.GetItemValue("IP_" & scan)(0) Else item.IPI = 0
			If IsNumeric(doc.GetItemValue("II_" & scan)(0)) Then item.II = doc.GetItemValue("II_" & scan)(0) Else item.II = 0
			If IsNumeric(doc.GetItemValue("IS_" & scan)(0)) Then item.ISS = doc.GetItemValue("IS_" & scan)(0) Else item.ISS = 0
			If IsNumeric(doc.GetItemValue("AliquotaPIS_" & scan)(0)) Then item.AliquotaPIS = doc.GetItemValue("AliquotaPIS_" & scan)(0) Else item.AliquotaPIS = 0
			If IsNumeric(doc.GetItemValue("AliquotaCOFINS_" & scan)(0)) Then item.AliquotaCOFINS = doc.GetItemValue("AliquotaCOFINS_" & scan)(0) Else item.AliquotaCOFINS = 0
			'Link para a Origem
			If item.Hasitem("LinkNegocio") Then item.Removeitem("LinkNegocio")
			Dim ligacao As NotesRichTextItem
			Set ligacao = item.CreateRichTextItem("LinkNegocio")
			Call ligacao.AppendDocLink(doc, "Link para o " & doc.Form(0) & " " & doc.Codigo(0))
			Call item.Save(True, True)
		Else
			If Not itemAnterior Is Nothing Then
				Call itemAnterior.Remove(True)
			End If
		End If
	Next
	
	'Atualiza o Status das Planilhas geradas por Cotação Financeira
	If doc.Form(0) = "Projeto" Then
		Dim dc As NotesDocumentCollection
		Set dc = view.Getalldocumentsbykey(doc.Codigo(0) & "-", False)
		Set item = dc.Getfirstdocument()
		Do Until item Is Nothing
			item.Status = status
			Call item.Save(True, True)
			Set item = dc.Getnextdocument(item)
		Loop
	End If
	
End Sub

'++LotusScript Development Environment:2:2:AtualizaSitGerente:1:8
Sub AtualizaSitGerente(negocio As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "pessoal.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Set view = db.GetView("(Funcionarios/Geral/UserName)")
	Set doc = view.GetDocumentByKey(negocio.GerenteConta(0), True)
	If Not doc Is Nothing Then
		negocio.SitGerente = doc.Status(0)
	End If
	
End Sub

'++LotusScript Development Environment:2:2:Desfechamento:5:8
%REM
	Sub DesfechamentoDoc
	Description: Comments for Sub
%END REM
Sub Desfechamento(negocio As NotesDocument)
	
	Dim  lista As New NotesDatabase(negocio.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection, dcReceber As NotesDocumentCollection
	Dim doc As NotesDocument, receber As NotesDocument
	Set view = lista.GetView( "(NegocioForm)" )
	'Atualiza Metas - LMO 11/02/09
	'Call AtualizaMetasNegocio(negocio, "Cancela")
	'Altera Status
	If negocio.Form(0) = "Negocio" Then
		negocio.Sit = "Forecast"
		negocio.SitNumero = 2
		negocio.DataRetornoForecast = Today
		negocio.DataFechamento = ""
		negocio.DataFaturamentoFuturo = ""
		negocio.Desfechado = "Sim"
		Call Forecast(negocio)
		'Salva Lista de Serviços no db Listas
		Call SaveListaServicos(negocio)
		'Atualiza Projeto/Contrato
		Call ProjetoContrato(negocio, "Desfechamento")
	End If
	'Salva Lista de Materiais no db Listas
	Call SaveListaMateriais(negocio)
	'Zera Saldos na Cotação de Compras
	Call Cotacao(negocio)
	If Not negocio.Save(False, False) Then
		MessageBox("Os Dados do Negócio " & negocio.Codigo(0) & " não foram Atualizados pois o Negócio encontra-se aberto por outra sessão")
	End If
	
End Sub




'++LotusScript Development Environment:2:1:ExtratoPerda:1:8
Function ExtratoPerda(negocio As NotesDocument) As Variant
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim array(7) As Double
	Set db = session.CurrentDatabase
	'*** Atividades de Vendas
	Set view = db.GetView("(Atividades)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		array(0) = array(0) + doc.Valor_0(0) + doc.Valor_1(0) + doc.Valor_2(0) + doc.Valor_3(0) + doc.Valor_4(0)
		Set doc = dc.GetNextDocument(doc)
	Loop
	'*** Horas de Vendas
	Set view = db.GetView("(Logs/Codigo)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.Sit(0) = "Inativo" Then
			Dim dataI As New NotesDateTime(doc.Entrada(0))
			Dim dataF As New NotesDateTime(doc.Saida(0))
			array(1) = array(1) + Round(dataF.TimeDifference(dataI) / 3600, 1)
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	'Time Sheet
	Set db = New NotesDatabase(negocio.ParentDatabase.Server, "timesheet.nsf")
	Set view = db.GetView("(TimeSheet/Codigo)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.Tipo(0) = "PV" Then
			'*** Despesas de Pré-Venda
			array(2) = array(2) + doc.Valor_0(0) + doc.Valor_1(0) + doc.Valor_2(0) + doc.Valor_3(0) + doc.Valor_4(0)
			'*** Horas de Pré-Venda
			array(3) = array(3) + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
		ElseIf doc.Tipo(0) = "POC" Then
			'*** Despesas de POC
			array(4) = array(4) + doc.Valor_0(0) + doc.Valor_1(0) + doc.Valor_2(0) + doc.Valor_3(0) + doc.Valor_4(0)
			'*** Horas de POC
			array(5) = array(5) + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
		Elseif doc.Tipo(0) <> "G" Then
			'*** Despesas de Execução
			array(6) = array(6) + doc.Valor_0(0) + doc.Valor_1(0) + doc.Valor_2(0) + doc.Valor_3(0) + doc.Valor_4(0)
			'*** Horas de Execução
			array(7) = array(7) + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	ExtratoPerda = array
	'Salva Extrato de Horas e Despesas no Negócio - LMO 27/02/09
	negocio.DespVendas = array(0)
	negocio.HorasVendas = array(1)
	negocio.DespPV = array(2)
	negocio.HorasPV = array(3)
	negocio.DespPOC = array(4)
	negocio.HorasPOC = array(5)
	negocio.DespExec = array(6)
	negocio.HorasExec = array(7)
	negocio.DespTot = array(0) + array(2) + array(4) + array(6)
	negocio.HorasTot = array(1) + array(3) + array(5) + array(7)
	Call negocio.Save(True, True)
	
End Function

'++LotusScript Development Environment:2:1:GetVisitas:5:8
%REM
	Function GetValoresVisitas
	Description: Comments for Function
%END REM
Function GetVisitas(codigo As String) As Double
	
	'Despesas
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Set db = New NotesDatabase(session.CurrentDatabase.Server, "caixa.nsf")
	Set view = db.GetView("(DespesasNegocio)")
	Set dc = view.GetAllDocumentsByKey(codigo, True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If (doc.TipoCusto(0) = "Custo Variavel" And InStr(doc.Origem(0), "Visita") > 0) Or (doc.TipoCusto(0) = "Despesa Operacional" And InStr(doc.Origem(0), "Atividade de Vendas") > 0) Then
				If CStr(doc.Pagamento(0)) <> "" Then
				'Primeiro Pagamento
				If dataPagamento = "" Then dataPagamento = doc.Pagamento(0)
				If CDat(doc.Pagamento(0)) < CDat(dataPagamento) Then dataPagamento = doc.Pagamento(0)
			End If
			GetVisitas = GetVisitas + doc.TotTot(0)
		End If
		Set doc = dc.Getnextdocument(doc)
	Loop
		
End Function








'++LotusScript Development Environment:2:1:ConsisteCamposFechamento:5:8
%REM
	Function ConsisteCamposFechamento
	Description: Comments for Function
%END REM
Function ConsisteCamposFechamento(uidoc As NotesUIDocument) As Boolean
	
	ConsisteCamposFechamento = True
	'Prazo de Pagamento, Condição de Pagamento, Número do Pedido
	If uidoc.FieldGetText("PrazoPagamento") = "" Then
		MsgBox "Você precisa cadastrar o Prazo de Pagamento para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "PrazoPagamento" )
		ConsisteCamposFechamento = False
		Exit Function
	ElseIf uidoc.FieldGetText("CondPagto") = "" Then
		MsgBox "Você precisa cadastrar a Condição de Pagamento para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "CondPagto" )
		ConsisteCamposFechamento = False
		Exit Function
	ElseIf uidoc.FieldGetText("TipoPagto") = "" Then
		MsgBox "Você precisa cadastrar o Tipo de Pagamento para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "TipoPagto" )
		ConsisteCamposFechamento = False
		Exit Function
	ElseIf uidoc.FieldGetText("Pedido") = "" Then
		MsgBox "Você precisa informar o Número do Pedido do Cliente", 16, "Erro !"
		Call uidoc.GotoField( "Pedido" )
		ConsisteCamposFechamento = False
		Exit Function
	%REM
	Else
		If uidoc.FieldGetText("CondPagto") = "D.D.L." Then
			'Último dia do mês atual
			Dim data As New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
			Call data.Adjustmonth(1, True)
			Call data.Adjustday(-1, True)
			Call data.Isvaliddate
 		End If
	%END REM	
	End If
	%REM
	'Verifica o preenchimento da Lista de Materiais e Serviços
	If Not checkItensLista(uidoc) Then
		ConsisteCamposFechamento = False
		Exit Function
	End If
	%END REM
	'Verifica os Comissionamentos
	If Not ckComissionamento(uidoc.Document) Then
		ConsisteCamposFechamento = False
		Exit Function
	End If
	
End Function

'++LotusScript Development Environment:2:2:DeletarEspelhosReceber:5:8
%REM
	Sub DeletarEspelhosReceber
	Description: Comments for Sub
%END REM
Sub DeletarEspelhosReceber(negocio As NotesDocument, tipo As String)
	
	'Remove Espelhos, Recibos e Receber Pendentes
	Dim resp As Integer
	If tipo = "Espelho" Then
		resp = MsgBox("Confirma a exclusão dos Espelhos de Faturamento do Contrato?", 36, "Deletar Espelhos de Faturamento")
	Else
		resp = MsgBox("Confirma a exclusão das Faturas e Receber Pendentes do Contrato?", 36, "Deletar Faturas e Receber")
	End If
	If resp <> 6 Then
		Exit Sub
	End If
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection, dcReceber As NotesDocumentCollection
	Dim doc As NotesDocument, receber As NotesDocument
	Dim scan As Integer
	Set view = db.GetView("(EspelhosNegocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	For scan = 1 To dc.Count
		Set doc = dc.GetNthDocument(scan)
		If Not doc Is Nothing Then
			'Espelhos
			If tipo = "Espelho" And doc.Sit(0) = "Espelho" Then
				Call doc.Remove(True)
			'Faturas e Receber Pendentes
			Else
				If CStr(doc.NFiscal(0)) = "" Then
					'Receber
					Set dcReceber = doc.Responses
					Set receber = dcReceber.Getfirstdocument()
					Do Until receber Is Nothing
						If receber.Sit(0) <> "a Receber" Then
							Exit For
						End If
						Set receber = dcReceber.Getnextdocument(receber)
					Loop
					Call doc.Remove(True)
					Call dcReceber.RemoveAll( True )
				End If
			End If
		End If
	Next
	MsgBox "Faturas, Recibos e Receber do Contrato excluídos.", 64, "Aviso"
	
End Sub

'++LotusScript Development Environment:2:1:CheckFI:5:8
%REM
	Function CheckFI
	Description: Comments for Function
%END REM
Function CheckFI(doc As NotesDocument, tipo As String) As Boolean
	
	On Error Resume Next
	CheckFI = True
	Dim scan As Integer, x As Integer, y As Integer, z As Integer, FIMinimo As Double, array(2) As Double
	For scan = 0 To 49
		If CStr(doc.Getitemvalue("FI_" & scan)(0)) <> "" Then
			If doc.Getitemvalue("T_" & scan)(0) = "HW" Then
				If CStr(doc.FIAprovado_HW(0)) <> "" And doc.Status_FI(0) = "Aprovado" Then FIMinimo = doc.FIAprovado_HW(0) Else FIMinimo = doc.FI_HW(0)
				If FIMinimo > doc.FI_HW(0) Then FIMinimo = doc.FI_HW(0)
				If doc.Getitemvalue("FI_" & scan)(0) < FIMinimo Then
					If x = 0 Then
						array(0) = doc.Getitemvalue("FI_" & scan)(0)
						x = x + 1
					Else
						If doc.Getitemvalue("FI_" & scan)(0) < array(0) Then
							array(0) = doc.Getitemvalue("FI_" & scan)(0)
						End If
					End If 
					CheckFI = False
				End If
			ElseIf doc.Getitemvalue("T_" & scan)(0) = "SW" Then
				If CStr(doc.FIAprovado_SW(0)) <> "" And doc.Status_FI(0) = "Aprovado" Then FIMinimo = doc.FIAprovado_SW(0) Else FIMinimo = doc.FI_SW(0)
				If FIMinimo > doc.FI_SW(0) Then FIMinimo = doc.FI_SW(0)
				If doc.Getitemvalue("FI_" & scan)(0) < FIMinimo Then
					If y = 0 Then
						array(1) = doc.Getitemvalue("FI_" & scan)(0)
						y = y + 1
					Else
						If doc.Getitemvalue("FI_" & scan)(0) < array(1) Then
							array(1) = doc.Getitemvalue("FI_" & scan)(0)
						End If
					End If
					CheckFI = False
				End If
			ElseIf doc.Getitemvalue("T_" & scan)(0) = "SV" Then
				If CStr(doc.FIAprovado_SV(0)) <> "" And doc.Status_FI(0) = "Aprovado" Then FIMinimo = doc.FIAprovado_SV(0) Else FIMinimo = doc.FI_SV(0)
				If FIMinimo > doc.FI_SV(0) Then FIMinimo = doc.FI_SV(0)
				If doc.Getitemvalue("FI_" & scan)(0) < FIMinimo Then
					If z = 0 Then
						array(2) = doc.Getitemvalue("FI_" & scan)(0)
						z = z + 1
					Else
						If doc.Getitemvalue("FI_" & scan)(0) < array(2) Then
							array(2) = doc.Getitemvalue("FI_" & scan)(0)
						End If
					End If
					CheckFI = False
				End If
			End If
		End If
	Next
	'Print dos Fatores de Importação no Negócio
	If Not CheckFI Then
		If tipo = "Solicita Aprovação" Then
			doc.FISolicitado_HW = array(0)
			doc.FISolicitado_SW = array(1)
			doc.FISolicitado_SV = array(2)
		ElseIf tipo = "Aprovado" Then
			doc.FIAprovado_HW = array(0)
			doc.FIAprovado_SW = array(1)
			doc.FIAprovado_SV = array(2)
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:AtualizaDadosGerentesDoNamesAddresBook:7:8
%REM
	Sub AtualizaDadosGerenteNoNAB
	mcastro em 27/02/2015
	Description: Busca informações de email, telefone, celular etc no names address book do Notes
	utilizado para prenchimento automático das propostas
%END REM
Sub AtualizaDadosGerentesDoNamesAddresBook(negocio As NotesDocument)

	Dim nab As New NotesDatabase(negocio.Parentdatabase.Server,"names.nsf")
	Dim view As NotesView
	Set view = nab.Getview("($NamesFieldLookup)")
	Dim doc As NotesDocument
	Dim gerente As String, inside As String
	gerente = negocio.GerenteConta(0)
	inside = negocio.Inside(0)
	Set doc = view.Getdocumentbykey(gerente, true)
	If Not (doc Is Nothing) Then
		negocio.EmailGerenteConta = doc.InternetAddress
		negocio.CargoGerenteConta = doc.JobTitle
		negocio.TelefoneGerenteConta = doc.OfficePhoneNumber
		negocio.CelularGerenteConta = doc.CellPhoneNumber
	End If
	
	Set doc = view.Getdocumentbykey(inside, True)
	If Not (doc Is Nothing) Then
		negocio.EmailInside = doc.InternetAddress
		negocio.CargoInside = doc.JobTitle
		negocio.TelefoneInside = doc.OfficePhoneNumber
		negocio.CelularInside = doc.CellPhoneNumber
	End If
	
End Sub

'++LotusScript Development Environment:2:2:ConclusaoNegocio:5:8
%REM
	Sub ConclusaoNegocio
	Description: Comments for Sub
%END REM
Sub ConclusaoNegocio(negocio As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "sales.nsf")
	Dim newDoc As NotesDocument
	Set newDoc = db.CreateDocument
	newDoc.Form = "ConclusaoNegocio"
	newDoc.Codigo = negocio.Codigo(0)
	Call PopulaConclusaoNegocio(newDoc)
	Call AvisoConclusaoNegocio(negocio, newDoc)
	negocio.CheckConclusao = "OK"
	
End Sub


'++LotusScript Development Environment:2:2:LoadListaMateriais:5:8
%REM
	Sub LoadListaMateriais
	Description: Não Mantém a Ordem dos Itens e Ocupa as Linhas em Branco
%END REM
Sub LoadListaMateriais(doc As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(doc.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim item As NotesDocument
	Dim scan As Integer
	Dim key(1) As String
	Set view = db.GetView("(NegocioForm)")
	If doc.Form(0) = "Projeto" Then
		key(0) = doc.Codigo(0) & "Planilha"
	Else
		key(0) = doc.Codigo(0) & "Item"
	End If
	For scan = 0 To 49
		key(1) = CStr(scan + 1)
		Set item = view.GetDocumentByKey(key, True)
		If Not item Is Nothing Then
			Call doc.ReplaceItemValue("Q_" & scan, Val(item.Q(0)))
			Call doc.ReplaceItemValue("PartNo_" & scan, item.PartNo(0))
			Call doc.ReplaceItemValue("Produto_" & scan, item.Produto(0))
			Call doc.ReplaceItemValue("T_" & scan, item.T(0))
			Call doc.ReplaceItemValue("Un_" & scan, item.Un(0))
			Call doc.ReplaceItemValue("CF_" & scan, item.CF(0))
			Call doc.ReplaceItemValue("ST_" & scan, item.ST(0))
			Call doc.ReplaceItemValue("Fabricante_" & scan, item.Fabricante(0))
			Call doc.ReplaceItemValue("UFCompra_" & scan, item.UFCompra(0))
			Call doc.ReplaceItemValue("Us_" & scan, item.Us(0))
			If item.CustoFOB(0) = 0 Then Call doc.ReplaceItemValue("CustoFOB_" & scan, "") Else Call doc.ReplaceItemValue("CustoFOB_" & scan, item.CustoFOB(0))
			If item.FI(0) = 0 Then Call doc.ReplaceItemValue("FI_" & scan, "") Else Call doc.ReplaceItemValue("FI_" & scan, item.FI(0))
			If item.Custo(0) = 0 Then Call doc.ReplaceItemValue("Custo_" & scan, "") Else Call doc.ReplaceItemValue("Custo_" & scan, item.Custo(0))
			If item.ICMSSTC(0) = 0 Then Call doc.ReplaceItemValue("ICMSSTC_" & scan, "") Else Call doc.ReplaceItemValue("ICMSSTC_" & scan, item.ICMSSTC(0))
			If item.Mg(0) = 0 Then Call doc.ReplaceItemValue("Mg_" & scan, "") Else Call doc.ReplaceItemValue("Mg_" & scan, item.Mg(0))
			If item.CustoUnit(0) = 0 Then Call doc.ReplaceItemValue("CustoUnit_" & scan, "") Else Call doc.ReplaceItemValue("CustoUnit_" & scan, item.CustoUnit(0))
			If CStr(item.CusTot(0)) = "" Then Call doc.ReplaceItemValue("CusTot_" & scan, "") Else Call doc.ReplaceItemValue("CusTot_" & scan, item.CusTot(0))
			If CStr(item.ICMSST(0)) = "" Then Call doc.ReplaceItemValue("ICMSST_" & scan, "") Else Call doc.ReplaceItemValue("ICMSST_" & scan, item.ICMSST(0))
			If CStr(item.BCICMSST(0)) = "" Then Call doc.ReplaceItemValue("BCICMSST_" & scan, "") Else Call doc.ReplaceItemValue("BCICMSST_" & scan, item.BCICMSST(0))
			If CStr(item.ICC(0)) = "" Then Call doc.ReplaceItemValue("ICC_" & scan, 0) Else Call doc.ReplaceItemValue("ICC_" & scan, item.ICC(0))
			If CStr(item.IC(0)) = "" Then Call doc.ReplaceItemValue("IC_" & scan, 0) Else Call doc.ReplaceItemValue("IC_" & scan, item.IC(0))
			If CStr(item.ICD(0)) = "" Then Call doc.ReplaceItemValue("ICD_" & scan, 0) Else Call doc.ReplaceItemValue("ICD_" & scan, item.ICD(0))
			If CStr(item.FCP(0)) = "" Then Call doc.ReplaceItemValue("FCP_" & scan, 0) Else Call doc.ReplaceItemValue("FCP_" & scan, item.FCP(0))
			If CStr(item.IPIC(0)) = "" Then Call doc.ReplaceItemValue("IPC_" & scan, 0) Else Call doc.ReplaceItemValue("IPC_" & scan, item.IPIC(0))
			If CStr(item.IPI(0)) = "" Then Call doc.ReplaceItemValue("IP_" & scan, 0) Else Call doc.ReplaceItemValue("IP_" & scan, item.IPI(0))
			If CStr(item.II(0)) = "" Then Call doc.ReplaceItemValue("II_" & scan, 0) Else Call doc.ReplaceItemValue("II_" & scan, item.II(0))
			If CStr(item.ISS(0)) = "" Then Call doc.ReplaceItemValue("IS_" & scan, 0) Else Call doc.ReplaceItemValue("IS_" & scan, item.ISS(0))
			If CStr(item.AliquotaPIS(0)) = "" Then Call doc.ReplaceItemValue("AliquotaPIS_" & scan, 0) Else Call doc.ReplaceItemValue("AliquotaPIS_" & scan, item.AliquotaPIS(0))
			If CStr(item.AliquotaCOFINS(0)) = "" Then Call doc.ReplaceItemValue("AliquotaCOFINS_" & scan, 0) Else Call doc.ReplaceItemValue("AliquotaCOFINS_" & scan, item.AliquotaCOFINS(0))
			If doc.Form(0) = "Negocio" Then
				Call doc.ReplaceItemValue("QFat_" & scan, item.Q(0) - item.QFat(0))
			End If
		Else
			Call doc.ReplaceItemValue("Q_" & scan, "")
			Call doc.ReplaceItemValue("PartNo_" & scan, "")
			Call doc.ReplaceItemValue("Produto_" & scan, "")
			Call doc.ReplaceItemValue("T_" & scan, "")
			Call doc.ReplaceItemValue("Un_" & scan, "")
			Call doc.ReplaceItemValue("CF_" & scan, "")
			Call doc.ReplaceItemValue("ST_" & scan, "")
			Call doc.ReplaceItemValue("Fabricante_" & scan, "")
			Call doc.ReplaceItemValue("UFCompra_" & scan, "")
			Call doc.ReplaceItemValue("Us_" & scan, "R$")
			Call doc.ReplaceItemValue("CustoFOB_" & scan, "")
			Call doc.ReplaceItemValue("FI_" & scan, "")
			Call doc.ReplaceItemValue("Custo_" & scan, "")
			Call doc.ReplaceItemValue("ICMSSTC_" & scan, "")
			Call doc.ReplaceItemValue("Mg_" & scan, "")
			Call doc.ReplaceItemValue("CustoUnit_" & scan, "")
			Call doc.ReplaceItemValue("CusTot_" & scan, "")
			Call doc.ReplaceItemValue("ICMSST_" & scan, "")
			Call doc.ReplaceItemValue("VendaTot_" & scan, "")
			Call doc.ReplaceItemValue("BCICMSST_" & scan, "")
			Call doc.ReplaceItemValue("ICC_" & scan, "")
			Call doc.ReplaceItemValue("IC_" & scan, "")
			Call doc.ReplaceItemValue("ICD_" & scan, "")
			Call doc.ReplaceItemValue("FCP_" & scan, "")
			Call doc.ReplaceItemValue("IPC_" & scan, "")
			Call doc.ReplaceItemValue("IP_" & scan, "")
			Call doc.ReplaceItemValue("II_" & scan, "")
			Call doc.ReplaceItemValue("IS_" & scan, "")
			Call doc.ReplaceItemValue("AliquotaPIS_" & scan, "")
			Call doc.ReplaceItemValue("AliquotaCOFINS_" & scan, "")
			Call doc.ReplaceItemValue("QFat_" & scan, "")
		End If
	Next	 
	
End Sub

'++LotusScript Development Environment:2:2:LoadListaServicos:1:8
Sub LoadListaServicos(doc As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(doc.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim item As NotesDocument
	Dim scan As Integer
	Dim key(1) As String
	key(0) = doc.Codigo(0) & "Servico"
	Set view = db.GetView("(NegocioForm)")
	For scan = 0 To 11
		key(1) = CStr(scan + 1)
		Set item = view.GetDocumentByKey(key, True)
		If Not item Is Nothing Then
			Call doc.ReplaceItemValue("Qs_" & scan, Val(item.Qs(0)))
			Call doc.ReplaceItemValue("PartNos_" & scan, item.PartN(0))
			Call doc.ReplaceItemValue("Produtos_" & scan, item.Produtos(0))
			Call doc.ReplaceItemValue("Uss_" & scan, item.Us(0))
			If CStr(item.Custos(0)) = "" Then Call doc.ReplaceItemValue("Custos_" & scan, "") Else Call doc.ReplaceItemValue("Custos_" & scan, item.Custos(0))
			If CStr(item.Terceiros(0)) = "" Then Call doc.ReplaceItemValue("Terceiros_" & scan, "") Else Call doc.ReplaceItemValue("Terceiros_" & scan, item.Terceiros(0))
			If doc.Form(0) = "Negocio" Then
				If item.Mgs(0) = 0 Then Call doc.ReplaceItemValue("Mgs_" & scan, "") Else Call doc.ReplaceItemValue("Mgs_" & scan, item.Mgs(0))
				If item.CustoUnits(0) = 0 Then Call doc.ReplaceItemValue("CustoUnits_" & scan, "") Else Call doc.ReplaceItemValue("CustoUnits_" & scan, item.CustoUnits(0))
				If CStr(item.CusTots(0)) = "" Then Call doc.ReplaceItemValue("CusTots_" & scan, "") Else Call doc.ReplaceItemValue("CusTots_" & scan, item.CusTots(0))
				If CStr(item.RIR(0)) = "" Then Call doc.ReplaceItemValue("RIR_" & scan, "") Else Call doc.ReplaceItemValue("RIR_" & scan, item.RIR(0))
				If CStr(item.RIN(0)) = "" Then Call doc.ReplaceItemValue("RIN_" & scan, "") Else Call doc.ReplaceItemValue("RIN_" & scan, item.RIN(0))
				If CStr(item.ISS(0)) = "" Then Call doc.ReplaceItemValue("ISS_" & scan, "") Else Call doc.ReplaceItemValue("ISS_" & scan, item.ISS(0))
				Call doc.ReplaceItemValue("VlFat_" & scan, item.CusTots(0) - item.VlFat(0))
			End If
			If CStr(item.Despesas(0)) = "" Then Call doc.ReplaceItemValue("Despesas_" & scan, "") Else Call doc.ReplaceItemValue("Despesas_" & scan, item.Despesas(0))
			If CStr(item.CPS(0)) = "" Then Call doc.ReplaceItemValue("CPS_" & scan, "") Else Call doc.ReplaceItemValue("CPS_" & scan, item.CPS(0))
		Else
			Call doc.ReplaceItemValue("Qs_" & scan, "")
			Call doc.ReplaceItemValue("PartNos_" & scan, "")
			Call doc.ReplaceItemValue("Produtos_" & scan, "")
			Call doc.ReplaceItemValue("Uss_" & scan, "" )
			Call doc.ReplaceItemValue("Custos_" & scan, "")
			Call doc.ReplaceItemValue("Terceiros_" & scan, "")
			Call doc.ReplaceItemValue("Mgs_" & scan, "")
			Call doc.ReplaceItemValue("CustoUnits_" & scan, "")
			Call doc.ReplaceItemValue("Despesas_" & scan, "")
			Call doc.ReplaceItemValue("CPS_" & scan, "")
			Call doc.ReplaceItemValue("CusTots_" & scan, "")
			Call doc.ReplaceItemValue("RIR_" & scan, "")
			Call doc.ReplaceItemValue("RIN_" & scan, "")
			Call doc.ReplaceItemValue("ISS_" & scan, "")
			Call doc.ReplaceItemValue("VlFat_" & scan, "")
		End If
	Next
	
End Sub

'++LotusScript Development Environment:2:1:GetValoresPlanilha:5:8
%REM
	Function GetValoresPlanilha
	Description: Comments for Function
%ENDREM
Function GetValoresPlanilha(codigo As String, tipo As String) As Variant
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim planilha As NotesDocument
	Dim custos As Double, despesas As Double, cps As Double, hh As Double, vendas As Double, terceiros As Double, alugueis As Double
	Dim custosPV As Double, despesasPV As Double, hPV As Double
	Dim custosPOC As Double, despesasPOC As Double, hPOC As Double
	Dim array(12) As Double
	'array(0) = 'Custos
	'array(1) = 'Despesas
	'array(2) = 'Lista CPS(Custo)
	'array(3) = 'Horas
	'array(4) = 'Frete de Revenda
	'array(5) = 'Terceiros Faturáveis (CSV)
	'array(6) = 'Custos de Pré-venda
	'array(7) = 'Despesas de Pré-venda
	'array(8) = 'Horas de Pré-venda
	'array(9) = 'Custos de POC
	'array(10) = 'Despesas de POC
	'array(11) = 'Horas de POC
	'array(12) = 'Aluguel (Outros - Créditos de PIS/Cofins)
	If tipo = "Previsto" Then
		Set view = db.Getview("(ProjetosCodigo)")
		Set planilha = view.Getdocumentbykey(codigo, True)
		If planilha Is Nothing Then
			'Verifica se é Contrato
			Set view = db.Getview("(ContratosCodigo)")
			Set planilha = view.Getdocumentbykey(codigo, True)
		End If
		If Not planilha Is Nothing Then
			'If planilha.TipoVenda(0) = "Projeto" Or planilha.TipoVenda(0) = "Chamado" Or planilha.TipoVenda(0) = "Contrato" Then
			If CStr(planilha.CustoP(0)) <> "" Then custos = planilha.CustoP(0)
			If CStr(planilha.DespP(0)) <> "" Then despesas = planilha.DespP(0)
			If CStr(planilha.CPSP(0)) <> "" Then cps = planilha.CPSP(0)
			If CStr(planilha.HHP(0)) <> "" Then hh = planilha.HHP(0)
			If CStr(planilha.TerceirosP(0)) <> "" Then terceiros = planilha.TerceirosP(0)
			If CStr(planilha.VendasP(0)) <> "" Then vendas = planilha.VendasP(0)
			If CStr(planilha.AlugP_1(0)) <> "" Then alugueis = planilha.AlugP_1(0)
			'End If
		End If
	ElseIf tipo = "Real" Then
		Set view = db.Getview("(Planilha/Codigo)")
		Set planilha = view.Getdocumentbykey(codigo, True)
		If Not planilha Is Nothing Then
			If CStr(planilha.CustoU(0)) <> "" Then custos = planilha.CustoU(0) - planilha.MatU(0)
			If CStr(planilha.DespU(0)) <> "" Then despesas = planilha.DespU(0)
			If CStr(planilha.HHU(0)) <> "" Then hh = planilha.HHU(0)
			If CStr(planilha.TerceirosU(0)) <> "" Then terceiros = planilha.TerceirosU(0)
			If CStr(planilha.VendasU(0)) <> "" Then vendas = planilha.VendasU(0)
		End If
	End If
	'Pré-Venda e POC (Planilha Financeira) - LMO 21/10/19
	Set view = db.Getview("(Planilha/Codigo)")
	Set planilha = view.Getdocumentbykey(codigo, True)
	If Not planilha Is Nothing Then
		If tipo = "Previsto" Then
			If CStr(planilha.CustoPVT(0)) <> "" Then custosPV = planilha.CustoPVT(0)
			If CStr(planilha.DespPVT(0)) <> "" Then despesasPV = planilha.DespPVT(0)
			If CStr(planilha.HPVT(0)) <> "" Then hPV = planilha.HPVT(0)
			If CStr(planilha.CustoPOCT(0)) <> "" Then custosPOC = planilha.CustoPOCT(0)
			If CStr(planilha.DespPOCT(0)) <> "" Then despesasPOC = planilha.DespPOCT(0)
			If CStr(planilha.HPOCT(0)) <> "" Then hPOC = planilha.HPOCT(0)
		ElseIf tipo = "Real" Then
			If CStr(planilha.CustoPVU(0)) <> "" Then custosPV = planilha.CustoPVU(0)
			If CStr(planilha.DespPVU(0)) <> "" Then despesasPV = planilha.DespPVU(0)
			If CStr(planilha.HPVU(0)) <> "" Then hPV = planilha.HPVU(0)
			If CStr(planilha.CustoPOCU(0)) <> "" Then custosPOC = planilha.CustoPOCU(0)
			If CStr(planilha.DespPOCU(0)) <> "" Then despesasPOC = planilha.DespPOCU(0)
			If CStr(planilha.HPOCU(0)) <> "" Then hPOC = planilha.HPOCU(0)
		End If
	End If
	array(0) = Round(custos, 2)
	array(1) = Round(despesas, 2)
	array(2) = Round(cps, 2)
	array(3) = Round(hh, 2)
	array(4) = Round(vendas, 2)
	array(5) = Round(terceiros, 2)
	array(6) = Round(custosPV, 2)
	array(7) = Round(despesasPV, 2)
	array(8) = Round(hPV, 2)
	array(9) = Round(custosPOC, 2)
	array(10) = Round(despesasPOC, 2)
	array(11) = Round(hPOC, 2)
	array(12) = Round(alugueis, 2)
	GetValoresPlanilha = array
	
End Function

'++LotusScript Development Environment:2:2:AtualizaPrejuizo:5:8
%REM
	Sub AtualizaPrejuizo
	Description: Comments for Sub
%END REM
Sub AtualizaPrejuizo(negocio As NotesDocument)
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim indice As Variant, codigos As Variant, codigo(0) As Variant
	If negocio.CodigoOrigem(0) <> "" Then
		Set db = session.Currentdatabase
		Set view = db.Getview("(Prejuizos/Codigo)")
		Set doc = view.Getdocumentbykey(negocio.CodigoOrigem(0), True)
		If Not doc Is Nothing Then
			indice = ArrayGetIndex(doc.NovoCodigo, negocio.Codigo(0))
			If IsNull(indice) Then
				codigo(0) = negocio.Codigo(0)
				codigos = ArrayAppend(codigo, doc.NovoCodigo)
				doc.NovoCodigo = codigos
				doc.Sit = "Prejuízo Compensado em Outro Negócio"
				Call doc.Save(False, False)
			End If
		End If
	End If
	
End Sub

'++LotusScript Development Environment:2:2:GetTotalFaturado:5:8
%REM
	Sub GetTotalFaturado
	Description: Comments for Sub
%END REM
Sub GetTotalFaturado(negocio As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim dbFat As New NotesDatabase(negocio.ParentDatabase.Server,"faturas.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection, col As NotesDocumentCollection
	Dim espelho As NotesDocument, receber As NotesDocument
	Dim totalFaturado As Double, ckEspelho As String
	Set view = dbFat.GetView("(EspelhosNegocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	If dc.Count = 0 Then
		negocio.TotalFaturado = 0
		negocio.CkEspelho = ""
		Exit Sub
	End If
	Set espelho = dc.GetFirstDocument
	While Not espelho Is Nothing
		If espelho.Sit(0) = "OK" Or espelho.Sit(0) = "Emitido por Extrato" Then
			ckEspelho = "OK"
			'Receber (Nota de Débito) - LMO 06/03/25
			If espelho.Form(0) = "Recibo" And espelho.Natureza(0) = "Nota de Débito" Then
				Set col = espelho.Responses
				Set receber = col.Getfirstdocument()
				Do Until receber Is Nothing
					totalFaturado = totalFaturado + receber.TotTot(0)
					Set receber = col.Getnextdocument(receber)
				Loop
			'Espelho
			Else
				If espelho.Hasitem("TotTotComIPI") Then
					totalFaturado = totalFaturado + espelho.TotTotComIPI(0)
				Else
					totalFaturado = totalFaturado + espelho.TotTot(0)
				End If
			End If
		End If
		Set espelho = dc.GetNextDocument(espelho)
	Wend
	negocio.TotalFaturado = totalFaturado
	negocio.CkEspelho = ckEspelho
	
End Sub

'++LotusScript Development Environment:2:2:LoadServicosInternos:5:8
%REM
	Sub LoadServicosInternos
	Description: Comments for Sub
%END REM
Sub LoadServicosInternos(doc As NotesDocument)
	
	Dim db As New NotesDatabase(doc.ParentDatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim vc As NotesViewEntryCollection
	Dim entry As NotesViewEntry
	Dim negocio As NotesDocument
	Dim item As NotesRichTextItem
	Dim scan As Integer
	Dim vendaP As Double, vendaR As Double, totalP As Double, totalR As Double
	Dim key(1) As String
	key(0) = "Serviços Internos"
	key(1) = doc.Codigo(0)
	Set view = db.GetView("(Adendos)")
	Set vc = view.Getallentriesbykey(key, True)
	Set entry = vc.Getfirstentry()
	Do Until entry Is Nothing
		Set negocio = entry.Document
		If doc.HasItem("LinkNegocio_" & scan) Then doc.RemoveItem("LinkNegocio_" & scan)
		Set item = doc.CreateRichTextItem("LinkNegocio_" & scan)
		Call item.AppendDocLink(negocio, "Link para o Negócio")
		Call doc.ReplaceItemValue("Ck_" & scan, "")
		Call doc.ReplaceItemValue("Codigo_" & scan, negocio.Codigo(0))
		Call doc.ReplaceItemValue("Area_" & scan, negocio.Area(0))
		Call doc.ReplaceItemValue("Tipo_" & scan, negocio.TipoVenda(0))
		Call doc.ReplaceItemValue("Desc_" & scan, negocio.Descricao(0))
		Call doc.ReplaceItemValue("Dias_" & scan, CStr(Val(negocio.Dias(0))))
		Call doc.ReplaceItemValue("Status_" & scan, negocio.Sit(0))
		If negocio.Sit(0) <> "Consolidado" And negocio.Sit(0) <> "Perdido" And negocio.Sit(0) <> "" And negocio.Sit(0) <> "Postergado" Then
			If CStr(negocio.Venda_P(0)) = "" Then vendaP = 0 Else vendaP = negocio.Venda_P(0)
			If CStr(negocio.Venda_R(0)) = "" Then vendaR = 0 Else vendaR = negocio.Venda_R(0)
			Call doc.ReplaceItemValue("VendaP_" & scan, vendaP)
			Call doc.ReplaceItemValue("VendaR_" & scan, vendaR)
			totalP = totalP + vendaP
			totalR = totalR + vendaR
		Else
			Call doc.ReplaceItemValue("VendaP_" & scan, 0)
			Call doc.ReplaceItemValue("VendaR_" & scan, 0)
		End If
		Set entry = vc.Getnextentry(entry)
		scan = scan + 1
	Loop
	'Limpa Linhas não utilizadas
	For scan = scan To 9
		Call doc.ReplaceItemValue("Ck_" & scan, "")
		Call doc.ReplaceItemValue("LinkNegocio_" & scan, "")
		Call doc.ReplaceItemValue("Codigo_" & scan, "")
		Call doc.ReplaceItemValue("Area_" & scan, "")
		Call doc.ReplaceItemValue("Tipo_" & scan, "")
		Call doc.ReplaceItemValue("Desc_" & scan, "")
		Call doc.ReplaceItemValue("Dias_" & scan, "")
		Call doc.ReplaceItemValue("Status_" & scan, "")
		Call doc.ReplaceItemValue("VendaP_" & scan, "")
		Call doc.ReplaceItemValue("VendaR_" & scan, "")
	Next
	doc.VendaT_P = totalP
	doc.VendaT_R = totalR
	
End Sub

'++LotusScript Development Environment:2:1:CalcPis:1:8
Function CalcPis( doc As NotesDocument ) As Double
		
	If doc.TipoNota(0) = "Entrada" Then
		CalcPis# = (doc.TotalServicos(0) + doc.TotalProdutos(0)) * aliquota(0) * - 1
	Else
		CalcPis# = (doc.TotalServicos(0) + doc.TotalProdutos(0)) * aliquota(0)
	End If
	
End Function


'++LotusScript Development Environment:2:2:Cotacao:5:8
%REM
	Sub Cotacao
	Description: Comments for Sub
%END REM
Sub Cotacao(docAtu As NotesDocument)
	
	'1) Cria/Atualiza Cotação em Compras
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.CurrentDatabase.Server, "compras.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument, cotacao As NotesDocument
	Dim scan As Integer, x As Integer
	Dim array As Variant, custoFOB As Double
	ReDim key(1) As String
	key(0) = docAtu.Codigo(0)
	key(1) = docAtu.Form(0)
	Set view = db.Getview("(Cotacoes/Codigo)")
	Set doc = view.Getdocumentbykey(key, True)
	'Cotação já existe
	If Not doc Is Nothing Then
		Set cotacao = doc
	Else
		Set cotacao = New NotesDocument(db)
		cotacao.Form = "Cotacao"
		cotacao.Id = geraJavaId(cotacao)
		cotacao.Autor = session.CommonUserName
		cotacao.Criacao = Now
	End If
	cotacao.Tipo = docAtu.Form(0)
	cotacao.CodEmpresa = docAtu.CodEmpresa(0)
	cotacao.Codigo = docAtu.Codigo(0)
	cotacao.CodClienteFaturamento = docAtu.CodClienteFaturamento(0)
	cotacao.Descricao = docAtu.Descricao(0)
	'Campos de Controle das Despesas
	cotacao.AreaDespesa = docAtu.AreaDespesa(0)
	cotacao.ResponsavelDespesa = docAtu.ResponsavelDespesa(0)
	cotacao.TipoCompra = docAtu.TipoCompra(0)
	cotacao.TipoVenda = docAtu.TipoVenda(0)
	cotacao.Tag = docAtu.Tag(0)
	cotacao.ClassificacaoDespesa = docAtu.ClassificacaoDespesa(0)
	cotacao.Areas = docAtu.Areas
	cotacao.Overhead = docAtu.Overhead
	'
	If docAtu.Form(0) = "Negocio" Or docAtu.Form(0) = "Projeto" Then
		cotacao.Area = docAtu.AreaVendas(0)
		If docAtu.Area(0) = "" Then
			cotacao.AreaServicos = docAtu.AreaVendas(0)
		Else
			cotacao.AreaServicos = docAtu.Area(0)
		End If
		cotacao.GerenteConta = docAtu.GerenteConta
		cotacao.Inside = docAtu.Inside
	Else
		cotacao.Area = docAtu.Area(0)
		cotacao.AreaServicos = docAtu.Area(0)
		cotacao.GerenteConta = docAtu.Requisitante
		cotacao.Inside = docAtu.Requisitante
	End If
	For scan = 0 To 49
		array = docAtu.GetItemValue("Produto_" & scan)
		If array(0) = "" Then
			Call cotacao.ReplaceItemValue("Produto_" & scan, "")
			Call cotacao.ReplaceItemValue("us_" & scan, "")
			Call cotacao.ReplaceItemValue("T_" & scan, "")
			Call cotacao.ReplaceItemValue("UF_" & scan, "")
			Call cotacao.ReplaceItemValue("S_" & scan, "")
			Call cotacao.ReplaceItemValue("A_" & scan, "")
			Call cotacao.ReplaceItemValue("VA_" & scan, "")
			Call cotacao.ReplaceItemValue("B_" & scan, "")
			Call cotacao.ReplaceItemValue("VB_" & scan, "")
			Call cotacao.ReplaceItemValue("C_" & scan, "")
			Call cotacao.ReplaceItemValue("VC_" & scan, "")
			Call cotacao.ReplaceItemValue("D_" & scan, "")
			Call cotacao.ReplaceItemValue("VD_" & scan, "")
			Call cotacao.ReplaceItemValue("E_" & scan, "")
			Call cotacao.ReplaceItemValue("VE_" & scan, "")
			Call cotacao.ReplaceItemValue("Imp_" & scan, "")
			Call cotacao.ReplaceItemValue("VImp_" & scan, "")
		Else
			Call cotacao.ReplaceItemValue("Produto_" & scan, array(0))
			array = docAtu.GetItemValue("us_" & scan)
			Call cotacao.ReplaceItemValue("us_" & scan, array(0))
			array = docAtu.GetItemValue("t_" & scan)
			Call cotacao.ReplaceItemValue("t_" & scan, array(0))
			array = docAtu.GetItemValue("UFCompra_" & scan)
			Call cotacao.ReplaceItemValue("UF_" & scan, array(0))
			Call cotacao.ReplaceItemValue("A_" & scan, "")
			Call cotacao.ReplaceItemValue("B_" & scan, "")
			Call cotacao.ReplaceItemValue("C_" & scan, "")
			Call cotacao.ReplaceItemValue("D_" & scan, "")
			Call cotacao.ReplaceItemValue("E_" & scan, "")
			Call cotacao.ReplaceItemValue("Imp_" & scan, "")
			'Se tiver Custo FOB é Importação
			array = docAtu.GetItemValue("CustoFOB_" & scan)
			If CStr(array(0)) <> "" Then custoFOB = array(0) Else custoFOB = 0
			If custoFOB > 0 Then
				Call cotacao.ReplaceItemValue("VImp_" & scan, array(0))
				'Troca de Reservas de Importação - LMO 11/05/12
				array = docAtu.GetItemValue("Custo_" & scan)
				Call cotacao.ReplaceItemValue("VA_" & scan, array(0))
				Call cotacao.ReplaceItemValue("VB_" & scan, array(0))
				Call cotacao.ReplaceItemValue("VC_" & scan, array(0))
				Call cotacao.ReplaceItemValue("VD_" & scan, array(0))
				Call cotacao.ReplaceItemValue("VE_" & scan, array(0))
			Else
				array = docAtu.GetItemValue("Custo_" & scan)
				Call cotacao.ReplaceItemValue("VA_" & scan, array(0))
				Call cotacao.ReplaceItemValue("VB_" & scan, array(0))
				Call cotacao.ReplaceItemValue("VC_" & scan, array(0))
				Call cotacao.ReplaceItemValue("VD_" & scan, array(0))
				Call cotacao.ReplaceItemValue("VE_" & scan, array(0))
				Call cotacao.ReplaceItemValue("VImp_" & scan, "")
			End If
			x = x + 1
		End If
		Call cotacao.ReplaceItemValue("i_" & scan, CStr(scan + 1))
	Next
	'Lista de Materiais vazia no Negócio
	If x = 0 Then
		Exit Sub
	End If
	'Atualiza Status da Cotação
	Call CkStatusCotacao(cotacao)
	Call cotacao.Computewithform(False, False)
	If cotacao.Save(False, False) = False Then
		MsgBox "A Cotação de Compras não pôde ser atualizada pois encontra-se aberta por outra sessão." & Chr(13) & "Feche a Cotação de Compras e clique em Alterar novamente.", 16, "Aviso"
	End If
	
	'2) Envia Aviso de Solicitação de Compras com o Link da Cotação ao Suporte a Vendas
	If docAtu.Form(0) = "Negocio" Or docAtu.Form(0) = "Projeto" Then
		If doc Is Nothing And cotacao.Status(0) <> "OK" Then
			Dim richStyle As NotesRichTextStyle
			Set richStyle = session.CreateRichTextStyle
			richStyle.NotesFont = FONT_ROMAN
			richStyle.FontSize = 10
			Dim memo As New NotesDocument(db)
			memo.Form = "Memo"
			memo.Subject = "-> Favor comprar os itens do Negócio: " & docAtu.Codigo(0)
			If docAtu.Form(0) = "Negocio" Then
				memo.SendTo = docAtu.Inside
			End If
			memo.CopyTo = session.Commonusername
			'memo.BlindCopyTo = "Ludimila Oliveira"
			Dim corpo As New NotesRichTextItem(memo, "Body")
			Call corpo.AppendStyle(richStyle)
			Call corpo.Appendtext("Código: " & docAtu.Codigo(0))
			Call corpo.AddNewLine(1) 
			Call corpo.Appendtext("Descrição: " & docAtu.Descricao(0))
			Call corpo.AddNewLine(2)
			If docAtu.Form(0) = "Projeto" Then
				Call corpo.Appendtext("Projeto -> ")
				Call corpo.AppendDocLink(docAtu, "Link para o Projeto")
			Else
				Call corpo.Appendtext("Negócio -> ")
				Call corpo.AppendDocLink(docAtu, "Link para o Negócio")
			End If
			Call corpo.AddNewLine(2)
			Call corpo.Appendtext("Cotação -> ")
			Call corpo.AppendDocLink(cotacao, "Link para a Cotação")
			Call corpo.AddNewLine(2)
			Call corpo.Appendtext(session.Commonusername & ",")
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("TDec Network Group.")
			Call memo.Send( False )
			MsgBox "Solicitação de Compra enviada ao Suporte a Vendas", 64, "Aviso"
		End If
	End If
	
End Sub

'++LotusScript Development Environment:2:1:CkImportacao:5:8
%REM
	Function CkImportacao
	Description: Comments for Function
%END REM
Function CkImportacao(negocio As NotesDocument) As Boolean
	
	CkImportacao = True
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Set db = New NotesDatabase(negocio.ParentDatabase.Server, "importacao.nsf")
	'PO
	Set view = db.GetView("(PO/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	If dc.Count = 0 Then
		Exit Function
	End If
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.Sit(0) <> "Concluído" And doc.Sit(0) <> "Cancelado" Then
			CkImportacao = False
			Exit Function
		End If
		Set doc = dc.GetNextDocument( doc )
	Loop
	'Data de Conclusão do PO
	Set doc = dc.GetFirstDocument
	If Not doc Is Nothing Then
		negocio.DataConclusaoImportacao = doc.DataConclusao(0)
	End If
	'Atracagem
	Set view = db.GetView("(Atracagem/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	If dc.Count = 0 Then
		Exit Function
	End If
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.Sit(0) <> "Concluído" And doc.Sit(0) <> "Cancelado" Then
			CkImportacao = False
			Exit Function
		End If
		Set doc = dc.GetNextDocument( doc )
	Loop
	'Data de Conclusão da Atracagem
	Set doc = dc.GetFirstDocument
	If Not doc Is Nothing Then
		If doc.DataConclusao(0) <> "" And negocio.DataConclusaoImportacao(0) <> "" Then
			If CDat(doc.DataConclusao(0)) > CDat(negocio.DataConclusaoImportacao(0)) Then
				negocio.DataConclusaoImportacao = doc.DataConclusao(0)
			End If
		End If
	End If
		
End Function

'++LotusScript Development Environment:2:2:SolicitaPV:5:8
%REM
	Sub SolicitaPV
	Description: Comments for Sub
%END REM
Sub SolicitaPV(negocio As NotesDocument)
	
	On Error Resume Next
	If negocio.TecnicoResponsavel(0) = "" Then
		negocio.TecnicoResponsavel = GetResponsavelPlanejamento(negocio.Area(0), "PreVenda")
	End If
	Dim session As New NotesSession
	Dim scan As Integer, x As Integer
	Dim data As string
	data = GetPrazoPlanejamento(prazoPlanejamento)
	'Forecast
	Dim proxDatas As Variant, proxData(0) As Variant
	Dim datasForecast As Variant, dataForecast(0) As Variant
	Dim temperaturas As Variant, temperatura(0) As Variant
	Dim tiposFollowUp As Variant, tipoFollowUp(0) As Variant
	Dim followUps As Variant, followUp(0) As Variant
	proxData(0) = CDat(data)
	dataForecast(0) = negocio.DataForecastSub(0)
	temperatura(0) = negocio.TemperaturaSub(0)
	tipoFollowUp(0) = "Pré-Venda"
	followUp(0) = "-> " & Format(Now, "dd/mm/yyyy") & " " & session.Commonusername & " - " & Implode(negocio.ObsSub, " ")
	If negocio.ProxData(0) <> "" Then
		'Temperatura passou a ser MultiValue - LMO 24/07/18
		x = UBound(negocio.DataForecast)
		If UBound(negocio.Temperatura) < x Then
			ReDim temp(x) As Variant
			For scan = 0 To x
				If scan > UBound(negocio.Temperatura) Then
					temp(scan) = negocio.TemperaturaSub(0)
				Else
					If negocio.Temperatura(scan) = "" Then
						temp(scan) = negocio.TemperaturaSub(0)
					Else
						temp(scan) = negocio.Temperatura(scan)
					End If
				End If
			Next
			negocio.Temperatura = temp
		End If
		'*** Tipo de Follow Up - LMO 23/08/18 ***
		x = UBound(negocio.DataForecast)
		If UBound(negocio.TipoFollowup) < x Then
			ReDim tipoFUp(x) As String
			For scan = 0 To x
				If scan > UBound(negocio.TipoFollowup) Then
					tipoFUp(scan) = "Telefone"
				Else
					If negocio.TipoFollowup(scan) = "" Then
						tipoFUp(scan) = "Telefone"
					Else
						tipoFUp(scan) = negocio.TipoFollowup(scan)
					End If
				End If
			Next
			negocio.TipoFollowup = tipoFUp
		End If
		'***
		proxDatas = ArrayAppend( proxData, negocio.ProxData )			
		datasForecast = ArrayAppend( dataForecast, negocio.DataForecast )
		temperaturas = ArrayAppend( temperatura, negocio.Temperatura )
		tiposFollowUp = ArrayAppend( tipoFollowUp, negocio.TipoFollowup )
		followUps = ArrayAppend( followUp, negocio.FollowUp )
	Else 
		proxDatas = proxData			
		datasForecast = dataForecast
		temperaturas = temperatura
		tiposFollowUp = tipoFollowUp
		followUps = followUp
	End If
	negocio.ProxData = proxDatas
	negocio.DataForecast = datasForecast
	negocio.Temperatura = temperaturas
	negocio.TipoFollowup = tiposFollowUp
	negocio.FollowUp = followUps
	'Solicitação da Pré-Venda
	'Ordena do atual para o antigo - LMO 27/07/18
	Dim valoresEstimados As Variant, valorEstimado(0) As Variant
	Dim probsFechamento As Variant, probFechamento(0) As Variant
	Dim datasLimitePV As Variant, dataLimitePV(0) As Variant
	Dim respsSolicitacaoPV As Variant, respSolicitacaoPV(0) As Variant
	Dim solicitacoesPV As Variant, solicitacaoPV(0) As Variant
	Dim observacoes As Variant, obs(0) As Variant
	valorEstimado(0) = CDbl(negocio.ValorEstimadoSub(0))
	If negocio.TemperaturaSub(0) = "Frio" Then
		probFechamento(0) = 0.6
	ElseIf negocio.TemperaturaSub(0) = "Morno" Then
		probFechamento(0) = 0.7
	ElseIf negocio.TemperaturaSub(0) = "Quente" Then
		probFechamento(0) = 0.8
	End If
	dataLimitePV(0) = CDat(data)
	respSolicitacaoPV(0) = session.CommonUserName
	solicitacaoPV(0) = Now
	obs(0) = "-> " & Format(Now, "dd/mm/yyyy") & " " & session.Commonusername & " - " & Implode(negocio.ObsSub, " ")
	If CStr(negocio.ValorEstimado(0)) = "" Then
		valoresEstimados = valorEstimado			
		probsFechamento = probFechamento			
		datasLimitePV = dataLimitePV			
		respsSolicitacaoPV = respSolicitacaoPV			
		solicitacoesPV = solicitacaoPV			
		observacoes = obs			
	Else
		valoresEstimados = ArrayAppend( valorEstimado, negocio.ValorEstimado )			
		probsFechamento = ArrayAppend( probFechamento, negocio.ProbFechamento )			
		datasLimitePV = ArrayAppend( dataLimitePV, negocio.DataLimitePV )			
		respsSolicitacaoPV = ArrayAppend( respSolicitacaoPV, negocio.RespSolicitacaoPV )			
		solicitacoesPV = ArrayAppend( solicitacaoPV, negocio.SolicitacaoPV )			
		observacoes = ArrayAppend( obs, negocio.Obs )			
		'Data Retorno Pré-Venda
		negocio.DataRetornoPreVenda = Today
	End If
	negocio.ValorEstimado = valoresEstimados
	negocio.ProbFechamento = probsFechamento
	negocio.DataLimitePV = datasLimitePV
	negocio.RespSolicitacaoPV = respsSolicitacaoPV
	negocio.SolicitacaoPV = solicitacoesPV
	negocio.Obs = observacoes
	'Controle de Pré-Venda
	negocio.Sit = "Pré-Venda"
	negocio.SitNumero = 3
	negocio.CkInspecao = "1"
	negocio.CkPreVenda = ""
	Call negocio.Save(True, True)
	'Cria/Atualiza o Projeto ou Contrato
	Call ProjetoContrato(negocio, "Pré-Venda")
	
End Sub

'++LotusScript Development Environment:2:2:EspelhoMateriais:5:8
%REM
	Sub EspelhoMateriais
	Description: Comments for Sub
%END REM
Sub EspelhoMateriais(uidoc As NotesUIDocument)
	
	Dim session As New NotesSession
	Dim workspace As New NotesUIWorkspace
	Dim pedido As String, st As String, item As String
	Dim fator As Double, fi As Double, ip As Double, total As Double
	Dim scan As Integer, scan2 As Integer, scan3 As Integer
	'Popula Lista de Materiais
	Call PopulaListaMateriais(uidoc.Document)
	'Verifica Preenchimento da Lista de Materiais
	If Not CheckItensLista(uidoc) Then
		Exit Sub
	End If
	'*** Novas Consistências - LMO 17/12/18 ***
	'Consiste Campos do Negócio
	If Not ConsisteCampos(uidoc) Then
		Exit Sub
	End If
	'Consiste Conteúdo do Negócio
	If CDbl(uidoc.FieldGetText("TotalNegocio")) = 0 Then
		MsgBox "Para Fechar a Venda é necessário ter conteúdo na Lista de Materiais e/ou Lista de Serviços", 16, "Erro ao Fechar Venda"	
		Exit Sub
	End If
	'Consiste Projeto/Chamado sem Conteúdo
	If (uidoc.FieldGetText("TipoVenda") = "Projeto" Or uidoc.FieldGetText("TipoVenda") = "Chamado") And CDbl(uidoc.FieldGetText("TotServicos")) = 0 Then
		MsgBox "Para Fechar a Venda de Projeto ou Chamado é necessário ter conteúdo na Lista de Serviços. Solicite a Pré-Venda ou altere o Tipo do Negócio.", 16, "Erro ao Fechar Venda"	
		Exit Sub
	End If
	'Verifica dados da Lista de Materiais e Serviços
	If Not CheckItensLista( uidoc ) Then
		Exit Sub
	End If
	'Verifica dados da Lista CPS no Projeto
	If Not CheckItensListaCPS(uidoc) Then
		Exit Sub
	End If
	'Verifica Planilha Financeira
	If Not CkPlanilha(uidoc) Then
		Exit Sub
	End If
	'Verifica Serviços Internos
	If Not CkServicosInternos(uidoc.Document, "Fechamento") Then
		Exit Sub
	End If
	'****
	'Verifica o Prazo de Pagamento e a Condição de Pagamento
	If uidoc.FieldGetText("PrazoPagamento") = "" Then
		MsgBox "Você precisa cadastrar o Prazo de Pagamento para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "PrazoPagamento" )
		Exit Sub
	ElseIf uidoc.FieldGetText("CondPagto") = "" Then
		MsgBox "Você precisa cadastrar a Condição de Pagamento para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "CondPagto" )
		Exit Sub
	ElseIf uidoc.FieldGetText("TipoPagto") = "" Then
		MsgBox "Você precisa cadastrar o Tipo de Pagamento para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "TipoPagto" )
		Exit Sub
	End If
	'Condições de Pagamento (D.D.L.: Dias da Data Líquido; D.F.M.: Dias Fora Mês; D.F.Q.: Dias Fora Quinzena; D.F.V.: Dia Fixo de Vencimento)
	Dim dataFaturamento As New NotesDateTime(Today), vencimento As New NotesDateTime(Today)
	If uidoc.FieldGetText("CondPagto") = "D.F.M." Then	'D.F.M. (Dias Fora Mês)
		Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
		Call vencimento.AdjustMonth(1)
		Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0) - 1)
	ElseIf uidoc.FieldGetText("CondPagto") = "D.F.V." Then	'D.F.V. (Dia Fixo de Vencimento)
		Set vencimento = New NotesDateTime(uidoc.FieldGetText("PrazoPagamento") & "/" & Month(Today) & "/" & Year(Today))
	ElseIf uidoc.FieldGetText("CondPagto") = "D.F.Q." Then	'D.F.Q. (Dias Fora Quinzena)
		If Day(dataFaturamento.DateOnly) <= 15 Then
			'1)Faturado até dia 15
			Set vencimento = New NotesDateTime("15/" & Month(Today) & "/" & Year(Today))
			Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
		Else	
			'2)Faturado após dia 15
			Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
			Call vencimento.AdjustMonth(1)
			Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
		End If
	ElseIf uidoc.FieldGetText("CondPagto") = "D.D.L." Then	'D.D.L. (Dias Decorridos Líquido)
		Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
	End If
	'Consistências
	For scan = 0 To 49
		If uidoc.FieldGetText("Q_" & scan) <> "" And uidoc.FieldGetText("QFat_" & scan) <> "" Then
			'Verifica Quantidade no Negócio e Quantidade de Faturamento
			If Val(uidoc.FieldGetText("QFat_" & scan)) > Val(uidoc.FieldGetText("Q_" & scan)) Then
				If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
				scan2 = scan2 + 1
			End If
			scan3 = scan3 + 1
		End If
	Next
	If scan2 > 0 Then
		MsgBox "A quantidade de Faturamento não pode ser maior do que a quantidade do Negócio no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio.", 16, "Erro !"
		Exit Sub
	End If
	If scan3 = 0 Then
		MsgBox "Você não informou nenhum item da Lista de Materiais para ser Faturado." & Chr(10) & "Informe no campo Saldos a Faturar", 16, "Erro !"
		Exit Sub
	End If
	'Fim das Consistências
	pedido = getPedido(uidoc.FieldGetText("Pedido"))
	Dim nota As NotesUIDocument
	Set nota = workspace.ComposeDocument("", "", "NotaMateriais")
	Call nota.FieldSetText("DataFaturamento", dataFaturamento.DateOnly)
	Call nota.FieldSetText("Vencimento", vencimento.DateOnly)
	Call nota.FieldSetText("Codigo", uidoc.FieldGetText("Codigo"))
	Call nota.FieldSetText("GerenteConta", uidoc.FieldGetText("GerenteConta"))
	Call nota.FieldSetText("CodCliente", uidoc.FieldGetText("CodCliente"))
	Call nota.FieldSetText("CodClienteFaturamento", uidoc.FieldGetText("CodCliente"))
	Call nota.FieldSetText("Contribuinte", uidoc.FieldGetText("Contribuinte"))
	Call nota.FieldSetText("CodEmpresa", uidoc.FieldGetText("CodEmpresa"))
	Call nota.FieldSetText("CondPagto", uidoc.FieldGetText("PrazoPagamento") & uidoc.FieldGetText("CondPagto"))
	Call nota.FieldSetText("Pedido", pedido)
	Call nota.FieldSetText("Area", uidoc.FieldGetText("AreaVendas"))
	Call nota.FieldSetText("AreaVendas", uidoc.FieldGetText("AreaVendas"))
	Call nota.FieldSetText("UF", uidoc.FieldGetText("UF"))
	Call nota.FieldSetText("Destino",  uidoc.FieldGetText("Destino"))
	Call nota.FieldSetText("TipoComissionamento", uidoc.FieldGetText("TipoComissionamento"))
	Call nota.FieldSetText("Tipo", "Espelho")
	'Busca Cotação da Moeda
	Dim moeda As Variant
	moeda = GetMoedas
	'US$C Venda Fixo - LMO 08/01/18
	If IsNumeric(uidoc.Fieldgettext("USVenda")) Then
		Call nota.FieldSetText("USC", uidoc.Fieldgettext("USVenda"))
	Else
		Call nota.FieldSetText("USC", CStr(moeda(0)))
	End If
	Call nota.FieldSetText("UST", CStr(moeda(1)))

	Dim ck As Long, ckq As Long, saldoFat As Long
	Dim tipo As String, tipoAnterior As String
	Dim icAnterior As Double, ipAnterior As Double, icd As Double, icmsst As Double, bcicmsst As Double, fcp As Double
	Dim msg As Variant
	
	For scan = 0 To 49
		'Observação para Mídia/Pedido de Compra
		If scan = 0 Then
			If tipoAnterior = "SW" Then
				Call nota.FieldSetText("ObsCorpo", "Base de cálculo do ICMS Conforme o artigo 51-A-RICMS/91 do Decreto 35.674 de 15/09/92"_
				+ Chr(10) + uidoc.FieldGetText("Pedido"))
			Else
				Call nota.FieldSetText("ObsCorpo", uidoc.FieldGetText("Pedido"))
			End If
		End If
		'
		ck = Val(uidoc.FieldGetText("QFat_" & scan))
		ckq = Val(uidoc.FieldGetText("Q_" & scan))
		If ck > 0 And ckq > 0 Then
			'ICMSST de Venda
			If CStr(uidoc.Document.GetItemValue("BCICMSST_" & scan)(0)) <> "" Then bcicmsst = uidoc.Document.GetItemValue("BCICMSST_" & scan)(0) Else bcicmsst = 0
			If CStr(uidoc.Document.GetItemValue("ICMSST_" & scan)(0)) <> "" Then icmsst = uidoc.Document.GetItemValue("ICMSST_" & scan)(0) Else icmsst = 0
			If CStr(uidoc.Document.GetItemValue("ICD_" & scan)(0)) <> "" And CStr(uidoc.Document.GetItemValue("ICD_" & scan)(0)) <> "?" And CStr(uidoc.Document.GetItemValue("ICD_" & scan)(0)) <> "*" Then icd = uidoc.Document.GetItemValue("ICD_" & scan)(0) Else icd = 0
			If CStr(uidoc.Document.GetItemValue("FCP_" & scan)(0)) <> "" And CStr(uidoc.Document.GetItemValue("FCP_" & scan)(0)) <> "?" And CStr(uidoc.Document.GetItemValue("FCP_" & scan)(0)) <> "*" Then fcp = uidoc.Document.GetItemValue("FCP_" & scan)(0) Else fcp = 0
			'Verifica Quantidade no Negócio e Quantidade de Faturamento
			If ck > ckq Then
				msg = Msgbox("A quantidade de faturamento não pode ser maior do que a quantidade do negócio no ítem Nº " & (scan + 1) &".", 16, "Você entrou com uma quantidade de faturamento inválida")
				Goto refresh
			End If
			'Verifica se houve troca de tipo de produto no mesmo pedido
			If scan2 > 0 Then
				If tipoAnterior <> uidoc.Fieldgettext("t_" & scan) Then
					msg = MsgBox("Você não pode pedir ítens de tipos diferentes no mesmo Pedido", 16, "Tipos de Ítens Diferentes no Mesmo Pedido")
					GoTo refresh
				End If
			End If
			If uidoc.Fieldgettext("t_" & scan) <> "HW" Then
				'Verifica se as alíquotas de retenção de IR e INSS são as mesmas
				If (uidoc.Fieldgettext("t_" & scan) = "SV" Or uidoc.Fieldgettext("t_" & scan) = "SW") And scan2 > 0 Then
					If CDbl(uidoc.Fieldgettext("IC_" & scan)) <> icAnterior Or CDbl(uidoc.Fieldgettext("IP_" & scan)) <> ipAnterior Then
						MsgBox("Você entrou com ítens com retenções de IR e INSS diferentes para a mesma Nota Fiscal")
						GoTo refresh   
					End If
				End If
			End If
			Call nota.FieldSetText("Q_" & scan2, CStr(ck))
			Call nota.FieldSetText("NItem_" & scan2, CStr(scan + 1)) 
			Call nota.FieldSetText("PartNo_" & scan2, uidoc.Fieldgettext("PartNo_" & scan))
			Call nota.FieldSetText("Produto_" & scan2, uidoc.Fieldgettext("Produto_" & scan))
			Call nota.FieldSetText("Un_" & scan2, uidoc.Fieldgettext("Un_" & scan))
			Call nota.FieldSetText("Us_" & scan2, uidoc.Fieldgettext("us_" & scan))
			Call nota.FieldSetText("CF_" & scan2, uidoc.Fieldgettext("CF_" & scan))
			'CST e IPI
			If uidoc.Fieldgettext("t_" & scan) = "HW" Then
				'Converte Origem
				If uidoc.Fieldgettext("FI_" & scan) <> "" Then fi = CDbl(uidoc.Fieldgettext("FI_" & scan)) Else fi = 0
				If fi > 0 Then
					'Importação TDec
					st = Left(uidoc.Fieldgettext("ST_" & scan), 1)
					ip = CDbl(uidoc.Fieldgettext("IP_" & scan))
				ElseIf Left(uidoc.Fieldgettext("ST_" & scan), 1) = "1" Then
					st = "2"
					ip = 0
				ElseIf Left(uidoc.Fieldgettext("ST_" & scan), 1) = "6" Then
					st = "7"
					ip = 0
				Else
					st = Left(uidoc.Fieldgettext("ST_" & scan), 1)
					ip = 0
				End If
				'Converte Situação Tributária
				If uidoc.FieldGetText("UF") = "SP" Then
					'Venda para SP
					If fi > 0 Then
						'Importação TDec
						st = st & "00"
					ElseIf Right(uidoc.Fieldgettext("ST_" & scan), 2) = "10" Then
						st = st & "60"
					Else
						'Compra de Fora de SP
						If uidoc.Fieldgettext("UFCompra_" & scan) <> "SP" And uidoc.Fieldgettext("UFCompra_" & scan) <> "EX" And Right(uidoc.Fieldgettext("ST_" & scan), 2) = "00" Then
							st = st & 60
						Else
							st = st & Right(uidoc.Fieldgettext("ST_" & scan), 2)
						End If
					End If
				Else
					'Venda para Fora de SP
					If icd > 0 Then
						'Com Protocolo
						st = st & "10"
					Else
						'Sem Protocolo
						st = st & "00"
					End If
				End If
			Else
				st = "000"
				ip = CDbl(uidoc.Fieldgettext("IP_" & scan))
			End If
			Call nota.FieldSetText("ST_" & scan2, st)
			If uidoc.Fieldgettext("us_" & scan) = "US$C" Then
				fator = moeda(0)
			ElseIf uidoc.Fieldgettext("us_" & scan) = "US$T" Then
				fator = moeda(1)
			Else
				fator = 1
			End If
			Call nota.FieldSetText("ICMSST_" & scan2, CStr(icmsst / ckq * ck))
			Call nota.FieldSetText("BCICMSST_" & scan2, CStr(bcicmsst / ckq * ck))
			Call nota.FieldSetText("Custo_" & scan2, CStr(CDbl(uidoc.Fieldgettext("CustoUnit_" & scan)) + icmsst / ckq))
			Call nota.FieldSetText("CustoUnit_" & scan2, CStr((CDbl(uidoc.Fieldgettext("CustoUnit_" & scan)) + icmsst / ckq) * fator))
			Call nota.FieldSetText("CusTot_" & scan2, Format((CDbl(uidoc.Fieldgettext("CusTot_" & scan)) + icmsst / ckq) * ck * fator, "Standard"))
			Call nota.FieldSetText("IC_" & scan2, Format(uidoc.Fieldgettext("IC_" & scan), "Percent"))
			Call nota.FieldSetText("ICST_" & scan2, Format(icd, "Percent"))
			Call nota.FieldSetText("FCP_" & scan2, Format(fcp, "Percent"))
			Call nota.FieldSetText("IP_" & scan2, Format(ip, "Percent"))
			Call nota.FieldSetText("AliquotaPIS_" & scan2, Format(uidoc.Fieldgettext("AliquotaPIS_" & scan), "Percent"))
			Call nota.FieldSetText("AliquotaCOFINS_" & scan2, Format(uidoc.Fieldgettext("AliquotaCOFINS_" & scan), "Percent"))
			Call nota.FieldSetText("UFCompra_" & scan2, uidoc.Fieldgettext("UFCompra_" & scan))
			total = total + (CDbl(uidoc.Fieldgettext("CustoUnit_" & scan)) * ck * fator)
			scan2 = scan2 + 1
			tipoAnterior = uidoc.Fieldgettext("t_" & scan)
			icAnterior = CDbl(uidoc.Fieldgettext("IC_" & scan))
			ipAnterior = CDbl(uidoc.Fieldgettext("IP_" & scan))
		End If
	Next
refresh: 'Finalização da Função com classificação da nota em caso de erro
	Call nota.FieldSetText("Total", Format(total, "Standard"))
	Call nota.FieldSetText("Valor", Format(total, "Standard"))
	If tipoAnterior = "HW" Then
		tipo = "Hardware"
	ElseIf tipoAnterior = "SW" Then
		tipo = "Software"
	Else
		tipo = "Serviços"
	End If
	Call nota.FieldSetText("TipoNF", tipo)
	Call nota.Refresh
	
End Sub



'++LotusScript Development Environment:2:2:PopulaListaServicos:5:8
%REM
	Sub PopulaListaServicos
	Description: Comments for Sub
%END REM
Sub PopulaListaServicos(doc As NotesDocument)
	
	On Error Resume Next
	Dim array As Variant, impostos As Variant
	Dim scan As Integer
	For scan = 0 To 11
		array = doc.Getitemvalue("Produtos_" & scan)
		If array(0) <> "" Then
			array = doc.Getitemvalue("PartNos_" & scan)
			If array(0) <> "" Then
				impostos = BuscaImpostos(array(0))
				Call doc.Replaceitemvalue("RIR_" & scan, impostos(4))
				Call doc.Replaceitemvalue("RIN_" & scan, impostos(5))
				Call doc.Replaceitemvalue("ISS_" & scan, impostos(3))
			Else
				Call doc.Replaceitemvalue("RIR_" & scan, 0)
				Call doc.Replaceitemvalue("RIN_" & scan, 0)
				Call doc.Replaceitemvalue("ISS_" & scan, 0)
			End If
		Else
			Call doc.Replaceitemvalue("Mgs_" & scan, "")
			Call doc.Replaceitemvalue("CustoUnits_" & scan, "")
			Call doc.Replaceitemvalue("CusTots_" & scan, "")
			Call doc.Replaceitemvalue("RIR_" & scan, "")
			Call doc.Replaceitemvalue("RIN_" & scan, "")
			Call doc.Replaceitemvalue("ISS_" & scan, "")
		End If
	Next
	
End Sub

'++LotusScript Development Environment:2:2:CalcNota:1:8
Sub CalcNota(doc As NotesDocument)
	
	On Error Resume Next
	Dim icms As Variant, totserv As Double, totmerc As Double, icmsST As Double, totComIPI As Double, tot As Double, valorFrete As Double, valorSeguro As Double, outrasDespesas As Double, valorICMS As Double
	Dim ckImpostos As Boolean
	ckImpostos = True
	icms = CalcICMS(doc)
	totmerc = CalcTotalMercadorias(doc)
	totserv = CalcTotalServicos(doc)
	If doc.Natureza(0) = "Complemento de ICMS" Or InStr(doc.Natureza(0), "Nota Complementar") > 0 Then
		doc.TotalProdutos = 0
	Else
		doc.TotalProdutos = totmerc
	End If	
	doc.TotalServicos = totserv
	If doc.TipoCompra(0) <> "Importação" Then
		doc.BaseCalculoICMS = icms(0)
		doc.ValorICMS = icms(1)
	End If
	doc.ValorIPI = icms(2)
	'ICMS-ST
	Dim indice As Variant
	indice = ArrayGetIndex(doc.Natureza, "Devolução de Compra ST")
	If icms(4) > 0 Then
		doc.BaseICMSSubstituicao = icms(3)
		doc.ICMSSubstituicao = icms(4)
	Else
		doc.BaseICMSSubstituicao = 0
		doc.ICMSSubstituicao = 0
	End If
	If doc.Form(0) = "Glosa" Then
		doc.TotalNota = (totmerc# + totserv#) * -1
	ElseIf doc.Natureza(0) = "Complemento de ICMS" Or InStr(doc.Natureza(0), "Nota Complementar") > 0 Then
		doc.TotalNota = 0
	Else	
		If CStr(doc.ICMSSubstituicao(0)) <> "" Then icmsST = doc.ICMSSubstituicao(0)
		If CStr(doc.ValorFrete(0)) <> "" Then valorFrete = doc.ValorFrete(0)
		If CStr(doc.ValorSeguro(0)) <> "" Then valorSeguro = doc.ValorSeguro(0)
		If CStr(doc.OutrasDespesas(0)) <> "" Then outrasDespesas = doc.OutrasDespesas(0)
		If CStr(doc.ValorICMS(0)) <> "" Then valorICMS = doc.ValorICMS(0)
		doc.TotalNota = totmerc# + totserv# + valorFrete + valorSeguro + outrasDespesas + icms(2) + icmsST
	End If
	'Tributos Totais
	doc.Tributos = icms(5) + icms(6) + icms(7)
	If doc.TotalNota(0) > 0 Then
		doc.TributosP = (icms(5) + icms(6) + icms(7))/doc.TotalNota(0)
	Else
		doc.TributosP = 0
	End If	
	'Tributos Federais
	doc.TributosF = icms(5)
	If doc.TributosF(0) > 0 Then
		doc.TributosFP = icms(5)/doc.TributosF(0)
	Else
		doc.TributosFP = 0
	End If
	'Tributos Estaduais
	doc.TributosE = icms(6)
	If doc.TributosE(0) > 0 Then
		doc.TributosEP = icms(6)/doc.TributosE(0)
	Else
		doc.TributosEP = 0
	End If
	'Tributos Municipais
	doc.TributosM = icms(7)
	If doc.TributosM(0) > 0 Then
		doc.TributosMP = icms(7)/doc.TributosM(0)
	Else
		doc.TributosMP = 0
	End If
	'ICMS de Partilha (Não Contribuinte para Fora de SP)
	doc.ICMSPartilha = icms(8)
	doc.ICMSPartilhaOrigem = icms(9)
	doc.ICMSPartilhaAliquota = icms(10)
	doc.ICMSPartilhaAliquotaOrigem = icms(11)
	doc.ValorFCP = icms(12)
	'Totais
	totComIPI = totmerc + totserv + doc.ValorIPI(0) + doc.ICMSSubstituicao(0)
	tot = totmerc + totserv
	If InStr(doc.Natureza(0), "Devolução") > 0 And doc.TipoNota(0) = "Entrada" And doc.Sit(0) <> "Cancelada" Then
		totComIPI = totComIPI * -1
		tot = tot * -1
	ElseIf doc.Natureza(0) = "Entrega Futura" Or doc.Natureza(0) = "Doação" Or doc.Natureza(0) = "Complemento de ICMS" Or InStr(doc.Natureza(0), "Nota Complementar") > 0 Or doc.Natureza(0) = "Outras Saídas" Or doc.Sit(0) = "Cancelada" Or doc.Sit(0) = "Espelho" Or doc.TipoCompra(0) = "Importação" Or _
	InStr(doc.Natureza(0), "Ativo") > 0 Or InStr(doc.Natureza(0), "Compra") > 0 Or InStr(doc.Natureza(0), "Distribuição") > 0 Or InStr(doc.Natureza(0), "Retorno") > 0 Or InStr(doc.Natureza(0), "Remessa") > 0 Or InStr(doc.Natureza(0), "Troca") > 0 Or InStr(doc.Natureza(0), "Outras Exportações") > 0 Or _
	InStr(doc.Natureza(0), "Devolução") > 0 And doc.TipoNota(0) = "Saída" Or InStr(doc.Natureza(0), "Devolução") = 0 And doc.TipoNota(0) = "Entrada" Then
		totComIPI = 0
		tot = 0
	End If
	doc.TotTotComIPI = totComIPI
	doc.TotTot = tot
	If (InStr(doc.Natureza(0), "Remessa") <> 0 And doc.Natureza(0) <> "Remessa de Entrega Futura")_
	Or InStr(doc.Natureza(0), "Retorno") <> 0 Or InStr(doc.Natureza(0), "Outras") <> 0_
	Or InStr(doc.Natureza(0), "Complement") <> 0 Then
	ckImpostos = False
	End If
	'Impostos
	If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.ValorISS = 0 Else doc.ValorISS = CalcISS(doc)
	'Retenções
	If doc.TipoInscricao(0) = "CPF" Then
		'Pessoa Física - LMO 29/08/16
		doc.IRRF = 0
		doc.INSSRF = 0
		doc.IF = 0
		doc.IFPis = 0
		doc.IFCofins = 0
		doc.IFCSLL = 0
		doc.ISS = 0
	Else
		If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.IRRF = 0 Else doc.IRRF = CalcIRRF(doc)
		If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.INSSRF = 0 Else doc.INSSRF = CalcINSSRF(doc)
		If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.IF = 0 Else doc.IF = CalcIF(doc)
		If doc.Sit(0) = "Cancelada" Or ckImpostos = False Or doc.Form(0)= "ReciboLocacao" Then doc.ISS = 0 Else doc.ISS = CalcIS(doc)
	End If
	'Margem Prevista
	If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.ValorVenda = 0 Else doc.ValorVenda = doc.TotalNota(0)
	If doc.TipoNota(0) = "Entrada" Then
		If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.ICMS = 0 Else doc.ICMS = (doc.ValorICMS(0) - credIcms) * -1
			doc.IPI = 0
		Else
			If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.ICMS = 0 Else doc.ICMS = doc.ValorICMS(0) - credIcms
				doc.IPI = 0
			End If
			If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.ICMSST = 0 Else doc.ICMSST = icmsST
			If doc.Sit(0) = "Cancelada" Or ckImpostos = False Or doc.Form(0)= "ReciboLocacao" Then doc.Impostos = 0 Else doc.Impostos = doc.ValorISS(0)
			If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.INSS = 0 Else doc.INSS = 0
			If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.Pis = 0 Else doc.Pis = CalcPis(doc) - credPis
			If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.Cofins = 0 Else doc.Cofins = CalcCofins(doc) - credCofins
			If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.CSLL = 0 Else doc.CSLL = doc.TotTotComIPI(0) * aliquota(9)
			If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then doc.IRPJ = 0 Else doc.IRPJ = doc.TotTotComIPI(0) * aliquota(10)
			If doc.Tipo(0) = "Software" Or doc.Tipo(0) = "Serviços" Then
			If doc.Sit(0) = "Cancelada" Or ckImpostos = False Then
				doc.CPR = 0
			Else
				doc.CPR = doc.TotalServicos(0) * aliquota(13)
			End If
		Else
		doc.CPR = 0
	End If
	doc.ValorCPR = doc.CPR(0)
	'Valor a Receber
	If CStr(doc.Valor(0)) = "" Then
		doc.Valor = totmerc# + totserv# + icms(2) + icmsST - doc.IRRF(0) - doc.INSSRF(0) - doc.IF(0) - doc.ISS(0) 
	End If
	'Margem
	If doc.Sit(0) = "Cancelada" Or ckImpostos = False Or (doc.Natureza(0) <> "Venda" And doc.Natureza(0) <> "Venda ST" And doc.Natureza(0) <> "Licenciamento de Uso" And doc.Natureza(0) <> "Prestação de Serviços" And doc.Natureza(0) <> "Compra para Comercialização" And doc.Natureza(0) <> "Compra de Bem para Ativo Fixo" And doc.TipoNota(0) <> "Entrada") Then
		doc.Margem = 0
	Else
		doc.Margem = doc.ValorVenda(0) - doc.CMV(0) - doc.ICMS(0) - doc.ICMSST(0) - doc.IPI(0) - doc.Impostos(0) - doc.INSS(0) - doc.PIS(0) - doc.Cofins(0) - doc.CSLL(0) - doc.IRPJ(0) - doc.CPR(0) - doc.Premio(0)
	End If
	
End Sub

'++LotusScript Development Environment:2:1:RetiraSinais:1:8
Function RetiraSinais(texto As String) As String
	
	Dim i As Integer
	Dim NovoTexto As String
	Dim size As Long
	Texto = UCase(Texto)
	Size = Len(Texto)
	For i = 1 To Size
		Select Case Mid(Texto, i, 1)
		Case "."
		Case ","
		Case "*"		
		Case "-"
		Case "/"
		Case "R"
		Case "$"
		Case ":"
		Case ";"
		Case " "
		Case Else
			NovoTexto = NovoTexto + Mid(Texto, i, 1)
		End Select
	Next
	RetiraSinais = NovoTexto
	
End Function


'++LotusScript Development Environment:2:2:CalcListaServicos:1:8
Sub CalcListaServicos( uidoc As NotesUiDocument )
	
	Dim scan As Integer, custo As Double, terceiros As Double, mg As Double, venda As Double, tot As Double, qtd As Long, despesas As Double, cps As Double, fator As Double
	For scan = 0 To 11
		qtd = Val(uidoc.FieldGetText("Qs_" & scan))
		If qtd > 0 Then
			If uidoc.FieldGetText("Custos_" & scan) = "" Then custo = 0 Else custo = Cdbl(uidoc.FieldGetText("Custos_" & scan))
			If uidoc.FieldGetText("Terceiros_" & scan) = "" Then terceiros = 0 Else terceiros = CDbl(uidoc.FieldGetText("Terceiros_" & scan))
			If uidoc.FieldGetText("Mgs_" & scan)  = "" Then mg = 0 Else mg = CDbl(uidoc.FieldGetText("Mgs_" & scan))
			If uidoc.FieldGetText("CustoUnits_" & scan) = "" Then venda = 0 Else venda = CDbl(uidoc.FieldGetText("CustoUnits_" & scan))
			If uidoc.FieldGetText("Despesas_" & scan) = "" Then despesas = 0 Else despesas = CDbl(uidoc.FieldGetText("Despesas_" & scan))
			If uidoc.FieldGetText("CPS_" & scan) = "" Then cps = 0 Else cps = CDbl(uidoc.FieldGetText("CPS_" & scan))
			if (custo > 0 And mg > 0 And venda > 0) Or (terceiros > 0 And mg > 0 And venda > 0) Or (custo > 0 And venda > 0 And mg = 0) Or (terceiros > 0 And venda > 0 And mg = 0) Then
				mg = (custo + terceiros)/venda
				Call uidoc.FieldSetText("Mgs_" & scan, Format(mg, "Fixed"))
			Elseif (custo > 0 And mg > 0 And venda = 0) Or (terceiros > 0 And mg > 0 And venda = 0) Then
				venda = (custo + terceiros)/mg
				Call uidoc.FieldSetText("CustoUnits_" & scan, Format(venda, "Standard"))
			ElseIf mg > 0 And venda > 0 And custo = 0 Then
				'O Custo tem que ser definido pela Área Técnica
				Call uidoc.FieldSetText("CustoUnits_" & scan, Format(0, "Standard"))
			Else
				'Não faz nada pois precisa de ao menos 2 campos preenchidos
			End If
			'Cotação da Moeda
			If uidoc.FieldGetText("USS_" & scan) = "US$C" Then
				'US$C Venda Fixo - LMO 08/01/18
				If IsNumeric(uidoc.Fieldgettext("USVenda")) Then
					fator = CDbl(uidoc.FieldGetText("USVenda"))
				Else
					fator = CDbl(uidoc.FieldGetText("USC"))
				End If
			Else
				fator = 1
			End If
			Call uidoc.FieldSetText("CusTots_" & scan, Format(Round(qtd * (venda + (despesas + cps) / fator), 2), "Standard"))	'despesas e cps em R$
			tot = tot + CDbl(uidoc.FieldGetText("CusTots_" & scan)) * fator
		End If
	Next
	Call uidoc.FieldSetText("TotServicos", Format(tot, "Standard"))
	Call uidoc.FieldSetText("TotServicos_1", Format(tot, "Standard"))
	'Calcula o Total do Negócio
	Call uidoc.Refresh
	
End Sub

'++LotusScript Development Environment:2:2:PopulaConclusaoNegocio:5:8
%REM
	Sub PopulaConclusaoNegocio
	Description: Comments for Sub
%END REM
Sub PopulaConclusaoNegocio(newdoc As NotesDocument)
	
	On Error Resume Next
	If newdoc.Codigo(0) = "" Then End
	Dim session As New NotesSession
	Dim db As New NotesDatabase(newdoc.Parentdatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim negocio As NotesDocument
	Dim dataCriacao As NotesDateTime, dataFechamento As NotesDateTime, dataConclusao As NotesDateTime
	Set view = db.GetView("(NegociosCodigo)")
	Set negocio = view.GetDocumentByKey(newdoc.Codigo(0), True)
	If negocio Is Nothing Then End
	'Verifica se a Margem Real do Negócio foi calculada
	If negocio.Res_R(0) = 0 Then
		'Calcula Planilha Financeira
		Call ProjetoContrato(negocio, "Atualiza")
		'Calcula a Margem Real
		Call MgReal(negocio)
	End If
	newDoc.Autor = session.CommonUserName
	newDoc.Criacao = Now
	newDoc.TipoVenda = negocio.TipoVenda(0)
	newDoc.GerenteConta = negocio.GerenteConta(0)
	newDoc.Inside = negocio.Inside(0)
	newDoc.Codigo = negocio.Codigo(0)
	newDoc.Parceria = negocio.Parceria(0)
	newDoc.Descricao = negocio.Descricao(0)
	'Rentabilidade Prevista
	newDoc.ReceitasP = negocio.Venda_P(0)
	newDoc.DespesasP = negocio.Venda_P(0) - negocio.Margem_P(0)
	newDoc.ResultadoP = negocio.Margem_P(0)
	newDoc.ResP = negocio.Res_P(0)
	'Rentabilidade Real
	newDoc.ReceitasR = negocio.Venda_R(0)
	newDoc.DespesasR = negocio.Venda_R(0) - negocio.Margem_R(0)
	newDoc.ResultadoR = negocio.Margem_R(0)
	newDoc.ResR = negocio.Res_R(0)
	'Ofensores
	Call Ofensores(negocio, newDoc)
	'Dólar Previsto e Dólar Médio Compra e Venda - LMO 11/02/25
	newDoc.USC = negocio.USC(0)
	Call DolarMedio(newdoc)
	'Datas
	If negocio.Criacao(0) = "" Then negocio.Criacao = Today
	Set dataCriacao = New NotesDateTime(negocio.Criacao(0))
	If negocio.DataFechamento(0) = "" Then negocio.DataFechamento = Today
	Set dataFechamento = New NotesDateTime(negocio.DataFechamento(0))
	Set dataConclusao = New NotesDateTime(negocio.DataConclusao(0))
	newDoc.DataCriacao = negocio.Criacao(0)
	newDoc.DataFechamento = negocio.DataFechamento(0)
	newDoc.DataConclusao = negocio.DataConclusao(0)
	'Dias
	newDoc.DiasFechamento = Round(dataFechamento.TimeDifference(dataCriacao)/86400, 0)
	newDoc.DiasConclusao = Round(dataConclusao.TimeDifference(dataFechamento)/86400, 0)
	newDoc.DiasTotal = Round(dataConclusao.TimeDifference(dataCriacao)/86400, 0)
	'Planilha Financeira
	Dim dbServ as New NotesDatabase(negocio.Parentdatabase.Server, "servicos.nsf")
	Dim planilha As NotesDocument
	Set view = dbServ.Getview("(Planilha/Codigo)")
	Set planilha = view.Getdocumentbykey(negocio.Codigo(0), True)
	If Not planilha Is Nothing Then
		'Atualiza Valores da Planilha Financeira
		Call CalcPlanilha(planilha)
		Call planilha.Save(False, False)
		'*** Custos ***
		'Planejado
		newDoc.PassP = planilha.PassP(0)
		newDoc.HospP = planilha.HospP(0)
		newDoc.TransporteP = planilha.TransporteP(0)
		newDoc.AlugP = planilha.AlugP(0)
		newDoc.MatP = planilha.MatP(0)
		newDoc.ServP = planilha.ServP(0)
		newDoc.FreteMP = planilha.FreteMP(0)
		newDoc.CustoP = planilha.CustoP(0)
		'Utilizado
		newDoc.PassU = planilha.PassU(0)
		newDoc.HospU = planilha.HospU(0)
		newDoc.TransporteU = planilha.TransporteU(0)
		newDoc.AlugU = planilha.AlugU(0)
		newDoc.MatU = planilha.MatU(0)
		newDoc.ServU = planilha.ServU(0)
		newDoc.FreteMU = planilha.FreteMU(0)
		newDoc.CustoU = planilha.CustoU(0)
		'Saldo
		newDoc.PassS = newDoc.PassP(0) - newDoc.PassU(0)
		newDoc.HospS = newDoc.HospP(0) - newDoc.HospU(0)
		newDoc.TransporteS = newDoc.TransporteP(0) - newDoc.TransporteU(0)
		newDoc.AlugS = newDoc.AlugP(0) - newDoc.AlugU(0)
		newDoc.MatS = newDoc.MatP(0) - newDoc.MatU(0)
		newDoc.ServS = newDoc.ServP(0) - newDoc.ServU(0)
		newDoc.FreteMS = newDoc.FreteMP(0) - newDoc.FreteMU(0)
		newDoc.CustoS = newDoc.CustoP(0) - newDoc.CustoU(0)
		'*** Despesas ***
		'Planejado
		newDoc.KmP = planilha.KmP(0)
		newDoc.TranspP = planilha.TranspP(0)
		newDoc.AlimeP = planilha.AlimeP(0)
		newDoc.TeleP = planilha.TeleP(0)
		newDoc.DespP = planilha.DespP(0)
		'Utilizado
		newDoc.KmU = planilha.KmU(0)
		newDoc.TranspU = planilha.TranspU(0)
		newDoc.AlimeU = planilha.AlimeU(0)
		newDoc.TeleU = planilha.TeleU(0)
		newDoc.DespU = planilha.DespU(0)
		'Saldo
		newDoc.KmS = newDoc.KmP(0) - newDoc.KmU(0)
		newDoc.TranspS = newDoc.TranspP(0) - newDoc.TranspU(0)
		newDoc.AlimeS = newDoc.AlimeP(0) - newDoc.AlimeU(0)
		newDoc.TeleS = newDoc.TeleP(0) - newDoc.TeleU(0)
		newDoc.DespS = newDoc.DespP(0) - newDoc.DespU(0)
		'*** Horas Homem ***
		'Planejado
		newDoc.PlanP = planilha.PlanP(0)
		newDoc.GerP = planilha.GerP(0)
		newDoc.ExecP = planilha.ExecP(0)
		newDoc.DeslocamentoP = planilha.DeslocamentoP(0)
		newDoc.DocP = planilha.DocP(0)
		newDoc.HHP = planilha.HHP(0)
		'Utilizado
		newDoc.PVU = planilha.PVU(0)
		newDoc.PlanU = planilha.PlanU(0)
		newDoc.GerU = planilha.GerU(0)
		newDoc.ExecU = planilha.ExecU(0)
		newDoc.DeslocamentoU = planilha.DeslocamentoU(0)
		newDoc.DocU = planilha.DocU(0)
		newDoc.HHU = planilha.HHU(0)
		'Saldo
		newDoc.PlanS = newDoc.PlanP(0) - newDoc.PlanU(0)
		newDoc.GerS = newDoc.GerP(0) - newDoc.GerU(0)
		newDoc.ExecS = newDoc.ExecP(0) - newDoc.ExecU(0)
		newDoc.DeslocamentoS = newDoc.DeslocamentoP(0) - newDoc.DeslocamentoU(0)
		newDoc.DocS = newDoc.DocP(0) - newDoc.DocU(0)
		newDoc.HHS = newDoc.HHP(0) - newDoc.HHU(0)
		'Total Utilizado - Planilha Financeira
		'Execução
		newDoc.Custo = planilha.CustoU(0)
		newDoc.Desp = planilha.DespU(0)
		newDoc.Total = newDoc.Custo(0) + newDoc.Desp(0)
		newDoc.HH = planilha.HHU(0)
		'Pré-Venda
		newDoc.CustoPV = planilha.CustoPVU(0)
		newDoc.DespPV = planilha.DespPVU(0)
		newDoc.TotalPV = newDoc.CustoPV(0) + newDoc.DespPV(0)
		newDoc.HPV = planilha.HPVU(0)
		'POC
		newDoc.CustoPOC = planilha.CustoPOCU(0)
		newDoc.DespPOC = planilha.DespPOCU(0)
		newDoc.TotalPOC = newDoc.CustoPOC(0) + newDoc.DespPOC(0)
		newDoc.HPOC = planilha.HPOCU(0)
		'*** Terceiros Faturáveis ***
		newDoc.TerceirosP = planilha.TerceirosP(0)
		newDoc.TerceirosU = planilha.TerceirosU(0)
		newDoc.TerceirosS = newDoc.TerceirosP(0) - newDoc.TerceirosU(0)
		'*** Despesas de Vendas ***
		newDoc.FreteP = planilha.FreteP(0)
		newDoc.FreteU = planilha.FreteU(0)
		newDoc.FreteS = newDoc.FreteP(0) - newDoc.FreteU(0)
		newDoc.IntermediacaoP = planilha.IntermediacaoP(0)
		newDoc.IntermediacaoU = planilha.IntermediacaoU(0)
		newDoc.IntermediacaoS = newDoc.IntermediacaoP(0) - newDoc.IntermediacaoU(0)
		newDoc.VendasP = planilha.VendasP(0)
		newDoc.VendasU = planilha.VendasU(0)
		newDoc.VendasS = newDoc.VendasP(0) - newDoc.VendasU(0)
	End If
	
End Sub

'++LotusScript Development Environment:2:2:CalcListaCPS:1:8
Sub CalcListaCPS(projeto As NotesDocument)
	
	On Error Resume Next
	Dim scan As Integer, custoMateriais As Double, vendaMateriais As Double
	Dim compra As Double, venda As Double, icmsst As Double, moeda As Double, qvar As Long
	Dim array As Variant
	For scan = 0 To 49
		array = projeto.GetItemValue("Q_" & scan)
		qvar = Val(array(0))
		If qvar > 0 Then
			array = projeto.GetItemValue("Us_" & scan)
			If array(0) = "US$C" Then
				moeda = projeto.USC(0)
			ElseIf array(0) = "US$T" Then
				moeda = projeto.UST(0)
			Else
				moeda = 1
			End If
			'Custo CPS
			array = projeto.GetItemValue("Custo_" & scan)
			If CStr(array(0)) <> "" Then
				compra = array(0)
				array = projeto.GetItemValue("ICMSSTC_" & scan)
				If CStr(array(0)) = "" Then icmsst = 0 Else icmsst = array(0)
				custoMateriais = custoMateriais + Round((compra + icmsst) * qvar * moeda, 2)
			End If
			'Venda CPS
			array = projeto.GetItemValue("CusTot_" & scan)
			If CStr(array(0)) <> "" Then
				venda = array(0)
				vendaMateriais = vendaMateriais + Round(venda * moeda, 2)
			End If
		End If
	Next
	projeto.CustoMateriais = custoMateriais
	projeto.TotMateriais = vendaMateriais
	If custoMateriais > 0 And projeto.TipoVenda(0) <> "Venda Simples" Then
		projeto.CPSQtd = 1
		projeto.CPS = custoMateriais
		projeto.CPSP = custoMateriais
		projeto.CPSObs = "Valor informado na Lista CPS"
	Else
		projeto.CPSQtd = 0
		projeto.CPS = 0
		projeto.CPSP = 0
		projeto.CPSObs = ""
	End If
	
End Sub

'++LotusScript Development Environment:2:2:GeraRequisicao:1:8
Sub GeraRequisicao (uidoc As NotesuiDocument)
	
	If uidoc.FieldGetText("CkRequisicao") = "OK" Then
		Exit Sub
	End If
	Dim session As New NotesSession
	Dim db As New NotesDatabase (uidoc.document.ParentDatabase.Server, "adm.nsf")
	Dim doc As NotesDocument
	Set doc = db.CreateDocument
	doc.Form = "Requisicao"
	doc.Id = geraJavaId(doc)
	doc.Tipo = "Adendo Administrativo"
	doc.TipoVenda = uidoc.FieldGetText("TipoVenda")
	doc.Area = uidoc.FieldGetText("Area")
	doc.CodCliente = uidoc.FieldGetText("CodCliente")
	doc.Classe = uidoc.FieldGetText("Classe")
	doc.Codigo = uidoc.FieldGetText("Codigo") 
	doc.Sit = "Aguardando Aprovação"
	doc.Autor = session.CommonUserName
	doc.Criacao = Today
	doc.Descricao = uidoc.FieldGetText("Descricao")
	doc.AreaDespesa = uidoc.FieldGetText("AreaDespesa")
	doc.ResponsavelDespesa = uidoc.FieldGetText("ResponsavelDespesa")
	doc.ClassificacaoDespesa = uidoc.FieldGetText("ClassificacaoDespesa")
	doc.TipoCusto = uidoc.FieldGetText("ClassificacaoDespesa")
	doc.TipoCompra = uidoc.FieldGetText("TipoCompra")
	doc.Requisitante = session.CommonUserName
	doc.DataRequisicao = Today
	doc.TotMateriais = uidoc.FieldGetText("TotMateriais")
	doc.TotMateriais_1 = uidoc.FieldGetText("TotMateriais")
	doc.Areas = uidoc.FieldGetText("Areas")
	doc.Overhead = uidoc.FieldGetText("Overhead")
	doc.CkEnvioPedidoAprovacao = "OK"
	
	'Popula dolar$
	Dim moeda As Variant
	moeda = GetMoedas
	doc.USC = moeda(0)
	doc.UST = moeda(1)
	
	'Lista de Materais
	Dim Item As NotesItem
	Dim scan As Integer
	For scan = 0 To 49
		
		If Val(uidoc.FieldGetText ("Q_" + Cstr(scan))) <> 0 Then
			Set item = doc.ReplaceItemValue ("Q_" + Cstr(scan), uidoc.FieldGetText("Q_" + Cstr(scan)))	
			Set item = doc.ReplaceItemValue ("PartNo_" + Cstr(scan), uidoc.FieldGetText("PartNo_" + Cstr(scan)))	
			Set item = doc.ReplaceItemValue ("Produto_" + Cstr(scan), uidoc.FieldGetText("Produto_" + Cstr(scan)))
			Set item = doc.ReplaceItemValue ("us_" + Cstr(scan), uidoc.FieldGetText("us_" + Cstr(scan)))
			Set item = doc.ReplaceItemValue ("Custo_" + Cstr(scan), uidoc.FieldGetText("Custo_" + Cstr(scan)))
			Set item = doc.ReplaceItemValue ("Mg_" + Cstr(scan), uidoc.FieldGetText("Mg_" + Cstr(scan)))
			Set item = doc.ReplaceItemValue ("CustoUnit_" + Cstr(scan), uidoc.FieldGetText("CustoUnit_" + Cstr(scan)))
			Set item = doc.ReplaceItemValue ("CusTot_" + Cstr(scan), uidoc.FieldGetText("CusTot_" + Cstr(scan)))
			Set item = doc.ReplaceItemValue ("t_" + Cstr(scan), uidoc.FieldGetText("t_" + Cstr(scan)))
			Set item = doc.ReplaceItemValue ("IC_" + Cstr(scan), uidoc.FieldGetText("IC_" + Cstr(scan)))
			Set item = doc.ReplaceItemValue ("IP_" + Cstr(scan), uidoc.FieldGetText("IP_" + Cstr(scan)))
		End If
		
	Next
	
	Call doc.save (True, True)
	
	Call uidoc.FieldSetText("CkRequisicao", "OK")
	Call uidoc.Document.save ( True,True )
	
	'Envia Email
	Dim memo As notesdocument
	Set memo = New notesdocument( session.CurrentDatabase )
	memo.Form = "Memo"
	memo.From = session.CommonUserName
	'memo.SendTo = "Diretoria"
	'memo.SendTo = "Ludimila Oliveira"
	memo.Subject = "-> Pedido de Aprovação de Requisição de Compra"
	Dim rtitem As NotesRichTextItem
	Set rtitem = memo.CreateRichTextItem( "Body" )
	Call rtitem.AppendText( "Favor Aprovar requisição de Compra -> " )	
	Call rtitem.AppendDocLink( doc , "Link para a Requisição")
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Descrição: " & uidoc.FieldGettext( "Descricao" ) )
	Call memo.Send( True )     
	
End Sub

'++LotusScript Development Environment:2:2:PlanilhaFinanceira:5:8
%REM
	Sub PlanilhaFinanceira
	Description: Comments for Sub
%END REM
Sub PlanilhaFinanceira(projeto As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.CurrentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument, planilha As NotesDocument
	Set view = db.Getview("(Planilha/Codigo)")
	Set doc = view.Getdocumentbykey(projeto.Codigo(0), True)
	'Cria/Atualiza Planilha Financeira
	If doc Is Nothing Then
		Set planilha = New NotesDocument(db)
		planilha.Form = "PlanilhaFinanceira"
		planilha.Id = geraJavaId(planilha)
		planilha.Autor = session.Commonusername
		planilha.Criacao = Now
	Else
		Set planilha = doc
	End If
	planilha.Codigo = projeto.Codigo(0)
	planilha.Area = projeto.Area(0)
	planilha.AreaVendas = projeto.AreaVendas(0)
	planilha.GerenteConta = projeto.GerenteConta(0)
	planilha.Inside = projeto.Inside
	planilha.CodEmpresa = projeto.CodEmpresa(0)
	planilha.Descricao = projeto.Descricao(0)
	planilha.TipoVenda = projeto.TipoVenda(0)
	planilha.Sit = projeto.Sit(0)
	planilha.SitNumero = projeto.SitNumero(0)
	planilha.StatusNegocio = projeto.StatusNegocio(0)
	planilha.PrevEsforcoPV = projeto.PrevEsforcoPV(0)
	planilha.Resultado_P = projeto.Resultado_P(0)
	Call planilha.save(True, True)
	'Calcula Valores da Planilha Financeira
	Call CalcPlanilha(planilha)
	Call planilha.save(True, True)
	'Atualiza Projeto
	projeto.CkPlanilha = "OK"
	projeto.SaldoHorasHomem = planilha.HHST(0)
	
End Sub

'++LotusScript Development Environment:2:1:GetPrazoRenovacao:5:8
%REM
	Function GetPrazoRenovacao
	Description: Comments for Function
%END REM
Function GetPrazoRenovacao(codigo As String, item As String) As Integer
		
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "estoquemain.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim key(1) As String
	key(0) = codigo
	key(1) = item
	'Movimento
	Set view = db.Getview("(Movimento/ReservaItem)")
	Set doc = view.Getdocumentbykey(key, True)
	If Not doc Is Nothing Then
		GetPrazoRenovacao = Val(doc.Validade(0))
		If GetPrazoRenovacao = 0 Then
			'Equipamento
			Set view = db.Getview("(Catalogo/PartNumber)")
			Set doc = view.Getdocumentbykey(doc.PartNo(0), True)
			If Not doc Is Nothing Then
				GetPrazoRenovacao = Val(doc.ValidadeDias(0))
				If GetPrazoRenovacao = 0 Then GetPrazoRenovacao = Val(doc.Validade(0)) * 365
			End If
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:AnalisePerda:1:8
Sub AnalisePerda(negocio As NotesDocument)
	
	On Error Resume Next
	'Envia Email para a Diretoria
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim recipients(3) As String
	Set db = session.CurrentDatabase
	'Define Estilo do email
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	richStyle.Bold = False
	'Dias decorridos do Negócio - LMO 03/04/09
	Dim dataI As New NotesDateTime(negocio.Criacao(0))
	Dim dataF As New NotesDateTime(negocio.DataPerda(0))
	Dim dif As Double
	dif = dataF.TimeDifference(dataI)
	dif = dif / 86400
	'Envia Email
	Dim memo As New NotesDocument( db )
	memo.Form = "Memo"
	'Análise da Perda encaminhada para a Diretoria - LMO 11/01/16
	If negocio.Sit(0) = "Aguardando Análise da Perda" Then
		recipients(0) = "Junior Castro/TDec"
		recipients(1) = "Marcelo Castro/TDec"
		If negocio.TipoPerda(0) = "Consolidado" And negocio.NovoCodigo(0) <> "" Then
			memo.Subject = "-> Favor analisar a Consolidação do Negócio: " & negocio.Codigo(0) & " Novo Negócio: " & negocio.NovoCodigo(0) & " - Data da Consolidação: " & Format(negocio.DataPerda(0), "dd/mm/yyyy")
		Else
			memo.Subject = "-> Favor analisar a Perda do Negócio: " & negocio.Codigo(0) & " - Data da Perda: " & Format(negocio.DataPerda(0), "dd/mm/yyyy")
		End If
	'Análise da Perda Concluída
	Else
		recipients(0) = negocio.GerenteConta(0)
		recipients(1) = negocio.Inside(0)
		If negocio.TipoPerda(0) = "Consolidado" And negocio.NovoCodigo(0) <> "" Then
			memo.Subject = "-> Consolidação de Negócio para mudança de Projeto: " & negocio.Codigo(0) & " Novo Negócio: " & negocio.NovoCodigo(0) & " - Data da Consolidação: " & Format(negocio.DataPerda(0), "dd/mm/yyyy")
		ElseIf negocio.TipoPerda(0) = "Check Point" Then
			memo.Subject = "-> Negócio Postergado: " & negocio.Codigo(0) & " - Data do Próximo Check Point: " & Format(negocio.DataCheckPointPerda(0), "dd/mm/yyyy")
			recipients(2) = "Junior Castro/TDec"
			recipients(3) = "Marcelo Castro/TDec"
		Else
			memo.Subject = "-> Negócio Perdido: " & negocio.Codigo(0) & " - Data da Perda: " & Format(negocio.DataPerda(0), "dd/mm/yyyy")
		End If
	End If
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	'Calcula Extrato de Horas e Despesas
	Dim array As Variant
	array = ExtratoPerda(negocio)
	memo.SendTo = recipients
	memo.CopyTo = "administracaovendas@tdec.com.br"
	Dim corpo As New NotesRichTextItem( memo , "Body" )
	Call corpo.AppendStyle( richStyle )
	Call corpo.Appendtext("Análise da Perda")
	Call corpo.AddNewLine( 2 )
	Call corpo.Appendtext( "Negócio: " & negocio.Codigo(0) & " (" & negocio.Descricao(0) & ")" )
	If negocio.TipoPerda(0) = "Consolidado" And negocio.NovoCodigo(0) <> "" Then
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Negócio para Consolidação: " & negocio.NovoCodigo(0) )
	End If
	If CStr(negocio.ProbFechamento(0)) <> "" Then
		richStyle.Bold = True
		Call corpo.AppendStyle( richStyle )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Probabilidade de Fechamento: " & Format(negocio.ProbFechamento(UBound(negocio.ProbFechamento)), "percent") )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Valor Estimado: " & Format(negocio.ValorEstimado(0), "currency") )
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Valor Real: " & Format(negocio.TotalNegocio(0), "currency") )
		richStyle.Bold = False
		Call corpo.AppendStyle( richStyle )
	End If
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Parceria: " & negocio.Parceria(0) )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Data de Abertura: " & Format(negocio.Criacao(0), "dd/mm/yyyy") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Data da Perda: " & Format(negocio.DataPerda(0), "dd/mm/yyyy") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Dias Decorridos: " & Round(dif, 0) )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Tipo: " & negocio.TipoPerda(0) )
	If negocio.TipoPerda(0) <> "Check Point" Then
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Motivo: " & negocio.MotivoPerda(0) )
	End If
	If negocio.TipoPerda(0) = "Perdido" Then
		If negocio.MotivoPerda(0) = "Preço" Or negocio.MotivoPerda(0) = "Falta de Funcionalidade" Then
			Call corpo.AddNewLine( 1 )
			Call corpo.Appendtext( "Fabricante: " & negocio.Fabricante(0) )
		End If
		If negocio.MotivoPerda(0) = "Preço" Then
			Call corpo.AddNewLine( 1 )
			Call corpo.Appendtext( "Revenda: " & negocio.Revenda(0) )
			Call corpo.AddNewLine( 1 )
			Call corpo.Appendtext( "Preço do Concorrente: " & negocio.PrecoConcorrencia(0) )
			Call corpo.AddNewLine( 1 )
			Call corpo.Appendtext( "Diferença no Preço: " & Format(negocio.DifPrecoConcorrencia(0), "Currency") & " (" & Format(negocio.DifPrecoConcorrenciaP(0), "Percent") & ")")
		End If
	End If
	If negocio.TipoPerda(0) = "Check Point" Then
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Data do Próximo Check Point: " & Format(negocio.DataCheckPointPerda(0), "dd/mm/yyyy") )
	End If
	If negocio.ObsPerda(0) <> "" Then
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Observações: " & negocio.ObsPerda(0) )
	End If
	Call corpo.AddNewLine( 2 )
	Call corpo.Appendtext( "Frete e Intermediação de Vendas: " & Format(array(0), "currency") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Horas de Vendas: " & Format(array(1), "standard") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Despesas de Pré-Venda: " & Format(array(2), "currency") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Horas de Pré-Venda: " & Format(array(3), "standard") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Despesas de POC: " & Format(array(4), "currency") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Horas de POC: " & Format(array(5), "standard") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Despesas de Execução: " & Format(array(6), "currency") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Horas de Execução: " & Format(array(7), "standard") )
	Call corpo.AddNewLine( 2 )
	richStyle.Bold = True
	Call corpo.AppendStyle( richStyle )
	Call corpo.Appendtext( "Total de Despesas: " & Format(array(0) + array(2) + array(4) + array(6), "currency") )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Total de Horas: " & Format(array(1) + array(3) + array(5) + array(7), "standard") )
	'***
	richStyle.Bold = False
	Call corpo.AppendStyle( richStyle )
	Call corpo.AddNewLine( 2 )
	Call corpo.Appendtext( "Negócio ->  " )
	Call corpo.AppendDocLink( negocio, "Link para o Negócio" )
	Call memo.Send(False)
	
End Sub

'++LotusScript Development Environment:2:1:CkSatisfacao:1:8
Function CkSatisfacao(Source As NotesUIDocument) As Boolean
	
	CkSatisfacao = True
	If Source.FieldGetText("NivelSatisfacao") = "" Then
		Msgbox "Favor preencher o Nível de Satisfação do Cliente", 16, "Erro"
		Call Source.GotoField("NivelSatisfacao")
		CkSatisfacao = False
	End If
	
End Function



'++LotusScript Development Environment:2:1:WhoIsOnLine:1:8
Function WhoIsOnLine( uidoc As NotesUiDocument) As Variant
	
	'Verifica se existe um documento de Log com status "ativo" na vista
	'caso não econtre, cria um documento com este status para que 
	'apenas uma pessoa por vez utilize o documento 
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Set db = uidoc.Document.ParentDatabase
	Dim view As NotesView
	Set view = db.getView("(WhoIsOnLine)")
	Dim doc As NotesDocument
	Set doc = view.getDocumentByKey(uidoc.Document.Codigo(0), True)
	
	If Not (doc Is Nothing) Then
		Msgbox("O Negócio está em uso por " + doc.Responsavel(0))
		WhoIsOnLine = True
		Exit Function
	Else
		Dim loga As New NotesDocument(db)
		loga.Form = "Log"
		loga.Id = geraJavaId(loga)
		loga.Codigo = uidoc.Document.Codigo(0)
		loga.Entrada = Now
		loga.Responsavel = session.Username
		loga.Sit = "Ativo"		
		loga.Autores = session.CommonUserName
		Call loga. ComputeWIthForm(False, False)
		Call loga.Save(True, True)
		WhoIsOnLine = False
	End If
	
End Function

'++LotusScript Development Environment:2:1:GeraCodigo:1:8
Function GeraCodigo(negocio As NotesDocument)
	
	Dim db as New NotesDatabase(negocio.Parentdatabase.Server, "sales.nsf")
	Dim dc As NotesDocumentCollection
	Dim view As NotesView,  viewNeg As NotesView
	Dim doc As NotesDocument, docNeg As NotesDocument
	Dim ckCodigo As String, ckPrincipal As String
	Dim checkPrincipal As Integer, checkAdendo As Integer, x As Integer, var As String
	Set view = db.GetView("(CodigoAdendo)")
	Set viewNeg = db.GetView("(CodigoNegocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.CodCliente(0), False)
	Set doc = dc.GetFirstDocument
	checkPrincipal = 0
	checkAdendo = 65
	ckCodigo = UCase(negocio.CodCliente(0)) & "-1"
	ckPrincipal = ckCodigo
	var = ""
	Do Until doc Is Nothing
		'Principal
		If negocio.Classe(0) = "Principal" Then
			checkPrincipal = checkPrincipal + 1
			ckCodigo = UCase(negocio.CodCliente(0))+"-"+ Cstr(checkPrincipal)
			Set docNeg = viewNeg.GetDocumentByKey( ckCodigo, True)
			If docNeg Is Nothing Then
				negocio.NegocioPrincipal = ckCodigo
				Exit Do
			End If
		'Adendo
		Else
			checkAdendo = checkAdendo + 1
			If checkAdendo > 90 Then
				checkAdendo = 66
				x = x + 1
				var = Cstr(x)
			End If
			ckCodigo = Ucase(negocio.NegocioPrincipal(0))+"/"+Chr(checkAdendo) + var
			Set docNeg = viewNeg.GetDocumentByKey( ckCodigo, True )
			If docNeg Is Nothing Then
				Exit Do
			End If
		End If
	Loop
	negocio.Codigo = ckCodigo
	Messagebox("Novo Código = " + ckCodigo)
	
End Function

'++LotusScript Development Environment:2:1:CheckContratoLicenca:5:8
%REM
	Function CkContratoLicenca
	Description: Comments for Function
%END REM
Function CheckContratoLicenca(ui As NotesUIDocument)
	
	'Controle de Contrato/Licença - LMO 29/02/16
	Dim scan As Integer, scan2 As Integer, item As String
	CheckContratoLicenca = True
	If ui.Fieldgettext("TipoCompra") <> "Remessa" Then
		For scan = 0 To 49
			If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
				If ui.FieldGetText("T_" & scan) <> "HW" Then
					'Apenas se o Item não foi Comprado
					If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Compra") Then
						If ui.FieldGetText("ContratoRenovavel_" & scan) = "" Then
							CheckContratoLicenca = False
							If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
							scan2 = scan2 + 1
						End If
					End If
				End If
			End If
		Next
		If Not CheckContratoLicenca Then
			MsgBox "As informações do Contrato/Lincença estão desatualizadas no(s) Item(s) " & item & "." & Chr(10) & "Atualize o Catálogo do Estoque Main e depois o Negócio", 16, "Erro na Lista de Materiais"
			Exit Function
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:CheckStatusNegocio:1:8
Sub CheckStatusNegocio(doc As NotesDocument)
	
	'1)Prospect
	'2)Forecast
	'3)Pré-Venda
	'4)Pré-Venda Aguardando Providências do Cliente
	'5)Pré-Venda Aguardando Providências Internas
	'6)Pré-Venda Aguardando Materiais
	'7)Pré-Venda Aguardando Projeto Relacionado
	'8)Check Point de Pré-Venda Atrasado
	'9)POC
	'10)POC Aguardando Providências do Cliente
	'11)POC Aguardando Providências Internas
	'12)POC Aguardando Materiais
	'13)POC Aguardando Projeto Relacionado
	'14)Check Point de POC Atrasado
	'15)Aguardando Aprovação
	'16)Fechado / Faturamento Futuro
	'17)Faturar Produtos
	'18)Faturar Serviços
	'19)Faturar Produtos e Serviços
	'20)Execução Aguardando Providências do Cliente
	'21)Execução Aguardando Providências Internas
	'22)Execução Aguardando Materiais
	'23)Execução Aguardando Projeto Relacionado
	'24)Check Point de Execução Atrasado
	'25)Contrato
	'26)Receber
	'27)Aguardando Conclusão do Projeto
	'28)Aguardando Conclusão da Importação
	'29)Aguardando Baixa
	'30)Concluído
	'31)Aguardando Análise da Perda
	'32)Consolidado
	'33)Perdido
	'34)Postergado
	'35)Verificar Lista de Materiais
	
	Dim saldoFat As Double, sit As String, tipoVenda As String, sitContrato As String, sitServicos As String
	Dim statusFat As Variant, fechado As Variant
	Dim pos As Integer
	statusFat = AtualizaSaldosAFaturar(doc)
	Call AtualizaSaldosEstoque(doc)
	saldoFat = statusFat(0)
	If statusFat(1) = 1 Then fechado = True Else fechado = False
	sit = doc.Sit(0)
	tipovenda = doc.TipoVenda(0)
	If CStr(doc.Antigo(0)) = "1" And fechado Then
		doc.Sit = "Concluído"
		doc.SitNumero = 30
	ElseIf saldoFat = 0 And sit = "Aguardando Análise da Perda" Then
		doc.SitNumero = 31
	ElseIf saldoFat = 0 And sit = "Consolidado" Then
		doc.SitNumero = 32
	ElseIf CStr(doc.Antigo(0)) = "1" And Not fechado Then
		doc.Sit = "Perdido"
		doc.SitNumero = 33
	ElseIf saldoFat = 0 And sit = "Perdido" Then
		doc.SitNumero = 33
	ElseIf saldoFat = 0 And sit = "Postergado" Then
		doc.SitNumero = 34
	ElseIf saldoFat <> 0 And sit = "Perdido" Then
		doc.Sit = "Verificar Lista de Materiais"
		doc.SitNumero = 35
	ElseIf tipovenda = "Contrato" And sit = "Concluído" Then
		doc.SitNumero = 30
	ElseIf tipovenda = "Contrato" And sit = "Contrato" Then
		doc.SitNumero = 25
	ElseIf tipovenda = "Contrato" And sit = "Fechado" Then
		doc.Sit = "Contrato"
		doc.SitNumero = 25
	ElseIf sit = "Prospect" Then
		doc.SitNumero = 1
	ElseIf fechado = False And sit = "Aguardando Aprovação" Then
		If doc.TipoAprovacao(0) = "Frete Revenda" Then
			If Not CheckFreteRevenda(doc) Then
				doc.Sit = "Forecast"
				doc.SitNumero = 2
			End If
		ElseIf doc.TipoAprovacao(0) = "Frete Projeto" Then
			If Not CheckFreteProjeto(doc) Then
				doc.Sit = "Forecast"
				doc.SitNumero = 2
			End If
		ElseIf doc.TipoAprovacao(0) = "Margem Item" Then
			If Not CheckMgItens(doc) Then
				doc.Sit = "Forecast"
				doc.SitNumero = 2
			End If
		ElseIf doc.TipoAprovacao(0) = "FI" Then
			If CheckFI(doc, "Solicita Aprovação") Then
				doc.Sit = "Forecast"
				doc.SitNumero = 2
			End If
		ElseIf doc.TipoAprovacao(0) = "Margem Negócio" Then
			If Not CheckMgNegocio(doc) Then
				doc.Sit = "Forecast"
				doc.SitNumero = 2
			End If
		ElseIf doc.TipoAprovacao(0) = "Margem Revenda" Then
			If Not CheckMgRevenda(doc) Then
				doc.Sit = "Forecast"
				doc.SitNumero = 2
			End If
		ElseIf doc.TipoAprovacao(0) = "Margem Serviços" Then
			If Not CheckMgServicos(doc) Then
				doc.Sit = "Forecast"
				doc.SitNumero = 2
			End If
		End If
	ElseIf sit = "Forecast" And fechado = True Then
		doc.Sit = "Fechado"
		doc.SitNumero = 16
	ElseIf sit = "Forecast" Then
		doc.SitNumero = 2
	ElseIf fechado = False And sit = "Fechado" Then
		doc.Sit = "Forecast"
		doc.SitNumero = 2
	ElseIf sit = "Faturamento Futuro" And CStr(doc.DataFaturamentoFuturo(0)) <> "" Then
		doc.Sit = "Faturamento Futuro"
		doc.SitNumero = 16
	ElseIf fechado = False And doc.StatusProjeto(0) = "Aguardando Fechamento" Then
		doc.Sit = "Forecast"
		doc.SitNumero = 2
	ElseIf fechado = False And sit = "Pré-Venda" Then
		doc.SitNumero = 3
	ElseIf fechado = False And sit = "Pré-Venda Aguardando Providências do Cliente" Then
		If doc.StatusProjeto(0) = "Pré-Venda Aguardando Providências do Cliente" Then
			doc.SitNumero = 4
		Else
			doc.Sit = "Pré-Venda"
			doc.SitNumero = 3
		End If
	ElseIf fechado = False And sit = "Pré-Venda Aguardando Providências Internas" Then
		If doc.StatusProjeto(0) = "Pré-Venda Aguardando Providências Internas" Then
			doc.SitNumero = 5
		Else
			doc.Sit = "Pré-Venda"
			doc.SitNumero = 3
		End If
	ElseIf fechado = False And sit = "Pré-Venda Aguardando Materiais" Then
		If doc.StatusProjeto(0) = "Pré-Venda Aguardando Materiais" Then
			doc.SitNumero = 6
		Else
			doc.Sit = "Pré-Venda"
			doc.SitNumero = 3
		End If
	ElseIf fechado = False And sit = "Pré-Venda Aguardando Projeto Relacionado" Then
		If doc.StatusProjeto(0) = "Pré-Venda Aguardando Projeto Relacionado" Then
			doc.SitNumero = 7
		Else
			doc.Sit = "Pré-Venda"
			doc.SitNumero = 3
		End If
	ElseIf fechado = False And sit = "Check Point de Pré-Venda Atrasado" Then
		If doc.StatusProjeto(0) = "Check Point de Pré-Venda Atrasado" Then
			doc.SitNumero = 8
		Else
			doc.Sit = "Pré-Venda"
			doc.SitNumero = 3
		End If
	ElseIf fechado = False And sit = "POC" Then
		doc.Sit = "POC"
		doc.SitNumero = 9
	ElseIf fechado = False And sit = "POC Aguardando Providências do Cliente" Then
		If doc.StatusProjeto(0) = "POC Aguardando Providências do Cliente" Then
			doc.SitNumero = 10
		Else
			doc.Sit = "POC"
			doc.SitNumero = 9
		End If
	ElseIf fechado = False And sit = "POC Aguardando Providências Internas" Then
		If doc.StatusProjeto(0) = "POC Aguardando Providências Internas" Then
			doc.SitNumero = 11
		Else
			doc.Sit = "POC"
			doc.SitNumero = 9
		End If
	ElseIf fechado = False And sit = "POC Aguardando Materiais" Then
		If doc.StatusProjeto(0) = "POC Aguardando Materiais" Then
			doc.SitNumero = 12
		Else
			doc.Sit = "POC"
			doc.SitNumero = 9
		End If
	ElseIf fechado = False And sit = "POC Aguardando Projeto Relacionado" Then
		If doc.StatusProjeto(0) = "POC Aguardando Projeto Relacionado" Then
			doc.SitNumero = 13
		Else
			doc.Sit = "POC"
			doc.SitNumero = 9
		End If
	ElseIf fechado = False And sit = "Check Point de POC Atrasado" Then
		If doc.StatusProjeto(0) = "Check Point de POC Atrasado" Then
			doc.SitNumero = 14
		Else
			doc.Sit = "POC"
			doc.SitNumero = 9
		End If
	ElseIf sit = "Execução Aguardando Providências do Cliente" Then
		If doc.StatusProjeto(0) = "Execução Aguardando Providências do Cliente" Then
			doc.SitNumero = 20
		Else
			doc.Sit = "Fechado"
			doc.SitNumero = 16
		End If
	ElseIf sit = "Execução Aguardando Providências Internas" Then
		If doc.StatusProjeto(0) = "Execução Aguardando Providências Internas" Then
			doc.SitNumero = 21
		Else
			doc.Sit = "Fechado"
			doc.SitNumero = 16
		End If
	ElseIf sit = "Execução Aguardando Materiais" Then
		If doc.StatusProjeto(0) = "Execução Aguardando Materiais" Then
			doc.SitNumero = 22
		Else
			doc.Sit = "Fechado"
			doc.SitNumero = 16
		End If
	ElseIf sit = "Execução Aguardando Projeto Relacionado" Then
		If doc.StatusProjeto(0) = "Execução Aguardando Projeto Relacionado" Then
			doc.SitNumero = 23
		Else
			doc.Sit = "Fechado"
			doc.SitNumero = 16
		End If
	ElseIf sit = "Check Point de Execução Atrasado" Then
		If doc.StatusProjeto(0) = "Check Point de Execução Atrasado" Then
			doc.SitNumero = 24
		Else
			doc.Sit = "Fechado"
			doc.SitNumero = 16
		End If
	ElseIf saldoFat = 0 And fechado = True Then
		If Not CkReceber(doc) Then
			doc.Sit = "Receber"
			doc.SitNumero = 26
		ElseIf Not CkProjeto(doc) Then
			doc.Sit = "Aguardando Conclusão do Projeto"
			doc.SitNumero = 27
		ElseIf Not CkImportacao(doc) Then
			doc.Sit = "Aguardando Conclusão da Importação"
			doc.SitNumero = 28
		ElseIf Not CkBaixa(doc) Then
			doc.Sit = "Aguardando Baixa"
			doc.SitNumero = 29
		Else
			doc.Sit = "Concluído"
			doc.SitNumero = 30
		End If
	ElseIf saldoFat <> 0 And fechado = True Then
		Dim array As Variant
		array = CheckFaturamento(doc)
		If array(0) And array(1) Then
			doc.Sit = "Faturar Produtos e Serviços"
			doc.SitNumero = 19
		ElseIf array(0) Then
			doc.Sit = "Faturar Produtos"
			doc.SitNumero = 17
		ElseIf array(1) Then
			doc.Sit = "Faturar Serviços"
			doc.SitNumero = 18
		Else
			doc.Sit = "Fechado"
			doc.SitNumero = 16
		End If
	End If
	'Conclusão do Negócio
	If doc.Sit(0) = "Concluído" Then
		'Data da Conclusão do Negócio
		If doc.CheckConclusao(0) = "" Or doc.DataConclusao(0) = "" Then
			doc.DataConclusao = Today
			'Call GetDataConclusao(doc)
		End If
		'Cria Renovação de Contrato
		Call CriarRenovacao(doc)
	Else
		doc.DataConclusao = ""
		doc.CheckConclusao = ""
		'doc.CheckPagtoComissao = "" 'Não gerar Ajuste de Comissão na Reativação do Projeto - LMO 16/04/25
	End If
	
End Sub

'++LotusScript Development Environment:2:2:GeraDespesasParticipacao:5:8
%REM
	Sub GeraDespesasParticipacao
	Description: Comments for Sub
%END REM
Sub GeraDespesasParticipacao(negocio As NotesDocument)
	
	On Error Resume Next
	If negocio.CheckPagtoParticipacoes(0) = "OK" Then Exit Sub
	Dim scan As Integer, indice As Variant
	Dim venc As NotesDateTime, vencPV As NotesDateTime, vencExec As NotesDateTime, vencPMO As NotesDateTime
	Set venc = New NotesDateTime("12/" & Month(Today) & "/" & Year(Today))
	Call venc.AdjustMonth(1)
	Dim doc As Variant
	'Pré-Venda/POC
	If Val(negocio.ValorPremioPV(0)) > 0 Then
		Set vencPV = New NotesDateTime(venc.Dateonly)
		If CStr(negocio.DiaPagtoPV(0)) <> "" And CStr(negocio.MesPagtoPV(0)) <> "" Then
			Set vencPV = New NotesDateTime(negocio.DiaPagtoPV(0) & "/" & Month(venc.Dateonly) & "/" & Year(venc.Dateonly))
			indice = ArrayGetIndex(negocio.MesPagtoPV, Month(vencPV.Dateonly))
			Do Until Not IsNull(indice)
				Call vencPV.AdjustMonth(1)
				indice = ArrayGetIndex(negocio.MesPagtoPV, Month(vencPV.Dateonly))
			Loop
		End If
		'Ajusta Data de Vencimento
		Do Until Weekday(vencPV.DateOnly) <> 1 And Weekday(vencPV.DateOnly) <> 7 And Not ckFeriado(vencPV.DateOnly)
			Call vencPV.Adjustday(1, True)
		Loop
		For scan = 0 To UBound(negocio.NomePV)
			If CStr(negocio.ValorParticipacaoPV(scan)) <> "" And negocio.NomePV(scan) <> "" Then
				If Round(negocio.ValorParticipacaoPV(scan), 2) > 0 Then
					'Gera Despesa
					Set doc = New ccDespesa(negocio)
					doc.Origem = "Participação Pré-Venda/POC - " & negocio.Codigo(0)
					doc.Codigo = negocio.Codigo(0)
					doc.Sit = "Pendente"
					doc.Classificacao = "Participação em Resultado"
					doc.Area = negocio.Area(0)
					doc.Responsavel = negocio.NomePV(scan)
					doc.Data = Today
					doc.Vencimento = vencPV.DateOnly
					doc.Adianta = False
					doc.Descricao = "Participação da Pré-Venda/POC - " & negocio.Codigo(0)
					doc.Valor = Round(negocio.ValorParticipacaoPV(scan), 2)
					doc.TipoCompra = negocio.TipoCompra(0)
					doc.TipoVenda = negocio.TipoVenda(0)
					Call doc.Save
					'Aviso Participacao
					Call AvisoParticipacao(negocio, "Pré-Venda/POC", negocio.NomePV(scan), Round(negocio.ValorParticipacaoPV(scan), 2), vencPV.DateOnly)
				End If
			End If
		Next
	End If
	'Execução
	If Val(negocio.ValorPremioExec(0)) > 0 Then
		Set vencExec = New NotesDateTime(venc.Dateonly)
		If CStr(negocio.DiaPagtoExec(0)) <> "" And CStr(negocio.MesPagtoExec(0)) <> "" Then
			Set vencExec = New NotesDateTime(negocio.DiaPagtoExec(0) & "/" & Month(venc.Dateonly) & "/" & Year(venc.Dateonly))
			indice = ArrayGetIndex(negocio.MesPagtoExec, Month(vencExec.Dateonly))
			Do Until Not IsNull(indice)
				Call vencExec.AdjustMonth(1)
				indice = ArrayGetIndex(negocio.MesPagtoExec, Month(vencExec.Dateonly))
			Loop
		End If
		'Ajusta Data de Vencimento
		Do Until Weekday(vencExec.DateOnly) <> 1 And Weekday(vencExec.DateOnly) <> 7 And Not ckFeriado(vencExec.DateOnly)
			Call vencExec.Adjustday(1, True)
		Loop
		For scan = 0 To UBound(negocio.NomeExec)
			If CStr(negocio.ValorParticipacaoExec(scan)) <> "" And negocio.NomeExec(scan) <> "" Then
				If Round(negocio.ValorParticipacaoExec(scan), 2) > 0 Then
					'Gera Despesa
					Set doc = New ccDespesa(negocio)
					doc.Origem = "Participação Execução - " & negocio.Codigo(0)
					doc.Codigo = negocio.Codigo(0)
					doc.Sit = "Pendente"
					doc.Classificacao = "Participação em Resultado"
					doc.Area = negocio.Area(0)
					doc.Responsavel = negocio.NomeExec(scan)
					doc.Data = Today
					doc.Vencimento = vencExec.DateOnly
					doc.Adianta = False
					doc.Descricao = "Participação da Execução - " & negocio.Codigo(0)
					doc.Valor = Round(negocio.ValorParticipacaoExec(scan), 2)
					doc.TipoCompra = negocio.TipoCompra(0)
					doc.TipoVenda = negocio.TipoVenda(0)
					Call doc.Save
					'Aviso Participacao
					Call AvisoParticipacao(negocio, "Execução", negocio.NomeExec(scan), Round(negocio.ValorParticipacaoExec(scan), 2), vencExec.DateOnly)
				End If
			End If
		Next
	End If
	'PMO
	If Val(negocio.ValorPremioPMO(0)) > 0 Then
		Set vencPMO = New NotesDateTime(venc.Dateonly)
		If CStr(negocio.DiaPagtoPMO(0)) <> "" And CStr(negocio.MesPagtoPMO(0)) <> "" Then
			Set vencPMO = New NotesDateTime(negocio.DiaPagtoPMO(0) & "/" & Month(venc.Dateonly) & "/" & Year(venc.Dateonly))
			indice = ArrayGetIndex(negocio.MesPagtoPMO, Month(vencPMO.Dateonly))
			Do Until Not IsNull(indice)
				Call vencPMO.AdjustMonth(1)
				indice = ArrayGetIndex(negocio.MesPagtoPMO, Month(vencPMO.Dateonly))
			Loop
		End If
		'Ajusta Data de Vencimento
		Do Until Weekday(vencPMO.DateOnly) <> 1 And Weekday(vencPMO.DateOnly) <> 7 And Not ckFeriado(vencPMO.DateOnly)
			Call vencPMO.Adjustday(1, True)
		Loop
		For scan = 0 To UBound(negocio.NomePMO)
			If CStr(negocio.ValorParticipacaoPMO(scan)) <> "" And negocio.NomePMO(scan) <> "" Then
				If Round(negocio.ValorParticipacaoPMO(scan), 2) > 0 Then
					'Gera Despesa
					Set doc = New ccDespesa(negocio)
					doc.Origem = "Participação PMO - " & negocio.Codigo(0)
					doc.Codigo = negocio.Codigo(0)
					doc.Sit = "Pendente"
					doc.Classificacao = "Participação em Resultado"
					doc.Area = negocio.Area(0)
					doc.Responsavel = negocio.NomePMO(scan)
					doc.Data = Today
					doc.Vencimento = vencPMO.DateOnly
					doc.Adianta = False
					doc.Descricao = "Participação PMO - " & negocio.Codigo(0)
					doc.Valor = Round(negocio.ValorParticipacaoPMO(scan), 2)
					doc.TipoCompra = negocio.TipoCompra(0)
					doc.TipoVenda = negocio.TipoVenda(0)
					Call doc.Save
					'Aviso Participacao
					Call AvisoParticipacao(negocio, "PMO", negocio.NomePMO(scan), Round(negocio.ValorParticipacaoPMO(scan), 2), vencPMO.DateOnly)
				End If
			End If
		Next
	End If
	negocio.CheckPagtoParticipacoes = "OK"
	
End Sub

'++LotusScript Development Environment:2:2:CriarPrejuizo:5:8
%REM
	Sub CriarPrejuizo
	Description: Comments for Sub
%END REM
Sub CriarPrejuizo(negocio As NotesDocument)
	
	Call AtualizaSaldosAFaturar(negocio)
	Call AtualizaSaldosEstoque(negocio)
	Call negocio.Save(False, False)
	If negocio.SaldoFaturamento(0) = 0 And negocio.ValorEstoque(0) = 0 Then
		MsgBox "O Negócio " & negocio.Codigo(0) & " não tem Saldo de Faturamento nem Valor Em Estoque.", 16, "Erro no Criar Prejuízo"
		Exit Sub
	End If
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim scan As Integer
	Dim fator As Double
	Set db = session.Currentdatabase
	Set view = db.Getview("(Prejuizos/Codigo)")
	Set doc = view.Getdocumentbykey(negocio.Codigo(0), True)
	If doc Is Nothing Then
		Set doc = New NotesDocument(db)
		doc.Form = "Prejuizo"
		doc.Id = geraJavaId(doc)
		doc.Codigo = negocio.Codigo
		doc.IdOrigem = negocio.Id
		doc.CodigoOrigem = negocio.Codigo
		doc.Autor = session.CommonUserName
		doc.Criacao = Now
		doc.Sit = "Pendente"
	End If
	doc.Cliente = negocio.Cliente
	doc.UF = negocio.UF
	doc.Contribuinte = negocio.Contribuinte
	doc.CodCliente = negocio.CodCliente
	doc.CodigoGrupoEconomico = negocio.CodigoGrupoEconomico
	doc.CodEmpresa = negocio.CodEmpresa
	doc.DataCotacaoUS = negocio.DataCotacaoUS
	doc.USC = negocio.USC
	doc.UST = negocio.UST
	doc.USCompra = negocio.USCompra
	doc.USVenda = negocio.USVenda
	doc.Classe = negocio.Classe
	doc.TipoAdendo = negocio.TipoAdendo
	doc.NegocioPrincipal = negocio.NegocioPrincipal
	doc.Grupo = negocio.Grupo
	doc.Descricao = negocio.Descricao
	doc.Principal = negocio.Codigo
	doc.OrigemOportunidade = negocio.OrigemOportunidade
	doc.Dias = negocio.Dias
	doc.DiaDesdeFechamento = negocio.DiaDesdeFechamento
	doc.Data = negocio.Criacao
	doc.TipoVenda = negocio.TipoVenda
	doc.AreaVendas = negocio.AreaVendas
	doc.GerenteConta = negocio.GerenteConta
	doc.Inside = negocio.Inside
	doc.NomeComissao = negocio.NomeComissao
	doc.ParticipacaoComissao = negocio.ParticipacaoComissao
	doc.ContatoComercial = negocio.ContatoComercial
	doc.CargoComercial = negocio.CargoComercial
	doc.TelComercial = negocio.TelComercial
	doc.CelComercial = negocio.CelComercial
	doc.eMailComercial = negocio.eMailComercial
	doc.ContatoTecnico = negocio.ContatoTecnico
	doc.CargoTecnico = negocio.CargoTecnico
	doc.TelTecnico = negocio.TelTecnico
	doc.CelTecnico = negocio.CelTecnico
	doc.eMailTecnico = negocio.eMailTecnico
	doc.Parceria = negocio.Parceria
	doc.Temperatura = negocio.Temperatura
	doc.SitNumero = negocio.SitNumero
	doc.PrazoPagamento = negocio.PrazoPagamento
	doc.PrazoPagamentoFornecedor = negocio.PrazoPagamentoFornecedor
	'Lista de Materiais
	Dim icmsst As Double
	doc.ResultadoRevendaP = negocio.ResultadoRevendaP
	doc.FI_HW = negocio.FI_HW
	doc.FI_SW = negocio.FI_SW
	doc.FI_SV = negocio.FI_SV
	doc.Destino = negocio.Destino
	For scan = 0 To 49
		If Val(negocio.Getitemvalue("QEstoque_" & scan)(0)) > 0 Then
			Call doc.Replaceitemvalue("Q_" & scan, negocio.Getitemvalue("QEstoque_" & scan)(0))
			Call doc.Replaceitemvalue("PartNo_" & scan, negocio.Getitemvalue("PartNo_" & scan)(0))
			Call doc.Replaceitemvalue("Produto_" & scan, negocio.Getitemvalue("Produto_" & scan)(0))
			Call doc.Replaceitemvalue("t_" & scan, negocio.Getitemvalue("t_" & scan)(0))
			Call doc.Replaceitemvalue("Un_" & scan, negocio.Getitemvalue("Un_" & scan)(0))
			Call doc.Replaceitemvalue("CF_" & scan, negocio.Getitemvalue("CF_" & scan)(0))
			Call doc.Replaceitemvalue("ST_" & scan, negocio.Getitemvalue("ST_" & scan)(0))
			Call doc.Replaceitemvalue("Fabricante_" & scan, negocio.Getitemvalue("Fabricante_" & scan)(0))
			Call doc.Replaceitemvalue("UFCompra_" & scan, negocio.Getitemvalue("UFCompra_" & scan)(0))
			Call doc.Replaceitemvalue("ICC_" & scan, negocio.Getitemvalue("ICC_" & scan)(0))
			Call doc.Replaceitemvalue("IPC_" & scan, negocio.Getitemvalue("IPC_" & scan)(0))
			Call doc.Replaceitemvalue("us_" & scan, negocio.Getitemvalue("us_" & scan)(0))
			Call doc.Replaceitemvalue("CustoFOB_" & scan, negocio.Getitemvalue("CustoFOB_" & scan)(0))
			Call doc.Replaceitemvalue("FI_" & scan, negocio.Getitemvalue("FI_" & scan)(0))
			Call doc.Replaceitemvalue("Custo_" & scan, negocio.Getitemvalue("Custo_" & scan)(0))
			Call doc.Replaceitemvalue("ICMSSTC_" & scan, negocio.Getitemvalue("ICMSSTC_" & scan)(0))
			Call doc.Replaceitemvalue("Mg_" & scan, negocio.Getitemvalue("Mg_" & scan)(0))
			Call doc.Replaceitemvalue("CustoUnit_" & scan, negocio.Getitemvalue("CustoUnit_" & scan)(0))
			Call doc.Replaceitemvalue("CusTot_" & scan, negocio.Getitemvalue("CustoUnit_" & scan)(0) * negocio.Getitemvalue("QEstoque_" & scan)(0))
			Call doc.Replaceitemvalue("ICMSST_" & scan, negocio.Getitemvalue("ICMSST_" & scan)(0) / negocio.Getitemvalue("Q_" & scan)(0) * negocio.Getitemvalue("QEstoque_" & scan)(0))
			Call doc.Replaceitemvalue("VendaTot_" & scan, doc.Getitemvalue("CusTot_" & scan)(0) + doc.Getitemvalue("ICMSST_" & scan)(0))
			Call doc.Replaceitemvalue("IC_" & scan, negocio.Getitemvalue("IC_" & scan)(0))
			Call doc.Replaceitemvalue("ICD_" & scan, negocio.Getitemvalue("ICD_" & scan)(0))
			Call doc.Replaceitemvalue("FCP_" & scan, negocio.Getitemvalue("FCP_" & scan)(0))
			Call doc.Replaceitemvalue("IP_" & scan, negocio.Getitemvalue("IP_" & scan)(0))
			Call doc.Replaceitemvalue("II_" & scan, negocio.Getitemvalue("II_" & scan)(0))
			Call doc.Replaceitemvalue("QFat_" & scan, negocio.Getitemvalue("QFat_" & scan)(0))
			Call doc.Replaceitemvalue("QEstoque_" & scan, negocio.Getitemvalue("QEstoque_" & scan)(0))
		End If
		If negocio.Getitemvalue("t_" & scan)(0) <> "HW" Then
			Call AtualizaMovimentoNegocio(negocio, scan)
		End If
	Next
	'Lista de Serviços
	For scan = 0 To 11
		If Val(negocio.Getitemvalue("VlFat_" & scan)(0)) > 0 Then
			fator = negocio.Getitemvalue("VlFat_" & scan)(0) / negocio.Getitemvalue("CusTots_" & scan)(0)
			Call doc.Replaceitemvalue("Qs_" & scan, negocio.Getitemvalue("Qs_" & scan)(0))
			Call doc.Replaceitemvalue("PartNos_" & scan, negocio.Getitemvalue("PartNos_" & scan)(0))
			Call doc.Replaceitemvalue("Produtos_" & scan, negocio.Getitemvalue("Produtos_" & scan)(0))
			Call doc.Replaceitemvalue("uss_" & scan, negocio.Getitemvalue("uss_" & scan)(0))
			Call doc.Replaceitemvalue("Custos_" & scan, negocio.Getitemvalue("Custos_" & scan)(0) * fator)
			Call doc.Replaceitemvalue("Terceiros_" & scan, negocio.Getitemvalue("Terceiros_" & scan)(0) * fator)
			Call doc.Replaceitemvalue("Mgs_" & scan, negocio.Getitemvalue("Mgs_" & scan)(0))
			Call doc.Replaceitemvalue("CustoUnits_" & scan, negocio.Getitemvalue("CustoUnits_" & scan)(0) * fator)
			Call doc.Replaceitemvalue("Despesas_" & scan, negocio.Getitemvalue("Despesas_" & scan)(0) * fator)
			Call doc.Replaceitemvalue("CPS_" & scan, negocio.Getitemvalue("CPS_" & scan)(0) * fator)
			Call doc.Replaceitemvalue("CusTots_" & scan, negocio.Getitemvalue("CusTots_" & scan)(0) * fator)
			Call doc.Replaceitemvalue("RIR_" & scan, negocio.Getitemvalue("RIR_" & scan)(0))
			Call doc.Replaceitemvalue("RIN_" & scan, negocio.Getitemvalue("RIN_" & scan)(0))
			Call doc.Replaceitemvalue("ISS_" & scan, negocio.Getitemvalue("ISS_" & scan)(0))
			Call doc.Replaceitemvalue("VlFat_" & scan, negocio.Getitemvalue("VlFat_" & scan)(0))
			Call doc.Replaceitemvalue("Participacao_" & scan, negocio.Getitemvalue("Participacao_" & scan)(0))
		End If
	Next
	Call CalcTotaisNegocio(doc)
	Call doc.Computewithform(False, False)
	Call doc.save(True, True)
	Call ConcluirNegocio(negocio)
	Call negocio.save(False, False)
	MsgBox "Prejuízo " & doc.Codigo(0) & " Criado/Atualizado", 64, "Aviso"
	
End Sub

'++LotusScript Development Environment:2:2:Contrato:1:8
Sub Contrato(negocio As NotesDocument, acao As String)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument, contrato As NotesDocument
	Dim array As Variant
	Dim scan As Integer, x As Integer
	Set view = db.GetView("(ContratosCodigo)")
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	'Novo Contrato
	If doc Is Nothing Then
		Set contrato = New NotesDocument(db)
		contrato.Form = "Contrato"
		contrato.Id = geraJavaId(contrato)
		contrato.Autor = session.CommonUserName
		contrato.Criacao = Now
		If InStr(negocio.Sit(0), "Pré-Venda") > 0 Then
			contrato.Sit = "Aguardando Planejamento da Pré-Venda"
			contrato.SitNumero = 1
			contrato.StatusNegocio = "Pré-Venda"
			contrato.ValorEstimado = negocio.ValorEstimado(UBound(negocio.ValorEstimado))
			contrato.ProbFechamento = negocio.ProbFechamento(UBound(negocio.ProbFechamento))
			contrato.DataLimitePV = negocio.DataLimitePV(UBound(negocio.DataLimitePV))
			contrato.RespSolicitacaoPV = negocio.RespSolicitacaoPV(UBound(negocio.RespSolicitacaoPV))
			contrato.SolicitacaoPV = negocio.SolicitacaoPV(UBound(negocio.SolicitacaoPV))
			contrato.Obs = negocio.Obs(UBound(negocio.Obs))
			contrato.CkPreVenda = negocio.CkPreVenda(0)
		ElseIf InStr(negocio.Sit(0), "POC") > 0 Then
			contrato.Sit = "Aguardando Planejamento do POC"
			contrato.SitNumero = 15
			contrato.StatusNegocio = "POC"
			contrato.ValorEstimadoPOC = negocio.ValorEstimadoPOC(UBound(negocio.ValorEstimadoPOC))
			contrato.ProbFechamentoPOC = negocio.ProbFechamentoPOC(UBound(negocio.ProbFechamentoPOC))
			contrato.DataLimitePOC = negocio.DataLimitePOC(UBound(negocio.DataLimitePOC))
			contrato.RespPOC = negocio.RespSolicitacaoPOC(UBound(negocio.RespSolicitacaoPOC))
			contrato.SolicitacaoPOC = negocio.SolicitacaoPOC(UBound(negocio.SolicitacaoPOC))
			contrato.ObsPOC = negocio.ObsPOC(UBound(negocio.ObsPOC))
			contrato.CkConclusaoPOC = negocio.CkConclusaoPOC(0)
		End If	
	Else
		Set contrato = doc
	End If
	contrato.StatusNegocio = negocio.Sit(0)
	contrato.DataFechamento = negocio.DataFechamento(0)
	contrato.RespFechamento = negocio.RespFechamento(0)
	contrato.DataConclusao = negocio.DataConclusao(0)
	contrato.RespConclusao = negocio.RespConclusao(0)
	contrato.TipoVenda = negocio.TipoVenda
	contrato.Cliente = negocio.Cliente(0)
	contrato.CodCliente = negocio.CodCliente(0)
	contrato.CodigoGrupoEconomico = negocio.CodigoGrupoEconomico(0)
	contrato.Codigo = negocio.Codigo
	contrato.CodEmpresa = negocio.CodEmpresa
	contrato.AreaVendas = negocio.AreaVendas
	contrato.Area = negocio.Area
	contrato.Descricao = negocio.Descricao
	contrato.GerenteConta = negocio.GerenteConta
	contrato.Inside = negocio.Inside
	'*** Matriz de Tarifacao ***
	%REM
	'Condições Comerciais
	contrato.DataInicial = negocio.DataInicial
	contrato.DataFinal = negocio.DataFinal
	contrato.TipoPagamento = negocio.TipoPagamento
	contrato.DiaFaturamento = negocio.DiaFaturamento
	If CStr(negocio.DataReajuste(0)) = "" Then
		contrato.DataReajuste = negocio.DataFinal
	Else
		contrato.DataReajuste = negocio.DataReajuste
	End If
	If CStr(negocio.IndiceReajuste(0)) = "" Then
		contrato.IndiceReajuste = "IGPM"
	Else
		contrato.IndiceReajuste = negocio.IndiceReajuste
	End If
	For scan = 0 To 9
		Call contrato.ReplaceItemValue("CQs_" & scan, negocio.Getitemvalue("CQs_" & scan)(0))
		Call contrato.ReplaceItemValue("CPartNo_" & scan, negocio.Getitemvalue("CPartNo_" & scan)(0))
		Call contrato.ReplaceItemValue("CProdutos_" & scan, negocio.Getitemvalue("CProdutos_" & scan)(0))
		Call contrato.ReplaceItemValue("CNBS_" & scan, negocio.Getitemvalue("CNBS_" & scan)(0))
		Call contrato.ReplaceItemValue("CTipo_" & scan, negocio.Getitemvalue("CTipo_" & scan))
		Call contrato.ReplaceItemValue("CArea_" & scan, negocio.Getitemvalue("CArea_" & scan))
		Call contrato.ReplaceItemValue("CMg_" & scan, negocio.Getitemvalue("CMg_" & scan)(0))
		Call contrato.ReplaceItemValue("CCusTots_" & scan, negocio.Getitemvalue("CCusTots_" & scan)(0))
		Call contrato.ReplaceItemValue("CRIR_" & scan, negocio.Getitemvalue("CRIR_" & scan)(0))
		Call contrato.ReplaceItemValue("CRIN_" & scan, negocio.Getitemvalue("CRIN_" & scan)(0))
		Call contrato.ReplaceItemValue("CISS_" & scan, negocio.Getitemvalue("CISS_" & scan)(0))
	Next
	'Configuração
	'contrato.Localidade = negocio.Localidade
	contrato.Complemento = negocio.Complemento
	contrato.Prioridade = negocio.Prioridade
	contrato.Aprovacao = negocio.Aprovacao
	%END REM
	'Campos de Controle das Despesas
	contrato.AreaDespesa = negocio.AreaDespesa(0)
	contrato.ResponsavelDespesa = negocio.ResponsavelDespesa(0)
	contrato.TipoVenda = negocio.TipoVenda(0)
	contrato.ClassificacaoDespesa = "CPS"
	contrato.Areas = negocio.Areas
	contrato.Overhead = negocio.Overhead
	If acao = "Pré-Venda" Then
		contrato.Sit = "Aguardando Planejamento da Pré-Venda"
		contrato.SitNumero = 1
		contrato.ValorEstimado = negocio.ValorEstimado(UBound(negocio.ValorEstimado))
		contrato.ProbFechamento = negocio.ProbFechamento(UBound(negocio.ProbFechamento))
		contrato.DataLimitePV = negocio.DataLimitePV(UBound(negocio.DataLimitePV))
		contrato.RespSolicitacaoPV = negocio.RespSolicitacaoPV(UBound(negocio.RespSolicitacaoPV))
		contrato.SolicitacaoPV = negocio.SolicitacaoPV(UBound(negocio.SolicitacaoPV))
		contrato.Obs = negocio.Obs(UBound(negocio.Obs))
		contrato.CkPreVenda = negocio.CkPreVenda(0)
		contrato.ResponsavelSolicitacaoPV = negocio.TecnicoResponsavel(0)
		Call AvisoSolicita(contrato, "PV")
	ElseIf acao = "POC" Then
		contrato.Sit = "Aguardando Planejamento do POC"
		contrato.SitNumero = 15
		contrato.ValorEstimadoPOC = negocio.ValorEstimadoPOC(UBound(negocio.ValorEstimadoPOC))
		contrato.ProbFechamentoPOC = negocio.ProbFechamentoPOC(UBound(negocio.ProbFechamentoPOC))
		contrato.DataLimitePOC = negocio.DataLimitePOC(UBound(negocio.DataLimitePOC))
		contrato.RespPOC = negocio.RespSolicitacaoPOC(UBound(negocio.RespSolicitacaoPOC))
		contrato.SolicitacaoPOC = negocio.SolicitacaoPOC(UBound(negocio.SolicitacaoPOC))
		contrato.ObsPOC = negocio.ObsPOC(UBound(negocio.ObsPOC))
		contrato.CkConclusaoPOC = negocio.CkConclusaoPOC(0)
		contrato.ResponsavelSolicitacaoPOC = negocio.TecnicoPOC(0)
		Call AvisoSolicita(contrato, "POC")
	ElseIf acao = "Fechamento" Then
		contrato.Sit = "Ativo"
		contrato.SitNumero = 26
		contrato.ValorEstimado = CDbl(negocio.ValorEstimado(0))
		contrato.ProbFechamento = negocio.ProbFechamento(UBound(negocio.ProbFechamento))
		contrato.DataFechamento = negocio.DataFechamento(0)
		contrato.RespFechamento = negocio.RespFechamento(0)
	ElseIf acao = "Desfechamento" Then
		contrato.Sit = "Inativo"
		contrato.SitNumero = 0
	ElseIf negocio.Sit(0) = "Contrato" Then
		contrato.Sit = "Ativo"
		contrato.SitNumero = 0
	Else
		contrato.Sit = "Inativo"
		contrato.SitNumero = 0
	End If
	Call contrato.Save( False, False )
	'Atualiza Status do Contrato no Negócio
	negocio.StatusProjeto = contrato.Sit(0)
	'Cria/Atualiza Planilha Financeira
	Call PlanilhaFinanceira(contrato)
	
End Sub

'++LotusScript Development Environment:2:2:LinkCotacoesPopup:5:8
%REM
	Sub LinkCotacoesPopup
	Description: Comments for Sub
%END REM
Sub LinkCotacoesPopup(negocio As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "compras.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim cont As Integer
	'Dim total As Double
	If negocio.HasItem("DocLinks") Then negocio.RemoveItem("DocLinks")
	Dim rtitem As NotesRichTextItem
	Set rtitem = negocio.CreateRichTextItem("DocLinks")
	'Define o Estilo do Texto
	Dim richStyle As NotesRichTextStyle	
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 8
	'Cotações
	Set view = db.Getview("(Cotacoes/Codigo)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	richStyle.NotesColor = COLOR_BLACK     
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AppendText("Cotações")
	Call rtitem.AddNewLine(1)
	richStyle.NotesColor = COLOR_BLUE     
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para a Cotação de " & doc.TipoCompra(0))
		Call rtitem.AppendText(" Cotação de " & doc.TipoCompra(0) & " - " & doc.Status(0))
		Call rtitem.AppendText(" " & Format(doc.Criacao(0), "dd/mm/yyyy"))
		Call rtitem.Addnewline(1)
		Set doc = dc.GetNextDocument(doc)
	Loop
	'Pedidos de Compra
	Set view = db.Getview("(PedidosCodigo)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	richStyle.NotesColor = COLOR_BLACK     
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine(1)
	Call rtitem.AppendText("Pedidos")
	Call rtitem.AddNewLine(1)
	richStyle.NotesColor = COLOR_BLUE     
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Set doc = dc.GetFirstDocument     
	Do Until doc Is Nothing
		If doc.ClassificacaoDespesa(0) <> "Intermediação de Vendas" Then
			Call rtitem.AppendDocLink(doc, "Link para o Pedido de Compra")
			Call rtitem.AppendText(" " + doc.PO(0))
			Call rtitem.AppendText(" " + doc.Status(0))
			Call rtitem.AppendText(" " & Format(doc.Criacao(0), "dd/mm/yyyy"))
			Call rtitem.Addnewline(1)
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	'POs
	Set db = New NotesDatabase(negocio.ParentDatabase.Server, "importacao.nsf")
	Set view = db.GetView("(PO/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para o Pedido Internacional" )
		Call rtitem.AppendText(" " & doc.PO(0))
		Call rtitem.AppendText(" " & doc.Sit(0))
		Call rtitem.AppendText(" " & Format(doc.Criacao(0), "dd/mm/yyyy"))
		Call rtitem.Addnewline(1)
		Set doc = dc.GetNextDocument(doc)
	Loop
	'POs de Cotação Financeira
	Set db = New NotesDatabase(negocio.ParentDatabase.Server, "importacao.nsf")
	Set view = db.GetView("(PO/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "-", False)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para o Pedido Internacional" )
		Call rtitem.AppendText(" " & doc.PO(0))
		Call rtitem.AppendText(" " & doc.Sit(0))
		Call rtitem.AppendText(" " & Format(doc.Criacao(0), "dd/mm/yyyy"))
		Call rtitem.Addnewline(1)
		Set doc = dc.GetNextDocument(doc)
	Loop
	'Atracagens
	Set view = db.GetView("(Atracagem/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para a Atracagem" )
		Call rtitem.AppendText(" " & UCase(doc.Atracagem(0)))
		Call rtitem.AppendText(" " & doc.Sit(0))
		Call rtitem.AppendText(" " & Format(doc.Criacao(0), "dd/mm/yyyy"))
		Call rtitem.Addnewline(1)
		Set doc = dc.GetNextDocument( doc )
	Loop
	'Atracagens de Cotação Financeira
	Set view = db.GetView("(Atracagem/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "-", False)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para a Atracagem" )
		Call rtitem.AppendText(" " & UCase(doc.Atracagem(0)))
		Call rtitem.AppendText(" " & doc.Sit(0))
		Call rtitem.AppendText(" " & Format(doc.Criacao(0), "dd/mm/yyyy"))
		Call rtitem.Addnewline(1)
		Set doc = dc.GetNextDocument( doc )
	Loop
	'Baixas
	set db = New NotesDatabase(negocio.Parentdatabase.Server, "compras.nsf")
	Set view = db.Getview("(BaixasNegocio)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	%REM
	total =  0
	Do Until doc Is Nothing
		If doc.Classificacao(0) <> "Intermediação de Vendas" Then
			total = total + doc.Valor(0)
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	%END REM
	richStyle.NotesColor = COLOR_BLACK     
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine(1)
	Call rtitem.AppendText("Baixas")
	%REM
	If total > 0 Then
		Call rtitem.AppendText(" R$" & Format(total, "standard"))
	End If
	%END REM
	Call rtitem.AppendText("Baixas")
	Call rtitem.AddNewLine(1)
	richStyle.NotesColor = COLOR_BLUE     
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Set doc = dc.GetFirstDocument     
	Do Until doc Is Nothing
		If doc.Classificacao(0) <> "Intermediação de Vendas" Then
			Call rtitem.AppendDocLink(doc, "Link para a Baixa de Compra")
			Call rtitem.AppendText(" " + doc.TipoBaixa(0))
			Call rtitem.AppendText(" " & Format(doc.Criacao(0), "dd/mm/yyyy"))
			Call rtitem.AppendText(": " + doc.DocID(0))
			Call rtitem.AppendText(" R$" + Format(doc.Valor(0), "standard"))
			Call rtitem.AppendText(" " + doc.Descricao(0))
			Call rtitem.Addnewline(1)
		End If
		Set doc = dc.GetNextDocument(doc)
	Loop
	'Baixas Internacionais
	Set db = New NotesDatabase(negocio.ParentDatabase.Server, "importacao.nsf")
	Set view = db.GetView("(Baixa/Negocio)")
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		Call rtitem.AppendDocLink(doc, "Link para a Baixa Internacional")
		Call rtitem.AppendText(" " + doc.TipoBaixa(0))
		Call rtitem.AppendText(" " & Format(doc.Criacao(0), "dd/mm/yyyy"))
		Call rtitem.AppendText(": " + doc.DocID(0))
		Call rtitem.AppendText(" R$" + Format(doc.Valor(0), "standard"))
		Call rtitem.AppendText(" " + doc.Descricao(0))
		Call rtitem.Addnewline(1)
		Set doc = dc.GetNextDocument(doc)
	Loop
	
End Sub

'++LotusScript Development Environment:2:1:CheckItensLista:1:8
Function CheckItensLista(ui As NotesUIDocument) As Boolean
	
	'Verifica se todos os dados relevantes estão cadastrados na Lista de Materiais e Servicos
	Dim custo As Double, mg As Double, venda As Double, custotvar As Double, ic As Double, icmsst As Double
	Dim protocolo As Variant
	Dim ckFOB As Boolean
	Dim scan As Integer, scan2 As Integer, item As String, contribuinte As String
	checkItensLista = True
	If ui.Document.Form(0) = "Negocio" And UCase(Trim(ui.Document.Pais(0))) = "BRASIL" Then
		'Inscrição Estadual do Cliente - LMO 24/02/15
		If ui.FieldGetText("Contribuinte") = "?" Then
			MsgBox "Você precisa informar a Inscrição Estadual do Cliente " & ui.FieldGetText("CodCliente") & " em Empresas.", 16, "Erro no Cadastro do Cliente"
			CheckItensLista = False
			Exit Function
		End If
		'Cliente Membro do Suframa - LMO 29/11/16
		If ui.FieldGetText("MembroSuframa") = "?" Or (ui.FieldGetText("MembroSuframa") = "Sim" And ui.Fieldgettext("CkImpostosSuframa") = "") Then
			MsgBox "Solicite a nossa Área Contábil/Fiscal a consulta do Suframa e sua atualização em Empresas. Cliente: " & ui.FieldGetText("CodCliente"), 16, "Erro no Cadastro do Cliente"
			CheckItensLista = False
			Exit Function
		End If
		If ui.FieldGetText("Contribuinte") = "Sim" Then contribuinte = "Contribuinte" Else contribuinte = "Não Contribuinte"
	End If
	'Lista de Materiais
	'1.PartNo, Produto, Unidade de Medida, UF de Compra
	For scan = 0 To 49
		If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
			If ui.FieldGetText("PartNo_" & scan) = "" Or ui.FieldGetText("Produto_" & scan) = "" Or ui.FieldGetText("Un_" & scan) = "" Or ui.FieldGetText("UFCompra_" & scan) = "" Then
				CheckItensLista = False
				If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
				scan2 = scan2 + 1
			End If
		End If
	Next
	If Not CheckItensLista Then
		MsgBox "Você precisa informar o PartNo, Produto, Unidade de Medida e UF de Compra na Lista de Materiais no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio.", 16, "Erro de Preenchimento na Lista de Materiais"
		Call ui.GotoField("PartNo_0")
		Exit Function
	End If
	'2.Código da Situação Tributária de Compra (Branco, Tamanho, Origem, Situação Tributária)
	For scan = 0 To 49
		If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
			'Apenas se o Item não foi faturado
			If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
				If ui.FieldGetText("ST_" & scan) = "" Or Len(ui.FieldGetText("ST_" & scan)) <> 3 Or _
				(Left(ui.FieldGetText("ST_" & scan), 1) <> "0" And Left(ui.FieldGetText("ST_" & scan), 1) <> "1" And Left(ui.FieldGetText("ST_" & scan), 1) <> "2" And Left(ui.FieldGetText("ST_" & scan), 1) <> "3" And Left(ui.FieldGetText("ST_" & scan), 1) <> "4" And Left(ui.FieldGetText("ST_" & scan), 1) <> "5" And Left(ui.FieldGetText("ST_" & scan), 1) <> "6" And Left(ui.FieldGetText("ST_" & scan), 1) <> "7" And Left(ui.FieldGetText("ST_" & scan), 1) <> "8") Or _
				(Right(ui.FieldGetText("ST_" & scan), 2) <> "00" And Right(ui.FieldGetText("ST_" & scan), 2) <> "10" And Right(ui.FieldGetText("ST_" & scan), 2) <> "20" And Right(ui.FieldGetText("ST_" & scan), 2) <> "30" And Right(ui.FieldGetText("ST_" & scan), 2) <> "40" And Right(ui.FieldGetText("ST_" & scan), 2) <> "41" And Right(ui.FieldGetText("ST_" & scan), 2) <> "50" And Right(ui.FieldGetText("ST_" & scan), 2) <> "51" And Right(ui.FieldGetText("ST_" & scan), 2) <> "60" And Right(ui.FieldGetText("ST_" & scan), 2) <> "70" And Right(ui.FieldGetText("ST_" & scan), 2) <> "90") Then
					CheckItensLista = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		End If
	Next
	If Not CheckItensLista Then
		MsgBox "Código da Situação Tributária de Compra Inválido no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio." & Chr(10) & "Não pode estar em Branco." & Chr(10) & "Precisa ter 3 caracteres." & Chr(10) & "Primeiro caracter: 0, 1, 2, 3, 4, 5, 6, 7 ou 8." & Chr(10) & "Dois últimos caracteres: 00, 10, 20, 30, 40, 41, 50, 51, 60, 70 ou 90.", 16, "Erro de Preenchimento na Lista de Materiais"
		Call ui.GotoField("ST_0")
		Exit Function
	End If
	'3.Custo/Mg/CustoUnit
	For scan = 0 To 49
		If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
			'Apenas se o Item não foi faturado
			If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
				If ui.FieldGetText("Custo_" & scan) = "" Or ui.FieldGetText("Mg_" & scan) = "" Or ui.FieldGetText("CustoUnit_" & scan) = "" Then
					CheckItensLista = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		End If
	Next
	If Not CheckItensLista Then
		MsgBox "Você precisa completar todos os dados da Lista de Materiais no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio.", 16, "Erro de Preenchimento na Lista de Materiais"
		Call ui.GotoField("Custo_0")
		Exit Function
	End If
	'4.CustoFOB/FI
	For scan = 0 To 49
		If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
			'Apenas se o Item não foi faturado
			If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
				'Preenchimento dos Campos na Importação TDec (FOB e FI)
				If ui.FieldGetText("CustoFOB_" & scan) <> "" And ui.FieldGetText("FI_" & scan) = "" Or ui.FieldGetText("CustoFOB_" & scan) = "" And ui.FieldGetText("FI_" & scan) <> "" Then
					CheckItensLista = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
				If ui.FieldGetText("CustoFOB_" & scan) <> "" And ui.FieldGetText("FI_" & scan) <> "" Then
					ckFOB = True
				End If
			End If
		End If
	Next
	If Not CheckItensLista Then
		MsgBox "Você precisa completar todos os dados da Importação TDec na Lista de Materiais no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio.", 16, "Erro de Preenchimento na Lista de Materiais"
		Call ui.GotoField("CustoFOB_0")
		Exit Function
	End If
	'5.ICMS de Compra, ICMS de Venda, IPI, II (Branco)
	For scan = 0 To 49
		If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
			If ui.FieldGetText("T_" & scan) = "HW" Then
				'Apenas se o Item não foi faturado
				If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
					If ui.FieldGetText("ICC_" & scan) = "" Or ui.FieldGetText("IC_" & scan) = "" Or ui.FieldGetText("IP_" & scan) = "" Or ui.FieldGetText("II_" & scan) = "" Then
						CheckItensLista = False
						If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
						scan2 = scan2 + 1
					End If
				End If
			End If
		End If
	Next
	If Not CheckItensLista Then
		MsgBox "O ICMS de Compra, ICMS de Venda, IPI e II não podem estar em Branco. Solicite a Atualização da Carga Tributária a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista de Materiais"
		Exit Function
	End If
	'6.Importação TDec: ICMS de Compra (ICMS de Venda - Precisa verificar se tem exceções tributárias) (Obrigatório)
	If ui.FieldGetText("TipoCompra") <> "Consumo" And ui.FieldGetText("TipoCompra") <> "Remessa" And ui.FieldGetText("TipoCompra") <> "Ativo" Then
		For scan = 0 To 49
			If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
				If ui.FieldGetText("T_" & scan) = "HW" Then
					'Apenas se o Item não foi faturado
					If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
						If ui.FieldGetText("UFCompra_" & scan) = "EX" Then
							If CDbl(ui.FieldGetText("ICC_" & scan)) = 0 Then
								CheckItensLista = False
								If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
								scan2 = scan2 + 1
							End If
						End If	
					End If
				End If
			End If
		Next
		If Not CheckItensLista Then
			MsgBox "As alíquotas do ICMS de Compra não pode ser zero na Importação TDec(FOB e FI preenchidos). Solicite a Atualização da Carga Tributária a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista de Materiais"
			Exit Function
		End If
	End If
	'7.ICMS de Compra de SP e Venda para Fora de SP (Obrigatório)
	For scan = 0 To 49
		If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
			'Apenas se o Item não foi faturado
			If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
				If ui.FieldGetText("T_" & scan) = "HW" Then
					If ui.FieldGetText("UF") <> "SP"  Then
						If ui.FieldGetText("UFCompra_" & scan) = "SP" Then
							If Right(ui.FieldGetText("ST_" & scan), 2) <> "60" And Right(ui.FieldGetText("ST_" & scan), 2) <> "90" Then
								If CDbl(ui.FieldGetText("ICC_" & scan)) = 0 Then
									CheckItensLista = False
									If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
									scan2 = scan2 + 1
								End If
							End If
						End If
					End If
				End If
			End If
		End If
	Next
	If Not CheckItensLista Then
		MsgBox "A alíquota do ICMS de Compra não pode ser zero. Solicite a Atualização da Carga Tributária a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista de Materiais"
		Exit Function
	End If
	'8. ICMSST de Compra do Fornecedor (Branco ou Zero)
	If ui.Fieldgettext("TipoCompra") <> "Remessa" Then
		For scan = 0 To 49
			If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
				If ui.FieldGetText("T_" & scan) = "HW" Then
					'Apenas se o Item não foi Faturado - LMO 21/10/16
					If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
						If Right(ui.FieldGetText("ST_" & scan), 2) = "10" Then	'Deve vir na Porposta mesmo nas compras de Fora de SP - LMO 24/10/16
							If ui.FieldGetText("ICMSSTC_" & scan) = "" Then icmsst = 0 Else icmsst = CDbl(ui.FieldGetText("ICMSSTC_" & scan))
							If icmsst = 0 Then
								CheckItensLista = False
								If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
								scan2 = scan2 + 1
							End If
						End If
					End If
				End If
			End If
		Next
		If Not CheckItensLista Then
			MsgBox "O ICMS-ST de Compra não pode ser zero no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio.", 16, "Erro de Preenchimento na Lista de Materiais"
			Call ui.GotoField("ICMSSTC_0")
			Exit Function
		End If
	End If
	'9.Protocolo de Compra (Inexistente ou Desatualizado)
	If ui.Fieldgettext("TipoCompra") <> "Remessa" Then
		For scan = 0 To 49
			If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
				If ui.FieldGetText("T_" & scan) = "HW" Then
					'Apenas se o Item não foi comprado - Comentado em 17/02/25 LMO
					'If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
						If ui.FieldGetText("ICC_" & scan) = "?" Then
							CheckItensLista = False
							If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
							scan2 = scan2 + 1
						End If
					'End If
				End If
			End If
		Next
		If Not CheckItensLista Then
			MsgBox "Solicitar a Consulta do Protocolo de Compra Contribuinte a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista de Materiais"
			Exit Function
		End If
	End If
	'10.Protocolo de Venda (Inexistente ou Desatualizado)
	If ui.Fieldgettext("TipoCompra") <> "Remessa" Then
		For scan = 0 To 49
			If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
				If ui.FieldGetText("T_" & scan) = "HW" Then
					'Apenas se o Item não foi faturado - Comentado em 17/02/25 LMO
					'If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
						If ui.FieldGetText("ICD_" & scan) = "?" Or ui.FieldGetText("FCP_" & scan) = "?" Then
							CheckItensLista = False
							If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
							scan2 = scan2 + 1
						End If
					'End If
				End If
			End If
		Next
		If Not CheckItensLista Then
			MsgBox "Solicitar a Consulta do Protocolo de Venda " & ui.FieldGetText("UF") & " " & contribuinte & " a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista de Materiais"
			Exit Function
		End If
	End If
	'11.CNAE (Inexistente ou Desatualizado)
	If ui.Fieldgettext("TipoCompra") <> "Remessa" Then
		For scan = 0 To 49
			If ui.FieldGetText("Produto_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
				If ui.FieldGetText("T_" & scan) = "HW" Then
					'Apenas se o Item não foi faturado
					If CheckDocListas(ui.FieldGetText("Codigo"), CStr(scan + 1), "Venda") Then
						If ui.FieldGetText("ICD_" & scan) = "*" Or ui.FieldGetText("FCP_" & scan) = "*" Then
							CheckItensLista = False
							If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
							scan2 = scan2 + 1
						End If
					End If
				End If
			End If
		Next
		If Not CheckItensLista Then
			MsgBox "Solicitar a Consulta do CNAE Fiscal " & ui.FieldGetText("UF") & " " & contribuinte & " a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista de Materiais"
			Exit Function
		End If
	End If
	%REM - Comentado: Implementado Workflow para Aprovação da Diretoria - LMO 13/12/22
	'12. Mg Inferior a 15% (Não cobre os Impostos)
	If ui.Document.Form(0) = "Negocio" Then
		If ui.Document.Sit(0) = "Forecast" Then
			For scan = 0 To 49
				If ui.FieldGetText("Produto_" & scan) <> "" Or ui.FieldGetText("Mg_" & scan) <> "" Or Val(ui.FieldGetText("Q_" & scan)) > 0 Then
					If CDbl(ui.FieldGetText("Mg_" & scan)) > 0.85 Then
						CheckItensLista = False
						If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
						scan2 = scan2 + 1
					End If
				End If
			Next
			If Not CheckItensLista Then
				MsgBox "A Margem não pode ser maior que 0,85 no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio.", 16, "Erro de Preenchimento na Lista de Materiais"
				Call ui.GotoField("Mg_0")
				Exit Function
			End If
		End If	
	End If
	%END REM
	'Destino da Venda
	If ui.Document.Form(0) = "Negocio" Then
		If ui.FieldGetText("Destino") = "" Then
			MsgBox "Você precisa informar o Destino da Venda", 16, "Erro de Preenchimento na Lista de Materiais"
			Call ui.GotoField("Destino")
			CheckItensLista = False
			Exit Function
		End If
	End If
	'Lista de Serviços
	If ui.FieldGetText("TipoVenda") <> "Venda Simples" And ui.Fieldgettext("Form") <> "Requisicao" Then
		'1.Custos/Mgs/CustoUnits/Produtos
		For scan = 0 To 11
			If ui.FieldGetText("Produtos_" & scan) <> "" Or Val(ui.FieldGetText("Qs_" & scan)) > 0 Then
				If ui.FieldGetText("Custos_" & scan) = "" Or ui.FieldGetText("Mgs_" & (scan)) = "" Or ui.FieldGetText("CustoUnits_" & scan) = "" Or ui.FieldGetText("Produtos_" & scan) = "" Then
					CheckItensLista = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensLista Then
			MsgBox "Você precisa completar todos os dados da Lista de Serviços. Corrija no Negócio." & Chr(10) & "Item(s): " & item & ".", 16, "Erro de Preenchimento na Lista de Serviços"
			Call ui.GotoField("Mgs_0")
			Exit Function
		End If
		'2.IRRF (Branco)
		For scan = 0 To 11
			If ui.FieldGetText("Produtos_" & scan) <> "" Or Val(ui.FieldGetText("Qs_" & scan)) > 0 Then
				If ui.FieldGetText("RIR_" & scan) = "" Then
					CheckItensLista = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensLista Then
			MsgBox "Retenção do IRRF inválida. Solicite atualização da Carga Tributária ao Financeiro." & Chr(10) & "Item(s): " & item & ".", 16, "Erro na Lista de Serviços"
			Exit Function
		End If
		'3.INSS (Branco)
		For scan = 0 To 11
			If ui.FieldGetText("Produtos_" & scan) <> "" Or Val(ui.FieldGetText("Qs_" & scan)) > 0 Then
				If ui.FieldGetText("RIN_" & scan) = "" Then
					CheckItensLista = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensLista Then
			MsgBox "Retenção do INSS inválida. Solicite atualização da Carga Tributária ao Financeiro." & Chr(10) & "Item(s): " & item & ".", 16, "Erro na Lista de Serviços"
			Exit Function
		End If
		'4.ISS (Branco)
		For scan = 0 To 11
			If ui.FieldGetText("Produtos_" & scan) <> "" Or Val(ui.FieldGetText("Qs_" & scan)) > 0 Then
				If ui.FieldGetText("ISS_" & scan) = "" Then
					CheckItensLista = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensLista Then
			MsgBox "Alíquota do ISS inválida. Solicite atualização da Carga Tributária ao Financeiro." & Chr(10) & "Item(s): " & item & ".", 16, "Erro na Lista de Serviços"
			Exit Function
		End If
	End If
	
End Function


'++LotusScript Development Environment:2:1:CalcICMS:1:8
Function CalcICMS(doc As NotesDocument) As Variant
	
	Dim scan As Integer, fatorbase As Integer, answer As Integer, ret As Integer, flagICMS As Boolean
	Dim custot As Double, bcst As Double, icmsst As Double, cusTotST As Double, valorIPI As Double, ic As Double, icd As Double, fcp As Double, ip As Double, ii As Double, tributos As Double, fatorDestino As Double,  fator As Double
	Dim natureza As Variant, codnatureza As Variant, estado As Variant, array As Variant
	Dim icms(12) As Double
	'icms(0) - Base de Cálculo do ICMS
	'icms(1) - Valor do ICMS
	'icms(2) - Valor do IPI
	'icms(3) - Base de Cálculo do ICMS Substituição
	'icms(4) - Valor do ICMS Substituição
	'icms(5) - Valor Aproximado dos Tributos Federais
	'icms(6) - Valor Aproximado dos Tributos Estaduais
	'icms(7) - Valor Aproximado dos Tributos Municipais
	'icms(8) - Valor do ICMS de Partilha no Destino
	'icms(9) - Valor do ICMS de Partilha na Origem
	'icms(10) - Fator de Partilha do ICMS no Destino
	'icms(11) - Fator de Partilha do ICMS na Origem
	'icms(12) - Valor do FCP
	natureza = doc.GetItemValue( "Natureza" )
	codnatureza = doc.GetItemValue( "CodNatureza" )
	estado = doc.GetItemValue( "Estado" )
	fatorbase% = 1 'utilizado para dobrar o valor da base de cálculo de ICMS no caso de software
	flagICMS = True
	'Fator de Partilha do ICMS-ST para Não Contribuinte de Fora de SP
	If doc.CodNatureza(0) = "6.108" Then
		Select Case CStr(Year(doc.DataFaturamento(0)))									'Fator de Partilha do ICMS no Destino
		Case "2016"		:	icms(10) = 0.4												'2016: 40%
		Case "2017"		:	icms(10) = 0.6												'2017: 60%
		Case "2018"		:	icms(10) = 0.8												'2018: 80%
		Case Else																		'2019 em diante: 100%
			icms(10) = 1
	End Select
		icms(11) = 1 - icms(10)															'Fator de Partilha do ICMS na Origem
	End If
	'Doação sempre tem icms - LMO 02/06/10
	ret = InStr(doc.natureza(0), "Doação")
	If ret > 0 Then
		answer% = 6
	'ICMS facultativo: Remessa e Retorno no Estado e Outras Saídas
	ElseIf doc.Natureza(0) = "Devolução de Compra" And doc.TipoNota(0) = "Saída" And doc.Sit(0) <> "Cancelada" Then
		answer% = MessageBox( "Deseja gerar ICMS?", 4+32+256+4096,"Emissão de Nota Fiscal" )
		If answer% <> 6  Then
			flagICMS = False
		End If
	Else
		If (((Left(doc.natureza(0), 7) = "Remessa" Or Left(doc.natureza(0), 7) = "Retorno") And doc.estado(0) = "SP") Or doc.natureza(0) = "Outras Saídas") And doc.Sit(0) <> "Cancelada" Then
			answer% = MessageBox( "Gerar ICMS e IPI na Remessa / Retorno ? (para caso de destaque dos impostos na nota de Remessa)", 4+32+256+4096, _ 
			"Emissão de Nota Fiscal de Remessa" )
			If answer% <> 6  Then
				CalcICMS  =  icms
				Exit Function
			End If
		End If
	End If
	If doc.natureza(0) = "Licenciamento de Uso" Or (doc.Natureza(0) = "Devolução de Compra" And doc.Tipo(0) = "Software" ) Then 
		fatorbase% = 2
	End If
	If doc.TipoCompra(0) <> "Importação" Then
		If flagICMS = True Then
			'Deseja Incluir IPI na BC-ICMS ?
			If doc.Sit(0) = "A Emitir" Or doc.Sit(0) = "Espelho" Then
				'Verifica se tem Alíquota de IPI
				For scan = 0 To 49
					array = doc.GetItemValue("IP_" & scan)
					If IsNumeric(array(0)) Then ip = array(0) Else ip =  0
					If ip > 0 Then
						'Verifica se tem Alíquota de ICMS
						array = doc.GetItemValue("IC_" & scan)
						If IsNumeric(array(0)) Then ic = array(0) Else ic = 0
						If ic > 0 Then
							'1) Se Destino = Branco, pergunta
							'2) Se Destino = Consumidor Final, inclui o IPI na BC-ICMS
							'3) Se Destino = Revenda, não inclui o IPI na BC-ICMS
							If doc.Destino(0) = "" Then
								answer = MessageBox ("Deseja incluir o IPI na Base de Cálculo do ICMS ?", 4+32+256+4096, "Emissão de Nota Fiscal de Remessa" )
								'Inclui IPI na Base de Cálculo do ICMS
								If answer = 6 Then
									doc.FlagBCicms = "OK"
								Else
									doc.FlagBCicms = ""
								End If
							ElseIf doc.Destino(0) = "Consumidor Final" Then
								doc.FlagBCicms = "OK"
							ElseIf doc.Destino(0) = "Revenda" Then
								doc.FlagBCicms = ""
							End If
							Exit For
						End If
					End If
				Next
			End If
		Else
			doc.FlagBCicms = ""
		End If
		'Lista de Materiais
		For scan = 0 To 49
			If doc.CodNatureza(0) = "6.108" Then
				array = doc.GetItemValue("CusTotcomICMSST_" & scan)
			Else
				array = doc.GetItemValue("CusTot_" & scan)
			End If
			If CStr(array(0)) = "" Then cusTot = 0 Else cusTot = array(0)
			array = doc.GetItemValue("BCICMSST_" & scan)
			If CStr(array(0)) = "" Then bcst = 0 Else bcst = array(0)
			array = doc.GetItemValue("ICMSST_" & scan)
			If CStr(array(0)) = "" Then icmsst = 0 Else icmsst = array(0)
			array = doc.GetItemValue("IC_" & scan)
			If CStr(array(0)) = "" Then ic = 0 Else ic = array(0)
			array = doc.GetItemValue("ICST_" & scan)
			If CStr(array(0)) = "" Then icd = 0 Else icd = array(0)
			array = doc.GetItemValue("FCP_" & scan)
			If CStr(array(0)) = "" Then fcp = 0 Else fcp = array(0)
			array = doc.GetItemValue("IP_" & scan)
			If CStr(array(0)) = "" Then ip = 0 Else ip = array(0)
			Call doc.ReplaceItemValue("IPI_" & scan, Round(cusTot * ip, 2))
			icms(2) = icms(2) + Round(cusTot * ip, 2)
			'Tributos Aproximados
			array = doc.GetItemValue("CusTotcomICMSST_" & scan)
			If CStr(array(0)) = "" Then cusTotST = 0 Else cusTotST = array(0)
			array = doc.GetItemValue("IPI_" & scan)
			If CStr(array(0)) = "" Then valorIPI = 0 Else valorIPI = array(0)
			'Tributos Federais
			array = doc.GetItemValue("Tributos_" & scan)
			If CStr(array(0)) = "" Then tributos = 0 Else tributos = array(0)
			icms(5) = icms(5) + Round((cusTotST + valorIPI) * tributos, 2)
			Call doc.ReplaceItemValue("ValorTributos_" & scan, Round((cusTotST + valorIPI) * tributos, 2))
			'Tributos Estaduais
			array = doc.GetItemValue("TributosE_" & scan)
			If CStr(array(0)) = "" Then tributos = 0 Else tributos = array(0)
			icms(6) = icms(6) + Round((cusTotST + valorIPI) * tributos, 2)
			Call doc.ReplaceItemValue("ValorTributosE_" & scan, Round((cusTotST + valorIPI) * tributos, 2))
			'ICMS
			If flagICMS = True Then
				If ic > 0 Then
					'Inclui IPI na Base de Cálculo do ICMS
					If doc.FlagBCicms(0) = "OK" Then
						icms(0) = icms(0) + Round(cusTot * (1 + ip) * fatorbase, 2)								'Base de ICMS com IPI
						icms(1) = icms(1) + Round(cusTot * (1 + ip) * ic * fatorbase, 2)						'Valor ICMS com IPI
					'Não inclui IPI na Base de Cálculo do ICMS
					Else
						icms(0) = icms(0) + Round(cusTot * fatorbase, 2)										'Base de ICMS sem IPI
						icms(1) = icms(1) + Round(cusTot * ic * fatorbase, 2)									'Valor ICMS sem IPI
					End If
					'ICMS-ST
					If doc.CodNatureza(0) <> "6.108" Then
						'Contribuinte ICMS
						icms(3) = icms(3) + Round(bcst, 2)														'Base de ICMS_ST sem IPI
						icms(4) = icms(4) + Round(icmsst, 2)													'Valor ICMS_ST sem IPI
					ElseIf doc.CodNatureza(0) = "6.108" Then
						'Não Contribuinte ICMS - Partilha do ICMS
						Dim valorFCP As Double
						valorFCP = Round(cusTot * (1 + ip) * fcp , 2)
						icms(8) = icms(8) + Round(icmsst * icms(10), 2)											'Total do ICMS de Partilha no Destino com IPI
						icms(9) = icms(9) + Round(icmsst * icms(11), 2)											'Total do ICMS de Partilha na Origem com IPI
						icms(12) = icms(12) + valorFCP															'Total do Fundo de Combate a Pobreza (BC do FCP é o Custo com IPI)
						Call doc.Replaceitemvalue("ICMSPartilha_" & scan, Round(icmsst * icms(10), 2))			'ICMS de Partilha no Destino com IPI por Item
						Call doc.Replaceitemvalue("ICMSPartilhaOrigem_" & scan, Round(icmsst * icms(11), 2))	'ICMS de Partilha na Origem com IPI por Item
						Call doc.Replaceitemvalue("ValorFCP_" & scan, valorFCP)									'Fundo de Combate a Pobreza por Item
					End If
				End If
			End If
		Next
		'Lista de Serviços (Carga Tributária) - LMO 28/05/14
		For scan = 0 To 99
			array = doc.GetItemValue("CusTots_" & scan)
			If CStr(array(0)) = "" Then cusTot = 0 Else cusTot = array(0)
			'Tributos Federais
			array = doc.GetItemValue("TributosS_" & scan)
			If CStr(array(0)) = "" Then tributos = 0 Else tributos = array(0)
			icms(5) = icms(5) + Round((cusTot * tributos), 2)
			'Tributos Estaduais
			array = doc.GetItemValue("TributosSE_" & scan)
			If CStr(array(0)) = "" Then tributos = 0 Else tributos = array(0)
			icms(6) = icms(6) + Round((cusTot * tributos), 2)
			'Tributos Municipais
			array = doc.GetItemValue("TributosSM_" & scan)
			If CStr(array(0)) = "" Then tributos = 0 Else tributos = array(0)
			icms(7) = icms(7) + Round((cusTot * tributos), 2)
		Next
	'*** Importação ***
	Else
		For scan = 0 To 49
			array = doc.GetItemValue("CusTot_" & scan)
			If CStr(array(0)) = "" Then custot = 0 Else custot = array(0)
			array = doc.GetItemValue("IC_" & scan)
			If CStr(array(0)) = "" Then ic = 0 Else ic = array(0)
			array = doc.GetItemValue("IPI_" & scan)
			If CStr(array(0)) = "" Then ip = 0 Else ip = array(0)
			icms(0) = icms(0) + Round((custot + ip), 2) 				'Base de Cálculo do ICMS
			icms(1) = icms(1) + Round((custot + ip) * ic, 2) 			'Valor do ICMS
			icms(2) = icms(2) + Round(ip, 2)							'Valor do IPI
		Next
	End If
	CalcICMS = icms
	
End Function

'++LotusScript Development Environment:2:2:EspelhoServicos:5:8
%REM
	Sub EspelhoServicos
	Description: Comments for Sub
%END REM
Sub EspelhoServicos(uidoc As NotesUIDocument)
	
	Dim session As New NotesSession
	Dim workspace As New NotesUIWorkspace
	Dim pedido As String, st As String, item As String
	Dim fator As Double, fi As Double, ip As Double, total As Double
	Dim scan As Integer, scan2 As Integer, scan3 As Integer
	Dim ck As Long, ckFat As Long, ckVal As Double, ckValFat As Double
	'Popula Lista de Serviços
	Call PopulaListaServicos(uidoc.Document)
	'Verifica Preenchimento da Lista de Materiais e Serviços
	If Not CheckItensLista(uidoc) Then
		Exit Sub
	End If
	'*** Novas Consistências - LMO 17/12/18 ***
	'Consiste Campos do Negócio
	If Not ConsisteCampos(uidoc) Then
		Exit Sub
	End If
	'Consiste Conteúdo do Negócio
	If CDbl(uidoc.FieldGetText("TotalNegocio")) = 0 Then
		MsgBox "Para Fechar a Venda é necessário ter conteúdo na Lista de Materiais e/ou Lista de Serviços", 16, "Erro ao Fechar Venda"	
		Exit Sub
	End If
	'Consiste Projeto/Chamado sem Conteúdo
	If (uidoc.FieldGetText("TipoVenda") = "Projeto" Or uidoc.FieldGetText("TipoVenda") = "Chamado") And CDbl(uidoc.FieldGetText("TotServicos")) = 0 Then
		MsgBox "Para Fechar a Venda de Projeto ou Chamado é necessário ter conteúdo na Lista de Serviços. Solicite a Pré-Venda ou altere o Tipo do Negócio.", 16, "Erro ao Fechar Venda"	
		Exit Sub
	End If
	'Verifica dados da Lista de Materiais e Serviços
	If Not CheckItensLista( uidoc ) Then
		Exit Sub
	End If
	'Verifica dados da Lista CPS no Projeto
	If Not CheckItensListaCPS(uidoc) Then
		Exit Sub
	End If
	'Verifica Planilha Financeira
	If Not CkPlanilha(uidoc) Then
		Exit Sub
	End If
	'Verifica Serviços Internos
	If Not CkServicosInternos(uidoc.Document, "Fechamento") Then
		Exit Sub
	End If
	'****
	'Verifica o Prazo de Pagamento e a Condição de Pagamento
	If uidoc.FieldGetText("PrazoPagamento") = "" Then
		MsgBox "Você precisa cadastrar o Prazo de Pagamento para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "PrazoPagamento" )
		Exit Sub
	ElseIf uidoc.FieldGetText("CondPagto") = "" Then
		MsgBox "Você precisa cadastrar a Condição de Pagamento para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "CondPagto" )
		Exit Sub
	ElseIf uidoc.FieldGetText("TipoPagto") = "" Then
		MsgBox "Você precisa cadastrar o Tipo de Pagamento para este Negócio", 16, "Erro !"
		Call uidoc.GotoField( "TipoPagto" )
		Exit Sub
	End If
	'Condições de Pagamento (D.D.L.: Dias da Data Líquido; D.F.M.: Dias Fora Mês; D.F.Q.: Dias Fora Quinzena; D.F.V.: Dia Fixo de Vencimento)
	Dim dataFaturamento As New NotesDateTime(Today), vencimento As New NotesDateTime(Today)
	If uidoc.FieldGetText("CondPagto") = "D.F.M." Then	'D.F.M. (Dias Fora Mês)
		Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
		Call vencimento.AdjustMonth(1)
		Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0) - 1)
	ElseIf uidoc.FieldGetText("CondPagto") = "D.F.V." Then	'D.F.V. (Dia Fixo de Vencimento)
		Set vencimento = New NotesDateTime(uidoc.FieldGetText("PrazoPagamento") & "/" & Month(Today) & "/" & Year(Today))
	ElseIf uidoc.FieldGetText("CondPagto") = "D.F.Q." Then	'D.F.Q. (Dias Fora Quinzena)
		If Day(dataFaturamento.DateOnly) <= 15 Then
			'1)Faturado até dia 15
			Set vencimento = New NotesDateTime("15/" & Month(Today) & "/" & Year(Today))
			Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
		Else	
			'2)Faturado após dia 15
			Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
			Call vencimento.AdjustMonth(1)
			Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
		End If
	ElseIf uidoc.FieldGetText("CondPagto") = "D.D.L." Then	'D.D.L. (Dias Decorridos Líquido)
		Call vencimento.Adjustday(uidoc.Document.PrazoPagamento(0))
	End If
	'Consistências
	For scan = 0 To 11
		ck = Val( uidoc.FieldGetText( "Qs_" & CStr( scan%) ) )
		If uidoc.FieldGetText( "VlFat_" & CStr( scan%) ) = "" Then ckValFat# = 0 Else ckValFat# = CDbl( uidoc.FieldGetText( "VlFat_" & CStr( scan%) ) )
		If uidoc.FieldGetText( "CusTots_" & CStr( scan%) ) = "" Then ckVal# = 0 Else ckVal# = CDbl( uidoc.FieldGetText( "CusTots_" & CStr( scan%) ) )
		If ck > 0 And ckValFat# > 0 Then
			'Verifica Valor no Negócio e Valor no Faturamento
			If ckValFat# > ckVal# Then
				If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
				scan2 = scan2 + 1
			End If
			scan3 = scan3 + 1
		End If
	Next
	If scan2 > 0 Then
		MsgBox "O Valor de Faturamento não pode ser maior do que o Investimento Total do Negócio no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio.", 16, "Erro !"
		Exit Sub
	End If
	If scan3 = 0 Then
		MsgBox "Você não informou nenhum item da Lista de Serviços para ser Faturado." & Chr(10) & "Informe no campo Saldos a Faturar", 16, "Erro !"
		Exit Sub
	End If
	'Fim das Consistências
	pedido = getPedido(uidoc.FieldGetText("Pedido"))
	Dim nota As NotesUIDocument
	Set nota = workspace.ComposeDocument("", "", "NotaServicos")
	Call nota.FieldSetText("DataFaturamento", dataFaturamento.DateOnly)
	Call nota.FieldSetText("Vencimento", vencimento.DateOnly)
	Call nota.FieldSetText("Codigo", uidoc.FieldGetText("Codigo"))
	Call nota.FieldSetText("GerenteConta", uidoc.FieldGetText("GerenteConta"))
	Call nota.FieldSetText("CodCliente", uidoc.FieldGetText("CodCliente"))
	Call nota.FieldSetText("CodClienteFaturamento", uidoc.FieldGetText("CodCliente"))
	Call nota.FieldSetText("Contribuinte", uidoc.FieldGetText("Contribuinte"))
	Call nota.FieldSetText("CodEmpresa", uidoc.FieldGetText("CodEmpresa"))
	Call nota.FieldSetText("CondPagto", uidoc.FieldGetText("PrazoPagamento") & uidoc.FieldGetText("CondPagto"))
	Call nota.FieldSetText("Pedido", pedido)
	Call nota.FieldSetText("Area", uidoc.FieldGetText("Area"))
	Call nota.FieldSetText("AreaVendas", uidoc.FieldGetText("AreaVendas"))
	Call nota.FieldSetText("UF", uidoc.FieldGetText("UF"))
	Call nota.FieldSetText("Destino",  uidoc.FieldGetText("Destino"))
	Call nota.FieldSetText("TipoComissionamento", uidoc.FieldGetText("TipoComissionamento"))
	Call nota.FieldSetText("Tipo", "Espelho")
	'Busca Cotação da Moeda
	Dim moeda As Variant
	moeda = GetMoedas
	'US$C Venda Fixo - LMO 08/01/18
	If IsNumeric(uidoc.Fieldgettext("USVenda")) Then
		Call nota.FieldSetText("USC", uidoc.Fieldgettext("USVenda"))
	Else
		Call nota.FieldSetText("USC", CStr(moeda(0)))
	End If
	Call nota.FieldSetText("UST", CStr(moeda(1)))
	'
	Dim icAnterior As Double, ipAnterior As Double, issAnterior As Double, iss As Double
	Dim msg As Variant
	For scan = 0 To 11
		ck = Val(uidoc.FieldGetText("Qs_" & scan))
		'ckFat = Val(uidoc.FieldGetText("CusTots_" & scan))
		If CStr(uidoc.FieldGetText("VlFat_" & scan)) <> "" Then ckFat = CDbl(uidoc.FieldGetText("VlFat_" & scan)) Else ckFat = 0
		If ck > 0 And ckFat > 0 Then
			If CStr(uidoc.Fieldgettext("ISS_" & scan)) <> "" Then iss = CDbl(uidoc.Fieldgettext("ISS_" & scan)) Else iss = 0
			'Verifica se as alíquotas de retenção de IR/INSS/ISS são as mesmas
			If scan2 > 0 Then
				If CDbl(uidoc.Fieldgettext("RIR_" & scan)) <> icAnterior Or CDbl(uidoc.Fieldgettext("RIN_" & scan)) <> ipAnterior Or CDbl(iss) <> issAnterior Then
					MsgBox("Você entrou com ítens com retenções de IR/INSS/ISS diferentes para a mesma Nota Fiscal")
					GoTo refresh
				End If
			End If
			Call nota.FieldSetText("Qs_" & scan2, uidoc.Fieldgettext("Qs_" & scan))
			Call nota.FieldSetText("NItem_" & scan2, CStr(scan + 1)) 
			Call nota.FieldSetText("PNs_" & scan2, uidoc.Fieldgettext("PartNos_" & scan))
			Call nota.FieldSetText("Produtos_" & scan2, uidoc.Fieldgettext("Produtos_" & scan))
			'Call nota.FieldSetText("Custo_" & scan2, CStr(CDbl(uidoc.Fieldgettext("CusTots_" & scan)) / ck))
			Call nota.FieldSetText("Custo_" & scan2, CStr(CDbl(uidoc.Fieldgettext("VlFat_" & scan))))
			Call nota.FieldSetText("Us_" & scan2, uidoc.Fieldgettext("uss_" & scan))
			If uidoc.Fieldgettext("uss_" & scan) = "US$C" Then
				fator = moeda(0)
			ElseIf uidoc.Fieldgettext("us_" & scan) = "US$T" Then
				fator = moeda(1)
			Else
				fator = 1
			End If
			'Call nota.FieldSetText("CusTots_" & scan2, CStr(CDbl(uidoc.Fieldgettext("CusTots_" & scan)) / ck * ckFat * fator))
			Call nota.FieldSetText("CusTots_" & scan2, CStr(CDbl(uidoc.Fieldgettext("VlFat_" & scan)) * fator))
			Call nota.FieldSetText("RIR_" & scan2, Format(uidoc.Fieldgettext("RIR_" & scan), "Percent"))
			Call nota.FieldSetText("RIN_" & scan2, Format(uidoc.Fieldgettext("RIN_" & scan), "Percent"))
			Call nota.FieldSetText("ISS_" & scan2, Format(iss, "Percent"))
			'total = total + CDbl(uidoc.Fieldgettext("CusTots_" & scan)) / ck * ckFat * fator
			total = total + CDbl(uidoc.Fieldgettext("VlFat_" & scan)) * fator
			scan2 = scan2 + 1
			icAnterior = CDbl(uidoc.Fieldgettext("RIR_" & scan))
			ipAnterior = CDbl(uidoc.Fieldgettext("RIN_" & scan))
			issAnterior = CDbl(iss)
		End If
	Next
refresh: 'Finalização da Função com classificação da nota em caso de erro
	Call nota.FieldSetText("Total", Format(total, "Standard"))
	Call nota.FieldSetText("Valor", Format(total, "Standard"))
	Call nota.FieldSetText("TipoNF", "Serviços")
	Call nota.Refresh
	
End Sub

'++LotusScript Development Environment:2:2:LinkOrigem:5:8
%REM
	Sub LinkOrigem
	Description: Comments for Sub
%END REM
Sub LinkOrigem(negocio As NotesDocument)
		
	On Error Resume Next
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "cablinglpu.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim rtItem As NotesRichTextItem
	If negocio.HasItem("LinkOrigem") Then negocio.RemoveItem("LinkOrigem")
	Set view = db.Getview("(Chamados/Codigo)")
	Set doc = view.Getdocumentbykey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		Set rtItem = negocio.CreateRichTextItem("LinkOrigem")
		Call rtItem.AppendDocLink(doc,"Link para o Chamado LPU")
	End If
	
End Sub

'++LotusScript Development Environment:2:1:geraCodigoPedidoCompra:1:8
Function geraCodigoPedidoCompra(codigoFornecedor As String)
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "compras.nsf")
	Dim view As NotesView
	Dim  doc As NotesDocument
	Set view = db.getView( "(NacionaisCodigo)" )
	Dim ckCodigo As String, scan As Integer
	ckCodigo$ = codigoFornecedor & "-1"
	Set doc = view.GetDocumentByKey( ckCodigo$ , True)
	scan% = 1
	Do Until doc Is Nothing
		scan% = scan% + 1
		ckCodigo$ = codigoFornecedor  & "-" & CStr(scan%)
		Set doc = view.GetDocumentByKey( ckCodigo$ , True)
	Loop               
	geraCodigoPedidoCompra = ckCodigo$
	
End Function

'++LotusScript Development Environment:2:2:CalcPlanilha:5:8
%REM
	Sub CalcPlanilhaDoc
	Description: Comments for Sub
%END REM
Sub CalcPlanilha(planilha As NotesDocument)
	
	On Error Resume Next
	Call GetValores(planilha)
	Call GetValoresTimeSheet(planilha)
	
	'*** Custos ***
	Dim passP As Double, hospP As Double, transporteP As Double, alugP As Double, matP As Double, ativoP As Double, servP As Double, freteMP As Double
	Dim passRT As Double, hospRT As Double, transporteRT As Double, alugRT As Double, matRT As Double, ativoRT As Double, servRT As Double, freteMRT As Double
	'Passagens
	If CStr(planilha.PassP(0)) <> "" Then passP = Round(planilha.PassP(0), 2)
	If CStr(planilha.PassRT(0)) <> "" Then passRT = Round(planilha.PassRT(0), 2)
	planilha.PassP = passP
	planilha.PassRT = passRT
	planilha.PassL = passP - passRT
	planilha.PassT = planilha.PassL(0) + planilha.PassD(0)
	planilha.PassS = planilha.PassT(0) - planilha.PassU(0)
	planilha.PassPVS = planilha.PassPVT(0) - planilha.PassPVU(0)
	planilha.PassPOCS = planilha.PassPOCT(0) - planilha.PassPOCU(0)
	'Hospedagens
	If CStr(planilha.HospP(0)) <> "" Then hospP = Round(planilha.HospP(0), 2)
	If CStr(planilha.HospRT(0)) <> "" Then hospRT = Round(planilha.HospRT(0), 2)
	planilha.HospP = hospP
	planilha.HospRT = hospRT
	planilha.HospL = hospP - hospRT
	planilha.HospT = planilha.HospL(0) + planilha.HospD(0)
	planilha.HospS = planilha.HospT(0)- planilha.HospU(0)
	planilha.HospPVS = planilha.HospPVT(0)- planilha.HospPVU(0)
	planilha.HospPOCS = planilha.HospPOCT(0)- planilha.HospPOCU(0)
	'Transporte
	If CStr(planilha.TransporteP(0)) <> "" Then transporteP = Round(planilha.TransporteP(0), 2)
	If CStr(planilha.TransporteRT(0)) <> "" Then transporteRT = Round(planilha.TransporteRT(0), 2)
	planilha.TransporteP = transporteP
	planilha.TransporteRT = transporteRT
	planilha.TransporteL = transporteP - transporteRT
	planilha.TransporteT = planilha.TransporteL(0) + planilha.TransporteD(0)
	planilha.TransporteS = planilha.TransporteT(0)- planilha.TransporteU(0)
	planilha.TransportePVS = planilha.TransportePVT(0)- planilha.TransportePVU(0)
	planilha.TransportePOCS = planilha.TransportePOCT(0)- planilha.TransportePOCU(0)
	'Aluguéis
	If CStr(planilha.AlugP(0)) <> "" Then alugP = Round(planilha.AlugP(0), 2)
	If CStr(planilha.AlugRT(0)) <> "" Then alugRT = Round(planilha.AlugRT(0), 2)
	planilha.AlugP = alugP
	planilha.AlugRT = alugRT
	planilha.AlugL = alugP - alugRT
	planilha.AlugT = planilha.AlugL(0) + planilha.AlugD(0)
	planilha.AlugS = planilha.AlugT(0) - planilha.AlugU(0)
	planilha.AlugPVS = planilha.AlugPVT(0) - planilha.AlugPVU(0)
	planilha.AlugPOCS = planilha.AlugPOCT(0) - planilha.AlugPOCU(0)
	'Compras para Prestação de Serviços
	If CStr(planilha.MatP(0)) <> "" Then matP = Round(planilha.MatP(0), 2)
	If CStr(planilha.MatRT(0)) <> "" Then matRT = Round(planilha.MatRT(0), 2)
	planilha.MatP = matP
	planilha.MatRT = matRT
	planilha.MatL = matP - matRT
	planilha.MatT = planilha.MatL(0) + planilha.MatD(0)
	planilha.MatS = planilha.MatT(0) - planilha.MatU(0)
	planilha.MatPVS = planilha.MatPVT(0) - planilha.MatPVU(0)
	planilha.MatPOCS = planilha.MatPOCT(0) - planilha.MatPOCU(0)
	'Ativo para Prestação de Serviços
	If CStr(planilha.AtivoP(0)) <> "" Then ativoP = Round(planilha.AtivoP(0), 2)
	If CStr(planilha.AtivoRT(0)) <> "" Then ativoRT = Round(planilha.AtivoRT(0), 2)
	planilha.AtivoP = ativoP
	planilha.AtivoRT = ativoRT
	planilha.AtivoL = ativoP - ativoRT
	planilha.AtivoT = planilha.AtivoL(0) + planilha.AtivoD(0)
	planilha.AtivoS = planilha.AtivoT(0) - planilha.AtivoU(0)
	planilha.AtivoPVS = planilha.AtivoPVT(0) - planilha.AtivoPVU(0)
	planilha.AtivoPOCS = planilha.AtivoPOCT(0) - planilha.AtivoPOCU(0)
	'Contratação de Terceiros não Faturáveis
	If CStr(planilha.ServP(0)) <> "" Then servP = Round(planilha.ServP(0), 2)
	If CStr(planilha.ServRT(0)) <> "" Then servRT = Round(planilha.ServRT(0), 2)
	planilha.ServP = servP
	planilha.ServRT = servRT
	planilha.ServL = servP - servRT
	planilha.ServT = planilha.ServL(0) + planilha.ServD(0)
	planilha.ServS = planilha.ServT(0) - planilha.ServU(0)
	planilha.ServPVS = planilha.ServPVT(0) - planilha.ServPVU(0)
	planilha.ServPOCS = planilha.ServPOCT(0) - planilha.ServPOCU(0)
	'Frete de Mercadorias
	If CStr(planilha.FreteMP(0)) <> "" Then freteMP = Round(planilha.FreteMP(0), 2)
	If CStr(planilha.FreteMRT(0)) <> "" Then freteMRT = Round(planilha.FreteMRT(0), 2)
	planilha.FreteMP = freteMP
	planilha.FreteMRT = freteMRT
	planilha.FreteML = freteMP - freteMRT
	planilha.FreteMT = planilha.FreteML(0) + planilha.FreteMD(0)
	planilha.FreteMS = planilha.FreteMT(0)- planilha.FreteMU(0)
	planilha.FreteMPVS = planilha.FreteMPVT(0)- planilha.FreteMPVU(0)
	planilha.FreteMPOCS = planilha.FreteMPOCT(0)- planilha.FreteMPOCU(0)
	'Totais Execução
	planilha.CustoP = passP + hospP + transporteP + alugP + matP + ativoP + servP + freteMP
	planilha.CustoRT = passRT + hospRT + transporteRT + alugRT + matRT + ativoRT + servRT + freteMRT
	planilha.CustoL = planilha.PassL(0) + planilha.HospL(0) + planilha.TransporteL(0) + planilha.AlugL(0) + planilha.MatL(0) + planilha.AtivoL(0) + planilha.ServL(0) + planilha.FreteML(0)
	planilha.CustoD = planilha.PassD(0) + planilha.HospD(0) + planilha.TransporteD(0) + planilha.AlugD(0) + planilha.MatD(0) + planilha.AtivoD(0) + planilha.ServD(0) + planilha.FreteMD(0)
	planilha.CustoT = planilha.PassT(0) + planilha.HospT(0) + planilha.TransporteT(0) + planilha.AlugT(0) + planilha.MatT(0) + planilha.AtivoT(0) + planilha.ServT(0) + planilha.FreteMT(0)
	planilha.CustoU = planilha.PassU(0) + planilha.HospU(0) + planilha.TransporteU(0) + planilha.AlugU(0) + planilha.MatU(0) + planilha.AtivoU(0) + planilha.ServU(0) + planilha.FreteMU(0)
	planilha.CustoS = planilha.PassS(0) + planilha.HospS(0) + planilha.TransporteS(0) + planilha.AlugS(0) + planilha.MatS(0) + planilha.AtivoS(0) + planilha.ServS(0) + planilha.FreteMS(0)
	'Totais Pré-Venda
	planilha.CustoPVT = planilha.PassPVT(0) + planilha.HospPVT(0) + planilha.TransportePVT(0) + planilha.AlugPVT(0) + planilha.MatPVT(0) + planilha.AtivoPVT(0) + planilha.ServPVT(0) + planilha.FreteMPVT(0)
	planilha.CustoPVU = planilha.PassPVU(0) + planilha.HospPVU(0) + planilha.TransportePVU(0) + planilha.AlugPVU(0) + planilha.MatPVU(0) + planilha.AtivoPVU(0) + planilha.ServPVU(0) + planilha.FreteMPVU(0)
	planilha.CustoPVS = planilha.PassPVS(0) + planilha.HospPVS(0) + planilha.TransportePVS(0) + planilha.AlugPVS(0) + planilha.MatPVS(0) + planilha.AtivoPVS(0) + planilha.ServPVS(0) + planilha.FreteMPVS(0)
	'Totais POC
	planilha.CustoPOCT = planilha.PassPOCT(0) + planilha.HospPOCT(0) + planilha.TransportePOCT(0) + planilha.AlugPOCT(0) + planilha.MatPOCT(0) + planilha.AtivoPOCT(0) + planilha.ServPOCT(0) + planilha.FreteMPOCT(0)
	planilha.CustoPOCU = planilha.PassPOCU(0) + planilha.HospPOCU(0) + planilha.TransportePOCU(0) + planilha.AlugPOCU(0) + planilha.MatPOCU(0) + planilha.AtivoPOCU(0) + planilha.ServPOCU(0) + planilha.FreteMPOCU(0)
	planilha.CustoPOCS = planilha.PassPOCS(0) + planilha.HospPOCS(0) + planilha.TransportePOCS(0) + planilha.AlugPOCS(0) + planilha.MatPOCS(0) + planilha.AtivoPOCS(0) + planilha.ServPOCS(0) + planilha.FreteMPOCS(0)
	'*** Despesas ***
	Dim kmP As Double, transP As Double, alimP As Double, teleP As Double
	Dim kmRT As Double, transRT As Double, alimRT As Double, teleRT As Double
	'Quilometragem
	If CStr(planilha.KmP(0)) <> "" Then kmP = Round(planilha.KmP(0), 2)
	If CStr(planilha.KmRT(0)) <> "" Then kmRT = Round(planilha.KmRT(0), 2)
	planilha.KmP = kmP
	planilha.KmRT = kmRT
	planilha.KmL = kmP - kmRT
	planilha.KmT = planilha.KmL(0) + planilha.KmD(0)
	planilha.KmS = planilha.KmT(0) - planilha.KmU(0)
	planilha.KmPVS = planilha.KmPVT(0) - planilha.KmPVU(0)
	planilha.KmPOCS = planilha.KmPOCT(0) - planilha.KmPOCU(0)
	'Transporte
	If CStr(planilha.TranspP(0)) <> "" Then transP = Round(planilha.TranspP(0), 2)
	If CStr(planilha.TranspRT(0)) <> "" Then transRT = Round(planilha.TranspRT(0), 2)
	planilha.TranspP = transP
	planilha.TranspRT = transRT
	planilha.TranspL = transP - transRT
	planilha.TranspT = planilha.TranspL(0) + planilha.TranspD(0)
	planilha.TranspS = planilha.TranspT(0) - planilha.TranspU(0)
	planilha.TranspPVS = planilha.TranspPVT(0) - planilha.TranspPVU(0)
	planilha.TranspPOCS = planilha.TranspPOCT(0) - planilha.TranspPOCU(0)
	'Alimentação
	If CStr(planilha.AlimeP(0)) <> "" Then alimP = Round(planilha.AlimeP(0), 2)
	If CStr(planilha.AlimeRT(0)) <> "" Then alimRT = Round(planilha.AlimeRT(0), 2)
	planilha.AlimeP = alimP
	planilha.AlimeRT = alimRT
	planilha.AlimeL = alimP - alimRT
	planilha.AlimeT = planilha.AlimeL(0) + planilha.AlimeD(0)
	planilha.AlimeS = planilha.AlimeT(0) - planilha.AlimeU(0)
	planilha.AlimePVS = planilha.AlimePVT(0) - planilha.AlimePVU(0)
	planilha.AlimePOCS = planilha.AlimePOCT(0) - planilha.AlimePOCU(0)
	'Telecom
	If CStr(planilha.TeleP(0)) <> "" Then teleP = Round(planilha.TeleP(0), 2)
	If CStr(planilha.TeleRT(0)) <> "" Then teleRT = Round(planilha.TeleRT(0), 2)
	planilha.TeleP = teleP
	planilha.TeleRT = teleRT
	planilha.TeleL = teleP - teleRT
	planilha.TeleT = planilha.TeleL(0) + planilha.TeleD(0)
	planilha.TeleS = planilha.TeleT(0) - planilha.TeleU(0)
	planilha.TelePVS = planilha.TelePVT(0) - planilha.TelePVU(0)
	planilha.TelePOCS = planilha.TelePOCT(0) - planilha.TelePOCU(0)
	'Totais
	planilha.DespP = kmP + transP + alimP + teleP
	planilha.DespRT = kmRT + transRT + alimRT + teleRT
	planilha.DespL = planilha.KmL(0) + planilha.TranspL(0) + planilha.AlimeL(0) + planilha.TeleL(0)
	planilha.DespD = planilha.KmD(0) + planilha.TranspD(0) + planilha.AlimeD(0) + planilha.TeleD(0)
	planilha.DespT = planilha.KmT(0) + planilha.TranspT(0) + planilha.AlimeT(0) + planilha.TeleT(0)
	planilha.DespU = planilha.KmU(0) + planilha.TranspU(0) + planilha.AlimeU(0) + planilha.TeleU(0)
	planilha.DespS = planilha.KmS(0) + planilha.TranspS(0) + planilha.AlimeS(0) + planilha.TeleS(0)
	'Totais Pré-Venda
	planilha.DespPVT = planilha.KmPVT(0) + planilha.TranspPVT(0) + planilha.AlimePVT(0) + planilha.TelePVT(0)
	planilha.DespPVU = planilha.KmPVU(0) + planilha.TranspPVU(0) + planilha.AlimePVU(0) + planilha.TelePVU(0)
	planilha.DespPVS = planilha.KmPVS(0) + planilha.TranspPVS(0) + planilha.AlimePVS(0) + planilha.TelePVS(0)
	'Totais Pré-Venda/POC
	planilha.DespPOCT = planilha.KmPOCT(0) + planilha.TranspPOCT(0) + planilha.AlimePOCT(0) + planilha.TelePOCT(0)
	planilha.DespPOCU = planilha.KmPOCU(0) + planilha.TranspPOCU(0) + planilha.AlimePOCU(0) + planilha.TelePOCU(0)
	planilha.DespPOCS = planilha.KmPOCS(0) + planilha.TranspPOCS(0) + planilha.AlimePOCS(0) + planilha.TelePOCS(0)
	'*** Horas ***
	Dim planP As Double, gerP As Double, execP As Double, deslocamentoP As Double, docP As Double
	Dim planRT As Double, gerRT As Double, execRT As Double, deslocamentoRT As Double, docRT As Double
	'Horas de Planejamento
	If CStr(planilha.PlanP(0)) <> "" Then planP = Round(planilha.PlanP(0), 2)
	If CStr(planilha.PlanRT(0)) <> "" Then planRT = Round(planilha.PlanRT(0), 2)
	planilha.PlanP = planP
	planilha.PlanRT = planRT
	planilha.PlanL = planP - planRT
	planilha.PlanT = planilha.PlanL(0) + planilha.PlanD(0)
	planilha.PlanS = planilha.PlanT(0) - planilha.PlanU(0)
	planilha.PlanPVS = planilha.PlanPVT(0) - planilha.PlanPVU(0)
	planilha.PlanPOCS = planilha.PlanPOCT(0) - planilha.PlanPOCU(0)
	'Horas de Gerenciamento
	If CStr(planilha.GerP(0)) <> "" Then gerP = Round(planilha.GerP(0), 2)
	If CStr(planilha.GerRT(0)) <> "" Then gerRT = Round(planilha.GerRT(0), 2)
	planilha.GerP = gerP
	planilha.GerRT = gerRT
	planilha.GerL = gerP - gerRT
	planilha.GerT = planilha.GerL(0) + planilha.GerD(0)
	planilha.GerS = planilha.GerT(0) - planilha.GerU(0)
	planilha.GerPVS = planilha.GerPVT(0) - planilha.GerPVU(0)
	planilha.GerPOCS = planilha.GerPOCT(0) - planilha.GerPOCU(0)
	'Horas de Execução
	If CStr(planilha.ExecP(0)) <> "" Then execP = Round(planilha.ExecP(0), 2)
	If CStr(planilha.ExecRT(0)) <> "" Then execRT = Round(planilha.ExecRT(0), 2)
	planilha.ExecP = execP
	planilha.ExecRT = execRT
	planilha.ExecL = execP - execRT
	planilha.ExecT = planilha.ExecL(0) + planilha.ExecD(0)
	planilha.ExecS = planilha.ExecT(0) - planilha.ExecU(0)
	planilha.ExecPVS = planilha.ExecPVT(0) - planilha.ExecPVU(0)
	planilha.ExecPOCS = planilha.ExecPOCT(0) - planilha.ExecPOCU(0)
	'Horas de Deslocamento
	If CStr(planilha.DeslocamentoP(0)) <> "" Then deslocamentoP = Round(planilha.DeslocamentoP(0), 2)
	If CStr(planilha.DeslocamentoRT(0)) <> "" Then deslocamentoRT = Round(planilha.DeslocamentoRT(0), 2)
	planilha.DeslocamentoP = deslocamentoP
	planilha.DeslocamentoRT = deslocamentoRT
	planilha.DeslocamentoL = deslocamentoP - deslocamentoRT
	planilha.DeslocamentoT = planilha.DeslocamentoL(0) + planilha.DeslocamentoD(0)
	planilha.DeslocamentoS = planilha.DeslocamentoT(0) - planilha.DeslocamentoU(0)
	planilha.DeslocamentoPVS = planilha.DeslocamentoPVT(0) - planilha.DeslocamentoPVU(0)
	planilha.DeslocamentoPOCS = planilha.DeslocamentoPOCT(0) - planilha.DeslocamentoPOCU(0)
	'Horas de Documentação
	If CStr(planilha.DocP(0)) <> "" Then docP = Round(planilha.DocP(0), 2)
	If CStr(planilha.DocRT(0)) <> "" Then docRT = Round(planilha.DocRT(0), 2)
	planilha.DocP = docP
	planilha.DocRT = docRT
	planilha.DocL = docP - docRT
	planilha.DocT = planilha.DocL(0) + planilha.DocD(0)
	planilha.DocS = planilha.DocT(0) - planilha.DocU(0)
	planilha.DocPVS = planilha.DocPVT(0) - planilha.DocPVU(0)
	planilha.DocPOCS = planilha.DocPOCT(0) - planilha.DocPOCU(0)
	'Totais Execução
	planilha.HHP = planP + gerP + execP + deslocamentoP + docP
	planilha.HHRT = planRT + gerRT + execRT + deslocamentoRT + docRT
	planilha.HHL = planilha.PlanL(0) + planilha.GerL(0) + planilha.ExecL(0) + planilha.DeslocamentoL(0) + planilha.DocL(0)
	planilha.HHD = planilha.PlanD(0) + planilha.GerD(0) + planilha.ExecD(0) + planilha.DeslocamentoD(0) + planilha.DocD(0)
	planilha.HHT = planilha.PlanT(0) + planilha.GerT(0) + planilha.ExecT(0) + planilha.DeslocamentoT(0) + planilha.DocT(0)
	planilha.HHU = planilha.PlanU(0) + planilha.GerU(0) + planilha.ExecU(0) + planilha.DeslocamentoU(0) + planilha.DocU(0)
	planilha.HHS = planilha.PlanS(0) + planilha.GerS(0) + planilha.ExecS(0) + planilha.DeslocamentoS(0) + planilha.DocS(0)
	'Totais Pré-Venda
	planilha.HPVT = planilha.PlanPVT(0) + planilha.GerPVT(0) + planilha.ExecPVT(0) + planilha.DeslocamentoPVT(0) + planilha.DocPVT(0)
	planilha.HPVU = planilha.PlanPVU(0) + planilha.GerPVU(0) + planilha.ExecPVU(0) + planilha.DeslocamentoPVU(0) + planilha.DocPVU(0)
	planilha.HPVS = planilha.PlanPVS(0) + planilha.GerPVS(0) + planilha.ExecPVS(0) + planilha.DeslocamentoPVS(0) + planilha.DocPVS(0)
	'Totais POC
	planilha.HPOCT = planilha.PlanPOCT(0) + planilha.GerPOCT(0) + planilha.ExecPOCT(0) + planilha.DeslocamentoPOCT(0) + planilha.DocPOCT(0)
	planilha.HPOCU = planilha.PlanPOCU(0) + planilha.GerPOCU(0) + planilha.ExecPOCU(0) + planilha.DeslocamentoPOCU(0) + planilha.DocPOCU(0)
	planilha.HPOCS = planilha.PlanPOCS(0) + planilha.GerPOCS(0) + planilha.ExecPOCS(0) + planilha.DeslocamentoPOCS(0) + planilha.DocPOCS(0)
	
	'*** Terceiros ***
	Dim terceirosP As Double, terceirosRT As Double
	If CStr(planilha.TerceirosP(0)) <> "" Then terceirosP = Round(planilha.TerceirosP(0), 2)
	If CStr(planilha.TerceirosRT(0)) <> "" Then terceirosRT = Round(planilha.TerceirosRT(0), 2)
	planilha.TerceirosP = terceirosP
	planilha.TerceirosRT = terceirosRT
	planilha.TerceirosL = terceirosP - terceirosRT
	planilha.TerceirosT = planilha.TerceirosL(0) + planilha.TerceirosD(0)
	planilha.TerceirosS = planilha.TerceirosT(0) - planilha.TerceirosU(0)
		
	'*** Despesas de Vendas ***
	'Frete
	Dim freteP As Double, freteRT As Double
	If CStr(planilha.FreteP(0)) <> "" Then freteP = Round(planilha.FreteP(0), 2)
	If CStr(planilha.FreteRT(0)) <> "" Then freteRT = Round(planilha.FreteRT(0), 2)
	planilha.FreteP = freteP
	planilha.FreteRT = freteRT
	planilha.FreteL = freteP - freteRT
	planilha.FreteT = planilha.FreteL(0) + planilha.FreteD(0)
	planilha.FreteS = planilha.FreteT(0) - planilha.FreteU(0)
	'Intermediação de Vendas
	Dim intermediacaoP As Double, intermediacaoRT As Double
	If CStr(planilha.IntermediacaoP(0)) <> "" Then intermediacaoP = Round(planilha.IntermediacaoP(0), 2)
	If CStr(planilha.IntermediacaoRT(0)) <> "" Then intermediacaoRT = Round(planilha.IntermediacaoRT(0), 2)
	planilha.IntermediacaoP = IntermediacaoP
	planilha.IntermediacaoRT = intermediacaoRT
	planilha.IntermediacaoL = intermediacaoP - intermediacaoRT
	planilha.IntermediacaoT = planilha.IntermediacaoL(0) + planilha.IntermediacaoD(0)
	planilha.IntermediacaoS = planilha.IntermediacaoT(0) - planilha.IntermediacaoU(0)
	'Totais
	planilha.VendasP = freteP + intermediacaoP
	planilha.VendasRT = freteRT + intermediacaoRT
	planilha.VendasL = planilha.FreteL(0) + planilha.IntermediacaoL(0)
	planilha.VendasD = planilha.FreteD(0) + 0 + planilha.IntermediacaoD(0)
	planilha.VendasT = planilha.FreteT(0) + planilha.IntermediacaoT(0)
	planilha.VendasU = planilha.FreteU(0) + 0 + planilha.IntermediacaoU(0)
	planilha.VendasS = planilha.FreteS(0) + planilha.IntermediacaoS(0)
	
	'*** Totais Gerais
	'Custos/Despesas
	planilha.CustoDespPT = planilha.CustoP(0) + planilha.DespP(0)
	planilha.CustoDespLT = planilha.CustoL(0) + planilha.DespL(0)
	planilha.CustoDespPVT = planilha.CustoPVT(0) + planilha.DespPVT(0)
	planilha.CustoDespPOCT = planilha.CustoPOCT(0) + planilha.DespPOCT(0)
	planilha.CustoDespDT = planilha.CustoD(0) + planilha.DespD(0)
	planilha.CustoDespUT = planilha.CustoU(0) + planilha.DespU(0)
	planilha.CustoDespST = planilha.CustoS(0) + planilha.DespS(0)
	'Horas
	planilha.HHPT = planilha.HHP(0)
	planilha.HHLT = planilha.HHL(0)
	planilha.HHPVT = planilha.HPVT(0)
	planilha.HHPOCT = planilha.HPOCT(0)
	planilha.HHDT = planilha.HHD(0)
	planilha.HHUT = planilha.HHU(0)
	planilha.HHST = planilha.HHS(0)
	'Vendas
	planilha.VendasPT = planilha.VendasP(0)
	planilha.VendasLT = planilha.VendasL(0)
	planilha.VendasDT = planilha.VendasD(0)
	planilha.VendasUT = planilha.VendasU(0)
	planilha.VendasST = planilha.VendasS(0)
	
End Sub

'++LotusScript Development Environment:2:2:MgReal:5:8
%REM
	Sub MgReal
	Description: Comments for Sub
%END REM
Sub MgReal(doc As NotesDocument)
	
	On Error Resume Next
	Dim vendaM As Double, vendaS As Double, venda As Double, custo As Double, custoImp As Double, cambio As Double, icmsD As Double, icmsC As Double, fcp As Double, icmsst As Double, ipi As Double, ipiD As Double, ipiC As Double, iss As Double, inss As Double, pis As Double, cofins As Double, csll As Double, irpj As Double, cpr As Double, atividades As Double, juros As Double, comissaoPaga As Double, comissaoPagaM As Double, comissaoPagaS As Double, participacaoPaga As Double, encargoPago As Double, comissao As Double, frete As Double, impostoC As Double, imposto As Double, intermediacao As Double, projeto As Double, cps As Double, terceiros As Double, valorIntermediacao As Double
	Dim issM As Double, issS As Double, inssM As Double, inssS As Double, pisM As Double, pisS As Double, cofinsM As Double, cofinsS As Double, cprM As Double, cprS As Double
	Dim irrf As Double, inssrf As Double, impostosFederais As Double, issrf As Double
	ReDim Preserve nome(0) As String, valoresIntermediacao(0) As Double
	Dim pf As Variant
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection, col As NotesDocumentCollection
	Dim documento As NotesDocument, espelho As NotesDocument
	Dim x As Integer, y As Integer, z As Integer, scan As Integer, indice As Variant, tipo As Variant
	'Espelho
	Set db = New NotesDatabase(doc.Parentdatabase.Server, "faturas.nsf")
	Set view = db.Getview("(EspelhosNegocio)")
	Set dc = view.Getalldocumentsbykey(doc.Codigo(0), True)
	Set espelho = dc.Getfirstdocument()
	Do Until espelho Is Nothing
		If espelho.Sit(0) = "OK" Or espelho.Sit(0) = "Emitido por Extrato" Then
			'Receber (Nota de Débito) - LMO 06/03/25
			If espelho.Form(0) = "Recibo" And espelho.Natureza(0) = "Nota de Débito" Then
				Set col = espelho.Responses
				Set documento = col.Getfirstdocument()
				Do Until documento Is Nothing
					If InStr(espelho.TipoAvancado(0), "Venda") > 0 Then
						vendaM = vendaM + documento.TotTot(0)
					Else
						vendaS = vendaS + documento.TotTot(0)
					End If
					venda = venda + documento.TotTot(0)
					Set documento = col.Getnextdocument(documento)
				Loop
			'Espelho
			Else
				If InStr(espelho.TipoAvancado(0), "Venda") > 0 Then
					vendaM = vendaM + espelho.TotTotComIPI(0)
				Else
					vendaS = vendaS + espelho.TotTotComIPI(0)
				End If
				venda = venda + espelho.TotTotComIPI(0)
			End If
		End If
		Set espelho = dc.Getnextdocument(espelho)
	Loop
	'Despesas
	Set db = New NotesDatabase(doc.ParentDatabase.server, "caixa.nsf")
	Set view = db.GetView("(DespesasNegocio)")
	Set dc = view.GetAllDocumentsByKey(doc.Codigo(0), True)
	Set documento = dc.Getfirstdocument()
	Dim dbFat As New NotesDatabase(doc.ParentDatabase.server, "faturas.nsf")
	Do Until documento Is Nothing
		If documento.ClassificacaoDespesa(0) = "Frete de Revenda" Then
			frete = frete + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "CSV" Then
			terceiros = terceiros + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - ICMS OUTROS ESTADOS" And documento.TipoCompra(0) <> "Projeto" Then
			If InStr(documento.Origem(0), "Pedido ") > 0 then
				impostoC = impostoC + documento.TotTot(0)
			Else
				imposto = imposto + documento.TotTot(0)
			End If
		ElseIf documento.ClassificacaoDespesa(0) = "CMV" Or documento.ClassificacaoDespesa(0) = "Estoque" Or documento.ClassificacaoDespesa(0) = "Ativo" Then
			custo = custo + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "Importação" Then
			custoImp = custoImp + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "Variação Cambial" Then
			cambio = cambio + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - ICMS" Then
			If documento.TotTot(0) > 0 Then
				icmsD = icmsD + documento.TotTot(0)
			Else
				icmsC = icmsC + documento.TotTot(0)
			End If
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - ICMS FUNDO COMBATE POBREZA" Then
			fcp = fcp + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - IPI" Then
			If documento.TotTot(0) > 0 Then
				ipiD = ipiD + documento.TotTot(0)
			Else
				ipiC = ipiC + documento.TotTot(0)
			End If
			ipi = ipi + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - ISS" Then
			iss = iss + documento.TotTot(0)
			If InStr(documento.TipoAvancado(0), "Serviços") > 0 Then
				issS = issS + documento.TotTot(0)
			Else
				issM = issM + documento.TotTot(0)
			End If
		ElseIf documento.ClassificacaoDespesa(0) = "Encargos - INSS" Then
			inss = inss + documento.TotTot(0)
			If InStr(documento.TipoAvancado(0), "Serviços") > 0 Then
				inssS = inssS + documento.TotTot(0)
			Else
				inssM = inssM + documento.TotTot(0)
			End If
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - PIS" Then
			pis = pis + documento.TotTot(0)
			If InStr(documento.TipoAvancado(0), "Serviços") > 0 Then
				pisS = pisS + documento.TotTot(0)
			Else
				pisM = pisM + documento.TotTot(0)
			End If
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - FINSOCIAL" Then
			cofins = cofins + documento.TotTot(0)
			If InStr(documento.TipoAvancado(0), "Serviços") > 0 Then
				cofinsS = cofinsS + documento.TotTot(0)
			Else
				cofinsM = cofinsM + documento.TotTot(0)
			End If
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - CONTR SOCIAL" Then
			csll = csll + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - IR" Then
			irpj = irpj + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "Imposto - CONTR PREV RECEITA" Then
			cpr = cpr + documento.TotTot(0)
			If InStr(documento.TipoAvancado(0), "Serviços") > 0 Then
				cprS = cprS + documento.TotTot(0)
			Else
				cprM = cprM + documento.TotTot(0)
			End If
		ElseIf documento.ClassificacaoDespesa(0) = "Comissoes" Then
			'Visitas
			If (documento.TipoCusto(0) = "Custo Variavel" And InStr(documento.Origem(0), "Visita") > 0) Or (documento.TipoCusto(0) = "Despesa Operacional" And InStr(documento.Origem(0), "Atividade de Vendas") > 0) Then
				atividades = atividades + documento.TotTot(0)
			'Comissão Paga
			Else
				comissaoPaga = comissaoPaga + documento.TotTot(0)
				If InStr(documento.TipoAvancado(0), "Serviços") > 0 Then
					comissaoPagaS = comissaoPagaS + documento.TotTot(0)
				Else
					comissaoPagaM = comissaoPagaM + documento.TotTot(0)
				End If
			End If
			'Atualiza Status do Negócio na Despesa
			Call documento.Computewithform(False, False)
			Call documento.Save(False, False)
			'Comissão Paga por Nome
			If x = 0 Then
				ReDim Preserve nome(x) As String, valorPago(x) As Double
				nome(x) = documento.ResponsavelDespesa(0)
				valorPago(x) = documento.TotTot(0)
				x = x + 1
			Else
				indice = ArrayGetIndex(nome, documento.ResponsavelDespesa(0))
				If IsNull(indice) Then
					ReDim Preserve nome(x) As String, valorPago(x) As Double
					nome(x) = documento.ResponsavelDespesa(0)
					valorPago(x) = documento.TotTot(0)
					x = x + 1
				Else
					valorPago(indice) = valorPago(indice) + documento.TotTot(0)
				End If
			End If
		ElseIf documento.ClassificacaoDespesa(0) = "Encargos - FGTS - Comissões" Or documento.ClassificacaoDespesa(0) = "Encargos - INSS - Comissões" Or documento.ClassificacaoDespesa(0) = "Salarios - Comissões" Then
			encargoPago = encargoPago + documento.TotTot(0)
		ElseIf documento.ClassificacaoDespesa(0) = "Participação em Resultado" Then
			participacaoPaga = participacaoPaga + documento.TotTot(0)
			'Atualiza Status do Negócio na Despesa
			Call documento.Computewithform(False, False)
			Call documento.Save(False, False)
		ElseIf (documento.TipoCusto(0) = "Custo Variavel" And InStr(documento.Origem(0), "Visita") > 0) Or (documento.TipoCusto(0) = "Despesa Operacional" And InStr(documento.Origem(0), "Atividade de Vendas") > 0) Then
			atividades = atividades + documento.TotTot(0)
		ElseIf documento.TipoCompra(0) = "Projeto" Then
			If documento.ClassificacaoDespesa(0) = "CMV" Then
				intermediacao = intermediacao + documento.TotTot(0)
			Else
				If documento.ClassificacaoDespesa(0) = "Intermediação de Vendas" Then
					valorIntermediacao = valorIntermediacao + documento.TotTot(0)
					ReDim Preserve valoresIntermediacao(z) As Double
					valoresIntermediacao(z) = documento.TotTot(0)
					z = z + 1
				Else
					projeto = projeto + documento.TotTot(0)
					If documento.ClassificacaoDespesa(0) = "CPS" Then
						cps = cps + documento.TotTot(0)
					End If
				End If
			End If
		End If
		Set documento = dc.Getnextdocument(documento)
	Loop
	pf = GetValoresPlanilha(doc.Codigo(0), "Real")
	'Custos das Horas
	Call CustoHora(doc, "Real")
	'Comissão
	If CStr(doc.Comissao(0)) <> "" Then comissao = doc.Comissao(0)
	'Juros
	'If doc.CheckConclusao(0) = "OK" And CStr(doc.Juros_R(0)) <> "" Then
	If doc.CheckPagtoCapitalGiro(0) = "OK" And CStr(doc.Juros_R(0)) <> "" Then
		juros = doc.Juros_R(0)
	Else
		Set db = doc.Parentdatabase
		Set dc = db.FtSearch("", 0)
		Call dc.AddDocument(doc)
		Call CalcCapitalGiroReal(dc)
		If CStr(doc.WC_TotJuros(0)) <> "" Then juros = - doc.WC_Total(0)
	End If
	
	'*** Margem Real
	doc.Venda_R = Round(venda, 2)
	doc.VendaM_R = Round(vendaM, 2)
	doc.VendaS_R = Round(vendaS, 2)
	doc.Custo_R = Round(custo, 2)
	doc.CustoImp_R = Round(custoImp, 2)
	doc.Cambio_R = Round(cambio, 2)
	Dim custosHoras_R As Double
	If doc.Sit(0) <> "Perdido" And doc.Sit(0) <> "Consolidado" Then
		If doc.TipoVenda(0) = "Contrato" Then
			custosHoras_R = doc.CustosHoras_P(0)
		Else
			'Teve Horas Planejadas e Horas Utilizadas
			If doc.HorasT_P(0) > 0 And doc.HorasT_R(0) > 0 Then
				'Teve Custo das Horas na Lista de Serviços
				If doc.CustosHoras_P(0) > 0 Then
					If doc.HorasT_R(0) < doc.HorasT_P(0) Then
						custosHoras_R = doc.CustosHoras_P(0)
					Else
						custosHoras_R = doc.CustosHoras_P(0) * doc.HorasFinais(0)/doc.HorasT_P(0)
					End If
				'Não Teve Custo das Horas na Lista de Serviços
				Else
					custosHoras_R = doc.CustoMedioT_P(0) * doc.HorasFinais(0)/doc.HorasT_P(0)
				End If
			'Teve Horas Planejadas mas não teve Horas Utilizadas (TimeSheet não foi lançado)
			Else
				If doc.Sit(0) = "Concluído" Then
					custosHoras_R = doc.CustosHoras_P(0)
				End If
			End If
		End If
	End If
	doc.CustosHoras_R = Round(custosHoras_R, 2)
	doc.ICMSD_R = Round(icmsD, 2)
	doc.ICMSC_R = Round(icmsC, 2)
	doc.ICMS_R = Round(icmsD, 2) + Round(icmsC, 2)
	doc.ICMSSTC_R = Round(impostoC, 2)
	doc.ICMSST_R = Round(imposto, 2)
	doc.DifICMS_R = Round(impostoC, 2) + Round(imposto, 2)
	doc.FCP_R = Round(fcp, 2)
	doc.IPID_R = Round(ipiD, 2)
	doc.IPIC_R = Round(ipiC, 2)
	doc.IPI_R = Round(ipi, 2)
	doc.ISS_R = Round(iss, 2)
	doc.INSS_R = Round(inss, 2)
	doc.PIS_R = Round(pis, 2)
	doc.COFINS_R = Round(cofins, 2)
	doc.CSLL_R = Round(csll, 2)
	doc.IRPJ_R = Round(irpj, 2)
	doc.CPR_R = Round(cpr, 2)
	doc.Atividades_R = Round(atividades, 2)
	doc.Despesas_R = Round(frete, 2) + Round(intermediacao, 2) 
	doc.TerceirosFaturaveis_R = Round(terceiros, 2)
	doc.PF_R = Round(projeto, 2) - (pf(6) + pf(7)) - (pf(9) + pf(10))	'LMO 09/10/20 - Inclui também as Despesas de Projeto dos Negócios Consolidados
	'doc.PF_R = pf(0) + pf(1) + pf(2) + cps
	doc.PreVenda_R = pf(6) + pf(7)
	doc.POC_R = pf(9) + pf(10)
	doc.Juros_R = Round(juros, 2)
	'Base de Cálculo do Prêmio
	If doc.CheckPagtoComissao(0) = "" Then
		doc.BCPremio_R = Round((doc.Venda_R(0) - doc.Custo_R(0) - doc.CustoImp_R(0) - doc.Cambio_R(0) - doc.CustosHoras_R(0) - doc.ICMS_R(0) - doc.DifICMS_R(0) - doc.FCP_R(0) - doc.IPI_R(0) - doc.ISS_R(0) - doc.INSS_R(0) - doc.PIS_R(0) - doc.COFINS_R(0) - doc.CSLL_R(0) - doc.IRPJ_R(0) - doc.CPR_R(0) - doc.Atividades_R(0) - doc.Despesas_R(0) - doc.TerceirosFaturaveis_R(0) - doc.PF_R(0) - doc.PreVenda_R(0) - doc.POC_R(0) - doc.Juros_R(0)) * comissao, 2)
	Else
		doc.BCPremio_R = Round(comissaoPaga, 2)
	End If
	'Encargos Sociais sobre o Prêmio
	If doc.CheckPagtoEncargosSociais(0) = "" Then
		doc.Encargos_R = Round(doc.BCPremio_R(0) * doc.EncargosSociais(0), 2)
	Else
		doc.Encargos_R = Round(encargoPago, 2)
	End If
	'Intermediação de Vendas - LMO 19/05/2020
	doc.ValoresIntermediacao_R = Round(valorIntermediacao, 2)
	doc.ValorIntermediacao_R = Round(valorIntermediacao, 2)
	doc.Intermediacao_R = Round(valorIntermediacao, 2)
	'Margem do Negócio
	doc.Margem_R = Round((doc.Venda_R(0) - doc.Custo_R(0) - doc.CustoImp_R(0) - doc.Cambio_R(0) - doc.CustosHoras_R(0) - doc.ICMS_R(0) - doc.DifICMS_R(0) - doc.FCP_R(0) - doc.IPI_R(0) - doc.ISS_R(0) - doc.INSS_R(0) - doc.PIS_R(0) - doc.COFINS_R(0) - doc.CSLL_R(0) - doc.IRPJ_R(0) - doc.CPR_R(0) - doc.Atividades_R(0) - doc.Despesas_R(0) - doc.TerceirosFaturaveis_R(0) - doc.PF_R(0) - doc.PreVenda_R(0) - doc.POC_R(0) - doc.Juros_R(0)) - doc.BCPremio_R(0) - doc.Encargos_R(0) - doc.Intermediacao_R(0), 2)
	If doc.CheckConclusao(0) = "" Then
		doc.Premio_R = Round(doc.Margem_R(0) * comissao, 2)
	Else
		doc.Premio_R = Round(comissaoPaga, 2)
	End If
	'Participação Técnica
	If doc.CheckPagtoParticipacoes(0) = "" Then
		If doc.Margem_R(0) > 0 Then
			doc.Participacao_R = Round(doc.Margem_R(0) * (doc.PremioPV(0) + doc.PremioExec(0) + doc.PremioPMO(0)), 2)
		Else
			doc.Participacao_R = 0
		End If
	Else
		doc.Participacao_R = participacaoPaga
	End If
	'Margem do Negócio
	doc.Resultado_R = doc.Margem_R(0) - doc.Participacao_R(0)
	If doc.Venda_R(0) = 0 Then
		doc.Res_R = 0
	Else
		doc.Res_R = doc.Resultado_R(0) / doc.Venda_R(0)
	End If
	doc.ResultadoR = doc.Res_R(0)
	'Fator de Materiais e Fator de Serviços
	Dim fatorM As Double, fatorS As Double
	If doc.Venda_R(0) <> 0 Then
		fatorM = doc.VendaM_R(0)/doc.Venda_R(0)
		fatorS = doc.VendaS_R(0)/doc.Venda_R(0)
	Else
		If doc.Venda_P(0) <> 0 Then
			fatorM = doc.VendaM_P(0)/doc.Venda_P(0)
			fatorS = doc.VendaS_P(0)/doc.Venda_P(0)
		End If
	End If
	'*** Margem de Materiais ***
	If doc.TipoVenda(0) = "Contrato" Then
		doc.ResultadoM_R = 0
		doc.ResM_R = 0
		doc.MgRevendaR = 0
	Else
		Dim premioM As Double, encargosM As Double, intermediacaoM As Double, participacaoM As Double
		premioM = Round((doc.VendaM_R(0) - doc.Custo_R(0) - doc.CustoImp_R(0) - doc.Cambio_R(0) - doc.ICMS_R(0) - doc.DifICMS_R(0) - doc.FCP_R(0) - doc.IPI_R(0) - issM - inssM - pisM - cofinsM - (doc.CSLL_R(0) * fatorM) - (doc.IRPJ_R(0) * fatorM) - cprM - (doc.Atividades_R(0) * fatorM) - doc.Despesas_R(0) - doc.PreVenda_R(0) * fatorM - doc.POC_R(0) * fatorM - (doc.Juros_R(0) * fatorM)) * comissao, 2)
		encargosM = premioM * doc.EncargosSociais(0)
		intermediacaoM = doc.Intermediacao_R(0) * fatorM
		participacaoM = doc.Participacao_R(0) * fatorM
		doc.ResultadoM_R = Round(doc.VendaM_R(0) - doc.Custo_R(0) - doc.CustoImp_R(0) - doc.Cambio_R(0) - doc.ICMS_R(0) - doc.DifICMS_R(0) - doc.FCP_R(0) - doc.IPI_R(0) - issM - inssM - pisM - cofinsM - (doc.CSLL_R(0) * fatorM) - (doc.IRPJ_R(0) * fatorM) - cprM - (doc.Atividades_R(0) * fatorM) - doc.Despesas_R(0) - doc.PreVenda_R(0) * fatorM - doc.POC_R(0) * fatorM - (doc.Juros_R(0) * fatorM) - premioM - encargosM - intermediacaoM - participacaoM, 2)
		If doc.VendaM_R(0) = 0 Then
			doc.ResM_R = 0
		Else
			doc.ResM_R = doc.ResultadoM_R(0) / doc.VendaM_R(0)
		End If
		doc.MgRevendaR = doc.ResM_R(0)
	End If
	'*** Margem de Serviços ***
	Dim premioS As Double, encargosS As Double, intermediacaoS As Double, participacaoS As Double
	If doc.TipoVenda(0) = "Contrato" Then	'Inclusão do Custo da Lista de Materiais
		premioS = Round((doc.VendaS_R(0) - doc.CustosHoras_R(0) - doc.Custo_R(0) - doc.CustoImp_R(0) - issS - inssS - pisS - cofinsS - (doc.CSLL_R(0) * fatorS) - (doc.IRPJ_R(0) * fatorS) - cprS - (doc.Atividades_R(0) * fatorS) - doc.TerceirosFaturaveis_R(0) - doc.PF_R(0) - doc.PreVenda_R(0) * fatorS - doc.POC_R(0) * fatorS - (doc.Juros_R(0) * fatorS)) * comissao, 2)
	Else
		premioS = Round((doc.VendaS_R(0) - doc.CustosHoras_R(0) - issS - inssS - pisS - cofinsS - (doc.CSLL_R(0) * fatorS) - (doc.IRPJ_R(0) * fatorS) - cprS - (doc.Atividades_R(0) * fatorS) - doc.TerceirosFaturaveis_R(0) - doc.PF_R(0) - doc.PreVenda_R(0) * fatorS - doc.POC_R(0) * fatorS - (doc.Juros_R(0) * fatorS)) * comissao, 2)
	End If
	encargosS = premioS * doc.EncargosSociais(0)
	intermediacaoS = doc.Intermediacao_R(0) * fatorS
	participacaoS = doc.Participacao_R(0) * fatorS
	If doc.TipoVenda(0) = "Contrato" Then	'Inclusão do Custo da Lista de Materiais (Ativo Fixo)
		doc.ResultadoS_R = Round(doc.VendaS_R(0) - custosHoras_R - doc.Custo_R(0) - doc.CustoImp_R(0) - issS - inssS - pisS - cofinsS - (doc.CSLL_R(0) * fatorS) - (doc.IRPJ_R(0) * fatorS) - cprS - (doc.Atividades_R(0) * fatorS) - doc.TerceirosFaturaveis_R(0) - doc.PF_R(0) - doc.PreVenda_R(0) * fatorS - doc.POC_R(0) * fatorS - (doc.Juros_R(0) * fatorS) - premioS - encargosS - intermediacaoS - participacaoS, 2)
	Else
		doc.ResultadoS_R = Round(doc.VendaS_R(0) - custosHoras_R - issS - inssS - pisS - cofinsS - (doc.CSLL_R(0) * fatorS) - (doc.IRPJ_R(0) * fatorS) - cprS - (doc.Atividades_R(0) * fatorS) - doc.TerceirosFaturaveis_R(0) - doc.PF_R(0) - doc.PreVenda_R(0) * fatorS - doc.POC_R(0) * fatorS - (doc.Juros_R(0) * fatorS) - premioS - encargosS - intermediacaoS - participacaoS, 2)
	End If
	If doc.VendaS_R(0) = 0 Then
		doc.ResS_R = 0
	Else
		doc.ResS_R = doc.ResultadoS_R(0) / doc.VendaS_R(0)
	End If
	doc.MgServicosR = doc.ResS_R(0)
	
	'*** Print - Diferença entre Real e Previsto ***
	doc.VendaM_D = Round(doc.VendaM_R(0) - doc.VendaM_P(0), 2)
	doc.VendaS_D = Round(doc.VendaS_R(0) - doc.VendaS_P(0), 2)
	doc.Venda_D = Round(doc.Venda_R(0) - doc.Venda_P(0), 2)
	doc.Custo_D = Round(doc.Custo_R(0) - doc.Custo_P(0), 2)
	doc.CustoImp_D = Round(doc.CustoImp_R(0) - doc.CustoImp_P(0), 2)
	doc.Cambio_D = Round(doc.Cambio_R(0) - doc.Cambio_P(0), 2)
	doc.CustosHoras_D = Round(doc.CustosHoras_R(0) - doc.CustosHoras_P(0), 2)
	doc.ICMSD_D = Round(doc.ICMSD_R(0) - doc.ICMSD_P(0), 2)
	doc.ICMSC_D = Round(doc.ICMSC_R(0) - doc.ICMSC_P(0), 2)
	doc.ICMS_D = Round(doc.ICMS_R(0) - doc.ICMS_P(0), 2)
	doc.ICMSSTC_D = Round(doc.ICMSSTC_R(0) - doc.ICMSSTC_P(0), 2)
	doc.ICMSST_D = Round(doc.ICMSST_R(0) - doc.ICMSST_P(0), 2)
	doc.DifICMS_D = Round(doc.DifICMS_R(0) - doc.DifICMS_P(0), 2)
	doc.FCP_D = Round(doc.FCP_R(0) - doc.FCP_P(0), 2)
	doc.IPID_D = Round(doc.IPID_R(0) - doc.IPID_P(0), 2)
	doc.IPIC_D = Round(doc.IPIC_R(0) - doc.IPIC_P(0), 2)
	doc.IPI_D = Round(doc.IPI_R(0) - doc.IPI_P(0), 2)
	doc.ISS_D = Round(doc.ISS_R(0) - doc.ISS_P(0), 2)
	doc.INSS_D = Round(doc.INSS_R(0) - doc.INSS_P(0), 2)
	doc.PIS_D = Round(doc.PIS_R(0) - doc.PIS_P(0), 2)
	doc.COFINS_D = Round(doc.COFINS_R(0) - doc.COFINS_P(0), 2)
	doc.CSLL_D = Round(doc.CSLL_R(0) - doc.CSLL_P(0), 2)
	doc.IRPJ_D = Round(doc.IRPJ_R(0) - doc.IRPJ_P(0), 2)
	doc.CPR_D = Round(doc.CPR_R(0) - doc.CPR_P(0), 2)
	doc.Atividades_D = Round(doc.Atividades_R(0) - doc.Atividades_P(0), 2)
	doc.Despesas_D = Round(doc.Despesas_R(0) - doc.Despesas_P(0), 2)
	doc.TerceirosFaturaveis_D = Round(doc.TerceirosFaturaveis_R(0) - doc.TerceirosFaturaveis_P(0), 2)
	doc.PF_D = Round(doc.PF_R(0) - doc.PF_P(0), 2)
	doc.PreVenda_D = Round(doc.PreVenda_R(0) - doc.PreVenda_P(0), 2)
	doc.POC_D = Round(doc.POC_R(0) - doc.POC_P(0), 2)
	doc.Juros_D = Round(doc.Juros_R(0) - doc.Juros_P(0), 2)
	doc.BCPremio_D = Round(doc.BCPremio_R(0) - doc.BCPremio_P(0), 2)
	doc.Encargos_D = Round(doc.Encargos_R(0) - doc.Encargos_P(0), 2)
	doc.Intermediacao_D = Round(doc.Intermediacao_R(0) - doc.Intermediacao_P(0), 2)
	doc.Margem_D = Round(doc.Margem_R(0) - doc.Margem_P(0), 2)
	doc.Premio_D = Round(doc.Premio_R(0) - doc.Premio_P(0), 2)
	doc.Participacao_D = Round(doc.Participacao_R(0) - doc.Participacao_P(0), 2)
	doc.Resultado_D = Round(doc.Resultado_R(0) - doc.Resultado_P(0), 2)
	doc.Res_D = Round(doc.Res_R(0) - doc.Res_P(0), 2)
	doc.ResultadoM_D = Round(doc.ResultadoM_R(0) - doc.ResultadoM_P(0), 2)
	doc.ResM_D = Round(doc.ResM_R(0) - doc.ResM_P(0), 2)
	doc.ResultadoS_D = Round(doc.ResultadoS_R(0) - doc.ResultadoS_P(0), 2)
	doc.ResS_D = Round(doc.ResS_R(0) - doc.ResS_P(0), 2)
	'*** Tabela do Valor dos Serviços ***
	If Val(doc.Horas_P(0)) > 0 Then
		doc.ValorSV_R = doc.HorasT_R(0) * (doc.CustosHoras_P(0)/doc.Horas_P(0))
		doc.Fator = doc.HorasT_R(0)/doc.Horas_P(0)
	Else
		doc.ValorSV_R = 0
		doc.Fator = 0
	End If
	doc.HorasSV_R = doc.HorasT_R(0)
	If Val(doc.HorasSV_R(0)) > 0 Then
		doc.CustoHoraSV_R = doc.ValorSV_P(0)/doc.HorasSV_R(0)
	Else
		doc.CustoHoraSV_R = 0
	End If
	'*** Ajuste de Comissão ***
	If doc.TipoComissionamento(0) = "Margem" Then
		doc.Comissao_R = Round(doc.Premio_R(0), 2)
		doc.Comissao_P = Round(comissaoPaga, 2)
		doc.Ajuste = Round(doc.Comissao_R(0), 2) - Round(doc.Comissao_P(0), 2)
		'Negócio
		x = UBound(doc.NomeComissao)
		ReDim Preserve nomes(x) As String, comissoes_R(x) As Double, comissoes_P(x) As Double, ajustes(x) As Double
		For scan = 0 To UBound(doc.NomeComissao)
			nomes(scan) = doc.NomeComissao(scan)
			comissoes_R(scan) = Round(doc.Comissao_R(0) * doc.ParticipacaoComissao(scan), 2)
			comissoes_P(scan) = 0
			ajustes(scan) = Round(comissoes_R(scan) - comissoes_P(scan), 2)
		Next
		'Despesas
		x = 0
		For scan = 0 To UBound(nome)
			If nome(scan) <> "" Then
				indice = ArrayGetIndex(doc.NomeComissao, nome(scan))
				If IsNull(indice) Then
					x = x + 1
					ReDim Preserve nomes(x) As String, comissoes_R(x) As Double, comissoes_P(x) As Double, ajustes(x) As Double
					nomes(x) = nome(scan)
					comissoes_R(x) = 0
					comissoes_P(x) = valorPago(scan)
					ajustes(x) = Round(comissoes_R(x), 2) - Round(comissoes_P(x), 2)
				Else
					comissoes_R(indice) = Round(doc.Comissao_R(0) * doc.ParticipacaoComissao(indice), 2)
					comissoes_P(indice) = valorPago(indice)
					ajustes(indice) = Round(comissoes_R(indice), 2) - Round(comissoes_P(indice), 2)
				End If
			End If
		Next
		doc.Nomes = nomes
		doc.Comissoes_R = comissoes_R
		doc.Comissoes_P = comissoes_P
		doc.Ajustes = ajustes
	End If
	
End Sub

'++LotusScript Development Environment:2:1:ConsisteCamposContrato:5:8
%REM
	Function ConsisteCamposContrato
	Description: Comments for Function
%END REM
Function ConsisteCamposContrato(uidoc As NotesUIDocument) As Boolean
	
	ConsisteCamposContrato = True
	If uidoc.FieldGetText("DataInicial") = "" Then
		MsgBox "Você precisa informar a Data do Início do Contrato", 16, "Erro !"
		Call uidoc.GotoField( "DataInicial" )
		ConsisteCamposContrato = False
		Exit Function
	ElseIf uidoc.FieldGetText("DataFinal") = "" Then
		MsgBox "Você precisa informar a Data Final do Contrato", 16, "Erro !"
		Call uidoc.GotoField( "DataFinal" )
		ConsisteCamposContrato = False
		Exit Function
	ElseIf CDat(uidoc.FieldGetText("DataInicial")) > CDat(uidoc.FieldGetText("DataFinal")) Then
		MsgBox "A Data Final do Contrato tem que ser posterior a Data do Início", 16, "Erro !"
		Call uidoc.GotoField( "DataFinal" )
		ConsisteCamposContrato = False
		Exit Function
	ElseIf uidoc.FieldGetText("TipoPagamento") = "" Then
		MsgBox "Você precisa informar o Tipo de Pagamento do Contrato", 16, "Erro !"
		Call uidoc.GotoField( "TipoPagamento" )
		ConsisteCamposContrato = False
		Exit Function
	ElseIf uidoc.FieldGetText("DiaFaturamento") = "" Then
		MsgBox "Você precisa informar o Dia do Faturamento do Contrato", 16, "Erro !"
		Call uidoc.GotoField( "DiaFaturamento" )
		ConsisteCamposContrato = False
		Exit Function
	ElseIf uidoc.FieldGetText("DataReajuste") = "" Then
		MsgBox "Você precisa informar a Data do Reajuste do Contrato", 16, "Erro !"
		Call uidoc.GotoField( "DataReajuste" )
		ConsisteCamposContrato = False
		Exit Function
	ElseIf uidoc.FieldGetText("IndiceReajuste") = "" Then
		MsgBox "Você precisa informar o Índice de Reajuste do Contrato", 16, "Erro !"
		Call uidoc.GotoField( "IndiceReajuste" )
		ConsisteCamposContrato = False
		Exit Function
	End If
		
End Function

'++LotusScript Development Environment:2:2:GetRegrasFiscais:1:8
Sub GetRegrasFiscais(negocio As NotesDocument)
	
	If negocio.Sit(0) <> "Prospect" And InStr(negocio.Sit(0), "Pré-Venda") = 0 And negocio.Sit(0) <> "Forecast" Then
		Exit Sub
	End If
	On Error Resume Next
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Set view = db.GetView("(RegrasFiscais)")
	Set doc = view.GetLastDocument
	Do Until doc Is Nothing
		'Sistema Multi Empresas
		If doc.CodEmpresa(0) = negocio.CodEmpresa(0) Then
			negocio.RegrasFiscais = doc.DocID(0)
			Exit Do	
		End If
		Set doc = view.GetPrevDocument(doc)
	Loop
	
End Sub

'++LotusScript Development Environment:2:2:ConsolidaCenarios:5:8
%REM
	Sub ConsolidaCenarios
	Description: Comments for Sub
%END REM
Sub ConsolidaCenarios(negocio As NotesDocument)
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Set db = session.Currentdatabase
	'Fechamento de Venda de Cenário
	If negocio.TipoNegocio(0) = "Cenário" Then
		If negocio.Principal(0) <> "" Then
			'Consolida Negócio Principal
			Set view = db.Getview("(NegociosCodigo)")
			Set doc = view.Getdocumentbykey(negocio.Principal(0), True)
			If Not doc Is Nothing Then
				If negocio.Codigo(0) <> doc.Codigo(0) Then
					If Not fechado(doc.Sit(0)) Then
						doc.DataPerda = Today
						doc.ColaboradorPerda = session.CommonUserName
						doc.TipoPerda = "Consolidado"
						doc.NovoCodigo = negocio.Codigo(0)
						doc.Sit = "Perdido"
						doc.SitNumero = 33
						'Call Perda(doc)
						Call doc.Save(True, True)
					End If
				End If
				'Consolida Cenários
				Set view = db.Getview("(Cenarios)")
				Set dc = view.Getalldocumentsbykey(negocio.Principal(0), True)
				Set doc = dc.Getfirstdocument()
				Do Until doc Is Nothing
					If negocio.Codigo(0) <> doc.Codigo(0) Then
						If Not fechado(doc.Sit(0)) Then
							doc.DataPerda = Today
							doc.ColaboradorPerda = session.CommonUserName
							doc.TipoPerda = "Consolidado"
							doc.NovoCodigo = negocio.Codigo(0)
							doc.Sit = "Perdido"
							doc.SitNumero = 33
							'Call Perda(doc)
							Call doc.Save(True, True)
						End If
					End If
					Set doc = dc.GetNextDocument(doc)
				Loop
			End If
		End If
	'Fechamento de Venda de Negócio Principal
	ElseIf negocio.TipoNegocio(0) = "Negócio" Then
		'Consolida Cenários
		Set view = db.Getview("(Cenarios)")
		Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
		Set doc = dc.Getfirstdocument()
		Do Until doc Is Nothing
			If negocio.Codigo(0) <> doc.Codigo(0) Then
				If Not fechado(doc.Sit(0)) Then
					doc.DataPerda = Today
					doc.ColaboradorPerda = session.CommonUserName
					doc.TipoPerda = "Consolidado"
					doc.NovoCodigo = negocio.Codigo(0)
					doc.Sit = "Perdido"
					doc.SitNumero = 33
					'Call Perda(doc)
					Call doc.Save(True, True)
				End If
			End If
			Set doc = dc.GetNextDocument(doc)
		Loop
	End If
	
End Sub

'++LotusScript Development Environment:2:2:GetHorasPrevistas:5:8
%REM
	Sub GetHorasPrevistas
	Description: Comments for Sub
%ENDREM
Sub GetHorasPrevistas(negocio As NotesDocument)
	
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim projeto As NotesDocument
	Dim array(1) As Double
	Dim data As NotesDateTime
	If negocio.TipoVenda(0) = "Contrato" Then
		Set view = db.Getview("(Planilha/Codigo)")
	Else
		Set view = db.Getview("(ProjetosCodigo)")
	End If
	Set projeto = view.Getdocumentbykey(negocio.Codigo(0), True)
	If negocio.DataFechamento(0) <> "" Then
		Set data = New NotesDateTime(negocio.DataFechamento(0))
	Else
		Set data = New NotesDateTime(negocio.Criacao(0))
	End If
	'Print
	negocio.Datas_P = Format(data.DateOnly, "mm/yyyy")
	If Not projeto Is Nothing Then
		If CStr(projeto.HHP(0)) = "" Then
			negocio.Horas_P = 0
			negocio.HorasT_P = 0
		Else
			negocio.Horas_P = projeto.HHP(0)
			negocio.HorasT_P = projeto.HHP(0)
		End If
	Else
		negocio.Horas_P = 0
		negocio.HorasT_P = 0
	End If
	
End Sub

'++LotusScript Development Environment:2:1:AtualizaSaldosAFaturar:1:8
Function AtualizaSaldosAFaturar(doc As NotesDocument) As Variant
	
	On Error Resume Next
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim itemLista As NotesDocument
	Dim scan As Integer, saldo As Double, fator As Double
	Dim a(1) As Double, icmsst As Double
	'Limpa Saldo Faturamento Lista Materiais
	For scan = 0 To 49
		Call doc.ReplaceItemValue("QFat_" & scan, "")
	Next
	'Limpa Saldo Faturamento Lista Serviços
	For scan = 0 To 11
		Call doc.ReplaceItemValue("VlFat_" & scan, "")
	Next
	'Contrato
	If doc.TipoVenda(0) = "Contrato" Then
		Set db = New NotesDatabase( doc.ParentDatabase.Server,"servicos.nsf" )
		Set view = db.GetView("(ContratosCodigo)")
		Set itemLista = view.GetDocumentByKey(doc.Codigo(0), True)
		a(0) = 0	'Saldo Faturamento
		If itemLista Is Nothing Then
			a(1) = 0 'Não Houve fechamento
		Else
			If doc.Sit(0) = "Contrato" Or doc.Sit(0) = "Concluído" Then
				a(1) = 1 'Houve fechamento
			Else
				a(1) = 0 'Não Houve fechamento
			End If
		End If
		AtualizaSaldosAFaturar = a
	End If
	'Negócio não foi Fechado (Limpa Saldos)
	If Not Fechado(doc.Sit(0)) Then
		a(0) = 0 'Saldo do faturamento
		AtualizaSaldosAFaturar = a
		doc.SaldoFaturamento = 0
		Exit Function
	End If
	'Conversão de Moedas
	Dim session As New NotesSession
	Dim comercial As Double, turismo As Double, valor As Double, valorTotal As Double
	Dim saldoNegocio As Double, saldoServ As Double, TotalNegocio As Double, valorSaldo As Double
	'US$C Venda Fixo - LMO 08/01/18
	If IsNumeric(doc.USVenda(0)) Then
		comercial = doc.USVenda(0)
	Else
		If CStr(doc.USC(0)) = "" Then comercial = 1 Else comercial = doc.USC(0)
	End If
	If Cstr(doc.UST(0)) = "" Then turismo = 1 Else turismo = doc.UST(0)
	'Listas
	Dim dbLista As NotesDatabase
	Dim viewLista As NotesView
	Set dbLista = New NotesDatabase( doc.ParentDatabase.Server,"listas.nsf" )
	Set viewLista = dbLista.GetView( "(NegocioForm)" )
	'Saldos de Materiais
	Dim listaMateriais As NotesDocumentCollection
	Set listaMateriais = viewLista.GetAllDocumentsByKey( doc.Codigo(0)  & "Item", True )
	Set itemLista = listaMateriais.GetFirstDocument
	scan = 0
	Do Until itemLista Is Nothing
		If Val(itemLista.Q(0)) > 0 Then	'Quantidade maior que zero - LMO 29/04/25
			If doc.TipoVenda(0) = "Contrato" Then
				saldo = itemLista.Q(0) - itemLista.QCompra(0)
			Else
				saldo = itemLista.Q(0) - itemLista.QFat(0)
				If itemLista.Us(0) = "US$C" Then
					fator = comercial
				ElseIf itemLista.Us(0) = "US$T" Then
					fator = turismo
				Else
					fator = 1
				End If
				If itemLista.Hasitem("ICMSST") Then
					If CStr(itemLista.ICMSST(0)) = "" Then icmsst = 0 Else icmsst = itemLista.ICMSST(0) 
				Else
					icmsst = 0
				End If
				If Val(itemLista.Q(0)) > 0 Then
					'Venda Não Contribuinte: Investimento Total é a BC do ICMSST - LMO 28/08/23
					If doc.Contribuinte(0) = "Não" And doc.UF(0) <> "SP" And doc.Pais(0) = "Brasil" And itemLista.T(0) = "HW" Then
						valor = itemLista.Q(0) * (itemLista.BCICMSST(0) / itemLista.Q(0)) * fator
						valorSaldo = saldo * (itemLista.BCICMSST(0) / itemLista.Q(0)) * fator
					Else
						valor = itemLista.Q(0) * (itemLista.CustoUnit(0) + icmsst / itemLista.Q(0)) * fator
						valorSaldo = saldo * (itemLista.CustoUnit(0) + icmsst / itemLista.Q(0)) * fator
					End If
				Else	
					valor = 0
					valorSaldo = 0
				End If
				totalNegocio = totalNegocio + valor
				saldoNegocio = saldoNegocio + valorSaldo
			End If
			Call doc.ReplaceItemValue("QFat_" & (Val(itemLista.NItem(0)) -1), saldo)
		Else
			Call doc.ReplaceItemValue("QFat_" & (Val(itemLista.NItem(0)) -1), "")
		End If
		Set itemLista = listaMateriais.GetNextDocument( itemLista )
		scan = scan + 1
	Loop
	'Saldos de Serviços
	Dim listaServicos As NotesDocumentCollection
	Set listaServicos = viewLista.GetAllDocumentsByKey( doc.Codigo(0) & "Servico", True)
	Set itemLista = listaServicos.GetFirstDocument
	scan = 0
	Do Until itemLista Is Nothing
		If Val(itemLista.Qs(0)) > 0 Then	'Quantidade maior que zero - LMO 29/04/25
			If itemLista.Us(0) = "US$C" Then
				fator = comercial
			ElseIf itemLista.Us(0) = "US$T" Then
				fator = turismo
			Else
				fator = 1
			End If
			saldo = (itemLista.CusTots(0) - itemLista.VlFat(0)) * fator
			saldoServ = saldoServ + saldo
			saldoNegocio = saldoNegocio + saldo
			totalNegocio  = totalNegocio  + (itemLista.CusTots(0) * fator)
			Call doc.ReplaceItemValue("VlFat_" & (Val(itemLista.NServico(0)) -1), saldo/fator)
			Set itemLista = listaServicos.GetNextDocument(itemLista)
		End If
		scan = scan + 1
	Loop
	doc.SaldoFaturamento = Round(saldoNegocio, 2)
	doc.SaldoServicos = Round(saldoServ, 2)
	a(0) = Round(saldoNegocio, 2)
	a(1) = 1 'Houve fechamento
	AtualizaSaldosAFaturar = a
	
End Function

'++LotusScript Development Environment:2:2:AvisoForecast:5:8
%REM
	Sub AvisoForecast
	Description: Comments for Sub
%END REM
Sub AvisoForecast(doc As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim memo As NotesDocument, rtitem As NotesRichTextItem
	Dim x As Integer
	'Inside Sales
	Dim y As Integer
	For y = 0 To UBound(doc.Inside)
		ReDim Preserve recipients(x + y) As String
		recipients(x + y) = doc.Inside(y) & "/TDec"
	Next
	'Gerente da Conta
	ReDim Preserve recipients(x + y + 2) As String
	recipients(x + y + 1) = doc.GerenteConta(0) & "/TDec"
	'Administração de Vendas
	recipients(x + y + 2) = "administracaovendas@tdec.com.br"
	'Estilo do Texto
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	Set memo = New NotesDocument( session.CurrentDatabase )
	memo.Form = "Memo"
	memo.From = session.CommonUserName
	memo.SendTo = recipients
	memo.CopyTo = "Junior Castro/TDec"
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	If doc.Sit(0) = "Forecast" Then
		memo.Subject = "-> Forecast de Negócio - " & doc.Codigo(0)  & " - " & doc.Cliente(0)
	Else
		memo.Subject = "-> Follow Up de Negócio - " & doc.Codigo(0)  & " - " & doc.Cliente(0)
	End If
	Set rtitem = memo.CreateRichTextItem( "Body" )
	Call rtitem.AppendStyle(richStyle)
	If doc.Area(0) <> "" Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Área de Serviços: " & doc.Area(0))
	End If
	If doc.AreaVendas(0) <> "" Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Área de Vendas: " & doc.AreaVendas(0))
	End If
	If CStr(doc.TotalNegocio(0)) <> "" Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "Total do Negócio: R$ " & Format(doc.TotalNegocio(0), "Standard"))
	End If
	If CStr(doc.ValorEstimadoSub(0)) <> "" Then
		Call rtitem.AddNewLine( 1 )
		If doc.Temperatura(0) = "Frio" Then
			Call rtitem.Appendtext( "Temperatura: Frio (60%)" )
		ElseIf doc.Temperatura(0) = "Morno" Then
			Call rtitem.Appendtext( "Temperatura: Morno (70%)" )
		ElseIf doc.Temperatura(0) = "Quente" Then
			Call rtitem.Appendtext( "Temperatura: Quente (80%)" )
		End If
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Valor Estimado: R$ " & Format(doc.ValorEstimadoSub(0), "Standard") )
	End If
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "Descrição: " & doc.Descricao(0) )
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "Negócio:  " )
	Call rtitem.AppendDocLink( doc, "Link para o Negócio" )
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine( 2 )
	Call rtitem.AppendText( "Forecast: " )
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine( 1 )
	Call rtitem.Appendtext( "Previsão Fechamento: " & Format(doc.DataForecast(0), "dd/mm/yyyy") )
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( doc.FollowUp(0) )	
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( session.CommonUserName & "," )
	Call rtitem.AddNewLine( 1 )
	Call rtitem.Appendtext( "TDec Network Group" )
	Call memo.Send( False )
	
End Sub


'++LotusScript Development Environment:2:1:GetDadosBancarios:5:8
%REM
	Function GetDadosBancarios LMO 12/12/24
	Description: Comments for Function
%END REM
Function GetDadosBancarios(negocio As NotesDocument) As String
	
	'If negocio.TipoPagto(0) <> "Crédito em Conta" Then Exit Function
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "bancos.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Set view = db.Getview("(ContaCorrenteEmpresaAtiva)")
	Set dc = view.Getalldocumentsbykey(negocio.CodEmpresa(0), True)
	'Apenas 1 Conta Ativa
	If dc.Count = 1 Then
		Set doc = dc.Getfirstdocument()
		If Not doc Is Nothing Then
			GetDadosBancarios = Chr(10) & "Crédito em Conta Corrente: Banco " & doc.Banco(0) & " " & GetNumeroBanco(doc.Banco(0)) & ", Ag. " & doc.Agencia(0) & ", CC " & Left(doc.Codigo(0), Len(doc.Codigo(0)) - 1) & "-" & Right(doc.Codigo(0), 1) & ", PIX " & doc.ChavePIX(0)
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:AvisoFaturamentoFinanceiro:5:8
%REM
	Sub AvisoFaturamentoFinanceiro
	Description: Comments for Sub
%END REM
Sub AvisoFaturamentoFinanceiro(aceite As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(aceite.Parentdatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument, memo As NotesDocument
	Dim key(1) As String
	key(0) = aceite.Codigo(0)
	key(1) = aceite.NFiscal(0)
	Set view = db.Getview("(EspelhosNegocio)")
	Set doc = view.GetDocumentbykey(key, True)
	If Not doc Is Nothing Then
		
	Dim rtitem As NotesRichTextItem
	Dim anexos As NotesRichTextItem
	Dim richStyle As NotesRichTextStyle
	Set memo = db.CreateDocument
	memo.Form = "Memo"
	memo.SendTo = "financeiro@tdec.com.br"
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	Set rtitem = memo.CreateRichTextItem("Body")
	Set anexos = doc.Getfirstitem("EmailAceiteFaturamento")
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = rtitem.GetNotesFont("Arial", True)
	richStyle.FontSize = 12
	Call rtitem.AppendStyle(richStyle)
	'Aviso de Faturamento recebido
	If aceite.StatusAceiteFaturamento(0) = "Aceite Pendente" Then
		memo.Subject = "-> Aviso de Faturamento recebido pelo cliente (" & doc.Codigo(0) & ") documento nº " & doc.NFiscal(0) & ", vencimento em " & Format(doc.Vencimento(0), "dd/mm/yyyy")
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Aviso de Faturamento referente a Nota Fiscal nº ")
		richStyle.Bold = True
		richStyle.Notescolor = COLOR_RED
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( doc.NFiscal(0) )
		richStyle.Bold = False
		richStyle.Notescolor = COLOR_BLACK
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( ", com vencimento em ")
		richStyle.Bold = True
		richStyle.Notescolor = COLOR_RED
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( Format(doc.Vencimento(0), "dd/mm/yyyy") )
		richStyle.Bold = False
		richStyle.Notescolor = COLOR_BLACK
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( " recebido pelo cliente." )
	'Faturamento aceito
	ElseIf aceite.StatusAceiteFaturamento(0) = "OK" Then
		memo.Subject = "-> Faturamento confirmado pelo cliente (" & doc.Codigo(0) & ") documento nº " & doc.NFiscal(0) & ", vencimento em " & Format(doc.Vencimento(0), "dd/mm/yyyy")
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Faturamento referente a Nota Fiscal nº ")
		richStyle.Bold = True
		richStyle.Notescolor = COLOR_RED
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( doc.NFiscal(0) )
		richStyle.Bold = False
		richStyle.Notescolor = COLOR_BLACK
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( ", com vencimento em ")
		richStyle.Bold = True
		richStyle.Notescolor = COLOR_RED
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( Format(doc.Vencimento(0), "dd/mm/yyyy") )
		richStyle.Bold = False
		richStyle.Notescolor = COLOR_BLACK
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( " confirmado pelo cliente." )
	'Faturamento recusado
	ElseIf aceite.StatusAceiteFaturamento(0) = "Recusado" Then
		memo.Subject = "-> Faturamento recusado pelo cliente (" & doc.Codigo(0) & ") documento nº " & doc.NFiscal(0) & ", vencimento em " & Format(doc.Vencimento(0), "dd/mm/yyyy")
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Faturamento referente a Nota Fiscal nº ")
		richStyle.Bold = True
		richStyle.Notescolor = COLOR_RED
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( doc.NFiscal(0) )
		richStyle.Bold = False
		richStyle.Notescolor = COLOR_BLACK
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( ", com vencimento em ")
		richStyle.Bold = True
		richStyle.Notescolor = COLOR_RED
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( Format(doc.Vencimento(0), "dd/mm/yyyy") )
		richStyle.Bold = False
		richStyle.Notescolor = COLOR_BLACK
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( " recusado pelo cliente." )
	End If
	'Parcela 1
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "Vencimento: ")
	richStyle.Bold = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.Appendtext( Format(doc.Vencimento(0), "dd/mm/yyyy") )
	richStyle.Bold = False
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine( 1 )
	Call rtitem.Appendtext( "Valor: ")
	richStyle.Bold = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.Appendtext( "R$" & Format(doc.Valor(0), "standard") )
	'Parcela 2
	If doc.Vencimento2(0) <> "" Then
		richStyle.Bold = False
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Vencimento: ")
		richStyle.Bold = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( Format(doc.Vencimento2(0), "dd/mm/yyyy") )
		richStyle.Bold = False
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Valor: ")
		richStyle.Bold = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( "R$" & Format(doc.Valor2(0), "standard") )
	End If
		'Parcela 3
		If doc.Vencimento3(0) <> "" Then
		richStyle.Bold = False
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Vencimento: ")
		richStyle.Bold = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( Format(doc.Vencimento3(0), "dd/mm/yyyy") )
		richStyle.Bold = False
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Valor: ")
		richStyle.Bold = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( "R$" & Format(doc.Valor3(0), "standard") )
	End If
		'Parcela 4
		If doc.Vencimento4(0) <> "" Then
		richStyle.Bold = False
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AddNewLine( 2 )
		Call rtitem.Appendtext( "Vencimento: ")
		richStyle.Bold = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( Format(doc.Vencimento4(0), "dd/mm/yyyy") )
		richStyle.Bold = False
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Valor: ")
		richStyle.Bold = True
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.Appendtext( "R$" & Format(doc.Valor4(0), "standard") )
	End If
	richStyle.Bold = False
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "Observações:")
	Call rtitem.AddNewLine( 1 )
	Call rtitem.Appendtext( aceite.Observacao(0))
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "Espelho:  " )
	Call rtitem.AppendDocLink( doc, "Link para o Espelho" )
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( session.Commonusername & "," )
	Call rtitem.AddNewLine( 1 )
	Call rtitem.Appendtext( "TDec Network Group" )
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendrtitem(anexos)
	Call memo.Send( True )
	End If
	
End Sub

'++LotusScript Development Environment:2:2:ColocarNaAgenda:5:8
%REM
	Sub ColocarNaAgenda
	Description: Comments for Sub
%END REM
Sub ColocarNaAgenda(doc As NotesDocument)
	
	Dim session As New NotesSession
	Dim datetime As New NotesDateTime(doc.ProxData(0) + " 10:00")
	Dim db As NotesDatabase
	Dim scan As Integer
	Dim dbTitle(1) As String
	dbTitle(0) = doc.GerenteConta(0)
	dbTitle(1) = doc.Inside(0)
	Set db = New NotesDatabase( "", "" )
	Call db.OpenMail
	Dim co As New NotesDocument(db)
	Call co.ReplaceItemValue("Form", "Appointment")
	Call co.ReplaceItemValue("AppointmentType", "4")
	Call co.ReplaceItemValue("CalendarDateTime", datetime)
	Call co.ReplaceItemValue("Chair", session.UserName)
	Call co.ReplaceItemValue("EndDate", CDat(datetime.Dateonly))
	Call co.ReplaceItemValue("EndDateTime", datetime)
	Call co.ReplaceItemValue("EndTime", CDat(datetime.Timeonly))
	Call co.ReplaceItemValue("From", session.UserName)
	Call co.ReplaceItemValue("Principal", session.UserName)
	Call co.ReplaceItemValue("StartDate", CDat(datetime.Dateonly))
	Call co.ReplaceItemValue("STARTDATETIME", datetime)
	Call co.ReplaceItemValue("StartTime", CDat(datetime.Timeonly))
	Call co.ReplaceItemValue("_ViewIcon", 10)
	ReDim tempArray(0 To 1)
	tempArray(0) = |D|
	tempArray(1) = |S|
	Call co.ReplaceItemValue("ExcludeFromView", tempArray)
	Call co.ReplaceItemValue("SequenceNum", 1)
	Call co.ReplaceItemValue("UpdateSeq", 1)
	Call co.ReplaceItemValue("$CSVersion", |2|)
	Call co.ReplaceItemValue("$SMTPKeepNotesItems", |1|)
	ReDim tempArray(0 To 7)
	tempArray(0) = |$S:1|
	tempArray(1) = |$L:1|
	tempArray(2) = |$B:1|
	tempArray(3) = |$R:1|
	tempArray(4) = |$E:1|
	tempArray(5) = |$W:1|
	tempArray(6) = |$O:1|
	tempArray(7) = |$M:1|
	Call co.ReplaceItemValue("$CSWISL", tempArray)
	Call co.ReplaceItemValue("WebDateTimeInit", |1|)
	Call co.ReplaceItemValue("OrgTable", |C0|)
	Call co.ReplaceItemValue("$Abstract", "")
	Call co.ReplaceItemValue("$HFFlags", |1|)
	Call co.ReplaceItemValue("StartTimeZone", |Z=3$DO=1$DL=10 3 7 2 3 7$ZX=30$ZN=E. South America|)
	Call co.ReplaceItemValue("SchedulerSwitcher", |1|)
	Call co.ReplaceItemValue("EndTimeZone", |Z=3$DO=1$DL=10 3 7 2 3 7$ZX=30$ZN=E. South America|)
	Call co.ReplaceItemValue("$IconSwitcher", |Reminder|)
	Call co.ReplaceItemValue("$Alarm", 1)
	Call co.ReplaceItemValue("$AlarmMemoOptions", "")
	Call co.ReplaceItemValue("$AlarmOffset", 0)
	Call co.ReplaceItemValue("$AlarmUnit", "M")
	Call co.ReplaceItemValue("Alarms", "1")
	Call co.ReplaceItemValue("HideFromCalendar", "1")
	Call co.ReplaceItemValue("Subject", doc.Codigo(0) + " - " + doc.FollowUp(0) + " - " + doc.ContatoComercial(0) + " - Tel.: " + doc.TelComercial(0))
	Dim ligacao As NotesRichTextItem
	Set ligacao = co.CreateRichTextItem( "Body" )
	Call ligacao.AppendDocLink( doc, "Link para o Negócio "+ doc.Codigo(0) )
	Call ligacao.AppendText( doc.FollowUp(0) )                    
	Call ligacao.AddNewLine( 1 )
	Call ligacao.AppendText( doc.ContatoComercial(0) )                    
	Call ligacao.AddNewLine( 1 )
	Call ligacao.AppendText( "Telefones: " )                    
	Call ligacao.AppendText( doc.TelComercial(0) )
	Call ligacao.AddNewLine( 1 )
	Call ligacao.AppendText( doc.Descricao(0) )
	Call ligacao.AddNewLine( 1 )
	Dim compute As Boolean
	compute = co.ComputeWithForm(False, False)
	'If compute Then
		Call co.Save(True,False)
		MsgBox "Contato Incluído na Agenda de " & db.Title & " em " & Format(datetime.Dateonly, "dd/mm/yyyy"),64, "Contato Agendado: " & doc.Codigo(0)
	'Else
	'	MsgBox "Não foi possível incluir o contato na Agenda de " & db.Title, 16, "Erro no Agendamento: " & doc.Codigo(0)
	'End If
	Call co.PutInFolder( "$Alarms" )
				
End Sub

'++LotusScript Development Environment:2:1:GetFator:5:8
%REM
	Function GetFator
	Description: Comments for Function
%END REM
Function GetFator(area As String, fase As String) As Double
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim config As NotesDocument
	Dim key(1) As String
	key(0) = area
	key(1) = fase
	Set view = db.Getview("(Configuracao/FatorRateio)")
	Set config = view.GetDocumentBykey(key, True)
	If Not config Is Nothing Then
		GetFator = config.Fator(0)
	Else
		GetFator = 1
	End If
	
End Function

'++LotusScript Development Environment:2:1:CheckMgServicos:5:8
%REM
	Function CheckMgServicos
	Description: Comments for Function
%END REM
Function CheckMgServicos(doc As NotesDocument) As Boolean
	
	'Margem Mínima de Serviços
	Dim margemMinimaServicos As Double
	If CStr(doc.MgAprovada(0)) <> "" And doc.StatusMg(0) = "Aprovado" Then margemMinimaServicos = doc.MgAprovada(0) Else margemMinimaServicos = doc.MgServicosM(0)
	If margemMinimaServicos > doc.MgServicosM(0) Then margemMinimaServicos = doc.MgServicosM(0)
	If Val(doc.TotServicos(0)) > 0 And doc.ResS_P(0) < margemMinimaServicos Then
		CheckMgServicos = True
	End If
	
End Function

'++LotusScript Development Environment:2:1:CkAceite:1:8
Function CkAceite (doc As NotesDocument) As Boolean
	
    'Verificando se o Aceite foi anexado
	Dim rtitem As NotesRichTextItem
	Set rtitem = doc.GetFirstItem( "Aceite" )
	If Not( rtItem Is Nothing ) Then
		If ( rtitem.Type = RICHTEXT ) Then
			If Not( Isempty( rtitem.EmbeddedObjects ) ) Then
				CkAceite = True
				Exit Function          
			End If          
		End If
	End If
	
End Function



'++LotusScript Development Environment:2:1:CkNegocioPrincipal:1:8
Function CkNegocioPrincipal(Source As NotesUIDocument) As Boolean
	
	CkNegocioPrincipal = True
	'Verifica o Negócio Principal
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Set db = New NotesDatabase(session.Currentdatabase.Server, "sales.nsf")
	If Source.FieldGetText("Classe") = "Adendo" Then
		If Source.FieldGetText("NegocioPrincipal") = "" Then Exit Function
		Set view = db.GetView("(NegociosPrincipal)")
		Set doc = view.GetDocumentByKey(Source.FieldGetText("NegocioPrincipal"), True)
		If doc Is Nothing Then
			MsgBox "Negócio Principal do Adendo Inválido", 16, "Erro !"
			CkNegocioPrincipal = False
			Exit Function
		Else
			If Source.FieldGetText("CodCliente") <> doc.CodCliente(0) Then
				MsgBox "O Codigo do Cliente não pode ser diferente do Negócio Principal", 16, "Erro !"
				CkNegocioPrincipal = False
				Exit Function
			End If
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:LinkDespesasPopup:5:8
%REM
	Sub LinkDespesasPopup
	Description: Comments for Sub
%END REM
Sub LinkDespesasPopup(negocio As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "caixa.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim pos As String
	'Dim total As Double
	If negocio.HasItem("DocLinks") Then negocio.RemoveItem("DocLinks")
	Set view = db.Getview("(DespesasNegocio)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	%REM
	'Total de Comissões
	If negocio.Tipo(0) = "DespesasComissoes" Then
		Set doc = dc.GetFirstDocument
		Do Until doc Is Nothing
			If doc.ClassificacaoDespesa(0) = "Comissoes" Then
				total = total + doc.TotTot(0)
			End If
			Set doc = dc.GetNextDocument(doc)
		Loop
	End If
	'Total de Encargos
	If negocio.Tipo(0) = "DespesasEncargos" Then
		Set doc = dc.GetFirstDocument
		Do Until doc Is Nothing
			If doc.ClassificacaoDespesa(0) = "Salarios - Comissões" Or doc.ClassificacaoDespesa(0) = "Encargos - INSS - Comissões" Or doc.ClassificacaoDespesa(0) = "Encargos - FGTS - Comissões" Then
				total = total + doc.TotTot(0)
			End If
			Set doc = dc.GetNextDocument(doc)
		Loop
	End If
	'Participações
	If negocio.Tipo(0) = "DespesasParticipacoes" Then
		Set doc = dc.GetFirstDocument
		Do Until doc Is Nothing
			If doc.ClassificacaoDespesa(0) = "Participação em Resultado" Then
				total = total + doc.TotTot(0)
			End If
			Set doc = dc.GetNextDocument(doc)
		Loop
	End If
	'Total de Serviços Internos
	If negocio.Tipo(0) = "DespesasServicosInternos" Then
		Set doc = dc.GetFirstDocument
		Do Until doc Is Nothing
			If doc.ClassificacaoDespesa(0) = "Transferência Interna" Then
				total = total + doc.TotTot(0)
			End If
			Set doc = dc.GetNextDocument(doc)
		Loop
	End If
	%END REM
		
	Dim rtitem As NotesRichTextItem
	Set rtitem = negocio.CreateRichTextItem("DocLinks")
	'Define o Estilo
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 8
	richStyle.NotesColor = COLOR_BLACK
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	pos = InStr(negocio.Title(0), " -")
	Call rtitem.AppendText(Left(negocio.Title(0), pos - 1 ))
	%REM
	If total > 0 Then
		Call rtitem.AppendStyle(richStyle)
		Call rtitem.AppendText(" R$ " & Format(total, "standard"))
	End If
	%END REM
	Call rtitem.AddNewLine(1)
	richStyle.NotesColor = COLOR_BLUE
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	
	'Despesas Comissões
	If negocio.Tipo(0) = "DespesasComissoes" Then
		Set doc = dc.GetFirstDocument
		Do Until doc Is Nothing
			If doc.ClassificacaoDespesa(0) = "Comissoes" Then
				Call rtitem.AppendDocLink(doc, "Link para a Despesa")
				Call rtitem.AppendText(doc.VencimentoDespesa(0) & " ")
				Call rtitem.AppendText(doc.Sit(0) & " ")
				Call rtitem.AppendText(doc.ClassificacaoDespesa(0) & " ")
				Call rtitem.AppendText(doc.ResponsavelDespesa(0) & " ")
				If doc.Sit(0) = "OK" Then
					Call rtitem.AppendText("em " & doc.Pagamento(0) & " ")
					Call rtitem.AppendText("Nº Cheque " & doc.NCheque(0) & " ")
					Call rtitem.AppendText(doc.Banco(0) & " ")
				End If
				Call rtitem.AppendText("R$ " & Format(doc.TotTot(0), "Standard"))        
				Call rtitem.AddNewLine(1)
			End If
			Set doc = dc.GetNextDocument(doc)
		Loop
	End If
	
	'Despesas Encargos
	If negocio.Tipo(0) = "DespesasEncargos" Then
		Set doc = dc.GetFirstDocument
		Do Until doc Is Nothing
			If doc.ClassificacaoDespesa(0) = "Salarios - Comissões" Or doc.ClassificacaoDespesa(0) = "Encargos - INSS - Comissões" Or doc.ClassificacaoDespesa(0) = "Encargos - FGTS - Comissões" Then
				Call rtitem.AppendDocLink(doc, "Link para a Despesa")
				Call rtitem.AppendText(doc.VencimentoDespesa(0) & " ")
				Call rtitem.AppendText(doc.Sit(0) & " ")
				Call rtitem.AppendText(doc.ClassificacaoDespesa(0) & " ")
				Call rtitem.AppendText(doc.ResponsavelDespesa(0) & " ")
				If doc.Sit(0) = "OK" Then
					Call rtitem.AppendText("em " & doc.Pagamento(0) & " ")
					Call rtitem.AppendText("Nº Cheque " & doc.NCheque(0) & " ")
					Call rtitem.AppendText(doc.Banco(0) & " ")
				End If
				Call rtitem.AppendText("R$ " & Format(doc.TotTot(0), "Standard"))        
				Call rtitem.AddNewLine(1)
			End If
			Set doc = dc.GetNextDocument(doc)
		Loop
	End If
	
	'Participações
	If negocio.Tipo(0) = "DespesasParticipacoes" Then
		Set doc = dc.GetFirstDocument
		Do Until doc Is Nothing
			If doc.ClassificacaoDespesa(0) = "Participação em Resultado" Then
				Call rtitem.AppendDocLink(doc, "Link para a Despesa")
				Call rtitem.AppendText(doc.VencimentoDespesa(0) & " ")
				Call rtitem.AppendText(doc.Sit(0) & " ")
				Call rtitem.AppendText(doc.ClassificacaoDespesa(0) & " ")
				Call rtitem.AppendText(doc.ResponsavelDespesa(0) & " ")
				If doc.Sit(0) = "OK" Then
					Call rtitem.AppendText("em " & doc.Pagamento(0) & " ")
					Call rtitem.AppendText("Nº Cheque " & doc.NCheque(0) & " ")
					Call rtitem.AppendText(doc.Banco(0) & " ")
				End If
				Call rtitem.AppendText("R$ " & Format(doc.TotTot(0), "Standard"))        
				Call rtitem.AddNewLine(1)
			End If
			Set doc = dc.GetNextDocument(doc)
		Loop
	End If
		
	'Serviços Internos
	If negocio.Tipo(0) = "DespesasServicosInternos" Then
		Set doc = dc.GetFirstDocument
		Do Until doc Is Nothing
			If doc.ClassificacaoDespesa(0) = "Transferência Interna" Then
				Call rtitem.AppendDocLink(doc, "Link para a Despesa")
				Call rtitem.AppendText(doc.VencimentoDespesa(0) & " ")
				Call rtitem.AppendText(doc.Sit(0) & " ")
				Call rtitem.AppendText(doc.ClassificacaoDespesa(0) & " ")
				Call rtitem.AppendText(doc.ResponsavelDespesa(0) & " ")
				If doc.Sit(0) = "OK" Then
					Call rtitem.AppendText("em " & doc.Pagamento(0) & " ")
					Call rtitem.AppendText("Nº Cheque " & doc.NCheque(0) & " ")
					Call rtitem.AppendText(doc.Banco(0) & " ")
				End If
				Call rtitem.AppendText("R$ " & Format(doc.TotTot(0), "Standard"))        
				Call rtitem.AddNewLine(1)
			End If
			Set doc = dc.GetNextDocument(doc)
		Loop
	End If
	
End Sub

'++LotusScript Development Environment:2:1:GetFatorPMO:5:8
%REM
	Function GetFatorPMO
	Description: Comments for Function
%END REM
Function GetFatorPMO(area As String) As Double
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "pessoal.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim cont As Integer
	Set view = db.Getview("(Funcionarios/Area)")
	Set dc = view.Getalldocumentsbykey(area, True)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If doc.PMO(0) = "Sim" Then
			cont = cont + 1
		End If
		Set doc = dc.Getnextdocument(doc)
	Loop
	If dc.Count > 0 Then GetFatorPMO = Round(cont/dc.Count, 2)
	
End Function

'++LotusScript Development Environment:2:2:ConverteListaMateriais:5:8
%REM
	Sub ConverterListaMateriais
	Description: Comments for Sub
%END REM
Sub ConverteListaMateriais(negocio As NotesDocument)
	
	On Error Resume Next
	Dim item As String
	Dim scan As Integer, scan2 As Integer, scan3 As Integer, answer As Integer, x As Integer
	Dim q As Variant, qFat As Variant, qProjeto As Variant, ck As Boolean
	'Consistências
	answer = MessageBox("Você confirma a conversão para a Lista CPS dos itens indicados ?", 4+32+256+4096, "Convesão da Lista de Materiais")
	If answer <> 6  Then
		Exit Sub
	End If
	For scan = 0 To 49
		q = negocio.GetItemValue("Q_" & scan)
		qFat = negocio.GetItemValue("QFat_" & scan)
		If CStr(q(0)) <> "" And CStr(qFat(0)) <> "" Then
			'Verifica Quantidade no Negócio e Quantidade de Faturamento
			If qFat(0) > q(0) Then
				If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
				scan2 = scan2 + 1
			End If
			scan3 = scan3 + 1
		End If
	Next
	If scan2 > 0 Then
		MsgBox "A quantidade de Convesão não pode ser maior do que a quantidade do Negócio no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Negócio.", 16, "Erro na Conversão da Lista de Materiais"
		Exit Sub
	End If
	If scan3 = 0 Then
		MsgBox "Você não informou nenhum item da Lista de Materiais para ser Convertido para CPS/Terceiros." & Chr(10) & "Informe no campo Saldos a Faturar", 16, "Erro na Conversão da Lista de Materiais"
		Exit Sub
	End If
	'Fim das Consistências
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim projeto As NotesDocument
	Dim array As Variant, chave As String, chaveProjeto As String
	Set view = db.GetView("(ProjetosCodigo)")
	Set projeto = view.GetDocumentByKey(negocio.Codigo(0), True)
	If projeto Is Nothing Then Exit Sub
	For scan = 0 To 49
		q = negocio.GetItemValue("Q_" & scan)
		qFat = negocio.GetItemValue("QFat_" & scan)
		If Val(qFat(0)) > 0 Then
			'Copia item para a Lista CPS/Terceiros do Projeto
			For scan2 = 0 To 49
				ck = False
				array = projeto.Getitemvalue("Produto_" & scan2)
				If array(0) = "" Then
					Call projeto.ReplaceItemValue("Q_" & scan2, qFat(0))
					array = negocio.Getitemvalue("PartNo_" & scan)
					Call projeto.ReplaceItemValue("PartNo_" & scan2, array(0))
					array = negocio.Getitemvalue("Produto_" & scan)
					Call projeto.ReplaceItemValue("Produto_" & scan2, array(0))
					array = negocio.Getitemvalue("t_" & scan)
					Call projeto.ReplaceItemValue("t_" & scan2, array(0))
					array = negocio.Getitemvalue("Un_" & scan)
					Call projeto.ReplaceItemValue("Un_" & scan2, array(0))
					array = negocio.Getitemvalue("CF_" & scan)
					Call projeto.ReplaceItemValue("CF_" & scan2, array(0))
					array = negocio.Getitemvalue("ST_" & scan)
					Call projeto.ReplaceItemValue("ST_" & scan2, array(0))
					array = negocio.Getitemvalue("Fabricante_" & scan)
					Call projeto.ReplaceItemValue("Fabricante_" & scan2, array(0))
					array = negocio.Getitemvalue("UFCompra_" & scan)
					Call projeto.ReplaceItemValue("UFCompra_" & scan2, array(0))
					array = negocio.Getitemvalue("ICC_" & scan)
					Call projeto.ReplaceItemValue("ICC_" & scan2, array(0))
					array = negocio.Getitemvalue("us_" & scan)
					Call projeto.ReplaceItemValue("us_" & scan2, array(0))
					array = negocio.Getitemvalue("CustoFOB_" & scan)
					Call projeto.ReplaceItemValue("CustoFOB_" & scan2, array(0))
					array = negocio.Getitemvalue("FI_" & scan)
					Call projeto.ReplaceItemValue("FI_" & scan2, array(0))
					array = negocio.Getitemvalue("Custo_" & scan)
					Call projeto.ReplaceItemValue("Custo_" & scan2, array(0))
					array = negocio.Getitemvalue("ICMSSTC_" & scan)
					Call projeto.ReplaceItemValue("ICMSSTC_" & scan2, array(0))
					array = negocio.Getitemvalue("Mg_" & scan)
					Call projeto.ReplaceItemValue("Mg_" & scan2, array(0))
					array = negocio.Getitemvalue("Custo_" & scan)
					Call projeto.ReplaceItemValue("CustoUnit_" & scan2, array(0))
					Call projeto.ReplaceItemValue("CusTot_" & scan2, array(0) * qFat(0))
					array = negocio.Getitemvalue("IC_" & scan)
					Call projeto.ReplaceItemValue("IC_" & scan2, array(0))
					array = negocio.Getitemvalue("ICD_" & scan)
					Call projeto.ReplaceItemValue("ICD_" & scan2, array(0))
					array = negocio.Getitemvalue("IP_" & scan)
					Call projeto.ReplaceItemValue("IP_" & scan2, array(0))
					array = negocio.Getitemvalue("II_" & scan)
					Call projeto.ReplaceItemValue("II_" & scan2, array(0))
					Call projeto.ComputeWithForm(False, False)
					Call projeto.Save( False, False )
					ck = True
					Exit For
				End If
			Next
AtualizaNegocio:
			'Linhas do CPS/Terceiros do Projeto esgotadas
			If Not ck Then
				MsgBox "Todas as linhas do CPS/Terceiros do Projeto já estão ocupadas.", 64, "Os itens não puderam ser convertidos."
				Exit Sub
			Else
				'Item criado no Projeto
				If ck Then
					'Exclui item do Negócio
					If qFat(0) - q(0) = 0 Then
						Call negocio.ReplaceItemValue("Q_" & scan, "")
						Call negocio.ReplaceItemValue("PartNo_" & scan, "")
						Call negocio.ReplaceItemValue("Produto_" & scan, "")
						Call negocio.ReplaceItemValue("t_" & scan, "")
						Call negocio.ReplaceItemValue("Un_" & scan, "")
						Call negocio.ReplaceItemValue("CF_" & scan, "")
						Call negocio.ReplaceItemValue("ST_" & scan, "")
						Call negocio.ReplaceItemValue("Fabricante_" & scan, "")
						Call negocio.ReplaceItemValue("UFCompra_" & scan, "")
						Call negocio.ReplaceItemValue("ICC_" & scan, "")
						Call negocio.ReplaceItemValue("us_" & scan, "R$")
						Call negocio.ReplaceItemValue("CustoFOB_" & scan, "")
						Call negocio.ReplaceItemValue("FI_" & scan, "")
						Call negocio.ReplaceItemValue("Custo_" & scan, "")
						Call negocio.ReplaceItemValue("ICMSSTC_" & scan, "")
						Call negocio.ReplaceItemValue("Mg_" & scan, "")
						Call negocio.ReplaceItemValue("CustoUnit_" & scan, "")
						Call negocio.ReplaceItemValue("CusTot_" & scan, 0)
						Call negocio.ReplaceItemValue("VendaTot_" & scan, 0)
						Call negocio.ReplaceItemValue("IC_" & scan, "")
						Call negocio.ReplaceItemValue("ICD_" & scan, "")
						Call negocio.ReplaceItemValue("IP_" & scan, "")
						Call negocio.ReplaceItemValue("II_" & scan, "")
						Call negocio.ReplaceItemValue("QFat_" & scan, "")
						'Atualiza a Quantidade do Negócio
					Else
						Call negocio.ReplaceItemValue("Q_" & scan, q(0) - qFat(0))
					End If
				End If
				Call negocio.Save( False, False )
			End If
		End If
	Next
	'Salva Lista CPS
	Call SaveListaMateriais(projeto)
	
End Sub

'++LotusScript Development Environment:2:2:GeraDespesasEncargosSociais:5:8
%REM
	Sub GeraDespesasEncargosSociais
	Description: Comments for Sub
%END REM
Sub GeraDespesasEncargosSociais(negocio As NotesDocument)
	
	If negocio.CheckPagtoEncargosSociais(0) = "OK" Then Exit Sub
	Dim doc As Variant, ccDespesa As Variant
	Dim scan As Integer
	Dim venc As NotesDateTime
	ReDim classificacao(4) As String, vencimento(4) As String, adianta(4) As Boolean, descricao(4) As String, valor(4) As Double
	'DSR
	Set venc = New NotesDateTime(negocio.VencDSR(0) & "/" & Format(Today, "mm/yyyy"))
	Call venc.Adjustmonth(2)
	classificacao(0) = "Salarios - Comissões"
	vencimento(0) = venc.Dateonly
	If negocio.AdDSR(0) = "S" Then
		adianta(0) = True
	End If
	descricao(0) = "DSR sobre Comissão de Negócio - " & negocio.Codigo(0)
	valor(0) = negocio.BCPremio_R(0) * negocio.DSR(0)
	'INSS
	Set venc = New NotesDateTime(negocio.VencINSS(0) & "/" & Format(Today, "mm/yyyy"))
	Call venc.Adjustmonth(2)
	classificacao(1) = "Encargos - INSS - Comissões"
	vencimento(1) = venc.Dateonly
	If negocio.AdINSS(0) = "S" Then
		adianta(1) = True
	End If
	descricao(1) = "INSS sobre Comissão de Negócio - " & negocio.Codigo(0)
	valor(1) = negocio.BCPremio_R(0) * negocio.INSS(0)
	'FGTS
	Set venc = New NotesDateTime(negocio.VencFGTS(0) & "/" & Format(Today, "mm/yyyy"))
	Call venc.Adjustmonth(2)
	classificacao(2) = "Encargos - FGTS - Comissões"
	vencimento(2) = venc.Dateonly
	If negocio.AdFGTS(0) = "S" Then
		adianta(2) = True
	End If
	descricao(2) = "FGTS sobre Comissão de Negócio - " & negocio.Codigo(0)
	valor(2) = negocio.BCPremio_R(0) * negocio.FGTS(0)
	'13º Salário
	Set venc = New NotesDateTime(negocio.VencDecimoTerceiro(0) & "/" & Year(Today))
	classificacao(3) = "Salarios - Comissões"
	vencimento(3) = venc.Dateonly
	If negocio.AdDecimoTerceiro(0) = "S" Then
		adianta(3) = True
	End If
	descricao(3) = "Décimo Terceiro sobre Comissão de Negócio - " & negocio.Codigo(0)
	valor(3) = negocio.BCPremio_R(0) * negocio.DecimoTerceiro(0)
	'Ferias
	Set venc = New NotesDateTime(negocio.VencFerias(0) & "/" & Year(Today))
	classificacao(4) = "Salarios - Comissões"
	vencimento(4) = venc.Dateonly
	If negocio.AdFerias(0) = "S" Then
		adianta(4) = True
	End If
	descricao(4) = "Férias sobre Comissão de Negócio - " & negocio.Codigo(0)
	valor(4) = negocio.BCPremio_R(0) * negocio.Ferias(0)
	'Gera Despesas
	For scan = 0 To UBound(descricao)
		If valor(scan) > 0 Then
			Set doc = New ccDespesa(negocio)
			doc.Origem = "Negócio - " & negocio.Codigo(0)
			doc.Codigo = negocio.Codigo(0)
			doc.Sit = "Pendente"
			doc.Classificacao = classificacao(scan)
			doc.Area = negocio.AreaVendas(0)
			doc.Responsavel = negocio.GerenteConta(0)
			doc.Data = Today
			doc.Vencimento = vencimento(scan)
			doc.Adianta = adianta(scan)
			doc.Descricao = descricao(scan)
			doc.Valor = Round(valor(scan), 2)
			doc.TipoCompra = negocio.TipoCompra(0)
			doc.TipoVenda = negocio.TipoVenda(0)
			Call doc.Save
		End If
	Next
	negocio.CheckPagtoEncargosSociais = "OK"
	
End Sub

'++LotusScript Development Environment:2:1:CkDataCQ:1:8
Function CkDataCQ(Source As NotesUIDocument) As Boolean
	
	ckDataCQ = True
	Dim data As New NotesDateTime (Today)
	If Source.FieldGetText("ProxDataCQ") = "" Then
		Msgbox "Favor preencher a Próxima Data do Controle de Qualidade", 16, "Erro"
		Call Source.GotoField("ProxDataCQ")
		CkDataCQ = False
	Elseif Cdat(Source.FieldGetText("ProxDataCQ")) < Cdat(data.DateOnly) Then
		Msgbox "A Próxima Data do Controle de Qualidade não pode ser menor do que hoje", 16, "Erro"
		Call Source.GotoField("ProxDataCQ")
		CkDataCQ = False
	End If
	
End Function

'++LotusScript Development Environment:2:1:CalcIS:1:8
Function CalcIS (doc As NotesDocument) As Double
	'Retenção de ISS para SW e SV
	
	Dim answer As Integer
	If doc.Sit(0) = "A Emitir" Then
		If doc.CodClienteFatura(0) = "UNICREDPOA" And doc.Cidade(0) <> "São Paulo" And (doc.Tipo(0) = "Serviços" Or doc.Tipo(0) = "Software") Then
			answer = MessageBox( "Gerar Retenção de ISS (2%)?", 4+32+256+4096, "Emissão de Nota com Retenção de ISS (2%)" )
			If answer = 6  Then
				CalcIS = doc.TotalServicos(0) * 0.02
			End If
		End If
	Else
		CalcIS = doc.ISS(0)
	End If
	
End Function


'++LotusScript Development Environment:2:1:CheckDesfechamento:5:8
%REM
	Function CheckDesfechamentoDoc
	Description: Comments for Function
%END REM
Function CheckDesfechamento(negocio As NotesDocument)
	
	'Verifica se já houve Compra, Baixa, Faturamento, Planilha Financeira e Time Sheet de Execução
	Dim listas As New NotesDatabase(negocio.ParentDatabase.Server,"listas.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Set view = listas.GetView("(NegocioForm)")
	'Itens
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "Item", False)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.QFat(0) <> 0 Then
			CheckDesfechamento = False
			MsgBox "O ítem "& doc.Produto(0) & " já foi faturado. O Negócio não pode ser desfechado.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		ElseIf doc.QBaixa(0) <> 0 Then
			CheckDesfechamento = False
			MsgBox "O Ítem " & doc.Produto(0) & " já teve Baixa de Compra." + Chr(10) + "Os itens devem ser transferidos para o Estoque TDec através de Requisição Administrativa ou utilizados em outro negócio.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		ElseIf doc.QPreBaixa(0) <> 0 Then
			CheckDesfechamento = False
			MsgBox "O Ítem " & doc.Produto(0) & " já teve Pré-Baixa de Compra." + Chr(10) + "A Pré-Baixa e o Pedido de Compra devem ser cancelados.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		ElseIf Val(doc.QSimplesFaturamento(0)) <> 0 Then
			CheckDesfechamento = False
			MsgBox "O Ítem " & doc.Produto(0) & " já teve Baixa de Simples Faturamento." + Chr(10) + "A Baixa e o Pedido de Compra devem ser cancelados.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		ElseIf doc.QCompra(0) <> 0 Then
			CheckDesfechamento = False 
			MsgBox "O ítem "& doc.Produto(0) & " tem pedido colocado no Fornecedor." + Chr(10) + "O Pedido de Compra deve ser cancelado.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		End If
		Set doc = dc.GetNextDocument( doc )
	Loop
	'Serviços
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "Servico", False)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		If doc.VlFat(0) > 0 Then
			CheckDesfechamento = False 
			MsgBox "O Serviço "& doc.Produto(0) & " já foi faturado. O Negócio não pode ser desfechado.", 16, "Erro no Item: " & doc.NServico(0)
			Exit Function
		End If
		Set doc = dc.GetNextDocument( doc )
	Loop
	'Lista CPS e Compras de Cotação Financeira
	Set dc = view.GetAllDocumentsByKey(negocio.Codigo(0) & "-", False)
	Set doc = dc.Getfirstdocument()
	Do Until doc Is Nothing
		If doc.QFat(0) <> 0 Then
			CheckDesfechamento = False
			MsgBox "O ítem "& doc.Produto(0) & " já foi faturado. O Negócio não pode ser desfechado.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		ElseIf doc.QBaixa(0) <> 0 Then
			CheckDesfechamento = False
			MsgBox "O Ítem " & doc.Produto(0) & " já teve Baixa de Compra." + Chr(10) + "Os itens devem ser transferidos para o Estoque TDec através de Requisição Administrativa ou utilizados em outro negócio.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		ElseIf doc.QPreBaixa(0) <> 0 Then
			CheckDesfechamento = False
			MsgBox "O Ítem " & doc.Produto(0) & " já teve Pré-Baixa de Compra." + Chr(10) + "A Pré-Baixa e o Pedido de Compra devem ser cancelados.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		ElseIf Val(doc.QSimplesFaturamento(0)) <> 0 Then
			CheckDesfechamento = False
			MsgBox "O Ítem " & doc.Produto(0) & " já teve Baixa de Simples Faturamento." + Chr(10) + "A Baixa e o Pedido de Compra devem ser cancelados.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		ElseIf doc.QCompra(0) <> 0 Then
			CheckDesfechamento = False 
			MsgBox "O ítem "& doc.Produto(0) & " tem pedido colocado no Fornecedor." + Chr(10) + "O Pedido de Compra deve ser cancelado.", 16, "Erro no Item: " & doc.NItem(0)
			Exit Function
		End If
		Set doc = dc.GetNextDocument( doc )
	Loop
	'Verifica o Total Faturado - LMO 29/11/16
	If Val(negocio.TotalFaturado(0)) > 0 Then
		CheckDesfechamento = False
		MsgBox "O Negócio já teve Faturamento, não pode ser Desfechado. Solicite atualização dos Saldos de Faturamento ao Desenvolvimento", 16, "Desfechamento de Negócio"
		Exit Function
	End If
	'Verifica se teve despesas na Planilha Financeira
	Call MgReal(negocio)
	If Val(negocio.PF_R(0)) > 0 Or Val(negocio.Despesas_R(0)) > 0 Then
		CheckDesfechamento = False
		MsgBox "O Negócio já teve despesas de Planilha Financeira, não pode ser Desfechado.", 16, "Desfechamento de Negócio"
		Exit Function
	End If
	'Time Sheet - Verifica se teve Horas de Execução de Projeto
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server,"timesheet.nsf")
	Dim chave(1) As String
	chave(0) = negocio.Codigo(0)
	chave(1) = "Projeto"
	Set view = db.Getview("(TimeSheet/Codigo)")
	Set dc = view.Getalldocumentsbykey(chave, True)
	If dc.Count > 0 Then
		CheckDesfechamento = False 
		MsgBox "O Negócio já teve Horas de Execução, não pode ser Desfechado.", 16, "Desfechamento de Negócio"
		Exit Function
	End If
	'Time Sheet - Verifica se teve Horas de Execução de Contrato
	chave(1) = "Contrato"
	Set view = db.Getview("(TimeSheet/Codigo)")
	Set dc = view.Getalldocumentsbykey(chave, True)
	If dc.Count > 0 Then
		CheckDesfechamento = False 
		MsgBox "O Negócio já teve Horas de Execução, não pode ser Desfechado.", 16, "Desfechamento de Negócio"
		Exit Function
	End If
	CheckDesfechamento = True
	
End Function

'++LotusScript Development Environment:2:2:AlteraListaMateriais:1:8
Sub AlteraListaMateriais(uidoc As NotesUIDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim listas As New NotesDatabase(uidoc.Document.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	If uidoc.Document.Form(0) = "Projeto" Then
		Set view = listas.GetView("(NegocioNPlanilhas)")
	Else
		Set view = listas.GetView("(NegocioNItens)")
	End If
	Dim doc As NotesDocument
	Dim dc As NotesDocumentCollection
	Dim item As NotesDocument
	Dim array As Variant, scan As Integer
	Dim codigo As String
	Dim custoFOB As Double, fi As Double, icmsstC As Double, icmsst As Double, icmsstListas As Double, bcICMSST As Double, fcp As Double, ipc As Double, aliquotaPIS As Double, aliquotaCOFINS As Double
	Dim flag As Variant, boxtype As Long, answer As Integer
	codigo$ = uidoc.FieldGetText("Codigo")
	Dim ligacao As NotesRichTextItem                            
	'Verifica se todos os dados da Lista de Materiais estão preenchidos
	If Not checkItensLista( uidoc ) Then
		MsgBox "Os itens não foram atualizados em Listas", 16, "Erro"
		Exit Sub
	End If
	'*** Solicita Aprovação da Margem do Negócio ***
	If CheckMgNegocio(uidoc.Document) Then
		answer = MessageBox("A Margem do Negócio é menor que " & uidoc.FieldGetText("Resultado") & Chr(10) & "Deseja solicitar aprovação da Diretoria?", 4+32+256+4096, "Alterar Lista de Mateiais")
		If answer = 6 Then
			Call SolicitaAprovacaoMargemFatorInferior(uidoc.Document, "Margem Negócio")
			uidoc.Document.SaveOptions = "0"
			uidoc.Close
			Exit Sub
		Else
			MsgBox "Os itens não foram atualizados em Listas", 16, "Erro"
			Call LoadListaMateriais(uidoc.Document)
			Exit Sub
		End If
	'*** Solicita Aprovação da Margem de Revenda ***
	ElseIf CheckMgRevenda(uidoc.Document) Then
		answer = MessageBox("A Margem de Revenda é menor que " & uidoc.FieldGetText("MgRevendaM") & Chr(10) & "Deseja solicitar aprovação da Diretoria?", 4+32+256+4096, "Alterar Lista de Mateiais")
		If answer = 6 Then
			Call SolicitaAprovacaoMargemFatorInferior(uidoc.Document, "Margem Revenda")
			uidoc.Document.SaveOptions = "0"
			uidoc.Close
			Exit Sub
		Else
			MsgBox "Os itens não foram atualizados em Listas", 16, "Erro"
			Call LoadListaMateriais(uidoc.Document)
			Exit Sub
		End If
	'*** Solicita Aprovação de Fator de Importação inferior ao Fator de Importação Mínimo ***
	ElseIf Not CheckFI(uidoc.Document, "Solicita Aprovação") Then
		answer = MessageBox("O FI Informado é menor que o FI Mínimo." & Chr(10) & "Fi Mínimo - HW: " & uidoc.FieldGetText("FI_HW")  & " - SW: " & uidoc.FieldGetText("FI_SW") & " - SV: " & uidoc.FieldGetText("FI_SV") & Chr(10) & "Deseja solicitar aprovação da Diretoria?", 4+32+256+4096, "Alterar Lista de Mateiais")
		If answer = 6 Then
			Call SolicitaAprovacaoMargemFatorInferior(uidoc.Document, "FI")
			uidoc.Document.SaveOptions = "0"
			uidoc.Close
			Exit Sub
		Else
			MsgBox "Os itens não foram atualizados em Listas", 16, "Erro"
			Call LoadListaMateriais(uidoc.Document)
			Exit Sub
		End If
	'*** Solicita Aprovação de Margem de Item ***
	ElseIf CheckMgItens(uidoc.Document) Then
		answer = MessageBox("Margem de Item inválida." & Chr(10) & "Deseja solicitar aprovação da Diretoria?", 4+32+256+4096, "Alterar Lista de Mateiais")
		If answer = 6 Then
			Call SolicitaAprovacaoMargemFatorInferior(uidoc.Document, "Margem Item")
			uidoc.Document.SaveOptions = "0"
			uidoc.Close
			Exit Sub
		Else
			MsgBox "Os itens não foram atualizados em Listas", 16, "Erro"
			Call LoadListaMateriais(uidoc.Document)
			Exit Sub
		End If
	'*** Altera a Lista de Materiais (Margem Maior ou Igual a Margem Prevista) ***
	Else
		For scan = 0 To 49
			If CStr(uidoc.FieldGetText("CustoFOB_" & scan)) = "" Then custoFOB = 0 Else custoFOB = CDbl(uidoc.FieldGetText("CustoFOB_" & scan))
			If CStr(uidoc.FieldGetText("FI_" & scan)) = "" Then fi = 0 Else fi = CDbl(uidoc.FieldGetText("FI_" & scan))
			If CStr(uidoc.FieldGetText("ICMSSTC_" & scan)) = "" Then icmsstC = 0 Else icmsstC = CDbl(uidoc.FieldGetText("ICMSSTC_" & scan))
			If CStr(uidoc.FieldGetText("ICMSST_" & scan)) = "" Then icmsst = 0 Else icmsst = CDbl(uidoc.FieldGetText("ICMSST_" & scan))
			If CStr(uidoc.Document.GetItemValue("BCICMSST_" & scan)(0)) = "" Then bcICMSST = 0 Else bcICMSST = CDbl(uidoc.Document.GetItemValue("BCICMSST_" & scan)(0))
			If CStr(uidoc.FieldGetText("FCP_" & scan)) = "" Then fcp = 0 Else fcp = CDbl(uidoc.FieldGetText("FCP_" & scan))
			If CStr(uidoc.FieldGetText("IPC_" & scan)) = "" Then ipc = 0 Else ipc = CDbl(uidoc.FieldGetText("IPC_" & scan))
			If CStr(uidoc.FieldGetText("AliquotaPIS_" & scan)) = "" Then aliquotaPIS = 0 Else aliquotaPIS = CDbl(uidoc.FieldGetText("AliquotaPIS_" & scan))
			If CStr(uidoc.FieldGetText("AliquotaCOFINS_" & scan)) = "" Then aliquotaCOFINS = 0 Else aliquotaCOFINS = CDbl(uidoc.FieldGetText("AliquotaCOFINS_" & scan))
			Set doc = view.getDocumentByKey(codigo & "-" & (scan+1), True)
			If Not(doc Is Nothing) Then
				'Dados de Listas
				If CStr(doc.ICMSST(0)) = "" Then icmsstListas = 0 Else icmsstListas = Round(doc.ICMSST(0),2)
				'Quantidade Comprada
				If Val(uidoc.FieldGetText("Q_" & scan)) < doc.QCompra(0) Then
					MsgBox "No Item " & (scan+1) & " a Quantidade do Negócio não pode ser menor do que a Quantidade Comprada: " & doc.QCompra(0), 16, "Quantidade menor que a compra."
				'Exclusão de Item
				ElseIf Val(uidoc.FieldGetText("Q_" & scan)) = 0 Then
					If  doc.QFat(0) <> 0 Then
						MsgBox "O Item " & (scan+1) & " já foi faturado e os dados de VALOR DE VENDA, QUANT, PRODUTO e MARGEM não podem ser alterados", 16, "Erro na Exclusão de Item"
					Else	
						boxType& = 4+32+256+4096
						answer% = MessageBox("Isto irá deletar o item, confirma a Deleção do item?" & (scan+1), boxType, "Você alterou a quantidade do ítem " & (scan+1) & " para zero!")
						If answer = 6 Then flag = doc.Remove(True)
					End If
				'Alteração de Item
				Else
					'Alteração de PartN, Produto, Tipo, UM, UFCompra, Moeda, Custo FOB, FI, Custo Unitário
					If uidoc.FieldGetText("PartNo_" & scan) <> doc.PartNo(0) Or uidoc.FieldGetText("Produto_" & scan) <> doc.Produto(0) Or uidoc.FieldGetText("T_" & scan) <> doc.T(0) Or uidoc.FieldGetText("Un_" & scan) <> doc.Un(0) Or uidoc.FieldGetText("UFCompra_" & scan) <> doc.UFCompra(0) Or uidoc.FieldGetText("US_" & scan) <> doc.US(0) Or custoFOB <> doc.CustoFOB(0) Or fi <> Round(doc.FI(0),2) Or CDbl(uidoc.FieldGetText("Custo_" & scan)) <> doc.Custo(0) Then
						'Alteração de Tipo - pode ser alterado entre SW/SV mesmo se já foi comprado, conforme gfogaca - LMO 17/02/25
						If (uidoc.FieldGetText("T_" & scan) = "SW" Or uidoc.FieldGetText("T_" & scan) = "SV") And (doc.T(0) = "SW" Or doc.T(0) = "SV") And (uidoc.FieldGetText("T_" & scan) <> doc.T(0)) Then
							doc.T =  uidoc.FieldGetText("T_" & scan)
						ElseIf doc.QCompra(0) <> 0 Then 'Tentativa de alteração de um ítem que já teve Pedido de Compra
							MsgBox "O Item " & (scan+1) & " já foi comprado e os dados de PARTN, PRODUTO, TIPO, UFCOMPRA, MOEDA, CUSTO FOB, FI e CUSTO não podem ser alterados", 16, "Erro na Alteração de Item"
						Else
							doc.PartNo = uidoc.FieldGetText("PartNo_" & scan)
							doc.Produto = uidoc.FieldGetText("Produto_" & scan)
							doc.T =  uidoc.FieldGetText("T_" & scan)
							doc.UFCompra = uidoc.FieldGetText("UFCompra_" & scan)
							doc.Us = uidoc.FieldGetText("Us_" & scan)
							doc.CustoFOB = custoFOB
							doc.FI = fi
							doc.Custo = CDbl(uidoc.FieldGetText("Custo_" & scan))
							doc.Mg = CDbl(uidoc.FieldGetText("Mg_" & scan))
							doc.CustoUnit = CDbl(uidoc.FieldGetText("CustoUnit_" & scan))
						End If
					'Alteração da Quantidade
					ElseIf CDbl(uidoc.FieldGetText("Q_" & scan)) <> doc.Q(0) Then
						If doc.QCompra(0) > CDbl(uidoc.FieldGetText("Q_" & scan)) Then  'Qtd não pode ser menor que Qtd Comprada
							MsgBox "No Item " & (scan+1) & " a Quantidade não pode ser menor que a Quantidade Comprada" & Chr(10) & "Qtd Comprada: " & doc.QCompra(0), 16, "Erro na Alteração de Quantidade"
						Else
							doc.Q = Val(uidoc.FieldGetText("Q_" & scan))
							doc.CusTot = Val(uidoc.FieldGetText("Q_" & scan)) * CDbl(uidoc.FieldGetText("CustoUnit_" & scan))
						End If
					'Alteração da Margem e do Valor de Venda
					ElseIf CDbl(uidoc.FieldGetText("Mg_" & scan)) <> doc.MG(0) Or CDbl(uidoc.FieldGetText("CustoUnit_" & scan)) <> doc.CustoUnit(0) Then
						If doc.QFat(0) <> 0 Then  'Tentativa de alteração da Margem e Valor de Venda de item que já teve faturamento
							MsgBox "O Item " & (scan+1) & " já foi faturado e os dados de MARGEM e VALOR DE VENDA não podem ser alterados", 16, "Erro na Alteração de Item"
						Else
							doc.Mg = CDbl(uidoc.FieldGetText("Mg_" & scan))
							doc.CustoUnit = CDbl(uidoc.FieldGetText("CustoUnit_" & scan))
							doc.CusTot = CDbl(uidoc.FieldGetText("CusTot_" & scan))
						End If
					End If
					doc.ICMSSTC = icmsstC
					doc.ICMSST = icmsst
					doc.BCICMSST = bcICMSST
					doc.Un = uidoc.FieldGetText("Un_" & scan)
					doc.CF = uidoc.FieldGetText("CF_" & scan)
					doc.ST = uidoc.FieldGetText("ST_" & scan)
					doc.Fabricante = uidoc.FieldGetText("Fabricante_" & scan)
					doc.UFVenda = uidoc.FieldGetText("UF")
					doc.ICC = CDbl(uidoc.FieldGetText("ICC_" & scan))
					doc.IC = CDbl(uidoc.FieldGetText("IC_" & scan))
					doc.ICD = CDbl(uidoc.FieldGetText("ICD_" & scan))
					doc.FCP = fcp
					doc.IPIC = ipc
					doc.IPI = CDbl(uidoc.FieldGetText("IP_" & scan))
					doc.II = CDbl(uidoc.FieldGetText("II_" & scan))
					doc.AliquotaPIS = aliquotaPIS
					doc.AliquotaCOFINS = aliquotaCOFINS
					Call doc.Save(True, True)
				End If
			Else
				'Incluir Item
				If uidoc.FieldGetText("Q_" & scan) <> "" Then
					Set doc = New NotesDocument(listas)
					doc.Form = "Item"
					doc.Autor = session.CommonUserName
					doc.Criacao = Now
					doc.Id = geraJavaId(doc)
					Set ligacao = doc.CreateRichTextItem("LinkNegocio")
					Call ligacao.AppendDocLink(uidoc.Document, "Link para o Negócio " & codigo)
					doc.Codigo = codigo
					doc.NItem = CStr(scan+1)
					doc.Q = CLng(uidoc.FieldGetText("Q_" & scan))
					doc.PartNo = uidoc.FieldGetText("PartNo_" & scan)
					doc.Produto = uidoc.FieldGetText("Produto_" & scan)
					doc.Un = uidoc.FieldGetText("Un_" & scan)
					doc.CF = uidoc.FieldGetText("CF_" & scan)
					doc.ST = uidoc.FieldGetText("ST_" & scan)
					doc.Fabricante = uidoc.FieldGetText("Fabricante_" & scan)
					doc.UFCompra = uidoc.FieldGetText("UFCompra_" & scan)
					doc.UFVenda = uidoc.FieldGetText("UF")
					doc.Us = uidoc.FieldGetText("Us_" & scan)
					doc.CustoFOB = custoFOB
					doc.FI = fi
					doc.Custo= CDbl(uidoc.FieldGetText("Custo_" & scan))
					doc.ICMSSTC = icmsstC
					doc.Mg = CDbl(uidoc.FieldGetText("Mg_" & scan))
					doc.CustoUnit = CDbl(uidoc.FieldGetText("CustoUnit_" & scan))
					doc.CusTot = CDbl(uidoc.FieldGetText("CusTot_" & scan))
					doc.ICMSST = icmsst
					doc.BCICMSST = bcICMSST
					doc.FIReal = 0
					doc.T = uidoc.FieldGetText("T_" & scan)
					doc.ICC = CDbl(uidoc.FieldGetText("ICC_" & scan))
					doc.IC = CDbl(uidoc.FieldGetText("IC_" & scan))
					doc.ICD = CDbl(uidoc.FieldGetText("ICD_" & scan))
					doc.FCP = fcp
					doc.IPIC = ipc
					doc.IPI = CDbl(uidoc.FieldGetText("IP_" & scan))
					doc.II = CDbl(uidoc.FieldGetText("II_" & scan))
					doc.AliquotaPIS = aliquotaPIS
					doc.AliquotaCOFINS = aliquotaCOFINS
					'Campos de Controle
					doc.QCompra = 0
					doc.VlCompra = 0
					doc.QDanfe = 0
					doc.QPreBaixa = 0
					doc.QSimplesFaturamento = 0
					doc.QBaixa = 0
					doc.QFat = 0
					doc.QRecibo = 0
					Call doc.Save(True, True)
				End If
			End If
		Next
		Call LoadListaMateriais(uidoc.Document)
		'Atualiza Cotação de Compra
		Call Cotacao(uidoc.Document)
	End If
	
End Sub

'++LotusScript Development Environment:2:1:WorkflowResumido:5:8
%REM
	Function WorkflowResumido
	Description: Comments for Function
%END REM
Function WorkflowResumido(codigo As String) As String
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "cablinglpu.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Set view = db.Getview("Contratos")
	Set doc = view.Getdocumentbykey(codigo, True)
	If Not doc Is Nothing Then
		If doc.WorkflowResumidoExec(0) = "Sim" Then
			WorkflowResumido = doc.FaseExec(0)
		End If
	End If
	
End Function


'++LotusScript Development Environment:2:1:CheckMgNegocio:5:8
%REM
	Function CheckMgNegocio
	Description: Comments for Function
%END REM
Function CheckMgNegocio(doc As NotesDocument) As Boolean
	
	'Margem Mínima do Negócio
	Dim margemMinima As Double
	If CStr(doc.MgAprovada(0)) <> "" And doc.StatusMg(0) = "Aprovado" Then margemMinima = doc.MgAprovada(0) Else margemMinima = doc.Resultado(0)
	If margemMinima > doc.Resultado(0) Then margemMinima = doc.Resultado(0)
	If Val(doc.TotalNegocio(0)) > 0 And doc.Res_P(0) < margemMinima Then
		CheckMgNegocio = True
	End If
	
End Function


'++LotusScript Development Environment:2:2:AvisoMgPrevista:5:8
%REM
	Sub AvisoMgPrevista
	Description: Comments for Sub
%END REM
Sub AvisoMgPrevista(doc As NotesDocument, tipo As String)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim nome As New NotesName(session.Effectiveusername)
	Dim db As NotesDatabase
	Dim rtitem As NotesRichTextItem
	'Estilo do Texto
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	Set db = session.Currentdatabase
	Dim recipients(1) As String
	'Email
	Dim memo As New NotesDocument (db)
	memo.Form = "Memo"
	memo.From = session.Commonusername
	Set rtitem = memo.CreateRichTextItem("Body")
	Call rtitem.AppendStyle(richStyle)
	If doc.Renovacao(0) = "Sim" Then
		Call rtitem.AppendText("Renovação: " & doc.Descricao(0))
	Else
		Call rtitem.AppendText(doc.TipoVenda(0) & ": " & doc.Descricao(0))
	End If
	Call rtitem.AddNewLine(1)
	If doc.DataFaturamentoFuturo(0) <> "" Then
		Call rtitem.AppendText("Data do Faturamento Futuro: " & doc.DataFaturamentoFuturo(0))
		Call rtitem.AddNewLine(1)
	End If
	If doc.Area(0) <> "" Then
		Call rtitem.AppendText("Area: " & doc.Area(0))
		Call rtitem.AddNewLine(1)
	End If
	If doc.Parceria(0) <> "" Then
		Call rtitem.AppendText("Parceria: " & doc.Parceria(0))
		Call rtitem.AddNewLine(1)
	End If
	If CStr(doc.PrazoPagamento(0)) <> "" Then
		Call rtitem.AppendText("Prazo de Pagamento do Cliente: " & doc.PrazoPagamento(0) & " dias")
		Call rtitem.AddNewLine(1)
	End If
	If CStr(doc.PrazoPagamentoFornecedor(0)) <> "" Then
		Call rtitem.AppendText("Prazo de Pagamento do Fornecedor: " & doc.PrazoPagamentoFornecedor(0) & " dias")
		Call rtitem.AddNewLine(1)
	End If
	'Recipients
	If tipo = "Aprovado" Or tipo = "Reprovado" Then
		recipients(0) = doc.GerenteConta(0)
		If doc.TipoAprovacao(0) = "Frete Revenda" Then
			recipients(1) = doc.SolicitadoPor_FreteRevenda(0)
		ElseIf doc.TipoAprovacao(0) = "Frete Projeto" Then
			recipients(1) = doc.SolicitadoPor_FreteProjeto(0)
		ElseIf doc.TipoAprovacao(0) = "Margem Item" Then
			recipients(1) = doc.SolicitadoPor_MI(0)
		ElseIf doc.TipoAprovacao(0) = "FI" Then
			recipients(1) = doc.SolicitadoPor_FI(0)
		Else
			recipients(1) = doc.SolicitadoPor(0)
		End If
		memo.SendTo = recipients
		memo.CopyTo = doc.Inside
		'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	Else
		recipients(0) = "Marcelo Castro/TDec"
		recipients(1) = "Junior Castro/TDec"
		memo.SendTo = recipients
		If tipo = "Fechamento" Or tipo = "Faturamento Futuro" Then
			memo.CopyTo = doc.GerenteConta(0)
		End If
		If InStr(tipo, "Solicita Aprovação") > 0 Then
			'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
		End If
	End If
	'Faturamento Futuro
	Dim faturamentoFuturo As String
	If InStr(tipo, "Solicita Aprovação") > 0 Then
		If doc.DataFaturamentoFuturo(0) <> "" Then
			faturamentoFuturo = " Faturamento Futuro"
		End If
	End If
	'Email
	If tipo = "Solicita Aprovação Frete Revenda" Then
		memo.Subject = "-> Solicitação de Aprovação" & faturamentoFuturo & " de Frete de Revenda Zero. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
	ElseIf tipo = "Solicita Aprovação Frete Projeto" Then
		memo.Subject = "-> Solicitação de Aprovação" & faturamentoFuturo & " de Frete de Projeto Zero. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
	ElseIf tipo = "Solicita Aprovação Margem Item" Then
		memo.Subject = "-> Solicitação de Aprovação" & faturamentoFuturo & " de Margem de Item. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
	ElseIf tipo = "Solicita Aprovação FI" Then
		memo.Subject = "-> Solicitação de Aprovação" & faturamentoFuturo & " de Fator de Importação Inferior. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent")  & " - FI Mínimo HW: " & doc.FI_HW(0) & " - SW: " & doc.FI_SW(0) & " - SV: " & doc.FI_SV(0)
	ElseIf tipo = "Solicita Aprovação Margem Negócio" Then
		memo.Subject = "-> Solicitação de Aprovação" & faturamentoFuturo & " de Margem do Negócio Inferior a " & Format(doc.Resultado(0), "Percent") & ". Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
	ElseIf tipo = "Solicita Aprovação Margem Revenda" Then
		memo.Subject = "-> Solicitação de Aprovação" & faturamentoFuturo & " de Margem de Revenda Inferior a " & Format(doc.MgRevendaM(0), "Percent") & ". Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.ResM_P(0), "Percent") & " - Resultado: R$ " & Format(doc.ResultadoM_P(0), "Standard") & " - Venda: R$ " & Format(doc.VendaM_P(0), "Standard")
	ElseIf tipo = "Solicita Aprovação Margem Serviços" Then
		memo.Subject = "-> Solicitação de Aprovação" & faturamentoFuturo & " de Margem de Serviços Inferior a " & Format(doc.MgServicosM(0), "Percent") & ". Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.ResS_P(0), "Percent") & " - Resultado: R$ " & Format(doc.ResultadoS_P(0), "Standard") & " - Venda: R$ " & Format(doc.VendaS_P(0), "Standard")
	ElseIf tipo = "Aprovado" Then
		If doc.TipoAprovacao(0) = "Frete Revenda" Then
			memo.Subject = "-> Frete de Revenda Zero Aprovado. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "Frete Projeto" Then
			memo.Subject = "-> Frete de Projeto Zero Aprovado. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "Margem Item" Then
			memo.Subject = "-> Margem de Item Aprovada. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "FI" Then
			memo.Subject = "-> Fator de Importação Aprovado. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - FI Mínimo HW: " & doc.FI_HW(0) & " - SW: " & doc.FI_SW(0) & " - SV: " & doc.FI_SV(0)
		ElseIf doc.TipoAprovacao(0) = "Margem Negócio" Then
			memo.Subject = "-> Margem do Negócio Aprovada. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "Margem Revenda" Then
			memo.Subject = "-> Margem de Revenda Aprovada. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.ResM_P(0), "Percent") & " - Resultado: R$ " & Format(doc.ResultadoM_P(0), "Standard") & " - Venda: R$ " & Format(doc.VendaM_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "Margem Serviços" Then
			memo.Subject = "-> Margem de Serviços Aprovada. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.ResS_P(0), "Percent") & " - Resultado: R$ " & Format(doc.ResultadoS_P(0), "Standard") & " - Venda: R$ " & Format(doc.VendaS_P(0), "Standard")
		End If
	ElseIf tipo = "Reprovado" Then
		If doc.TipoAprovacao(0) = "Frete Revenda" Then
			memo.Subject = "-> Frete de Revenda Zero Reprovado. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "Frete Projeto" Then
			memo.Subject = "-> Frete de Projeto Zero Reprovado. Negócio: " & doc.Codigo(0) & " - Mg:" & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "Margem Item" Then
			memo.Subject = "-> Margem de Item Reprovada. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "FI" Then
			memo.Subject = "-> Fator de Importação Reprovado. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - FI Mínimo HW: " & doc.FI_HW(0) & " - SW: " & doc.FI_SW(0) & " - SV: " & doc.FI_SV(0)
		ElseIf doc.TipoAprovacao(0) = "Margem Negócio" Then
			memo.Subject = "-> Margem do Negócio Reprovada. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "Margem Revenda" Then
			memo.Subject = "-> Margem de Revenda Reprovada. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.ResM_P(0), "Percent") & " - Resultado: R$ " & Format(doc.ResultadoM_P(0), "Standard") & " - Venda: R$ " & Format(doc.VendaM_P(0), "Standard")
		ElseIf doc.TipoAprovacao(0) = "Margem Serviços" Then
			memo.Subject = "-> Margem de Serviços Reprovada. Negócio: " & doc.Codigo(0) & " - Mg: " & Format(doc.ResS_P(0), "Percent") & " - Resultado: R$ " & Format(doc.ResultadoS_P(0), "Standard") & " - Venda: R$ " & Format(doc.VendaS_P(0), "Standard")
		End If
	Else
		If tipo = "Faturamento Futuro" Then
			memo.Subject = "-> Negócio Fechado para Faturamento Futuro: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		Else	
			memo.Subject = "-> Negócio Fechado: " & doc.Codigo(0) & " - Mg: " & Format(doc.Res_P(0), "Percent") & " - Resultado: R$ " & Format(doc.Resultado_P(0), "Standard") & " - Venda: R$ " & Format(doc.Venda_P(0), "Standard")
		End If
	End If
	If tipo <> "Fechamento" And tipo <> "Faturamento Futuro" Then
		If doc.TipoAprovacao(0) = "Frete Revenda" Then
			If CStr(doc.Justifica_FreteRevenda(0)) <> "" Then
				richStyle.Bold = True
				Call rtitem.AppendStyle(richStyle)
				Call rtitem.AddNewLine(1)
				Call rtitem.AppendText("Justificativa: " & doc.Justifica_FreteRevenda(0))
				Call rtitem.AddNewLine(1)
				richStyle.Bold = False
				Call rtitem.AppendStyle(richStyle)
			End If
		ElseIf doc.TipoAprovacao(0) = "Frete Projeto" Then
			If CStr(doc.Justifica_FreteProjeto(0)) <> "" Then
				richStyle.Bold = True
				Call rtitem.AppendStyle(richStyle)
				Call rtitem.AddNewLine(1)
				Call rtitem.AppendText("Justificativa: " & doc.Justifica_FreteProjeto(0))
				Call rtitem.AddNewLine(1)
				richStyle.Bold = False
				Call rtitem.AppendStyle(richStyle)
			End If
		ElseIf doc.TipoAprovacao(0) = "Margem Item" Then
			Dim scan As Integer, scan2 As Integer, item As String
			For scan = 0 To 49
				If doc.HasItem("MgSolicitada_" & scan) Then
					If scan2 > 0 Then item = item & "; "
					item = item & "Item " & (scan + 1) & ": Mg " & Format(doc.GetItemValue("MgSolicitada_" & scan)(0), "standard")
					scan2 = scan2 + 1
				End If
			Next
			If item <> "" Then
				Call rtitem.AddNewLine(1)
				Call rtitem.AppendText(item & ".")
				Call rtitem.AddNewLine(1)
			End If
			If CStr(doc.Justifica_MI(0)) <> "" Then
				richStyle.Bold = True
				Call rtitem.AppendStyle(richStyle)
				Call rtitem.AddNewLine(1)
				Call rtitem.AppendText("Justificativa: " & doc.Justifica_MI(0))
				Call rtitem.AddNewLine(1)
				richStyle.Bold = False
				Call rtitem.AppendStyle(richStyle)
			End If
		ElseIf doc.TipoAprovacao(0) = "FI" Then
			If CStr(doc.Justifica_FI(0)) <> "" Then
				richStyle.Bold = True
				Call rtitem.AppendStyle(richStyle)
				Call rtitem.AddNewLine(1)
				Call rtitem.AppendText("Justificativa: " & doc.Justifica_FI(0))
				Call rtitem.AddNewLine(1)
				richStyle.Bold = False
				Call rtitem.AppendStyle(richStyle)
			End If
			richStyle.Bold = True
			richStyle.Underline = True
			Call rtitem.AppendStyle(richStyle)
			Call rtitem.AppendText( "Fator de Importação Solicitado" )
			richStyle.Bold = False
			richStyle.Underline = False
			Call rtitem.AppendStyle(richStyle)
			If doc.FISolicitado_HW(0) > 0 Then
				Call rtitem.AddNewLine( 1 )
				Call rtitem.AppendText( "HW: " & Format(doc.FISolicitado_HW(0), "Standard"))
			End If 
			If doc.FISolicitado_SW(0) > 0 Then
				Call rtitem.AddNewLine( 1 )
				Call rtitem.AppendText( "SW: " & Format(doc.FISolicitado_SW(0), "Standard"))
			End If 
			If doc.FISolicitado_SV(0) > 0 Then
				Call rtitem.AddNewLine( 1 )
				Call rtitem.AppendText( "SV: " & Format(doc.FISolicitado_SV(0), "Standard"))
			End If
			Call rtitem.AddNewLine(1)
		Else
			If CStr(doc.Justifica(0)) <> "" Then
				richStyle.Bold = True
				Call rtitem.AppendStyle(richStyle)
				Call rtitem.AddNewLine(1)
				Call rtitem.AppendText("Justificativa: " & doc.Justifica(0))
				Call rtitem.AddNewLine(1)
				richStyle.Bold = False
				Call rtitem.AppendStyle(richStyle)
			End If
		End If	
	End If
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine(1)
	Call rtitem.AppendText("Acesso Notes -> ")
	Call rtitem.AppendDocLink(doc, "Link para o Negócio")
	Call rtitem.AddNewLine(2)
	If InStr(tipo, "Solicita Aprovação") > 0 And doc.DocID(0) <> "" Then
		Call rtitem.AppendText("Acesso Web -> ")
		'Call rtitem.AppendText("https://intra.tdec.com.br/" + doc.ParentDatabase.FileName + "/0/" + doc.DocID(0) + "?EditDocument")
		Call rtitem.AppendText("https://intra.tdec.com.br/" + doc.ParentDatabase.FileName + "/0/" + doc.Universalid + "?OpenDocument")
		Call rtitem.AddNewLine(2)
	End If
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	'Margem do Negócio
	Call rtitem.AppendText( "Margem Prevista" )
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Venda de Materiais: " & Format(doc.VendaM_P(0), "Standard"))
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Venda de Serviços: " & Format(doc.VendaS_P(0), "Standard"))
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Total da Venda: " & Format(doc.Venda_P(0), "Standard"))
	If doc.Custo_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "CMV: " & Format(doc.Custo_P(0), "Standard"))
	End If
	If doc.CustoImp_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "Importação: " & Format(doc.CustoImp_P(0), "Standard"))
	End If
	If doc.CustosHoras_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "CSV: " & Format(doc.CustosHoras_P(0), "Standard"))
	End If
	If doc.ICMS_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "ICMS: " & Format(doc.ICMS_P(0), "Standard"))
	End If
	If doc.DifICMS_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "ICMS-ST: " & Format(doc.DifICMS_P(0), "Standard"))
	End If
	If doc.IPI_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "IPI: " & Format(doc.IPI_P(0), "Standard"))
	End If
	If doc.ISS_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "ISS: " & Format(doc.ISS_P(0), "Standard"))
	End If
	If doc.INSS_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "INSS: " & Format(doc.INSS_P(0), "Standard"))
	End If
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "PIS: " & Format(doc.PIS_P(0), "Standard"))
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "COFINS: " & Format(doc.COFINS_P(0), "Standard"))
	If doc.Atividades_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "Atividades de Vendas: " & Format(doc.Atividades_P(0), "Standard"))
	End If
	If doc.Despesas_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "Frete: " & Format(doc.Despesas_P(0), "Standard"))
	End If
	If doc.TerceirosFaturaveis_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "Terceiros Faturáveis: " & Format(doc.TerceirosFaturaveis_P(0), "Standard"))
	End If
	If doc.PF_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "Planilha Financeira: " & Format(doc.PF_P(0), "Standard"))
	End If
	If doc.PreVenda_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "Pré-Venda: " & Format(doc.PreVenda_P(0), "Standard"))
	End If
	If doc.POC_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "POC: " & Format(doc.POC_P(0), "Standard"))
	End If
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Capital de Giro: " & Format(doc.Juros_P(0), "Standard"))
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Base Cálculo dos Premios: " & Format(doc.BCPremio_P(0), "Standard"))
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Margem Contribuição: " & Format(doc.Margem_P(0), "Standard"))
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Comissão: " & Format(doc.Premio_P(0), "Standard"))
	If doc.Encargos_P(0) <> 0 Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText( "Encargos Sociais: " & Format(doc.Encargos_P(0), "Standard"))
	End If
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Margem do Negócio: " & Format(doc.Resultado_P(0), "Standard") & " (" & Format(doc.Res_P(0), "Percent") & ")")
	'Margem de Revenda
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Margem de Revenda: " & Format(doc.ResultadoM_P(0), "Standard") & " (" & Format(doc.ResM_P(0), "Percent") & ")")
	'Margem de Serviços
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( "Margem de Serviços: " & Format(doc.ResultadoS_P(0), "Standard") & " (" & Format(doc.ResS_P(0), "Percent") & ")")
	'
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( nome.Common & "," )
	Call rtitem.AddNewLine( 1 )
	Call rtitem.Appendtext( "TDec Network Group" )
	Call memo.Send( False )
	If InStr(tipo, "Solicita Aprovação") > 0 Then
		MsgBox "Email encaminhado para a Diretoria.", 64, tipo
	End If
	
End Sub

'++LotusScript Development Environment:2:2:PopulaMetas:1:8
Sub PopulaMetas(uidoc As NotesUIDocument)
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim x As Integer, it As NotesItem
	Set db = session.CurrentDatabase
	Set view = db.GetView("(Parceria)")
	Set doc = view.GetFirstDocument
	Do Until doc Is Nothing
		Call uidoc.FieldSetText("Parceria_" & x, doc.Parceria(0))
		x = x + 1
		Set doc = view.GetNextDocument(doc)
	Loop
	
End Sub

'++LotusScript Development Environment:2:1:CkCodigo:1:8
Function CkCodigo(Source As NotesUIDocument) As Boolean
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Set db = session.CurrentDatabase
	Set view = db.GetView("(NegociosCodigo)")
	Set doc = view.GetDocumentByKey(Source.FieldGetText("NegocioPrincipal"), True)
	If Not doc Is Nothing Then
		If doc.CodEmpresa(0) = Source.FieldGetText("CodEmpresa") Then
			CkCodigo = True	
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:1:BuscaAtividades:1:8
Function BuscaAtividades (negocio As NotesDocument) As Double
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Set db = session.Currentdatabase
	Set view = db.GetView("(Atividades)")
	Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		BuscaAtividades = BuscaAtividades + doc.Valor_0(0) + doc.Valor_1(0) + doc.Valor_2(0) + doc.Valor_3(0) + doc.Valor_4(0)
		Set doc = dc.GetNextDocument(doc)
	Loop
	
End Function


'++LotusScript Development Environment:2:2:AtualizaRenovacao:5:8
%REM
	Sub AtualizaRenovacao
	Description: Comments for Sub
%END REM
Sub AtualizaRenovacao(negocio As NotesDocument)
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Set db = session.Currentdatabase
	Set view = db.Getview("(Renovacoes/Codigo)")
	Set doc = view.Getdocumentbykey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		If negocio.Sit(0) = "Aguardando Análise da Perda" Or negocio.Sit(0) = "Perdido" Then
			doc.Sit = "Perdido"
			doc.SitNumero = 5
		Else
			doc.Sit = "Renovado"
			doc.SitNumero = 3
		End If
		Call doc.Save(False, False)
	End If
	
End Sub

'++LotusScript Development Environment:2:2:AjusteComissao:5:8
%REM
	Sub AjusteComissao
	Description: Comments for Sub
%END REM
Sub AjusteComissao(negocio As NotesDocument)
	
	On Error Resume Next
	If negocio.CheckPagtoComissao(0) = "OK" Then Exit Sub
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "caixa.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim despesa As NotesDocument, memo As NotesDocument
	Dim doc As Variant, ccDespesa As Variant, nomes As Variant, participacoes As Variant, indice As Variant
	Dim venc As NotesDateTime
	Dim scan As Integer, totPago As Double, totPagar As Double
	Dim msgPago As String, msgPagar As String
	Dim corpo As NotesRichTextItem
	Dim recipients(1) As String
	recipients(0) = "Junior Castro/TDec"
	recipients(1) = "Marcelo Castro/TDec"
	'Set venc = New NotesDateTime("12/" & Month(Today) & "/" & Year(Today))
	Set venc = New NotesDateTime("12/" & Month(negocio.DataConclusao(0)) & "/" & Year(negocio.DataConclusao(0)))
	Call venc.AdjustMonth( 1 )
	'Ajusta da Data de Vencimento
	Do Until Weekday(venc.DateOnly) <> 1 And Weekday(venc.DateOnly) <> 7 And Not ckFeriado(venc.DateOnly)
		Call venc.Adjustday(1, True)
	Loop
	'Estilo do Email
	Dim session As New NotesSession
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	'
	For scan = 0 To UBound(negocio.Nomes)
		totPago = 0
		totPagar = 0
		If negocio.Ajustes(scan) <> 0 And negocio.Nomes(scan) <> "" Then
			'Gera Despesa
			Set doc = New ccDespesa(negocio)
			doc.Origem = "Ajuste de Comissão - " & negocio.Codigo(0)
			doc.Codigo = negocio.Codigo(0)
			doc.Sit = "Pendente"
			doc.Classificacao = "Comissoes"
			doc.Area = negocio.AreaVendas(0)
			doc.Responsavel = negocio.Nomes(scan)
			doc.Data = Today
			doc.Vencimento = CDat(venc.DateOnly)
			doc.Adianta = False
			doc.Descricao = "Ajuste de Comissão - " & negocio.Codigo(0)
			doc.Valor = negocio.Ajustes(scan)
			doc.TipoCompra = negocio.TipoCompra(0)
			doc.TipoVenda = negocio.TipoVenda(0)
			Call doc.Save
			'Envia Extrato de Comissões
			Set view = db.Getview("(DespesasNegocio)")
			Set dc = view.Getalldocumentsbykey(negocio.Codigo(0), True)
			Set despesa = dc.GetFirstDocument
			Do Until despesa Is Nothing
				If despesa.ClassificacaoDespesa(0) = "Comissoes" Then
					If despesa.ResponsavelDespesa(0) = negocio.Nomes(scan) Then
						If despesa.Sit(0) = "OK" Then
							totPago = totPago + despesa.TotTot(0)
							msgPago = msgPago & Chr(10) & despesa.VencimentoDespesa(0) & " " & despesa.Sit(0) & " " & despesa.ClassificacaoDespesa(0) & " em " & despesa.Pagamento(0) & " Nº Cheque " & despesa.NCheque(0) & " " & despesa.Banco(0) & " R$ " & Format(despesa.TotTot(0), "Standard")
						ElseIf despesa.Sit(0) = "Pendente" Then
							totPagar = totPagar + despesa.TotTot(0)
							msgPagar = msgPagar & Chr(10) & despesa.VencimentoDespesa(0) & " " & despesa.Sit(0) & " " & despesa.ClassificacaoDespesa(0) & " R$ " & Format(despesa.TotTot(0), "Standard")
						End If
					End If
				End If
				Set despesa = dc.GetNextDocument(despesa)
			Loop
			'Participação na Comissão - LMO 01/11/2016
			nomes = negocio.NomeComissao
			participacoes = negocio.ParticipacaoComissao
			indice = ArrayGetIndex(nomes, negocio.Nomes(scan))
			'Envia Email
			Set memo = New NotesDocument(negocio.Parentdatabase)
			memo.Form = "Memo"
			memo.SendTo = negocio.Nomes(scan)
			memo.CopyTo = recipients
			'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
			memo.Subject = "-> Extrato de Comissão de " & negocio.Nomes(scan) & ": " & negocio.Codigo(0)
			Set corpo = New NotesRichTextItem(memo, "Body")
			Call corpo.AppendStyle(richStyle)
			Call corpo.Appendtext("Responsável: " & negocio.Nomes(scan))
			If Not IsNull(indice) Then
				Call corpo.AddNewLine(1)
				Call corpo.Appendtext("Participação: " & Format(participacoes(indice), "percent"))
			End If
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Valor da Comissão: R$ " & Format(totPagar, "Standard"))
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Data para Pagamento: " & Format(CDat(venc.DateOnly), "dd/mm/yyyy"))
			Call corpo.AddNewLine(2)
			Call corpo.Appendtext("Negocio: " & negocio.Codigo(0))
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Descrição: " & negocio.Descricao(0))
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Dias do Negócio: " & Round(negocio.Dias(0), 0))
			Call corpo.AddNewLine(1) 
			Call corpo.Appendtext("Conclusão do Negócio: " & Format(negocio.DataConclusao(0), "dd/mm/yyyy")) 
			Call corpo.AddNewLine(1) 
			Call corpo.Appendtext("Link para o Negócio -> ")
			Call corpo.AppendDocLink(negocio, "Link para o Negócio" )
			Call corpo.AddNewLine(2)
			Call corpo.AppendText("Margem Prevista:")        
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Receitas: " & Format(negocio.Venda_P(0), "Standard"))
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Despesas: " & Format(negocio.Venda_P(0) - negocio.Margem_P(0), "Standard"))
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Resultado: " & Format(negocio.Margem_P(0), "Standard") & " (" & Format(negocio.Res_P(0), "percent") & ")" )
			If Not IsNull(indice) Then
				Call corpo.AddNewLine(1)
				Call corpo.Appendtext("Comissão Total: " & Format(negocio.Premio_P(0) * participacoes(indice), "Standard"))
			End If
			Call corpo.AddNewLine(2)
			Call corpo.AppendText("Margem Real:")
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Receitas: " & Format(negocio.Venda_R(0), "Standard"))
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Despesas: " & Format(negocio.Venda_R(0) - negocio.Margem_R(0), "Standard"))
			Call corpo.AddNewLine(1)
			Call corpo.Appendtext("Resultado: " & Format(negocio.Margem_R(0), "Standard") & " (" & Format(negocio.Res_R(0), "percent") & ")" )
			If Not IsNull(indice) Then
				Call corpo.AddNewLine(1)
				Call corpo.Appendtext("Comissão Total: " & Format(negocio.Premio_R(0) * participacoes(indice), "Standard"))
			End If
			Call corpo.AddNewLine(2)
			Call corpo.Appendtext("TDec Network Group.")
			Call memo.Send(False)
		End If
	Next
	negocio.CheckPagtoComissao = "OK"
	
End Sub


'++LotusScript Development Environment:2:1:CalcIF:1:8
Function CalcIF(doc As NotesDocument) As Double
	'Impostos Federais = alíq. PIS + alíq. COFINS + alíq. CSLL - Ínicio Fev-2004
	
	If doc.Form(0) = "Glosa" Then Exit Function
	Dim data As New NotesDateTime(CStr(doc.DataFaturamento(0)))
	Dim answer As Integer
	If CDat(data.DateOnly) >= CDat("01/02/2004") Then
		If doc.Tipo(0) = "Serviços" Then
			If (doc.Sit(0) = "A Emitir" Or doc.Sit(0) = "Espelho" Or doc.Sit(0) = "Emitido por Extrato") And doc.Form(0) <> "ReciboLocacao" Then
				If Round(doc.TotalServicos(0), 2) > 215.05 Or doc.CkIF(0)= "IF" Then answer% = 6 Else answer% = 0	'Mundança Lei 13.137 em 19/06/2015
			Else
				If IsNumeric(doc.IF(0)) Then
					If doc.IF(0) = 0 Then answer% = 0 Else answer% = 6
				Else
					answer% = 0
				End If
			End If
			If answer% = 6  Then
				CalcIF# = Round(doc.TotalServicos(0) * aliquota(6), 2) + Round(doc.TotalServicos(0) * aliquota(7), 2) + Round(doc.TotalServicos(0) * aliquota(8), 2)
				doc.IFPis = Round(doc.TotalServicos(0) * aliquota(6), 2)
				doc.IFCofins = Round(doc.TotalServicos(0) * aliquota(7), 2)
				doc.IFCSLL = Round(doc.TotalServicos(0) * aliquota(8), 2)
			Else
				doc.IFPis = 0
				doc.IFCofins = 0
				doc.IFCSLL = 0
			End If
		Else
			doc.IFPis = 0
			doc.IFCofins = 0
			doc.IFCSLL = 0
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:CalcPremio:5:8
%REM
	Sub CalcPremio
	Description: Comments for Sub
%END REM
Sub CalcPremio(doc As NotesDocument)
	
	On Error Resume Next
	Dim qs As Variant, valor As Double
	Dim scan As Integer
	Dim ck As Double, totalServicos As Double, comServ As Double
	Dim mgA As Double,  mgB As Double, mgC As Double, mgD As Double 
	Dim comA As Double, comB As Double, comC As Double, comD As Double
	Dim valComHw As Double, valComSv As Double, valcomServico As Double, valcomHardware As Double,  totalVenda As Double, premio As Double, adiantamento As Double
	Dim mg As Variant , quant As Variant, custo As Variant, ic As Variant, icc As Variant,  st As Variant
	Dim totalMateriais As Double, moeda As Double, tipo As Variant, us As Variant, array As Variant
	'Busca Regras Fiscais para a definição das Alíquotas dos Impostos
	Call BuscaRegrasFiscais(doc)
	'Comissionamento de Contrato(4,5%) - LMO 15/02/05
	If Isnumeric(doc.ComissaoSA(0)) Then comA# = doc.ComissaoSA(0) Else comA# = 0.045 
	If Isnumeric(doc.ComServicos(0)) Then comServ# = doc.ComServicos(0) Else comServ# = comA# 'Comissionamento Vendas - LMO 15/02/05
	'Comissionamento de Serviços
	valcomServico# = 0
	If Isnumeric(doc.MargemSA(0)) Then mgA# = doc.MargemSA(0) Else mgA# = 0
	If Isnumeric(doc.MargemSB(0)) Then mgB# = doc.MargemSB(0) Else mgB# = 0
	If Isnumeric(doc.MargemSC(0)) Then mgC# = doc.MargemSC(0) Else mgC# = 0
	If Isnumeric(doc.MargemSD(0)) Then mgD# = doc.MargemSD(0) Else mgD# = 0
	If Isnumeric(doc.ComissaoSA(0)) Then comA# = doc.ComissaoSA(0) Else comA# = 0
	If Isnumeric(doc.ComissaoSB(0)) Then comB# = doc.ComissaoSB(0) Else comB# = 0
	If Isnumeric(doc.ComissaoSC(0)) Then comC# = doc.ComissaoSC(0) Else comC# = 0
	If Isnumeric(doc.ComissaoSD(0)) Then comD# = doc.ComissaoSD(0) Else comD# = 0
	If doc.TipoVenda(0) = "Venda Simples" Then
		totalServicos# = 0
		doc.PremioServicos = 0 'Comissionamento Vendas
	Elseif doc.TipoVenda(0) = "Contrato" Then
		For scan% = 0 To 3
			qs = doc.GetItemValue("CQs_"+ Cstr(scan%))
			If Isnumeric(qs(0)) Then
				If qs(0) > 0 Then       
					array = doc.GetItemValue("CCusTots_"+ Cstr(scan%))
					totalServicos# = TotalServicos# + (array(0) * qs(0))
				End If
			End If
		Next
		doc.PremioServicos = Round(totalServicos# * comServ#, 2) 'Comissionamento Vendas
	Else
		'Comissionamento de Serviços
		For scan% = 0 To 11
			qs =  doc.GetItemValue("Qs_"+ CStr(scan%))
			If IsNumeric(qs(0)) Then
				If qs(0) > 0 Then       
					array = doc.GetItemValue("CusTots_"+ CStr(scan%))
					If IsNumeric( array(0) ) Then 
						us = doc.GetItemValue("Uss_"+ CStr(scan%))
						If us(0) = "US$C" Then
							'US$C Venda Fixo - LMO 08/01/18
							If IsNumeric(doc.USVenda(0)) Then
								moeda = doc.USVenda(0)
							Else
								If IsNumeric(doc.USC(0)) Then moeda# = doc.USC(0) Else moeda# = 1
							End If
						ElseIf us(0) = "US$T" Then
							If IsNumeric(doc.UST(0)) Then moeda# = doc.UST(0) Else moeda# = 1
						Else
							moeda# = 1
						End If
						valor# = array(0) * moeda#
						mg = doc.GetItemValue("Mgs_"+ CStr(scan%))
						If CStr(mg(0)) = "" Then mg = 0 Else mg = mg(0)
						Select Case mg
						Case Is <= mgA#               : valComSv# = comA#
						Case (mgA#+0.01) To mgB#      : valComSv# = comB#
						Case (mgB#+0.01) To mgC#      : valComSv# = comC#
						Case (mgC#+0.01) To mgD#      : valComSv# = comD#
						Case Is > mgD#                : valComSv# = 0.00
					End Select
						valcomServico# = valcomServico# + (valComSv# * valor# )
						totalServicos# = totalServicos# + valor# 
					End If
				End If
			End If
		Next
		doc.PremioServicos = Round(valcomServico#, 2) 'Comissionamento Vendas
	End If
	'Comissionamento de Materiais
	If doc.TipoVenda(0) <> "Contrato" Then
		If Isnumeric(doc.MargemA(0)) Then mgA# = doc.MargemA(0) Else mgA# = 0
		If Isnumeric(doc.MargemB(0)) Then mgB# = doc.MargemB(0) Else mgB# = 0
		If Isnumeric(doc.MargemC(0)) Then mgC# = doc.MargemC(0) Else mgC# = 0
		If Isnumeric(doc.MargemD(0)) Then mgD# = doc.MargemD(0) Else mgD# = 0
		If Isnumeric(doc.ComissaoA(0)) Then comA# = doc.ComissaoA(0) Else comA# = 0
		If Isnumeric(doc.ComissaoB(0)) Then comB# = doc.ComissaoB(0) Else comB# = 0
		If Isnumeric(doc.ComissaoC(0)) Then comC# = doc.ComissaoC(0) Else comC# = 0
		If Isnumeric(doc.ComissaoD(0)) Then comD# = doc.ComissaoD(0) Else comD# = 0
		For scan% = 0 To 49	'Lista de Materiais
			mg = doc.GetItemValue("Mg_"+ Cstr(scan%))
			quant = doc.GetItemValue("Q_"+ Cstr(scan%))
			custo = doc.GetItemValue("Custo_"+ Cstr(scan%))
			icc = doc.GetItemValue("ICC_"+ CStr(scan%))
			ic = doc.GetItemValue("IC_"+ Cstr(scan%))
			us = doc.GetItemValue("Us_"+ Cstr(scan%))
			tipo = doc.GetItemValue("t_"+ Cstr(scan%))
			st = doc.GetItemValue("ST_"+ Cstr(scan%))
			If us(0) = "US$C" Then
				'US$C Venda Fixo - LMO 08/01/18
				If IsNumeric(doc.USVenda(0)) Then
					moeda = doc.USVenda(0)
				Else
					If IsNumeric(doc.USC(0)) Then moeda# = doc.USC(0) Else moeda# = 1
				End If
			Elseif us(0) = "US$T" Then
				If Isnumeric(doc.UST(0)) Then moeda# = doc.UST(0) Else moeda# = 1
			Elseif us(0) = "R$" Then
				moeda# = 1
			End If
			If Isnumeric(quant(0)) Then
				If Isnumeric(mg(0)) And quant(0) > 0 Then
					valor = doc.GetItemValue("CusTot_"+ Cstr(scan%))
					Select Case Cdbl(mg(0))
					Case Is <= mgA#               : valComHw# = comA#
					Case (mgA#+0.01) To mgB#      : valComHw# = comB#
					Case (mgB#+0.01) To mgC#      : valComHw# = comC#
					Case (mgC#+0.01) To mgD#      : valComHw# = comD#
					Case Is > mgD#                : valComHw# = 0.00
				End Select
					valComHardware# = valComHardware# + (valComHw# * valor# * moeda# )
				End If
				If quant(0) > 0 Then
					If tipo(0) = "SW" Or tipo(0) = "HW" Then
						totalMateriais# = totalMateriais# + (valor# * moeda# )
					Elseif tipo(0) = "SV" Then
						totalServicos# = totalServicos# + (valor# * moeda# )
					End If		
				End If
			End If
		Next
	End If
	doc.PremioMateriais = Round(valComHardware#, 2)
	doc.Premio = Round(doc.PremioMateriais(0) + doc.PremioServicos(0), 2)
	
End Sub

'++LotusScript Development Environment:2:2:CalcCapitalGiroPrevisto:12:8
%REM
	Sub geraCapitalGiroPrevisto - mcastro em 18/03/2016
	Description: a partir de previsoes de uso de capital de giro para importacoes, prazo de pagamento de clientes, 
	prazo para pagamento de fornecedores, tentar criar uma previsao para custo de capital de giro
	- tem produtos importados? (pagamos os impostos antes de receber do cliente)
	- tem serviços? (neste caso vamos pagar a Plan Financeira e CPS e recebemos a maior parte dos serviços quando finalizamos o projeto)
	- tem venda fora do estado? (temos que adiantar o ICMS antes de receber do cliente)
	- vamos receber do cliente antes de pagar o CMV ao fornecedor? (neste caso vou levar em consideração que isto nao vai acontecer)
	- O resultado serao duas informacoes importantes
	- Qual sera o custo do capital de giro e quanto capital eu preciso para fazer o negocio por quanto tempo
%END REM
Sub CalcCapitalGiroPrevisto(negocio As NotesDocument)
	
	On Error Resume Next
	Dim capGiroImportacao As Double
	Dim diasImportacao As Integer
	Dim jurosImportacao As Double
	Dim capGiroSiscomex As Double
	Dim diasSiscomex As Integer
	Dim jurosSiscomex As Double
	Dim capGiroCMV As Double
	Dim diasCMV As Integer
	Dim jurosCMV As Double
	Dim capGiroFrete As Double
	Dim diasFrete As Integer
	Dim jurosFrete As Double
	Dim capGiroICMSCompra As Double
	Dim diasICMSCompra As Integer
	Dim jurosICMSCompra As Double
	Dim capGiroICMSVenda As Double
	Dim diasICMSVenda As Integer
	Dim jurosICMSVenda As Double
	Dim capGiroReceber As Double 'este seria para eu calcular o atraso médio do cliente antes de fazer uma venda
	Dim diasReceber As Integer
	Dim jurosReceber As Double
	Dim capGiroPlanFin As Double
	Dim diasPlanFin As Integer
	Dim jurosPlanFin As Double
	Dim capGiroCPS As Double
	Dim diasCPS As Integer
	Dim jurosCPS As Double
	Dim capGiroTerceiros As Double
	Dim diasTerceiros As Integer
	Dim jurosTerceiros As Double
	Dim capGiroVisitas As Double
	Dim diasVisitas As Integer
	Dim jurosVisitas As Double
	Dim capGiroPV As Double
	Dim diasPV As Integer
	Dim jurosPV As Double
	Dim capGiroPOC As Double
	Dim diasPOC As Integer
	Dim jurosPOC As Double
	'Prazos
	Dim prazoPagtoCliente As Integer, prazoPagtoImportacao As Integer, prazoPagtoCMV As Integer, prazoPagtoFrete As Integer, prazoPagtoPlanilhaFinanceira As Integer, prazoPagtoCPS As Integer, prazoPagtoTerceiros As Integer, prazoExecucao As Integer
	If CStr(negocio.PrazoPagamento(0)) <> "" Then prazoPagtoCliente = negocio.PrazoPagamento(0)
	If CStr(negocio.PrazoPagamentoFornecedor(0)) <> "" Then prazoPagtoImportacao = negocio.PrazoPagamentoFornecedor(0) Else prazoPagtoImportacao = Val(negocio.PrazoPagtoImportacao(0))
	If CStr(negocio.PrazoPagamentoFornecedor(0)) <> "" Then prazoPagtoCMV = negocio.PrazoPagamentoFornecedor(0) Else prazoPagtoCMV = Val(negocio.PrazoPagtoCMV(0))
	If CStr(negocio.PrazoPagtoFrete(0)) <> "" Then prazoPagtoFrete = negocio.PrazoPagtoFrete(0)
	If CStr(negocio.PrazoPagtoPlanilhaFinanceira(0)) <> "" Then prazoPagtoPlanilhaFinanceira = negocio.PrazoPagtoPlanilhaFinanceira(0)
	If CStr(negocio.PrazoPagtoCPS(0)) <> "" Then prazoPagtoCPS = negocio.PrazoPagtoCPS(0)
	If CStr(negocio.PrazoPagtoTerceiros(0)) <> "" Then prazoPagtoTerceiros = negocio.PrazoPagtoTerceiros(0)
	If CStr(negocio.PrazoExecucao(0)) <> "" Then prazoExecucao = negocio.PrazoExecucao(0)
	'Condições de Pagamento (D.D.L.: Dias da Data Líquido; D.F.M.: Dias Fora Mês; D.F.Q.: Dias Fora Quinzena; D.F.V.: Dia Fixo de Vencimento) - LMO 18/12/24
	Select Case negocio.CondPagto(0)
		Case "D.F.M."	'D.F.M. (Dias Fora Mês)
			prazoPagtoCliente = prazoPagtoCliente + 30
		Case "D.F.Q."	'D.F.Q. (Dias Fora Quinzena)
			prazoPagtoCliente = prazoPagtoCliente + 15
		Case "D.F.S."	'D.F.S. (Dias Fora Semana)
			prazoPagtoCliente = prazoPagtoCliente + 7
		Case "D.F.V."	'D.F.V. (Dia Fixo de Vencimento)
			prazoPagtoCliente = 30
	End Select
	'Previsão de Fechamento
	Dim dataForecast As New NotesDateTime(negocio.DataForecast(0))
	'Lista de Materiais 
	Dim scan As Integer, x As Integer, fatorCompra As Double, fatorVenda As Double
	Dim qtd As Variant, array As Variant
	For scan = 0 To 49
		qtd = negocio.Getitemvalue("Q_" & scan)
		If CStr(qtd(0)) <> "" Then
			array = negocio.Getitemvalue("us_" & scan)
			If array(0) = "US$C" Then
				fatorCompra = negocio.USC(0)
				'US$C Venda Fixo - LMO 08/01/18
				If IsNumeric(negocio.USVenda(0)) Then
					fatorVenda = negocio.USVenda(0)
				Else
					fatorVenda = negocio.USC(0)
				End If
			Else
				fatorCompra = 1
				fatorVenda = 1
			End If
			'Capital de Giro de Importação
			If CStr(negocio.Getitemvalue("CustoFOB_" & scan)(0)) <> "" Then
				'Custo CIF
				capGiroImportacao = capGiroImportacao + Round(negocio.Getitemvalue("Custo_" & scan)(0), 4) * qtd(0) * fatorCompra
				'Capital de Giro Siscomex - Atracagem
				If negocio.Getitemvalue("T_" & scan)(0) = "HW" Then
					'Custo CIF
					capGiroSiscomex = capGiroSiscomex + Round(negocio.Getitemvalue("Custo_" & scan)(0), 4) * qtd(0) * fatorCompra
				End If
			'Capital de Giro de CMV
			Else
				capGiroCMV = capGiroCMV + Round(negocio.Getitemvalue("Custo_" & scan)(0), 4) * qtd(0) * fatorCompra
			End If
			'ICMSST de Compra
			If IsNumeric(negocio.Getitemvalue("ICMSSTC_" & scan)(0)) Then
				'Antecipação do ICMS de Compra
				If negocio.Getitemvalue("UFCompra_" & scan)(0) <> "SP" And negocio.Getitemvalue("UFCompra_" & scan)(0) <> "EX" Then
					capGiroICMSCompra = capGiroICMSCompra + negocio.Getitemvalue("ICMSSTC_" & scan)(0) * qtd(0) * fatorCompra
				'Capital de Giro do CMV (O ICMSST entra no custo)
				Else
					capGiroCMV = capGiroCMV + negocio.Getitemvalue("ICMSSTC_" & scan)(0) * qtd(0) * fatorCompra
				End If
			End If
			'Antecipação do ICMS de Venda
			array = negocio.Getitemvalue("ICMSST_" & scan)
			If IsNumeric(array(0)) Then
				capGiroICMSVenda = capGiroICMSVenda + array(0) * fatorVenda
			End If
		End If
	Next
	
	'Capital de Giro do Frete
	If CStr(negocio.Frete(0)) = "" Then capGiroFrete = 0 Else capGiroFrete = negocio.Frete(0)
	
	'Budget do Projeto
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim projeto As NotesDocument
	Set view = db.GetView("(ProjetosCodigo)")
	Set projeto = view.GetDocumentByKey(negocio.Codigo(0), True)
	If Not projeto Is Nothing Then
		If negocio.TipoVenda(0) <> "Venda Simples" Then
			If CStr(projeto.CustoDespPT(0)) = "" Then capGiroPlanFin = 0 Else capGiroPlanFin = projeto.CustoDespPT(0)
			If CStr(projeto.CPSPT(0)) = "" Then capGiroCPS = 0 Else capGiroCPS = projeto.CPSPT(0)
			If CStr(projeto.TerceirosP(0)) = "" Then capGiroTerceiros = 0 Else capGiroTerceiros = projeto.TerceirosP(0)
		End If
	End If

	'Contrato: Matriz de Tarifação - LMO 22/09/22
	If negocio.TipoVenda(0) = "Contrato" Then
		For scan = 0 To 9
			qtd = negocio.Getitemvalue("CQs_" & scan)
			If CStr(qtd(0)) <> "" Then
				If CStr(negocio.GetItemValue("CTerceiros_" & scan)(0)) <> "" Then
					capGiroTerceiros = capGiroTerceiros + Round(negocio.GetItemValue("CTerceiros_" & scan)(0), 2) * qtd(0)
				End If
			End If
		Next
	End If
	
	'Visitas
	Dim prazoVisitas As Integer
	Dim dataPagtoPrimeiraVisita As New NotesDateTime(dataPagamento)
	prazoVisitas = dataForecast.Timedifference(dataPagtoPrimeiraVisita)/86400
	If prazoVisitas < 0 Then prazoVisitas = 0
	'capGiroVisitas = visitas
	capGiroVisitas = negocio.Atividades_P(0)
	
	'Pré-Venda
	capGiroPV = pf(6) + pf(7)
	
	'POC
	capGiroPOC = pf(9) + pf(10)
	
	If capGiroImportacao + capGiroSiscomex + capGiroCMV + capGiroFrete + capGiroICMSCompra + capGiroICMSVenda + capGiroReceber + capGiroPlanFin + capGiroCPS + capGiroTerceiros + capGiroVisitas + capGiroPV + capGiroPOC = 0 Then
		'Print
		GoTo Fim
	End If
	
	
	'===================================================================================================
	' Busca indices em Bancos
	'===================================================================================================
	Dim dbBancos As New NotesDatabase(negocio.Parentdatabase.Server,"bancos.nsf")
	Dim viewCapitalGiro As NotesView
	Dim doc As NotesDocument
	Dim fatorJuros As Double, fatorIOF As Double, fatorIOC As Double, totJuros As Double, totIOF As Double, totIOC As Double
	Set viewCapitalGiro = dbBancos.GetView("Custo Capital de Giro")
	%REM
	'Taxa de Juros da Data de Fechamento x Data de Forecast (Pode ser uma Data Futura distante, como fazer?) - LMO 31/10/24
	Dim data As NotesDateTime
	If Fechado(negocio.Sit(0)) And CStr(negocio.DataFechamento(0)) <> "" Then
		Set data = New NotesDateTime(negocio.DataFechamento(0))
	Else
		Set data = New NotesDateTime(negocio.DataForecast(0))
	End If
	Call data.Adjustmonth(-1)
	Set doc = view.Getdocumentbykey(Format(data.Dateonly, "YYYY/MM"), True)
	%END REM
	
	%REM
	'Se o Negócio ainda não foi fechado - LMO 08/01/25
	If CStr(negocio.TaxaJuros_P(0)) = "" Or negocio.Sit(0) = "Prospect" Or InStr(negocio.Sit(0), "Pré-Venda") = 0 Or InStr(negocio.Sit(0), "POC") = 0 Or negocio.Sit(0) <> "Forecast" Then
		Set doc = viewCapitalGiro.Getlastdocument()
		If doc Is Nothing Then
			'Print
			GoTo Fim
		End If
		negocio.DataTaxaJuros_P = Format(doc.Criacao(0), "dd/mm/yyyy")
		negocio.TaxaJuros_P = doc.Fator(0)
		fatorIOF = doc.IOF(0)
		'fatorIOC = doc.IOC(0) Mesmo Fator do WC Real - LMO 31/10/24
		fatorIOC = 0.0038	'É Fixo no WC Real - LMO 31/10/24
	End If
	fatorJuros = negocio.TaxaJuros_P(0)
	%END REM
	
	'%REM
	Set doc = viewCapitalGiro.Getlastdocument()
	If doc Is Nothing Then
		'Print
		GoTo Fim
	End If
	negocio.DataTaxaJuros_P = Format(doc.Criacao(0), "dd/mm/yyyy")
	negocio.TaxaJuros_P = doc.Fator(0)
	fatorJuros = doc.Fator(0) - 1
	fatorIOF = doc.IOF(0)
	'fatorIOC = doc.IOC(0) Mesmo Fator do WC Real - LMO 31/10/24
	fatorIOC = 0.0038	'É Fixo no WC Real - LMO 31/10/24
	'%END REM	
		
	
	'===================================================================================================
	' Para começar vamos achar os dias - a data inicial e a data final para cada tipo de capital de giro
	'===================================================================================================
	
	'Fator de Correção
	'FatorTotalDiario = FatorJurosDiario * FatorCDIDiario
	'FatorJurosDiario = (1+JurosMensal/100)^(1/DiasUteis))
	'FatorCDIDiario = (1+CDIMensal/100)^(1/DiasUteis))
	
	'Juros Compostos
	'J = Juros, M = montante, P = principal, i = taxa de juros e n = número de períodos que o principal P (capital inicial) foi aplicado.
	'M = p(1+i)^n 
	'J = M - P
	
	'potência = ^
	
	'calculando os juros do dia (CalcReal)
	%REM
	If saldoFinal < 0 Then
		osJuros = saldoFinal * (doc.Fator(0) - 1)
		valIOF = saldoFinal * aliqIOF(scan)
	Else
		osJuros = 0
		valIOF = 0
	End If	
	%END REM
	
	
	
	'===================================================================================================
	'Importacao - dias que vou precisar do dinheiro para financiar a Importação
	'===================================================================================================
	If capGiroImportacao > 0 And prazoPagtoCliente - prazoPagtoImportacao > 0 Then
		diasImportacao = prazoPagtoCliente - prazoPagtoImportacao
		totJuros = (capGiroImportacao * (1 + fatorJuros) ^ diasImportacao) - capGiroImportacao
		totIOF = (capGiroImportacao * (1 + fatorIOF) ^ diasImportacao) - capGiroImportacao
		totIOC = capGiroImportacao * fatorIOC
		jurosImportacao = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'Siscomex - dias que vou precisar do dinheiro para financiar os impostos de liberação Siscomex
	'===================================================================================================
	If capGiroSiscomex > 0 And prazoPagtoCliente > 0 Then
		diasSiscomex = prazoPagtoCliente
		totJuros = (capGiroSiscomex * (1 + fatorJuros) ^ diasSiscomex) - capGiroSiscomex
		totIOF = (capGiroSiscomex * (1 + fatorIOF) ^ diasSiscomex) - capGiroSiscomex
		totIOC = capGiroSiscomex * fatorIOC
		jurosSiscomex = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'CMV - dias que vou precisar do dinheiro para financiar o CMV
	'===================================================================================================
	If capGiroCMV > 0 And prazoPagtoCliente - prazoPagtoCMV > 0 Then
		diasCMV = prazoPagtoCliente - prazoPagtoCMV
		totJuros = (capGiroCMV * (1 + fatorJuros) ^ diasCMV) - capGiroCMV
		totIOF = (capGiroCMV * (1 + fatorIOF) ^ diasCMV) - capGiroCMV
		totIOC = capGiroCMV * fatorIOC
		jurosCMV = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'Frete - dias que vou precisar do dinheiro para financiar o Frete de Mercadorias
	'===================================================================================================
	If capGiroFrete > 0 And prazoPagtoCliente - prazoPagtoFrete > 0 Then
		diasFrete = prazoPagtoCliente - prazoPagtoFrete
		totJuros = (capGiroFrete * (1 + fatorJuros) ^ diasFrete) - capGiroFrete
		totIOF = (capGiroFrete * (1 + fatorIOF) ^ diasFrete) - capGiroFrete
		totIOC = capGiroFrete * fatorIOC
		jurosFrete = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'ICMS de Compra - para compras de fora do estado que temos que adiantar dinheiro do ICMS de compra da mercadoria
	'===================================================================================================
	If capGiroICMSCompra > 0 And prazoPagtoCliente > 0 Then
		diasICMSCompra = prazoPagtoCliente
		totJuros = (capGiroICMSCompra * (1 + fatorJuros) ^ diasICMSCompra) - capGiroICMSCompra
		totIOF = (capGiroICMSCompra * (1 + fatorIOF) ^ diasICMSCompra) - capGiroICMSCompra
		totIOC = capGiroICMSCompra * fatorIOC
		jurosICMSCompra = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'ICMS de Venda - para vendas fora do estado que temos que adiantar dinheiro do ICMS na venda da mercadoria
	'===================================================================================================
	If capGiroICMSVenda > 0 And prazoPagtoCliente > 0 Then
		diasICMSVenda = prazoPagtoCliente
		totJuros = (capGiroICMSVenda * (1 + fatorJuros) ^ diasICMSVenda) - capGiroICMSVenda
		totIOF = (capGiroICMSVenda * (1 + fatorIOF) ^ diasICMSVenda) - capGiroICMSVenda
		totIOC = capGiroICMSVenda * fatorIOC
		jurosICMSVenda = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'Receber - vou ver se consigo criar uma média de pagamento por cliente. Se não conseguir, isto é 
	'o desencaixe entre a compra e a vendas, caso recebamos o dinheiro depois de pagar o fornecedor
	'===================================================================================================
	
	
	'===================================================================================================
	'Planilha Financeira - pagamos a planilha finaiceira toda a quarta feira. Dependendo de quando 
	'iremos receber o dinheiro dos serviços, isto impacta diretamente o capital de giro
	'É uma conta aproximada pois poderíamos usar o saldo de caixa positivo do HW para pagar os serviços,
	'mas neste caso não vou levar isto em consideração pois a conta seria muito complexa para a 
	'primeira versão
	'===================================================================================================
	If capGiroPlanFin > 0 And prazoExecucao + prazoPagtoCliente - prazoPagtoPlanilhaFinanceira > 0 Then
		diasPlanFin = prazoExecucao + prazoPagtoCliente - prazoPagtoPlanilhaFinanceira
		totJuros = (capGiroPlanFin * (1 + fatorJuros) ^ diasPlanFin) - capGiroPlanFin
		totIOF = (capGiroPlanFin * (1 + fatorIOF) ^ diasPlanFin) - capGiroPlanFin
		totIOC = capGiroPlanFin * fatorIOC
		jurosPlanFin = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'CPS - no caso de CPS há um desencaixe entre o prazo de pagamento aos fornecedores e o recebimento
	'do cliente, pois normalmente recebemos o dinheiro só no final do projeto.
	'Vou criar novas variáveis de controle de pagamento de serviços para cobrarmos sinal e o prazo
	'previsto para término do projeto, pois sem estes dados não consigo calcular este valor.
	'===================================================================================================
	If capGiroCPS > 0 And prazoExecucao + prazoPagtoCliente - prazoPagtoCPS > 0 Then
		diasCPS = prazoExecucao + prazoPagtoCliente - prazoPagtoCPS
		totJuros = (capGiroCPS * (1 + fatorJuros) ^ diasCPS) - capGiroCPS
		totIOF = (capGiroCPS * (1 + fatorIOF) ^ diasCPS) - capGiroCPS
		totIOC = capGiroCPS * fatorIOC
		jurosCPS = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'Pagamento de Parceiros - no caso de Parceiros há um desencaixe entre o prazo de pagamento aos fornecedores e o recebimento
	'do cliente, pois normalmente recebemos o dinheiro só no final do projeto.
	'Vou criar novas variáveis de controle de pagamento de serviços para cobrarmos sinal e o prazo
	'previsto para término do projeto, pois sem estes dados não consigo calcular este valor.
	'===================================================================================================
	If capGiroTerceiros > 0 And prazoExecucao + prazoPagtoCliente - prazoPagtoTerceiros > 0 Then
		diasTerceiros = prazoExecucao + prazoPagtoCliente - prazoPagtoTerceiros
		totJuros = (capGiroTerceiros * (1 + fatorJuros) ^ diasTerceiros) - capGiroTerceiros
		totIOF = (capGiroTerceiros * (1 + fatorIOF) ^ diasTerceiros) - capGiroTerceiros
		totIOC = capGiroTerceiros * fatorIOC
		jurosTerceiros = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'Visitas - Prazo entre o pagamento da primeira Visita e a data de Forecast somado ao Prazo de Pagamento do Cliente
	'===================================================================================================
	If capGiroVisitas > 0 And prazoVisitas + prazoPagtoCliente > 0 Then
		diasVisitas = prazoVisitas + prazoPagtoCliente
		totJuros = (capGiroVisitas * (1 + fatorJuros) ^ diasVisitas) - capGiroVisitas
		totIOF = (capGiroVisitas * (1 + fatorIOF) ^ diasVisitas) - capGiroVisitas
		totIOC = capGiroVisitas * fatorIOC
		jurosVisitas = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'Pré-Venda - Prazo de Pagamento do Cliente somado ao Prazo de Execução
	'===================================================================================================
	If capGiroPV > 0 And prazoExecucao + prazoPagtoCliente > 0 Then
		diasPV = prazoExecucao + prazoPagtoCliente
		totJuros = (capGiroPV * (1 + fatorJuros) ^ diasPV) - capGiroPV
		totIOF = (capGiroPV * (1 + fatorIOF) ^ diasPV) - capGiroPV
		totIOC = capGiroPV * fatorIOC
		jurosPV = totJuros + totIOF + totIOC
	End If
	
	
	'===================================================================================================
	'POC - Prazo de Pagamento do Cliente somado ao Prazo de Execução
	'===================================================================================================
	If capGiroPOC > 0 And prazoExecucao + prazoPagtoCliente > 0 Then
		diasPOC = prazoExecucao + prazoPagtoCliente
		totJuros = (capGiroPOC * (1 + fatorJuros) ^ diasPOC) - capGiroPOC
		totIOF = (capGiroPOC * (1 + fatorIOF) ^ diasPOC) - capGiroPOC
		totIOC = capGiroPOC * fatorIOC
		jurosPOC = totJuros + totIOF + totIOC
	End If
	
	
Fim:	
	negocio.CapGiroImportacao_P = capGiroImportacao
	negocio.CapGiroSiscomex_P = capGiroSiscomex
	negocio.CapGiroCMV_P = capGiroCMV
	negocio.CapGiroFrete_P = capGiroFrete
	negocio.CapGiroICMSCompra_P = capGiroICMSCompra
	negocio.CapGiroICMSVenda_P = capGiroICMSVenda
	negocio.CapGiroReceber_P = capGiroReceber
	negocio.CapGiroPlanFin_P = capGiroPlanFin
	negocio.CapGiroCPS_P = capGiroCPS
	negocio.CapGiroTerceiros_P = capGiroTerceiros
	negocio.CapGiroVisitas_P = capGiroVisitas
	negocio.CapGiroPV_P = capGiroPV
	negocio.CapGiroPOC_P = capGiroPOC

	negocio.DiasImportacao_P = diasImportacao
	negocio.DiasSiscomex_P = diasSiscomex
	negocio.DiasCMV_P = diasCMV
	negocio.DiasFrete_P = diasFrete
	negocio.DiasICMSCompra_P = diasICMSCompra
	negocio.DiasICMSVenda_P = diasICMSVenda
	negocio.DiasReceber_P = diasReceber
	negocio.DiasPlanFin_P = diasPlanFin
	negocio.DiasCPS_P = diasCPS
	negocio.DiasTerceiros_P = diasTerceiros
	negocio.DiasVisitas_P = diasVisitas
	negocio.DiasPV_P = diasPV
	negocio.DiasPOC_P = diasPOC

	negocio.JurosImportacao_P = jurosImportacao
	negocio.JurosSiscomex_P = jurosSiscomex
	negocio.JurosCMV_P = jurosCMV
	negocio.JurosFrete_P = jurosFrete
	negocio.JurosICMSCompra_P = jurosICMSCompra
	negocio.JurosICMSVenda_P = jurosICMSVenda
	negocio.JurosReceber_P = jurosReceber
	negocio.JurosPlanFin_P = jurosPlanFin
	negocio.JurosCPS_P = jurosCPS
	negocio.JurosTerceiros_P = jurosTerceiros
	negocio.JurosVisitas_P = jurosVisitas
	negocio.JurosPV_P = jurosPV
	negocio.JurosPOC_P = jurosPOC
	negocio.JurosTotal_P = jurosImportacao + jurosSiscomex + jurosCMV + jurosFrete + jurosICMSCompra + jurosICMSVenda + jurosReceber + jurosPlanFin + jurosCPS + jurosTerceiros + jurosVisitas + jurosPV + jurosPOC
	
	'Dias de utilização do Capital de Giro
	If diasImportacao > diasCMV Then negocio.DiasCapitalGiro = diasImportacao Else negocio.DiasCapitalGiro = diasCMV
	
End Sub

'++LotusScript Development Environment:2:1:CkEmpresa:5:8
%REM
	Function ckEmpresa
	Description: Comments for Function
%END REM
Function CkEmpresa(negocio As NotesDocument) As Variant
	
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "empresas.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim scan As Integer
	ReDim tributos(scan) As String, tipos(scan) As String, suframa(scan) As String, ncm(scan) As String, tipoReducao(scan) As String, reducao(scan) As Double
	Dim empresa(2) As String
	Set view = db.GetView("(Dados Cadastrais)")
	Set doc = view.GetDocumentByKey(negocio.CodClienteFaturamento(0), True)
	If Not doc Is Nothing Then
		'Dados da Empresa
		negocio.CodigoGrupoEconomico = doc.CodigoOrigem(0)
		negocio.Cliente = doc.Nome(0)
		negocio.UF = doc.Estado(0)
		negocio.Endereco = Trim(doc.Endereco(0) & " " +  doc.Numero(0) & " " &  doc.Complemento(0))
		negocio.Bairro = doc.Bairro(0)
		negocio.Cidade = doc.Cidade(0)
		negocio.Pais = doc.Pais(0)
		negocio.CEP = doc.CEP(0)
		negocio.CGC = doc.CGC(0)
		negocio.CNAE = doc.CNAE(0)
		negocio.Inscricao = doc.Inscricao(0)
		negocio.IdEmpresa = doc.Id(0)
		negocio.IdGrupoEconomico = doc.IdOrigem(0)
		'InscricaoEstadual
		empresa(0) = RetiraSinais(doc.Inscricao(0))	'empresa(0) = InscricaoEstadual
		If doc.Hasitem("IndicadorIE") Then
			If doc.IndicadorIE(0) = "2" Then		'2 = Isento
				empresa(0) = "Isento"
			ElseIf doc.IndicadorIE(0) = "9" Then	'9 = Não Contribuinte
				empresa(0) = "Não Contribuinte"
			End If
		End If
		If doc.Hasitem("MembroSuframa") Then empresa(1) = doc.MembroSuframa(0)		'empresa(1) = MembroSuframa
		If doc.Hasitem("InscricaoSuframa") Then empresa(2) = doc.InscricaoSuframa(0)'empresa(2) = InscricaoSuframa
		'Exceções Tributárias
		Set view = db.GetView("(ExcecaoTributaria)")
		Set dc = view.Getalldocumentsbykey(negocio.CodClienteFaturamento(0), True)
		Set doc = dc.Getfirstdocument()
		Do Until doc Is Nothing
			ReDim Preserve tributos(scan) As String, tipos(scan) As String, suframa(scan) As String, ncm(scan) As String, tipoReducao(scan) As String, reducao(scan) As Double
			tributos(scan) = doc.Codigo(0)
			tipos(scan) = doc.Tipo(0)
			suframa(scan) = doc.Suframa(0)
			ncm(scan) = doc.NCM(0)
			If doc.TipoReducao(0) = "" Then tipoReducao(scan) = "-" Else tipoReducao(scan) = doc.TipoReducao(0)
			If CStr(doc.PercReducao(0)) <> "" Then reducao(scan) = doc.PercReducao(0)
			scan = scan + 1
			Set doc = dc.Getnextdocument(doc)
		Loop
	End If
	negocio.Tributos = tributos
	negocio.Tipos = tipos
	negocio.Suframa = suframa
	negocio.NCM = ncm
	negocio.TipoReducao = tipoReducao
	negocio.Reducao = reducao
	CkEmpresa = empresa
	
End Function

'++LotusScript Development Environment:2:2:CriarNegocio:5:8
%REM
	Sub CriarNegocio
	Description: Comments for Sub
%END REM
Sub CriarNegocio(negocio As NotesUIDocument, doc As NotesDocument)
	
	Dim scan As Integer
	'Preenche campos apenas se o Cliente for Ativo - LMO 02/04/25
	If CkCliente(doc.CodCliente(0)) Then
		Call negocio.FieldSetText("CodCliente", doc.CodCliente(0))
		Call negocio.FieldSetText("CodigoGrupoEconomico", doc.CodigoGrupoEconomico(0))
		Call negocio.FieldSetText("Cliente", doc.Cliente(0))
		'Contato Comercial
		Call negocio.FieldSetText("ContatoComercial", doc.ContatoComercial(0))
		Call negocio.FieldSetText("CargoComercial", doc.CargoComercial(0))
		Call negocio.FieldSetText("DeptoComercial", doc.DeptoComercial(0))
		Call negocio.FieldSetText("TelComercial", doc.TelComercial(0))
		Call negocio.FieldSetText("CelComercial", doc.CelComercial(0))
		Call negocio.FieldSetText("eMailComercial", doc.eMailComercial(0))
		'Contato Técnico
		Call negocio.FieldSetText("ContatoTecnico", doc.ContatoTecnico(0))
		Call negocio.FieldSetText("CargoTecnico", doc.CargoTecnico(0))
		Call negocio.FieldSetText("DeptoTecnico", doc.DeptoTecnico(0))
		Call negocio.FieldSetText("TelTecnico", doc.TelTecnico(0))
		Call negocio.FieldSetText("CelTecnico", doc.CelTecnico(0))
		Call negocio.FieldSetText("eMailTecnico", doc.eMailTecnico(0))
	End If
	If doc.Form(0) = "Renovacao" Then	'LMO 16/02/21
		Call negocio.FieldSetText("Codigo", doc.Codigo(0))
		Call negocio.FieldSetText("GerenteConta", doc.GerenteConta(0))
		Call negocio.FieldSetText("Inside", doc.Inside(0))
		Call negocio.FieldSetText("AreaVendas", doc.AreaVendas(0))
		Call negocio.FieldSetText("Renovacao", "Sim")
		Call negocio.FieldSetText("Descricao", doc.Descricao(0))
		Call negocio.FieldSetText("Principal", doc.Principal(0))
		Call negocio.FieldSetText("Parceria", doc.Parceria(0))
		Call negocio.FieldSetText("CodEmpresa", doc.CodEmpresa(0))
		Call negocio.FieldSetText("Classe", doc.Classe(0))
		Call negocio.FieldSetText("TipoAdendo", doc.TipoAdendo(0))
		Call negocio.FieldSetText("NegocioPrincipal", doc.NegocioPrincipal(0))
		Call negocio.FieldSetText("Grupo", doc.Grupo(0))
		Call negocio.FieldSetText("TipoVenda", doc.TipoVenda(0))
		Call negocio.FieldSetText("PrazoPagamento", CStr(doc.PrazoPagamento(0)))
		Call negocio.FieldSetText("PrazoPagamentoFornecedor", CStr(doc.PrazoPagamentoFornecedor(0)))
	Else
		Call negocio.FieldSetText("Renovacao", "Não")
	End If
	If doc.Form(0) = "Renovacao" Or doc.Form(0) = "Prejuizo" Then	'LMO 02/09/21
		Call negocio.FieldSetText("Origem", doc.Form(0))
		Call negocio.FieldSetText("CodigoOrigem", doc.Codigo(0))
	End If
	'Lista de Materiais
	For scan = 0 To 49
		If doc.GetItemValue("Produto_" & scan)(0) <> "" Then
			Call negocio.FieldSetText("Q_" & scan, CStr(doc.GetItemValue("Q_" & scan)(0)))
			Call negocio.FieldSetText("PartNo_" & scan, doc.GetItemValue("PartNo_" & scan)(0))
			Call negocio.FieldSetText("Produto_" & scan, doc.GetItemValue("Produto_" & scan)(0))
			Call negocio.FieldSetText("t_" & scan, doc.GetItemValue("t_" & scan)(0))
			Call negocio.FieldSetText("Un_" & scan, doc.GetItemValue("Un_" & scan)(0))
			Call negocio.FieldSetText("CF_" & scan, doc.GetItemValue("CF_" & scan)(0))
			Call negocio.FieldSetText("ST_" & scan, doc.GetItemValue("ST_" & scan)(0))
			Call negocio.FieldSetText("Fabricante_" & scan, doc.GetItemValue("Fabricante_" & scan)(0))
			Call negocio.FieldSetText("UFCompra_" & scan, doc.GetItemValue("UFCompra_" & scan)(0))
			Call negocio.FieldSetText("us_" & scan, doc.GetItemValue("us_" & scan)(0))
			Call negocio.FieldSetText("CustoFob_" & scan, CStr(doc.GetItemValue("CustoFob_" & scan)(0)))
			Call negocio.FieldSetText("FI_" & scan, CStr(doc.GetItemValue("FI_" & scan)(0)))
			Call negocio.FieldSetText("Custo_" & scan, CStr(doc.GetItemValue("Custo_" & scan)(0)))
			Call negocio.FieldSetText("ICMSSTC_" & scan, CStr(doc.GetItemValue("ICMSSTC_" & scan)(0)))
			Call negocio.FieldSetText("Mg_" & scan, CStr(doc.GetItemValue("Mg_" & scan)(0)))
			Call negocio.FieldSetText("CustoUnit_" & scan, CStr(doc.GetItemValue("CustoUnit_" & scan)(0)))
		End If
	Next
	'Lista de Serviços - LMO 01/09/21
	If doc.Form(0) = "Prejuizo" Then
		For scan = 0 To 11
			If doc.GetItemValue("Produto_" & scan)(0) <> "" Then
				Call negocio.FieldSetText("Qs_" & scan, CStr(doc.GetItemValue("Qs_" & scan)(0)))
				Call negocio.FieldSetText("PartNos_" & scan, doc.GetItemValue("PartNos_" & scan)(0))
				Call negocio.FieldSetText("Produtos_" & scan, doc.GetItemValue("Produtos_" & scan)(0))
				Call negocio.FieldSetText("uss_" & scan, doc.GetItemValue("uss_" & scan)(0))
				Call negocio.FieldSetText("Custos_" & scan, Format(doc.GetItemValue("Custos_" & scan)(0), "Standard"))
				Call negocio.FieldSetText("Terceiros_" & scan, Format(doc.GetItemValue("Terceiros_" & scan)(0), "Standard"))
				Call negocio.FieldSetText("Mgs_" & scan, CStr(doc.GetItemValue("Mgs_" & scan)(0)))
				Call negocio.FieldSetText("CustoUnits_" & scan, Format(doc.GetItemValue("CustoUnits_" & scan)(0), "Standard"))
				Call negocio.FieldSetText("Despesas_" & scan, Format(doc.GetItemValue("Despesas_" & scan)(0), "Standard"))
				Call negocio.FieldSetText("CPS_" & scan, Format(doc.GetItemValue("CPS_" & scan)(0), "Standard"))
				Call negocio.FieldSetText("CusTots_" & scan, Format(doc.GetItemValue("CusTots_" & scan)(0), "Standard"))
				Call negocio.FieldSetText("RIR_" & scan, CStr(doc.GetItemValue("RIR_" & scan)(0)))
				Call negocio.FieldSetText("RIN_" & scan, CStr(doc.GetItemValue("RIN_" & scan)(0)))
				Call negocio.FieldSetText("ISS_" & scan, CStr(doc.GetItemValue("ISS_" & scan)(0)))
			End If
		Next
	End If
	
End Sub

'++LotusScript Development Environment:2:2:AtualizaMovimentoNegocio:1:8
 Sub AtualizaMovimentoNegocio(negocio As NotesDocument, scan As integer)
	
	Print "Atualizando Movimentos"
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView, catalogo As NotesView
	Dim dc As NotesDocumentCollection
	Dim movimento As NotesDocument, equipamento As NotesDocument
	Dim Key(3) As String
	Key(0) = negocio.GetItemValue("PartNo_" & scan)(0)
	Key(1) = negocio.Codigo(0)
	key(2) = negocio.CodEmpresa(0)
	Key(3) = CStr(scan + 1)
	Set db = New NotesDatabase(negocio.ParentDatabase.Server,"estoquemain.nsf")
	Set view = db.GetView("(Movimento/PartNoReservaCod)")
	Set dc = view.GetAllDocumentsBykey(Key, True)
	Set movimento = dc.GetFirstDocument
	Do Until movimento Is Nothing
		If Val(movimento.QSaida(0)) > 0 Then	'Movimento já teve saída
			'Gera Movimento Resposta
			Dim movimentoResposta As New NotesDocument(db)
			movimentoResposta.Form = "MovimentoResposta"
			movimentoResposta.Id = geraJavaId(movimentoResposta)
			movimentoResposta.Autor = session.Commonusername
			movimentoResposta.Criacao = Today
			movimentoResposta.PartNo = movimento.PartNo(0)
			movimentoResposta.Produto = movimento.Produto(0)
			movimentoResposta.Movimento = "Saída"
			movimentoResposta.Tipo = "Revenda"
			movimentoResposta.Q = negocio.GetItemValue("Q_" & scan)(0)
			movimentoResposta.Data = Today
			movimentoResposta.Responsavel = session.CommonUserName
			movimentoResposta.ST = 000
			movimentoResposta.UF = negocio.UF(0)
			movimentoResposta.Moeda = movimento.Moeda(0)
			movimentoResposta.Valor = 0
			movimentoResposta.Cotacao = 0
			movimentoResposta.ValorReal = 0
			movimentoResposta.IC = 0
			movimentoResposta.ICST = 0
			movimentoResposta.IP = 0
			movimentoResposta.II = 0
			movimentoResposta.ValorCompra = movimento.ValorCompra(0)
			movimentoResposta.ValorVenda = 0
			movimentoResposta.Margem = CDbl(movimentoResposta.ValorVenda(0)) - movimentoResposta.ValorCompra(0)
			movimentoResposta.Codigo = movimento.Codigo(0)
			movimentoResposta.NItem = movimento.NItem(0)
			movimentoResposta.CodEspelho = ""
			movimentoResposta.CodEmpresa = movimento.CodEmpresa(0)
			movimentoResposta.RegrasFiscais = negocio.RegrasFiscais(0)
			Call movimentoResposta.Makeresponse(movimento)
			Call movimentoResposta.save (True, True)
		Else
			'Atualiza Movimento
			movimento.Propriedade = "Não"
			movimento.Posse = "Não"
			movimento.CodEspelho = ""
			movimento.RegrasFiscaisS = negocio.RegrasFiscais(0)
			movimento.DataSaida = Today
			movimento.ResponsavelSaida = session.CommonUserName
			movimento.Negocio = negocio.Codigo(0)
			movimento.CodClienteSaida = negocio.CodCliente(0)
			movimento.CotacaoSaida = 0
			movimento.Moeda_3 = negocio.GetItemValue("Us_" & scan)(0)
			movimento.Moeda_4 = negocio.GetItemValue("Us_" & scan)(0)
			movimento.IC_Venda = 0
			movimento.DifIC_Venda = 0
			movimento.IPI_Venda = 0
			movimento.ST_Venda = 0
			movimento.UF_Venda = negocio.UF(0)
			movimento.AreaVenda = negocio.AreaVendas(0)
			movimento.ValorSaida = 0
			movimento.ValorRealSaida = 0
			movimento.ValorVenda = 0
			movimento.Margem = CDbl(movimento.ValorVenda(0)) - movimento.ValorCompra(0)
			movimento.SaidaTipo = "Revenda"
			movimento.Status = "Revenda"
			movimento.FlagContrato = "0"
			movimento.FlagAlmoxarifado = "0"
			movimento.QSaida = negocio.GetItemValue("Q_" & scan)(0)
		End If
		'Atualiza Saldo do Movimento Principal
		movimento.Saldo = 0
		movimento.Tipo = "Saída"
		Call movimento.save (True, True)
		Set movimento = dc.Getnextdocument(movimento)
	Loop
	'Atualiza Catálogo do Estoque Main
	Set catalogo = db.GetView("(Catalogo/PartNumber)")
	Set equipamento = catalogo.GetDocumentByKey(Key(0), True)
	If Not equipamento Is Nothing Then
		equipamento.Quantidade = Val(equipamento.Quantidade(0)) - Val(negocio.GetItemValue("Q_" & scan)(0))
		Call equipamento.save (True, True)
	End If
	
End Sub

'++LotusScript Development Environment:2:1:CheckItensAgente:1:8
Function CheckItensAgente ( doc As NotesDocument ) As Integer
	'Retorna 1 em caso de sucesso
	'Retorna -1 qdo Você precisa completar todos os dados da lista de Materiais
	'Retorna -2 qdo Você precisa incluir as alíquota de ICMS Produto
	'Retorna -3 qdo Você precisa incluir as retenções dos serviços
	'Retorna -4 qdo As alíquitas podem ser 1,5% para IR e 11% para INSS
	'Retorna -5 qdo Você precisa completar todos os dados da lista de Serviços
	'Retorna -6 qdo Você precisa incluir as Retenções no Serviço
	'Retorna -7 qdo As alíquotas de IR são de 1,5% e de INSS são de 11%
	'Retorna -8 qdo Não há Nenhum ítem na lista referente à venda
	REM Verifica se todos os dados relevantes estão cadastrados na lista de materiais e servicos antes do fechamento
	REM ou da alteração
	Dim msg As Variant
	Dim qvar As Integer, custo As Double, mg As Double, venda As Double, custotvar As Double
	Dim scan As Integer
	Dim ckQtd As Variant, ckCusto As Variant, ckMg As Variant, ckCustoUnit As Variant, ckT As Variant, ckIC As Variant
	Dim ckIP As Variant, ckCustoUnits As Variant, ckProdutos As Variant, ckRIR As Variant, ckRIN As Variant
	Dim strCusto As String, strMg As String, CustoUnit As String, T As String, IC As String, IP As String
	Dim CustoUnits As String, Produtos As String, RIR As String, RIN As String
	Dim QtdMateriais As Long, QtdServicos As Long	'Contador usado apenas epara verificação
	
	CheckItensAgente = 1
	QtdMateriais = 0
	QtdServicos = 0
	
	If doc.TipoVenda(0) <> "Contrato" Then	
		For scan% = 0 To 49
			
			ckQtd = doc.GetItemValue ( "Q_" & CStr( scan% ) )
			ckCusto = doc.GetItemValue ( "Custo_" & CStr( scan% ) )
			ckMg = doc.GetItemValue ( "Mg_" & CStr( scan% ) )
			ckCustoUnit = doc.GetItemValue ( "CustoUnit_" & CStr( scan% ) )
			ckT = doc.GetItemValue ( "T_" & CStr( scan% ) )
			ckIC = doc.GetItemValue ( "IC_" & CStr( scan% ) )
			ckIP = doc.GetItemValue ( "IP_" & CStr( scan% ) )
			
			qvar% = Val( ckQtd( 0 ) )
			strCusto = CStr ( ckCusto(0) )
			strMg = CStr ( ckMg(0) )
			CustoUnit = CStr ( ckCustoUnit (0) )
			T = CStr ( ckT (0) )
			IC = CStr ( ckIC (0) )
			IP = CStr ( ckIP (0) )
			
			If  qvar%  > 0  Then     ' Verificando se o conteúdo da variante é numerica
				
				QtdMateriais = QtdMateriais + 1
				If  strCusto= ""   Or strMg  = "" Or CustoUnit = ""  Then
					'msg = Msgbox( "Você precisa completar todos os dados da lista de Materiais no Ítem Nº " & ui.FieldGetText( "Produto_" & Cstr( scan%) ), 0 , "Erro de Preenchimento de Lista de Materiais" )
					CheckItensAgente = -1
					Exit Function
				End If
				
				If T = "HW" And  CDbl( IC ) = 0 Then                                       
					'msg = Msgbox( "Você precisa incluir as alíquota de ICMS Produto  " & ui.FieldGetText( "Produto_" & Cstr( scan%) ), 0 , "Erro de Preenchimento de Lista de Materiais" )
					CheckItensAgente = -2
					Exit Function                    
				End If
				
				If T = "SV" Then
					If  IC  = "" Or IP  = ""  Then                                       
						'msg = Msgbox( "Você precisa incluir as retenções dos serviços  " & ui.FieldGetText( "Produto_" & Cstr( scan%) ), 0 , "Erro de Preenchimento de Lista de Materiais" )
						CheckItensAgente = -3
						Exit Function                    
					ElseIf ( CDbl( IC ) <> 0.015 And CDbl( IC ) <> 0 ) Or ( CDbl( IP) <> 0.11 And CDbl( IP ) <> 0 ) Then
						'msg = Msgbox( "As alíquitas podem ser 1,5% para IR e 11% para INSS - " & ui.FieldGetText( "Produto_" & Cstr( scan%) ), 0 , "Erro de Preenchimento de Lista de Materiais" )
						CheckItensAgente = -4
						Exit Function                                           
					End If     
				End If
				
				If T = "SW" Then 'a Alíquota de Software é sempre 18%
					Call doc.ReplaceItemValue( "IC_"& CStr( scan% ), 18% )                    
				End If
				
			End If
			
		Next
		
	End If
	
	If doc.TipoVenda(0) = "Projeto" Or doc.TipoVenda(0) = "Chamado" Then
		
		For scan% = 0 To 11 
			
			ckQtd = doc.GetItemValue ( "Q" & CStr( scan% ) )			
			ckCustoUnits = doc.GetItemValue ( "CustoUnits_" & CStr( scan% ) )
			ckProdutos = doc.GetItemValue ( "Produtos_" & CStr( scan% ) )
			ckRIR = doc.GetItemValue ( "RIR_" & CStr( scan% ) )
			ckRIN = doc.GetItemValue ( "RIN_" & CStr( scan% ) )
			
			qvar% = Val( ckQtd(0) )
			CustoUnits = CStr ( ckCustoUnits (0) )
			Produtos = CStr ( ckProdutos (0) )
			RIR = CStr ( ckRIR (0) )
			RIN = CStr ( ckRIN (0) )
			
			If  qvar%  > 0  Then     
				
				QtdServicos = QtdServicos + 1				
				If CustoUnits = ""   Or  Produtos  = ""  Then
					'msg = Msgbox( "Você precisa completar todos os dados da lista de Serviços- Serviço Nº " & ui.FieldGetText( "Produtos_" & Cstr( scan%) ), 0 , "Erro de Preenchimento de Lista de Serviços" )
					CheckItensAgente = -5
					Exit Function
				End If
				
				If RIR = "" Or  RIN = "" Then
					'msg = Msgbox( "Você precisa incluir as Retenções no Serviço " & ui.FieldGetText( "Produtos_" & Cstr( scan%) ), 0 , "Erro de Preenchimento de Lista de Serviços" )
					CheckItensAgente = -6
					Exit Function                    
				End If
				Dim a As Double
				If ( CDbl( RIR ) <> 0.015 And CDbl( RIR ) <> 0 ) Or ( CDbl( RIN ) <> 0.11 And CDbl( RIN ) <> 0 ) Then
					a# = CDbl( RIR )
					'msg = Msgbox( "As alíquotas de IR são de 1,5% e de INSS são de 11% - " & ui.FieldGetText( "Produtos_" & Cstr( scan%) ), 0 , "Erro de Preenchimento de Lista de Serviços" )
					CheckItensAgente = -7
					Exit Function                    
				End If               
				
			End If
			
		Next   
		
	End If
	
	If ( doc.TipoVenda(0) = "Projeto" Or doc.TipoVenda(0) = "Chamado" ) And QtdServicos = 0 And QtdMateriais = 0 Then
		CheckItensAgente = -8
		Exit Function
	ElseIf ( doc.TipoVenda(0) = "Venda Simples" And QtdMateriais = 0 ) Then
		CheckItensAgente = -8
		Exit Function
	End If
	
	CheckItensAgente = 1
End Function

'++LotusScript Development Environment:2:1:CkDadosEmpresa:1:8
Function CkDadosEmpresa (empresa As NotesDocument) As Variant
	
	Dim ck(1) As Variant
	Dim msg As String
	If empresa.Nome(0) = "" Then
		msg = Chr(10) + "Razão Social"
		ck(0) = False
	End If
	If empresa.Endereco(0) = "" Then
		msg = msg + Chr(10) + "Endereço"
		ck(0) = False
	End If
	If empresa.Numero(0) = "" Then
		msg = msg + Chr(10) + "Número"
		ck(0) = False
	End If
	If empresa.Telefones(0) = "" Then
		msg = msg + Chr(10) + "Telefones"
		ck(0) = False
	End If
	If empresa.Cidade(0) = "" Then
		msg = msg + Chr(10) + "Cidade"
		ck(0) = False
	End If
	If empresa.Estado(0) = "" Then
		msg = msg + Chr(10) + "Estado"
		ck(0) = False
	End If
	If empresa.Cep(0) = "" Then
		msg = msg + Chr(10) + "Cep"
		ck(0) = False
	End If
	If empresa.Pais(0) = "Brasil" Or empresa.Pais(0) = "Brazil" Then
		If empresa.Bairro(0) = "" Then
			msg = msg + Chr(10) + "Bairro"
			ck(0) = False
		End If
		If empresa.CGC(0) = "" And empresa.CPF(0) = "" Then
			msg = msg + Chr(10) + "CNPJ/CPF"
			ck(0) = False
		End If
		If empresa.Inscricao(0) = "" Then
			msg = msg + Chr(10) + "Inscrição Estadual"
			ck(0) = False
		End If
	End If
	ck(0) = True
	ck(1) = msg
	CkDadosEmpresa = ck
	
End Function

'++LotusScript Development Environment:2:1:CheckAceiteFaturamento:5:8
%REM
	Function CheckAceiteFaturamento
	Description: Comments for Function
%END REM
Function CheckAceiteFaturamento(codigo As String) As String
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Set view = db.Getview("(EspelhosNegocioAceitePendente)")
	Set doc = view.Getdocumentbykey(codigo, true)
	If Not doc Is Nothing Then
		CheckAceiteFaturamento = CStr(doc.NFiscal(0))
	End If
	
End Function


'++LotusScript Development Environment:2:2:MargensListaUI:1:8
Sub MargensListaUI(ui As NotesUiDocument)
	
	'Calcula as Margens dos Itens do Negócio
	Dim qvar As Long, custoFOB As Double, fi As Double, custo As Double, icmsst As Double, mg As Double, venda As Double
	Dim scan As Integer, us As String
	For scan = 0 To 49
		qvar = Val(ui.FieldGetText("Q_" & scan))
		If qvar > 0 Then
			'Calcula CustoFOB/FI/Custo
			If ui.FieldGetText("CustoFOB_" & scan) = "" Then custoFOB = 0 Else custoFOB = CDbl(ui.FieldGetText("CustoFOB_" & scan))
			If ui.FieldGetText("FI_" & scan) = "" Then fi = 0 Else fi = CDbl(ui.FieldGetText("FI_" & scan))
			If ui.FieldGetText("Custo_" & scan) = "" Then custo = 0 Else custo = CDbl(ui.FieldGetText("Custo_" & scan))
			If custoFOB > 0 Or fi > 0 Then
				'Tem que ter ao menos 2 valores preenchidos
				If (custoFOB = 0 And fi = 0) Or (custoFOB = 0 And custo = 0) Or (fi = 0 And custo = 0) Then
					GoTo proximo
				End If
				'1) Calcula o Custo (CustoFOB e Fator de Importação preenchidos ou 3 campos preenchidos)
				If (custoFOB > 0 And fi > 0 And custo = 0) Or (custoFOB > 0 And fi > 0 And custo > 0) Then
					custo = custoFOB * fi
				'2)	Calcula o Fator de Importação (CustoFOB e Custo preenchidos)
				ElseIf custoFOB > 0 And fi = 0 And custo > 0 Then
					fi = custo / custoFOB
				'3) Calcula o CustoFOB (Fator de Importação e Custo preenchidos)
				ElseIf custoFOB = 0 And fi > 0 And custo > 0 Then
					custoFOB = custo / fi
				End If
				Call ui.FieldSetText("CustoFOB_" & scan, CStr(custoFOB))
				Call ui.FieldSetText("FI_" & scan, Format(fi, "Fixed"))
				Call ui.FieldSetText("Custo_" & scan, CStr(custo))
			End If
			'Calcula Custo/Margem/Custo Unitário
			If ui.FieldGetText("Custo_" & scan) = "" Then custo = 0 Else custo = Cdbl(ui.FieldGetText("Custo_" & scan))
			If ui.FieldGetText("Mg_" & scan) = "" Then mg = 0 Else mg = Cdbl(ui.FieldGetText("Mg_" & scan))
			If ui.FieldGetText("CustoUnit_" & scan) = "" Then venda = 0 Else venda = Cdbl(ui.FieldGetText("CustoUnit_" & scan))
			If ui.FieldGetText("ICMSSTC_" & scan) = "" Then icmsst = 0 Else icmsst = CDbl(ui.FieldGetText("ICMSSTC_" & scan))
			'Tem que ter ao menos 2 valores preenchidos
			If (custo# = 0 And mg# = 0) Or (custo# = 0 And venda# = 0) Or (mg# = 0 And venda# = 0) Then
				GoTo proximo
			End If
			If (mg = 0 And custo > 0 And venda > 0) Or (custo > 0 And mg > 0 And venda > 0) Then
				'1)Custo e Venda preenchidos ou 3 campos preenchidos: Calcula a Margem
				mg = Round((custo + icmsst) / venda, 2)
			Elseif venda = 0  And custo > 0  And mg > 0 Then
				'2)Custo e Margem preenchidos: Calcula a Venda
				venda = Round((custo + icmsst) / mg, 2)
			Elseif custo = 0 And mg > 0 And venda > 0 Then
				'3) Margem e Venda preenchidos: Calcula o Custo
				custo = Round(venda * mg, 2) - icmsst
			End If
			Call ui.FieldSetText("Mg_" & scan, Format(mg, "Fixed"))
			Call ui.FieldSetText("Custo_" & scan, CStr(custo))
			Call ui.FieldSetText("CustoUnit_" & scan, CStr(venda))
		End If
proximo:
	Next
	'Calcula o Total do Negócio
	Call ui.Refresh
	
End Sub

'++LotusScript Development Environment:2:2:GeraDocumentoPublico:1:8
Sub GeraDocumentoPublico (doc As NotesDocument)
	
	'O Documento Público é utilizado para a Geração do Código dos Negócios  LMO-22/07/03
	Dim db as New NotesDatabase(doc.Parentdatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim docPub As NotesDocument
	Dim newdoc As NotesDocument
	Set view = db.GetView("(CodigoNegocio)")
	Set docPub = view.GetDocumentByKey(doc.Codigo(0), True)
	If docPub Is Nothing Then
		Set newdoc = db.CreateDocument
		newdoc.Form = "CodigoNegocio"
		newdoc.Id = geraJavaId(newdoc)
		newdoc.Codigo = doc.Codigo(0)
		newdoc.CodCliente = doc.CodCliente(0)
		newdoc.Cliente = doc.Cliente(0)
		newdoc.Descricao = doc.Descricao(0)
		newdoc.SaldoHoras = doc.SaldoHoras(0)
		Call newdoc.ComputeWithForm (False, False)
		Call newdoc.Save (True, True)
	Else
		'Atualiza o Documento Público
		docPub.CodCliente = doc.CodCliente(0)
		docPub.Cliente = doc.Cliente(0)
		docPub.Descricao = doc.Descricao(0)
		docPub.SaldoHoras = doc.SaldoHoras(0)
		Call docPub.Save (True, True)
	End If
	
End Sub

'++LotusScript Development Environment:2:2:StatusProjeto:5:8
%REM
	Sub StatusProjeto
	Description: Comments for Sub
%END REM
Sub StatusProjeto(doc As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim dbVendas As New NotesDatabase(doc.ParentDatabase.Server, "sales.nsf")
	Dim viewVendas As NotesView
	Dim negocio As NotesDocument
	Dim ckFechado As Boolean
	Dim data As String
	Set viewVendas = dbVendas.GetView("(NegociosCodigo)")
	Set negocio = viewVendas.GetDocumentByKey(doc.Codigo(0), True)
	If negocio Is Nothing Then
		doc.Sit = "Negócio foi Deletado"
		doc.StatusNegocio = "Negócio foi Deletado"
		doc.SitNumero = 0
		Exit Sub
	End If
	doc.DescricaoNegocio = negocio.Descricao(0)
	doc.StatusNegocio = negocio.Sit(0)
	'Contrato
	If doc.Form(0) = "Contrato" Then
		If negocio.Sit(0) = "Contrato" Then
			doc.Sit = "Ativo"
			doc.SitNumero = 0
			Exit Sub
		ElseIf negocio.TipoVenda(0) = "Contrato" And negocio.Sit(0) = "Concluído" Then
			doc.Sit = "Inativo"
			doc.SitNumero = 0
			Exit Sub
		End If
	'Projeto
	Else
		If negocio.Sit(0) = "Perdido" Then
			doc.Sit = "Perdido"
			doc.SitNumero = 46
			Exit Sub
		ElseIf negocio.Sit(0) = "Consolidado" Then
			doc.Sit = "Consolidado"
			doc.SitNumero = 47
			Exit Sub
		ElseIf negocio.Sit(0) = "Postergado" Then
			doc.Sit = "Postergado"
			doc.SitNumero = 48
			Exit Sub
		ElseIf negocio.Sit(0) = "Aguardando Análise da Perda" Then
			doc.Sit = "Aguardando Análise da Perda"
			doc.SitNumero = 45
			Exit Sub
		End If
		ckFechado = Fechado(negocio.Sit(0))
	End If
	
	'Negócio foi Deletado
	If doc.Sit(0) = "Negócio foi Deletado" Then
		If InStr(negocio.Sit(0), "Pré-Venda") > 0 Then
			doc.Sit = "Aguardando Planejamento da Pré-Venda"
			doc.SitNumero = 1
			If doc.DataLimitePV(0) <> "" Then
				If CDat(Today) > CDat(doc.DataLimitePV(0)) Then
					doc.Sit = "Planejamento da Pré-Venda em Atraso"
					doc.SitNumero = 2
				End If
			End If
			Exit Sub
		ElseIf InStr(negocio.Sit(0), "POC") > 0 Then
			doc.Sit = "Aguardando Planejamento do POC"
			doc.SitNumero = 15
			If doc.DataLimitePOC(0) <> "" Then
				If CDat(Today) > CDat(doc.DataLimitePOC(0)) Then
					doc.Sit = "Planejamento do POC em Atraso"
					doc.SitNumero = 16
				End If
			End If
			Exit Sub
		ElseIf ckFechado Then
			doc.Sit = "Aguardando Início da Execução"
			doc.SitNumero = 32
			If CStr(doc.PrevInicio(UBound(doc.PrevInicio))) <> "" Then
				If CDat(Today) > CDat(doc.PrevInicio(UBound(doc.PrevInicio))) Then
					doc.Sit = "Início da Execução em Atraso"
					doc.SitNumero = 33
				End If
			End If
			Exit Sub
		End If	
	End If
	
	'***** Pré-Venda *****
	'1)Aguardando Planejamento da Pré-Venda (2 dias)
	'2)Planejamento da Pré-Venda em Atraso
	'3)Aguardando Início da Pré-Venda
	'4)Início da Pré-Venda em Atraso
	'5)Pré-Venda em Execução
	'6)Final da Pré-Venda em Atraso
	'7)Aguardando Revisão da Pré-Venda
	'8)Revisão da Pré-Venda em Atraso (1 dia)
	'9)Pré-Venda Aguardando Providências do Cliente
	'10)Pré-Venda Aguardando Providências Internas
	'11)Pré-Venda Aguardando Materiais
	'12)Pré-Venda Aguardando doc Relacionado
	'13)Check Point de Pré-Venda Atrasado
	'****
	
	If doc.CkPreVenda(0) = "" And ckFechado = False Then
		If doc.Sit(0) = "Aguardando Planejamento da Pré-Venda" Then
			doc.Sit = "Aguardando Planejamento da Pré-Venda"
			doc.SitNumero = 1
			If doc.DataLimitePV(0) <> "" Then
				If CDat(Today) > CDat(doc.DataLimitePV(0)) Then
					doc.Sit = "Planejamento da Pré-Venda em Atraso"
					doc.SitNumero = 2
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Planejamento da Pré-Venda em Atraso" Then
			doc.SitNumero = 2
			Exit Sub
		ElseIf doc.Sit(0) = "Aguardando Início da Pré-Venda" Then
			doc.SitNumero = 3
			If CStr(doc.PrevInicioPV(UBound(doc.PrevInicioPV))) <> "" Then
				If CDat(Today) > CDat(doc.PrevInicioPV(UBound(doc.PrevInicioPV))) Then
					doc.Sit = "Início da Pré-Venda em Atraso"
					doc.SitNumero = 4
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Início da Pré-Venda em Atraso" Then
			doc.SitNumero = 4
			If CStr(doc.PrevInicioPV(UBound(doc.PrevInicioPV))) <> "" Then
				If CDat(Today) <= CDat(doc.PrevInicioPV(UBound(doc.PrevInicioPV))) Then
					doc.Sit = "Aguardando Início da Pré-Venda"
					doc.SitNumero = 3
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Pré-Venda em Execução" Then
			doc.SitNumero = 5
			If CStr(doc.PrevEntregaPV(UBound(doc.PrevEntregaPV))) <> "" Then
				If CDat(Today) > CDat(doc.PrevEntregaPV(UBound(doc.PrevEntregaPV))) Then
					doc.Sit = "Final da Pré-Venda em Atraso"
					doc.SitNumero = 6
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Final da Pré-Venda em Atraso" Then
			doc.SitNumero = 6
			If CStr(doc.PrevEntregaPV(UBound(doc.PrevEntregaPV))) <> "" Then
				If CDat(Today) <= CDat(doc.PrevEntregaPV(UBound(doc.PrevEntregaPV))) Then
					doc.Sit = "Pré-Venda em Execução"
					doc.SitNumero = 5
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Aguardando Revisão da Pré-Venda" Then
			doc.SitNumero = 7
			If CStr(doc.PrevRevisaoPV(UBound(doc.PrevRevisaoPV))) <> "" Then
				If CDat(Today) > CDat(doc.PrevRevisaoPV(UBound(doc.PrevRevisaoPV))) Then
					doc.Sit = "Revisão da Pré-Venda em Atraso"
					doc.SitNumero = 8
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Revisão da Pré-Venda em Atraso" Then
			doc.SitNumero = 8
			If CStr(doc.PrevRevisãoPV(UBound(doc.PrevRevisaoPV))) <> "" Then
				If CDat(Today) <= CDat(doc.PrevRevisaoPV(UBound(doc.PrevRevisaoPV))) Then
					doc.Sit = "Aguardando Revisão da Pré-Venda"
					doc.SitNumero = 7
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Pré-Venda Aguardando Providências do Cliente" Then
			doc.SitNumero = 9
			If CStr(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) Then
					doc.Sit = "Check Point de Pré-Venda Atrasado"
					doc.SitNumero = 13
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point de Pré-Venda Atrasado" And doc.MotivoPV(UBound(doc.MotivoPV)) = "Cliente" Then
			doc.SitNumero = 13
			If CStr(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) Then
					doc.Sit = "Pré-Venda Aguardando Providências do Cliente"
					doc.SitNumero = 9
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Pré-Venda Aguardando Providências Internas" Then
			doc.SitNumero = 10
			If CStr(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) Then
					doc.Sit = "Check Point de Pré-Venda Atrasado"
					doc.SitNumero = 13
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point de Pré-Venda Atrasado" And doc.MotivoPV(UBound(doc.MotivoPV)) = "Interno" Then
			doc.SitNumero = 13
			If CStr(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) Then
					doc.Sit = "Pré-Venda Aguardando Providências Internas"
					doc.SitNumero = 10
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Pré-Venda Aguardando Materiais" Then
			doc.SitNumero = 11
			If CStr(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) Then
					doc.Sit = "Check Point de Pré-Venda Atrasado"
					doc.SitNumero = 13
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point de Pré-Venda Atrasado" And doc.MotivoPV(UBound(doc.MotivoPV)) = "Atraso de Material" Then
			doc.SitNumero = 13
			If CStr(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) Then
					doc.Sit = "Pré-Venda Aguardando Materiais"
					doc.SitNumero = 11
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Pré-Venda Aguardando doc Relacionado" Then
			doc.SitNumero = 12
			If CStr(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) Then
					doc.Sit = "Check Point de Pré-Venda Atrasado"
					doc.SitNumero = 13
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point de Pré-Venda Atrasado" And doc.MotivoPV(UBound(doc.MotivoPV)) = "Dependência de Outro doc" Then
			doc.SitNumero = 13
			If CStr(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPointPV(UBound(doc.DataCheckPointPV))) Then
					doc.Sit = "Pré-Venda Aguardando doc Relacionado"
					doc.SitNumero = 12
				End If
			End If
			Exit Sub
		End If
	End If
	'***** Fim da Pré-Venda *****
	
	'***** Forecast *****
	'14)Aguardando Fechamento
	If negocio.Sit(0) = "Prospect" Or negocio.Sit(0) = "Forecast" Or negocio.Sit(0) = "Faturamento Futuro" Or negocio.Sit(0) = "Aguardando Aprovação" Then
		doc.Sit = "Aguardando Fechamento"
		doc.SitNumero = 14
		Exit Sub
	End If
	'***** Fim do Forecast *****
	
	'***** POC *****
	'15)Aguardando Planejamento do POC (2 dias)
	'16)Planejamento dO POC em Atraso
	'17)Aguardando Início do POC
	'18)Início do POC em Atraso
	'19)POC em Execução
	'20)Final do POC em Atraso
	'21)POC Aguardando Providências do Cliente
	'22)POC Aguardando Providências Internas
	'23)POC Aguardando Materiais
	'24)POC Aguardando doc Relacionado
	'25)Check Point do POC Atrasado
	'****
	If doc.CkConclusaoPOC(0) = "" And ckFechado = False Then
		If doc.Sit(0) = "Aguardando Planejamento do POC" Then
			doc.Sit = "Aguardando Planejamento do POC"
			doc.SitNumero = 15
			If doc.DataLimitePOC(0) <> "" Then
				If CDat(Today) > CDat(doc.DataLimitePOC(0)) Then
					doc.Sit = "Planejamento do POC em Atraso"
					doc.SitNumero = 16
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Planejamento do POC em Atraso" Then
			doc.SitNumero = 16
			Exit Sub
		ElseIf doc.Sit(0) = "Aguardando Início do POC" Then
			doc.SitNumero = 17
			If CStr(doc.PrevInicioPOC(UBound(doc.PrevInicioPOC))) <> "" Then
				If CDat(Today) > CDat(doc.PrevInicioPOC(UBound(doc.PrevInicioPOC))) Then
					doc.Sit = "Início do POC em Atraso"
					doc.SitNumero = 18
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Início do POC em Atraso" Then
			doc.SitNumero = 18
			If CStr(doc.PrevInicioPOC(UBound(doc.PrevInicioPOC))) <> "" Then
				If CDat(Today) <= CDat(doc.PrevInicioPOC(UBound(doc.PrevInicioPOC))) Then
					doc.Sit = "Aguardando Início do POC"
					doc.SitNumero = 17
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "POC em Execução" Then
			doc.SitNumero = 19
			If CStr(doc.PrevEntregaPOC(UBound(doc.PrevEntregaPOC))) <> "" Then
				If CDat(Today) > CDat(doc.PrevEntregaPOC(UBound(doc.PrevEntregaPOC))) Then
					doc.Sit = "Final do POC em Atraso"
					doc.SitNumero = 20
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Final do POC em Atraso" Then
			doc.SitNumero = 20
			If CStr(doc.PrevEntregaPOC(UBound(doc.PrevEntregaPOC))) <> "" Then
				If CDat(Today) <= CDat(doc.PrevEntregaPOC(UBound(doc.PrevEntregaPOC))) Then
					doc.Sit = "POC em Execução"
					doc.SitNumero = 19
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "POC Aguardando Providências do Cliente" Then
			doc.SitNumero = 21
			If CStr(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) Then
					doc.Sit = "Check Point do POC Atrasado"
					doc.SitNumero = 25
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point do POC Atrasado" And doc.MotivoPOC(UBound(doc.MotivoPOC)) = "Cliente" Then
			doc.SitNumero = 25
			If CStr(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) Then
					doc.Sit = "POC Aguardando Providências do Cliente"
					doc.SitNumero = 21
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "POC Aguardando Providências Internas" Then
			doc.SitNumero = 22
			If CStr(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) Then
					doc.Sit = "Check Point do POC Atrasado"
					doc.SitNumero = 25
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point do POC Atrasado" And doc.MotivoPOC(UBound(doc.MotivoPOC)) = "Interno" Then
			doc.SitNumero = 25
			If CStr(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) Then
					doc.Sit = "POC Aguardando Providências Internas"
					doc.SitNumero = 22
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "POC Aguardando Materiais" Then
			doc.SitNumero = 23
			If CStr(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) Then
					doc.Sit = "Check Point do POC Atrasado"
					doc.SitNumero = 25
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point do POC Atrasado" And doc.MotivoPOC(UBound(doc.MotivoPOC)) = "Atraso de Material" Then
			doc.SitNumero = 25
			If CStr(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) Then
					doc.Sit = "POC Aguardando Materiais"
					doc.SitNumero = 23
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "POC Aguardando doc Relacionado" Then
			doc.SitNumero = 24
			If CStr(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) Then
					doc.Sit = "Check Point do POC Atrasado"
					doc.SitNumero = 25
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point do POC Atrasado" And doc.MotivoPOC(UBound(doc.MotivoPOC)) = "Dependência de Outro doc" Then
			doc.SitNumero = 25
			If CStr(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPointPOC(UBound(doc.DataCheckPointPOC))) Then
					doc.Sit = "POC Aguardando doc Relacionado"
					doc.SitNumero = 24
				End If
			End If
			Exit Sub
		End If
	End If
	'***** Fim do POC *****
	
	
	'***** Execução *****
	'26)Aguardando Pedido de Compra
	'27)Aguardando Entrega dos Materiais
	'28)Entrega Parcial
	'29)Aguardando Kickoff
	'30)Aguardando Planejamento da Execução (2 dias)
	'31)Planejamento da Execução em Atraso
	'32)Aguardando Início da Execução
	'33)Início da Execução em Atraso
	'34)Projeto em Execução
	'35)Final da Execução em Atraso
	'36)Execução Aguardando Providências do Cliente
	'37)Execução Aguardando Providências Internas
	'38)Execução Aguardando Materiais
	'39)Execução Aguardando doc Relacionado
	'40)Check Point de Execução Atrasado
	'41)Aguardando Documentação (Botão "Concluir Documentação" - Sai mensagem para Liberação de Faturamento)
	'42)Aguardando Aceite do Cliente
	'43)Aguardando Lançamento de Despesas e Horas
	'44)Concluído
	'45)Aguardando Análise da Perda
	'46)Perdido
	'47)Consolidado
	'48)Postergado
	'****
	
	If ckFechado Then
		If doc.Sit(0) = "Aguardando Início da Execução" Then
			doc.Sit = "Aguardando Início da Execução"
			doc.SitNumero = 32
			If CStr(doc.PrevInicio(UBound(doc.PrevInicio))) <> "" Then
				If CDat(Today) > CDat(doc.PrevInicio(UBound(doc.PrevInicio))) Then
					doc.Sit = "Início da Execução em Atraso"
					doc.SitNumero = 33
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Início da Execução em Atraso" Then
			doc.SitNumero = 33
			If CStr(doc.PrevInicio(UBound(doc.PrevInicio))) <> "" Then
				If CDat(Today) <= CDat(doc.PrevInicio(UBound(doc.PrevInicio))) Then
					doc.Sit = "Aguardando Início da Execução"
					doc.SitNumero = 32
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Projeto em Execução" Then
			doc.SitNumero = 34
			If CStr(doc.PrevEntrega(UBound(doc.PrevEntrega))) <> "" Then
				If CDat(Today) > CDat(doc.PrevEntrega(UBound(doc.PrevEntrega))) Then
					doc.Sit = "Final da Execução em Atraso"
					doc.SitNumero = 35
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Final da Execução em Atraso" Then
			doc.SitNumero = 35
			If CStr(doc.PrevEntrega(UBound(doc.PrevEntrega))) <> "" Then
				If CDat(Today) <= CDat(doc.PrevEntrega(UBound(doc.PrevEntrega))) Then
					doc.Sit = "Projeto em Execução"
					doc.SitNumero = 34
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Execução Aguardando Providências do Cliente" Then
			doc.SitNumero = 36
			If CStr(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) Then
					doc.Sit = "Check Point de Execução Atrasado"
					doc.SitNumero = 40
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point de Execução Atrasado" And doc.Motivo(UBound(doc.Motivo)) = "Cliente" Then
			doc.SitNumero = 40
			If CStr(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) Then
					doc.Sit = "Execução Aguardando Providências do Cliente"
					doc.SitNumero = 36
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Execução Aguardando Providências Internas" Then
			doc.SitNumero = 37
			If CStr(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) Then
					doc.Sit = "Check Point de Execução Atrasado"
					doc.SitNumero = 40
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point de Execução Atrasado" And doc.Motivo(UBound(doc.Motivo)) = "Interno" Then
			doc.SitNumero = 40
			If CStr(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) Then
					doc.Sit = "Execução Aguardando Providências Internas"
					doc.SitNumero = 37
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Execução Aguardando Materiais" Then
			doc.SitNumero = 38
			If CStr(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) Then
					doc.Sit = "Check Point de Execução Atrasado"
					doc.SitNumero = 40
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point de Execução Atrasado" And doc.Motivo(UBound(doc.Motivo)) = "Atraso de Material" Then
			doc.SitNumero = 40
			If CStr(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) Then
					doc.Sit = "Execução Aguardando Materiais"
					doc.SitNumero = 38
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Execução Aguardando Projeto Relacionado" Then
			doc.SitNumero = 39
			If CStr(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) <> "" Then
				If CDat(Today) > CDat(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) Then
					doc.Sit = "Check Point de Execução Atrasado"
					doc.SitNumero = 40
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Check Point de Execução Atrasado" And doc.Motivo(UBound(doc.Motivo)) = "Dependência de Outro Projeto" Then
			doc.SitNumero = 40
			If CStr(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) <> "" Then
				If CDat(Today) <= CDat(doc.DataCheckPoint(UBound(doc.DataCheckPoint))) Then
					doc.Sit = "Execução Aguardando Projeto Relacionado"
					doc.SitNumero = 39
				End If
			End If
			Exit Sub
		ElseIf doc.Sit(0) = "Aguardando Documentação" Then
			doc.SitNumero = 41
			Exit Sub
		ElseIf doc.Sit(0) = "Aguardando Aceite do Cliente" Then
			doc.SitNumero = 42
			Exit Sub
		ElseIf doc.Sit(0) = "Aguardando Lançamento de Despesas e Horas" Then
			doc.SitNumero = 43
			Exit Sub
		ElseIf doc.Sit(0) = "Concluído" Then
			doc.SitNumero = 44
			Exit Sub
		Else
			If negocio.TipoCompra(0) <> "Venda Simples" And Val(negocio.TotServicos(0)) > 0 Then
				If doc.Sit(0) = "Aguardando Kickoff" And negocio.TipoVenda(0) = "Projeto" Then
					doc.SitNumero = 29
					Exit Sub
				ElseIf doc.Sit(0) = "Aguardando Planejamento da Execução" Then
					doc.SitNumero = 30
					'Verifica se o Planejamento da Execução está Atrasado
					If doc.DataLimite(0) <> "" Then
						If CDat(Today) > CDat(doc.DataLimite(0)) Then
							doc.Sit = "Planejamento da Execução em Atraso"
							doc.SitNumero = 31
						End If
					End If
					Exit Sub
				ElseIf doc.Sit(0) = "Planejamento da Execução em Atraso" Then
					doc.SitNumero = 31
					Exit Sub
				Else
					If negocio.TipoVenda(0) = "Projeto" Then
						If negocio.Area(0) = "Suporte" Then
							doc.ResponsavelKickoff = GetResponsavelPlanejamento(doc.Area(0), "Kickoff")
						Else
							'*** Responsável do Kickoff é o mesmo Responsável da Pré-Venda ***
							If negocio.TecnicoResponsavel(0) = "" Then
								doc.ResponsavelKickoff = GetResponsavelPlanejamento(doc.Area(0), "Kickoff")
							Else
								doc.ResponsavelKickoff = negocio.TecnicoResponsavel(0)
							End If
						End If
						doc.Sit = "Aguardando Kickoff"
						doc.SitNumero = 29
						'Envia Email para Projetos
						Call AvisoSolicita(doc, "Kickoff")
						Exit Sub
					Else
						'*** Controle de Materiais ***
						Call SaldoMateriais(doc)
						'*** Não tem Materiais ***
						If doc.QT(0) = 0 Then
							doc.ResponsavelSolicitacao = GetResponsavelPlanejamento(doc.Area(0), "Exec")
							doc.Sit = "Aguardando Planejamento da Execução"
							doc.SitNumero = 30
							'Define o Prazo para o Planejamento da Execução
							data = GetPrazoPlanejamento(prazoPlanejamento)
							doc.DataLimite = CDat(data)
							'Envia Email para Projetos e Pós-Venda
							Call AvisoSolicita(doc, "Exec")
							Exit Sub
							'*** Tem Materiais ***
						Else
							If doc.SCT(0) > 0 Then
								doc.Sit = "Aguardando Pedido de Compra"
								doc.SitNumero = 26
								Exit Sub
							ElseIf doc.SBT(0) = doc.QT(0) Then
								doc.Sit = "Aguardando Entrega dos Materiais"
								doc.SitNumero = 27
								Exit Sub
							ElseIf doc.SBT(0) > 0 Then
								doc.Sit = "Entrega Parcial"
								doc.SitNumero = 28
								Exit Sub
							End If	
						End If
					End If
				End If
			Else
				doc.Sit = "Concluído"
				doc.SitNumero = 44
			End If
		End If
	End If
	'***** Fim da Execução *****
	
End Sub

'++LotusScript Development Environment:2:2:AvisoCQ:1:8
Sub AvisoCQ (doc As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim memo As NotesDocument
	Dim corpo As NotesRichTextItem
	Set db = session.CurrentDatabase
	
	'Define o Estilo da Fonte
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	
	'Email para o Qualificador
	Set memo = New NotesDocument( db )
	memo.Form = "Memo"
	memo.SendTo = "Controle de Qualidade"	'PAB Group
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	memo.Subject = "-> Controle de Qualidade Iniciado para o Negócio " & doc.Codigo(0) & " - Data: " & Format(doc.ProxDataCQ(0), "dd/mm/yyyy")
	Set corpo = memo.CreateRichTextItem( "Body" )
	Call corpo.AppendStyle(richStyle)
	Call corpo.AddNewLine( 1 )
	Call corpo.AppendText( "Favor efetuar o Controle de Qualidade para o Negócio " & doc.Codigo(0) & ".")
	%REM
	If doc.TipoVenda(0) = "Projeto" Or doc.TipoVenda(0) = "Chamado" Then
		Call corpo.AddNewLine( 1 )
		Call corpo.AppendText( "Solicitação para verificação de Pendências de Documentação encaminhada automaticamente para " & doc.GerenteConta(0) & ".")
		Call corpo.AddNewLine( 1 )
		Call corpo.AppendText( "Solicitação para verificação de Pendências de Execução encaminhada automaticamente para " & doc.TecnicoExecucao(0) & ".")
	End If
	%END REM
	Call corpo.AddNewLine( 2 )
	Call corpo.AppendText( "Link para o Negócio" & " > " )
	Call corpo.AppendDocLink( doc, "Link para o Negócio")
	Call corpo.AddNewLine( 2 )
	Call corpo.AppendText( "Descrição do Negócio:" )
	Call corpo.AddNewLine( 1 )
	Call corpo.AppendText( doc.Descricao(0) )
	Call corpo.AddNewLine( 2 )
	Call corpo.AppendText( "TDec Network Group.")
	Call memo.Send( False )
	
	If doc.TipoVenda(0) = "Projeto" Or doc.TipoVenda(0) = "Chamado" Then
		'Email para o Gerente da Conta - Pendências TDec
		Set memo = New NotesDocument( db )
		memo.Form = "Memo"
		memo.ReplyTo = "Controle de Qualidade"	'PAB Group
		memo.SendTo = doc.GerenteConta(0)
		memo.CopyTo = "Controle de Qualidade"
		'memo.BlindCopyTo = "Ludimila Oliveira"
		memo.Subject = "-> Controle de Qualidade para o Negócio " & doc.Codigo(0) & " - Data: " & Format(doc.ProxDataCQ(0), "dd/mm/yyyy")
		Set corpo = memo.CreateRichTextItem( "Body" )
		Call corpo.AppendStyle(richStyle)
		Call corpo.AddNewLine( 1 )
		Call corpo.AppendText( memo.SendTo(0) & ",")
		Call corpo.AddNewLine( 1 )
		Call corpo.AppendText( "Há pendências de Documentação para o Negócio " & doc.Codigo(0) & " ?" )
		Call corpo.AddNewLine( 2 )
		Call corpo.AppendText( "Link para o Negócio" & " > " )
		Call corpo.AppendDocLink( doc, "Link para o Negócio")
		Call corpo.AddNewLine( 2 )
		Call corpo.AppendText( "Descrição do Negócio:" )
		Call corpo.AddNewLine( 1 )
		Call corpo.AppendText( doc.Descricao(0) )
		Call corpo.AddNewLine( 2 )
		Call corpo.AppendText( "TDec Network Group.")
		Call memo.Send( False )
		
		'Email para o Técnico Execução - Pendências TDec
		Set memo = New NotesDocument( db )
		memo.Form = "Memo"
		memo.ReplyTo = "Controle de Qualidade"	'PAB Group
		memo.SendTo = doc.TecnicoExecucao(0)
		'memo.CopyTo = "Controle de Qualidade"
		'memo.BlindCopyTo = "Ludimila Oliveira"
		memo.Subject = "-> Controle de Qualidade para o Negócio " & doc.Codigo(0) & " - Data: " & Format(doc.ProxDataCQ(0), "dd/mm/yyyy")
		Set corpo = memo.CreateRichTextItem( "Body" )
		Call corpo.AppendStyle(richStyle)
		Call corpo.AddNewLine( 1 )
		Call corpo.AppendText( memo.SendTo(0) & ",")
		Call corpo.AddNewLine( 1 )
		Call corpo.AppendText( "Há pendências de Execução para o Negócio " & doc.Codigo(0) & " ?" )
		Call corpo.AddNewLine( 2 )
		Call corpo.AppendText( "Link para o Negócio" & " > " )
		Call corpo.AppendDocLink( doc, "Link para o Negócio")
		Call corpo.AddNewLine( 2 )
		Call corpo.AppendText( "Descrição do Negócio:" )
		Call corpo.AddNewLine( 1 )
		Call corpo.AppendText( doc.Descricao(0) )
		Call corpo.AddNewLine( 2 )
		Call corpo.AppendText( "TDec Network Group.")
		Call memo.Send( False )
	End If
	
End Sub

'++LotusScript Development Environment:2:2:StatusRenovacao:5:8
%REM
	Sub StatusRenovacao: 1) Pendente, 2) Vencido, 3) Renovado, 4) Concluído
	Description: Comments for Sub
%END REM
Sub StatusRenovacao(doc As NotesDocument)
	
	If CStr(doc.Vencimento(0)) <> "" Then
		If doc.Sit(0) = "Pendente" Then
			If CDat(Today) > CDat(doc.Vencimento(0)) Then
				doc.Sit = "Vencido"
				doc.SitNumero = 2
			Else
				doc.Sit = "Pendente"
				doc.SitNumero = 1
			End If
		ElseIf doc.Sit(0) = "Vencido" Then
			If CDat(Today) <= CDat(doc.Vencimento(0)) Then
				doc.Sit = "Pendente"
				doc.SitNumero = 1
			Else
				doc.Sit = "Vencido"
				doc.SitNumero = 2
			End If
		End If
	End If
		
End Sub


'++LotusScript Development Environment:2:1:CheckFreteRevenda:5:8
%REM
	Function CheckFreteRevenda
	Description: Comments for Function
%END REM
Function CheckFreteRevenda(doc As NotesDocument) As Boolean
	
	If TemHardware(doc) And Val(doc.Frete(0)) <= 0 And doc.Status_FreteRevenda(0) <> "Aprovado" Then
		CheckFreteRevenda = True
	End If
		
End Function


'++LotusScript Development Environment:2:1:CkComissionamento:1:8
Function CkComissionamento (doc As NotesDocument) As Boolean
	
	Dim nomes As Variant, participacoes As Variant
	Dim scan As Integer, ck As Double
	'Comissão Vendas
	nomes = doc.NomeComissao
	participacoes = doc.ParticipacaoComissao
	If Cstr(participacoes(0)) = "" Then
		Msgbox "O campo Participação nas Comissões de Vendas não pode estar em branco", 16, "Comissionamento Vendas"
		End
	End If
	If Ubound(nomes) <> Ubound(participacoes) Then
		Msgbox "Número de Nomes para divisão de Comissões de Vendas diferente do número de percentuais", 16, "Comissionamento Vendas"
		Exit Function
	End If
	For scan = 0 To Ubound(participacoes)
		ck = ck + participacoes(scan)	
	Next
	If Cstr(ck) <> "1" Then
		Msgbox "Os percentuais de Comissões de Vendas não somam 100%", 16, "Comissionamento Vendas"
		Exit Function
	End If
	CkComissionamento = True
	
End Function



'++LotusScript Development Environment:2:2:AtualizaFollowUp:1:8
Sub AtualizaFollowUp(uidoc As NotesUIDocument, doc As NotesDocument)
	
	Dim novoFollowUp As String
	novoFollowUp = CStr(Today())+ " - " + uidoc.FieldGetText("AtividadeHoje")
	NovoFollowUp = novoFollowUp + Chr(13)
	novoFollowUp = novoFollowUp + doc.FollowUp(0)
	MsgBox(novoFollowUp)
		
End Sub


'++LotusScript Development Environment:2:2:GeraControleDoc:5:8
%REM
	Sub GeraControleBudget
	Description: Comments for Sub
%END REM
Sub GeraControleDoc(negocio As NotesDocument, Tipo As String)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "servicos.nsf")
	Dim view As NotesView, viewC As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument, controle As NotesDocument, planilha As NotesDocument
	If negocio.TipoVenda(0) = "Contrato" Then
		Set view = db.Getview("(ContratosCodigo)")
	Else
		Set view = db.Getview("(ProjetosCodigo)")
	End If
	Set doc = view.Getdocumentbykey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		Call CalcListaCPS(doc)
		Call CalcBudget(doc)
		Call doc.Save(False, False)
		'Verifica se o Controle Financeiro Planejado já existe
		Set viewC = db.GetView("(Controle/Codigo)")
		Set dc = viewC.GetAllDocumentsByKey(negocio.Codigo(0), True)
		Set controle = dc.GetFirstDocument
		Do Until controle Is Nothing
			If controle.Tipo(0) = "Planejado" Then
				Exit Do
			End If
			Set controle = dc.GetNextDocument(controle)
		Loop
		If controle Is Nothing Then
			Set controle = New NotesDocument( db )
			controle.Form = "ControleFinanceiro"
			controle.Id = geraJavaId(controle)
			controle.Autor = session.Commonusername
			controle.Criacao = Now
			controle.Area = doc.Area(0)
			controle.AreaVendas = doc.AreaVendas(0)
			controle.Codigo = doc.Codigo(0)
			controle.Tipo = tipo
			controle.Resultado_P = doc.Resultado_P(0)
			controle.GerenteConta = doc.GerenteConta(0)
			controle.Inside = doc.Inside(0)
			controle.TipoVenda = doc.TipoVenda(0)
			controle.Desconto = doc.Desconto(0)
		End If
		If tipo = "Planejado" Then
			If negocio.TipoVenda(0) = "Venda Simples" Then
				'Zera Valores Planejados se for Venda Simples (Exceto Despesas de Vendas) - LMO 08/08/16
				controle.PassQtd = 0
				controle.Pass = 0
				controle.PassP = 0
				controle.PassQtd_1 = 0
				controle.Pass_1 = 0
				controle.PassP_1 = 0
				controle.HospQtd = 0
				controle.Hosp = 0
				controle.HospP = 0
				controle.HospQtd_1 = 0
				controle.Hosp_1 = 0
				controle.HospP_1 = 0
				controle.TransporteQtd = 0
				controle.Transporte = 0
				controle.TransporteP = 0
				controle.AlugQtd = 0
				controle.Alug = 0
				controle.AlugP = 0
				controle.AlugQtd_1 = 0
				controle.Alug_1 = 0
				controle.AlugP_1 = 0
				controle.MatQtd = 0
				controle.Mat = 0
				controle.MatP = 0
				controle.MatQtd_1 = 0
				controle.Mat_1 = 0
				controle.MatP_1 = 0
				controle.MatQtd_2 = 0
				controle.Mat_2 = 0
				controle.MatP_2 = 0
				controle.AtivoQtd = 0
				controle.Ativo = 0
				controle.AtivoP = 0
				controle.AtivoQtd_1 = 0
				controle.Ativo_1 = 0
				controle.AtivoP_1 = 0
				controle.ServQtd = 0
				controle.Serv = 0
				controle.ServP = 0
				controle.ServQtd_1 = 0
				controle.Serv_1 = 0
				controle.ServP_1 = 0
				controle.CustoP = 0
				'Despesas
				controle.KmQtd = 0
				controle.Km = 0
				controle.KmP = 0
				controle.KmQtd_1 = 0
				controle.Km_1 = 0
				controle.KmP_1 = 0
				controle.TransQtd = 0
				controle.Trans = 0
				controle.TransP = 0
				controle.TransQtd_1 = 0
				controle.Trans_1 = 0
				controle.TransP_1 = 0
				controle.TransQtd_2 = 0
				controle.Trans_2 = 0
				controle.TransP_2 = 0
				controle.TransQtd_3 = 0
				controle.Trans_3 = 0
				controle.TransP_3 = 0
				controle.TransQtd_4 = 0
				controle.Trans_4 = 0
				controle.TransP_4 = 0
				controle.TransQtd_5 = 0
				controle.Trans_5 = 0
				controle.TransP_5 = 0
				controle.TransQtd_6 = 0
				controle.Trans_6 = 0
				controle.TransP_6 = 0
				controle.AlimQtd = 0
				controle.Alim = 0
				controle.AlimP = 0
				controle.AlimQtd_1 = 0
				controle.Alim_1 = 0
				controle.AlimP_1 = 0
				controle.TeleQtd = 0
				controle.Tele = 0
				controle.TeleP = 0
				controle.DespP = 0
				'Horas Homem
				controle.HorasPlan = 0
				controle.HorasPlanFE = 0
				controle.PlanP = 0
				controle.CustoPlan = 0
				controle.HorasGer = 0
				controle.HorasGerFE = 0
				controle.GerP = 0
				controle.CustoGer = 0
				controle.HorasExec = 0
				controle.HorasExecFE = 0
				controle.ExecP = 0
				controle.CustoExec = 0
				controle.HorasDeslocamento = 0
				controle.HorasDeslocamentoFE = 0
				controle.DeslocamentoP = 0
				controle.CustoDeslocamento = 0
				controle.HorasDoc = 0
				controle.HorasDocFE = 0
				controle.DocP = 0
				controle.CustoDoc = 0
				controle.HHP = 0
				'Terceiros Faturáveis
				controle.TerceirosQtd = 0
				controle.Terceiros = 0
				controle.TerceirosP = 0
				'Despesas de Vendas
				controle.FreteQtd = doc.FreteQtd(0)
				controle.Frete = doc.Frete(0)
				controle.FreteP = doc.FreteP(0)
				controle.FreteObs = doc.FreteObs(0)
				controle.IntermediacaoQtd = doc.IntermediacaoQtd(0)
				controle.Intermediacao = doc.Intermediacao(0)
				controle.IntermediacaoP = doc.IntermediacaoP(0)
				controle.IntermediacaoObs = doc.IntermediacaoObs(0)
				controle.VendasP = doc.FreteP(0) + doc.IntermediacaoP(0)
				'Total
				controle.Total = controle.CustoP(0) + controle.DespP(0)
				controle.TotalHH = controle.HHP(0)
				controle.CustoHora = doc.CustoHora(0)
				controle.CustoServicos = doc.CustoServicos(0)
			Else
				'Custos
				controle.PassQtd = doc.PassQtd(0)
				controle.Pass = doc.Pass(0)
				controle.PassP = doc.PassP(0)
				controle.PassObs = doc.PassObs(0)
				controle.PassQtd_1 = doc.PassQtd_1(0)
				controle.Pass_1 = doc.Pass_1(0)
				controle.PassP_1 = doc.PassP_1(0)
				controle.PassObs_1 = doc.PassObs_1(0)
				controle.HospQtd = doc.HospQtd(0)
				controle.Hosp = doc.Hosp(0)
				controle.HospP = doc.HospP(0)
				controle.HospObs = doc.HospObs(0)
				controle.HospQtd_1 = doc.HospQtd_1(0)
				controle.Hosp_1 = doc.Hosp_1(0)
				controle.HospP_1 = doc.HospP_1(0)
				controle.HospObs_1 = doc.HospObs_1(0)
				controle.TransporteQtd = doc.TransporteQtd(0)
				controle.Transporte = doc.Transporte(0)
				controle.TransporteP = doc.TransporteP(0)
				controle.TransporteObs = doc.TransporteObs(0)
				controle.AlugQtd = doc.AlugQtd(0)
				controle.Alug = doc.Alug(0)
				controle.AlugP = doc.AlugP(0)
				controle.AlugObs = doc.AlugObs(0)
				controle.AlugQtd_1 = doc.AlugQtd_1(0)
				controle.Alug_1 = doc.Alug_1(0)
				controle.AlugP_1 = doc.AlugP_1(0)
				controle.AlugObs_1 = doc.AlugObs_1(0)
				controle.MatQtd = doc.MatQtd(0)
				controle.Mat = doc.Mat(0)
				controle.MatP = doc.MatP(0)
				controle.MatObs = doc.MatObs(0)
				controle.MatQtd_1 = doc.MatQtd_1(0)
				controle.Mat_1 = doc.Mat_1(0)
				controle.MatP_1 = doc.MatP_1(0)
				controle.MatObs_1 = doc.MatObs_1(0)
				controle.MatQtd_2 = doc.MatQtd_2(0)
				controle.Mat_2 = doc.Mat_2(0)
				controle.MatP_2 = doc.MatP_2(0)
				controle.MatObs_2 = doc.MatObs_2(0)
				controle.AtivoQtd = doc.AtivoQtd(0)
				controle.Ativo = doc.Ativo(0)
				controle.AtivoP = doc.AtivoP(0)
				controle.AtivoObs = doc.AtivoObs(0)
				controle.AtivoQtd_1 = doc.AtivoQtd_1(0)
				controle.Ativo_1 = doc.Ativo_1(0)
				controle.AtivoP_1 = doc.AtivoP_1(0)
				controle.AtivoObs_1 = doc.AtivoObs_1(0)
				controle.ServQtd = doc.ServQtd(0)
				controle.Serv = doc.Serv(0)
				controle.ServP = doc.ServP(0)
				controle.ServObs = doc.ServObs(0)
				controle.ServQtd_1 = doc.ServQtd_1(0)
				controle.Serv_1 = doc.Serv_1(0)
				controle.ServP_1 = doc.ServP_1(0)
				controle.ServObs_1 = doc.ServObs_1(0)
				controle.FreteMQtd = doc.FreteMQtd(0)
				controle.FreteM = doc.FreteM(0)
				controle.FreteMP = doc.FreteMP(0)
				controle.FreteMObs = doc.FreteMObs(0)
				controle.CustoP = doc.PassP(0) + doc.PassP_1(0) + doc.HospP(0) + doc.HospP_1(0) + doc.AlugP(0) + doc.AlugP_1(0) + doc.MatP(0) + doc.MatP_1(0) + doc.MatP_2(0) + doc.ServP(0) + doc.ServP_1(0) + doc.FreteMP(0)
				'Despesas
				controle.KmQtd = doc.KmQtd(0)
				controle.Km = doc.Km(0)
				controle.KmP = doc.KmP(0)
				controle.KmObs = doc.KmObs(0)
				controle.KmQtd_1 = doc.KmQtd_1(0)
				controle.Km_1 = doc.Km_1(0)
				controle.KmP_1 = doc.KmP_1(0)
				controle.KmObs_1 = doc.KmObs_1(0)
				controle.TransQtd = doc.TranspQtd(0)
				controle.Trans = doc.Transp(0)
				controle.TransP = doc.TranspP(0)
				controle.TranspObs = doc.TranspObs(0)
				controle.TransQtd_1 = doc.TranspQtd_1(0)
				controle.Trans_1 = doc.Transp_1(0)
				controle.TransP_1 = doc.TranspP_1(0)
				controle.TranspObs_1 = doc.TranspObs_1(0)
				controle.TransQtd_2 = doc.TranspQtd_2(0)
				controle.Trans_2 = doc.Transp_2(0)
				controle.TransP_2 = doc.TranspP_2(0)
				controle.TranspObs_2 = doc.TranspObs_2(0)
				controle.TransQtd_3 = doc.TranspQtd_3(0)
				controle.Trans_3 = doc.Transp_3(0)
				controle.TransP_3 = doc.TranspP_3(0)
				controle.TranspObs_3 = doc.TranspObs_3(0)
				controle.TransQtd_4 = doc.TranspQtd_4(0)
				controle.Trans_4 = doc.Transp_4(0)
				controle.TransP_4 = doc.TranspP_4(0)
				controle.TranspObs_4 = doc.TranspObs_4(0)
				controle.TransQtd_5 = doc.TranspQtd_5(0)
				controle.Trans_5 = doc.Transp_5(0)
				controle.TransP_5 = doc.TranspP_5(0)
				controle.TranspObs_5 = doc.TranspObs_5(0)
				controle.TransQtd_6 = doc.TranspQtd_6(0)
				controle.Trans_6 = doc.Transp_6(0)
				controle.TransP_6 = doc.TranspP_6(0)
				controle.TranspObs_6 = doc.TranspObs_6(0)
				controle.AlimQtd = doc.AlimeQtd(0)
				controle.Alim = doc.Alime(0)
				controle.AlimP = doc.AlimeP(0)
				controle.AlimeObs = doc.AlimeObs(0)
				controle.AlimQtd_1 = doc.AlimeQtd_1(0)
				controle.Alim_1 = doc.Alime_1(0)
				controle.AlimP_1 = doc.AlimeP_1(0)
				controle.AlimeObs_1 = doc.AlimeObs_1(0)
				controle.TeleQtd = doc.TeleQtd(0)
				controle.Tele = doc.Tele(0)
				controle.TeleP = doc.TeleP(0)
				controle.TeleObs = doc.TeleObs(0)
				controle.DespP = doc.KmP(0) + doc.KmP_1(0) + doc.TranspP(0) + doc.TranspP_1(0) + doc.TranspP_2(0) + doc.TranspP_3(0) + doc.TranspP_4(0) + doc.TranspP_5(0) + doc.TranspP_6(0) + doc.AlimeP(0) + doc.AlimeP_1(0) + doc.TeleP(0)
				'Horas Homem
				controle.HorasPlan = doc.HorasPlan(0)
				controle.HorasPlanFE = doc.HorasPlanFE(0)
				controle.PlanP = doc.PlanP(0)
				controle.CustoPlan = doc.CustoPlan(0)
				controle.ObsHorasPlan = doc.ObsHorasPlan(0)
				controle.HorasGer = doc.HorasGer(0)
				controle.HorasGerFE = doc.HorasGerFE(0)
				controle.GerP = doc.GerP(0)
				controle.CustoGer = doc.CustoGer(0)
				controle.ObsHorasGer = doc.ObsHorasGer(0)
				controle.HorasExec = doc.HorasExec(0)
				controle.HorasExecFE = doc.HorasExecFE(0)
				controle.ExecP = doc.ExecP(0)
				controle.CustoExec = doc.CustoExec(0)
				controle.ObsHorasExec = doc.ObsHorasExec(0)
				controle.HorasDeslocamento = doc.HorasDeslocamento(0)
				controle.HorasDeslocamentoFE = doc.HorasDeslocamentoFE(0)
				controle.DeslocamentoP = doc.DeslocamentoP(0)
				controle.CustoDeslocamento = doc.CustoDeslocamento(0)
				controle.ObsHorasDeslocamento = doc.ObsHorasDeslocamento(0)
				controle.HorasDoc = doc.HorasDoc(0)
				controle.HorasDocFE = doc.HorasDocFE(0)
				controle.DocP = doc.DocP(0)
				controle.CustoDoc = doc.CustoDoc(0)
				controle.ObsHorasDoc = doc.ObsHorasDoc(0)
				controle.HHP = doc.PlanP(0) + doc.GerP(0) + doc.ExecP(0) + doc.DeslocamentoP(0) + doc.DocP(0)
				'Terceiros Faturáveis
				controle.TerceirosQtd = doc.TerceirosQtd(0)
				controle.Terceiros = doc.Terceiros(0)
				controle.TerceirosP = doc.TerceirosP(0)
				controle.TerceirosObs = doc.TerceirosObs(0)
				'Despesas de Vendas
				controle.FreteQtd = doc.FreteQtd(0)
				controle.Frete = doc.Frete(0)
				controle.FreteP = doc.FreteP(0)
				controle.FreteObs = doc.FreteObs(0)
				controle.IntermediacaoQtd = doc.IntermediacaoQtd(0)
				controle.Intermediacao = doc.Intermediacao(0)
				controle.IntermediacaoP = doc.IntermediacaoP(0)
				controle.IntermediacaoObs = doc.IntermediacaoObs(0)
				controle.VendasP = doc.FreteP(0) + doc.IntermediacaoP(0)
				'Total
				controle.Total = controle.CustoP(0) + controle.DespP(0)
				controle.TotalHH = controle.HHP(0)
				controle.CustoHora = doc.CustoHora(0)
				controle.CustoServicos = doc.CustoServicos(0)
			End If
		End If
		'Planilha Financeira
		Set view = db.Getview("(Planilha/Codigo)")
		Set planilha = view.Getdocumentbykey(negocio.Codigo(0), True)
		If Not planilha Is Nothing Then
			'Transforma Controle Financeiro em Reposta da Planilha Financeira
			Call controle.MakeResponse(planilha)
			Call controle.save(True, True)
			'*** Reserva Técnica Default de 10% - Apenas para Controle PLanejado Novo - LMO 22/08/18 ***
			If controle Is Nothing Then
				'Custos
				planilha.PassRT = (doc.PassP(0) + doc.PassP_1(0)) * 0.1
				planilha.HospRT = (doc.HospP(0) + doc.HospP_1(0)) * 0.1
				planilha.AlugRT = (doc.AlugP(0) + doc.AlugP_1(0)) * 0.1
				planilha.MatRT = (doc.MatP(0) + doc.MatP_1(0) + doc.MatP_2(0)) * 0.1
				planilha.AtivoRT = (doc.AtivoP(0) + doc.AtivoP_1(0)) * 0.1
				planilha.ServRT = (doc.ServP(0) + doc.ServP_1(0)) * 0.1
				planilha.FreteMRT = doc.FreteMP(0) * 0.1
				planilha.CustoRT = planilha.PassRT(0) + planilha.HospRT(0) + planilha.AlugRT(0) + planilha.MatRT(0) + planilha.ServRT(0) + planilha.FreteMRT(0)
				'Despesas
				planilha.KmRT = (doc.KmP(0) + doc.KmP_1(0)) * 0.1
				planilha.TranspRT = (doc.TranspP(0) + doc.TranspP_1(0) + doc.TranspP_2(0) + doc.TranspP_3(0) + doc.TranspP_4(0) + doc.TranspP_5(0) + doc.TranspP_6(0)) * 0.1
				planilha.AlimeRT = (doc.AlimeP(0) + doc.AlimeP_1(0)) * 0.1
				planilha.TeleRT = doc.TeleP(0) * 0.1
				planilha.DespRT = planilha.KmRT(0) + planilha.TranspRT(0) + planilha.AlimeRT(0) + planilha.TeleRT(0)
				'Horas
				planilha.PlanRT = doc.PlanP(0) * 0.1
				planilha.GerRT = doc.GerP(0) * 0.1
				planilha.ExecRT = doc.ExecP(0) * 0.1
				planilha.DeslocamentoRT = doc.DeslocamentoP(0) * 0.1
				planilha.DocRT = doc.DocP(0) * 0.1
				planilha.HHRT = planilha.PVRT(0) + planilha.PlanRT(0) + planilha.GerRT(0) + planilha.ExecRT(0) + planilha.DeslocamentoRT(0) + planilha.DocRT(0)
			End If
			'***
			'Calcula Valores da Planilha Financeira
			Call CalcPlanilha(planilha)
			planilha.StatusNegocio = negocio.Sit(0)
			planilha.Sit = doc.Sit(0)
			Call planilha.Save(True, True)
		End If
	End If
	
End Sub

'++LotusScript Development Environment:2:2:GeraCapitalGiroRTF:8:8
%REM
	Sub GeraCapitalGiroRTF
	Description: Mais uma versão de geração de capital de giro, agora gerando um campo RTF 
	já que as demais funções criam campos com mais de 64K e impedem que o documento seja gravado.
	O RTF não tem limite de tamanho.
	'--- Nao está em uso. Usamos apenas o CalcCapitalGiroReal
%END REM
Sub GeraCapitalGiroRTF (negocios As NotesDocumentCollection)
	On Error GoTo tratamentoErro
	Dim session As New NotesSession
	Dim doc As NotesDocument
	'Iniciar criando um array com todas as datas entre o início e o final do negócio
	'Pesquisar nas bases de Receber e Despesas para ver quando iniciaram os movimentos de caixa
	Dim dbFaturas As New NotesDatabase(session.CurrentDatabase.Server,"faturas.nsf")
	Dim viewReceber As NotesView
	Set viewReceber = dbFaturas.GetView("(Receber/Negocio)")
	Dim dbDespesas As New NotesDatabase(session.CurrentDatabase.Server,"caixa.nsf")
	Dim viewDespesas As NotesView
	Set viewDespesas = dbDespesas.GetView("(DespesasNegocio)")
	Dim despesa As NotesDocument
	Dim receber As NotesDocument
	Dim primeiraDataDesp As NotesDateTime
	Dim primeiraDataRec As NotesDateTime
	Dim datasDescpTmp() As String
	Dim valoresDespTmp() As Double
	Dim valoresRecTmp() As Double
	Dim datasRecTmp() As String
	Dim dataFinal As NotesDateTime
	Dim dbBancos As New NotesDatabase(session.CurrentDatabase.Server,"bancos.nsf")
	Dim viewCapitalGiro As NotesView
	Dim hoje As New NotesDateTime(Today)
	Dim anos() As Integer, meses() As Integer
	Dim datasFatores() As String, valoresFatores() As Double, fatorIOF() As Double
	Dim ckAno As Integer, ckMes As Integer
	Dim comparaMesPeriodo As String, comparaMesHoje As String
	Dim contaMeses As NotesDateTime, contaMesesSimulacao As NotesDateTime
	Dim resultado As Integer
	Dim saldoInicial As Double, saldoFinal As Double,  saida As Double, entrada As Double,fator As Double, osJuros As Double, totJuros As Double, valIOF As Double
	Dim totIOF As Double, totIOC As Double
	Dim totJurosReais As Double, totJurosFuturos As Double
	Dim maiorSaldo As Double 'para calcular o IOC
	Dim periodoFinal As String, scanPeriodo As String
	Dim comissaoHoje As Double, capitalGiroHoje As DOuble
	Dim periodo As String, mes As String, ckPeriodo As String, simula As Double, simulaIOF As Double, simulaIOC
	Dim scanData As NotesDateTime
	Dim ultimaDataDesp As NotesDateTime, ultimaDataRec As NotesDateTime, estaData As NotesDateTime
	Dim diasContaNegativa As Double, valorMedioNegativo As Double
	Dim scan As Integer
	
	Dim datas() As Variant 'vai guardar todas entre a primeira despesa/receber até a conclusão do negócio
	Dim saidas() As Double, entradas() As Double, saldos() As Double, fatores() As Double, juros() As Double
	Dim ckIOC As Integer
	
	Dim dcDespesas As NotesDocumentCollection
	Dim dcReceber As NotesDocumentCollection
	
	ReDim Preserve saldosFinais(0) As Double 'declaro duas vezes para nao dar problema se nao houverem desp nem receitas no negocio
	
	Dim codigo As String
	
	Dim negocio As NotesDocument
	Dim obs As String, ioc As Double, somaSaldos As Double
	
	Set negocio = negocios.GetFirstDocument
	Do Until negocio Is Nothing
		
		codigo = negocio.Codigo(0)
		saldoInicial = 0
		saldoFinal = 0
		totIOC = 0
		totJuros = 0
		totIOF = 0
		obs = ""
		ioc = 0
		somaSaldos = 0
		diasContaNegativa = 0
		valorMedioNegativo = 0

		Set dcDespesas = viewDespesas.GetAllDocumentsByKey(codigo, True)
		Set despesa = viewDespesas.GetDocumentByKey(codigo, True)
		Set dcReceber = viewReceber.GetAlldocumentsByKey(codigo, True)
		Set receber = viewReceber.GetDocumentByKey(codigo, True)
		If receber Is Nothing And despesa Is Nothing Then
			'MsgBox("Não houve movimento financeiro neste negócio")
			'print codigo + " - " + "Não houve movimento nesse negócio"
			obs = "Não houve movimento nesse negócio"
			GoTo semDetalhamento
		End If
		Dim dataInicial As NotesDateTime
		
		'===============================================================================
		'certificando de estar pegando a última data do documentcollection das despesas
		'===============================================================================
		scan = 0
		Set doc = dcDespesas.GetFirstDocument
		If dcDespesas.Count > 0 Then
			Set ultimaDataDesp = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
			Set primeiraDataDesp = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
			Do Until doc Is Nothing
				ReDim Preserve datasDespTmp(scan) As String
				ReDim Preserve valoresDespTmp(scan) As Double
				datasDespTmp(scan) = DateValue(doc.VencimentoDespesa(0))
				valoresDespTmp(scan) = doc.TotTot(0)
				Set estaData = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
				If estaData.TimeDifference(ultimaDataDesp) > 0 Then
					Set ultimaDataDesp = session.CreateDateTime( estaData.DateOnly )
				End If
				If estaData.TimeDifference(primeiraDataDesp) <= 0 Then
					Set primeiraDataDesp = session.CreateDateTime( estaData.DateOnly )
				End If
				scan = scan+1
				Set doc = dcDespesas.GetNextDocument(doc)
			Loop
		End If
		'==================================================================================
		'Populando a matriz temporária de RECEBER e definindo qual a última data do receber
		'==================================================================================
		
		If dcReceber.Count > 0 Then	
			scan = 0
			Set doc = dcReceber.GetFirstDocument
			Set ultimaDataRec = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
			Set primeiraDataRec = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
			Do Until doc Is Nothing
				ReDim Preserve datasRecTmp(scan) As String
				ReDim Preserve valoresRecTmp(scan) As Double
				datasRecTmp(scan) = DateValue(doc.Prorrogacao(0))
				valoresRecTmp(scan) = doc.TotTot(0)
				Set estaData = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
				If estaData.TimeDifference(ultimaDataRec) > 0 Then
					Set ultimaDataRec = session.CreateDateTime( estaData.DateOnly )
				End If
				If estaData.TimeDifference(primeiraDataRec) <= 0 Then
					Set primeiraDataRec = session.CreateDateTime( estaData.DateOnly )
				End If
				scan = scan+1
				Set doc = dcReceber.GetNextDocument(doc)
			Loop
		Else
			Set ultimaDataRec = session.CreateDateTime(ultimaDataDesp.DateOnly)
			Set primeiraDataRec = session.CreateDateTime(primeiraDataDesp.DateOnly)
		End If
		
		'================================================================================
		'Definindo a data final - a ultima data entre a ultima DESPESA e o ultimo RECEBER
		'================================================================================
		
		If primeiraDataDesp.TimeDifference(primeiraDataRec) <= 0 Then
			Set dataInicial = session.CreateDateTime( primeiraDataDesp.DateOnly )
		Else
			Set dataInicial = session.CreateDateTime( primeiraDataRec.DateOnly )
			obs = obs + " - Receber foi antes"
		End If
		
		If ultimaDataRec.TimeDifference(ultimaDataDesp) > 0 Then
			Set dataFinal = session.CreateDateTime( ultimaDataRec.DateOnly )
		Else
			Set dataFinal = session.CreateDateTime( ultimaDataDesp.DateOnly )
		End If
		
		Set scanData = session.CreateDateTime(dataInicial.DateOnly)
		scan = 0
		Do Until scanData.TimeDifference(dataFinal) > 0
			ReDim Preserve datas(scan)
			ReDim Preserve saldosIniciais(scan)
			ReDim Preserve entradas(scan)
			ReDim Preserve saidas(scan)
			ReDim Preserve saldosFinais(scan)
			ReDim Preserve fatores(scan)
			ReDim Preserve aliqIOF(scan) 'aliq de 0,0041% incide diariamente
			ReDim Preserve valorIOF(scan)
			ReDim Preserve juros(scan)
			ReDim Preserve comissoes(scan)
			datas(scan) = scanData.DateOnly
			Call scanData.AdjustDay(1)
			scan = scan + 1
		Loop
		
		'================================================================================================
		'populando a matriz de FATORES e IOF a partir dos dados contidos na vista Custo Capital de Giro em Bancos
		'em uma simulação pode ocorrer um caso onde datas futuras entram na simulacao. Vamos usar data de hoje para futuro
		'aproveitar e popular a matriz IOF que é fixa mensal
		'================================================================================================
		
		Set viewCapitalGiro = dbBancos.GetView("Custo Capital de Giro")
		
		' Definindo quantos meses devo buscar nas taxas de juros para fazer apenas um acesso a disco
		
		'====================================================================================
		'analisando se o periodo sendo analisado é anterior ou posterior ao mes da data atual
		'se for "depois" será usado o último índice existente no sistema. 
		'será uma SIMULACAO, já que não temos índices futuros
		'====================================================================================
		scan = 0
		
		Set contaMeses = session.CreateDateTime(DataInicial.DateOnly)
		Set contaMesesSimulacao = session.CreateDateTime(DataInicial.DateOnly)
		
		If Len(CStr(Month(dataFinal.LSGMTTime))) = 1 Then
			periodoFinal = CStr(Year(dataFinal.LSGMTTime)+"/0"+Cstr(Month(dataFinal.LSGMTTime)))
		Else
			periodoFinal = CStr(Year(dataFinal.LSGMTTime)+"/"+Cstr(Month(dataFinal.LSGMTTime)))
		End If
		If Len(CStr(Month(contaMeses.LSGMTTime))) = 1 Then
			scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/0"+Cstr(Month(contaMeses.LSGMTTime)))
		Else
			scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/"+Cstr(Month(contaMeses.LSGMTTime)))
		End If
		
		Do While scanPeriodo <= periodoFinal		
			ReDim Preserve anos(scan) As Integer
			mes = CStr(Month(contaMeses.LSLocalTime))
			If Len(mes) = 1 Then mes = "0" + mes
			periodo = CStr(Year(contaMeses.LSLocalTime)) + "/" + mes
			'analisando se a simulação está sendo feita em um mês futuro onde iremos utilizar o último fator como base de simulacao
			'========================
			'precisamos acrescenter um zero no mes para que a comparacao nao coloque periodos como 2014/4 sendo maior que 2014/10.
			If Len(CStr(Month(contaMeses.LSLocalTime))) = 1 Then
				comparaMesPeriodo = "0"+CStr(Month(contaMeses.LSLocalTime))
			Else
				comparaMesPeriodo = CStr(Month(contaMeses.LSLocalTime))
			End If 
			If Len(CStr(Month(Today))) = 1 Then
				comparaMesHoje = "0"+CStr(Month(contaMeses.LSLocalTime))
			Else
				comparaMesHoje = CStr(Month(Today))
			End If 			
			If CStr(Year(contaMeses.LSLocalTime)) + "/" +  comparaMesPeriodo < CStr(Year(Today)) + "/" + comparaMesHoje Then
				'MsgBox(CStr(Year(contaMeses.LSLocalTime)) + "/" +  CStr(Month(contaMeses.LSLocalTime)) + " --- " + CStr(Year(Today)) + "/" + CStr(Month(Today)))
				ckPeriodo = "antes"			
			Else
				ckPeriodo = "depois"
			End If
			Set doc = viewCapitalGiro.GetDocumentByKey(periodo, True)
			If doc Is Nothing And ckPeriodo = "antes" Then
				'MsgBox("Fator não encontrado na base Bancos - Vista Custo Capital de Giro. Favor criar o documento")
				'MsgBox( codigo + " - " + periodo + " - " + "Fator não encontrado")
				obs = "- Fator não está no sistema - "
				GoTo fatorNaoEncontrado
			End If
			ReDim Preserve datasFatores(scan) As String
			ReDim Preserve valoresFatores(scan) As Double
			ReDim Preserve fatorIOF(scan) As Double
			If ckPeriodo = "antes" Then  
				datasFatores(scan) = periodo
				valoresFatores(scan ) = doc.Fator(0)
				fatorIOF(scan) = doc.IOF(0)
				simula = doc.Fator(0)
				simulaIOF = doc.IOF(0)
			Else
				'se a primeira data do negócio for em um mês futuro, simula fica igual a zero.
				'neste caso, temos que voltar um mês no período para encontrar um simula diferente de zero
				If simula = 0 Then
					Do While simula = 0
						'procurar o último fator anterior à primeira despesa/receita do negocio
						mes = CStr(Month(contaMesesSimulacao.LSLocalTime))
						If Len(mes) = 1 Then mes = "0" + mes
						Set doc = viewCapitalGiro.GetDocumentByKey(CStr(Year(contaMesesSimulacao.LSLocalTime)) + "/" + mes, True)
						If Not (doc Is Nothing) Then							
							datasFatores(scan) = periodo ' fica o período correto com os fatores de mes anterior
							valoresFatores(scan ) = doc.Fator(0)
							fatorIOF(scan) = doc.IOF(0)
							simula = doc.Fator(0)
							simulaIOF = doc.IOF(0)
						End If
						Call contaMesesSimulacao.Adjustmonth(-1)
					Loop
				Else
					datasFatores(scan) = periodo
					valoresFatores(scan ) = simula
					fatorIOF(scan) = simulaIOF
				End If
			End If
			Call contaMeses.AdjustMonth(1)
			If Len(CStr(Month(contaMeses.LSGMTTime))) = 1 Then
				scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/0"+Cstr(Month(contaMeses.LSGMTTime)))
			Else
				scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/"+Cstr(Month(contaMeses.LSGMTTime)))
			End If
			scan = scan + 1
		Loop
		
		'=====================================================================
		'Populando a matriz de FATORES para posterior calculo de juros diários
		'=====================================================================
		scan = 0
		Do While scan <= UBound(datas)
			mes =  CStr(Month(CDat(datas(scan))))
			If Len(mes) = 1 Then mes = "0" + mes
			periodo = CStr(Year(CDat(datas(scan)))) + "/" + mes
			fatores(scan) = valoresFatores(ArrayGetIndex(datasFatores, periodo))
			aliqIOF(scan) = fatorIOF(ArrayGetIndex(datasFatores, periodo))
			scan = scan + 1
		Loop 
		
		'para economizar acessos a disco e reduzir a quantidade de índices estou buscando uma técnica para fazer em memória
		'para isto irei copiar o conteúdo do document collection para a array temporária
		
		'=====================================================================
		'Populando a matriz SAIDAS com os dados das DESPESAS
		'Como o arraygetindex só pega a primeira ocorrencia do search, copio a ocorrencia encontrada, deleto e tento novamente até acabar com todas.
		'======================================================================
		
		maiorSaldo = 0
		scan = 0
		Do While scan <= UBound(datas)
			saida = 0
			entrada = 0
			'Verificando se há valor de saída na data do loop
			If dcDespesas.Count > 0 Then
				Do While Not (IsNull(ArrayGetIndex(  datasDespTmp, CStr(datas(scan))))) 
					resultado = ArrayGetIndex(  datasDespTmp, CStr(datas(scan)))
					'saídas negativas são créditos de impostos que não podem ser consideradas entradas reais de caixa
					'If valoresDespTmp(resultado)> 0 then
					saida = saida + valoresDespTmp(resultado)
					'End if 
					datasDespTmp(resultado) = "99/99/9999"	
				Loop 	
			End If
			'Verificando se há uma "entrada" na data do loop
			If dcReceber.Count > 0 Then		
				Do While Not (IsNull(ArrayGetIndex(  datasRecTmp, CStr(datas(scan))))) 
					resultado = ArrayGetIndex(  datasRecTmp, CStr(datas(scan)))
					entrada  = entrada + valoresRecTmp(resultado)
					datasRecTmp(resultado) = "99/99/9999"
				Loop 			
			End If
			If scan > 0 Then
				saldoInicial = saldosFinais(scan-1) + juros(scan-1) + valorIOF(scan-1)
				saldoFinal = saldoInicial + entrada - saida
				If saldoFinal < 0 Then 
					'esta conta não faz sentido, pois se o projeto fica muito tempo com valor negativo pequeno a média nao faz sentido
					diasContaNegativa = diasContaNegativa + 1
					valorMedioNegativo = valorMedioNegativo + saldoFinal
				End If
			Else
				saldoInicial = 0
				saldoFinal = entrada - saida
			End If
			
			
			'calculando os juros do dia
			If saldoFinal < 0 Then
				osJuros = saldoFinal * (fatores(scan)-1)
				valIOF = saldoFinal * aliqIOF(scan)
			Else
				osJuros = 0
				valIOF = 0
			End If
			
			saldosIniciais(scan) = saldoInicial
			saidas(scan) = saida
			entradas(scan) = entrada
			saldosFinais(scan) = saldoFinal
			juros(scan) = osJuros
			valorIOF(scan) = valIOF		
			comissoes(scan) = saldoFinal * negocio.Comissao(0) 	
			If CDat(datas(scan)) = Today Then
				comissaoHoje = comissoes(scan)
				capitalGiroHoje = saldosFinais(scan)
			End If
			
			totJuros = totJuros + osJuros 
			'Em um contrato de longo prazo os juros futuros são apenas uma conjuctura, partindo-se do pressuposto que o cliente nao pagará as parcelas
			'pois apenas as saídas estão programadas e as entradas não estão.
			If CDat(datas(scan)) > Today Then
				totJurosFuturos = totJurosFuturos + osJuros
			Else
				totJurosReais = totJurosReais + osJuros
			End If
			
			totIOF = totIOF + valIOF
			
			saida = 0
			entrada = 0
			scan = scan + 1
			
		Loop 
		'=======================================================================================
		'Calcular IOC - sempre que o saldo sair de zero será utilizado o maior valor para colocar 0,0038 de IOC
		'calculando maior saldo para aplicar o IOC que é um imposto único cobrado sobre o maior valor utilizado de empréstimo
		'=======================================================================================
		
		maiorSaldo = 0
		ioc = 0
		ckIOC = 1
		For scan = 0 To UBound(saldosFinais)
			If scan > 0 Then
				If saldosFinais(scan) < 0 Then
					If saldosFinais(scan) < maiorSaldo Then 
						maiorSaldo = saldosFinais(scan)'a comparação é negativa pois a saída é um num negativo
					End If
				ElseIf saldosFinais(scan) > 0 And saldosFinais(scan-1) < 0 Then 'pegar a soma do bloco anterior e multiplicar para IOC
					ioc = ioc + (maiorSaldo * 0.0038)
					'MsgBox(codigo + " - Fechei o bloco " + CStr(ckIOC) + " - Maior Saldo -> " + CStr(maiorSaldo) + " - Saldo Final -> " + CStr(saldosFinais(scan))+ " IOC -> " + CStr(ioc))					
					maiorSaldo = 0
					ckIOC = ckIOC +1					
				End If
			Else
				If saldosFinais(0) < 0 Then maiorSaldo = saldosFinais(0)
			End If
		Next scan
		If ckIOC > 2 Then
			obs = obs + " - mais de um bloco de conta de IOC"
		End If

fatorNaoEncontrado: 'para achar os fatores que precisam ser criados
		totIOC = ioc
		'============================================================================
		'Agora que as matrizes estão populadas, criar as tabelas para mostrar os valores
		'lembrando do limite de 255 linhas que uma NotesRichTextTable pode ter (64 colunas)
		'================================================================================
		
		'====Estilo apenas ======================================
		Dim richStyle As NotesRichTextStyle
		Set richStyle = session.CreateRichTextStyle
		'richStyle.NotesFont = FONT_ROMAN
		'richStyle.NotesFont = FONT_COURIER
		richStyle.NotesFont = FONT_HELV
		richStyle.FontSize = 8
		richStyle.NotesColor = COLOR_BLUE
		'====Criando campo rich text para tabela ======================================
		If negocio.HasItem("CapGiro") Then Call negocio.RemoveItem("CapGiro")
		Dim capGiro As NotesRichTextItem
		Set capGiro = New NotesRichTextItem( negocio, "CapGiro" )
		Call capGiro.AppendStyle(richStyle)
		
		'=== Criando NotesParagraph para poder alinhar os números à direita, texto esq e percentuais centro
		Dim rtpStyle As NotesRichTextParagraphStyle
		Set rtpStyle = session.CreateRichTextParagraphStyle
		rtpStyle.Alignment = ALIGN_CENTER
		Call capGiro.AppendParagraphStyle(rtpStyle)
		'======= Fim da Criação do NotesParagraph
		
		'========= Create a table =================
		'=== Definindo o número de linhas da tabela (quantidade de viewEntryes na ClassificacaoDespesa do FATURAS.NSF ===
		Dim rowCount As Integer, columnCount As Integer,iRow As Integer, iColumn As Integer
		ReDim Preserve titColunas(10) As String
		titColunas(0) = "Data"
		titColunas(1) = "Saldo Inicial"
		titColunas(2) = "Entradas"
		titColunas(3) = "Saídas"
		titColunas(4) = "Fator Diário"
		titColunas(5) = "Aliq IOF"
		titColunas(6) = "Valor IOF"
		titColunas(7) = "Juros"
		titColunas(8) = "Saldo Final"
		titColunas(9) = "Comissão do Dia"
		rowCount = 1 'irá aumentando com addRow()
		columnCount = UBound(titColunas)
				
		Call capGiro.AppendTable(rowCount, columnCount)
		Dim rtnav As NotesRichTextNavigator
		Set rtnav = capGiro.CreateNavigator
		
		'===Inserindo os títulos na Tabela ===== REM Populate table	
		
		Dim i As Integer	

		Call rtnav.FindFirstElement(RTELEM_TYPE_TABLECELL) 
		Call capGiro.BeginInsert(rtnav)
		Call capGiro.AppendText("Data")
		Call capGiro.EndInsert
		For i = 1 To UBound(titColunas)
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL)
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(titColunas(i))
			Call capGiro.EndInsert
		Next
		
		'=== fim dos títulos = Posicionando o Cursos na linha abaixo para inserir o titulo Receita Bruta ======
		richStyle.NotesColor = COLOR_BLACK
		Call capGiro.AppendStyle(richStyle)
		
		Call doc.Save(True, True)'gravando para o addrow funcionar
		If Not rtnav.FindFirstElement(RTELEM_TYPE_TABLE) Then
			MessageBox "Não foi encontrada nenhuma tabela no campo CapGiro,",, _
			"Error"
			Exit Sub
		End If
		
		Dim rttable As NotesRichTextTable	
		Set rttable = rtnav.GetElement
				
		'Agora preciso popular cada campo da tabela.
		
		Call doc.Save(True, True)'gravando para o addrow funcionar
		
		Dim scantable As Integer
		scantable = 0
		'posicionando na célula abaixo dos títulos (depois do firstelement, tamanho da matriz de titulos)
		Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,UBound(titColunas))
		Print "Criando Extrato Capital de Giro, aguarde..."
		For scan = 0  to UBound(datas)
			scantable = scantable + 1 'a tabela pode ter no maximo 255 linhas e 64 colunas
			If scantable > 255 Then
				scantable = 0
				Call capGiro.AppendTable(rowCount, columnCount)				
			'	If Not rtnav.FindNextElement(RTELEM_TYPE_TABLE) Then
			'		MessageBox "Não foi encontrada a próxima tabela no campo CapGiro,",, _
			' 		"Error"
			'		Exit Sub
			'	End If
				Call rtnav.FindNextElement(RTELEM_TYPE_TABLE)
				'Set rttable = rtnav.GetElement
				'Call rtnav.Findfirstelement(RTELEM_TYPE_TABLECELL)
			End If
			Call rttable.Addrow(1) 
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,(1))
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(datas(scan))
			Call capGiro.EndInsert
			Call capGiro.AppendParagraphStyle(rtpStyle)
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(Format(saldosIniciais(scan),"Standard"))
			Call capGiro.EndInsert
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,(1))
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(Format(entradas(scan),"Standard"))
			Call capGiro.EndInsert
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,(1))
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(Format(saidas(scan),"Standard"))
			Call capGiro.EndInsert
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,(1))
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(fatores(scan))
			Call capGiro.EndInsert
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,(1))
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(aliqIOF(scan))
			Call capGiro.EndInsert
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,(1))
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(Format(valorIOF(scan),"Standard"))
			Call capGiro.EndInsert
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,(1))
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(Format(juros(scan), "Standard"))
			Call capGiro.EndInsert
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,(1))
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(Format(saldosFinais(scan),"Standard"))
			Call capGiro.EndInsert
			Call rtnav.FindNextElement(RTELEM_TYPE_TABLECELL,(1))
			Call capGiro.BeginInsert(rtnav)
			Call capGiro.AppendText(Format(comissoes(scan),"Standard"))
			Call capGiro.EndInsert	
		Next
		
		Print "Extrato Gerado"
		
		
		
		GoTo fimDoLoop
		'====================================================================================
		'=== SEM DETALHAMENTO 0 FUNCAO RTF
		'====================================================================================		

semDetalhamento: 'vem pra cá se não houver movimentação ou se o limite do campo for excedito 
		'Call negocio.ReplaceItemValue("WC_Datas", "")
		'Call negocio.ReplaceItemValue("WC_Saidas", 0)
		'Call negocio.ReplaceItemValue("WC_Entradas", 0)
		'Call negocio.ReplaceItemValue("WC_SaldosIniciais", 0)
		'Call negocio.ReplaceItemValue("WC_Fatores", 0)
		'Call negocio.ReplaceItemValue("WC_SaldosFinais", 0)
		'Call negocio.ReplaceItemValue("WC_AliqIOFs", 0)
		'Call negocio.ReplaceItemValue("WC_ValorIOFs", 0)
		'Call negocio.ReplaceItemValue("WC_Juros", 0)
		'Call negocio.ReplaceItemValue("WC_SaldoDoDia", 0)
fimDoLoop:
		Call negocio.ReplaceItemValue("WC_Obs", obs)
		Call negocio.ReplaceItemValue("WC_TotJuros", totJuros)
		Call negocio.ReplaceItemValue("WC_TotJurosReais", totJurosReais)
		Call negocio.ReplaceItemValue("WC_TotJurosFuturos", totJurosFuturos)
		Call negocio.ReplaceItemValue("WC_ComissaoHoje", comissaoHoje)
		Call negocio.ReplaceItemValue("WC_TotIOF", totIOF)
		Call negocio.ReplaceItemValue("WC_TotIOC", totIOC)
		Call negocio.ReplaceItemValue("WC_Total", totJuros+totIOF+ totIOC)
		Call negocio.ReplaceItemValue("WC_DataInicial", dataInicial)
		Call negocio.ReplaceItemValue("WC_DataFinal", dataFinal)
		Call negocio.ReplaceItemValue("WC_Dias", diasContaNegativa)
		Call negocio.ReplaceItemValue("WC_SaldoDoDia", capitalGiroHoje)	
		Call negocio.ReplaceItemValue("WC_SaldoDoDiaProjetado", saldosFinais(UBound(saldosFinais))) 'ultima posicao da matriz tem o saldo final
		
		If diasContaNegativa > 0 Then
			Call negocio.ReplaceItemValue("WC_ValorMedio", valorMedioNegativo/diasContaNegativa)
		End If
		Call negocio.Save(True, True)
		Set negocio = negocios.GetNextDocument(negocio)
	Loop
	Exit Sub
	
tratamentoErro:
	If Str(Err) = 4000 Then
		obs = "Limite do campo(32K) excedito" & Chr(10) & obs
		GoTo semDetalhamento
	Else
		Resume Next
	End If
End Sub

'++LotusScript Development Environment:2:1:CalculaSaldosMateriais:1:8
Function CalculaSaldosMateriais (doc As NotesDocument) As Double
	
	Dim db As New NotesDatabase (doc.ParentDatabase.Server, "estoquemain.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim movimento As NotesDocument
	Dim scan As Integer
	Dim key(1) As String 
	Dim qtd As Variant
	Dim saldoFaturado As Double, faturar As Double
	
	Set view = db.GetView("(Movimento/ReservaItem)")
	key(0) = doc.Codigo(0)
	
	For scan = 0 To 49
		qtd = doc.GetItemValue("Q_" + Cstr(scan))
		
		If Val(Cstr(qtd(0))) <> 0 Then
			
			key(1) = Cstr(scan + 1)
			Set dc = view.GetAllDocumentsByKey(key, True)
			Set movimento = dc.GetFirstDocument
			
			Do Until movimento Is Nothing
				If movimento.Tipo(0) = "Saída" Then
					saldoFaturado = saldoFaturado + movimento.ValorRealSaida(0)
				End If
				
				Set movimento = dc.GetNextDocument(movimento)
			Loop
			
			Dim moeda As Double
			Dim us As Variant, custo As Variant
			
			us = doc.GetItemValue("Us_"+ Cstr(scan%))
			custo = doc.GetItemValue("CustoUnit_"+ Cstr(scan%))
			If us(0) = "US$C" Then
				'US$C Venda Fixo - LMO 08/01/18
				If IsNumeric(doc.USVenda(0)) Then
					moeda = doc.USVenda(0)
				Else
					If IsNumeric(doc.USC(0)) Then moeda = doc.USC(0) Else moeda = 1
				End If
			Elseif us(0) = "US$T" Then
				If Isnumeric(doc.UST(0)) Then moeda = doc.UST(0) Else moeda = 1
			Elseif us(0) = "R$" Then
				moeda = 1
			End If
			
			If Isnumeric(custo(0)) And Isnumeric(qtd(0)) Then
				faturar = faturar + (custo(0) * moeda * (qtd(0) - dc.Count))
			End If
			
		End If
		
	Next
	
	doc.TotMateriais = saldoFaturado + faturar
	doc.TotMateriais_1 = saldoFaturado + faturar
	doc.TotalNegocio = doc.TotMaterias(0) + doc.TotServicos(0)
	CalculaSaldosMateriais = faturar
	
End Function

'++LotusScript Development Environment:2:2:LinkProjetoContrato:5:8
%REM
	Sub LinkProjeto
	Description: Comments for Sub
%END REM
Sub LinkProjetoContrato(negocio As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim rtItem As NotesRichTextItem
	If negocio.HasItem("LinkProjeto") Then negocio.RemoveItem("LinkProjeto")
	'If negocio.Sit(0) = "Contrato" Then
	If negocio.TipoVenda(0) = "Contrato" Then
		Set view = db.GetView("(ContratosCodigo)")
	Else
		Set view = db.GetView("(ProjetosCodigo)")
	End If
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		negocio.CkInspecao = "1"
		negocio.CkPreVenda = doc.CkPreVenda(0)
		negocio.StatusProjeto = doc.Sit(0)
		Set rtItem = negocio.CreateRichTextItem("LinkProjeto")
		Call rtItem.AppendDocLink(doc,"Link para o " & doc.Form(0))
	Else
		negocio.CkInspecao = ""
		negocio.CkPreVenda = ""
		negocio.StatusProjeto = ""
	End If
	
End Sub


'++LotusScript Development Environment:2:2:Forecast:5:8
%REM
	Sub Forecast
	Description: Comments for Sub
%END REM
Sub Forecast(negocio As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim x As Integer, scan As Integer
	Dim indice As Variant
	indice = ArrayGetIndex(negocio.ProxData, negocio.ProxDataSub(0))
	'Ordena do atual para o antigo - LMO 23/07/18
	Dim proxDatas As Variant, proxData(0) As Variant
	Dim datasForecast As Variant, dataForecast(0) As Variant
	Dim temperaturas As Variant, temperatura(0) As Variant
	Dim tiposFollowUp As Variant, tipoFollowUp(0) As Variant
	Dim followUps As Variant, followUp(0) As Variant
	proxData(0) = negocio.ProxDataSub(0)
	dataForecast(0) = negocio.DataForecastSub(0)
	temperatura(0) = negocio.TemperaturaSub(0)
	tipoFollowUp(0) = negocio.TipoFollowupSub(0)
	followUp(0) = "-> " & Format(Now, "dd/mm/yyyy") & " " & session.Commonusername & " - " & Implode(negocio.ForecastSub, " ")
	If negocio.ProxData(0) <> "" Then
		'*** Temperatura passou a ser MultiValue - LMO 24/07/18 ***
		x = UBound(negocio.DataForecast)
		If UBound(negocio.Temperatura) < x Then
			ReDim temp(x) As Variant
			For scan = 0 To x
				If scan > UBound(negocio.Temperatura) Then
					temp(scan) = negocio.TemperaturaSub(0)
				Else
					If negocio.Temperatura(scan) = "" Then
						temp(scan) = negocio.TemperaturaSub(0)
					Else
						temp(scan) = negocio.Temperatura(scan)
					End If
				End If
			Next
			negocio.Temperatura = temp
		End If
		'*** Tipo de Follow Up - LMO 23/08/18 ***
		x = UBound(negocio.DataForecast)
		If UBound(negocio.TipoFollowup) < x Then
			ReDim tipoFUp(x) As String
			For scan = 0 To x
				If scan > UBound(negocio.TipoFollowup) Then
					tipoFUp(scan) = "Telefone"
				Else
					If negocio.TipoFollowup(scan) = "" Then
						tipoFUp(scan) = "Telefone"
					Else
						tipoFUp(scan) = negocio.TipoFollowup(scan)
					End If
				End If
			Next
			negocio.TipoFollowup = tipoFUp
		End If
		'***
		proxDatas = ArrayAppend( proxData, negocio.ProxData )			
		datasForecast = ArrayAppend( dataForecast, negocio.DataForecast )
		temperaturas = ArrayAppend( temperatura, negocio.Temperatura )
		tiposFollowUp = ArrayAppend( tipoFollowUp, negocio.TipoFollowup )
		followUps = ArrayAppend( followUp, negocio.FollowUp )
	Else
		proxDatas = proxData			
		datasForecast = dataForecast
		temperaturas = temperatura
		tiposFollowUp = tipoFollowUp
		followUps = followUp
	End If
	negocio.ProxData = proxDatas
	negocio.DataForecast = datasForecast
	negocio.Temperatura = temperaturas
	negocio.TipoFollowup = tiposFollowUp
	negocio.FollowUp = followUps
	Call negocio.Save(True, True)
	If IsNull(indice) Then
	'	Call ColocarNaAgenda(negocio)
	End If
	'Aviso de Forecast
	Call AvisoForecast(negocio)
	'Atualiza Projeto/Contrato
	If negocio.CkInspecao(0) = "1" Then
		Call ProjetoContrato(negocio, "Atualiza")
	End If
	'Limpa campos do Popup
	negocio.ValorEstimadoSub = ""
	negocio.DataForecastSub = ""
	negocio.TemperaturaSub = ""
	negocio.ProxDataSub = ""
	negocio.ForecastSub = ""
	
End Sub

'++LotusScript Development Environment:2:1:ConsisteCampos:1:8
Function ConsisteCampos(Source As NotesUIDocument) As Variant
	
	ConsisteCampos = True
	'*** Qualificação do Negócio
	If Source.FieldGetText("CodCliente") = "" Then
		Msgbox "Você precisa Selecionar um Cliente para o Negócio", 16, "Erro !"
		ConsisteCampos = False
	Elseif Source.FieldGetText("TipoVenda") = "" Then
		Msgbox "Você precisa entrar com o Tipo do Negócio", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "TipoVenda" )
	Elseif Source.FieldGetText("CodEmpresa") = "" Then
		Msgbox "Você precisa entrar com o Código da Empresa para este Negócio", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "CodEmpresa" )
	Elseif Source.IsNewDoc And Source.FieldGetText("Classe") = "" Then
		Msgbox "Você precisa entrar com uma Classificação para o Negócio", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "Classe" )
	'Adendo
	Elseif Source.IsNewDoc And Source.FieldGetText("Classe") = "Adendo" And Source.FieldGetText("TipoAdendo") = "" Then
		Msgbox "Você precisa entrar com o Tipo do Adendo", 16, "Erro !"
		ConsisteCampos = False
		Call Source.Refreshhideformulas()
		Call Source.GotoField( "TipoAdendo" )
	Elseif Source.IsNewDoc And Source.FieldGetText("Classe") = "Adendo" And Source.FieldGetText("NegocioPrincipal") = "" Then
		Msgbox "Você precisa entrar com um Negócio Principal para esse Adendo", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "NegocioPrincipal" )
	ElseIf Source.IsNewDoc And Source.FieldGetText("Classe") = "Adendo" And Not ckNegocioPrincipal(Source) Then
		ConsisteCampos = False
		Call Source.GotoField( "NegocioPrincipal" )
	'	
	Elseif Source.FieldGetText("GerenteConta") = "" Then
		Msgbox "Você precisa entrar com um Gerente de Contas para este Negócio", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "GerenteConta" )
	ElseIf Source.FieldGetText("Inside") = "" Then
		MsgBox "Você precisa entrar com um Suporte a Vendas para este Negócio", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "Inside" )
	ElseIf Source.FieldGetText("AreaVendas") = "" Then
		MsgBox "Você precisa entrar com a Área de Vendas para este Negócio", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "AreaVendas" )
	Elseif Source.FieldGetText("TipoVenda") <> "Venda Simples" And Source.FieldGetText("Area") = "" Then
		Msgbox "Você precisa entrar com uma Área de Serviços para este Negócio", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "Area" )
	Elseif Source.FieldGetText("ContatoComercial") = "" Or Source.FieldGetText("ContatoComercial") = "Não há Contatos Ativos Cadastrados nesse Grupo Econômico" Then
		Msgbox "Você precisa entrar com um Contato Comercial responsável por esta proposta dentro do cliente", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "ContatoComercial" )
	Elseif Source.FieldGetText("Descricao") = "" Then
		Msgbox "Você precisa entrar com uma Descrição para este Negocio", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "Descricao" )
	'Cenário
	ElseIf Source.FieldGetText("TipoNegocio") = "Cenário" And Source.FieldGetText("Principal") = "" Then
		MsgBox "Você precisa informar o Negocio Principal", 16, "Erro !"
		ConsisteCampos = False
		Call Source.Refreshhideformulas()
		Call Source.GotoField( "Principal" )
	'Prazo de Pagamento do Cliente
	Elseif (Fechado(Source.FieldGetText("Sit")) Or Source.FieldGetText("Sit") = "Forecast") And Source.FieldGetText("PrazoPagamento") = "" Then
		Msgbox "Você precisa informar o Prazo de Pagamento do Cliente", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "PrazoPagamento" )
	'Prazo de Pagamento do Fornecedor
	ElseIf (Fechado(Source.FieldGetText("Sit")) Or Source.FieldGetText("Sit") = "Forecast") And Val(Source.FieldGetText("TotMateriais")) > 0 And Source.FieldGetText("PrazoPagamentoFornecedor") = "" Then
		MsgBox "Você precisa informar o Prazo de Pagamento do Fornencedor", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "PrazoPagamentoFornecedor" )
	'Prazo Limite do Projeto
	ElseIf (Fechado(Source.FieldGetText("Sit")) Or Source.FieldGetText("Sit") = "Forecast") And Source.FieldGetText("TipoVenda") = "Projeto" And Val(Source.FieldGetText("TotServicos")) > 0 And Source.FieldGetText("PrazoLimiteProjeto") = "" Then
		MsgBox "Você precisa informar o Prazo Limite do Projeto", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "PrazoLimiteProjeto" )
	'Responsável pelo Gerenciamento Projeto
	ElseIf (Fechado(Source.FieldGetText("Sit")) Or Source.FieldGetText("Sit") = "Forecast") And Source.FieldGetText("TipoVenda") = "Projeto" And Val(Source.FieldGetText("TotServicos")) > 0 And Source.FieldGetText("GerenciamentoProjeto") = "" Then
		MsgBox "Você precisa informar o Responsável pelo Gerenciamento Projeto", 16, "Erro !"
		ConsisteCampos = False
		Call Source.GotoField( "GerenciamentoProjeto" )
	'Parceria Predominante - LMO 17/05/16
	ElseIf Source.FieldGetText("Parceria") = "" Then
		MsgBox "Você precisa informar a Parceria Predominante para este Negócio", 16, "Erro !"
		Call Source.GotoField( "Parceria" )
		ConsisteCampos = False
	ElseIf Val(Source.FieldGetText("TotMateriais")) > 0 And UCase(Source.FieldGetText("Parceria")) = "SERVIÇOS" Then
		MsgBox "Parceria Predominante inválida para este Negócio", 16, "Erro !"
		Call Source.GotoField( "Parceria" )
		ConsisteCampos = False
	'Frete
	ElseIf Source.Fieldgettext("Frete") = "" Then
		MsgBox "Você precisa informar o Valor do Frete. Se não houver informar Zero.", 16, "Erro !"
		Call Source.GotoField( "Frete" )
		ConsisteCampos = False
	Else
		'Lista de Materiais
		Dim scan As Integer
		For scan = 0 To 49
			If Source.FieldGetText("Q_" + Cstr(scan) ) <> "" Then
				'PartN e Produto
				If Source.FieldGetText("PartNo_" + Cstr(scan) ) = "" Or Source.FieldGetText("Produto_" + Cstr(scan) ) = "" Then
					Msgbox "Você precisa preencher o PartN e o Produto do Item " + Cstr(scan + 1), 16, "Erro na Lista de Materiais!"
					ConsisteCampos = False
					Call Source.GotoField( "Q_" + Cstr(scan) )
					Exit For
				End If
			End If
		Next
		'Lista de Serviços
		If Source.FieldGetText( "TipoVenda" ) <> "Venda Simples" Then
			For scan = 0 To 11
				If Source.FieldGetText("Qs_" + CStr(scan) ) <> "" Then
					If Source.FieldGetText("Produtos_" + CStr(scan) ) = "" Then
						MsgBox "Você precisa preencher o Serviço do Item " + CStr(scan + 1), 16, "Erro na Lista de Serviços!"
						ConsisteCampos = False
						Call Source.GotoField( "Qs_" + CStr(scan) )
						Exit For
					End If
				End If
			Next
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:1:CkSuframa:5:8
%REM
	Function CkSuframa
	Description: Comments for Function
%END REM
Function CkSuframa(origem As String, destino As String) As Boolean
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim chave(1) As String
	chave(0) = origem
	chave(1) = destino
	Set db = New NotesDatabase(session.CurrentDatabase.Server, "faturas.nsf")
	Set view = db.GetView("(Configuracao/ICMS)")
	Set doc = view.GetDocumentByKey(chave, True)
	If Not doc Is Nothing Then
		If doc.HasItem("Suframa") Then
			If doc.Suframa(0) = "Sim" Then
				CkSuframa = True
			End If
		End If
	End If
	
End Function


'++LotusScript Development Environment:2:1:CkPlanilha:5:8
%REM
	Function CkPlanilha
	Description: Comments for Function
%ENDREM
Function CkPlanilha(uidoc As NotesUIDocument) As Boolean
	
	CkPlanilha = True
	If uidoc.Fieldgettext("TipoVenda") = "Projeto" Or uidoc.Fieldgettext("TipoVenda") = "Chamado" Or uidoc.Fieldgettext("TipoVenda") = "Contrato" Then
		Dim db As New NotesDatabase(uidoc.Document.Parentdatabase.Server, "servicos.nsf")
		Dim view As NotesView
		Dim doc As NotesDocument
		Set view = db.Getview("(Planilha/Codigo)")
		Set doc = view.Getdocumentbykey(uidoc.FieldGetText("Codigo"), True)
		If doc Is Nothing Then
			MsgBox "Planilha Financeira não foi criada," & Chr(10) & "solicite a Pré-Venda do Negócio.", 16, "Erro no Fechamento do Negócio"
			CkPlanilha = False
		End If
	End If
	
End Function


'++LotusScript Development Environment:2:2:AtualizaReceber:5:8
%REM
	Sub AtualizaReceber
	Description: Comments for Sub
%END REM
Sub AtualizaReceber(espelho As NotesDocument)
	
	'Salva Informações do Aceite no Receber - LMO 23/10/18
	Dim db As New NotesDatabase(espelho.ParentDatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim key(2) As String
	key(0) = "TDECREDES"
	key(1) = CStr(espelho.NFiscal(0))
	key(2) = espelho.Tipo(0)
	Set view = db.GetView("(Receber/NFiscal)")
	Set dc = view.GetAllDocumentsByKey(key, True)
	If dc.Count = 0 Then
		Exit Sub
	End If
	Set doc = dc.GetFirstDocument
	Do Until doc Is Nothing
		doc.StatusAceiteFaturamento = espelho.StatusAceiteFaturamento(0)
		doc.NumContatos = espelho.NumContatos(0)
		Call doc.Save(False, False)
		Set doc = dc.GetNextDocument(doc)
	Loop
	
End Sub

'++LotusScript Development Environment:2:2:SaldoMateriais:5:8
%REM
	Function Saldo
	Description: Comments for Function
%END REM
Sub SaldoMateriais(projeto As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(projeto.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim scan As Integer, qtd As Long, saldoCompra As Long, saldoBaixa As Long, saldoCompraT As Long, saldoBaixaT As Long, saldoFaseT As Long
	Dim cont As Integer, contC As Integer, contB As Integer, contF As Integer
	Dim item As NotesItem
	Dim fase As Variant
	Set view = db.GetView("(NegocioNItens)")
	For scan = 0 To 49
		Set doc = view.getDocumentByKey( projeto.Codigo(0) & "-" & (scan + 1), True )
		If Not doc Is Nothing Then
			qtd = qtd + doc.Q(0)
			saldoCompra = doc.Q(0) - doc.QCompra(0)
			saldoBaixa = doc.Q(0) - doc.QBaixa(0)
			saldoCompraT = saldoCompraT + saldoCompra
			saldoBaixaT = saldoBaixaT + saldoBaixa
			Set item = projeto.ReplaceItemValue("SC_" & scan, saldoCompra)
			Set item = projeto.ReplaceItemValue("SB_" & scan, saldoBaixa)
			Set item = projeto.ReplaceItemValue("DataE_" & scan, doc.PrazoEntrega(0))
			'Fase
			fase = projeto.Getitemvalue("Fase_" & scan)
			If fase(0) = "" Then
				Set item = projeto.ReplaceItemValue("Fase_" & scan, "1")
			End If
			If Val(fase(0)) = 0 Then
				saldoFaseT = saldoFaseT + 1
			End If
			'Atualiza Fase em Listas
			doc.Fase = CStr(Val(fase(0)))
			Call doc.Save(True, True)
			'Controle de Itens
			cont = cont + 1
			If doc.Q(0) = doc.QCompra(0) Then
				contC = contC + 1
			End If
			If doc.Q(0) = doc.QBaixa(0) Then
				contB = contB + 1
			End If
			If Val(fase(0)) > 0 Then
				contF = contF + 1
			End If
		End If
	Next
	projeto.QT = qtd
	projeto.SCT = saldoCompraT
	projeto.SBT = saldoBaixaT
	projeto.SFT = saldoFaseT
	projeto.Compras = contC & " de " & cont
	projeto.Baixas = contB & " de " & cont
	projeto.Fases = contF & " de " & cont
	
End Sub


'++LotusScript Development Environment:2:2:Participacoes:5:8
%REM
	Sub Participacoes
	Description: Busca as Horas por Fase dos Técnicos lançadas no Time Sheet e calcula a Participação proporcional de cada Técnico.
%END REM
Sub Participacoes(negocio As NotesDocument)
	
	On Error Resume Next
	If negocio.CheckPagtoParticipacoes(0) = "OK" Then Exit Sub
	'Time Sheets
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "timesheet.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim doc As NotesDocument
	Dim x As Integer, y As Integer, scan As Integer, horasTot As Double, horasTotPMO As Double
	ReDim nomes(0) As String, horas(0) As Double
	ReDim nomesPMO(0) As String, horasPMO(0) As Double
	Dim indice As Variant, indicePMO As Variant
	Dim key(1) As String
	key(0) = negocio.Codigo(0)
	Set view = db.GetView("(TimeSheet/Codigo)")
	If negocio.Area(0) = "Suporte" Or negocio.Area(0) = "Cabling" Then
		'*** Pré-Venda ***
		key(1) = "Pré-Venda"
		Set dc = view.GetAllDocumentsByKey(key, True)
		Set doc = dc.Getfirstdocument()
		Do Until doc Is Nothing
				indice = ArrayGetIndex(nomes, doc.Nome(0))
				If IsNull(indice) Then
					ReDim Preserve nomes(x) As String, horas(x) As Double
					nomes(x) = doc.Nome(0)
					horas(x) = Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
					x = x + 1
				Else
					horas(indice) = horas(indice) + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
				End If
				horasTot = horasTot + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
			Set doc = dc.Getnextdocument(doc)
		Loop
		'*** POC ***
		key(1) = "POC"
		Set dc = view.GetAllDocumentsByKey(key, True)
		Set doc = dc.Getfirstdocument()
		Do Until doc Is Nothing
			indice = ArrayGetIndex(nomes, doc.Nome(0))
			If IsNull(indice) Then
				ReDim Preserve nomes(x) As String, horas(x) As Double
				nomes(x) = doc.Nome(0)
				horas(x) = Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
				x = x + 1
			Else
				horas(indice) = horas(indice) + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
			End If
			horasTot = horasTot + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
			Set doc = dc.Getnextdocument(doc)
		Loop
		x = UBound(nomes)
		ReDim participacao(x) As Double
		For scan = 0 To x
			If horasTot > 0 Then participacao(scan) = Round(horas(scan) / horasTot, 2)
		Next
		negocio.NomePV = nomes
		negocio.ParticipacaoPV = participacao
		'*** Execução e PMO ***
		x = 0
		horasTot = 0
		key(1) = negocio.TipoVenda(0) 'Projeto/Chamado/Contrato
		If key(1) = "Chamado" Then key(1) = "Projeto"
		ReDim nomes(0) As String, horas(0) As Double
		Set dc = view.GetAllDocumentsByKey(key, True)
		Set doc = dc.Getfirstdocument()
		Do Until doc Is Nothing
			'PMO (Horas de Gerenciamento) - LMO 31/07/25
			If doc.TipoHora(0) = "Ger" Then
				indicePMO = ArrayGetIndex(nomesPMO, doc.Nome(0))
				If IsNull(indicePMO) Then
					ReDim Preserve nomesPMO(y) As String, horasPMO(y) As Double
					nomesPMO(y) = doc.Nome(0)
					horasPMO(y) = Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
					y = y + 1
				Else
					horasPMO(indicePMO) = horasPMO(indicePMO) + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
				End If
				horasTotPMO = horasTotPMO + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
			Else
				indice = ArrayGetIndex(nomes, doc.Nome(0))
				If IsNull(indice) Then
					ReDim Preserve nomes(x) As String, horas(x) As Double
					nomes(x) = doc.Nome(0)
					horas(x) = Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
					x = x + 1
				Else
					horas(indice) = horas(indice) + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
				End If
				horasTot = horasTot + Round(Hour(doc.HorarioFinal(0)) - Hour(doc.HorarioInicial(0)) + (Minute(doc.HorarioFinal(0)) - Minute(doc.HorarioInicial(0)))/60, 1)
			End If
			Set doc = dc.Getnextdocument(doc)
		Loop
		x = UBound(nomes)
		ReDim participacao(x) As Double
		For scan = 0 To x
			If horasTot > 0 Then participacao(scan) = Round(horas(scan) / horasTot, 2)
		Next
		negocio.NomeExec = nomes
		negocio.ParticipacaoExec = participacao
		'PMO (Horas de Gerenciamento) - LMO 31/07/25
		x = UBound(nomesPMO)
		ReDim participacao(x) As Double
		For scan = 0 To x
			If horasTotPMO > 0 Then participacao(scan) = Round(horasPMO(scan) / horasTotPMO, 2)
		Next
		negocio.NomePMO = nomesPMO
		negocio.ParticipacaoPMO = participacao
		'Calcula a Participação
		Call CalcParticipacoes(negocio)
	End If
	
End Sub

'++LotusScript Development Environment:2:2:GetDataConclusao:5:8
%REM
	Sub GetDataConclusao
	Description: Comments for Sub
%END REM
Sub GetDataConclusao(negocio As NotesDocument)
	
	'1) Data do Último Receber/Data da Conclusão do Projeto/Data da Conclusão da Importação (o que acontecer por último)
	'2) Data da Última Glosa/Espelho(Doação e Remessa não tem Receber)
	'3) Data da Conclusão FOB
	On Error Resume Next
	If negocio.DataConclusao(0) <> "" Then Exit Sub
	'If negocio.TipoVenda(0) = "Contrato" Then	'Comentado em 20/03/18
	'	Exit Sub
	'End If
	'1)
	Dim data As String
	'Data do Último Receber
	If negocio.DataConclusaoReceber(0) <> "" Then
		data = negocio.DataConclusaoReceber(0)
	End If
	'Data da Conclusão do Projeto
	If negocio.DataConclusaoProjeto(0) <> "" Then
		If data = "" Then
			data = negocio.DataConclusaoProjeto(0)
		Else
			If CDat(negocio.DataConclusaoProjeto(0)) > CDat(data) Then
				data = negocio.DataConclusaoProjeto(0)
			End If
		End If
	End If
	'Data da Conclusão da Importação
	If negocio.DataConclusaoImportacao(0) <> "" Then
		If data = "" Then
			data = negocio.DataConclusaoImportacao(0)
		Else
			If CDat(negocio.DataConclusaoImportacao(0)) > CDat(data) Then
				data = negocio.DataConclusaoImportacao(0)
			End If
		End If
	End If
	negocio.DataConclusao = CDat(data)
	If data <> "" Then Exit Sub
	'2) Glosa/Espelho
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Set db = New NotesDatabase(negocio.ParentDatabase.Server, "faturas.nsf")
	Set view = db.GetView("(EspelhosNegocio)")
	Set doc = view.GetDocumentByKey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		negocio.DataConclusao = doc.DataFaturamento(0)
		Exit Sub
	End If
	'3) Conclusão FOB
	If negocio.DataConclusao(0) = "" Then
		negocio.DataConclusao = Today
	End If
		
End Sub

'++LotusScript Development Environment:2:1:CheckFaturamento:5:8
%REM
	Function CheckFaturamento
	Description: Comments for Function
%END REM
Function CheckFaturamento(negocio As NotesDocument) As Variant
	
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim array(1) As Boolean
	
	'1) Check Estoque Main
	Set db = New NotesDatabase(negocio.Parentdatabase.Server, "estoquemain.nsf")
	Set view = db.Getview("(Estoque/Reserva)")
	Set doc = view.Getdocumentbykey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		array(0) = True
	End If
	
	'2) Check Serviços
	Set db = New NotesDatabase(negocio.Parentdatabase.Server, "servicos.nsf")
	If negocio.TipoVenda(0) = "Contrato" Then
		Set view = db.GetView("(ContratosCodigo)")
	Else
		Set view = db.GetView("(ProjetosCodigo)")
	End If
	Set doc = view.Getdocumentbykey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		negocio.StatusProjeto = doc.Sit(0)
		If (negocio.TipoVenda(0) = "Projeto" Or negocio.TipoVenda(0) = "Chamado") And Val(negocio.SaldoServicos(0)) > 0 Then
			If doc.Sit(0) = "Aguardando Lançamento de Despesas e Horas" Or doc.Sit(0) = "Concluído" Then
				array(1) = True
			End If
		End If
	End If
	CheckFaturamento = array
	
End Function

'++LotusScript Development Environment:2:2:GetConsolidacoes:5:8
%REM
	Sub GetConsolidacoes
	Description: Comments for Sub
%END REM
Sub GetConsolidacoes(doc As NotesDocument)
	
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim documento As NotesDocument
	Dim despesas As Double, horas As Double
	'Despesas
	Set db = New NotesDatabase(doc.ParentDatabase.server, "caixa.nsf")
	Set view = db.GetView("(DespesasConsolidadasNegocio)")
	Set dc = view.GetAllDocumentsByKey(doc.Codigo(0), True)
	Set documento = dc.Getfirstdocument()
	Do Until documento Is Nothing
		despesas = despesas + documento.TotTot(0)
		Set documento = dc.Getnextdocument(documento)
	Loop
	'Horas
	Set db = New NotesDatabase(doc.ParentDatabase.server, "timesheet.nsf")
	Set view = db.GetView("(TimeSheetConsolidados/Codigo)")
	Set dc = view.GetAllDocumentsByKey(doc.Codigo(0), True)
	Set documento = dc.Getfirstdocument()
	Do Until documento Is Nothing
		'Horas de Execução - (Contrato/Projeto)
		If documento.Tipo(0) = "C" Or documento.Tipo(0) = "P" Then
			horas = horas + documento.TotPeriodo(0)
		End If
		Set documento = dc.Getnextdocument(documento)
	Loop
	doc.DespesasConsolidadas_P = Round(despesas, 2)
	doc.HorasConsolidadas_P = Round(horas, 2)
	
End Sub

'++LotusScript Development Environment:2:2:CalcComissoes:1:8
Sub CalcComissoes (doc As NotesDocument)
	
	On Error Resume Next
	Dim nomes As Variant, participacoes As Variant
	Dim scan As Integer
	nomes = doc.NomeComissao
	participacoes = doc.ParticipacaoComissao
	ReDim valoresParticipacoes(UBound(nomes)) As Double
	If UBound(nomes) = UBound(participacoes) Then
		For scan = 0 To UBound(nomes)
			If IsNumeric(participacoes(scan)) Then valoresParticipacoes(scan) = doc.Premio(0) * participacoes(scan)
		Next
	End If
	doc.ValorPrevistoComissao = valoresParticipacoes
	
End Sub



'++LotusScript Development Environment:2:2:FaturaMateriaisDoc:5:8
%REM
	Sub FaturaMateriaisDoc
	Description: Comments for Sub
%END REM
Sub FaturaMateriaisDoc(negocio As NotesDocument)
	
	'Passar para a Lista de Materiais
	%REM
	'Consiste Campos do Fechamento
	If Not ConsisteCamposFechamento(uidoc) Then
		Exit Sub
	End If
	'Consiste Campos Comprador
	If Not ConsisteComprador(uidoc) Then
		Exit Sub
	End If
	%END REM
	'Popula Lista de Materiais
	'Call PopulaListaMateriais(uidoc.Document)	'Retirado para melhorar a performance - LMO 21/06/23
	'Verifica dados da Lista de Materiais e Serviços	'Retirado para melhorar a performance - LMO 21/06/23
	%REM
	If Not checkItensLista(uidoc) Then
		Exit Sub
	End If
	%END REM
	Dim session As New NotesSession
	Dim workspace As New NotesUIWorkspace
	Dim pedido As String, st As String, item As String
	Dim fator As Double, fi As Double, ip As Double, total As Double
	Dim scan As Integer, scan2 As Integer, scan3 As Integer
	'Condições de Pagamento (D.D.L.: Dias da Data Líquido; D.F.M.: Dias Fora Mês; D.F.Q.: Dias Fora Quinzena; D.F.V.: Dia Fixo de Vencimento)
	Dim dataFaturamento As New NotesDateTime(Today), vencimento As New NotesDateTime(Today)
	If negocio.CondPagto(0) = "D.F.M." Then	'D.F.M. (Dias Fora Mês)
		Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
		Call vencimento.AdjustMonth(1)
		Call vencimento.Adjustday(negocio.PrazoPagamento(0) - 1)
	ElseIf negocio.CondPagto(0) = "D.F.Q." Then	'D.F.Q. (Dias Fora Quinzena)
		If Day(dataFaturamento.DateOnly) <= 15 Then
			'1)Faturado até dia 15
			Set vencimento = New NotesDateTime("15/" & Month(Today) & "/" & Year(Today))
			Call vencimento.Adjustday(negocio.PrazoPagamento(0))
		Else
			'2)Faturado após dia 15
			Set vencimento = New NotesDateTime("01/" & Month(Today) & "/" & Year(Today))
			Call vencimento.AdjustMonth(1)
			Call vencimento.Adjustday(negocio.PrazoPagamento(0))
		End If
	ElseIf negocio.CondPagto(0) = "D.F.S." Then	'D.F.S. (Dias Fora Semana)
		Set vencimento = New NotesDateTime(Today)
		Do Until Weekday(vencimento.Dateonly) = 1
			Call vencimento.AdjustDay(1)
		Loop
		Call vencimento.Adjustday(negocio.PrazoPagamento(0))
	ElseIf negocio.CondPagto(0) = "D.F.V." Then	'D.F.V. (Dia Fixo de Vencimento)
		Set vencimento = New NotesDateTime(negocio.PrazoPagamento(0) & "/" & Month(Today) & "/" & Year(Today))
	ElseIf negocio.CondPagto(0) = "D.D.L." Then	'D.D.L. (Dias Decorridos Líquido)
		Call vencimento.Adjustday(negocio.PrazoPagamento(0))
	End If
	
	
	
End Sub

'++LotusScript Development Environment:2:2:AvisoDesfechamento:5:8
%REM
	Sub AvisoDesfechamento
	Description: Comments for Sub
%END REM
Sub AvisoDesfechamento(doc As NotesDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim memo As NotesDocument, rtitem As NotesRichTextItem
	'Estilo do Texto
	Dim richStyle As NotesRichTextStyle
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	Set memo = New NotesDocument( session.CurrentDatabase )
	memo.Form = "Memo"
	memo.From = session.CommonUserName
	memo.Subject = "-> Negócio Desfechado - " & doc.Codigo(0)  & " - " & doc.Cliente(0)
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	Set rtitem = memo.CreateRichTextItem("Body")
	Call rtitem.AppendStyle(richStyle)
	If doc.Area(0) <> "" Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Área de Serviços: " & doc.Area(0))
	End If
	If doc.AreaVendas(0) <> "" Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Área de Vendas: " & doc.AreaVendas(0))
	End If
	If CStr(doc.TotalNegocio(0)) <> "" Then
		Call rtitem.AddNewLine( 1 )
		Call rtitem.AppendText("Total do Negócio: R$ " & Format(doc.TotalNegocio(0), "Standard"))
	End If
	If CStr(doc.ValorEstimadoSub(0)) <> "" Then
		Call rtitem.AddNewLine( 1 )
		If doc.Temperatura(0) = "Frio" Then
			Call rtitem.Appendtext( "Temperatura: Frio (60%)" )
		ElseIf doc.Temperatura(0) = "Morno" Then
			Call rtitem.Appendtext( "Temperatura: Morno (70%)" )
		ElseIf doc.Temperatura(0) = "Quente" Then
			Call rtitem.Appendtext( "Temperatura: Quente (80%)" )
		End If
		Call rtitem.AddNewLine( 1 )
		Call rtitem.Appendtext( "Valor Estimado: R$ " & Format(doc.ValorEstimadoSub(0), "Standard") )
	End If
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "Descrição: " & doc.Descricao(0) )
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( "Negócio:  " )
	Call rtitem.AppendDocLink( doc, "Link para o Negócio" )
	richStyle.Bold = True
	richStyle.Underline = True
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine( 2 )
	Call rtitem.AppendText( "Motivo: " )
	richStyle.Bold = False
	richStyle.Underline = False
	Call rtitem.AppendStyle(richStyle)
	Call rtitem.AddNewLine( 1 )
	Call rtitem.Appendtext( "Previsão Fechamento: " & Format(doc.DataForecast(0), "dd/mm/yyyy") )
	Call rtitem.AddNewLine( 1 )
	Call rtitem.AppendText( doc.FollowUp(0) )	
	Call rtitem.AddNewLine( 2 )
	Call rtitem.Appendtext( session.CommonUserName & "," )
	Call rtitem.AddNewLine( 1 )
	Call rtitem.Appendtext( "TDec Network Group" )
	Call memo.Send( False )
	
End Sub

'++LotusScript Development Environment:2:2:GeraCapitalGiroporArray:2:8

Sub GeraCapitalGiroporArray(negocios As NotesDocumentCollection)
	'--- Nao está em uso. Usamos apenas o CalcCapitalGiroReal	
	On Error GoTo tratamentoErro
	Dim session As New NotesSession
	Dim doc As NotesDocument
	'Iniciar criando um array com todas as datas entre o início e o final do negócio
	'Pesquisar nas bases de Receber e Despesas para ver quando iniciaram os movimentos de caixa
	Dim dbFaturas As New NotesDatabase(session.CurrentDatabase.Server,"faturas.nsf")
	Dim viewReceber As NotesView
	Set viewReceber = dbFaturas.GetView("(Receber/Negocio)")
	Dim dbDespesas As New NotesDatabase(session.CurrentDatabase.Server,"caixa.nsf")
	Dim viewDespesas As NotesView
	Set viewDespesas = dbDespesas.GetView("(DespesasNegocio)")
	Dim despesa As NotesDocument
	Dim receber As NotesDocument
	Dim primeiraDataDesp As NotesDateTime
	Dim primeiraDataRec As NotesDateTime
	Dim datasDescpTmp() As String
	Dim valoresDespTmp() As Double
	Dim valoresRecTmp() As Double
	Dim datasRecTmp() As String
	Dim dataFinal As NotesDateTime
	Dim dbBancos As New NotesDatabase(session.CurrentDatabase.Server,"bancos.nsf")
	Dim viewCapitalGiro As NotesView
	Dim hoje As New NotesDateTime(Today)
	Dim anos() As Integer, meses() As Integer
	Dim datasFatores() As String, valoresFatores() As Double, fatorIOF() As Double
	Dim ckAno As Integer, ckMes As Integer
	Dim comparaMesPeriodo As String, comparaMesHoje As String
	Dim contaMeses As NotesDateTime, contaMesesSimulacao As NotesDateTime
	Dim resultado As Integer
	Dim saldoInicial As Double, saldoFinal As Double,  saida As Double, entrada As Double,fator As Double, osJuros As Double, totJuros As Double, valIOF As Double
	Dim totIOF As Double, totIOC As Double
	Dim maiorSaldo As Double 'para calcular o IOC
	Dim periodoFinal As String, scanPeriodo As String
	Dim periodo As String, mes As String, ckPeriodo As String, simula As Double, simulaIOF As Double, simulaIOC
	Dim scanData As NotesDateTime
	Dim ultimaDataDesp As NotesDateTime, ultimaDataRec As NotesDateTime, estaData As NotesDateTime
	Dim diasContaNegativa As Double, valorMedioNegativo As Double
	Dim scan As Integer
	
	Dim datas() As Variant 'vai guardar todas entre a primeira despesa/receber até a conclusão do negócio
	Dim saidas() As Double, entradas() As Double, saldos() As Double, fatores() As Double, juros() As Double
	Dim ckIOC As Integer
	
	Dim dcDespesas As NotesDocumentCollection
	Dim dcReceber As NotesDocumentCollection
	
	Dim codigo As String
	
	Dim negocio As NotesDocument
	Dim obs As String, ioc As Double, somaSaldos As Double
	
	Set negocio = negocios.GetFirstDocument
	Do Until negocio Is Nothing
		
		codigo = negocio.Codigo(0)
		saldoInicial = 0
		saldoFinal = 0
		totIOC = 0
		totJuros = 0
		totIOF = 0
		obs = ""
		ioc = 0
		somaSaldos = 0
		diasContaNegativa = 0
		valorMedioNegativo = 0
		
		'Print codigo
		Set dcDespesas = viewDespesas.GetAllDocumentsByKey(codigo, True)
		Set despesa = viewDespesas.GetDocumentByKey(codigo, True)
		Set dcReceber = viewReceber.GetAlldocumentsByKey(codigo, True)
		Set receber = viewReceber.GetDocumentByKey(codigo, True)
		If receber Is Nothing And despesa Is Nothing Then
			'MsgBox("Não houve movimento financeiro neste negócio")
			'print codigo + " - " + "Não houve movimento nesse negócio"
			obs = "Não houve movimento nesse negócio"
			GoTo semDetalhamento
		End If
		Dim dataInicial As NotesDateTime
		
		'===============================================================================
		'certificando de estar pegando a última data do documentcollection das despesas
		'===============================================================================
		scan = 0
		Set doc = dcDespesas.GetFirstDocument
		If dcDespesas.Count > 0 Then
			Set ultimaDataDesp = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
			Set primeiraDataDesp = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
			Do Until doc Is Nothing
				ReDim Preserve datasDespTmp(scan) As String
				ReDim Preserve valoresDespTmp(scan) As Double
				datasDespTmp(scan) = DateValue(doc.VencimentoDespesa(0))
				valoresDespTmp(scan) = doc.TotTot(0)
				Set estaData = session.CreateDateTime( DateValue(doc.VencimentoDespesa(0)))
				If estaData.TimeDifference(ultimaDataDesp) > 0 Then
					Set ultimaDataDesp = session.CreateDateTime( estaData.DateOnly )
				End If
				If estaData.TimeDifference(primeiraDataDesp) <= 0 Then
					Set primeiraDataDesp = session.CreateDateTime( estaData.DateOnly )
				End If
				scan = scan+1
				Set doc = dcDespesas.GetNextDocument(doc)
			Loop
		End If
		'==================================================================================
		'Populando a matriz temporária de RECEBER e definindo qual a última data do receber
		'==================================================================================
		
		If dcReceber.Count > 0 Then	
			scan = 0
			Set doc = dcReceber.GetFirstDocument
			Set ultimaDataRec = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
			Set primeiraDataRec = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
			Do Until doc Is Nothing
				ReDim Preserve datasRecTmp(scan) As String
				ReDim Preserve valoresRecTmp(scan) As Double
				datasRecTmp(scan) = DateValue(doc.Prorrogacao(0))
				valoresRecTmp(scan) = doc.TotTot(0)
				Set estaData = session.CreateDateTime( DateValue(doc.Prorrogacao(0)))
				If estaData.TimeDifference(ultimaDataRec) > 0 Then
					Set ultimaDataRec = session.CreateDateTime( estaData.DateOnly )
				End If
				If estaData.TimeDifference(primeiraDataRec) <= 0 Then
					Set primeiraDataRec = session.CreateDateTime( estaData.DateOnly )
				End If
				scan = scan+1
				Set doc = dcReceber.GetNextDocument(doc)
			Loop
		Else
			Set ultimaDataRec = session.CreateDateTime(ultimaDataDesp.DateOnly)
			Set primeiraDataRec = session.CreateDateTime(primeiraDataDesp.DateOnly)
		End If
		
		'================================================================================
		'Definindo a data final - a ultima data entre a ultima DESPESA e o ultimo RECEBER
		'================================================================================
		
		If primeiraDataDesp.TimeDifference(primeiraDataRec) <= 0 Then
			Set dataInicial = session.CreateDateTime( primeiraDataDesp.DateOnly )
		Else
			Set dataInicial = session.CreateDateTime( primeiraDataRec.DateOnly )
			obs = obs + " - Receber foi antes"
		End If
		
		If ultimaDataRec.TimeDifference(ultimaDataDesp) > 0 Then
			Set dataFinal = session.CreateDateTime( ultimaDataRec.DateOnly )
		Else
			Set dataFinal = session.CreateDateTime( ultimaDataDesp.DateOnly )
		End If
		
		Set scanData = session.CreateDateTime(dataInicial.DateOnly)
		scan = 0
		Do Until scanData.TimeDifference(dataFinal) > 0
			ReDim Preserve datas(scan)
			ReDim Preserve saldosIniciais(scan)
			ReDim Preserve entradas(scan)
			ReDim Preserve saidas(scan)
			ReDim Preserve saldosFinais(scan)
			ReDim Preserve fatores(scan)
			ReDim Preserve aliqIOF(scan) 'aliq de 0,0041% incide diariamente
			ReDim Preserve valorIOF(scan)
			ReDim Preserve juros(scan)
			datas(scan) = scanData.DateOnly
			Call scanData.AdjustDay(1)
			scan = scan + 1
		Loop
		
		'================================================================================================
		'populando a matriz de FATORES e IOF a partir dos dados contidos na vista Custo Capital de Giro em Bancos
		'em uma simulação pode ocorrer um caso onde datas futuras entram na simulacao. Vamos usar data de hoje para futuro
		'aproveitar e popular a matriz IOF que é fixa mensal
		'================================================================================================
		
		Set viewCapitalGiro = dbBancos.GetView("Custo Capital de Giro")
		
		' Definindo quantos meses devo buscar nas taxas de juros para fazer apenas um acesso a disco
		
		'====================================================================================
		'analisando se o periodo sendo analisado é anterior ou posterior ao mes da data atual
		'se for "depois" será usado o último índice existente no sistema. 
		'será uma SIMULACAO, já que não temos índices futuros
		'====================================================================================
		scan = 0
		
		Set contaMeses = session.CreateDateTime(DataInicial.DateOnly)
		Set contaMesesSimulacao = session.CreateDateTime(DataInicial.DateOnly)
		
		If Len(CStr(Month(dataFinal.LSGMTTime))) = 1 Then
			periodoFinal = CStr(Year(dataFinal.LSGMTTime)+"/0"+Cstr(Month(dataFinal.LSGMTTime)))
		Else
			periodoFinal = CStr(Year(dataFinal.LSGMTTime)+"/"+Cstr(Month(dataFinal.LSGMTTime)))
		End If
		If Len(CStr(Month(contaMeses.LSGMTTime))) = 1 Then
			scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/0"+Cstr(Month(contaMeses.LSGMTTime)))
		Else
			scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/"+Cstr(Month(contaMeses.LSGMTTime)))
		End If
		
		Do While scanPeriodo <= periodoFinal		
			ReDim Preserve anos(scan) As Integer
			mes = CStr(Month(contaMeses.LSLocalTime))
			If Len(mes) = 1 Then mes = "0" + mes
			periodo = CStr(Year(contaMeses.LSLocalTime)) + "/" + mes
			'analisando se a simulação está sendo feita em um mês futuro onde iremos utilizar o último fator como base de simulacao
			'========================
			'precisamos acrescenter um zero no mes para que a comparacao nao coloque periodos como 2014/4 sendo maior que 2014/10.
			If Len(CStr(Month(contaMeses.LSLocalTime))) = 1 Then
				comparaMesPeriodo = "0"+CStr(Month(contaMeses.LSLocalTime))
			Else
				comparaMesPeriodo = CStr(Month(contaMeses.LSLocalTime))
			End If 
			If Len(CStr(Month(Today))) = 1 Then
				comparaMesHoje = "0"+CStr(Month(contaMeses.LSLocalTime))
			Else
				comparaMesHoje = CStr(Month(Today))
			End If 			
			If CStr(Year(contaMeses.LSLocalTime)) + "/" +  comparaMesPeriodo < CStr(Year(Today)) + "/" + comparaMesHoje Then
				'MsgBox(CStr(Year(contaMeses.LSLocalTime)) + "/" +  CStr(Month(contaMeses.LSLocalTime)) + " --- " + CStr(Year(Today)) + "/" + CStr(Month(Today)))
				ckPeriodo = "antes"			
			Else
				ckPeriodo = "depois"
			End If
			Set doc = viewCapitalGiro.GetDocumentByKey(periodo, True)
			If doc Is Nothing And ckPeriodo = "antes" Then
				'MsgBox("Fator não encontrado na base Bancos - Vista Custo Capital de Giro. Favor criar o documento")
				'MsgBox( codigo + " - " + periodo + " - " + "Fator não encontrado")
				obs = "- Fator não está no sistema - "
				GoTo fatorNaoEncontrado
			End If
			ReDim Preserve datasFatores(scan) As String
			ReDim Preserve valoresFatores(scan) As Double
			ReDim Preserve fatorIOF(scan) As Double
			If ckPeriodo = "antes" Then  
				datasFatores(scan) = periodo
				valoresFatores(scan ) = doc.Fator(0)
				fatorIOF(scan) = doc.IOF(0)
				simula = doc.Fator(0)
				simulaIOF = doc.IOF(0)
			Else
				'se a primeira data do negócio for em um mês futuro, simula fica igual a zero.
				'neste caso, temos que voltar um mês no período para encontrar um simula diferente de zero
				If simula = 0 Then
					Do While simula = 0
						'procurar o último fator anterior à primeira despesa/receita do negocio
						mes = CStr(Month(contaMesesSimulacao.LSLocalTime))
						If Len(mes) = 1 Then mes = "0" + mes
						Set doc = viewCapitalGiro.GetDocumentByKey(CStr(Year(contaMesesSimulacao.LSLocalTime)) + "/" + mes, True)
						If Not (doc Is Nothing) Then							
							datasFatores(scan) = periodo ' fica o período correto com os fatores de mes anterior
							valoresFatores(scan ) = doc.Fator(0)
							fatorIOF(scan) = doc.IOF(0)
							simula = doc.Fator(0)
							simulaIOF = doc.IOF(0)
						End If
						Call contaMesesSimulacao.Adjustmonth(-1)
					Loop
				Else
					datasFatores(scan) = periodo
					valoresFatores(scan ) = simula
					fatorIOF(scan) = simulaIOF
				End If
			End If
			Call contaMeses.AdjustMonth(1)
			If Len(CStr(Month(contaMeses.LSGMTTime))) = 1 Then
				scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/0"+Cstr(Month(contaMeses.LSGMTTime)))
			Else
				scanPeriodo = CStr(Year(contaMeses.LSGMTTime)+"/"+Cstr(Month(contaMeses.LSGMTTime)))
			End If
			scan = scan + 1
		Loop
		
		'=====================================================================
		'Populando a matriz de FATORES para posterior calculo de juros diários
		'=====================================================================
		scan = 0
		Do While scan <= UBound(datas)
			mes =  CStr(Month(CDat(datas(scan))))
			If Len(mes) = 1 Then mes = "0" + mes
			periodo = CStr(Year(CDat(datas(scan)))) + "/" + mes
			fatores(scan) = valoresFatores(ArrayGetIndex(datasFatores, periodo))
			aliqIOF(scan) = fatorIOF(ArrayGetIndex(datasFatores, periodo))
			scan = scan + 1
		Loop 
		
		'para economizar acessos a disco e reduzir a quantidade de índices estou buscando uma técnica para fazer em memória
		'para isto irei copiar o conteúdo do document collection para a array temporária
		
		'==========================================================
		'Populando a matriz SAIDAS com os dados das DESPESAS
		'Como o arraygetindex só pega a primeira ocorrencia do search, copio a ocorrencia encontrada, deleto e tento novamente até acabar com todas.
		'============================================================
		
		maiorSaldo = 0
		scan = 0
		Do While scan <= UBound(datas)
			saida = 0
			entrada = 0
			'Verificando se há valor de saída na data do loop
			If dcDespesas.Count > 0 Then
				Do While Not (IsNull(ArrayGetIndex(  datasDespTmp, CStr(datas(scan))))) 
					resultado = ArrayGetIndex(  datasDespTmp, CStr(datas(scan)))
					'saídas negativas são créditos de impostos que não podem ser consideradas entradas reais de caixa
					'If valoresDespTmp(resultado)> 0 then
					saida = saida + valoresDespTmp(resultado)
					'End if 
					datasDespTmp(resultado) = "99/99/9999"	
				Loop 	
			End If
			'Verificando se há uma "entrada" na data do loop
			If dcReceber.Count > 0 Then		
				Do While Not (IsNull(ArrayGetIndex(  datasRecTmp, CStr(datas(scan))))) 
					resultado = ArrayGetIndex(  datasRecTmp, CStr(datas(scan)))
					entrada  = entrada + valoresRecTmp(resultado)
					datasRecTmp(resultado) = "99/99/9999"
				Loop 			
			End If
			If scan > 0 Then
				saldoInicial = saldosFinais(scan-1) + juros(scan-1) + valorIOF(scan-1)
				saldoFinal = saldoInicial + entrada - saida
				If saldoFinal < 0 Then 
				'esta conta não faz sentido, pois se o projeto fica muito tempo com valor negativo pequeno a média nao faz sentido
				diasContaNegativa = diasContaNegativa + 1
				valorMedioNegativo = valorMedioNegativo + saldoFinal
				End If
			Else
				saldoInicial = 0
				saldoFinal = entrada - saida
			End If
			
			
			'calculando os juros do dia
			If saldoFinal < 0 Then
				osJuros = saldoFinal * (fatores(scan)-1)
				valIOF = saldoFinal * aliqIOF(scan)
			Else
				osJuros = 0
				valIOF = 0
			End If
			
			saldosIniciais(scan) = saldoInicial
			saidas(scan) = saida
			entradas(scan) = entrada
			saldosFinais(scan) = saldoFinal
			juros(scan) = osJuros
			valorIOF(scan) = valIOF
			
			
			totJuros = totJuros + osJuros 
			totIOF = totIOF + valIOF
			
			saida = 0
			entrada = 0
			scan = scan + 1
			
		Loop 
		'=======================================================================================
		'Calcular IOC - sempre que o saldo sair de zero será utilizado o maior valor para colocar 0,0038 de IOC
		'calculando maior saldo para aplicar o IOC que é um imposto único cobrado sobre o maior valor utilizado de empréstimo
		'=======================================================================================
		
		maiorSaldo = 0
		ioc = 0
		ckIOC = 1
		For scan = 0 To UBound(saldosFinais)
			If scan > 0 Then
				If saldosFinais(scan) < 0 Then
					If saldosFinais(scan) < maiorSaldo Then 
						maiorSaldo = saldosFinais(scan)'a comparação é negativa pois a saída é um num negativo
					End If
				ElseIf saldosFinais(scan) > 0 And saldosFinais(scan-1) < 0 Then 'pegar a soma do bloco anterior e multiplicar para IOC
					ioc = ioc + (maiorSaldo * 0.0038)
					'MsgBox(codigo + " - Fechei o bloco " + CStr(ckIOC) + " - Maior Saldo -> " + CStr(maiorSaldo) + " - Saldo Final -> " + CStr(saldosFinais(scan))+ " IOC -> " + CStr(ioc))					
					maiorSaldo = 0
					ckIOC = ckIOC +1					
				End If
			Else
				If saldosFinais(0) < 0 Then maiorSaldo = saldosFinais(0)
			End If
		Next scan
		If ckIOC > 2 Then
			obs = obs + " - mais de um bloco de conta de IOC"
		End If
		
fatorNaoEncontrado: 'para achar os fatores que precisam ser criados
		totIOC = ioc
		Call negocio.ReplaceItemValue("WC_Datas", datas)
		Call negocio.ReplaceItemValue("WC_Saidas", saidas)
		Call negocio.ReplaceItemValue("WC_Entradas", entradas)
		Call negocio.ReplaceItemValue("WC_SaldosIniciais", saldosIniciais)
		Call negocio.ReplaceItemValue("WC_Fatores", fatores)
		Call negocio.ReplaceItemValue("WC_SaldosFinais", saldosFinais)
		Call negocio.ReplaceItemValue("WC_AliqIOFs", aliqIOF)
		Call negocio.ReplaceItemValue("WC_ValorIOFs", valorIOF)
		Call negocio.ReplaceItemValue("WC_Juros", juros )
		Call negocio.ReplaceItemValue("WC_SaldoDoDia",saldosFinais(UBound(datas)))
		GoTo fimDoLoop
		
semDetalhamento: 'vem pra cá se não houver movimentação ou se o limite do campo for excedito 
		Call negocio.ReplaceItemValue("WC_Datas", "")
		Call negocio.ReplaceItemValue("WC_Saidas", 0)
		Call negocio.ReplaceItemValue("WC_Entradas", 0)
		Call negocio.ReplaceItemValue("WC_SaldosIniciais", 0)
		Call negocio.ReplaceItemValue("WC_Fatores", 0)
		Call negocio.ReplaceItemValue("WC_SaldosFinais", 0)
		Call negocio.ReplaceItemValue("WC_AliqIOFs", 0)
		Call negocio.ReplaceItemValue("WC_ValorIOFs", 0)
		Call negocio.ReplaceItemValue("WC_Juros", 0)
		Call negocio.ReplaceItemValue("WC_SaldoDoDia", 0)
fimDoLoop:
		Call negocio.ReplaceItemValue("WC_Obs", obs)
		Call negocio.ReplaceItemValue("WC_TotJuros", totJuros)
		Call negocio.ReplaceItemValue("WC_TotIOF", totIOF)
		Call negocio.ReplaceItemValue("WC_TotIOC", totIOC)
		Call negocio.ReplaceItemValue("WC_Total", totJuros+totIOF+ totIOC)
		Call negocio.ReplaceItemValue("WC_DataInicial", dataInicial)
		Call negocio.ReplaceItemValue("WC_DataFinal", dataFinal)
		Call negocio.ReplaceItemValue("WC_Dias", diasContaNegativa)
		If diasContaNegativa > 0 Then
			Call negocio.ReplaceItemValue("WC_ValorMedio", valorMedioNegativo/diasContaNegativa)
		End If
		Call negocio.Save(True, True)
		Set negocio = negocios.GetNextDocument(negocio)
	Loop
	Exit Sub
	
tratamentoErro:
	If Str(Err) = 4000 Then
		obs = "Limite do campo(32K) excedito" & Chr(10) & obs
		GoTo semDetalhamento
	Else
		Resume Next
	End If
	
End Sub

'++LotusScript Development Environment:2:1:getPedido:1:8
Function getPedido(Texto As String) As String
	
	Dim i As Integer
	Dim Size As Integer
	Texto = Trim( Texto )
	Size = Len ( Texto )
	For i = 1 To Size
		If (Mid( Texto, i, 1 ) = "" Or Mid( Texto, i, 1 ) = "," Or Mid( Texto, i, 1 ) = ";" Or Mid( Texto, i, 1 ) = Chr(10)) And Len(getPedido) > 0 Then Exit For
		If Isnumeric( Mid( Texto, i, 1 ) ) Then
			getPedido = getPedido + Mid( Texto, i, 1 )
		End If
	Next
	
End Function



'++LotusScript Development Environment:2:2:ProjetoContrato:5:8
%REM
	Sub ProjetoContrato
	Description: Comments for Sub
%END REM
Sub ProjetoContrato(negocio As NotesDocument, acao As String)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "servicos.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument, projeto As NotesDocument
	Dim scan As Integer, x As Integer, qtd As Integer
	Dim array As Variant
	Set view = db.GetView("(ContratosProjetosCodigo)")
	Set doc = view.GetDocumentByKey( negocio.Codigo(0), True )
	'Novo Projeto/Contrato
	If doc Is Nothing Then
		Set projeto = New NotesDocument(db)
		If negocio.TipoVenda(0) = "Contrato" Then
			projeto.Form = "Contrato"
		Else	
			projeto.Form = "Projeto"
		End If
		projeto.Id = geraJavaId(projeto)
		projeto.Autor = session.CommonUserName
		projeto.Criacao = CDat(Now)
		projeto.Codigo = negocio.Codigo
		projeto.Descricao = negocio.Descricao(0)
		projeto.DescricaoNegocio = negocio.Descricao(0)
		If InStr(negocio.Sit(0), "Pré-Venda") > 0 Then
			projeto.Sit = "Aguardando Planejamento da Pré-Venda"
			projeto.SitNumero = 1
			projeto.StatusNegocio = "Pré-Venda"
			projeto.ValorEstimado = negocio.ValorEstimado(0)
			projeto.ProbFechamento = negocio.ProbFechamento(0)
			projeto.DataLimitePV = negocio.DataLimitePV(0)
			projeto.RespSolicitacaoPV = negocio.RespSolicitacaoPV(0)
			projeto.SolicitacaoPV = negocio.SolicitacaoPV(0)
			projeto.Obs = negocio.Obs(0)
			projeto.CkPreVenda = negocio.CkPreVenda(0)
		ElseIf InStr(negocio.Sit(0), "POC") > 0 Then
			projeto.Sit = "Aguardando Planejamento do POC"
			projeto.SitNumero = 15
			projeto.StatusNegocio = "POC"
			projeto.ValorEstimadoPOC = negocio.ValorEstimadoPOC(0)
			projeto.ProbFechamentoPOC = negocio.ProbFechamentoPOC(0)
			projeto.DataLimitePOC = negocio.DataLimitePOC(0)
			projeto.RespPOC = negocio.RespSolicitacaoPOC(0)
			projeto.SolicitacaoPOC = negocio.SolicitacaoPOC(0)
			projeto.ObsPOC = negocio.ObsPOC(0)
			projeto.CkConclusaoPOC = negocio.CkConclusaoPOC(0)
		Else
			projeto.Sit = "Aguardando Fechamento"
			projeto.SitNumero = 14
		End If
	Else
		Set projeto = doc
		If acao = "Pré-Venda" Then
			projeto.Sit = "Aguardando Planejamento da Pré-Venda"
			projeto.SitNumero = 1
		ElseIf acao = "POC" Then
			projeto.Sit = "Aguardando Planejamento do POC"
			projeto.SitNumero = 15
		ElseIf acao = "Fechamento" And doc.TipoVenda(0) = "Chamado" Then 'LMO 09/02/22
			Dim wkResumido As String
			wkResumido = WorkflowResumido(negocio.NegocioPrincipal(0))
			If wkResumido = "" Then
				projeto.Sit = "Aguardando Planejamento da Execução"
				projeto.SitNumero = 15
			Else
				If wkResumido = "43" Then
					doc.Sit = "Aguardando Lançamento de Despesas e Horas"
					doc.SitNumero = 43
					'Término da Execução
					doc.DataCheckIn = negocio.DataFechamento(0)
					doc.RespCheckIn = negocio.RespFechamento(0)
					'Conclusão da Documentação e do Aceite do Cliente
					projeto.DataAceite = Now
					projeto.ResponsavelAceite = session.CommonUserName
					projeto.ObservacoesAceite = "Workflow Resumido." 
				Else
					projeto.Sit = "Projeto em Execução"
					projeto.SitNumero = 34
				End If
				'Solicitação da Execução
				doc.ResponsavelSolicitacao = negocio.RespFechamento(0)
				doc.DataLimite = CDat(GetPrazoPlanejamento(2))
				doc.Conclusao = negocio.DataFechamento(0)
				'Planejamento da Execução
				doc.PrevInicio = negocio.DataFechamento(0)
				doc.PrevPrazo = 2
				doc.PrevAgendamento = negocio.DataFechamento(0)
				doc.PrevEntrega = doc.DataLimite(0)
				doc.PrevResponsavel = negocio.RespFechamento(0)
				doc.DataPlanejamento = negocio.DataFechamento(0)
				doc.RespPlanejamento = negocio.RespFechamento(0)
				doc.TecnicoExecucao = negocio.RespFechamento(0)
				doc.ObsPlanejamentoExec = "-> " & Format(doc.DataPlanejamento(0), "dd/mm/yyyy") & " - Workflow Resumido."
				'Início da Execução
				doc.DataCheckOut = negocio.DataFechamento(0)
				doc.Responsavel = negocio.RespFechamento(0)
				doc.RespCheckOut = negocio.RespFechamento(0)
				doc.DataAtualizacao = negocio.DataFechamento(0)
				doc.TecnicoExecucao = negocio.RespFechamento(0)
				doc.PendenciasExec = "-> " & Format(doc.DataCheckOut(0), "dd/mm/yyyy") & " - Workflow Resumido."
			End If
		End If
	End If
	If negocio.Sit(0) = "Perdido" Then
		projeto.Sit = "Perdido"
		projeto.SitNumero = 46
		projeto.ConclusaoPV = negocio.DataPerda(0)
		projeto.DataLimite = negocio.DataPerda(0)
		projeto.Conclusao = negocio.DataPerda(0)
		projeto.Encerramento = negocio.DataPerda(0)
		projeto.RespEncerramento = negocio.ColaboradorPerda(0)
	ElseIf negocio.Sit(0) = "Consolidado" Then
		projeto.Sit = "Consolidado"
		projeto.SitNumero = 47
		projeto.ConclusaoPV = negocio.DataPerda(0)
		projeto.DataLimite = negocio.DataPerda(0)
		projeto.Conclusao = negocio.DataPerda(0)
		projeto.Encerramento = negocio.DataPerda(0)
		projeto.RespEncerramento = negocio.ColaboradorPerda(0)
	ElseIf negocio.Sit(0) = "Postergado" Then
		projeto.Sit = "Postergado"
		projeto.SitNumero = 48
		projeto.ConclusaoPV = negocio.DataPerda(0)
		projeto.DataLimite = negocio.DataPerda(0)
		projeto.Conclusao = negocio.DataPerda(0)
		projeto.Encerramento = negocio.DataPerda(0)
		projeto.RespEncerramento = negocio.ColaboradorPerda(0)
	ElseIf negocio.Sit(0) = "Aguardando Análise da Perda" Then
		projeto.Sit = "Aguardando Análise da Perda"
		projeto.SitNumero = 45
		projeto.ConclusaoPV = negocio.DataPerda(0)
		projeto.DataLimite = negocio.DataPerda(0)
		projeto.Conclusao = negocio.DataPerda(0)
		projeto.Encerramento = negocio.DataPerda(0)
		projeto.RespEncerramento = negocio.ColaboradorPerda(0)
	ElseIf negocio.Sit(0) = "Forecast" Or negocio.Sit(0) = "Prospect" Then
		projeto.Sit = "Aguardando Fechamento"
		projeto.SitNumero = 14
	ElseIf negocio.Sit(0) = "Contrato" Then
		If projeto.Form(0) = "Contrato" Then
			projeto.Sit = "Ativo"
			projeto.SitNumero = 0
		ElseIf projeto.Form(0) = "Projeto" Then
			projeto.Sit = "Concluído"
			projeto.SitNumero = 44
			projeto.ConclusaoPV = negocio.DataFechamento(0)
			projeto.DataLimite = negocio.DataFechamento(0)
			projeto.Conclusao = negocio.DataFechamento(0)
			projeto.Encerramento = negocio.DataFechamento(0)
			projeto.RespEncerramento = negocio.RespFechamento(0)
		End If
	End If
	projeto.StatusNegocio = negocio.Sit(0)
	projeto.TipoVenda = negocio.TipoVenda(0)
	If acao = "Pré-Venda" Then
		projeto.ValorEstimado = negocio.ValorEstimado(0)
		projeto.ProbFechamento = negocio.ProbFechamento(0)
		projeto.DataLimitePV = negocio.DataLimitePV(0)
		projeto.RespSolicitacaoPV = negocio.RespSolicitacaoPV(0)
		projeto.SolicitacaoPV = negocio.SolicitacaoPV(0)
		projeto.Obs = negocio.Obs(0)
		projeto.CkPreVenda = negocio.CkPreVenda(0)
	ElseIf acao = "POC" Then
		projeto.ValorEstimadoPOC = negocio.ValorEstimadoPOC(0)
		projeto.ProbFechamentoPOC = negocio.ProbFechamentoPOC(0)
		projeto.DataLimitePOC = negocio.DataLimitePOC(0)
		projeto.RespPOC = negocio.RespSolicitacaoPOC(0)
		projeto.SolicitacaoPOC = negocio.SolicitacaoPOC(0)
		projeto.ObsPOC = negocio.ObsPOC(0)
		projeto.CkConclusaoPOC = negocio.CkConclusaoPOC(0)
	ElseIf acao = "Atualiza" Or acao = "Fechamento" Then
		If CStr(negocio.ValorEstimado(0)) <> "" Then
			projeto.ValorEstimado = CDbl(negocio.ValorEstimado(0))
			projeto.ProbFechamento = negocio.ProbFechamento(0)
		End If
		'Controle de Execução
		If Fechado(negocio.Sit(0)) Then
			projeto.DataFechamento = negocio.DataFechamento(0)
			projeto.RespFechamento = negocio.RespFechamento(0)
		End If
	End If
	projeto.Cliente = negocio.Cliente(0)
	projeto.CodCliente = negocio.CodCliente(0)
	projeto.CodigoGrupoEconomico = negocio.CodigoGrupoEconomico(0)
	projeto.CodClienteFaturamento = negocio.CodClienteFaturamento(0)
	projeto.UF = negocio.UF(0)
	If negocio.AreaVendas(0) = "" Then projeto.AreaVendas = "Revenda" Else projeto.AreaVendas = negocio.AreaVendas(0)
	If negocio.Area(0) = "" Then projeto.Area = negocio.AreaVendas(0) Else projeto.Area = negocio.Area(0)
	projeto.DescricaoNegocio = negocio.Descricao(0)
	projeto.Parceria = negocio.Parceria(0)
	projeto.GerenciamentoProjeto = negocio.GerenciamentoProjeto(0)
	projeto.DescricaoGerenciamentoProjeto = negocio.DescricaoGerenciamentoProjeto(0)
	projeto.GerenteConta = negocio.GerenteConta(0)
	projeto.Inside = negocio.Inside
	projeto.ContatoComercial = negocio.ContatoComercial(0)
	projeto.eMailComercial = negocio.eMailComercial(0)
	projeto.ContatoTecnico = negocio.ContatoTecnico(0)
	projeto.eMailTecnico = negocio.eMailTecnico(0)
	'Despesas de Vendas
	Dim frete As Double, intermediacao As Double
	If CStr(negocio.Frete(0)) <> "" Then frete = negocio.Frete(0)
	If CStr(negocio.Intermediacao(0)) <> "" Then intermediacao = negocio.Intermediacao(0)
	Dim freteQtd As Integer, intermediacaoQtd As Integer
	If frete > 0 Then freteQtd = 1
	If intermediacao > 0 Then intermediacaoQtd = 1
	projeto.FreteQtd = freteQtd
	projeto.Frete = frete
	projeto.FreteP = frete
	projeto.IntermediacaoQtd = intermediacaoQtd
	projeto.Intermediacao = intermediacao
	projeto.IntermediacaoP = intermediacao
	projeto.VendasP = frete + intermediacao
	'Projeto/Chmado/Venda Simples
	If negocio.TipoVenda(0) <> "Contrato" Then
		'Lista de Materiais
		For scan = 0 To 49
			array = negocio.Getitemvalue("Q_" & scan)
			Call projeto.ReplaceItemValue("QM_" & scan, array(0))
			array = negocio.Getitemvalue("PartNo_" & scan)
			Call projeto.ReplaceItemValue("PartNoM_" & scan, array(0))
			array = negocio.Getitemvalue("Produto_" & scan)
			Call projeto.ReplaceItemValue("ProdutoM_" & scan, array(0))
			array = negocio.Getitemvalue("Un_" & scan)
			Call projeto.ReplaceItemValue("UnM_" & scan, array(0))
			array = negocio.Getitemvalue("us_" & scan)
			Call projeto.ReplaceItemValue("usM_" & scan, array(0))
			array = negocio.Getitemvalue("Custo_" & scan)
			Call projeto.ReplaceItemValue("CustoM_" & scan, array(0))
			array = negocio.Getitemvalue("Mg_" & scan)
			Call projeto.ReplaceItemValue("MgM_" & scan, array(0))
			array = negocio.Getitemvalue("CustoUnit_" & scan)
			Call projeto.ReplaceItemValue("CustoUnitM_" & scan, array(0))
			array = negocio.Getitemvalue("CusTot_" & scan)
			Call projeto.ReplaceItemValue("CusTotM_" & scan, array(0))
			array = negocio.Getitemvalue("t_" & scan)
			Call projeto.ReplaceItemValue("tM_" & scan, array(0))
			array = negocio.Getitemvalue("IC_" & scan)
			Call projeto.ReplaceItemValue("ICM_" & scan, array(0))
			array = negocio.Getitemvalue("IP_" & scan)
			Call projeto.ReplaceItemValue("IPM_" & scan, array(0))
		Next
		projeto.TotMateriaisM = negocio.TotMateriais(0)
		'Lista de Serviços
		If negocio.TipoVenda(0) = "Venda Simples" Then
			For scan = 0 To 11
				Call projeto.ReplaceItemValue("Qs_" & scan, "")
				Call projeto.ReplaceItemValue("PartNos_" & scan, "")
				Call projeto.ReplaceItemValue("Produtos_" & scan, "")
				Call projeto.ReplaceItemValue("RateioCusto_" & scan, "")
				Call projeto.ReplaceItemValue("Custos_" & scan, "")
				Call projeto.ReplaceItemValue("RateioTerceiros_" & scan, "")
				Call projeto.ReplaceItemValue("Terceiros_" & scan, "")
				Call projeto.ReplaceItemValue("RateioDespesas_" & scan, "")
				Call projeto.ReplaceItemValue("Despesas_" & scan, "")
				Call projeto.ReplaceItemValue("CPS_" & scan, "")
			Next
		End If
	End If
	projeto.TotServicos = negocio.TotServicos(0)
	projeto.TotalNegocio = negocio.TotalNegocio(0)
	projeto.SaldoFaturamento = negocio.SaldoFaturamento(0)
	projeto.SaldoServicos = negocio.SaldoServicos(0)
	projeto.Resultado_P = negocio.Resultado_P(0)
	'*** Matriz de Tarifação ***
	If negocio.TipoVenda(0) = "Contrato" Then
		'Condições Comerciais
		projeto.DataInicial = negocio.DataInicial
		projeto.DataFinal = negocio.DataFinal
		projeto.TipoPagamento = negocio.TipoPagamento
		projeto.DiaFaturamento = negocio.DiaFaturamento
		projeto.DataReajuste = negocio.DataReajuste
		If CStr(negocio.IndiceReajuste(0)) = "" Then
			projeto.IndiceReajuste = "IGPM"
		Else
			projeto.IndiceReajuste = negocio.IndiceReajuste
		End If
		For scan = 0 To 9
			If CStr(negocio.GetItemValue("CQs_" & scan)(0)) <> "" Then qtd = negocio.GetItemValue("CQs_" & scan)(0) Else qtd = 1
			Call projeto.Replaceitemvalue("CQs_" & scan, negocio.GetItemValue("CQs_" & scan)(0))
			Call projeto.Replaceitemvalue("CPartNo_" & scan, negocio.GetItemValue("CPartNo_" & scan)(0))
			Call projeto.Replaceitemvalue("CProdutos_" & scan, negocio.GetItemValue("CProdutos_" & scan)(0))
			Call projeto.Replaceitemvalue("CNBS_" & scan, negocio.GetItemValue("CNBS_" & scan)(0))
			Call projeto.Replaceitemvalue("CTipo_" & scan, negocio.GetItemValue("CTipo_" & scan)(0))
			Call projeto.Replaceitemvalue("CArea_" & scan, negocio.GetItemValue("CArea_" & scan)(0))
			Call projeto.Replaceitemvalue("CRateioCusto_" & scan, negocio.GetItemValue("CRateioCusto_" & scan)(0))
			If negocio.GetItemValue("CProdutos_" & scan)(0) <> "" Then
				Call projeto.Replaceitemvalue("CCusto_" & scan, negocio.GetItemValue("CCusto_" & scan)(0) * qtd)
				Call projeto.Replaceitemvalue("CTerceiros_" & scan, negocio.GetItemValue("CTerceiros_" & scan)(0) * qtd)
				Call projeto.Replaceitemvalue("CCusTots_" & scan, negocio.GetItemValue("CCusTots_" & scan)(0) * qtd)
			Else
				Call projeto.Replaceitemvalue("CCusto_" & scan, negocio.GetItemValue("CCusto_" & scan)(0))
				Call projeto.Replaceitemvalue("CTerceiros_" & scan, negocio.GetItemValue("CTerceiros_" & scan)(0))
				Call projeto.Replaceitemvalue("CCusTots_" & scan, negocio.GetItemValue("CCusTots_" & scan)(0))
			End If
			Call projeto.Replaceitemvalue("CCustoT_" & scan, negocio.GetItemValue("CCustoT_" & scan)(0))
			Call projeto.Replaceitemvalue("CTerceirosT_" & scan, negocio.GetItemValue("CTerceirosT_" & scan)(0))
			Call projeto.Replaceitemvalue("CCusTotsT_" & scan, negocio.GetItemValue("CCusTotsT_" & scan)(0))
			Call projeto.Replaceitemvalue("CMg_" & scan, negocio.GetItemValue("CMg_" & scan)(0))
			Call projeto.Replaceitemvalue("CRIR_" & scan, negocio.GetItemValue("CRIR_" & scan)(0))
			Call projeto.Replaceitemvalue("CRIN_" & scan, negocio.GetItemValue("CRIN_" & scan)(0))
			Call projeto.Replaceitemvalue("CISS_" & scan, negocio.GetItemValue("CISS_" & scan)(0))
		Next
		projeto.CustoC = negocio.CustoC
		projeto.TerceirosC = negocio.TerceirosC
		projeto.TotContrato = negocio.TotContrato
		projeto.Valor = negocio.Valor
	End If
	%REM
	'Tipo de Atendimento
	projeto.TpHora = negocio.TpHora
	projeto.FtHora = negocio.FtHora
	projeto.PtHora = negocio.PtHora
	projeto.UnidadeMT = negocio.UnidadeMT
	projeto.ValorMT = negocio.ValorMT
	projeto.UtilizadoMT = negocio.UtilizadoMT
	projeto.SaldoMT = negocio.SaldoMT
	projeto.PeriodoMT = negocio.PeriodoMT
	projeto.SLA_A = negocio.SLA_A
	projeto.SLA_D = negocio.SLA_D
	projeto.SLA_S = negocio.SLA_S
	'Faixa de Atendimento
	projeto.TabelaHora = negocio.TabelaHora
	projeto.ValorHora = negocio.ValorHora
	projeto.FaixaSemana = negocio.FaixaSemana
	projeto.FaixaSabado = negocio.FaixaSabado
	projeto.FaixaDomingo = negocio.FaixaDomingo
	projeto.DescrHora = negocio.DescrHora
	projeto.DescrHoraS = negocio.DescrHoraS
	projeto.DescrHoraD = negocio.DescrHoraD
	projeto.PesoCus = negocio.PesoCus
	projeto.PesoCusS = negocio.PesoCusS
	projeto.PesoCusD = negocio.PesoCusD
	projeto.PesoFat = negocio.PesoFat
	projeto.PesoFatS = negocio.PesoFatS
	projeto.PesoFatD = negocio.PesoFatD
	projeto.Alim = negocio.Alim
	projeto.AlimS = negocio.AlimS
	projeto.AlimD = negocio.AlimD
	projeto.Trans = negocio.Trans
	projeto.TransS = negocio.TransS
	projeto.TransD = negocio.TransD
	%END REM
	'***
	'Campos de Controle das Despesas
	projeto.AreaDespesa = negocio.AreaDespesa(0)
	projeto.ResponsavelDespesa = negocio.ResponsavelDespesa(0)
	projeto.TipoVenda = negocio.TipoVenda(0)
	projeto.ClassificacaoDespesa = "CPS"
	projeto.Areas = negocio.Areas
	projeto.Overhead = negocio.Overhead
	'Campos do Forecast - LMO 08/10/18
	projeto.Temperatura = negocio.Temperatura(0)
	projeto.DataForecast = negocio.DataForecast(0)
	'Controle de Adendos - LMO 15/10/18
	projeto.CodEmpresa = negocio.CodEmpresa(0)
	projeto.Classe = negocio.Classe(0)
	projeto.TipoAdendo = negocio.TipoAdendo(0)
	projeto.NegocioPrincipal = negocio.NegocioPrincipal(0)
	projeto.Grupo = negocio.Grupo(0)
	If Fechado(negocio.Sit(0)) Then
		Call StatusProjeto(projeto)
	End If
	'Atualiza Status do Projeto/Contrato no Negócio
	negocio.StatusProjeto = projeto.Sit(0)
	'Responsável da Pré-Venda, POC, Execução e Logística - LMO 16/05/24
	projeto.ResponsavelSolicitacaoPV = negocio.TecnicoResponsavel(0)
	projeto.ResponsavelSolicitacaoPOC = negocio.TecnicoPOC(0)
	projeto.ResponsavelSolicitacao = negocio.TecnicoExecucao(0)
	projeto.ResponsavelLogistica = negocio.ResponsavelLogistica(0)
	'Envia Email
	If acao = "Pré-Venda" Then
		'projeto.ResponsavelSolicitacaoPV = negocio.TecnicoResponsavel(0)
		Call AvisoSolicita(projeto, "PV")
	ElseIf acao = "POC" Then
		'projeto.ResponsavelSolicitacaoPOC = negocio.TecnicoPOC(0)
		Call AvisoSolicita(projeto, "POC")
	End If
	'Prazo Limite do Projeto
	projeto.PrazoLimiteProjeto = negocio.PrazoLimiteProjeto(0)
	'Cria/Atualiza Planilha Financeira
	Call PlanilhaFinanceira(projeto)
	Call projeto.ComputeWithForm(False, False)
	Call projeto.Save(False, False)
	If acao = "Fechamento" Or acao = "Desfechamento" Then
		'Salva Lista CPS no db Listas
		Call SaveListaMateriais(projeto)
		'Cria/Atualiza Cotação da Lista CPS no Sistema de Compras
		Call Cotacao(projeto)
	End If
	
End Sub

'++LotusScript Development Environment:2:2:AtualizaPrevisaoEntrega:5:8
%REM
	Sub AtualizaPrevisaoEntrega
	Description: Comments for Sub
%END REM
Sub AtualizaPrevisaoEntrega(negocio As NotesDocument)
	
	On Error Resume Next
	Dim db As New NotesDatabase(negocio.ParentDatabase.Server, "listas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim scan As Integer
	Dim item As NotesItem
	Set view = db.GetView("(NegocioNItens)")
	For scan = 0 To 49
		Set doc = view.getDocumentByKey( negocio.Codigo(0) & "-" & (scan + 1), True )
		If Not doc Is Nothing Then
			Set item = negocio.ReplaceItemValue("DataE_" & scan, doc.PrazoEntrega(0))
		Else
			Set item = negocio.ReplaceItemValue("DataE_" & scan, "")
		End If
	Next
	
End Sub

'++LotusScript Development Environment:2:2:NotOnLine:1:8
Sub NotOnLine(uidoc As NotesUiDocument)
	
	'Retira o flag de ativo dos Negocios que estão em uso
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Set db = uidoc.Document.ParentDatabase
	Dim view As NotesView
	Set view = db.getView("(WhoIsOnLine)")
	Dim doc As NotesDocument
	Set doc = view.getDocumentByKey(uidoc.Document.Codigo(0), True)
	If Not (doc Is Nothing) Then
		If uidoc.EditMode Or doc.Responsavel(0) = session.UserName Then
			doc.Sit = "Inativo"
			doc.Saida = Now
			Call doc.Save(True, True)		
		End If
	End If
	
End Sub

'++LotusScript Development Environment:2:1:CkCliente:5:8
%REM
	Function CkCliente
	Description: Comments for Function
%END REM
Function CkCliente(codCliente As String) As Boolean
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "empresas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Set view = db.Getview("(EmpresasAtivas)")
	Set doc = view.Getdocumentbykey(codCliente, True)
	If Not doc Is Nothing Then
		If doc.Status(0) = "Ativa" Then
			CkCliente = True
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:AvisoNovoNegocio:1:8
Sub AvisoNovoNegocio(uidoc As NotesUIDocument)
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim richStyle As NotesRichTextStyle
	Dim recipients(1) As String
	Set db = session.CurrentDatabase
	Set richStyle = session.CreateRichTextStyle
	richStyle.NotesFont = FONT_ROMAN
	richStyle.FontSize = 10
	Dim memo As New NotesDocument( db )
	memo.Form = "Memo"
	recipients(0) = "Marcelo Castro/TDec"
	recipients(1) = "Junior Castro/TDec"
	memo.SendTo = recipients
	recipients(0) = uidoc.Document.GerenteConta(0) & "/TDec"
	recipients(1) = uidoc.Document.Inside(0) & "/TDec"
	memo.CopyTo = recipients
	'memo.BlindCopyTo = "Ludimila Oliveira/TDec"
	Dim corpo As New NotesRichTextItem( memo , "Body" )   
	Call corpo.AppendStyle(richStyle)
	If uidoc.Fieldgettext("Renovacao") = "Sim" Then
		memo.Subject = "-> Renovação - Negócio: " & uidoc.Document.Codigo(0) & " (" & uidoc.Document.Descricao(0) & ")"
		Call corpo.Appendtext( "Renovação " & uidoc.Document.Codigo(0) & " criada no Sale Force." )   
	Else
		memo.Subject = "-> Novo " & uidoc.Document.TipoNegocio(0) & ": " & uidoc.Document.Codigo(0) & " (" & uidoc.Document.Descricao(0) & ")"
		Call corpo.Appendtext( uidoc.Document.TipoNegocio(0) & " " & uidoc.Document.Codigo(0) & " criado no Sale Force." )   
	End If
	Call corpo.AddNewLine( 2 )
	Call corpo.Appendtext( "Descrição: " & uidoc.Document.Descricao(0) )   
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "Tipo: " & uidoc.document.TipoVenda(0) )
	If uidoc.document.TipoVenda(0) = "Projeto" Or uidoc.document.TipoVenda(0) = "Chamado" Then
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Área: " & uidoc.document.Area(0) )
	End If
	If uidoc.document.Parceria(0) <> "" Then
		Call corpo.AddNewLine( 1 )
		Call corpo.Appendtext( "Parceria: " & uidoc.document.Parceria(0) )
	End If
	Call corpo.AddNewLine( 2 ) 
	Call corpo.Appendtext( "Negócio: " )   
	Call corpo.AppendDocLink( uidoc.Document, "Link para o Negócio" )
	Call corpo.AddNewLine( 2 )
	Call corpo.Appendtext( session.CommonUserName & "," )
	Call corpo.AddNewLine( 1 )
	Call corpo.Appendtext( "TDec Network Group" )
	Call memo.Send(False)
	
End Sub

'++LotusScript Development Environment:2:1:CheckItensListaCPS:5:8
%REM
	Function CheckItensListaCPS
	Description: Comments for Function
%END REM
Function CheckItensListaCPS(uidoc As NotesUiDocument) As Boolean
	
	CheckItensListaCPS = True
	If uidoc.Fieldgettext("TipoVenda") = "Projeto" Or uidoc.Fieldgettext("TipoVenda") = "Chamado" Then
		Dim db As New NotesDatabase(uidoc.Document.Parentdatabase.Server, "servicos.nsf")
		Dim view As NotesView
		Dim doc As NotesDocument
		Set view = db.GetView("(ProjetosCodigo)")
		Set doc = view.Getdocumentbykey(uidoc.FieldGetText("Codigo"), True)
		If doc Is Nothing Then
			MsgBox "Projeto não encontrado na base de Serviços.", 16, "Erro no Fechamento do Negócio"
			CheckItensListaCPS = False
			Exit function
		End If
		'Verifica dados relevantes da Lista CPS
		Dim array As Variant
		Dim qtd As Long, partN As String, produto As String, un As String, ufCompra As String, custoFOB As Double, fi As Double, custo As Double, mg As Double, venda As Double, icmsst As Double
		Dim scan As Integer, scan2 As Integer, item As String
		'1.Quantidade, PartNo, Produto, Unidade de Medida e UF de Compra
		For scan = 0 To 49
			produto = doc.Getitemvalue("Produto_" & scan)(0)
			qtd = Val(doc.Getitemvalue("Q_" & scan)(0))
			If produto <> "" Or qtd <> 0 Then
				partN = doc.Getitemvalue("PartNo_" & scan)(0)
				un = doc.Getitemvalue("Un_" & scan)(0)
				ufCompra = doc.Getitemvalue("UFCompra_" & scan)(0)
				If partN = "" Or produto = "" Or un = "" Or ufCompra = "" Then
					CheckItensListaCPS = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "Você precisa informar a Quantidade, PartNo, Produto, Unidade de Medida e UF de Compra na Lista CPS no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Projeto/Cotação Financeira.", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'2.Código da Situação Tributária de Compra (Branco, Tamanho, Origem, Situação Tributária)
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("ST_" & scan)
				If array(0) = "" Or Len(array(0)) <> 3 Or _
				(Left(array(0), 1) <> "0" And Left(array(0), 1) <> "1" And Left(array(0), 1) <> "2" And Left(array(0), 1) <> "3" And Left(array(0), 1) <> "4" And Left(array(0), 1) <> "5" And Left(array(0), 1) <> "6" And Left(array(0), 1) <> "7" And Left(array(0), 1) <> "8") Or _
				(Right(array(0), 2) <> "00" And Right(array(0), 2) <> "10" And Right(array(0), 2) <> "20" And Right(array(0), 2) <> "30" And Right(array(0), 2) <> "40" And Right(array(0), 2) <> "41" And Right(array(0), 2) <> "50" And Right(array(0), 2) <> "51" And Right(array(0), 2) <> "60" And Right(array(0), 2) <> "70" And Right(array(0), 2) <> "90") Then
					CheckItensListaCPS = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "Código da Situação Tributária de Compra Inválido no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Projeto/Cotação Financeira." & Chr(10) & "Não pode estar em Branco." & Chr(10) & "Precisa ter 3 caracteres." & Chr(10) & "Primeiro caracter: 0, 1, 2, 3, 4, 5, 6, 7 ou 8." & Chr(10) & "Dois últimos caracteres: 00, 10, 20, 30, 40, 41, 50, 51, 60, 70 ou 90.", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'3.Custo/Mg/CustoUnit
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("Custo_" & scan)
				If CStr(array(0)) = "" Then custo = 0 Else custo = array(0)
				array = doc.Getitemvalue("Mg_" & scan)
				If CStr(array(0)) = "" Then mg = 0 Else mg = array(0)
				array = doc.Getitemvalue("CustoUnit_" & scan)
				If CStr(array(0)) = "" Then venda = 0 Else venda = array(0)
				If custo = 0 Or mg = 0 Or venda = 0 Then
					CheckItensListaCPS = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "Você precisa completar todos os dados da Lista CPS no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Projeto.", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'Mg Inferior a 15% (Não cobre os Impostos)
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("Mg_" & scan)
				If CStr(array(0)) = "" Then mg = 0 Else mg = array(0)
				If mg > 0.85 Then
					CheckItensListaCPS = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "A Margem não pode ser maior que 0,85 na Lista CPS no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Projeto.", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'4.CustoFOB/FI
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("CustoFOB_" & scan)
				If CStr(array(0)) = "" Then custoFOB = 0 Else custoFOB = array(0)
				array = doc.Getitemvalue("FI_" & scan)
				If CStr(array(0)) = "" Then fi = 0 Else fi = array(0)
				If custoFOB <> 0 And fi = 0 Or custoFOB = 0 And fi <> 0 Then
					CheckItensListaCPS = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "Você precisa completar os dados da Importação TDec na Lista CPS no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Projeto/Cotação Financeira.", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'5.ICMS de Compra (Branco)
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("T_" & scan)
				If array(0) = "HW" Then
					array = doc.Getitemvalue("ICC_" & scan)
					If CStr(array(0)) = "" Then
						CheckItensListaCPS = False
						If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
						scan2 = scan2 + 1
					End If
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "O ICMS de Compra não pode estar em Branco. Solicite a Atualização da Carga Tributária a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'6.Protocolo de Compra (Inexistente ou Desatualizado)
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("T_" & scan)
				If array(0) = "HW" Then
					array = doc.Getitemvalue("ICC_" & scan)
					If CStr(array(0)) = "?" Then
						CheckItensListaCPS = False
						If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
						scan2 = scan2 + 1
					End If
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "Solicitar a Consulta do Protocolo de Compra Contribuinte a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'7.ICMS de Compra (Zero)
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("T_" & scan)
				If array(0) = "HW" Then
					array = doc.Getitemvalue("UFCompra_" & scan)
					If array(0) <> "SP" And array(0) <> "EX" Then
						array = doc.Getitemvalue("ST_" & scan)
						If Right(array(0), 2) = "10" Then
							array = doc.Getitemvalue("ICC_" & scan)
							If CDbl(array(0)) = 0 Then
								CheckItensListaCPS = False
								If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
								scan2 = scan2 + 1
							End If
						End If	
					End If
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "A alíquota do ICMS de Compra não pode ser zero. Solicite a Atualização da Carga Tributária a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'8.ICMS de Compra (Maior que 100%)
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("T_" & scan)
				If array(0) = "HW" Then
					array = doc.Getitemvalue("ICC_" & scan)
					If CDbl(array(0)) > 1 Then
						CheckItensListaCPS = False
						If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
						scan2 = scan2 + 1
					End If
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "A alíquota do ICMS de Compra não pode ser maior que 100% no(s) Item(s) " & item & "." & Chr(10) & "Solicite a Atualização da Carga Tributária a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'9.II na Importação TDec (Não pode ser zero)
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("T_" & scan)
				If array(0) = "HW" Then
					array = doc.Getitemvalue("CustoFOB_" & scan)
					If CStr(array(0)) = "" Then custoFOB = 0 Else custoFOB = array(0)
					array = doc.Getitemvalue("FI_" & scan)
					If CStr(array(0)) = "" Then fi = 0 Else fi = array(0)
					If custoFOB <> 0 And fi <> 0 Then
						array = doc.Getitemvalue("II_" & scan)
						If CStr(array(0)) = "" Then
							CheckItensListaCPS = False
							If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
							scan2 = scan2 + 1
						End If
					End If
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "A alíquota do II não pode estar em branco na Importação TDec(FOB e FI preenchidos) no(s) Item(s) " & item & "." & Chr(10) & "Solicite a Atualização da Carga Tributária a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'10.ICMSST de Compra do Fornecedor (Branco ou Zero)
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("T_" & scan)
				If array(0) = "HW" Then
					array = doc.Getitemvalue("ST_" & scan)
					If Right(array(0), 2) = "10" Then
						array = doc.Getitemvalue("ICMSSTC_" & scan)
						If CStr(array(0)) = "" Then icmsst = 0 Else icmsst = array(0)
						If icmsst = 0 Then
							CheckItensListaCPS = False
							If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
							scan2 = scan2 + 1
						End If
					End If	
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "O ICMS-ST de Compra não pode ser branco nem zero no(s) Item(s) " & item & "." & Chr(10) & "Corrija no Projeto/Cotação Financeira.", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
		'11.ICMS Outros Estados (Branco ou Zero)
		For scan = 0 To 49
			array = doc.Getitemvalue("Produto_" & scan)
			produto = array(0)
			array = doc.Getitemvalue("Q_" & scan)
			qtd = Val(array(0))
			If produto <> "" Or qtd <> 0 Then
				array = doc.Getitemvalue("T_" & scan)
				If array(0) = "HW" Then
					array = doc.Getitemvalue("UFCompra_" & scan)
					If array(0) <> "SP" And array(0) <> "EX" Then
						array = doc.Getitemvalue("ST_" & scan)
						If Right(array(0), 2) = "10" Then
							array = doc.Getitemvalue("ICMSSTC_" & scan)
							If CStr(array(0)) = "" Then icmsst = 0 Else icmsst = array(0)
							If icmsst = 0 Then
								CheckItensListaCPS = False
								If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
								scan2 = scan2 + 1
							End If
						End If
					End If
				End If
			End If
		Next
		If Not CheckItensListaCPS Then
			MsgBox "Solicitar a Consulta de Protocolo da UF de Compra a nossa Área Contábil/Fiscal no(s) Item(s) " & item & ".", 16, "Erro na Lista CPS do Projeto"
			Exit Function
		End If
	End If
		
End Function

'++LotusScript Development Environment:2:1:CalcINSSRF:1:8
Function CalcINSSRF(doc As NotesDocument) As Double
	'As consistências de todos os serviços possuem a mesma alíquota de retenção já foi realizada na geração da Nota Fiscal
	
	If doc.Tipo(0) = "Serviços" Or doc.Tipo(0) = "Software" Then
		CalcINSSRF# = doc.TotalServicos(0) * aliquota(5)
	Else
		CalcINSSRF# = 0
	End If
	
End Function

'++LotusScript Development Environment:2:1:CalcTotalMercadorias:1:8
Function CalcTotalMercadorias(doc As NotesDocument) As Double
	
	'Calcula Total de Produtos
	Dim scan As Integer, array As Variant, totmerc As Double
	Dim cusTot As Double
	For scan = 0 To 49
		If doc.CodNatureza(0) = "6.108" Then
			array = doc.GetItemValue("CusTotcomICMSST_" & scan)
		Else
			array = doc.GetItemValue("CusTot_" & scan)
		End If
		If CStr(array(0)) = "" Then cusTot = 0 Else cusTot = array(0)
		totmerc = totmerc + Round(cusTot, 2)
	Next
	CalcTotalMercadorias# = totmerc
	
End Function

'++LotusScript Development Environment:2:1:CheckItensListaServicos:5:8
%REM
	Function CheckItensListaServicos
	Description: Comments for Function
%END REM
Function CheckItensListaServicos(ui As NotesUIDocument) As Boolean
	
	CheckItensListaServicos = True
	Dim scan As Integer, scan2 As Integer, item As String
	'Lista de Serviços
	If ui.FieldGetText("TipoVenda") <> "Venda Simples" And ui.Fieldgettext("Form") <> "Requisicao" Then
		'1.Custos/Mgs/CustoUnits/Produtos
		For scan = 0 To 11
			If ui.FieldGetText("Produtos_" & scan) <> "" Or Val(ui.FieldGetText("Qs_" & scan)) > 0 Then
				If ui.FieldGetText("Custos_" & scan) = "" Or ui.FieldGetText("Mgs_" & (scan)) = "" Or ui.FieldGetText("CustoUnits_" & scan) = "" Or ui.FieldGetText("Produtos_" & scan) = "" Then
					CheckItensListaServicos = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensListaServicos Then
			MsgBox "Você precisa completar todos os dados da Lista de Serviços. Corrija no Negócio." & Chr(10) & "Item(s): " & item & ".", 16, "Erro de Preenchimento na Lista de Serviços"
			Call ui.GotoField("Mgs_0")
			Exit Function
		End If
		'2.IRRF (Branco)
		For scan = 0 To 11
			If ui.FieldGetText("Produtos_" & scan) <> "" Or Val(ui.FieldGetText("Qs_" & scan)) > 0 Then
				If ui.FieldGetText("RIR_" & scan) = "" Then
					CheckItensListaServicos = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensListaServicos Then
			MsgBox "Retenção do IRRF inválida. Solicite atualização da Carga Tributária ao Financeiro." & Chr(10) & "Item(s): " & item & ".", 16, "Erro na Lista de Serviços"
			Exit Function
		End If
		'3.INSS (Branco)
		For scan = 0 To 11
			If ui.FieldGetText("Produtos_" & scan) <> "" Or Val(ui.FieldGetText("Qs_" & scan)) > 0 Then
				If ui.FieldGetText("RIN_" & scan) = "" Then
					CheckItensListaServicos = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensListaServicos Then
			MsgBox "Retenção do INSS inválida. Solicite atualização da Carga Tributária ao Financeiro." & Chr(10) & "Item(s): " & item & ".", 16, "Erro na Lista de Serviços"
			Exit Function
		End If
		'4.ISS (Branco)
		For scan = 0 To 11
			If ui.FieldGetText("Produtos_" & scan) <> "" Or Val(ui.FieldGetText("Qs_" & scan)) > 0 Then
				If ui.FieldGetText("ISS_" & scan) = "" Then
					CheckItensListaServicos = False
					If scan2 = 0 Then item = CStr(scan + 1) Else item = item & ", " & (scan + 1)
					scan2 = scan2 + 1
				End If
			End If
		Next
		If Not CheckItensListaServicos Then
			MsgBox "Alíquota do ISS inválida. Solicite atualização da Carga Tributária ao Financeiro." & Chr(10) & "Item(s): " & item & ".", 16, "Erro na Lista de Serviços"
			Exit Function
		End If
	End If
	
End Function

'++LotusScript Development Environment:2:2:BuscaRegrasFiscais:1:8
Sub BuscaRegrasFiscais(negocio As NotesDocument)
	
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.CurrentDatabase.Server, "faturas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim key(1) As String
	key(0) = negocio.RegrasFiscais(0)
	key(1) = negocio.CodEmpresa(0)
	Set view = db.GetView("(RegrasFiscais)")
	Set doc = view.GetDocumentByKey(key, True)
	If Not doc Is Nothing Then
		aliquota(0) = doc.Pis(0)
		aliquota(1) = doc.Cofins(0)
		aliquota(2) = doc.CPMF(0)
		aliquota(3) = doc.Iss(0)
		aliquota(4) = doc.IRRF(0)
		aliquota(5) = doc.INSSRF(0)
		aliquota(6) = doc.IFPis(0)
		aliquota(7) = doc.IFCofins(0)
		aliquota(8) = doc.IFCSLL(0)
		aliquota(9) = doc.CSLLV(0)
		aliquota(10) = doc.IRV(0)
		If doc.Regime(0) = "Lucro Presumido" Then aliquota(11) = 1
		aliquota(12) = doc.IssSw(0)
		aliquota(13) = doc.CPR(0)
		aliquota(14) = doc.IRImportacao(0)
		aliquota(15) = doc.PISImportacao(0)
		aliquota(16) = doc.COFINSImportacao(0)
	End If
	
End Sub

'++LotusScript Development Environment:2:1:BuscaCatalogo:5:8
%REM
	Function BuscaCatalogo
	Description: Comments for Function
%END REM
Function BuscaCatalogo(partN As String) As Variant
	
	On Error Resume Next
	Dim session As New NotesSession
	Dim db As New NotesDatabase(session.Currentdatabase.Server, "estoquemain.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim array(5) As Variant
	Set view = db.GetView("(Catalogo/PartNumberAtivos)")
	Set doc = view.GetDocumentByKey(partN, True)
	If Not doc Is Nothing Then
		array(0) = doc.ClassificacaoFiscal(0)
		array(1) = doc.UnidadeMedida(0)
		array(2) = doc.Tipo(0)
		'Controle de Licença/Contrato
		%REM
		If doc.Hasitem("Contrato") Then
			array(2) = doc.Contrato(0)
			array(3) = doc.TipoRenovacao(0)
			array(4) = doc.VinculaHW(0)
			array(5) = doc.Validade(0)
		End If
		%END REM
	End If
	BuscaCatalogo = array
	
End Function

'++LotusScript Development Environment:2:2:LinkRenovacao:5:8
%REM
	Sub LinkRenovacao
	Description: Comments for Sub
%END REM
Sub LinkRenovacao(negocio As NotesDocument)
	
	Dim session As New NotesSession
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim rtItem As NotesRichTextItem
	If negocio.HasItem("LinkRenovacao") Then negocio.RemoveItem("LinkRenovacao")
	Set db = session.Currentdatabase
	Set view = db.Getview("(Renovacoes/Codigo)")
	Set doc = view.Getdocumentbykey(negocio.Codigo(0), True)
	If Not doc Is Nothing Then
		Set rtItem = negocio.CreateRichTextItem("LinkRenovacao")
		Call rtItem.AppendDocLink(doc,"Link para a Renovação")
	End If
	
End Sub

'++LotusScript Development Environment:2:2:CkStatusCotacao:1:8
Sub CkStatusCotacao(cotacao As NotesDocument)
	
	On Error Resume Next
	Dim listas As New NotesDatabase(cotacao.ParentDatabase.Server,"listas.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Dim scan As Integer
	Dim comprar As Long, comprado As Long
	Dim produto As Variant, item As Variant
	If cotacao.TipoCompra(0) = "Projeto" Then
		Set view = listas.GetView("(NegocioNPlanilhas)")
	Else
		Set view = listas.GetView("(NegocioNItens)")
	End If
	For scan% = 0 To 49
		produto = cotacao.GetItemValue("Produto_" & CStr( scan ))
		If produto(0) <> "" Then
			item = cotacao.GetItemValue("i_" + CStr(scan))
			Set doc = view.getDocumentByKey( cotacao.Codigo(0) & "-" & item(0) )
			If Not (doc Is Nothing) Then
				If doc.Status(0) = "Inativo" Or doc.Status(0) = "Inativa" Then
					Call cotacao.ReplaceItemValue("S_" & scan, 0)
				Else	
					Call cotacao.ReplaceItemValue("Produto_" & scan, doc.Produto(0))
					Call cotacao.ReplaceItemValue("us_" & scan, doc.Us(0))
					Call cotacao.ReplaceItemValue("t_" & scan, doc.T(0))
					Call cotacao.ReplaceItemValue("UF_" & scan, doc.UFCompra(0))
					comprar = comprar + doc.Q(0)
					comprado = comprado + doc.QCompra(0) 
					Call cotacao.ReplaceItemValue("S_" & scan, doc.Q(0) - doc.QCompra(0))
				End If
			Else
				Call cotacao.ReplaceItemValue("S_" & scan, 0)
			End If 
		End If
	Next
	If comprar = comprado Then
		cotacao.Status = "OK" 		
	ElseIf comprado = 0 Then
		cotacao.Status = "Pendente"
	Else
		cotacao.Status = "Parcial" 
	End If
	
End Sub

'++LotusScript Development Environment:2:2:PopulaMoedas:1:8
Sub PopulaMoedas(negocio As NotesDocument)
	
	If CStr(negocio.DataCotacaoUS(0)) = "" Then GoTo Popula
	'Não popula se já fechou a venda.
	If negocio.Sit(0) <> "Prospect" And InStr(negocio.Sit(0), "Pré-Venda") = 0 And InStr(negocio.Sit(0), "POC") = 0 And negocio.Sit(0) <> "Forecast" Then
		Exit Sub
	End If
	'Não popula na mesma data que já populou.
	If CDat(negocio.DataCotacaoUS(0)) = CDat(Today) Then
		Exit Sub
	End If
Popula:
	On Error Resume Next
	Dim db As New NotesDatabase(negocio.Parentdatabase.Server, "sales.nsf")
	Dim view As NotesView
	Dim doc As NotesDocument
	Set view = db.GetView("3. Moedas")	
	Set doc = view.GetDocumentByKey(Format(Today, "dd/mm/yyyy"), True)
	'Encontrou a Cotação de Hoje
	If Not doc Is Nothing Then
			negocio.USC = doc.USC(0)
			negocio.UST = doc.UST(0)
			negocio.DataCotacaoUS = doc.Data(0)
	'Não Encontrou a Cotação de Hoje
	Else
		If CStr(negocio.DataCotacaoUS(0)) = "" Then
			negocio.USC = 1
			negocio.UST = 1
			negocio.DataCotacaoUS = ""
		End If
	End If
	
End Sub

'++LotusScript Development Environment:2:2:Fechamento:5:8
%REM
	Sub Fechamento
	Description: Comments for Sub
%END REM
Sub Fechamento(doc As NotesDocument)
	
	On Error Resume Next
	'Salva Lista de Materiais no db Listas
	Call SaveListaMateriais(doc)
	'Cria/Atualiza Cotação da Lista de Materiais em Compras
	Call Cotacao(doc)
	If doc.Form(0) = "Negocio" Then
		'Salva Lista de Serviços no db Listas
		Call SaveListaServicos(doc)
		'Atualiza Saldos as Faturar
		Call AtualizaSaldosAFaturar(doc)
		'Envia Email de Fechamento da Venda para Projetos
		If doc.TipoVenda(0) = "Projeto" Then Call AvisoFechamentoProjeto(doc)
	End If
	
End Sub

'++LotusScript Development Environment:2:2:RefreshListaServicos:1:8
Sub RefreshListaServicos(doc As NotesDocument)
	
	Dim db As NotesDatabase
	Dim view As NotesView
	Dim item As NotesDocument
	Dim array As Variant, scan As Integer
	Dim key(1) As String
	Set db = New NotesDatabase(doc.ParentDatabase.Server, "listas.nsf")
	Set view = db.GetView("(NegocioForm)")
	key(0) = doc.Codigo(0) & "Servico"
	For scan = 0 To 49
		key(1) = CStr(scan + 1)
		Set item = view.GetDocumentByKey(key, True)
		If Not item Is Nothing Then
			Call doc.ReplaceItemValue("Qs_" & scan, Val(item.Qs(0)))
			Call doc.ReplaceItemValue("PartNos_" & scan, item.PartN(0))
			Call doc.ReplaceItemValue("Produtos_" & scan, item.Produtos(0))
			Call doc.ReplaceItemValue("Uss_" & scan, item.Us(0))
			If CStr(item.Custos(0)) = "" Then Call doc.ReplaceItemValue("Custos_" & scan, "") Else Call doc.ReplaceItemValue("Custos_" & scan, item.Custos(0))
			If CStr(item.Terceiros(0)) = "" Then Call doc.ReplaceItemValue("Terceiros_" & scan, "") Else Call doc.ReplaceItemValue("Terceiros_" & scan, item.Terceiros(0))
			If doc.Form(0) = "Negocio" Then
				If item.Mgs(0) = 0 Then Call doc.ReplaceItemValue("Mgs_" & scan, "") Else Call doc.ReplaceItemValue("Mgs_" & scan, item.Mgs(0))
				If item.CustoUnits(0) = 0 Then Call doc.ReplaceItemValue("CustoUnits_" & scan, "") Else Call doc.ReplaceItemValue("CustoUnits_" & scan, item.CustoUnits(0))
				If CStr(item.CusTots(0)) = "" Then Call doc.ReplaceItemValue("CusTots_" & scan, "") Else Call doc.ReplaceItemValue("CusTots_" & scan, item.CusTots(0))
				If CStr(item.RIR(0)) = "" Then Call doc.ReplaceItemValue("RIR_" & scan, "") Else Call doc.ReplaceItemValue("RIR_" & scan, item.RIR(0))
				If CStr(item.RIN(0)) = "" Then Call doc.ReplaceItemValue("RIN_" & scan, "") Else Call doc.ReplaceItemValue("RIN_" & scan, item.RIN(0))
				If CStr(item.ISS(0)) = "" Then Call doc.ReplaceItemValue("ISS_" & scan, "") Else Call doc.ReplaceItemValue("ISS_" & scan, item.ISS(0))
			End If
			If CStr(item.Despesas(0)) = "" Then Call doc.ReplaceItemValue("Despesas_" & scan, "") Else Call doc.ReplaceItemValue("Despesas_" & scan, item.Despesas(0))
			If CStr(item.CPS(0)) = "" Then Call doc.ReplaceItemValue("CPS_" & scan, "") Else Call doc.ReplaceItemValue("CPS_" & scan, item.CPS(0))
			Call doc.ReplaceItemValue("VlFat_" & scan, item.CusTots(0) - item.VlFat(0))
		Else
			Call doc.ReplaceItemValue("Qs_" & scan, "")
			Call doc.ReplaceItemValue("PartNos_" & scan, "")
			Call doc.ReplaceItemValue("Produtos_" & scan, "")
			Call doc.ReplaceItemValue("Uss_" & scan, "" )
			Call doc.ReplaceItemValue("Custos_" & scan, "")
			Call doc.ReplaceItemValue("Terceiros_" & scan, "")
			Call doc.ReplaceItemValue("Mgs_" & scan, "")
			Call doc.ReplaceItemValue("CustoUnits_" & scan, "")
			Call doc.ReplaceItemValue("Despesas_" & scan, "")
			Call doc.ReplaceItemValue("CPS_" & scan, "")
			Call doc.ReplaceItemValue("CusTots_" & scan, "")
			Call doc.ReplaceItemValue("RIR_" & scan, "")
			Call doc.ReplaceItemValue("RIN_" & scan, "")
			Call doc.ReplaceItemValue("ISS_" & scan, "")
			Call doc.ReplaceItemValue("VlFat_" & scan, "")
		End If
	Next
			
End Sub


'++LotusScript Development Environment:2:1:CalcTotalServicos:1:8
Function CalcTotalServicos( doc As NotesDocument ) As Double
	
	'Calcula Total de Servicos
	Dim scan As Integer, array As Variant, totserv As Double
	Dim cusTot As Double
	For scan = 0 To 99
		array = doc.GetItemValue( "CusTots_" & scan)
		If DataType(array(0)) = 8 Then cusTot = 0 Else cusTot = array(0)
		totserv = totserv + Round(cusTot, 2)
	Next
	CalcTotalServicos = totserv
	
End Function


'++LotusScript Development Environment:2:1:TemHardware:5:8
%REM
	Function TemHardware
	Description: Comments for Function
%END REM
Function TemHardware(doc As NotesDocument) As Boolean
	
	Dim scan As Integer
	For scan = 0 To 49
		If doc.Getitemvalue("Produto_"& scan)(0) <> "" Then
			If Val(doc.Getitemvalue("Q_"& scan)(0)) > 0 And doc.Getitemvalue("t_"& scan)(0) = "HW" Then
				TemHardware = True
				Exit Function
			End If
		End If
	Next
		
End Function
























































































































































































































































'++LotusScript Development Environment:2:1:CkAreaTS:5:8
%REM
	Function CkAreaTS
	Description: Comments for Function
%END REM
Function CkAreaTS(doc As NotesDocument) As String
	
	Dim db As New NotesDatabase(doc.ParentDatabase.Server, "timesheet.nsf")
	Dim view As NotesView
	Dim dc As NotesDocumentCollection
	Dim config As NotesDocument
	Set view = db.GetView("(Usuario/Geral)")
	Set config = view.Getdocumentbykey(doc.Nome(0), True)
	If Not config Is Nothing Then
		CkAreaTS = config.Area(0)
	End If
	
End Function
















































































'++LotusScript Development Environment:2:1:GetPrimeiroTelefone:5:8
%REM
	Function GetPrimeiroTelefone
	Description: Comments for Function
%END REM
Function GetPrimeiroTelefone(telefoneCompleto As String) As String
	
	Dim telefones As Variant
	Dim primeiroTelefone As String
	If telefoneCompleto <> "" Then
		telefoneCompleto = Replace(telefoneCompleto, Chr(10), "/")
		telefoneCompleto = Replace(telefoneCompleto, ",", "/")
		telefones = Split(telefoneCompleto, "/")
		If UBound(telefones) >= 0 Then
			primeiroTelefone = Trim(telefones(0))
		Else
			primeiroTelefone = ""
		End If
	Else
		primeiroTelefone = ""
	End If
	GetPrimeiroTelefone = primeiroTelefone
	
End Function